"use strict";exports.id=2303,exports.ids=[2303],exports.modules={73543:(e,t,s)=>{s.d(t,{q5:()=>h,x0:()=>p,fn:()=>I,rr:()=>n});var a=s(57745),i=s(9576),l=s(57435),r=s(10413),o=s(93567),d=s(88317);async function n({data:e,broadcastAction:t=!0,userId:s}){let n={success:!1};try{let t=[];for(let{hospitalId:l,...d}of e)try{let e=l||i.Z();if(!t.length){let t=l?await r.Z.query.hospitalsDrafts.findFirst({where:(0,a.eq)(o.hospitalsDrafts.hospitalDraftId,e)}):null,i=t||!l?null:await r.Z.query.hospitals.findFirst({where:(0,a.eq)(o.hospitals.hospitalId,e)});if(t){let s={...t.data,...d};await r.Z.update(o.hospitalsDrafts).set({data:s}).where((0,a.eq)(o.hospitalsDrafts.hospitalDraftId,e))}else{let t={...i,...d,hospitalId:e,version:i?.version?i.version+1:1};await r.Z.insert(o.hospitalsDrafts).values({data:t,hospitalDraftId:e,hospitalId:i?.hospitalId,createdByUserId:s})}}}catch(e){t.push(e.message)}t.length?n.errors=t:n.success=!0}catch(e){n.success=!1,n.errors=[e.message],l.Z.error("_saveHospitals ERROR",e.message)}finally{return!n?.errors?.length&&t&&d.Z.emit("data_changed","save_hospitals"),n}}async function h(e){try{return await r.Z.delete(o.hospitalsDrafts).where(e?.userId?(0,a.eq)(o.hospitalsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function p({hospitalsIds:e,broadcastAction:t=!0,userId:s}){let i={success:!1};try{if(e.length){await r.Z.delete(o.hospitalsDrafts).where((0,a.d3)(o.hospitalsDrafts.hospitalDraftId,e));let t=(await r.Z.select({hospitalId:o.hospitals.hospitalId,pendingDeletion:o.pendingDeletion.hospitalId}).from(o.hospitals).leftJoin(o.pendingDeletion,(0,a.eq)(o.pendingDeletion.hospitalId,o.hospitals.hospitalId)).where((0,a.d3)(o.hospitals.hospitalId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:s}));t.length&&await r.Z.insert(o.pendingDeletion).values(t)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],l.Z.error("_deleteHospitals ERROR",e.message)}finally{return!i?.errors?.length&&t&&d.Z.emit("data_changed","delete_hospitals"),i}}async function f({previous:e,drafts:t,userId:s}){let a=[];try{let i=[];for(let l of t){let t=l?.data?.hospitalId;if(!t)continue;let r={version:l?.data?.version||1,hospitalId:t,changes:{}},o=1===(l?.data?.version||1);if(o)r.changes={action:"create_hospital",description:"Create hospital",oldValues:[],newValues:[]};else{let s=e.find(e=>e.hospitalId===t),a=[],i=[];Object.keys({...l?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l.data[e],r={...s}[e];JSON.stringify(t)!==JSON.stringify(r)&&(a.push({[e]:r}),i.push({[e]:t}))}),r.changes={action:"update_hospital",description:"Update hospital",oldValues:a,newValues:i}}if(i.push(r),s){let{...i}=l.data||{},d=JSON.parse(JSON.stringify(i)),n=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.hospitalId===t)||{}));a.push({entityId:t,entityType:"hospital",action:o?"create":"update",version:r.version||1,changes:r.changes,fullSnapshot:d,previousSnapshot:n,baselineSnapshot:n,userId:s,hospitalId:t})}}i.length&&await r.Z.insert(o.hospitalsHistory).values(i)}catch(e){l.Z.error(e.message)}return a}var u=s(34149),c=s(36864);async function I(e){let t={success:!1},s=[];try{let d=[],n=[],h=await r.Z.query.hospitalsDrafts.findMany({where:e?.userId?(0,a.eq)(o.hospitalsDrafts.createdByUserId,e?.userId):void 0});if(d=h.filter(e=>e.hospitalId),n=h.filter(e=>!e.hospitalId),d.length){let t=[];for(let{hospitalId:e,data:s}of(d.filter(e=>e.hospitalId).length&&(t=await r.Z.query.hospitals.findMany({where:(0,a.d3)(o.hospitals.hospitalId,d.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),d)){let{hospitalId:t,id:i,oldHospitalId:l,createdAt:d,updatedAt:n,deletedAt:h,...p}=s,f={...p,publishDate:new Date};await r.Z.update(o.hospitals).set(f).where((0,a.eq)(o.hospitals.hospitalId,e)).returning()}let i=await f({drafts:d,previous:t,userId:e?.publisherUserId});s.push(...i.map(t=>({...t,dataVersion:e?.dataVersion})))}if(n.length){let t=[];for(let{id:e,data:s}of(n.filter(e=>e.hospitalId).length&&(t=await r.Z.query.hospitals.findMany({where:(0,a.d3)(o.hospitals.hospitalId,n.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),n)){let t=s.hospitalId||(0,i.Z)(),a={...s,hospitalId:t};n=n.map(s=>(s.id===e&&(s.data.hospitalId=t),s)),await r.Z.insert(o.hospitals).values(a)}let l=await f({drafts:n,previous:t,userId:e?.publisherUserId});s.push(...l.map(t=>({...t,dataVersion:e?.dataVersion})))}await r.Z.delete(o.hospitalsDrafts).where(e?.userId?(0,a.eq)(o.hospitalsDrafts.createdByUserId,e.userId):void 0);let p=await r.Z.query.pendingDeletion.findMany({where:(0,a.xD)((0,a.K0)(o.pendingDeletion.hospitalId),e?.userId?(0,a.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0),columns:{hospitalId:!0},with:{hospital:!0}});if((p=p.filter(e=>e.hospital)).length){let t=new Date;await r.Z.update(o.hospitals).set({deletedAt:t}).where((0,a.d3)(o.hospitals.hospitalId,p.map(e=>e.hospitalId)));let i=p.map(e=>({version:e.hospital.version,hospitalId:e.hospitalId,changes:{action:"delete_hospital",description:"Delete hospital",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await r.Z.insert(o.hospitalsHistory).values(i),e?.publisherUserId)for(let a=0;a<p.length;a++){let l=p[a],r=i[a];if(!l?.hospitalId)continue;let o={...l.hospital??{},deletedAt:t};s.push({entityId:l.hospitalId,entityType:"hospital",action:"delete",version:r.version||1,dataVersion:e.dataVersion,changes:r.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),description:r.changes.description,userId:e.publisherUserId,hospitalId:l.hospitalId,isActive:!1})}}await r.Z.delete(o.pendingDeletion).where((0,a.xD)((0,a.or)((0,a.K0)(o.pendingDeletion.hospitalId),(0,a.K0)(o.pendingDeletion.hospitalDraftId)),e?.userId?(0,a.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0));let I=[...d.map(e=>e.hospitalId),...p.map(e=>e.hospitalId)];if(I.length&&await r.Z.update(o.hospitals).set({version:(0,u.i6)`${o.hospitals.version} + 1`}).where((0,a.d3)(o.hospitals.hospitalId,I)),s.length){let e=await (0,c.F)({data:s,allowPartial:!0});e.errors?.length&&l.Z.error("_publishHospitals changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],l.Z.error("_publishHospitals ERROR",e)}finally{return t}}},20084:(e,t,s)=>{s.d(t,{Py:()=>u,SE:()=>f,C9:()=>h,O8:()=>n});var a=s(57745),i=s(30900),l=s(9576),r=s(10413),o=s(93567),d=s(57435);async function n(e){try{let{hospitalsIds:t,returnDraftsIfExist:s=!0}={...e},d=t||[],n=d?.length?(0,a.d3)(o.hospitalsDrafts.hospitalDraftId,d.map(e=>i.Z(e)?e:l.Z())):void 0,h=[...n?[n]:[]],p=s?await r.Z.query.hospitalsDrafts.findMany({where:(0,a.xD)(...h)}):[];d=d.filter(e=>!p.map(e=>e.hospitalDraftId).includes(e));let f=p.length?(0,a.Nl)(o.hospitals.hospitalId,p.map(e=>e.hospitalDraftId)):void 0,u=d?.length?(0,a.d3)(o.hospitals.hospitalId,d.filter(e=>i.Z(e))):void 0,c=d?.length?(0,a.d3)(o.hospitals.oldHospitalId,d.filter(e=>!i.Z(e))):void 0,I=[(0,a.Ft)(o.hospitals.deletedAt),(0,a.Ft)(o.pendingDeletion),...u&&c?[(0,a.or)(u,c)]:[],f],g=(await r.Z.select({hospital:o.hospitals,pendingDeletion:o.pendingDeletion}).from(o.hospitals).leftJoin(o.pendingDeletion,(0,a.eq)(o.pendingDeletion.hospitalId,o.hospitals.hospitalId)).where(I.length?(0,a.xD)(...I):void 0)).map(e=>e.hospital),D=g.length?await r.Z.query.pendingDeletion.findMany({where:(0,a.d3)(o.pendingDeletion.hospitalId,g.map(e=>e.hospitalId)),columns:{hospitalId:!0}}):[];return{data:[...g.map(e=>({...e,isDraft:!1,isDeleted:!1,isUnpublishedDraft:!1})),...p.map(e=>({...e.data,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!e.hospitalId,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()).filter(e=>!D.map(e=>e.hospitalId).includes(e.hospitalId))}}catch(e){return d.Z.error("_getHospitals ERROR",e.message),{data:[],errors:[e.message]}}}async function h(e){let{hospitalId:t,returnDraftIfExists:s=!0}={...e};try{if(!t)throw Error("Missing hospitalId");let e=i.Z(t)?(0,a.eq)(o.hospitals.hospitalId,t):void 0,l=i.Z(t)?void 0:(0,a.eq)(o.hospitals.oldHospitalId,t),d=e?(0,a.eq)(o.hospitalsDrafts.hospitalDraftId,t):void 0,n=s&&d?await r.Z.query.hospitalsDrafts.findFirst({where:d}):void 0,h=n?{...n.data,draftCreatedByUserId:n.createdByUserId,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!n.hospitalId}:null;if(h)return{data:h};let p=await r.Z.query.hospitals.findFirst({where:(0,a.xD)((0,a.Ft)(o.hospitals.deletedAt),e||l),with:{draft:!0}});n=s?p?.draft:void 0;let f=n?.data||p;if(!(h=f?{...f,draftCreatedByUserId:n?.createdByUserId,isDraft:!!n?.data,isDeleted:!1,isUnpublishedDraft:!1}:null))return{data:null};return{data:h}}catch(e){return d.Z.error("_getHospital ERROR",e.message),{errors:[e.message]}}}var p=s(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await r.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts),[{count:t}]=await r.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts).where((0,a.Ft)(o.hospitalsDrafts.hospitalId)),[{count:s}]=await r.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts).where((0,a.K0)(o.hospitalsDrafts.hospitalId)),[{count:i}]=await r.Z.select({count:(0,p.QX)()}).from(o.pendingDeletion).where((0,a.K0)(o.pendingDeletion.hospitalId)),[{count:l}]=await r.Z.select({count:(0,p.QX)()}).from(o.hospitals);return{data:{allPublished:l,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getHospitals ERROR",e.message),{data:f,errors:[e.message]}}}}};