"use strict";exports.id=1162,exports.ids=[1162],exports.modules={21162:(e,t,i)=>{i.d(t,{tW:()=>I,co:()=>u,ix:()=>c,GM:()=>g,W0:()=>f,Zu:()=>o,XA:()=>w.X,DX:()=>y,Ew:()=>w.E,eh:()=>s.eh,A0:()=>s.A0,NB:()=>m.NB,uK:()=>m.uK,pw:()=>h,bK:()=>s.bK,Tw:()=>s.Tw,$F:()=>p,pd:()=>x,Sc:()=>b,f:()=>m.f,Yc:()=>L});var s=i(49815),a=i(60938),r=i(57745),l=i(10413),n=i(93567),d=i(57435);let o={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function c(){try{let[{count:e}]=await l.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts),[{count:t}]=await l.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts).where((0,r.Ft)(n.scriptsDrafts.scriptId)),[{count:i}]=await l.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts).where((0,r.K0)(n.scriptsDrafts.scriptId)),[{count:s}]=await l.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,r.K0)(n.pendingDeletion.scriptId)),[{count:d}]=await l.Z.select({count:(0,a.QX)()}).from(n.scripts);return{data:{allPublished:d,publishedWithDrafts:i,allDrafts:e,newDrafts:t,pendingDeletion:s}}}catch(e){return d.Z.error("_getScripts ERROR",e.message),{data:o,errors:[e.message]}}}async function p(e){try{let e={};return(await l.Z.query.scriptsHistory.findMany({})).forEach(t=>{e[t.scriptId]=e[t.scriptId]||{},e[t.scriptId][t.version]=e[t.scriptId][t.version]||[],e[t.scriptId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(e){let{scriptsIds:t=[],types:i=[]}={...e};try{let e=t.length?(0,r.d3)(n.screens.scriptId,t):void 0,s=t.length?(0,r.d3)(n.screensDrafts.scriptId,t):void 0,d=i.length?(0,r.d3)(n.screens.type,i):void 0,o=i.length?(0,r.d3)(n.screensDrafts.type,i):void 0,[{count:c}]=await l.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,r.xD)(s,o)),[{count:p}]=await l.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,r.xD)(s,o,(0,r.Ft)(n.screensDrafts.screenId))),[{count:f}]=await l.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,r.xD)(s,o,(0,r.K0)(n.screensDrafts.screenId))),[{count:u}]=await l.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,r.xD)(t.length?(0,r.or)((0,r.d3)(n.pendingDeletion.screenScriptId,t)):void 0,(0,r.K0)(n.pendingDeletion.screenId))),[{count:m}]=await l.Z.select({count:(0,a.QX)()}).from(n.screens).where((0,r.xD)(e,d));return{data:{allPublished:m,publishedWithDrafts:f,allDrafts:c,newDrafts:p,pendingDeletion:u}}}catch(e){return d.Z.error("_getScreens ERROR",e.message),{data:f,errors:[e.message]}}}var m=i(62345);async function h(e){try{let e={};return(await l.Z.query.screensHistory.findMany({})).forEach(t=>{e[t.screenId]=e[t.screenId]||{},e[t.screenId][t.version]=e[t.screenId][t.version]||[],e[t.screenId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let g={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function I(e){let{scriptsIds:t=[]}={...e};try{let e=t.length?(0,r.d3)(n.diagnoses.scriptId,t):void 0,i=t.length?(0,r.d3)(n.diagnosesDrafts.scriptId,t):void 0,[{count:s}]=await l.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where(i),[{count:d}]=await l.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where((0,r.xD)(i,(0,r.Ft)(n.diagnosesDrafts.diagnosisId))),[{count:o}]=await l.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where((0,r.xD)(i,(0,r.K0)(n.diagnosesDrafts.diagnosisId))),[{count:c}]=await l.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,r.xD)(t.length?(0,r.or)((0,r.d3)(n.pendingDeletion.diagnosisScriptId,t)):void 0,(0,r.K0)(n.pendingDeletion.diagnosisId))),[{count:p}]=await l.Z.select({count:(0,a.QX)()}).from(n.diagnoses).where(e);return{data:{allPublished:p,publishedWithDrafts:o,allDrafts:s,newDrafts:d,pendingDeletion:c}}}catch(e){return d.Z.error("_getDiagnoses ERROR",e.message),{data:g,errors:[e.message]}}}var w=i(31300);async function y(e){try{let e={};return(await l.Z.query.diagnosesHistory.findMany({})).forEach(t=>{e[t.diagnosisId]=e[t.diagnosisId]||{},e[t.diagnosisId][t.version]=e[t.diagnosisId][t.version]||[],e[t.diagnosisId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}var D=i(30900),$=i(9576);async function b(e){try{let{scriptsIds:t=[],hospitalsIds:i=[],returnDraftsIfExist:s}={...e},a=await l.Z.query.hospitals.findMany({where:(0,r.xD)((0,r.Ft)(n.hospitals.deletedAt))}),d=t.filter(e=>!D.Z(e));if(d.length){let e=await l.Z.query.scripts.findMany({where:(0,r.d3)(n.scripts.oldScriptId,d),columns:{scriptId:!0,oldScriptId:!0}});d.forEach(i=>{let s=e.filter(e=>e.oldScriptId===i)[0];t.push(s?.scriptId||$.Z())})}let o=t.filter(e=>D.Z(e)),c=o.length?(0,r.d3)(n.scripts.scriptId,o):void 0,p=i.length?(0,r.d3)(n.scripts.hospitalId,i):void 0,f=await l.Z.query.scriptsDrafts.findMany({where:(0,r.xD)(p,o.length?(0,r.xD)((0,r.d3)(n.scriptsDrafts.scriptDraftId,o),(0,r.Ft)(n.scriptsDrafts.scriptId)):void 0),with:{screensDrafts:!0,diagnosesDrafts:!0}}),u=(s?await l.Z.query.scripts.findMany({where:(0,r.xD)(c,p),with:{draft:!!s||void 0,screens:{where:(0,r.Ft)(n.screens.deletedAt),with:{draft:!!s||void 0}},diagnoses:{where:(0,r.Ft)(n.screens.deletedAt),with:{draft:!!s||void 0}}}}):[]).map(e=>({...e,...s&&e.draft?e.draft.data:null,screens:e.screens.sort((e,t)=>e.position-t.position),diagnoses:e.diagnoses.sort((e,t)=>e.position-t.position)})),m=f.map(e=>({...e.data,scriptId:e.scriptDraftId,screens:e.screensDrafts.map(e=>({...e.data,screenId:e.screenDraftId})),diagnoses:e.diagnosesDrafts.map(e=>({...e.data,diagnosisId:e.diagnosisDraftId}))})),h=[...u,...m].sort((e,t)=>e.position-t.position),g=[];return h.forEach(e=>{let t=a.filter(t=>t.hospitalId===e.hospitalId)[0];g.push({scriptId:e.scriptId,title:e.title,hospitalName:t?.name||"",diagnoses:e.diagnoses.map(e=>({diagnosisId:e.diagnosisId,name:e.name,key:e.key||e.name,fields:[]})),screens:e.screens.map(e=>{let t=e.items,i=e.fields,s=[{label:e.label,key:e.key,type:e.type,...(e.type,{dataType:e.dataType,value:null,valueLabel:null,optional:e.skippable,confidential:e.confidential,minValue:e.minValue,maxValue:e.maxValue})}];switch(e.type){case"progress":case"edliz_summary_table":case"mwi_edliz_summary_table":case"zw_edliz_summary_table":case"management":s=[];break;case"yesno":s=[{value:"true",label:e.positiveLabel||"Yes"},{value:"false",label:e.negativeLabel||"Yes"}].map(t=>({label:e.label,key:e.key,type:e.type,dataType:"boolean",value:t.value,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"diagnosis":s=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.id,type:e.type,dataType:"diagnosis",optional:e.skippable,confidential:e.confidential}));break;case"checklist":s=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.key,type:e.type,dataType:null,optional:e.skippable,confidential:e.confidential}));break;case"form":s=i.map(e=>{let t=e.dataType;switch(e.type){case"datetime":t="datetime";break;case"date":t="date";break;case"time":t="time";break;case"dropdown":t="dropdown";break;case"multi_select":t="multi_select";break;case"number":t="number";break;case"text":t="string",("uid"===`${e.key}`.toLowerCase()||`${e.key}`.toLowerCase().includes("nuid"))&&(t="uid");break;default:t=e.dataType}if(["multi_select","dropdown"].includes(e.type)){let t="dropdown";return"multi_select"===e.type&&(t="multi_select"),(e.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).map(e=>({value:(e=e.split(","))[0],label:e[1]})).map(i=>({label:e.label,key:e.key,type:e.type,dataType:t,value:i.value,valueLabel:i.label,optional:e.optional,confidential:e.confidential}))}return[{label:e.label,key:e.key,type:e.type,dataType:t,value:null,valueLabel:null,optional:e.optional,confidential:e.confidential,minValue:e.minValue??e.minDate??e.minTime,maxValue:e.maxValue??e.maxDate??e.maxTime}]}).reduce((e,t)=>[...e,...t],[]);break;case"single_select":s=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"single_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"multi_select":s=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"multi_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}))}return{screenId:e.screenId,type:e.type,title:e.title,ref:e.refId,fields:s}})})}),{data:g}}catch(e){return{errors:[e.message],data:[]}}}var k=i(88781);async function x(e){try{let t=await (0,s.Tw)(e),i=await (0,m.uK)({types:["drugs","feeds","fluids"],scriptsIds:t.data.map(e=>e.scriptId),returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted}),a=Object.keys(i.data.reduce((e,t)=>([...t.drugs,...t.fluids,...t.feeds].forEach(t=>{e[t.key]=t.key}),e),{}));return await (0,k.fP)({keys:a,returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted})}catch(e){return d.Z.error("_getScriptsDrugsLibrary ERROR",e.message),{data:[],errors:[e.message]}}}var v=i(34149),_=i(67785);async function L({searchValue:e,returnDraftsIfExist:t=!0}){try{let i=`${e||""}`,{normalizedValue:s}=(0,_.l)(i);if(!s)return{data:[]};let a=t?await l.Z.query.scriptsDrafts.findMany({where:(0,v.i6)`lower(${n.scriptsDrafts.data}::text) like ${`%${s}%`}`}):[],d=await l.Z.select({pendingDeletion:n.pendingDeletion,script:n.scripts}).from(n.scripts).leftJoin(n.pendingDeletion,(0,r.eq)(n.pendingDeletion.scriptId,n.scripts.scriptId)).where((0,r.xD)((0,r.Ft)(n.pendingDeletion),(0,r.Ft)(n.scripts.deletedAt),a.length?(0,r.Nl)(n.scripts.scriptId,a.map(e=>e.scriptDraftId)):void 0,(0,r.or)((0,v.i6)`lower(${n.scripts.title}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.scripts.printTitle}::text) like ${`%${s}%`}`))),o=t?await l.Z.query.screensDrafts.findMany({where:(0,v.i6)`lower(${n.screensDrafts.data}::text) like ${`%${s}%`}`}):[],c=await l.Z.select({pendingDeletion:n.pendingDeletion,screen:n.screens}).from(n.screens).leftJoin(n.pendingDeletion,(0,r.eq)(n.pendingDeletion.screenId,n.screens.screenId)).where((0,r.xD)((0,r.Ft)(n.pendingDeletion),(0,r.Ft)(n.screens.deletedAt),o.length?(0,r.Nl)(n.screens.screenId,o.map(e=>e.screenDraftId)):void 0,(0,r.or)((0,v.i6)`lower(${n.screens.condition}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.sectionTitle}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.previewTitle}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.previewPrintTitle}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.title}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.key}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.refId}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.label}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.fields}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.items}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.drugs}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.fluids}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.screens.feeds}::text) like ${`%${s}%`}`))),p=t?await l.Z.query.diagnosesDrafts.findMany({where:(0,v.i6)`lower(${n.diagnosesDrafts.data}::text) like ${`%${s}%`}`}):[],f=await l.Z.select({pendingDeletion:n.pendingDeletion,diagnosis:n.diagnoses}).from(n.diagnoses).leftJoin(n.pendingDeletion,(0,r.eq)(n.pendingDeletion.diagnosisId,n.diagnoses.diagnosisId)).where((0,r.xD)((0,r.Ft)(n.pendingDeletion),(0,r.Ft)(n.diagnoses.deletedAt),p.length?(0,r.Nl)(n.diagnoses.diagnosisId,p.map(e=>e.diagnosisDraftId)):void 0,(0,r.or)((0,v.i6)`lower(${n.diagnoses.name}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.diagnoses.expression}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.diagnoses.symptoms}::text) like ${`%${s}%`}`,(0,v.i6)`lower(${n.diagnoses.key}::text) like ${`%${s}%`}`))),u=[...a.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,isDraft:!0})),...d.map(e=>({...e.script,isDraft:!1}))].sort((e,t)=>e.position-t.position),m=[...o.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,screenId:e.screenId||e.screenDraftId,isDraft:!0})),...c.map(e=>({...e.screen,isDraft:!1}))].sort((e,t)=>e.position-t.position),h=[...p.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,diagnosisId:e.diagnosisId||e.diagnosisDraftId,isDraft:!0})),...f.map(e=>({...e.diagnosis,isDraft:!1}))].sort((e,t)=>e.position-t.position),g=[...h.map(e=>e.scriptId),...m.map(e=>e.scriptId)],I=(g=g.filter((e,t)=>g.indexOf(e)===t).filter(e=>-1===u.map(e=>e.scriptId).indexOf(e))).length?await l.Z.query.scriptsDrafts.findMany({where:(0,r.or)((0,r.d3)(n.scriptsDrafts.scriptId,g),(0,r.d3)(n.scriptsDrafts.scriptDraftId,g))}):[],w=g.length?await l.Z.select({script:n.scripts}).from(n.scripts).where((0,r.xD)((0,r.d3)(n.scripts.scriptId,g),I.length?(0,r.Nl)(n.scripts.scriptId,I.map(e=>e.scriptDraftId)):void 0)):[],y=[...I.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,isDraft:!0})),...w.map(e=>({...e.script,isDraft:!1}))].sort((e,t)=>e.position-t.position);return{data:function({searchValue:e,scripts:t,screens:i,diagnoses:s}){let{normalizedValue:a,isExactMatch:r}=(0,_.l)(e);if(!a)return[];let l=(0,_.y)(a),n=new RegExp(r?`^${l}$`:l),d={};return t.forEach(e=>{let t=[];`${e.title||""}`.toLowerCase().match(n)&&t.push({field:"title",fieldValue:e.title}),`${e.printTitle||""}`.toLowerCase().match(n)&&t.push({field:"printTitle",fieldValue:e.printTitle}),t.length&&(d[e.scriptId]={title:e.title,scriptId:e.scriptId,diagnoses:[],screens:[],matches:t})}),i.forEach(e=>{let t=[];`${e.title||""}`.toLowerCase().match(n)&&t.push({field:"title",fieldValue:e.title}),`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"key",fieldValue:e.key}),`${e.refId||""}`.toLowerCase().match(n)&&t.push({field:"refId",fieldValue:`${e.refId||""}`}),`${e.label||""}`.toLowerCase().match(n)&&t.push({field:"label",fieldValue:e.label}),`${e.sectionTitle||""}`.toLowerCase().match(n)&&t.push({field:"sectionTitle",fieldValue:e.sectionTitle}),`${e.previewTitle||""}`.toLowerCase().match(n)&&t.push({field:"previewTitle",fieldValue:e.previewTitle}),`${e.previewPrintTitle||""}`.toLowerCase().match(n)&&t.push({field:"previewPrintTitle",fieldValue:e.previewPrintTitle}),`${e.condition||""}`.toLowerCase().match(n)&&t.push({field:"condition",fieldValue:e.condition}),(e.fields||[]).map((e,i)=>{`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"field_key",fieldIndex:i,fieldValue:e.key}),`${e.label||""}`.toLowerCase().match(n)&&t.push({field:"field_label",fieldIndex:i,fieldValue:e.label}),`${e.condition||""}`.toLowerCase().match(n)&&t.push({field:"field_condition",fieldIndex:i,fieldValue:e.condition}),(e.items||[]).map((e,s)=>{`${e.value||""}`.toLowerCase().match(n)&&t.push({field:"field_item_key",fieldIndex:i,fieldItemIndex:s,fieldValue:e.value}),`${e.label||""}`.toLowerCase().match(n)&&t.push({field:"field_item_label",fieldIndex:i,fieldItemIndex:s,fieldValue:e.label})})}),(e.items||[]).map((e,i)=>{`${e.id||""}`.toLowerCase().match(n)&&t.push({field:"item_id",fieldIndex:i,fieldValue:e.id}),`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"item_key",fieldIndex:i,fieldValue:e.key}),`${e.label||""}`.toLowerCase().match(n)&&t.push({field:"item_label",fieldIndex:i,fieldValue:e.label})}),(e.drugs||[]).map((e,i)=>{`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"drug",fieldIndex:i,fieldValue:e.key})}),(e.fluids||[]).map((e,i)=>{`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"fluid",fieldIndex:i,fieldValue:e.key})}),(e.feeds||[]).map((e,i)=>{`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"feed",fieldIndex:i,fieldValue:e.key})}),t.length&&(d[e.scriptId]=d[e.scriptId]||{title:"",scriptId:e.scriptId,diagnoses:[],screens:[],matches:[]},d[e.scriptId].title=d[e.scriptId].title||e.scriptTitle,d[e.scriptId].screens.push({title:e.title,matches:t,screenId:e.screenId,isDraft:e.isDraft,fields:[...e.items.map(e=>({label:e.label,type:"item"})),...e.fields.map(e=>({label:e.label,type:"field"}))]}))}),s.forEach(e=>{let t=[];`${e.name||""}`.toLowerCase().match(n)&&t.push({field:"name",fieldValue:e.name}),`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"key",fieldValue:e.key}),`${e.expression||""}`.toLowerCase().match(n)&&t.push({field:"expression",fieldValue:e.expression}),(e.symptoms||[]).map((e,i)=>{`${e.key||""}`.toLowerCase().match(n)&&t.push({field:"diagnosis_symptom_key",fieldIndex:i,fieldValue:e.key}),`${e.name||""}`.toLowerCase().match(n)&&t.push({field:"diagnosis_symptom_name",fieldIndex:i,fieldValue:e.name}),`${e.expression||""}`.toLowerCase().match(n)&&t.push({field:"diagnosis_symptom_expression",fieldIndex:i,fieldValue:e.expression})}),t.length&&(d[e.scriptId]=d[e.scriptId]||{title:"",scriptId:e.scriptId,diagnoses:[],screens:[],matches:[]},d[e.scriptId].title=d[e.scriptId].title||e.scriptTitle,d[e.scriptId].diagnoses.push({title:e.name||"",matches:t,diagnosisId:e.diagnosisId,isDraft:e.isDraft,fields:[...e.symptoms.map(e=>({label:e.name,type:"diagnosis_symptom"}))]}))}),Object.values(d)}({searchValue:i,screens:m.map(e=>({...e,scriptTitle:y.find(t=>t.scriptId===e.scriptId)?.title||""})),diagnoses:h.map(e=>({...e,scriptTitle:y.find(t=>t.scriptId===e.scriptId)?.title||""})),scripts:u})}}catch(e){return d.Z.error("_searchScripts ERROR",e.message),{errors:[e.message],data:[]}}}}};