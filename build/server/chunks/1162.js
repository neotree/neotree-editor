"use strict";exports.id=1162,exports.ids=[1162],exports.modules={21162:(e,t,i)=>{i.d(t,{tW:()=>I,co:()=>u,ix:()=>c,GM:()=>y,W0:()=>f,Zu:()=>o,XA:()=>g.X,DX:()=>D,Ew:()=>g.E,eh:()=>s.eh,A0:()=>s.A0,NB:()=>m.NB,uK:()=>m.uK,pw:()=>h,bK:()=>s.bK,Tw:()=>s.Tw,$F:()=>p,pd:()=>k,Sc:()=>b,f:()=>m.f,Yc:()=>V});var s=i(49815),a=i(60938),l=i(57745),r=i(10413),n=i(93567),d=i(57435);let o={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function c(){try{let[{count:e}]=await r.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts),[{count:t}]=await r.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts).where((0,l.Ft)(n.scriptsDrafts.scriptId)),[{count:i}]=await r.Z.select({count:(0,a.QX)()}).from(n.scriptsDrafts).where((0,l.K0)(n.scriptsDrafts.scriptId)),[{count:s}]=await r.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,l.K0)(n.pendingDeletion.scriptId)),[{count:d}]=await r.Z.select({count:(0,a.QX)()}).from(n.scripts);return{data:{allPublished:d,publishedWithDrafts:i,allDrafts:e,newDrafts:t,pendingDeletion:s}}}catch(e){return d.Z.error("_getScripts ERROR",e.message),{data:o,errors:[e.message]}}}async function p(e){try{let e={};return(await r.Z.query.scriptsHistory.findMany({})).forEach(t=>{e[t.scriptId]=e[t.scriptId]||{},e[t.scriptId][t.version]=e[t.scriptId][t.version]||[],e[t.scriptId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(e){let{scriptsIds:t=[],types:i=[]}={...e};try{let e=t.length?(0,l.d3)(n.screens.scriptId,t):void 0,s=t.length?(0,l.d3)(n.screensDrafts.scriptId,t):void 0,d=i.length?(0,l.d3)(n.screens.type,i):void 0,o=i.length?(0,l.d3)(n.screensDrafts.type,i):void 0,[{count:c}]=await r.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,l.xD)(s,o)),[{count:p}]=await r.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,l.xD)(s,o,(0,l.Ft)(n.screensDrafts.screenId))),[{count:f}]=await r.Z.select({count:(0,a.QX)()}).from(n.screensDrafts).where((0,l.xD)(s,o,(0,l.K0)(n.screensDrafts.screenId))),[{count:u}]=await r.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,l.xD)(t.length?(0,l.or)((0,l.d3)(n.pendingDeletion.screenScriptId,t)):void 0,(0,l.K0)(n.pendingDeletion.screenId))),[{count:m}]=await r.Z.select({count:(0,a.QX)()}).from(n.screens).where((0,l.xD)(e,d));return{data:{allPublished:m,publishedWithDrafts:f,allDrafts:c,newDrafts:p,pendingDeletion:u}}}catch(e){return d.Z.error("_getScreens ERROR",e.message),{data:f,errors:[e.message]}}}var m=i(62345);async function h(e){try{let e={};return(await r.Z.query.screensHistory.findMany({})).forEach(t=>{e[t.screenId]=e[t.screenId]||{},e[t.screenId][t.version]=e[t.screenId][t.version]||[],e[t.screenId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function I(e){let{scriptsIds:t=[]}={...e};try{let e=t.length?(0,l.d3)(n.diagnoses.scriptId,t):void 0,i=t.length?(0,l.d3)(n.diagnosesDrafts.scriptId,t):void 0,[{count:s}]=await r.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where(i),[{count:d}]=await r.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where((0,l.xD)(i,(0,l.Ft)(n.diagnosesDrafts.diagnosisId))),[{count:o}]=await r.Z.select({count:(0,a.QX)()}).from(n.diagnosesDrafts).where((0,l.xD)(i,(0,l.K0)(n.diagnosesDrafts.diagnosisId))),[{count:c}]=await r.Z.select({count:(0,a.QX)()}).from(n.pendingDeletion).where((0,l.xD)(t.length?(0,l.or)((0,l.d3)(n.pendingDeletion.diagnosisScriptId,t)):void 0,(0,l.K0)(n.pendingDeletion.diagnosisId))),[{count:p}]=await r.Z.select({count:(0,a.QX)()}).from(n.diagnoses).where(e);return{data:{allPublished:p,publishedWithDrafts:o,allDrafts:s,newDrafts:d,pendingDeletion:c}}}catch(e){return d.Z.error("_getDiagnoses ERROR",e.message),{data:y,errors:[e.message]}}}var g=i(31300);async function D(e){try{let e={};return(await r.Z.query.diagnosesHistory.findMany({})).forEach(t=>{e[t.diagnosisId]=e[t.diagnosisId]||{},e[t.diagnosisId][t.version]=e[t.diagnosisId][t.version]||[],e[t.diagnosisId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}var w=i(30900),$=i(9576);async function b(e){try{let{scriptsIds:t=[],hospitalsIds:i=[],returnDraftsIfExist:s}={...e},a=await r.Z.query.hospitals.findMany({where:(0,l.xD)((0,l.Ft)(n.hospitals.deletedAt))}),d=t.filter(e=>!w.Z(e));if(d.length){let e=await r.Z.query.scripts.findMany({where:(0,l.d3)(n.scripts.oldScriptId,d),columns:{scriptId:!0,oldScriptId:!0}});d.forEach(i=>{let s=e.filter(e=>e.oldScriptId===i)[0];t.push(s?.scriptId||$.Z())})}let o=t.filter(e=>w.Z(e)),c=o.length?(0,l.d3)(n.scripts.scriptId,o):void 0,p=i.length?(0,l.d3)(n.scripts.hospitalId,i):void 0,f=await r.Z.query.scriptsDrafts.findMany({where:(0,l.xD)(p,o.length?(0,l.xD)((0,l.d3)(n.scriptsDrafts.scriptDraftId,o),(0,l.Ft)(n.scriptsDrafts.scriptId)):void 0),with:{screensDrafts:!0,diagnosesDrafts:!0}}),u=(s?await r.Z.query.scripts.findMany({where:(0,l.xD)(c,p),with:{draft:!!s||void 0,screens:{where:(0,l.Ft)(n.screens.deletedAt),with:{draft:!!s||void 0}},diagnoses:{where:(0,l.Ft)(n.screens.deletedAt),with:{draft:!!s||void 0}}}}):[]).map(e=>({...e,...s&&e.draft?e.draft.data:null,screens:e.screens.sort((e,t)=>e.position-t.position),diagnoses:e.diagnoses.sort((e,t)=>e.position-t.position)})),m=f.map(e=>({...e.data,scriptId:e.scriptDraftId,screens:e.screensDrafts.map(e=>({...e.data,screenId:e.screenDraftId})),diagnoses:e.diagnosesDrafts.map(e=>({...e.data,diagnosisId:e.diagnosisDraftId}))})),h=[...u,...m].sort((e,t)=>e.position-t.position),y=[];return h.forEach(e=>{let t=a.filter(t=>t.hospitalId===e.hospitalId)[0];y.push({scriptId:e.scriptId,title:e.title,hospitalName:t?.name||"",diagnoses:e.diagnoses.map(e=>({diagnosisId:e.diagnosisId,name:e.name,key:e.key||e.name,severityOrder:e.severityOrder||"",expression:e.expression||"",expressionMeaning:e.expressionMeaning||"",description:e.description||"",fields:[]})),screens:e.screens.map(e=>{let t=e.items,i=e.fields,s=[{label:e.label,key:e.key,type:e.type,...(e.type,{dataType:e.dataType,value:null,valueLabel:null,optional:e.skippable,confidential:e.confidential,minValue:e.minValue,maxValue:e.maxValue})}];switch(e.type){case"progress":case"edliz_summary_table":case"mwi_edliz_summary_table":case"zw_edliz_summary_table":case"management":s=[];break;case"yesno":s=[{value:"true",label:e.positiveLabel||"Yes"},{value:"false",label:e.negativeLabel||"Yes"}].map(t=>({label:e.label,key:e.key,type:e.type,dataType:"boolean",value:t.value,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"diagnosis":s=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.id,type:e.type,dataType:"diagnosis",optional:e.skippable,confidential:e.confidential}));break;case"checklist":s=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.key,type:e.type,dataType:null,optional:e.skippable,confidential:e.confidential}));break;case"form":s=i.map(e=>{let t=e.dataType,i=e.items||[];switch(e.type){case"datetime":t="datetime";break;case"date":t="date";break;case"time":t="time";break;case"dropdown":t="dropdown";break;case"multi_select":t="multi_select";break;case"number":t="number";break;case"text":t="string",("uid"===`${e.key}`.toLowerCase()||`${e.key}`.toLowerCase().includes("nuid"))&&(t="uid");break;default:t=e.dataType}if(["multi_select","dropdown"].includes(e.type)){let t="dropdown";"multi_select"===e.type&&(t="multi_select");let s=(e.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).map(e=>({value:(e=e.split(","))[0],label:e[1]}));return i.length&&(s=i.map(e=>({value:`${e.value||""}`,label:`${e.label||""}`}))),s.map(i=>({label:e.label,key:e.key,type:e.type,dataType:t,value:i.value,valueLabel:i.label,optional:e.optional,confidential:e.confidential}))}return[{label:e.label,key:e.key,type:e.type,dataType:t,value:null,valueLabel:null,optional:e.optional,confidential:e.confidential,minValue:e.minValue??e.minDate??e.minTime,maxValue:e.maxValue??e.maxDate??e.maxTime,condition:e.condition||""}]}).reduce((e,t)=>[...e,...t],[]);break;case"single_select":s=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"single_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"multi_select":s=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"multi_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}))}return{screenId:e.screenId,type:e.type,title:e.title,ref:e.refId,condition:e.condition,fields:s}})})}),{data:y}}catch(e){return{errors:[e.message],data:[]}}}var x=i(88781);async function k(e){try{let t=await (0,s.Tw)(e),i=await (0,m.uK)({types:["drugs","feeds","fluids"],scriptsIds:t.data.map(e=>e.scriptId),returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted}),a=Object.keys(i.data.reduce((e,t)=>([...t.drugs,...t.fluids,...t.feeds].forEach(t=>{e[t.key]=t.key}),e),{}));return await (0,x.fP)({keys:a,returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted})}catch(e){return d.Z.error("_getScriptsDrugsLibrary ERROR",e.message),{data:[],errors:[e.message]}}}var v=i(34149),_=i(67785);async function V({searchValue:e,returnDraftsIfExist:t=!0}){try{let i=`${e||""}`,{normalizedValue:s}=(0,_.l)(i);if(!s)return{data:[]};let a=s.toLowerCase(),d=t?await r.Z.query.scriptsDrafts.findMany({where:(0,v.i6)`lower(${n.scriptsDrafts.data}::text) like ${`%${a}%`}`}):[],o=await r.Z.select({pendingDeletion:n.pendingDeletion,script:n.scripts}).from(n.scripts).leftJoin(n.pendingDeletion,(0,l.eq)(n.pendingDeletion.scriptId,n.scripts.scriptId)).where((0,l.xD)((0,l.Ft)(n.pendingDeletion),(0,l.Ft)(n.scripts.deletedAt),d.length?(0,l.Nl)(n.scripts.scriptId,d.map(e=>e.scriptDraftId)):void 0,(0,l.or)((0,v.i6)`lower(${n.scripts.title}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.scripts.printTitle}::text) like ${`%${a}%`}`))),c=t?await r.Z.query.screensDrafts.findMany({where:(0,v.i6)`lower(${n.screensDrafts.data}::text) like ${`%${a}%`}`}):[],p=await r.Z.select({pendingDeletion:n.pendingDeletion,screen:n.screens}).from(n.screens).leftJoin(n.pendingDeletion,(0,l.eq)(n.pendingDeletion.screenId,n.screens.screenId)).where((0,l.xD)((0,l.Ft)(n.pendingDeletion),(0,l.Ft)(n.screens.deletedAt),c.length?(0,l.Nl)(n.screens.screenId,c.map(e=>e.screenDraftId)):void 0,(0,l.or)((0,v.i6)`lower(${n.screens.condition}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.sectionTitle}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.previewTitle}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.previewPrintTitle}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.title}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.key}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.refId}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.label}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.fields}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.items}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.drugs}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.fluids}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.screens.feeds}::text) like ${`%${a}%`}`))),f=t?await r.Z.query.diagnosesDrafts.findMany({where:(0,v.i6)`lower(${n.diagnosesDrafts.data}::text) like ${`%${a}%`}`}):[],u=await r.Z.select({pendingDeletion:n.pendingDeletion,diagnosis:n.diagnoses}).from(n.diagnoses).leftJoin(n.pendingDeletion,(0,l.eq)(n.pendingDeletion.diagnosisId,n.diagnoses.diagnosisId)).where((0,l.xD)((0,l.Ft)(n.pendingDeletion),(0,l.Ft)(n.diagnoses.deletedAt),f.length?(0,l.Nl)(n.diagnoses.diagnosisId,f.map(e=>e.diagnosisDraftId)):void 0,(0,l.or)((0,v.i6)`lower(${n.diagnoses.name}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.diagnoses.expression}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.diagnoses.symptoms}::text) like ${`%${a}%`}`,(0,v.i6)`lower(${n.diagnoses.key}::text) like ${`%${a}%`}`))),m=[...d.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,isDraft:!0})),...o.map(e=>({...e.script,isDraft:!1}))].sort((e,t)=>e.position-t.position),h=[...c.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,screenId:e.screenId||e.screenDraftId,isDraft:!0})),...p.map(e=>({...e.screen,isDraft:!1}))].sort((e,t)=>e.position-t.position),y=[...f.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,diagnosisId:e.diagnosisId||e.diagnosisDraftId,isDraft:!0})),...u.map(e=>({...e.diagnosis,isDraft:!1}))].sort((e,t)=>e.position-t.position),I=[...y.map(e=>e.scriptId),...h.map(e=>e.scriptId)],g=(I=I.filter((e,t)=>I.indexOf(e)===t).filter(e=>-1===m.map(e=>e.scriptId).indexOf(e))).length?await r.Z.query.scriptsDrafts.findMany({where:(0,l.or)((0,l.d3)(n.scriptsDrafts.scriptId,I),(0,l.d3)(n.scriptsDrafts.scriptDraftId,I))}):[],D=I.length?await r.Z.select({script:n.scripts}).from(n.scripts).where((0,l.xD)((0,l.d3)(n.scripts.scriptId,I),g.length?(0,l.Nl)(n.scripts.scriptId,g.map(e=>e.scriptDraftId)):void 0)):[],w=[...g.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,isDraft:!0})),...D.map(e=>({...e.script,isDraft:!1}))].sort((e,t)=>e.position-t.position);return{data:function({searchValue:e,scripts:t,screens:i,diagnoses:s}){let{normalizedValue:a,isExactMatch:l}=(0,_.l)(e);if(!a)return[];let r=(0,_.y)(a),n=new RegExp(l?`^${r}$`:r,l?"":"i"),d="manual entry enter value manually custom value other specify",o={};return t.forEach(e=>{let t=[];`${e.title||""}`.match(n)&&t.push({field:"title",fieldValue:e.title}),`${e.printTitle||""}`.match(n)&&t.push({field:"printTitle",fieldValue:e.printTitle}),t.length&&(o[e.scriptId]={title:e.title,scriptId:e.scriptId,position:e.position,diagnoses:[],screens:[],matches:t})}),i.forEach(e=>{let t=[];`${e.title||""}`.match(n)&&t.push({field:"title",fieldValue:e.title}),`${e.key||""}`.match(n)&&t.push({field:"key",fieldValue:e.key}),`${e.refId||""}`.match(n)&&t.push({field:"refId",fieldValue:`${e.refId||""}`}),`${e.label||""}`.match(n)&&t.push({field:"label",fieldValue:e.label}),`${e.sectionTitle||""}`.match(n)&&t.push({field:"sectionTitle",fieldValue:e.sectionTitle}),`${e.previewTitle||""}`.match(n)&&t.push({field:"previewTitle",fieldValue:e.previewTitle}),`${e.previewPrintTitle||""}`.match(n)&&t.push({field:"previewPrintTitle",fieldValue:e.previewPrintTitle}),`${e.condition||""}`.match(n)&&t.push({field:"condition",fieldValue:e.condition}),(e.fields||[]).map((e,i)=>{`${e.key||""}`.match(n)&&t.push({field:"field_key",fieldIndex:i,fieldValue:e.key}),`${e.label||""}`.match(n)&&t.push({field:"field_label",fieldIndex:i,fieldValue:e.label}),`${e.condition||""}`.match(n)&&t.push({field:"field_condition",fieldIndex:i,fieldValue:e.condition}),(e.items||[]).map((e,s)=>{`${e.value||""}`.match(n)&&t.push({field:"field_item_key",fieldIndex:i,fieldItemIndex:s,fieldValue:e.value}),`${e.label||""}`.match(n)&&t.push({field:"field_item_label",fieldIndex:i,fieldItemIndex:s,fieldValue:e.label}),e.enterValueManually&&d.match(n)&&t.push({field:"field_item_manual_entry",fieldIndex:i,fieldItemIndex:s,fieldValue:"Enter value manually"}),`${e.enterValueManuallyLabel||""}`.match(n)&&t.push({field:"field_item_manual_label",fieldIndex:i,fieldItemIndex:s,fieldValue:`${e.enterValueManuallyLabel||""}`})})}),(e.items||[]).map((e,i)=>{`${e.id||""}`.match(n)&&t.push({field:"item_id",fieldIndex:i,fieldValue:e.id}),`${e.key||""}`.match(n)&&t.push({field:"item_key",fieldIndex:i,fieldValue:e.key}),`${e.label||""}`.match(n)&&t.push({field:"item_label",fieldIndex:i,fieldValue:e.label}),e.enterValueManually&&d.match(n)&&t.push({field:"item_manual_entry",fieldIndex:i,fieldValue:"Enter value manually"}),`${e.enterValueManuallyLabel||""}`.match(n)&&t.push({field:"item_manual_label",fieldIndex:i,fieldValue:`${e.enterValueManuallyLabel||""}`})}),(e.drugs||[]).map((e,i)=>{`${e.key||""}`.match(n)&&t.push({field:"drug",fieldIndex:i,fieldValue:e.key})}),(e.fluids||[]).map((e,i)=>{`${e.key||""}`.match(n)&&t.push({field:"fluid",fieldIndex:i,fieldValue:e.key})}),(e.feeds||[]).map((e,i)=>{`${e.key||""}`.match(n)&&t.push({field:"feed",fieldIndex:i,fieldValue:e.key})}),t.length&&(o[e.scriptId]=o[e.scriptId]||{title:"",scriptId:e.scriptId,position:e.scriptPosition,diagnoses:[],screens:[],matches:[]},o[e.scriptId].title=o[e.scriptId].title||e.scriptTitle,o[e.scriptId].screens.push({title:e.title,matches:t,screenId:e.screenId,isDraft:e.isDraft,position:e.position,fields:[...e.items.map(e=>({label:e.label,type:"item"})),...e.fields.map(e=>({label:e.label,type:"field"}))]}))}),s.forEach(e=>{let t=[];`${e.name||""}`.match(n)&&t.push({field:"name",fieldValue:e.name}),`${e.key||""}`.match(n)&&t.push({field:"key",fieldValue:e.key}),`${e.expression||""}`.match(n)&&t.push({field:"expression",fieldValue:e.expression}),(e.symptoms||[]).map((e,i)=>{`${e.key||""}`.match(n)&&t.push({field:"diagnosis_symptom_key",fieldIndex:i,fieldValue:e.key}),`${e.name||""}`.match(n)&&t.push({field:"diagnosis_symptom_name",fieldIndex:i,fieldValue:e.name}),`${e.expression||""}`.match(n)&&t.push({field:"diagnosis_symptom_expression",fieldIndex:i,fieldValue:e.expression})}),t.length&&(o[e.scriptId]=o[e.scriptId]||{title:"",scriptId:e.scriptId,position:e.scriptPosition,diagnoses:[],screens:[],matches:[]},o[e.scriptId].title=o[e.scriptId].title||e.scriptTitle,o[e.scriptId].diagnoses.push({title:e.name||"",position:e.position,matches:t,diagnosisId:e.diagnosisId,isDraft:e.isDraft,fields:[...e.symptoms.map(e=>({label:e.name,type:"diagnosis_symptom"}))]}))}),Object.values(o)}({searchValue:i,screens:h.map(e=>({...e,scriptTitle:w.find(t=>t.scriptId===e.scriptId)?.title||"",scriptPosition:w.find(t=>t.scriptId===e.scriptId)?.position||0})),diagnoses:y.map(e=>({...e,scriptTitle:w.find(t=>t.scriptId===e.scriptId)?.title||"",scriptPosition:w.find(t=>t.scriptId===e.scriptId)?.position||0})),scripts:m})}}catch(e){return d.Z.error("_searchScripts ERROR",e.message),{errors:[e.message],data:[]}}}}};