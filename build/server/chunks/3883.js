"use strict";exports.id=3883,exports.ids=[3883],exports.modules={92963:(e,i,n)=>{n.d(i,{sj:()=>g,LR:()=>y,h:()=>u,UZ:()=>d});var t=n(57745),o=n(81445),s=n(9576),r=n(57435),a=n(10413),f=n(93567),c=n(88317);async function d({data:e,broadcastAction:i,userId:n}){let d={success:!1};try{let i=[];for(let{configKeyId:r,...c}of e)try{let e=r||s.Z();if(!i.length){let i=r?await a.Z.query.configKeysDrafts.findFirst({where:(0,t.eq)(f.configKeysDrafts.configKeyDraftId,e)}):null,s=i||!r?null:await a.Z.query.configKeys.findFirst({where:(0,t.eq)(f.configKeys.configKeyId,e)});if(i){let n={...i.data,...c};await a.Z.update(f.configKeysDrafts).set({data:n,position:n.position}).where((0,t.eq)(f.configKeysDrafts.configKeyDraftId,e))}else{let i=c.position||s?.position;if(!i){let e=await a.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,o.C)(f.configKeys.position)}),n=await a.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,o.C)(f.configKeysDrafts.position)});i=Math.max(0,e?.position||0,n?.position||0)+1}let t={...s,...c,configKeyId:e,version:s?.version?s.version+1:1,position:i};await a.Z.insert(f.configKeysDrafts).values({data:t,configKeyDraftId:e,position:t.position,configKeyId:s?.configKeyId,createdByUserId:n})}}}catch(e){i.push(e.message)}i.length?d.errors=i:d.success=!0}catch(e){d.success=!1,d.errors=[e.message],r.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!d?.errors?.length&&i&&c.Z.emit("data_changed","save_config_keys"),d}}async function g(e){try{return await a.Z.delete(f.configKeysDrafts).where(e?.userId?(0,t.eq)(f.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function y({configKeysIds:e,broadcastAction:i,userId:n}){let o={success:!1};try{if(e.length){await a.Z.delete(f.configKeysDrafts).where((0,t.d3)(f.configKeysDrafts.configKeyDraftId,e));let i=(await a.Z.select({configKeyId:f.configKeys.configKeyId,pendingDeletion:f.pendingDeletion.configKeyId}).from(f.configKeys).leftJoin(f.pendingDeletion,(0,t.eq)(f.pendingDeletion.configKeyId,f.configKeys.configKeyId)).where((0,t.d3)(f.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:n}));i.length&&await a.Z.insert(f.pendingDeletion).values(i)}o.success=!0}catch(e){o.success=!1,o.errors=[e.message],r.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!o?.errors?.length&&i&&c.Z.emit("data_changed","delete_config_keys"),o}}async function l({previous:e,drafts:i}){try{let n=[];for(let t of i){let i={version:t?.data?.version||1,configKeyId:t?.data?.configKeyId,changes:{}};if(t?.data?.version===1)i.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let n=e.filter(e=>e.configKeyId===t?.data?.configKeyId)[0],o=[],s=[];Object.keys({...t?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let i=t.data[e],r={...n}[e];JSON.stringify(i)!==JSON.stringify(r)&&(o.push({[e]:r}),s.push({[e]:i}))}),i.changes={action:"update_config_key",description:"Update config key",oldValues:o,newValues:s}}n.push(i)}await a.Z.insert(f.configKeysHistory).values(n)}catch(e){r.Z.error(e.message)}}var K=n(34149);async function u(e){let i={success:!1};try{let n=[],o=[],r=await a.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,t.eq)(f.configKeysDrafts.createdByUserId,e?.userId):void 0});if(n=r.filter(e=>e.configKeyId),o=r.filter(e=>!e.configKeyId),n.length){let e=[];for(let{configKeyId:i,data:o}of(n.filter(e=>e.configKeyId).length&&(e=await a.Z.query.configKeys.findMany({where:(0,t.d3)(f.configKeys.configKeyId,n.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),n)){let{configKeyId:e,id:n,oldConfigKeyId:s,createdAt:r,updatedAt:c,deletedAt:d,...g}=o,y={...g,publishDate:new Date};await a.Z.update(f.configKeys).set(y).where((0,t.eq)(f.configKeys.configKeyId,i)).returning()}await l({drafts:n,previous:e})}if(o.length){let e=[];for(let{id:i,data:n}of(o.filter(e=>e.configKeyId).length&&(e=await a.Z.query.configKeys.findMany({where:(0,t.d3)(f.configKeys.configKeyId,o.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),o)){let e=n.configKeyId||(0,s.Z)(),t={...n,configKeyId:e};o=o.map(n=>(n.id===i&&(n.data.configKeyId=e),n)),await a.Z.insert(f.configKeys).values(t)}await l({drafts:o,previous:e})}await a.Z.delete(f.configKeysDrafts);let c=await a.Z.query.pendingDeletion.findMany({where:(0,t.xD)((0,t.K0)(f.pendingDeletion.configKeyId),e?.userId?(0,t.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:{columns:{version:!0}}}});if((c=c.filter(e=>e.configKey)).length){let e=new Date;await a.Z.update(f.configKeys).set({deletedAt:e}).where((0,t.d3)(f.configKeys.configKeyId,c.map(e=>e.configKeyId))),await a.Z.insert(f.configKeysHistory).values(c.map(i=>({version:i.configKey.version,configKeyId:i.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await a.Z.delete(f.pendingDeletion).where((0,t.xD)((0,t.or)((0,t.K0)(f.pendingDeletion.configKeyId),(0,t.K0)(f.pendingDeletion.configKeyDraftId)),e?.userId?(0,t.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0));let d=[...n.map(e=>e.configKeyId),...c.map(e=>e.configKeyId)];d.length&&await a.Z.update(f.configKeys).set({version:(0,K.i6)`${f.configKeys.version} + 1`}).where((0,t.d3)(f.configKeys.configKeyId,d)),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],r.Z.error("_publishConfigKeys ERROR",e)}finally{return i}}},17137:(e,i,n)=>{n.d(i,{G$:()=>l,ZV:()=>y,SL:()=>d,aP:()=>c});var t=n(57745),o=n(30900),s=n(9576),r=n(10413),a=n(93567),f=n(57435);async function c(e){try{let{configKeysIds:i,returnDraftsIfExist:n}={...e},f=i||[],c=f?.length?(0,t.d3)(a.configKeysDrafts.configKeyDraftId,f.map(e=>o.Z(e)?e:s.Z())):void 0,d=[...c?[c]:[]],g=n?await r.Z.query.configKeysDrafts.findMany({where:(0,t.xD)(...d)}):[];f=f.filter(e=>!g.map(e=>e.configKeyDraftId).includes(e));let y=g.length?(0,t.Nl)(a.configKeys.configKeyId,g.map(e=>e.configKeyDraftId)):void 0,l=f?.length?(0,t.d3)(a.configKeys.configKeyId,f.filter(e=>o.Z(e))):void 0,K=f?.length?(0,t.d3)(a.configKeys.oldConfigKeyId,f.filter(e=>!o.Z(e))):void 0,u=[(0,t.Ft)(a.configKeys.deletedAt),(0,t.Ft)(a.pendingDeletion),...l&&K?[(0,t.or)(l,K)]:[],y],I=(await r.Z.select({configKey:a.configKeys,pendingDeletion:a.pendingDeletion}).from(a.configKeys).leftJoin(a.pendingDeletion,(0,t.eq)(a.pendingDeletion.configKeyId,a.configKeys.configKeyId)).where(u.length?(0,t.xD)(...u):void 0)).map(e=>e.configKey),D=I.length?await r.Z.query.pendingDeletion.findMany({where:(0,t.d3)(a.pendingDeletion.configKeyId,I.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...I.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,i)=>e.position-i.position).filter(e=>!D.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return f.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function d(e){let{configKeyId:i,returnDraftIfExists:n}={...e};try{if(!i)throw Error("Missing configKeyId");let e=o.Z(i)?(0,t.eq)(a.configKeys.configKeyId,i):void 0,s=o.Z(i)?void 0:(0,t.eq)(a.configKeys.oldConfigKeyId,i),f=e?(0,t.eq)(a.configKeysDrafts.configKeyDraftId,i):void 0,c=n&&f?await r.Z.query.configKeysDrafts.findFirst({where:e}):void 0,d=c?{...c.data,draftCreatedByUserId:c.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(d)return{data:d};let g=await r.Z.query.configKeys.findFirst({where:(0,t.xD)((0,t.Ft)(a.configKeys.deletedAt),e||s),with:{draft:!0}});c=n?g?.draft:void 0;let y=c?.data||g;if(!(d=y?{...y,draftCreatedByUserId:c?.createdByUserId,isDraft:!!c?.data,isDeleted:!1}:null))return{data:null};return{data:d}}catch(e){return f.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var g=n(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function l(){try{let[{count:e}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts),[{count:i}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,t.Ft)(a.configKeysDrafts.configKeyId)),[{count:n}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,t.K0)(a.configKeysDrafts.configKeyId)),[{count:o}]=await r.Z.select({count:(0,g.QX)()}).from(a.pendingDeletion).where((0,t.K0)(a.pendingDeletion.configKeyId)),[{count:s}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeys);return{data:{allPublished:s,publishedWithDrafts:n,allDrafts:e,newDrafts:i,pendingDeletion:o}}}catch(e){return f.Z.error("_getConfigKeys ERROR",e.message),{data:y,errors:[e.message]}}}}};