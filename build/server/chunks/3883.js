"use strict";exports.id=3883,exports.ids=[3883],exports.modules={92963:(e,i,n)=>{n.d(i,{sj:()=>g,LR:()=>y,h:()=>p,UZ:()=>c});var t=n(57745),s=n(81445),o=n(9576),r=n(57435),a=n(10413),f=n(93567),d=n(88317);async function c({data:e,broadcastAction:i,userId:n}){let c={success:!1};try{let i=[];for(let{configKeyId:r,...d}of e)try{let e=r||o.Z();if(!i.length){let i=r?await a.Z.query.configKeysDrafts.findFirst({where:(0,t.eq)(f.configKeysDrafts.configKeyDraftId,e)}):null,o=i||!r?null:await a.Z.query.configKeys.findFirst({where:(0,t.eq)(f.configKeys.configKeyId,e)});if(i){let n={...i.data,...d};await a.Z.update(f.configKeysDrafts).set({data:n,position:n.position}).where((0,t.eq)(f.configKeysDrafts.configKeyDraftId,e))}else{let i=d.position||o?.position;if(!i){let e=await a.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,s.C)(f.configKeys.position)}),n=await a.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,s.C)(f.configKeysDrafts.position)});i=Math.max(0,e?.position||0,n?.position||0)+1}let t={...o,...d,configKeyId:e,version:o?.version?o.version+1:1,position:i};await a.Z.insert(f.configKeysDrafts).values({data:t,configKeyDraftId:e,position:t.position,configKeyId:o?.configKeyId,createdByUserId:n})}}}catch(e){i.push(e.message)}i.length?c.errors=i:c.success=!0}catch(e){c.success=!1,c.errors=[e.message],r.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!c?.errors?.length&&i&&d.Z.emit("data_changed","save_config_keys"),c}}async function g(e){try{return await a.Z.delete(f.configKeysDrafts).where(e?.userId?(0,t.eq)(f.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function y({configKeysIds:e,broadcastAction:i,userId:n}){let s={success:!1};try{if(e.length){await a.Z.delete(f.configKeysDrafts).where((0,t.d3)(f.configKeysDrafts.configKeyDraftId,e));let i=(await a.Z.select({configKeyId:f.configKeys.configKeyId,pendingDeletion:f.pendingDeletion.configKeyId}).from(f.configKeys).leftJoin(f.pendingDeletion,(0,t.eq)(f.pendingDeletion.configKeyId,f.configKeys.configKeyId)).where((0,t.d3)(f.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:n}));i.length&&await a.Z.insert(f.pendingDeletion).values(i)}s.success=!0}catch(e){s.success=!1,s.errors=[e.message],r.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!s?.errors?.length&&i&&d.Z.emit("data_changed","delete_config_keys"),s}}async function l({previous:e,drafts:i,userId:n}){let t=[];try{let s=[];for(let o of i){let i=o?.data?.configKeyId;if(!i)continue;let r={version:o?.data?.version||1,configKeyId:i,changes:{}},a=1===(o?.data?.version||1);if(a)r.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let n=e.find(e=>e.configKeyId===i),t=[],s=[];Object.keys({...o?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let i=o.data[e],r={...n}[e];JSON.stringify(i)!==JSON.stringify(r)&&(t.push({[e]:r}),s.push({[e]:i}))}),r.changes={action:"update_config_key",description:"Update config key",oldValues:t,newValues:s}}if(s.push(r),n){let{...s}=o.data||{},f=JSON.parse(JSON.stringify(s)),d=a?{}:JSON.parse(JSON.stringify(e.find(e=>e.configKeyId===i)||{}));t.push({entityId:i,entityType:"config_key",action:a?"create":"update",version:r.version||1,changes:r.changes,fullSnapshot:f,previousSnapshot:d,baselineSnapshot:d,userId:n,configKeyId:i})}}s.length&&await a.Z.insert(f.configKeysHistory).values(s)}catch(e){r.Z.error(e.message)}return t}var K=n(34149),u=n(36864);async function p(e){let i={success:!1},n=[];try{let s=[],r=[],d=await a.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,t.eq)(f.configKeysDrafts.createdByUserId,e?.userId):void 0});if(s=d.filter(e=>e.configKeyId),r=d.filter(e=>!e.configKeyId),s.length){let i=[];for(let{configKeyId:e,data:n}of(s.filter(e=>e.configKeyId).length&&(i=await a.Z.query.configKeys.findMany({where:(0,t.d3)(f.configKeys.configKeyId,s.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),s)){let{configKeyId:i,id:s,oldConfigKeyId:o,createdAt:r,updatedAt:d,deletedAt:c,...g}=n,y={...g,publishDate:new Date};await a.Z.update(f.configKeys).set(y).where((0,t.eq)(f.configKeys.configKeyId,e)).returning()}let o=await l({drafts:s,previous:i,userId:e?.publisherUserId});n.push(...o.map(i=>({...i,dataVersion:e?.dataVersion})))}if(r.length){let i=[];for(let{id:e,data:n}of(r.filter(e=>e.configKeyId).length&&(i=await a.Z.query.configKeys.findMany({where:(0,t.d3)(f.configKeys.configKeyId,r.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),r)){let i=n.configKeyId||(0,o.Z)(),t={...n,configKeyId:i};r=r.map(n=>(n.id===e&&(n.data.configKeyId=i),n)),await a.Z.insert(f.configKeys).values(t)}let s=await l({drafts:r,previous:i,userId:e?.publisherUserId});n.push(...s.map(i=>({...i,dataVersion:e?.dataVersion})))}await a.Z.delete(f.configKeysDrafts).where(e?.userId?(0,t.eq)(f.configKeysDrafts.createdByUserId,e.userId):void 0);let c=await a.Z.query.pendingDeletion.findMany({where:(0,t.xD)((0,t.K0)(f.pendingDeletion.configKeyId),e?.userId?(0,t.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:!0}});if((c=c.filter(e=>e.configKey)).length){let i=new Date;await a.Z.update(f.configKeys).set({deletedAt:i}).where((0,t.d3)(f.configKeys.configKeyId,c.map(e=>e.configKeyId)));let s=c.map(e=>({version:e.configKey.version,configKeyId:e.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:i}]}}));if(await a.Z.insert(f.configKeysHistory).values(s),e?.publisherUserId)for(let t=0;t<c.length;t++){let o=c[t],r=s[t];if(!o?.configKeyId)continue;let a={...o.configKey??{},deletedAt:i};n.push({entityId:o.configKeyId,entityType:"config_key",action:"delete",version:r.version||1,dataVersion:e.dataVersion,changes:r.changes,fullSnapshot:JSON.parse(JSON.stringify(a)),previousSnapshot:JSON.parse(JSON.stringify(a)),baselineSnapshot:JSON.parse(JSON.stringify(a)),description:r.changes.description,userId:e.publisherUserId,configKeyId:o.configKeyId,isActive:!1})}}await a.Z.delete(f.pendingDeletion).where((0,t.xD)((0,t.or)((0,t.K0)(f.pendingDeletion.configKeyId),(0,t.K0)(f.pendingDeletion.configKeyDraftId)),e?.userId?(0,t.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...s.map(e=>e.configKeyId),...c.map(e=>e.configKeyId)];g.length&&await a.Z.update(f.configKeys).set({version:(0,K.i6)`${f.configKeys.version} + 1`}).where((0,t.d3)(f.configKeys.configKeyId,g)),n.length&&await (0,u.F)({data:n}),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],r.Z.error("_publishConfigKeys ERROR",e)}finally{return i}}},17137:(e,i,n)=>{n.d(i,{G$:()=>l,ZV:()=>y,SL:()=>c,aP:()=>d});var t=n(57745),s=n(30900),o=n(9576),r=n(10413),a=n(93567),f=n(57435);async function d(e){try{let{configKeysIds:i,returnDraftsIfExist:n}={...e},f=i||[],d=f?.length?(0,t.d3)(a.configKeysDrafts.configKeyDraftId,f.map(e=>s.Z(e)?e:o.Z())):void 0,c=[...d?[d]:[]],g=n?await r.Z.query.configKeysDrafts.findMany({where:(0,t.xD)(...c)}):[];f=f.filter(e=>!g.map(e=>e.configKeyDraftId).includes(e));let y=g.length?(0,t.Nl)(a.configKeys.configKeyId,g.map(e=>e.configKeyDraftId)):void 0,l=f?.length?(0,t.d3)(a.configKeys.configKeyId,f.filter(e=>s.Z(e))):void 0,K=f?.length?(0,t.d3)(a.configKeys.oldConfigKeyId,f.filter(e=>!s.Z(e))):void 0,u=[(0,t.Ft)(a.configKeys.deletedAt),(0,t.Ft)(a.pendingDeletion),...l&&K?[(0,t.or)(l,K)]:[],y],p=(await r.Z.select({configKey:a.configKeys,pendingDeletion:a.pendingDeletion}).from(a.configKeys).leftJoin(a.pendingDeletion,(0,t.eq)(a.pendingDeletion.configKeyId,a.configKeys.configKeyId)).where(u.length?(0,t.xD)(...u):void 0)).map(e=>e.configKey),I=p.length?await r.Z.query.pendingDeletion.findMany({where:(0,t.d3)(a.pendingDeletion.configKeyId,p.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...p.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,i)=>e.position-i.position).filter(e=>!I.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return f.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){let{configKeyId:i,returnDraftIfExists:n}={...e};try{if(!i)throw Error("Missing configKeyId");let e=s.Z(i)?(0,t.eq)(a.configKeys.configKeyId,i):void 0,o=s.Z(i)?void 0:(0,t.eq)(a.configKeys.oldConfigKeyId,i),f=e?(0,t.eq)(a.configKeysDrafts.configKeyDraftId,i):void 0,d=n&&f?await r.Z.query.configKeysDrafts.findFirst({where:e}):void 0,c=d?{...d.data,draftCreatedByUserId:d.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(c)return{data:c};let g=await r.Z.query.configKeys.findFirst({where:(0,t.xD)((0,t.Ft)(a.configKeys.deletedAt),e||o),with:{draft:!0}});d=n?g?.draft:void 0;let y=d?.data||g;if(!(c=y?{...y,draftCreatedByUserId:d?.createdByUserId,isDraft:!!d?.data,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return f.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var g=n(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function l(){try{let[{count:e}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts),[{count:i}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,t.Ft)(a.configKeysDrafts.configKeyId)),[{count:n}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,t.K0)(a.configKeysDrafts.configKeyId)),[{count:s}]=await r.Z.select({count:(0,g.QX)()}).from(a.pendingDeletion).where((0,t.K0)(a.pendingDeletion.configKeyId)),[{count:o}]=await r.Z.select({count:(0,g.QX)()}).from(a.configKeys);return{data:{allPublished:o,publishedWithDrafts:n,allDrafts:e,newDrafts:i,pendingDeletion:s}}}catch(e){return f.Z.error("_getConfigKeys ERROR",e.message),{data:y,errors:[e.message]}}}}};