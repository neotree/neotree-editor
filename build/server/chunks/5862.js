"use strict";exports.id=5862,exports.ids=[5862],exports.modules={45862:(e,t,a)=>{a.r(t),a.d(t,{$$ACTION_0:()=>ea,$$ACTION_1:()=>er,$$ACTION_10:()=>ew,$$ACTION_11:()=>eR,$$ACTION_12:()=>eE,$$ACTION_13:()=>eV,$$ACTION_14:()=>eO,$$ACTION_15:()=>eq,$$ACTION_16:()=>eZ,$$ACTION_17:()=>eN,$$ACTION_18:()=>eS,$$ACTION_19:()=>ex,$$ACTION_2:()=>ei,$$ACTION_20:()=>eF,$$ACTION_21:()=>eJ,$$ACTION_22:()=>eX,$$ACTION_3:()=>eg,$$ACTION_4:()=>ed,$$ACTION_5:()=>el,$$ACTION_6:()=>ey,$$ACTION_7:()=>ep,$$ACTION_8:()=>em,$$ACTION_9:()=>ev,countChangeLogs:()=>eu,countChangeLogsByAction:()=>eL,countChangeLogsByEntity:()=>ef,countChangeLogsByUser:()=>eI,countEntityVersions:()=>eb,findRelatedChanges:()=>eK,getActiveVersion:()=>eo,getChangeLog:()=>es,getChangeLogStats:()=>eh,getChangeLogs:()=>et,getDataVersionSummaries:()=>e$,getEntityHistory:()=>en,getVersionChain:()=>ec,markVersionAsSuperseded:()=>eB,rollbackChangeLog:()=>eU,rollbackDataVersion:()=>eM,saveChangeLog:()=>ek,saveChangeLogs:()=>e_,searchChangeLogs:()=>eA,searchChangeLogsByDateRange:()=>eD,searchChangeLogsByUser:()=>eT,searchChangesByField:()=>eC,updateChangeLog:()=>ej});var s=a(24330);a(60166);var r=a(36864),n=a(57745),i=a(30900),o=a(57435),g=a(10413),c=a(93567),d=a(88317);async function h({data:e,broadcastAction:t}){let a={success:!1};try{if(!e.changeLogId&&(!e.entityId||void 0===e.version))throw Error("Either changeLogId or entityId+version is required");let s=e.changeLogId&&i.Z(e.changeLogId)?(0,n.eq)(c.changeLogs.changeLogId,e.changeLogId):(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e.entityId),(0,n.eq)(c.changeLogs.version,e.version)),r={};void 0!==e.isActive&&(r.isActive=e.isActive),void 0!==e.supersededBy&&(r.supersededBy=e.supersededBy),void 0!==e.supersededAt&&(r.supersededAt=e.supersededAt),void 0!==e.description&&(r.description=e.description),void 0!==e.changeReason&&(r.changeReason=e.changeReason);let[o]=await g.Z.update(c.changeLogs).set(r).where(s).returning();if(!o)throw Error("Change log not found");return a.success=!0,a.data=o,t&&d.Z.emit("data_changed","update_change_log"),a}catch(e){return a.success=!1,a.errors=[e.message],o.Z.error("_updateChangeLog ERROR",e.message),a}}async function l({entityId:e,version:t,supersededBy:a,broadcastAction:s}){return h({data:{entityId:e,version:t,isActive:!1,supersededBy:a,supersededAt:new Date},broadcastAction:s})}let u={script:{table:c.scripts,pk:c.scripts.scriptId,pkKey:"scriptId",versionKey:"version",publishDateKey:"publishDate"},screen:{table:c.screens,pk:c.screens.screenId,pkKey:"screenId",versionKey:"version",publishDateKey:"publishDate"},diagnosis:{table:c.diagnoses,pk:c.diagnoses.diagnosisId,pkKey:"diagnosisId",versionKey:"version",publishDateKey:"publishDate"},config_key:{table:c.configKeys,pk:c.configKeys.configKeyId,pkKey:"configKeyId",versionKey:"version",publishDateKey:"publishDate"},drugs_library:{table:c.drugsLibrary,pk:c.drugsLibrary.itemId,pkKey:"itemId",versionKey:"version",publishDateKey:"publishDate"},data_key:{table:c.dataKeys,pk:c.dataKeys.uuid,pkKey:"uuid",versionKey:"version",publishDateKey:"publishDate"},alias:{table:c.aliases,pk:c.aliases.uuid,pkKey:"uuid",publishDateKey:"publishDate"},hospital:{table:c.hospitals,pk:c.hospitals.hospitalId,pkKey:"hospitalId",versionKey:"version",publishDateKey:"publishDate"}};function y(e){if(e&&"string"==typeof e)try{return JSON.parse(e)}catch{return{}}return e??{}}async function f({tx:e,binding:t,entityId:a,snapshot:s,newVersion:r}){var i,o;let g=new Date,c=(i=s??{},Object.keys(o=t.table).filter(e=>{let t=o[e];return t&&"object"==typeof t&&"name"in t}).reduce((e,t)=>(void 0!==i[t]&&(e[t]=i[t]),e),{}));c[t.pkKey]=a,t.versionKey&&(c[t.versionKey]=r),t.publishDateKey&&(c[t.publishDateKey]=g),"updatedAt"in t.table&&(c.updatedAt=g);let[d]=await e.update(t.table).set(c).where((0,n.eq)(t.pk,a)).returning();if(d)return d;let h={...c};delete h.id;let[l]=await e.insert(t.table).values(h).returning();return l}async function p({entityId:e,toVersion:t,userId:a,changeReason:s,broadcastAction:h}){let l={success:!1};try{if(!e||!i.Z(e))throw Error("Invalid entityId");let o=await g.Z.transaction(async i=>{let o=await i.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e),(0,n.eq)(c.changeLogs.isActive,!0)),orderBy:(e,{desc:t})=>[t(e.version)]});if(!o)throw Error("No active version found for entity");let g=Number.isFinite(o.parentVersion)?o.parentVersion:void 0,d=(void 0!==g?await i.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e),(0,n.eq)(c.changeLogs.version,g))}):await i.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e),(0,n.lt)(c.changeLogs.version,o.version)),orderBy:(e,{desc:t})=>[t(e.version)]}))??null;if(!d)throw Error("No previous version available to restore");let h=d.version;if(void 0!==t&&t!==h)throw Error(`Can only restore to immediate previous version (${h})`);if(!d)throw Error(`Previous version ${h} not found for entity`);if(d.entityType!==o.entityType)throw Error("Entity type mismatch between current and previous versions");if(!d.fullSnapshot)throw Error(`Previous version ${h} is missing a full snapshot`);let l=u[o.entityType];if(!l)throw Error(`Unsupported entity type ${o.entityType}`);let p=await i.query.editorInfo.findFirst(),L=(p?.dataVersion??o.dataVersion??0)+1,m=`Rollback to version ${d.version}`,I=y(d.fullSnapshot),v=y(o.fullSnapshot),b={entityId:e,entityType:o.entityType,action:"rollback",changes:[{action:"rollback",description:m,fromVersion:o.version,toVersion:d.version}],fullSnapshot:I,previousSnapshot:v,description:m,changeReason:s||m,parentVersion:o.version,dataVersion:L,isActive:!0,userId:a,scriptId:d.scriptId,screenId:d.screenId,diagnosisId:d.diagnosisId,configKeyId:d.configKeyId,hospitalId:d.hospitalId,drugsLibraryItemId:d.drugsLibraryItemId,dataKeyId:d.dataKeyId,aliasId:d.aliasId},w=await (0,r.C)({data:b,broadcastAction:!1,client:i});if(!w.success||!w.data)throw Error(w.errors?.join(", ")||"Failed to save rollback changelog");if(!await f({tx:i,binding:l,entityId:e,snapshot:I,newVersion:w.data.version}))throw Error("Failed to apply snapshot to entity");return p&&await i.update(c.editorInfo).set({dataVersion:L,lastPublishDate:new Date}).where((0,n.eq)(c.editorInfo.id,p.id)),w.data});return l.success=!0,l.newVersion=o?.version,l.data=o,h&&d.Z.emit("data_changed","rollback_change_log"),l}catch(e){return l.success=!1,l.errors=[e.message],o.Z.error("_rollbackChangeLog ERROR",e.message),l}}var L=a(34149),m=a(84770),I=a(84878);let v={script:{table:c.scripts,pk:c.scripts.scriptId,pkKey:"scriptId",versionKey:"version",publishDateKey:"publishDate",numericKeys:["position"],timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},screen:{table:c.screens,pk:c.screens.screenId,pkKey:"screenId",versionKey:"version",publishDateKey:"publishDate",numericKeys:["position","timerValue","multiplier","minValue","maxValue"],timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},diagnosis:{table:c.diagnoses,pk:c.diagnoses.diagnosisId,pkKey:"diagnosisId",versionKey:"version",publishDateKey:"publishDate",numericKeys:["position","severityOrder"],timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},config_key:{table:c.configKeys,pk:c.configKeys.configKeyId,pkKey:"configKeyId",versionKey:"version",publishDateKey:"publishDate",numericKeys:["position"],timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},drugs_library:{table:c.drugsLibrary,pk:c.drugsLibrary.itemId,pkKey:"itemId",versionKey:"version",publishDateKey:"publishDate",numericKeys:["minGestation","maxGestation","minWeight","maxWeight","minAge","maxAge","hourlyFeed","hourlyFeedDivider","dosage","dosageMultiplier"],timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},data_key:{table:c.dataKeys,pk:c.dataKeys.uuid,pkKey:"uuid",versionKey:"version",publishDateKey:"publishDate",timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},alias:{table:c.aliases,pk:c.aliases.uuid,pkKey:"uuid",publishDateKey:"publishDate",timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]},hospital:{table:c.hospitals,pk:c.hospitals.hospitalId,pkKey:"hospitalId",versionKey:"version",publishDateKey:"publishDate",timestampKeys:["publishDate","createdAt","updatedAt","deletedAt"]}};function b(e){return(0,m.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function w(e,t){if(t.snapshotHash)return t.snapshotHash;let a=b(t.fullSnapshot);return t.id&&await e.update(c.changeLogs).set({snapshotHash:a}).where((0,n.eq)(c.changeLogs.id,t.id)),a}function $(e){if(e&&"string"==typeof e)try{return JSON.parse(e)}catch{return{}}return e??{}}async function R({tx:e,binding:t,entityId:a}){await e.select({lock:(0,L.i6)`1`}).from(t.table).where((0,n.eq)(t.pk,a)).for("update")}async function A({tx:e,binding:t,entityId:a,snapshot:s,newVersion:r}){var i,o;let g=new Date,c=(i=s??{},Object.keys(o=t.table).filter(e=>{let t=o[e];return t&&"object"==typeof t&&"name"in t}).reduce((e,t)=>(void 0!==i[t]&&(e[t]=i[t]),e),{}));(function(e){let t=/(_at|_on|_date|_time|Date$|Time$)/i;for(let a of Object.keys(e).filter(e=>t.test(e))){let t=e[a];if(!(t instanceof Date)){if(t&&("string"==typeof t||"number"==typeof t)){let s=new Date(t);if(!isNaN(s.valueOf())){e[a]=s;continue}}e[a]=null}}})(c),t.numericKeys?.length&&function(e,t){for(let a of t){if(!(a in e))continue;let t=e[a],s="number"==typeof t?t:Number(t);e[a]=Number.isFinite(s)?s:null}}(c,t.numericKeys),t.timestampKeys?.length&&function(e,t){for(let a of t){if(!(a in e))continue;let t=e[a];if(!(t instanceof Date)){if(t&&("string"==typeof t||"number"==typeof t)){let s=new Date(t);if(!isNaN(s.valueOf())){e[a]=s;continue}}e[a]=null}}}(c,t.timestampKeys),t.forceNullKeys?.length&&function(e,t){for(let a of t)a in e&&(e[a]=null)}(c,t.forceNullKeys),c[t.pkKey]=a,t.versionKey&&(c[t.versionKey]=r),t.publishDateKey&&(c[t.publishDateKey]=g),"updatedAt"in t.table&&(c.updatedAt=g),"createdAt"in t.table&&(null===c.createdAt||void 0===c.createdAt)&&(c.createdAt=g);let[d]=await e.update(t.table).set(c).where((0,n.eq)(t.pk,a)).returning();if(d)return d;let h={...c};delete h.id;let[l]=await e.insert(t.table).values(h).returning();return l}async function E(e,t,a){return await e.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,t.entityId),(0,n.eq)(c.changeLogs.entityType,t.entityType),(0,n.lt)(c.changeLogs.dataVersion,a)),orderBy:(e,{desc:t})=>[t(e.dataVersion),t(e.version)]})||(await e.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,t.entityId),(0,n.eq)(c.changeLogs.entityType,t.entityType),(0,n.lt)(c.changeLogs.version,t.version)),orderBy:(e,{desc:t})=>[t(e.version)]})??t)}async function C({dataVersion:e,userId:t,changeReason:a,createdEntityPolicy:s="keep"}){let i;let d={success:!1};try{if(!(0,I.X)(t))throw Error("Invalid userId");return await g.Z.transaction(async o=>{let g=await o.execute((0,L.i6)`select id, data_version as "dataVersion" from nt_editor_info limit 1 for update`),d=g?.[0],h=e??d?.dataVersion;if(!h||h<2)throw Error("No data version to rollback or already at initial version");if(!d||d.dataVersion!==h)throw Error("Data version drift detected; reload and try again");let l=h-1;if(l<1)throw Error("No previous data version available to restore");let u=h+1;i=u,await o.execute((0,L.i6)`select id from nt_change_logs where data_version = ${h} and is_active = true for update`);let y=await o.query.changeLogs.findMany({where:(0,n.xD)((0,n.eq)(c.changeLogs.dataVersion,h),(0,n.eq)(c.changeLogs.isActive,!0)),orderBy:(e,{asc:t})=>[t(e.entityType),t(e.entityId)]});if(!y.length)throw Error(`No active changes found for data version v${h}`);for(let e of y){let t=await o.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e.entityId),(0,n.eq)(c.changeLogs.entityType,e.entityType),(0,n.lt)(c.changeLogs.dataVersion,h)),orderBy:(e,{desc:t})=>[t(e.dataVersion),t(e.version)]})??e;if(!t.fullSnapshot)throw Error(`Previous snapshot missing for ${e.entityId}`);if(t.entityType!==e.entityType)throw Error(`Entity type mismatch for ${e.entityId}`);let a=b(t.fullSnapshot);if(await w(o,t)!==a)throw Error(`Snapshot hash mismatch for ${e.entityId} v${t.version}`);let s=await w(o,e),r=b(e.fullSnapshot);if(s!==r)throw Error(`Snapshot hash mismatch for current ${e.entityId} v${e.version}`)}let f=y.filter(e=>"script"===e.entityType),p=y.filter(e=>"script"!==e.entityType),m="soft_delete"===s;for(let e of f){let s=v[e.entityType];if(!s)throw Error(`Unsupported entity type ${e.entityType}`);await R({tx:o,binding:s,entityId:e.entityId});let i=await E(o,e,h);if(!i.fullSnapshot)throw Error(`Missing previous script snapshot ${e.entityId}`);let g=[];for(let t of(g.push({current:e,target:i,binding:s,createdInCurrentVersion:i.dataVersion===h}),["screen","diagnosis"]))for(let a of y.filter(a=>a.entityType===t&&a.scriptId===e.scriptId)){let e=v[t];if(!e)throw Error(`Unsupported entity type ${t}`);await R({tx:o,binding:e,entityId:a.entityId});let s=await o.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,a.entityId),(0,n.eq)(c.changeLogs.entityType,a.entityType),(0,n.lt)(c.changeLogs.dataVersion,h)),orderBy:(e,{desc:t})=>[t(e.dataVersion),t(e.version)]}),r=await E(o,a,h),i=s??r;if(!i||!i.fullSnapshot)throw Error(`Missing previous snapshot for child entity ${a.entityId}`);g.push({current:a,target:i,binding:e,createdInCurrentVersion:!s||s.dataVersion===h})}for(let{current:e,target:s,binding:n,createdInCurrentVersion:i}of g){let g=s??e,c=`Rollback release v${h} -> v${u} (state of v${l})`,d=$(g.fullSnapshot),y=$(e.fullSnapshot);m&&i&&(d.deletedAt=new Date().toISOString());let f={entityId:e.entityId,entityType:e.entityType,action:"rollback",changes:[{action:"rollback",description:c,fromVersion:e.version,toVersion:g.version??e.version,fromDataVersion:h,toDataVersion:l}],fullSnapshot:d,previousSnapshot:y,description:c,changeReason:a||c,parentVersion:e.version,dataVersion:u,isActive:!0,userId:t,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,hospitalId:"hospital"===e.entityType?e.entityId:void 0},p=await (0,r.C)({data:f,client:o});if(!p.success||!p.data)throw Error(p.errors?.join(", ")||`Failed to rollback ${e.entityId}`);if(!await A({tx:o,binding:n,entityId:e.entityId,snapshot:d,newVersion:g.version??p.data.version}))throw Error(`Failed to apply snapshot for ${e.entityId}`)}}for(let e of p){let s=v[e.entityType];if(!s)throw Error(`Unsupported entity type ${e.entityType}`);await R({tx:o,binding:s,entityId:e.entityId});let i=await o.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,e.entityId),(0,n.eq)(c.changeLogs.entityType,e.entityType),(0,n.lt)(c.changeLogs.dataVersion,h)),orderBy:(e,{desc:t})=>[t(e.dataVersion),t(e.version)]}),g=await E(o,e,h),d=i??g;if(!d||!d.fullSnapshot)throw Error(`Previous snapshot missing for ${e.entityId}`);let y=`Rollback release v${h} -> v${u} (state of v${l})`,f=$(d.fullSnapshot),p=$(e.fullSnapshot),L=!i||i.dataVersion===h;m&&L&&(f.deletedAt=new Date().toISOString());let I={entityId:e.entityId,entityType:e.entityType,action:"rollback",changes:[{action:"rollback",description:y,fromVersion:e.version,toVersion:d.version??e.version,fromDataVersion:h,toDataVersion:l}],fullSnapshot:f,previousSnapshot:p,description:y,changeReason:a||y,parentVersion:e.version,dataVersion:u,isActive:!0,userId:t,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,hospitalId:"hospital"===e.entityType?e.entityId:void 0},b=await (0,r.C)({data:I,client:o});if(!b.success||!b.data)throw Error(b.errors?.join(", ")||`Failed to rollback ${e.entityId}`);if(!await A({tx:o,binding:s,entityId:e.entityId,snapshot:f,newVersion:d.version??b.data.version}))throw Error(`Failed to apply snapshot for ${e.entityId}`)}d&&await o.update(c.editorInfo).set({dataVersion:u,lastPublishDate:new Date}).where((0,n.eq)(c.editorInfo.id,d.id))}),d.success=!0,d.restoredVersion=i,d}catch(e){return o.Z.error("_rollbackDataVersion ERROR",e.message),d.errors=[e.message],d}}var V=a(81445),T=a(60938);let O=["password","secret","token","credential","auth","privatekey","apikey","salt"];function D(e){return Array.isArray(e)?e.map(D):e&&"object"==typeof e?Object.entries(e).reduce((e,[t,a])=>{let s=t.toLowerCase();return O.some(e=>s.includes(e))||(e[t]=D(a)),e},{}):e}function q(e){return{...e,fullSnapshot:D(e.fullSnapshot),previousSnapshot:D(e.previousSnapshot)}}async function K(e){try{let{changeLogIds:t=[],entityIds:a=[],entityTypes:s=[],userIds:r=[],actions:o=[],isActiveOnly:d=!1,versions:h=[],dataVersions:l=[],scriptIds:u=[],screenIds:y=[],diagnosisIds:f=[],limit:p=1e3,offset:L=0,sortBy:m="dateOfChange",sortOrder:v="desc"}={...e};t=t.filter(e=>i.Z(e)),a=a.filter(e=>i.Z(e)),r=r.filter(e=>(0,I.X)(e)),u=u.filter(e=>i.Z(e)),y=y.filter(e=>i.Z(e)),f=f.filter(e=>i.Z(e)),l=l.filter(e=>Number.isFinite(e)).map(e=>Number(e));let b=(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(t.length?(0,n.d3)(c.changeLogs.changeLogId,t):void 0,a.length?(0,n.d3)(c.changeLogs.entityId,a):void 0,s.length?(0,n.d3)(c.changeLogs.entityType,s):void 0,r.length?(0,n.d3)(c.changeLogs.userId,r):void 0,o.length?(0,n.d3)(c.changeLogs.action,o):void 0,h.length?(0,n.d3)(c.changeLogs.version,h):void 0,l.length?(0,n.d3)(c.changeLogs.dataVersion,l):void 0,u.length?(0,n.d3)(c.changeLogs.scriptId,u):void 0,y.length?(0,n.d3)(c.changeLogs.screenId,y):void 0,f.length?(0,n.d3)(c.changeLogs.diagnosisId,f):void 0,d?(0,n.eq)(c.changeLogs.isActive,!0):void 0)).orderBy("desc"===v?(0,V.C)(c.changeLogs[m]):(0,V.d)(c.changeLogs[m])).limit(Math.max(1,Math.min(p,2e3))).offset(Math.max(0,L||0))).map(e=>q({...e.changeLog,userName:e.user?.name||"",userEmail:e.user?.email||"",entityName:function(e){let t=e.fullSnapshot||{};for(let e of["title","name","label","printTitle","sectionTitle","collectionLabel","key"]){let a=t[e];if("string"==typeof a&&a.trim().length)return a.trim()}if("string"==typeof e.description&&e.description.trim().length)return e.description.trim()}(e.changeLog)})),w=await g.Z.select({total:(0,T.QX)()}).from(c.changeLogs).where((0,n.xD)(t.length?(0,n.d3)(c.changeLogs.changeLogId,t):void 0,a.length?(0,n.d3)(c.changeLogs.entityId,a):void 0,s.length?(0,n.d3)(c.changeLogs.entityType,s):void 0,r.length?(0,n.d3)(c.changeLogs.userId,r):void 0,o.length?(0,n.d3)(c.changeLogs.action,o):void 0,h.length?(0,n.d3)(c.changeLogs.version,h):void 0,l.length?(0,n.d3)(c.changeLogs.dataVersion,l):void 0,u.length?(0,n.d3)(c.changeLogs.scriptId,u):void 0,y.length?(0,n.d3)(c.changeLogs.screenId,y):void 0,f.length?(0,n.d3)(c.changeLogs.diagnosisId,f):void 0,d?(0,n.eq)(c.changeLogs.isActive,!0):void 0));return await Z(b),{data:b,total:w?.[0]?.total??b.length}}catch(e){return o.Z.error("_getChangeLogs ERROR",e.message),{data:[],errors:[e.message]}}}async function Z(e){if(!e.length)return;let t=new Map;for(let a of e)a.entityId&&(t.has(a.entityType)||t.set(a.entityType,new Set),t.get(a.entityType).add(a.entityId));if(!t.size)return;let a=new Map;for(let[e,s]of Array.from(t.entries())){let t=Array.from(s);if(t.length)for(let s of(await g.Z.select({entityId:c.changeLogs.entityId,latestVersion:(0,L.i6)`max(${c.changeLogs.version})`}).from(c.changeLogs).where((0,n.xD)((0,n.eq)(c.changeLogs.entityType,e),(0,n.d3)(c.changeLogs.entityId,t))).groupBy(c.changeLogs.entityId)))null!==s.latestVersion&&void 0!==s.latestVersion&&a.set(`${e}:${s.entityId}`,Number(s.latestVersion))}for(let t of e){let e=a.get(`${t.entityType}:${t.entityId}`);void 0!==e&&(t.isActive=t.isActive&&t.version===e)}}async function k(e){let{changeLogId:t,entityId:a,version:s}={...e};try{if(!t&&(!a||void 0===s))throw Error("Missing changeLogId or entityId+version");let e=t&&i.Z(t)?(0,n.eq)(c.changeLogs.changeLogId,t):void 0,r=a&&void 0!==s?(0,n.xD)((0,n.eq)(c.changeLogs.entityId,a),(0,n.eq)(c.changeLogs.version,s)):void 0,o=await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where(e||r).limit(1);if(!o[0])return{data:null};return{data:q({...o[0].changeLog,userName:o[0].user?.name||"",userEmail:o[0].user?.email||""})}}catch(e){return o.Z.error("_getChangeLog ERROR",e.message),{errors:[e.message]}}}async function N(e){let{entityId:t,entityType:a,includeInactive:s=!1,limit:r}={...e};try{if(!t||!i.Z(t))throw Error("Invalid entityId");let e=(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,t),a?(0,n.eq)(c.changeLogs.entityType,a):void 0,s?void 0:(0,n.eq)(c.changeLogs.isActive,!0))).orderBy((0,V.C)(c.changeLogs.version)).limit(r||100)).map(e=>q({...e.changeLog,userName:e.user?.name||"",userEmail:e.user?.email||""})),o=e.length>0?Math.max(...e.map(e=>e.version)):void 0;return{data:e,currentVersion:o}}catch(e){return o.Z.error("_getEntityHistory ERROR",e.message),{data:[],errors:[e.message]}}}async function _(e){let{entityId:t,entityType:a}={...e};try{if(!t||!i.Z(t))throw Error("Invalid entityId");let e=await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,t),(0,n.eq)(c.changeLogs.isActive,!0),a?(0,n.eq)(c.changeLogs.entityType,a):void 0)).orderBy((0,V.C)(c.changeLogs.version)).limit(1);if(!e[0])return{data:null};return{data:q({...e[0].changeLog,userName:e[0].user?.name||"",userEmail:e[0].user?.email||""})}}catch(e){return o.Z.error("_getActiveVersion ERROR",e.message),{errors:[e.message]}}}async function S(e){let{entityId:t,fromVersion:a,includeInactive:s=!1}={...e};try{if(!t||!i.Z(t))throw Error("Invalid entityId");let e=a;if(!e){let a=await g.Z.select({version:c.changeLogs.version}).from(c.changeLogs).where((0,n.eq)(c.changeLogs.entityId,t)).orderBy((0,V.C)(c.changeLogs.version)).limit(1);e=a[0]?.version}if(!e)return{data:[]};let r=[],o=e;for(;null!==o;){let e=await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,t),(0,n.eq)(c.changeLogs.version,o),s?void 0:(0,n.eq)(c.changeLogs.isActive,!0))).limit(1);if(!e[0])break;r.push(q({...e[0].changeLog,userName:e[0].user?.name||"",userEmail:e[0].user?.email||""})),o=e[0].changeLog.parentVersion}return{data:r}}catch(e){return o.Z.error("_getVersionChain ERROR",e.message),{data:[],errors:[e.message]}}}async function j(e){try{let{entityId:t,entityType:a,userId:s,startDate:r,endDate:i}={...e},o=await g.Z.select({action:c.changeLogs.action,entityType:c.changeLogs.entityType,userId:c.changeLogs.userId,count:(0,L.i6)`count(*)::int`}).from(c.changeLogs).where((0,n.xD)(t?(0,n.eq)(c.changeLogs.entityId,t):void 0,a?(0,n.eq)(c.changeLogs.entityType,a):void 0,s?(0,n.eq)(c.changeLogs.userId,s):void 0,r?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${r}`:void 0,i?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${i}`:void 0)).groupBy(c.changeLogs.action,c.changeLogs.entityType,c.changeLogs.userId),d={totalChanges:0,byAction:{},byUser:{},byEntityType:{}};return o.forEach(e=>{d.totalChanges+=e.count,d.byAction[e.action]=(d.byAction[e.action]||0)+e.count,d.byEntityType[e.entityType]=(d.byEntityType[e.entityType]||0)+e.count,d.byUser[e.userId]=(d.byUser[e.userId]||0)+e.count}),{data:d}}catch(e){return o.Z.error("_getChangeLogStats ERROR",e.message),{data:{totalChanges:0,byAction:{},byUser:{},byEntityType:{}},errors:[e.message]}}}async function x(e){try{let{entityIds:t=[],entityTypes:a=[],userIds:s=[],actions:r=[],isActiveOnly:o=!1,scriptIds:d=[],screenIds:h=[],diagnosisIds:l=[],startDate:u,endDate:y}={...e};t=t.filter(e=>i.Z(e)),s=s.filter(e=>(0,I.X)(e)),d=d.filter(e=>i.Z(e)),h=h.filter(e=>i.Z(e)),l=l.filter(e=>i.Z(e));let f=await g.Z.select({count:(0,T.QX)()}).from(c.changeLogs).where((0,n.xD)(t.length?(0,n.d3)(c.changeLogs.entityId,t):void 0,a.length?(0,n.d3)(c.changeLogs.entityType,a):void 0,s.length?(0,n.d3)(c.changeLogs.userId,s):void 0,r.length?(0,n.d3)(c.changeLogs.action,r):void 0,d.length?(0,n.d3)(c.changeLogs.scriptId,d):void 0,h.length?(0,n.d3)(c.changeLogs.screenId,h):void 0,l.length?(0,n.d3)(c.changeLogs.diagnosisId,l):void 0,o?(0,n.eq)(c.changeLogs.isActive,!0):void 0,u?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${u}`:void 0,y?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${y}`:void 0));return{count:f[0]?.count||0}}catch(e){return o.Z.error("_countChangeLogs ERROR",e.message),{count:0,errors:[e.message]}}}async function B(e){try{let{entityType:t,isActiveOnly:a=!1,startDate:s,endDate:r}={...e};return{data:await g.Z.select({entityId:c.changeLogs.entityId,entityType:c.changeLogs.entityType,totalVersions:(0,T.QX)(),activeVersions:(0,L.i6)`
                    count(*) FILTER (WHERE ${c.changeLogs.isActive} = true)::int
                `}).from(c.changeLogs).where((0,n.xD)(t?(0,n.eq)(c.changeLogs.entityType,t):void 0,a?(0,n.eq)(c.changeLogs.isActive,!0):void 0,s?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${s}`:void 0,r?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${r}`:void 0)).groupBy(c.changeLogs.entityId,c.changeLogs.entityType)}}catch(e){return o.Z.error("_countChangeLogsByEntity ERROR",e.message),{data:[],errors:[e.message]}}}async function F(e){try{let{entityId:t,entityType:a,userId:s,startDate:r,endDate:o}={...e};return{data:await g.Z.select({action:c.changeLogs.action,count:(0,T.QX)()}).from(c.changeLogs).where((0,n.xD)(t&&i.Z(t)?(0,n.eq)(c.changeLogs.entityId,t):void 0,a?(0,n.eq)(c.changeLogs.entityType,a):void 0,s&&(0,I.X)(s)?(0,n.eq)(c.changeLogs.userId,s):void 0,r?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${r}`:void 0,o?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${o}`:void 0)).groupBy(c.changeLogs.action)}}catch(e){return o.Z.error("_countChangeLogsByAction ERROR",e.message),{data:[],errors:[e.message]}}}async function U(e){try{let{entityId:t,entityType:a,action:s,startDate:r,endDate:o}={...e};return{data:await g.Z.select({userId:c.changeLogs.userId,count:(0,T.QX)()}).from(c.changeLogs).where((0,n.xD)(t&&i.Z(t)?(0,n.eq)(c.changeLogs.entityId,t):void 0,a?(0,n.eq)(c.changeLogs.entityType,a):void 0,s?(0,n.eq)(c.changeLogs.action,s):void 0,r?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${r}`:void 0,o?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${o}`:void 0)).groupBy(c.changeLogs.userId)}}catch(e){return o.Z.error("_countChangeLogsByUser ERROR",e.message),{data:[],errors:[e.message]}}}async function J(e){try{let{entityId:t,includeInactive:a=!0}={...e};if(!t||!i.Z(t))throw Error("Invalid entityId");let s=await g.Z.select({totalVersions:(0,T.QX)(),activeVersions:(0,L.i6)`
                    count(*) FILTER (WHERE ${c.changeLogs.isActive} = true)::int
                `}).from(c.changeLogs).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,t),a?void 0:(0,n.eq)(c.changeLogs.isActive,!0)));return{totalVersions:s[0]?.totalVersions||0,activeVersions:s[0]?.activeVersions||0}}catch(e){return o.Z.error("_countEntityVersions ERROR",e.message),{totalVersions:0,activeVersions:0,errors:[e.message]}}}async function M(e){try{let{searchTerm:t,entityTypes:a=[],actions:s=[],limit:r=25,offset:o=0,applyFiltersToCounts:d=!1,dataVersions:h=[],sortBy:l="publishedAt",sortOrder:u="desc",latestOnly:y=!1}={...e},f=h.filter(e=>Number.isFinite(e)).map(e=>Number(e)),p=await g.Z.select({latestDataVersion:(0,L.i6)`max(${c.changeLogs.dataVersion})`}).from(c.changeLogs).where((0,L.i6)`${c.changeLogs.dataVersion} IS NOT NULL`),m=Number.isFinite(p?.[0]?.latestDataVersion)?Number(p?.[0]?.latestDataVersion):null;if(y&&!m)return{data:[],total:0,latestDataVersion:null};let I=y&&m?[m]:f.length?f:[],v="string"==typeof t?t.trim():"",b=v.toLowerCase(),w=!!v&&i.Z(v),$=Object.entries({script:["script","scripts"],screen:["screen","screens"],diagnosis:["diagnosis","diagnoses"],config_key:["config key","config keys","config-key","configkey","configkeys"],drugs_library:["drugs library","drug library","drugs-library","drug-library","drugs library item"],data_key:["data key","data keys","data-key","datakey","datakeys"],alias:["alias","aliases"],hospital:["hospital","hospitals"],release:["release","releases"]}).filter(([,e])=>e.some(e=>e===b)).map(([e])=>e),R=v?(0,n.or)((0,n.o$)(c.changeLogs.description,`%${v}%`),(0,n.o$)(c.changeLogs.changeReason,`%${v}%`),(0,L.i6)`${c.changeLogs.changes}::text ILIKE ${"%"+v+"%"}`,(0,L.i6)`${c.changeLogs.entityId}::text ILIKE ${"%"+v+"%"}`,w?(0,n.eq)(c.changeLogs.entityId,v):void 0,(0,L.i6)`${c.changeLogs.entityType}::text ILIKE ${"%"+v+"%"}`,$.length?(0,n.d3)(c.changeLogs.entityType,$):void 0,(0,n.o$)(c.scripts.title,`%${v}%`),(0,n.o$)(c.users.displayName,`%${v}%`),(0,n.o$)(c.users.email,`%${v}%`)):void 0,A=(0,L.i6)`max(case when ${c.changeLogs.action} = 'publish' then ${c.changeLogs.dateOfChange} end)`,E=(0,L.i6)`max(${c.changeLogs.dateOfChange})`,C=(0,L.i6)`coalesce(${A}, ${E})`,T=(0,L.i6)`count(*)::int`,O="dataVersion"===l?"asc"===u?(0,V.d)(c.changeLogs.dataVersion):(0,V.C)(c.changeLogs.dataVersion):"changeCount"===l?"asc"===u?(0,V.d)(T):(0,V.C)(T):"asc"===u?(0,V.d)(C):(0,V.C)(C),D=g.Z.select({dataVersion:c.changeLogs.dataVersion,latestPublishedAt:A,latestChangeAt:E,changeCount:T}).from(c.changeLogs).leftJoin(c.scripts,(0,n.eq)(c.scripts.scriptId,c.changeLogs.scriptId)).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(R,a.length?(0,n.d3)(c.changeLogs.entityType,a):void 0,s.length?(0,n.d3)(c.changeLogs.action,s):void 0,I.length?(0,n.d3)(c.changeLogs.dataVersion,I):void 0,(0,L.i6)`${c.changeLogs.dataVersion} IS NOT NULL`)).groupBy(c.changeLogs.dataVersion).orderBy(O),q=g.Z.select({total:(0,L.i6)`count(distinct ${c.changeLogs.dataVersion})`}).from(c.changeLogs).leftJoin(c.scripts,(0,n.eq)(c.scripts.scriptId,c.changeLogs.scriptId)).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(R,a.length?(0,n.d3)(c.changeLogs.entityType,a):void 0,s.length?(0,n.d3)(c.changeLogs.action,s):void 0,I.length?(0,n.d3)(c.changeLogs.dataVersion,I):void 0,(0,L.i6)`${c.changeLogs.dataVersion} IS NOT NULL`)),[K,Z]=await Promise.all([D.limit(r).offset(o),q]),k=Number(Z?.[0]?.total??0),N=K.map(e=>e.dataVersion);if(0===N.length)return{data:[],total:k,latestDataVersion:m};let _=await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.scripts,(0,n.eq)(c.scripts.scriptId,c.changeLogs.scriptId)).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)((0,n.d3)(c.changeLogs.dataVersion,N),d?R:void 0,d&&a.length?(0,n.d3)(c.changeLogs.entityType,a):void 0,d&&s.length?(0,n.d3)(c.changeLogs.action,s):void 0,d&&I.length?(0,n.d3)(c.changeLogs.dataVersion,I):void 0)).orderBy((0,V.C)(c.changeLogs.dateOfChange)),S=new Map;for(let e of _){let t=e.changeLog.dataVersion;S.has(t)||S.set(t,[]),S.get(t).push(e)}let j=new Map;for(let e of _){let t=e.changeLog.entityType,a=e.changeLog.entityId;if(!t||!a)continue;let s=`${t}:${a}`;j.has(s)||j.set(s,{entityType:t,entityId:a})}let x=Array.from(j.values()),B=x.length?await g.Z.select({entityType:c.changeLogs.entityType,entityId:c.changeLogs.entityId,latestVersion:(0,L.i6)`max(${c.changeLogs.version})`}).from(c.changeLogs).where((0,n.or)(...x.map(e=>(0,n.xD)((0,n.eq)(c.changeLogs.entityType,e.entityType),(0,n.eq)(c.changeLogs.entityId,e.entityId))))).groupBy(c.changeLogs.entityType,c.changeLogs.entityId):[],F=new Map;for(let e of B)null!==e.latestVersion&&void 0!==e.latestVersion&&F.set(`${e.entityType}:${e.entityId}`,Number(e.latestVersion));return{data:N.map(e=>{let t=S.get(e)||[],a=t[0],s=t.find(e=>"publish"===e.changeLog.action&&"release"===e.changeLog.entityType)||t.find(e=>"publish"===e.changeLog.action)||a,r=t.find(e=>"rollback"===e.changeLog.action),n={},i={},o=new Set;t.forEach(e=>{let t=e.changeLog.entityType,a=e.changeLog.action;n[t]=(n[t]||0)+1,i[a]=(i[a]||0)+1,e.changeLog.description&&o.add(e.changeLog.description)});let g=t.some(e=>{let t=`${e.changeLog.entityType}:${e.changeLog.entityId}`,a=F.get(t);return void 0!==a?e.changeLog.version===a:e.changeLog.isActive}),c=Array.isArray(r?.changeLog?.changes)?r?.changeLog?.changes:[],d=c.find(e=>Number.isFinite(e?.toVersion))?.toVersion??c.find(e=>Number.isFinite(e?.to_version))?.to_version??r?.changeLog?.changes?.[0]?.toVersion??null;return{dataVersion:e,publishedAt:s?.changeLog?.dateOfChange?.toISOString()||a?.changeLog?.dateOfChange?.toISOString()||null,publishedByName:s?.user?.name||"Unknown user",publishedByEmail:s?.user?.email||void 0,totalChanges:t.length,hasActiveChanges:g,isLatestVersion:!!m&&e===m,entityCounts:n,actionCounts:i,descriptions:Array.from(o).slice(0,5),rollbackSourceVersion:r?d:null}}),total:k,latestDataVersion:m}}catch(e){return o.Z.error("_getDataVersionSummaries ERROR",e.message),{data:[],total:0,latestDataVersion:null,errors:[e.message]}}}async function X(e){try{let{searchTerm:t,entityTypes:a=[],actions:s=[],userIds:r=[],startDate:i,endDate:o,isActiveOnly:d=!1,limit:h=50,offset:l=0}={...e};r=r.filter(e=>(0,I.X)(e));let u=t?(0,n.or)((0,n.o$)(c.changeLogs.description,`%${t}%`),(0,n.o$)(c.changeLogs.changeReason,`%${t}%`),(0,L.i6)`${c.changeLogs.changes}::text ILIKE ${"%"+t+"%"}`,(0,L.i6)`${c.changeLogs.fullSnapshot}::text ILIKE ${"%"+t+"%"}`):void 0,y=(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(u,a.length?(0,n.d3)(c.changeLogs.entityType,a):void 0,s.length?(0,n.d3)(c.changeLogs.action,s):void 0,r.length?(0,n.d3)(c.changeLogs.userId,r):void 0,d?(0,n.eq)(c.changeLogs.isActive,!0):void 0,i?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${i}`:void 0,o?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${o}`:void 0)).orderBy((0,V.C)(c.changeLogs.dateOfChange)).limit(h).offset(l)).map(e=>({...e.changeLog,userName:e.user?.name||"",userEmail:e.user?.email||""}));return{data:y,total:y.length}}catch(e){return o.Z.error("_searchChangeLogs ERROR",e.message),{data:[],total:0,errors:[e.message]}}}async function P(e){try{let{fieldName:t,searchValue:a,entityId:s,entityType:r,limit:o=50}={...e};if(!t)throw Error("fieldName is required");let d=a?(0,L.i6)`EXISTS (
                SELECT 1 FROM jsonb_array_elements(${c.changeLogs.changes}) AS change
                WHERE (change->>'field' = ${t} OR change->>'fieldPath' = ${t})
                AND (
                    change->>'previousValue' ILIKE ${"%"+a+"%"}
                    OR change->>'newValue' ILIKE ${"%"+a+"%"}
                )
            )`:(0,L.i6)`EXISTS (
                SELECT 1 FROM jsonb_array_elements(${c.changeLogs.changes}) AS change
                WHERE change->>'field' = ${t} OR change->>'fieldPath' = ${t}
            )`;return{data:(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(d,s&&i.Z(s)?(0,n.eq)(c.changeLogs.entityId,s):void 0,r?(0,n.eq)(c.changeLogs.entityType,r):void 0)).orderBy((0,V.C)(c.changeLogs.dateOfChange)).limit(o)).map(e=>{let a=(e.changeLog.changes||[]).find(e=>e.field===t||e.fieldPath===t);return{version:e.changeLog.version,entityId:e.changeLog.entityId,entityType:e.changeLog.entityType,action:e.changeLog.action,field:a?.field||a?.fieldPath||t,previousValue:a?.previousValue,newValue:a?.newValue,dateOfChange:e.changeLog.dateOfChange,userId:e.changeLog.userId,userName:e.user?.name||""}})}}catch(e){return o.Z.error("_searchChangesByField ERROR",e.message),{data:[],errors:[e.message]}}}async function H(e){try{let{userId:t,userName:a,entityType:s,action:r,startDate:i,endDate:o,limit:d=50,offset:h=0}={...e};if(!t&&!a)throw Error("Either userId or userName is required");let l=a?(0,n.o$)(c.users.displayName,`%${a}%`):t&&(0,I.X)(t)?(0,n.eq)(c.changeLogs.userId,t):void 0;return{data:(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName,email:c.users.email}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)(l,s?(0,n.eq)(c.changeLogs.entityType,s):void 0,r?(0,n.eq)(c.changeLogs.action,r):void 0,i?(0,L.i6)`${c.changeLogs.dateOfChange} >= ${i}`:void 0,o?(0,L.i6)`${c.changeLogs.dateOfChange} <= ${o}`:void 0)).orderBy((0,V.C)(c.changeLogs.dateOfChange)).limit(d).offset(h)).map(e=>({...e.changeLog,userName:e.user?.name||"",userEmail:e.user?.email||""}))}}catch(e){return o.Z.error("_searchChangeLogsByUser ERROR",e.message),{data:[],errors:[e.message]}}}async function Q(e){try{let{startDate:t,endDate:a,entityType:s,action:r,limit:i=100}={...e},o=(await g.Z.select({changeLog:c.changeLogs,user:{name:c.users.displayName}}).from(c.changeLogs).leftJoin(c.users,(0,n.eq)(c.users.userId,c.changeLogs.userId)).where((0,n.xD)((0,L.i6)`${c.changeLogs.dateOfChange} >= ${t}`,(0,L.i6)`${c.changeLogs.dateOfChange} <= ${a}`,s?(0,n.eq)(c.changeLogs.entityType,s):void 0,r?(0,n.eq)(c.changeLogs.action,r):void 0)).orderBy((0,V.C)(c.changeLogs.dateOfChange)).limit(i)).map(e=>({...e.changeLog,userName:e.user?.name||""})),d={totalChanges:o.length,byAction:{},byEntityType:{}};return o.forEach(e=>{d.byAction[e.action]=(d.byAction[e.action]||0)+1,d.byEntityType[e.entityType]=(d.byEntityType[e.entityType]||0)+1}),{data:o,summary:d}}catch(e){return o.Z.error("_searchChangeLogsByDateRange ERROR",e.message),{data:[],errors:[e.message]}}}async function W(e){try{let t;let{changeLogId:a,includeParentChain:s=!0,includeMergedVersions:r=!0}={...e};if(!a||!i.Z(a))throw Error("Invalid changeLogId");let o=await g.Z.query.changeLogs.findFirst({where:(0,n.eq)(c.changeLogs.changeLogId,a)});if(!o)throw Error("Change log not found");s&&null!==o.parentVersion&&(t=await g.Z.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,o.entityId),(0,n.eq)(c.changeLogs.version,o.parentVersion))}));let d=await g.Z.query.changeLogs.findMany({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,o.entityId),(0,n.eq)(c.changeLogs.parentVersion,o.version)),orderBy:[(0,V.C)(c.changeLogs.version)]}),h=[];if(r&&null!==o.mergedFromVersion){let e=await g.Z.query.changeLogs.findFirst({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,o.entityId),(0,n.eq)(c.changeLogs.version,o.mergedFromVersion))});e&&(h=[e])}let l=await g.Z.query.changeLogs.findMany({where:(0,n.xD)((0,n.eq)(c.changeLogs.entityId,o.entityId),(0,n.eq)(c.changeLogs.supersededBy,o.version)),orderBy:[(0,V.C)(c.changeLogs.version)]});return{data:{current:o,parent:t,children:d,mergedVersions:h,supersededVersions:l}}}catch(e){return o.Z.error("_findRelatedChanges ERROR",e.message),{data:{current:{},children:[],mergedVersions:[],supersededVersions:[]},errors:[e.message]}}}var G=a(66267),z=a(72761),Y=a(40618);async function ee(){let e=await (0,z.$)();if(!e.yes||e.user?.role!=="super_user")throw Error("Forbidden: superuser required");return e}let et=(0,s.j)("8da9082f799215b21cd829454ba8f388fd4133c0",ea);async function ea(...e){try{return await (0,G.isAllowed)(),await K(...e)}catch(e){return o.Z.error("getChangeLogs ERROR",e.message),{errors:[e.message],data:[]}}}let es=(0,s.j)("e4ba7cb2aae277e7d75968794429e92dc58d76cc",er);async function er(...e){try{return await (0,G.isAllowed)(),await k(...e)}catch(e){return o.Z.error("getChangeLog ERROR",e.message),{errors:[e.message]}}}let en=(0,s.j)("ca80da3afba590dfd9d4262e688a2f8f029b1b09",ei);async function ei(...e){try{return await (0,G.isAllowed)(),await N(...e)}catch(e){return o.Z.error("getEntityHistory ERROR",e.message),{errors:[e.message],data:[]}}}let eo=(0,s.j)("336131fdd35c9d8697e0016bf5c9f29765769236",eg);async function eg(...e){try{return await (0,G.isAllowed)(),await _(...e)}catch(e){return o.Z.error("getActiveVersion ERROR",e.message),{errors:[e.message]}}}let ec=(0,s.j)("5c75d4d958f38b54bfa2fa861d3b368b8317ece4",ed);async function ed(...e){try{return await (0,G.isAllowed)(),await S(...e)}catch(e){return o.Z.error("getVersionChain ERROR",e.message),{errors:[e.message],data:[]}}}let eh=(0,s.j)("94dcf00258df6aad11e6c4a434abfb4d08ae9a4b",el);async function el(...e){try{return await (0,G.isAllowed)(),await j(...e)}catch(e){return o.Z.error("getChangeLogStats ERROR",e.message),{errors:[e.message],data:{totalChanges:0,byAction:{},byUser:{},byEntityType:{}}}}}let eu=(0,s.j)("97ff78fb05cd37d95e97550e7b19da15daff71f0",ey);async function ey(...e){try{return await (0,G.isAllowed)(),await x(...e)}catch(e){return o.Z.error("countChangeLogs ERROR",e.message),{errors:[e.message],count:0}}}let ef=(0,s.j)("4f31a8a845d0dd3d6db012c90ae6e1ba748822d7",ep);async function ep(...e){try{return await (0,G.isAllowed)(),await B(...e)}catch(e){return o.Z.error("countChangeLogsByEntity ERROR",e.message),{errors:[e.message],data:[]}}}let eL=(0,s.j)("d965405f6dff2b6824ffe5a4c89f4b890ff770a8",em);async function em(...e){try{return await (0,G.isAllowed)(),await F(...e)}catch(e){return o.Z.error("countChangeLogsByAction ERROR",e.message),{errors:[e.message],data:[]}}}let eI=(0,s.j)("0328a7cd9460fc38df68e5e8353eaa2e72f6155b",ev);async function ev(...e){try{return await (0,G.isAllowed)(),await U(...e)}catch(e){return o.Z.error("countChangeLogsByUser ERROR",e.message),{errors:[e.message],data:[]}}}let eb=(0,s.j)("d4f6e7d3c55c76cf973e700c2754795d3779de2f",ew);async function ew(...e){try{return await (0,G.isAllowed)(),await J(...e)}catch(e){return o.Z.error("countEntityVersions ERROR",e.message),{errors:[e.message],totalVersions:0,activeVersions:0}}}let e$=(0,s.j)("ada702ea360239c0162cb6b67567a286a52f05e3",eR);async function eR(...e){try{return await (0,G.isAllowed)(),await M(...e)}catch(e){return o.Z.error("getDataVersionSummaries ERROR",e.message),{errors:[e.message],data:[],total:0}}}let eA=(0,s.j)("960c140a03ff5693d2eb6b2713b93783fbeb79b4",eE);async function eE(...e){try{return await (0,G.isAllowed)(),await X(...e)}catch(e){return o.Z.error("searchChangeLogs ERROR",e.message),{errors:[e.message],data:[],total:0}}}let eC=(0,s.j)("a94a7dc48e11b9e8d02fce50b4c617b741b437c0",eV);async function eV(...e){try{return await (0,G.isAllowed)(),await P(...e)}catch(e){return o.Z.error("searchChangesByField ERROR",e.message),{errors:[e.message],data:[]}}}let eT=(0,s.j)("4322bd5ab176a575ad38e864dcc537845548e4a7",eO);async function eO(...e){try{return await (0,G.isAllowed)(),await H(...e)}catch(e){return o.Z.error("searchChangeLogsByUser ERROR",e.message),{errors:[e.message],data:[]}}}let eD=(0,s.j)("ca4fbb0d07a8cec65620c8be66a8ea4e8dcc32aa",eq);async function eq(...e){try{return await (0,G.isAllowed)(),await Q(...e)}catch(e){return o.Z.error("searchChangeLogsByDateRange ERROR",e.message),{errors:[e.message],data:[]}}}let eK=(0,s.j)("fd0c2a1e05f708e6e8f1e474d35c307f2c5056ba",eZ);async function eZ(...e){try{return await (0,G.isAllowed)(),await W(...e)}catch(e){return o.Z.error("findRelatedChanges ERROR",e.message),{errors:[e.message],data:{current:{},children:[],mergedVersions:[],supersededVersions:[]}}}}let ek=(0,s.j)("eae74167b19df3b58b2fead75dfc62de749560b3",eN);async function eN(e){try{let t=await (0,G.isAllowed)();return await r.C({...e,data:{...e.data,userId:t.user?.userId}})}catch(e){return o.Z.error("saveChangeLog ERROR",e.message),{errors:[e.message],success:!1}}}let e_=(0,s.j)("c9153339ae3fe2b220cecde185d1e37b5efcf29e",eS);async function eS(e){try{let t=await (0,G.isAllowed)();return await r.F({...e,data:e.data.map(e=>({...e,userId:t.user?.userId}))})}catch(e){return o.Z.error("saveChangeLogs ERROR",e.message),{errors:[e.message],success:!1,saved:0}}}let ej=(0,s.j)("6a2c8493cc6577d4a998e40a65456b6aff03f070",ex);async function ex(e){try{return await (0,G.isAllowed)(),await h(e)}catch(e){return o.Z.error("updateChangeLog ERROR",e.message),{errors:[e.message],success:!1}}}let eB=(0,s.j)("4ea892e98644fd77f230b5847ce46a5fbced9ecf",eF);async function eF(e){try{return await (0,G.isAllowed)(),await l(e)}catch(e){return o.Z.error("markVersionAsSuperseded ERROR",e.message),{errors:[e.message],success:!1}}}let eU=(0,s.j)("ee1b0c56fe6fd2fb8111f652bcc1d00c80aeb697",eJ);async function eJ(e){try{let t=await ee();return await p({...e,userId:t.user?.userId})}catch(e){return o.Z.error("rollbackChangeLog ERROR",e.message),{errors:[e.message],success:!1}}}let eM=(0,s.j)("c7b17a8c00d463ea2beedeb6f2673e1a74112f87",eX);async function eX(e){try{let t=await ee();return await C({...e,userId:t.user?.userId})}catch(e){return o.Z.error("rollbackDataVersion ERROR",e.message),{errors:[e.message],success:!1}}}(0,Y.h)([et,es,en,eo,ec,eh,eu,ef,eL,eI,eb,e$,eA,eC,eT,eD,eK,ek,e_,ej,eB,eU,eM]),(0,s.j)("39603dc25392591cfaeb2a23a14d258c58065cd4",et),(0,s.j)("2fc7eaf22b9df332e706412ff3205f70b2c9a15f",es),(0,s.j)("b8c72164c866ae4ebbab5ff1ec15b939f84c7e71",en),(0,s.j)("f202658d53f8310068bfb22742d28e4009b6fe79",eo),(0,s.j)("16f3f39a3da55ca79adc926d5400e09d5ee717af",ec),(0,s.j)("f32612a85c69af731cbd162229d3869e65233679",eh),(0,s.j)("c1f23e920adb7f9d841c6f4cb00d754bf7311054",eu),(0,s.j)("72ac90be74400adb58f536e69b3ed27485acb552",ef),(0,s.j)("acffff5904e4518a941c36a501f3deba35da68d6",eL),(0,s.j)("91af84490078439654c791faf1f41716b8fcd8e1",eI),(0,s.j)("3bcc3f076fe9322463b8496b0a7e9d851f79a8b7",eb),(0,s.j)("3f89158c66a705ddf8b5a2a8a80ee2cc08cb31fb",e$),(0,s.j)("6bb6bb8a8bcfc15b5fe174956d27b5cfecf2e6d2",eA),(0,s.j)("40bb9bf6246c2895e45843061668c16bf859fe42",eC),(0,s.j)("09420933c26c22c846afc28b6f2b1d1de5dea8ee",eT),(0,s.j)("79255768294f069d824805fcdcfc38c051d77f14",eD),(0,s.j)("f1df933c8d32273a034e2426c1c9cdd88bab39e0",eK),(0,s.j)("50522c6fbfc0dc8156df4cff8bb0e7bbfcc04dbb",ek),(0,s.j)("e56797185be2e503ac6c17a8f96c5ddea894e0be",e_),(0,s.j)("5b1a8f2dfb1fbfbed7bbecf73de92c2712b618e1",ej),(0,s.j)("c04b37f76cfe872642f8d9fe32fb8c77a5d695ff",eB),(0,s.j)("1b8276eef92547166cfb7c3510bfbdbbe8f97538",eU),(0,s.j)("b5fb127d56ca2b770334d23f5c9f9945838e302d",eM)}};