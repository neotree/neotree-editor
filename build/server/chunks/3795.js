exports.id=3795,exports.ids=[3795],exports.modules={58359:()=>{},93739:()=>{},41771:(r,e,t)=>{"use strict";t.d(e,{Ms:()=>m,Nq:()=>f,hA:()=>I,$s:()=>o,cj:()=>y});var i=t(57745),a=t(81445),s=t(9576),d=t(57435),n=t(10413),u=t(43509),l=t(88317),g=t(30834);async function o({data:r,broadcastAction:e}){let t={success:!1};try{let e=[];for(let{itemId:t,...d}of r)try{let r=t||s.Z();if(!e.length){let e=t?await n.Z.query.drugsLibraryDrafts.findFirst({where:(0,i.eq)(u.drugsLibraryDrafts.itemDraftId,r)}):null,s=e||!t?null:await n.Z.query.drugsLibrary.findFirst({where:(0,i.eq)(u.drugsLibrary.itemId,r)});if(e){let t={...e.data,...d};await n.Z.update(u.drugsLibraryDrafts).set({data:t,position:t.position}).where((0,i.eq)(u.drugsLibraryDrafts.itemDraftId,r))}else{let e=d.position||s?.position;if(!e){let r=await n.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,a.C)(u.drugsLibrary.position)}),t=await n.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,a.C)(u.drugsLibraryDrafts.position)});e=Math.max(0,r?.position||0,t?.position||0)+1}let t={...s,...d,itemId:r,version:s?.version?s.version+1:1,position:e};await n.Z.insert(u.drugsLibraryDrafts).values({data:t,itemDraftId:r,position:t.position,itemId:s?.itemId,key:t.key})}}}catch(r){e.push(r.message)}e.length?t.errors=e:t.success=!0}catch(r){t.success=!1,t.errors=[r.message],d.Z.error("_saveDrugsLibraryItems ERROR",r.message)}finally{return!t?.errors?.length&&e&&l.Z.emit("data_changed","save_drugs_library_items"),t}}async function y({data:r,broadcastAction:e}){try{let t=r.map(r=>r.key).filter(r=>r);if(t.length){let i=await (0,g.fP)({keys:t});if((r=r.filter(r=>!i.data.map(r=>r.key).includes(r.key))).length)return await o({data:r,broadcastAction:e})}return{success:!0}}catch(r){return d.Z.error("_saveDrugsLibraryItemsIfKeysNotExist ERROR",r.message),{errors:[r.message],success:!1}}}async function m(){try{return await n.Z.delete(u.drugsLibraryDrafts),!0}catch(r){throw r}}async function f({itemsIds:r,broadcastAction:e}){let t={success:!1};try{if(r.length){await n.Z.delete(u.drugsLibraryDrafts).where((0,i.d3)(u.drugsLibraryDrafts.itemDraftId,r));let e=(await n.Z.select({drugsLibraryItemId:u.drugsLibrary.itemId,pendingDeletion:u.pendingDeletion.drugsLibraryItemId}).from(u.drugsLibrary).leftJoin(u.pendingDeletion,(0,i.eq)(u.pendingDeletion.drugsLibraryItemId,u.drugsLibrary.itemId)).where((0,i.d3)(u.drugsLibrary.itemId,r))).filter(r=>!r.pendingDeletion);e.length&&await n.Z.insert(u.pendingDeletion).values(e)}t.success=!0}catch(r){t.success=!1,t.errors=[r.message],d.Z.error("_deleteDrugsLibraryItems ERROR",r.message)}finally{return!t?.errors?.length&&e&&l.Z.emit("data_changed","delete_drugs_library_items"),t}}async function c({previous:r,drafts:e}){try{let t=[];for(let i of e){let e={version:i?.data?.version||1,itemId:i?.data?.itemId,changes:{}};if(i?.data?.version===1)e.changes={action:"create_drugs_library_item",dedrugsLibraryItemion:"Create drugs library item",oldValues:[],newValues:[]};else{let t=r.filter(r=>r.itemId===i?.data?.itemId)[0],a=[],s=[];Object.keys({...i?.data}).filter(r=>!["version","draft"].includes(r)).forEach(r=>{let e=i.data[r],d={...t}[r];JSON.stringify(e)!==JSON.stringify(d)&&(a.push({[r]:d}),s.push({[r]:e}))}),e.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:a,newValues:s}}t.push(e)}await n.Z.insert(u.drugsLibraryHistory).values(t)}catch(r){d.Z.error(r.message)}}var b=t(34149);async function I(r){let e={success:!1};try{let r=[],t=[],a=await n.Z.query.drugsLibraryDrafts.findMany();if(r=a.filter(r=>r.itemId),t=a.filter(r=>!r.itemId),r.length){let e=[];for(let{itemId:t,data:a}of(r.filter(r=>r.itemId).length&&(e=await n.Z.query.drugsLibrary.findMany({where:(0,i.d3)(u.drugsLibrary.itemId,r.filter(r=>r.itemId).map(r=>r.itemId))})),r)){let{itemId:r,id:e,createdAt:s,updatedAt:d,deletedAt:l,...g}=a,o={...g,publishDate:new Date};await n.Z.update(u.drugsLibrary).set(o).where((0,i.eq)(u.drugsLibrary.itemId,t)).returning()}await c({drafts:r,previous:e})}if(t.length){let r=[];for(let{id:e,data:a}of(t.filter(r=>r.itemId).length&&(r=await n.Z.query.drugsLibrary.findMany({where:(0,i.d3)(u.drugsLibrary.itemId,t.filter(r=>r.itemId).map(r=>r.itemId))})),t)){let r=a.itemId||(0,s.Z)(),i={...a,itemId:r};t=t.map(t=>(t.id===e&&(t.data.itemId=r),t)),await n.Z.insert(u.drugsLibrary).values(i)}await c({drafts:t,previous:r})}await n.Z.delete(u.drugsLibraryDrafts);let d=await n.Z.query.pendingDeletion.findMany({where:(0,i.K0)(u.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0}}}});if((d=d.filter(r=>r.drugsLibraryItem)).length){let r=new Date;await n.Z.update(u.drugsLibrary).set({deletedAt:r}).where((0,i.d3)(u.drugsLibrary.itemId,d.map(r=>r.drugsLibraryItemId))),await n.Z.insert(u.drugsLibraryHistory).values(d.map(e=>({version:e.drugsLibraryItem.version,itemId:e.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null}],newValues:[{deletedAt:r}]}})))}await n.Z.delete(u.pendingDeletion).where((0,i.or)((0,i.K0)(u.pendingDeletion.drugsLibraryItemId),(0,i.K0)(u.pendingDeletion.drugsLibraryItemDraftId)));let l=[...r.map(r=>r.itemId),...d.map(r=>r.drugsLibraryItemId)];l.length&&await n.Z.update(u.drugsLibrary).set({version:(0,b.i6)`${u.drugsLibrary.version} + 1`}).where((0,i.d3)(u.drugsLibrary.itemId,l)),e.success=!0}catch(r){e.success=!1,e.errors=[r.message],d.Z.error("_publishDrugsLibraryItems ERROR",r)}finally{return e}}},30834:(r,e,t)=>{"use strict";t.d(e,{G$:()=>m,s:()=>y,t3:()=>g,fP:()=>l});var i=t(57745),a=t(30900),s=t(9576),d=t(10413),n=t(43509),u=t(57435);async function l(r){try{let{itemsIds:e,keys:t,returnDraftsIfExist:u}={...r},l=e||[],g=t||[],o=g?.length?(0,i.d3)(n.drugsLibraryDrafts.key,g):void 0,y=l?.length?(0,i.d3)(n.drugsLibraryDrafts.itemDraftId,l.map(r=>a.Z(r)?r:s.Z())):void 0,m=[...o?[o]:[],...y?[y]:[]],f=u?await d.Z.query.drugsLibraryDrafts.findMany({where:(0,i.xD)(...m)}):[];l=l.filter(r=>!f.map(r=>r.itemDraftId).includes(r)),g=g.filter(r=>!f.map(r=>r.key).includes(r));let c=g?.length?(0,i.d3)(n.drugsLibrary.key,g):void 0,b=f.length?(0,i.Nl)(n.drugsLibrary.itemId,f.map(r=>r.itemDraftId)):void 0,I=l?.length?(0,i.d3)(n.drugsLibrary.itemId,l.filter(r=>a.Z(r))):void 0,L=[(0,i.Ft)(n.drugsLibrary.deletedAt),(0,i.Ft)(n.pendingDeletion),b,I,c],D=(await d.Z.select({drugsLibraryItem:n.drugsLibrary,pendingDeletion:n.pendingDeletion}).from(n.drugsLibrary).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.drugsLibraryItemId,n.drugsLibrary.itemId)).where(L.length?(0,i.xD)(...L):void 0)).map(r=>r.drugsLibraryItem),p=D.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.drugsLibraryItemId,D.map(r=>r.itemId)),columns:{drugsLibraryItemId:!0}}):[];return{data:[...D.map(r=>({...r,isDraft:!1,isDeleted:!1})),...f.map(r=>({...r.data,isDraft:!0,isDeleted:!1}))].sort((r,e)=>r.position-e.position).filter(r=>!p.map(r=>r.drugsLibraryItemId).includes(r.itemId))}}catch(r){return u.Z.error("_getDrugsLibraryItems ERROR",r.message),{data:[],errors:[r.message]}}}async function g(r){let{itemId:e,returnDraftIfExists:t}={...r};try{if(!e)throw Error("Missing itemId");let r=a.Z(e)?(0,i.eq)(n.drugsLibrary.itemId,e):void 0,s=r?(0,i.eq)(n.drugsLibraryDrafts.itemDraftId,e):void 0,u=t&&s?await d.Z.query.drugsLibraryDrafts.findFirst({where:r}):void 0,l=u?{...u.data,isDraft:!1,isDeleted:!1}:null;if(l)return{data:l};let g=await d.Z.query.drugsLibrary.findFirst({where:(0,i.xD)((0,i.Ft)(n.drugsLibrary.deletedAt)),with:{draft:!0}});u=t?g?.draft:void 0;let o=u?.data||g;if(!(l=o?{...o,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:l}}catch(r){return u.Z.error("_getDrugsLibraryItem ERROR",r.message),{errors:[r.message]}}}var o=t(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function m(){try{let[{count:r}]=await d.Z.select({count:(0,o.QX)()}).from(n.drugsLibraryDrafts),[{count:e}]=await d.Z.select({count:(0,o.QX)()}).from(n.drugsLibraryDrafts).where((0,i.Ft)(n.drugsLibraryDrafts.itemId)),[{count:t}]=await d.Z.select({count:(0,o.QX)()}).from(n.drugsLibraryDrafts).where((0,i.K0)(n.drugsLibraryDrafts.itemId)),[{count:a}]=await d.Z.select({count:(0,o.QX)()}).from(n.pendingDeletion).where((0,i.K0)(n.pendingDeletion.drugsLibraryItemId)),[{count:s}]=await d.Z.select({count:(0,o.QX)()}).from(n.drugsLibrary);return{data:{allPublished:s,publishedWithDrafts:t,allDrafts:r,newDrafts:e,pendingDeletion:a}}}catch(r){return u.Z.error("_getDrugsLibraryItems ERROR",r.message),{data:y,errors:[r.message]}}}},88317:(r,e,t)=>{"use strict";t.d(e,{Z:()=>i});let i=(0,t(55802).io)(process.env.NEXT_PUBLIC_APP_URL)}};