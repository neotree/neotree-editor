"use strict";exports.id=7368,exports.ids=[7368],exports.modules={30834:(e,t,s)=>{s.d(t,{G$:()=>g,s:()=>f,t3:()=>c,fP:()=>o});var r=s(57745),i=s(30900),a=s(9576),n=s(10413),d=s(24161),l=s(57435);async function o(e){try{let{itemsIds:t,keys:s,returnDraftsIfExist:l=!0}={...e},o=(t||[]).map(e=>i.Z(e)?e:a.Z()),c=s||[],p=c?.length?(0,r.d3)(d.drugsLibraryDrafts.key,c):void 0,f=o?.length?(0,r.d3)(d.drugsLibraryDrafts.itemDraftId,o):void 0,g=[...p?[p]:[],...f?[f]:[]],u=l?await n.Z.query.drugsLibraryDrafts.findMany({where:(0,r.xD)(...g)}):[],D=u.map(e=>e.itemDraftId);o=o.map(e=>D.includes(e)?a.Z():e),c=c.map(e=>u.map(e=>e.key).includes(e)?a.Z():e);let h=c?.length?(0,r.d3)(d.drugsLibrary.key,c):void 0,I=o?.length?(0,r.d3)(d.drugsLibrary.itemId,o):void 0,m=[(0,r.Ft)(d.drugsLibrary.deletedAt),(0,r.Ft)(d.pendingDeletion),I,h,D.length?(0,r.Nl)(d.drugsLibrary.itemId,D):void 0],y=(await n.Z.select({drugsLibraryItem:d.drugsLibrary,pendingDeletion:d.pendingDeletion}).from(d.drugsLibrary).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.drugsLibraryItemId,d.drugsLibrary.itemId)).where(m.length?(0,r.xD)(...m):void 0)).map(e=>e.drugsLibraryItem),w=y.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(d.pendingDeletion.drugsLibraryItemId,y.map(e=>e.itemId)),columns:{drugsLibraryItemId:!0}}):[];return{data:[...y.map(e=>({...e,isDraft:!1,isDeleted:!1})),...u.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!w.map(e=>e.drugsLibraryItemId).includes(e.itemId))}}catch(e){return l.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){let{itemId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing itemId");let e=i.Z(t)?(0,r.eq)(d.drugsLibrary.itemId,t):void 0,a=e?(0,r.eq)(d.drugsLibraryDrafts.itemDraftId,t):void 0,l=s&&a?await n.Z.query.drugsLibraryDrafts.findFirst({where:e}):void 0,o=l?{...l.data,isDraft:!1,isDeleted:!1}:null;if(o)return{data:o};let c=await n.Z.query.drugsLibrary.findFirst({where:(0,r.xD)((0,r.Ft)(d.drugsLibrary.deletedAt)),with:{draft:!0}});l=s?c?.draft:void 0;let p=l?.data||c;if(!(o=p?{...p,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:o}}catch(e){return l.Z.error("_getDrugsLibraryItem ERROR",e.message),{errors:[e.message]}}}var p=s(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function g(){try{let[{count:e}]=await n.Z.select({count:(0,p.QX)()}).from(d.drugsLibraryDrafts),[{count:t}]=await n.Z.select({count:(0,p.QX)()}).from(d.drugsLibraryDrafts).where((0,r.Ft)(d.drugsLibraryDrafts.itemId)),[{count:s}]=await n.Z.select({count:(0,p.QX)()}).from(d.drugsLibraryDrafts).where((0,r.K0)(d.drugsLibraryDrafts.itemId)),[{count:i}]=await n.Z.select({count:(0,p.QX)()}).from(d.pendingDeletion).where((0,r.K0)(d.pendingDeletion.drugsLibraryItemId)),[{count:a}]=await n.Z.select({count:(0,p.QX)()}).from(d.drugsLibrary);return{data:{allPublished:a,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return l.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:f,errors:[e.message]}}}},57368:(e,t,s)=>{s.d(t,{tW:()=>q,co:()=>m,ix:()=>D,GM:()=>b,W0:()=>I,Zu:()=>u,XA:()=>L,DX:()=>x,Ew:()=>R,eh:()=>o,A0:()=>c,NB:()=>w,uK:()=>y,pw:()=>v,bK:()=>f,Tw:()=>p,$F:()=>h,pd:()=>F,Sc:()=>k,f:()=>Z});var r=s(57745),i=s(30900),a=s(9576),n=s(10413),d=s(24161),l=s(57435);async function o(){let e=await n.Z.select({scriptId:d.scripts.scriptId}).from(d.scripts).where((0,r.Ft)(d.scripts.deletedAt));return e?.map(e=>e.scriptId)??[]}async function c(e){let t=await n.Z.select({oldScript:d.scripts.oldScriptId}).from(d.scripts).where((0,r.eq)(d.scripts.scriptId,e));return t?.map(e=>e.oldScript)??[]}async function p(e){try{let{scriptsIds:t=[],hospitalIds:s=[],returnDraftsIfExist:l}={...e},o=t.filter(e=>!i.Z(e));t=t.filter(e=>i.Z(e));let c=s.filter(e=>!i.Z(e));if(s=s.filter(e=>i.Z(e)),o.length){let e=await n.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.oldScriptId,o),columns:{scriptId:!0,oldScriptId:!0}});o.forEach(s=>{let r=e.filter(e=>e.oldScriptId===s)[0];t.push(r?.scriptId||a.Z())})}if(c.length){let e=await n.Z.query.hospitals.findMany({where:(0,r.d3)(d.hospitals.oldHospitalId,c),columns:{hospitalId:!0,oldHospitalId:!0}});c.forEach(t=>{let r=e.filter(e=>e.oldHospitalId===t)[0];s.push(r?.hospitalId||a.Z())})}let p=(l?await n.Z.select({scriptDraft:d.scriptsDrafts,hospitalName:d.hospitals.name}).from(d.scriptsDrafts).leftJoin(d.hospitals,(0,r.eq)(d.hospitals.hospitalId,d.scriptsDrafts.hospitalId)).where((0,r.xD)(t?.length?(0,r.d3)(d.scriptsDrafts.scriptDraftId,t):void 0,s.length?(0,r.d3)(d.scriptsDrafts.hospitalId,s):void 0)):[]).map(e=>({...e.scriptDraft,hospitalName:e.hospitalName})),f=(await n.Z.select({script:d.scripts,pendingDeletion:d.pendingDeletion,hospitalName:d.hospitals.name}).from(d.scripts).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.scriptId,d.scripts.scriptId)).leftJoin(d.scriptsDrafts,(0,r.eq)(d.scriptsDrafts.scriptId,d.scripts.scriptId)).leftJoin(d.hospitals,(0,r.xD)((0,r.eq)(d.hospitals.hospitalId,d.scripts.hospitalId),(0,r.Ft)(d.hospitals.deletedAt))).where((0,r.xD)((0,r.Ft)(d.scripts.deletedAt),(0,r.Ft)(d.pendingDeletion),l?(0,r.Ft)(d.scriptsDrafts.scriptId):void 0,t.length?(0,r.d3)(d.scripts.scriptId,t):void 0,s.length?(0,r.d3)(d.scripts.hospitalId,s):void 0))).map(e=>({...e.script,hospitalName:e.hospitalName})),g=f.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(d.pendingDeletion.scriptId,f.map(e=>e.scriptId)),columns:{scriptId:!0}}):[];return{data:[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...p.map(e=>({...e.data,hospitalName:e.hospitalName,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!g.map(e=>e.scriptId).includes(e.scriptId)).map(e=>({...e,hospitalId:e.hospitalName?e.hospitalId:null}))}}catch(e){return l.Z.error("_getScripts ERROR",e.message),{data:[],errors:[e.message]}}}async function f(e){let{scriptId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing scriptId");let e=i.Z(t)?(0,r.eq)(d.scripts.scriptId,t):void 0,a=i.Z(t)?void 0:(0,r.eq)(d.scripts.oldScriptId,t),l=e?(0,r.eq)(d.scriptsDrafts.scriptDraftId,t):void 0,o=s&&l?await n.Z.query.scriptsDrafts.findFirst({where:l}):void 0,c=o?{...o.data,isDraft:!1,isDeleted:!1}:null;if(c)return{data:c};let p=await n.Z.select({script:d.scripts,pendingDeletion:d.pendingDeletion,draft:d.scriptsDrafts,hospitalName:d.hospitals.name}).from(d.scripts).leftJoin(d.hospitals,(0,r.xD)((0,r.eq)(d.hospitals.hospitalId,d.scripts.hospitalId),(0,r.Ft)(d.hospitals.deletedAt))).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.scriptId,d.scripts.scriptId)).leftJoin(d.scriptsDrafts,(0,r.eq)(d.scripts.scriptId,d.scriptsDrafts.scriptDraftId)).where((0,r.xD)((0,r.Ft)(d.scripts.deletedAt),(0,r.Ft)(d.pendingDeletion),(0,r.or)(e,a))),f=p[0]?{...p[0].script,draft:p[0].draft||void 0,hospitalName:p[0].hospitalName||""}:null;o=s?f?.draft:void 0;let g=o?.data||f;if(!(c=g?{...g,isDraft:!1,isDeleted:!1,hospitalId:g.hospitalName?g.hospitalId:null}:null))return{data:null};return{data:c}}catch(e){return l.Z.error("_getScript ERROR",e.message),{errors:[e.message]}}}var g=s(60938);let u={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function D(){try{let[{count:e}]=await n.Z.select({count:(0,g.QX)()}).from(d.scriptsDrafts),[{count:t}]=await n.Z.select({count:(0,g.QX)()}).from(d.scriptsDrafts).where((0,r.Ft)(d.scriptsDrafts.scriptId)),[{count:s}]=await n.Z.select({count:(0,g.QX)()}).from(d.scriptsDrafts).where((0,r.K0)(d.scriptsDrafts.scriptId)),[{count:i}]=await n.Z.select({count:(0,g.QX)()}).from(d.pendingDeletion).where((0,r.K0)(d.pendingDeletion.scriptId)),[{count:a}]=await n.Z.select({count:(0,g.QX)()}).from(d.scripts);return{data:{allPublished:a,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return l.Z.error("_getScripts ERROR",e.message),{data:u,errors:[e.message]}}}async function h(e){try{let e={};return(await n.Z.query.scriptsHistory.findMany({})).forEach(t=>{e[t.scriptId]=e[t.scriptId]||{},e[t.scriptId][t.version]=e[t.scriptId][t.version]||[],e[t.scriptId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let I={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function m(e){let{scriptsIds:t=[],types:s=[]}={...e};try{let e=t.length?(0,r.d3)(d.screens.scriptId,t):void 0,i=t.length?(0,r.d3)(d.screensDrafts.scriptId,t):void 0,a=s.length?(0,r.d3)(d.screens.type,s):void 0,l=s.length?(0,r.d3)(d.screensDrafts.type,s):void 0,[{count:o}]=await n.Z.select({count:(0,g.QX)()}).from(d.screensDrafts).where((0,r.xD)(i,l)),[{count:c}]=await n.Z.select({count:(0,g.QX)()}).from(d.screensDrafts).where((0,r.xD)(i,l,(0,r.Ft)(d.screensDrafts.screenId))),[{count:p}]=await n.Z.select({count:(0,g.QX)()}).from(d.screensDrafts).where((0,r.xD)(i,l,(0,r.K0)(d.screensDrafts.screenId))),[{count:f}]=await n.Z.select({count:(0,g.QX)()}).from(d.pendingDeletion).where((0,r.xD)(t.length?(0,r.or)((0,r.d3)(d.pendingDeletion.screenScriptId,t)):void 0,(0,r.K0)(d.pendingDeletion.screenId))),[{count:u}]=await n.Z.select({count:(0,g.QX)()}).from(d.screens).where((0,r.xD)(e,a));return{data:{allPublished:u,publishedWithDrafts:p,allDrafts:o,newDrafts:c,pendingDeletion:f}}}catch(e){return l.Z.error("_getScreens ERROR",e.message),{data:I,errors:[e.message]}}}async function y(e){try{let{scriptsIds:t=[],screensIds:s=[],types:l=[],returnDraftsIfExist:o,withImagesOnly:c}={...e},p=s.filter(e=>!i.Z(e));if(s=s.filter(e=>i.Z(e)),p.length){let e=await n.Z.query.screens.findMany({where:(0,r.d3)(d.screens.oldScreenId,p),columns:{screenId:!0,oldScreenId:!0}});p.forEach(t=>{let r=e.filter(e=>e.oldScreenId===t)[0];s.push(r?.screenId||a.Z())})}let f=(t=t.filter(e=>i.Z(e))).filter(e=>!i.Z(e));if(f.length){let e=await n.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.oldScriptId,f),columns:{scriptId:!0,oldScriptId:!0}});f.forEach(s=>{let r=e.filter(e=>e.oldScriptId===s)[0];t.push(r?.scriptId||a.Z())})}let g=o?await n.Z.query.screensDrafts.findMany({where:(0,r.xD)(t?.length?(0,r.or)((0,r.d3)(d.screensDrafts.scriptId,t),(0,r.d3)(d.screensDrafts.scriptDraftId,t)):void 0,s?.length?(0,r.d3)(d.screensDrafts.screenDraftId,s):void 0,l?.length?(0,r.d3)(d.screensDrafts.type,l):void 0)}):[],u=(await n.Z.select({screen:d.screens,pendingDeletion:d.pendingDeletion,script:{title:d.scripts.title,hospitalId:d.scripts.hospitalId},hospital:{name:d.hospitals.name}}).from(d.screens).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.screenId,d.screens.screenId)).leftJoin(d.screensDrafts,(0,r.eq)(d.screensDrafts.screenId,d.screens.screenId)).leftJoin(d.scripts,(0,r.eq)(d.scripts.scriptId,d.screens.scriptId)).leftJoin(d.hospitals,(0,r.xD)((0,r.eq)(d.scripts.scriptId,d.screens.scriptId),(0,r.eq)(d.scripts.hospitalId,d.hospitals.hospitalId))).where((0,r.xD)((0,r.Ft)(d.screens.deletedAt),(0,r.Ft)(d.pendingDeletion),o?(0,r.Ft)(d.screensDrafts.screenId):void 0,t?.length?(0,r.d3)(d.screens.scriptId,t):void 0,s?.length?(0,r.d3)(d.screens.screenId,s):void 0,l?.length?(0,r.d3)(d.screens.type,l):void 0,c?(0,r.or)((0,r.K0)(d.screens.image1),(0,r.K0)(d.screens.image2),(0,r.K0)(d.screens.image3)):void 0))).map(e=>({...e.screen,scriptTitle:e.script?.title||"",hospitalName:e.hospital?.name||""})),D=u.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(d.pendingDeletion.screenId,u.map(e=>e.screenId)),columns:{screenId:!0}}):[];return{data:[...u.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!D.map(e=>e.screenId).includes(e.screenId))}}catch(e){return l.Z.error("_getScreens ERROR",e.message),{data:[],errors:[e.message]}}}async function w(e){let{screenId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing screenId");let e=i.Z(t)?(0,r.eq)(d.screens.screenId,t):void 0,a=i.Z(t)?void 0:(0,r.eq)(d.screens.oldScreenId,t),l=e?(0,r.eq)(d.screensDrafts.screenDraftId,t):void 0,o=s&&l?await n.Z.query.screensDrafts.findFirst({where:l}):void 0,c=o?{...o.data,isDraft:!1,isDeleted:!1}:null;if(c)return{data:c};let p=await n.Z.select({screen:d.screens,pendingDeletion:d.pendingDeletion,draft:d.screensDrafts}).from(d.screens).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.screenId,d.screens.screenId)).leftJoin(d.screensDrafts,(0,r.eq)(d.screens.screenId,d.screensDrafts.screenDraftId)).where((0,r.xD)((0,r.Ft)(d.screens.deletedAt),(0,r.Ft)(d.pendingDeletion),(0,r.or)(e,a))),f=p[0]?{...p[0].screen,draft:p[0].draft||void 0}:null;o=s?f?.draft:void 0;let g=o?.data||f;if(!(c=g?{...g,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return l.Z.error("_getScreen ERROR",e.message),{errors:[e.message]}}}async function Z(e){try{let{scriptsIds:t=[],screensIds:s=[],returnDraftsIfExist:l}={...e},o=s.filter(e=>!i.Z(e));if(s=s.filter(e=>i.Z(e)),o.length){let e=await n.Z.query.screens.findMany({where:(0,r.d3)(d.screens.oldScreenId,o),columns:{screenId:!0,oldScreenId:!0}});o.forEach(t=>{let r=e.filter(e=>e.oldScreenId===t)[0];s.push(r?.screenId||a.Z())})}let c=(t=t.filter(e=>i.Z(e))).filter(e=>!i.Z(e));if(c.length){let e=await n.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.oldScriptId,c),columns:{scriptId:!0,oldScriptId:!0}});c.forEach(s=>{let r=e.filter(e=>e.oldScriptId===s)[0];t.push(r?.scriptId||a.Z())})}let p=l?await n.Z.query.screensDrafts.findMany({where:(0,r.xD)(t?.length?(0,r.or)((0,r.d3)(d.screensDrafts.scriptId,t),(0,r.d3)(d.screensDrafts.scriptDraftId,t)):void 0,s?.length?(0,r.d3)(d.screensDrafts.screenDraftId,s):void 0)}):[],f=(await n.Z.select({screen:{title:d.screens.title,screenId:d.screens.screenId,oldScreenId:d.screens.oldScreenId,position:d.screens.position,type:d.screens.type,refId:d.screens.refId},pendingDeletion:d.pendingDeletion}).from(d.screens).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.screenId,d.screens.screenId)).leftJoin(d.screensDrafts,(0,r.eq)(d.screensDrafts.screenId,d.screens.screenId)).where((0,r.xD)((0,r.Ft)(d.screens.deletedAt),(0,r.Ft)(d.pendingDeletion),l?(0,r.Ft)(d.screensDrafts.screenId):void 0,t?.length?(0,r.d3)(d.screens.scriptId,t):void 0,s?.length?(0,r.d3)(d.screens.screenId,s):void 0))).map(e=>e.screen),g=f.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(d.pendingDeletion.screenId,f.map(e=>e.screenId)),columns:{screenId:!0}}):[];return{data:[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...p.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!g.map(e=>e.screenId).includes(e.screenId)).map((e,t)=>({...e,position:t+1}))}}catch(e){return l.Z.error("_listScreens ERROR",e.message),{data:[],errors:[e.message]}}}async function v(e){try{let e={};return(await n.Z.query.screensHistory.findMany({})).forEach(t=>{e[t.screenId]=e[t.screenId]||{},e[t.screenId][t.version]=e[t.screenId][t.version]||[],e[t.screenId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let b={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function q(e){let{scriptsIds:t=[]}={...e};try{let e=t.length?(0,r.d3)(d.diagnoses.scriptId,t):void 0,s=t.length?(0,r.d3)(d.diagnosesDrafts.scriptId,t):void 0,[{count:i}]=await n.Z.select({count:(0,g.QX)()}).from(d.diagnosesDrafts).where(s),[{count:a}]=await n.Z.select({count:(0,g.QX)()}).from(d.diagnosesDrafts).where((0,r.xD)(s,(0,r.Ft)(d.diagnosesDrafts.diagnosisId))),[{count:l}]=await n.Z.select({count:(0,g.QX)()}).from(d.diagnosesDrafts).where((0,r.xD)(s,(0,r.K0)(d.diagnosesDrafts.diagnosisId))),[{count:o}]=await n.Z.select({count:(0,g.QX)()}).from(d.pendingDeletion).where((0,r.xD)(t.length?(0,r.or)((0,r.d3)(d.pendingDeletion.diagnosisScriptId,t)):void 0,(0,r.K0)(d.pendingDeletion.diagnosisId))),[{count:c}]=await n.Z.select({count:(0,g.QX)()}).from(d.diagnoses).where(e);return{data:{allPublished:c,publishedWithDrafts:l,allDrafts:i,newDrafts:a,pendingDeletion:o}}}catch(e){return l.Z.error("_getDiagnoses ERROR",e.message),{data:b,errors:[e.message]}}}async function L(e){try{let{scriptsIds:t=[],diagnosesIds:s=[],returnDraftsIfExist:l,withImagesOnly:o}={...e},c=s.filter(e=>!i.Z(e));if(s=s.filter(e=>i.Z(e)),c.length){let e=await n.Z.query.diagnoses.findMany({where:(0,r.d3)(d.diagnoses.oldDiagnosisId,c),columns:{diagnosisId:!0,oldDiagnosisId:!0}});c.forEach(t=>{let r=e.filter(e=>e.oldDiagnosisId===t)[0];s.push(r?.diagnosisId||a.Z())})}let p=(t=t.filter(e=>i.Z(e))).filter(e=>!i.Z(e));if(p.length){let e=await n.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.oldScriptId,p),columns:{scriptId:!0,oldScriptId:!0}});p.forEach(s=>{let r=e.filter(e=>e.oldScriptId===s)[0];t.push(r?.scriptId||a.Z())})}let f=l?await n.Z.query.diagnosesDrafts.findMany({where:(0,r.xD)(t?.length?(0,r.or)((0,r.d3)(d.diagnosesDrafts.scriptId,t),(0,r.d3)(d.diagnosesDrafts.scriptDraftId,t)):void 0,s?.length?(0,r.d3)(d.diagnosesDrafts.diagnosisDraftId,s):void 0)}):[],g=(await n.Z.select({diagnosis:d.diagnoses,pendingDeletion:d.pendingDeletion,script:{title:d.scripts.title,hospitalId:d.scripts.hospitalId},hospital:{name:d.hospitals.name}}).from(d.diagnoses).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.diagnosisId,d.diagnoses.diagnosisId)).leftJoin(d.diagnosesDrafts,(0,r.eq)(d.diagnosesDrafts.diagnosisId,d.diagnoses.diagnosisId)).leftJoin(d.scripts,(0,r.eq)(d.scripts.scriptId,d.diagnoses.scriptId)).leftJoin(d.hospitals,(0,r.xD)((0,r.eq)(d.scripts.scriptId,d.diagnoses.scriptId),(0,r.eq)(d.scripts.hospitalId,d.hospitals.hospitalId))).where((0,r.xD)((0,r.Ft)(d.diagnoses.deletedAt),(0,r.Ft)(d.pendingDeletion),l?(0,r.Ft)(d.diagnosesDrafts.diagnosisId):void 0,t?.length?(0,r.d3)(d.diagnoses.scriptId,t):void 0,s?.length?(0,r.d3)(d.diagnoses.diagnosisId,s):void 0,o?(0,r.or)((0,r.K0)(d.diagnoses.image1),(0,r.K0)(d.diagnoses.image2),(0,r.K0)(d.diagnoses.image3)):void 0))).map(e=>({...e.diagnosis,scriptTitle:e.script?.title||"",hospitalName:e.hospital?.name||""})),u=g.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(d.pendingDeletion.diagnosisId,g.map(e=>e.diagnosisId)),columns:{diagnosisId:!0}}):[];return{data:[...g.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!u.map(e=>e.diagnosisId).includes(e.diagnosisId)).map(e=>({...e,scriptTitle:e.scriptTitle||"",hospitalName:e.hospitalName||""}))}}catch(e){return l.Z.error("_getDiagnoses ERROR",e.message),{data:[],errors:[e.message]}}}async function R(e){let{diagnosisId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing diagnosisId");let e=i.Z(t)?(0,r.eq)(d.diagnoses.diagnosisId,t):void 0,a=i.Z(t)?void 0:(0,r.eq)(d.diagnoses.oldDiagnosisId,t),l=e?(0,r.eq)(d.diagnosesDrafts.diagnosisDraftId,t):void 0,o=s&&l?await n.Z.query.diagnosesDrafts.findFirst({where:l}):void 0,c=o?{...o.data,isDraft:!1,isDeleted:!1}:null;if(c)return{data:c};let p=await n.Z.select({diagnosis:d.diagnoses,pendingDeletion:d.pendingDeletion,draft:d.diagnosesDrafts}).from(d.diagnoses).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.diagnosisId,d.diagnoses.diagnosisId)).leftJoin(d.diagnosesDrafts,(0,r.eq)(d.diagnoses.diagnosisId,d.diagnosesDrafts.diagnosisDraftId)).where((0,r.xD)((0,r.Ft)(d.diagnoses.deletedAt),(0,r.Ft)(d.pendingDeletion),(0,r.or)(e,a))),f=p[0]?{...p[0].diagnosis,draft:p[0].draft||void 0}:null;o=s?f?.draft:void 0;let g=o?.data||f;if(!(c=g?{...g,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return l.Z.error("_getDiagnosis ERROR",e.message),{errors:[e.message]}}}async function x(e){try{let e={};return(await n.Z.query.diagnosesHistory.findMany({})).forEach(t=>{e[t.diagnosisId]=e[t.diagnosisId]||{},e[t.diagnosisId][t.version]=e[t.diagnosisId][t.version]||[],e[t.diagnosisId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}async function k(e){try{let{scriptsIds:t=[],hospitalsIds:s=[],returnDraftsIfExist:i}={...e},a=await n.Z.query.hospitals.findMany({where:(0,r.xD)((0,r.Ft)(d.hospitals.deletedAt))}),l=t.length?(0,r.d3)(d.scripts.scriptId,t):void 0,o=s.length?(0,r.d3)(d.scripts.hospitalId,s):void 0,c=await n.Z.query.scriptsDrafts.findMany({where:(0,r.xD)(o,t.length?(0,r.xD)((0,r.d3)(d.scriptsDrafts.scriptDraftId,t),(0,r.Ft)(d.scriptsDrafts.scriptId)):void 0),with:{screensDrafts:!0}}),p=(i?await n.Z.query.scripts.findMany({where:(0,r.xD)(l,o),with:{draft:!!i||void 0,screens:{with:{draft:!!i||void 0}}}}):[]).map(e=>({...e,...i&&e.draft?e.draft.data:null,screens:e.screens.sort((e,t)=>e.position-t.position)})),f=c.map(e=>({...e.data,scriptId:e.scriptDraftId,screens:e.screensDrafts.map(e=>({...e.data,screenId:e.screenDraftId}))})),g=[...p,...f].sort((e,t)=>e.position-t.position),u=[];return g.forEach(e=>{let t=a.filter(t=>t.hospitalId===e.hospitalId)[0];u.push({scriptId:e.scriptId,title:e.title,hospitalName:t?.name||"",screens:e.screens.map(e=>{let t=e.items,s=e.fields,r=[{label:e.label,key:e.key,type:e.type,...(e.type,{dataType:e.dataType,value:null,valueLabel:null})}];switch(e.type){case"progress":case"edliz_summary_table":case"mwi_edliz_summary_table":case"zw_edliz_summary_table":case"management":r=[];break;case"yesno":r=[{value:"true",label:e.positiveLabel||"Yes"},{value:"false",label:e.negativeLabel||"Yes"}].map(t=>({label:e.label,key:e.key,type:e.type,dataType:"boolean",value:t.value,valueLabel:t.label}));break;case"diagnosis":r=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.id,type:e.type,dataType:"diagnosis"}));break;case"checklist":r=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.key,type:e.type,dataType:null}));break;case"form":r=s.map(e=>{let t=e.dataType;switch(e.type){case"datetime":t="datetime";break;case"date":t="date";break;case"time":t="time";break;case"dropdown":t="dropdown";break;case"multi_select":t="multi_select";break;case"number":t="number";break;case"text":t="string",("uid"===`${e.key}`.toLowerCase()||`${e.key}`.toLowerCase().includes("nuid"))&&(t="uid");break;default:t=e.dataType}if(["multi_select","dropdown"].includes(e.type)){let t="dropdown";return"multi_select"===e.type&&(t="multi_select"),(e.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).map(e=>({value:(e=e.split(","))[0],label:e[1]})).map(s=>({label:e.label,key:e.key,type:e.type,dataType:t,value:s.value,valueLabel:s.label}))}return[{label:e.label,key:e.key,type:e.type,dataType:t,value:null,valueLabel:null}]}).reduce((e,t)=>[...e,...t],[]);break;case"single_select":r=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"single_select_option",value:t.id,valueLabel:t.label}));break;case"multi_select":r=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"multi_select_option",value:t.id,valueLabel:t.label}))}return{screenId:e.screenId,type:e.type,title:e.title,ref:e.refId,fields:r}})})}),{data:u}}catch(e){return{errors:[e.message],data:[]}}}var E=s(30834);async function F(e){try{let t=await p(e),s=await y({types:["drugs","feeds","fluids"],scriptsIds:t.data.map(e=>e.scriptId),returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted}),r=Object.keys(s.data.reduce((e,t)=>([...t.drugs,...t.fluids,...t.feeds].forEach(t=>{e[t.key]=t.key}),e),{}));return await (0,E.fP)({keys:r,returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted})}catch(e){return l.Z.error("_getScriptsDrugsLibrary ERROR",e.message),{data:[],errors:[e.message]}}}}};