exports.id=3712,exports.ids=[3712],exports.modules={58359:()=>{},93739:()=>{},54491:(e,t,s)=>{"use strict";s.d(t,{hf:()=>h,uW:()=>y});var r=s(57368),i=s(10413),a=s(57745),n=s(81445),d=s(93567),o=s(57435);function c(e){if(!e||""===e)return"A";let t=e.match(/^([A-Z]+)(\d*)$/);if(!t)throw Error("Invalid alias format");let[s,r,i]=t,a=i?parseInt(i,10):0,n=(e=>{let t="";do t=String.fromCharCode(e%26+65)+t,e=Math.floor(e/26)-1;while(e>=0);return t})(r.split("").reduce((e,t)=>26*e+(t.charCodeAt(0)-65),0)+1);return n.length>r.length?(n="A")+(a+1):n+(i||"")}async function l(e,t,s,r){let i=[],a=s;for(let s of t)if(!["management","mwi_edliz_summary_table","progress","zw_edliz_summary_table","diagnosis","drugs","fluids","feeds"].includes(s.type)){if("form"===s.type&&Array.isArray(s.fields))for(let t of s.fields)Array.isArray(t.prePopulate)&&t.prePopulate.length>0&&!await p({name:t.key,script:e})&&(a=c(a))&&i.push({name:t.key,alias:a,script:e,oldScript:r});else Array.isArray(s.prePopulate)&&s.prePopulate.length>0&&!await p({name:s.key,script:e})&&(a=c(a))&&i.push({name:s.key,alias:a,script:e,oldScript:r})}return i}async function p(e){return!!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,e.script),(0,a.eq)(d.aliases.name,e.name))})}async function u(){return!!await i.Z.query.aliases.findFirst()}async function f(e){let t={success:!1},s=[],r={};try{for(let t of e)try{if(!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,t.script),(0,a.eq)(d.aliases.name,t.name)),orderBy:(0,n.C)(d.aliases.createdAt)})){let e=i.Z.insert(d.aliases).values({alias:t.alias,name:t.name,script:t.script,oldScript:t.oldScript});r.query=e.toSQL(),await e.execute()}}catch(e){o.Z.error(e.message),s.push(e.message)}s.length?(t.errors=s,t.info=r):t.success=!0}catch(e){t.success=!1,t.errors=[e.message],t.info=r}}async function g(e){try{let t=e?await i.Z.query.aliases.findFirst({where:(0,a.eq)(d.aliases.script,e),orderBy:(0,n.C)(d.aliases.createdAt)}):"";return t?t.alias:""}catch(e){}}async function h(){try{let e=await (0,r.eh)();await u()||await y(e)}catch(e){}}async function y(e){try{for(let t of e)if(t){let e=await (0,r.A0)(t),s=await g(t),i=[t],{data:a,errors:n}=await (0,r.uK)({scriptsIds:i});if(!n||0===n.length){let r=await l(t,a,s||"",e?.[0]??null);r&&r.length>0&&await f(r)}}}catch(e){o.Z.error("Error in _generateScreenAliases:",e)}}},22418:(e,t,s)=>{"use strict";s.d(t,{U5:()=>y,Ms:()=>D,Nq:()=>Z,hA:()=>q,E8:()=>g,$s:()=>m,cj:()=>I,Lr:()=>w});var r=s(60938),i=s(57745),a=s(81445),n=s(9576),d=s(57435),o=s(10413),c=s(93567),l=s(88317),p=s(30834),u=s(10970),f=s(57368);async function g({keys:e}){try{let t=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),s=[];return t.data.forEach(t=>{let r=t.drugs.filter(t=>!e.includes(t.key)),i=t.fluids.filter(t=>!e.includes(t.key)),a=t.feeds.filter(t=>!e.includes(t.key));r.length!==t.drugs.length&&s.push({...t,drugs:r}),i.length!==t.fluids.length&&s.push({...t,fluids:i}),a.length!==t.feeds.length&&s.push({...t,feeds:a})}),s.length&&await (0,u.uD)({data:s}),{data:{success:!0}}}catch(e){return{errors:[e.message],data:{success:!1}}}}let h=async(e,t=1,s="")=>{let[{count:a}]=await o.Z.select({count:(0,r.QX)()}).from(c.drugsLibraryDrafts).where((0,i.eq)(c.drugsLibraryDrafts.key,e)),[{count:n}]=await o.Z.select({count:(0,r.QX)()}).from(c.drugsLibrary).where((0,i.eq)(c.drugsLibrary.key,e));return n||a?await h(`${s||e}-${t+1}`,t+1,s||e):e};async function y({data:e,...t}){try{let{data:s}=await (0,p.fP)({itemsIds:e.map(e=>e.itemId)}),r=[];for(let e of s){let t=await h(e.key);r.push({...e,key:t,itemId:n.Z(),position:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0})}return await m({data:r,...t})}catch(e){return d.Z.error("_copyDrugsLibraryItems ERROR",e.message),{success:!1,errors:[e.message]}}}async function I({data:e,broadcastAction:t}){try{let s=e.map(e=>e.key).filter(e=>e);if(s.length){let r=await (0,p.fP)({keys:s});if((e=e.filter(e=>!r.data.map(e=>e.key).includes(e.key)).map(e=>({...e,itemId:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0,position:void 0,version:void 0}))).length)return await m({data:e,broadcastAction:t})}return{success:!0}}catch(e){return d.Z.error("_saveDrugsLibraryItemsIfKeysNotExist ERROR",e.message),{errors:[e.message],success:!1}}}async function w({data:e,broadcastAction:t}){try{let s=e.map(e=>e.key).filter(e=>e);if(s.length){let r=await (0,p.fP)({keys:s});if((e=e.map(e=>{let t=r.data.find(t=>`${t.key}`.toLowerCase()===`${e.key}`.toLowerCase());return{...e,itemId:t?.itemId||e.itemId,createdAt:t?.createdAt||e.createdAt,updatedAt:t?.updatedAt||e.updatedAt,deletedAt:t?.deletedAt||e.deletedAt,publishDate:t?.publishDate||e.publishDate,id:t?.id||e.id,position:t?.position||e.position,version:t?.version||e.version}})).length)return await m({data:e,broadcastAction:t})}return{success:!0}}catch(e){return d.Z.error("_saveDrugsLibraryItemsAndUpdateIfExists ERROR",e.message),{errors:[e.message],success:!1}}}async function m({data:e,broadcastAction:t}){let s={success:!1};try{let t=[],r=[],d=[];for(let{itemId:s,...l}of e)try{let e=s||n.Z(),p="",u=l.key||"",f=null,g=l.type||null;if(!t.length){let t=s?await o.Z.query.drugsLibraryDrafts.findFirst({where:(0,i.eq)(c.drugsLibraryDrafts.itemDraftId,e)}):null,n=t||!s?null:await o.Z.query.drugsLibrary.findFirst({where:(0,i.eq)(c.drugsLibrary.itemId,e)});if(t){p=t.data.key,f=t.data.type||null;let s={...t.data,...l};await o.Z.update(c.drugsLibraryDrafts).set({data:s,position:s.position}).where((0,i.eq)(c.drugsLibraryDrafts.itemDraftId,e))}else{p=n?.key||"",f=n?.type||null;let t=l.position||n?.position;if(!t){let e=await o.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,a.C)(c.drugsLibrary.position)}),s=await o.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,a.C)(c.drugsLibraryDrafts.position)});t=Math.max(0,e?.position||0,s?.position||0)+1}let s={...n,...l,itemId:e,version:n?.version?n.version+1:1,position:t};await o.Z.insert(c.drugsLibraryDrafts).values({data:s,itemDraftId:e,position:s.position,itemId:n?.itemId,key:s.key,type:s.type})}p&&u&&p!==u&&r.push({old:p,new:u}),f&&g&&f!==g&&p&&d.push(p)}}catch(e){t.push(e.message)}if(d.length&&await g({keys:d}),r.length){let e=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),t=[];e.data.forEach(e=>{let s=!1,i=e.drugs.map(e=>{if(r.map(e=>e.old).includes(e.key)){let t=r.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},s=!0}return e}),a=e.fluids.map(e=>{if(r.map(e=>e.old).includes(e.key)){let t=r.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},s=!0}return e}),n=e.feeds.map(e=>{if(r.map(e=>e.old).includes(e.key)){let t=r.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},s=!0}return e});s&&t.push({...e,drugs:i,fluids:a,feeds:n})}),t.length&&await (0,u.uD)({data:t})}t.length?s.errors=t:s.success=!0}catch(e){s.success=!1,s.errors=[e.message],d.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!s?.errors?.length&&t&&l.Z.emit("data_changed","save_drugs_library_items"),s}}async function D(){try{return await o.Z.delete(c.drugsLibraryDrafts),!0}catch(e){throw e}}async function Z({itemsIds:e,broadcastAction:t}){let s={success:!1};try{let t=e||[];if(t.length){let e=await (0,p.fP)({itemsIds:t,returnDraftsIfExist:!0});await o.Z.delete(c.drugsLibraryDrafts).where((0,i.d3)(c.drugsLibraryDrafts.itemDraftId,t));let s=e.data.filter(e=>!e.isDraft).map(e=>({drugsLibraryItemId:e.itemId}));s.length&&await o.Z.insert(c.pendingDeletion).values(s),await g({keys:e.data.map(e=>e.key)})}s.success=!0}catch(e){s.success=!1,s.errors=[e.message],d.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!s?.errors?.length&&t&&l.Z.emit("data_changed","delete_drugs_library_items"),s}}async function v({previous:e,drafts:t}){try{let s=[];for(let r of t){let t={version:r?.data?.version||1,itemId:r?.data?.itemId,changes:{}};if(r?.data?.version===1)t.changes={action:"create_drugs_library_item",description:"Create drugs library item",oldValues:[],newValues:[]};else{let s=e.filter(e=>e.itemId===r?.data?.itemId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=r.data[e],n={...s}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:i,newValues:a}}s.push(t)}await o.Z.insert(c.drugsLibraryHistory).values(s)}catch(e){d.Z.error(e.message)}}var b=s(34149);async function q(e){let t={success:!1};try{let e=await o.Z.query.pendingDeletion.findMany({where:(0,i.K0)(c.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0,key:!0}}}});if((e=e.filter(e=>e.drugsLibraryItem)).length){let t=new Date;await o.Z.update(c.drugsLibrary).set({deletedAt:t,key:(0,b.i6)`CONCAT(${c.drugsLibrary.key}, '_', ${c.drugsLibrary.itemId})`}).where((0,i.d3)(c.drugsLibrary.itemId,e.map(e=>e.drugsLibraryItemId))),await o.Z.insert(c.drugsLibraryHistory).values(e.map(e=>({version:e.drugsLibraryItem.version,itemId:e.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null,key:e.drugsLibraryItem.key}],newValues:[{deletedAt:t,key:`${e.drugsLibraryItem.key}_${e.drugsLibraryItemId}`}]}})))}await o.Z.delete(c.pendingDeletion).where((0,i.or)((0,i.K0)(c.pendingDeletion.drugsLibraryItemId),(0,i.K0)(c.pendingDeletion.drugsLibraryItemDraftId)));let s=[],r=[],a=await o.Z.query.drugsLibraryDrafts.findMany();if(s=a.filter(e=>e.itemId),r=a.filter(e=>!e.itemId),s.length){let e=[];for(let{itemId:t,data:r}of(s.filter(e=>e.itemId).length&&(e=await o.Z.query.drugsLibrary.findMany({where:(0,i.d3)(c.drugsLibrary.itemId,s.filter(e=>e.itemId).map(e=>e.itemId))})),s)){let{itemId:e,id:s,createdAt:a,updatedAt:n,deletedAt:d,...l}=r,p={...l,publishDate:new Date};await o.Z.update(c.drugsLibrary).set(p).where((0,i.eq)(c.drugsLibrary.itemId,t)).returning()}await v({drafts:s,previous:e})}if(r.length){let e=[];for(let{id:t,data:s}of(r.filter(e=>e.itemId).length&&(e=await o.Z.query.drugsLibrary.findMany({where:(0,i.d3)(c.drugsLibrary.itemId,r.filter(e=>e.itemId).map(e=>e.itemId))})),r)){let e=s.itemId||(0,n.Z)(),i={...s,itemId:e};r=r.map(s=>(s.id===t&&(s.data.itemId=e),s)),await o.Z.insert(c.drugsLibrary).values(i)}await v({drafts:r,previous:e})}await o.Z.delete(c.drugsLibraryDrafts);let d=[...s.map(e=>e.itemId),...e.map(e=>e.drugsLibraryItemId)];d.length&&await o.Z.update(c.drugsLibrary).set({version:(0,b.i6)`${c.drugsLibrary.version} + 1`}).where((0,i.d3)(c.drugsLibrary.itemId,d)),t.success=!0}catch(e){t.success=!1,t.errors=[e.message],d.Z.error("_publishDrugsLibraryItems ERROR",e.message)}finally{return t}}},10970:(e,t,s)=>{"use strict";s.d(t,{cF:()=>g,In:()=>u,VQ:()=>y,Bx:()=>h,GH:()=>f,Es:()=>I,gv:()=>q,Ry:()=>v,Ls:()=>L,Pk:()=>x,uD:()=>_,Or:()=>p});var r=s(57745),i=s(81445),a=s(9576),n=s(57435),d=s(10413),o=s(93567),c=s(88317);function l(e){if("string"==typeof e)return e.replace(/0x[0-9A-Fa-f]+/g,"");if(Array.isArray(e))return e.map(l);if("object"==typeof e&&null!==e){let t={};for(let s in e)e.hasOwnProperty(s)&&(t[s]=l(e[s]));return t}return e}async function p({data:e,broadcastAction:t,syncSilently:s}){let p={success:!1},u=[],f={};e=l(e);try{for(let{scriptId:t,...s}of e)try{let e=t||a.Z();if(!u.length){let a=t?await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,e)}):null,n=a||!t?null:await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,e)});if(a){let t={...a.data,...s},i=d.Z.update(o.scriptsDrafts).set({data:t,position:t.position,hospitalId:t.hospitalId}).where((0,r.eq)(o.scriptsDrafts.scriptDraftId,e));f.query=i.toSQL(),await i.execute()}else{let t=s.position||n?.position;if(!t){let e=await d.Z.query.scripts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.scripts.position)}),s=await d.Z.query.scriptsDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.scriptsDrafts.position)});t=Math.max(0,e?.position||0,s?.position||0)+1}let r={...n,...s,scriptId:e,version:n?.version?n.version+1:1,position:t},a=d.Z.insert(o.scriptsDrafts).values({data:r,scriptDraftId:e,position:r.position,hospitalId:r.hospitalId,scriptId:n?.scriptId});f.query=a.toSQL(),await a.execute()}}}catch(e){u.push(e.message)}u.length?(p.errors=u,p.info=f):p.success=!0}catch(e){p.success=!1,p.errors=[e.message],p.info=f,n.Z.error("_saveScripts ERROR",e.message)}finally{return p?.errors?.length||!t||s||c.Z.emit("data_changed","save_scripts"),p}}async function u(){try{return await d.Z.delete(o.screensDrafts),!0}catch(e){throw e}}async function f({screensIds:e=[],scriptsIds:t=[],confirmDeleteAll:s,broadcastAction:i}){let a={success:!1};try{if(!t.length&&!e.length&&!s)throw Error("You&apos;re about to delete all the screens, please confirm this action!");await d.Z.delete(o.screensDrafts).where((0,r.xD)(e.length?(0,r.d3)(o.screensDrafts.screenDraftId,e):void 0,t.length?(0,r.or)((0,r.d3)(o.screensDrafts.scriptId,t),(0,r.d3)(o.screensDrafts.scriptDraftId,t)):void 0));let i=await d.Z.select({screenId:o.screens.screenId,screenScriptId:o.screens.scriptId,scriptDraftId:o.scriptsDrafts.scriptDraftId,pendingDeletion:o.pendingDeletion}).from(o.screens).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.screenId,o.screens.screenId)).leftJoin(o.scriptsDrafts,(0,r.eq)(o.scriptsDrafts.scriptId,o.screens.scriptId)).where((0,r.xD)((0,r.Ft)(o.screens.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.screens.screenId,e):void 0,t.length?(0,r.d3)(o.screens.scriptId,t):void 0));i.length&&await d.Z.insert(o.pendingDeletion).values(i),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_deleteScreens ERROR",e.message)}finally{return!a?.errors?.length&&i&&c.Z.emit("data_changed","delete_screens"),a}}async function g(){try{return await d.Z.delete(o.diagnosesDrafts),!0}catch(e){throw e}}async function h({diagnosesIds:e=[],scriptsIds:t=[],confirmDeleteAll:s,broadcastAction:i}){let a={success:!1};try{if(!t.length&&!e.length&&!s)throw Error("You&apos;re about to delete all the diagnoses, please confirm this action!");await d.Z.delete(o.diagnosesDrafts).where((0,r.xD)(e.length?(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,e):void 0,t.length?(0,r.or)((0,r.d3)(o.diagnosesDrafts.scriptId,t),(0,r.d3)(o.diagnosesDrafts.scriptDraftId,t)):void 0));let i=await d.Z.select({diagnosisId:o.diagnoses.diagnosisId,diagnosisScriptId:o.diagnoses.scriptId,scriptDraftId:o.scriptsDrafts.scriptDraftId,pendingDeletion:o.pendingDeletion}).from(o.diagnoses).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.diagnosisId,o.diagnoses.diagnosisId)).leftJoin(o.scriptsDrafts,(0,r.eq)(o.scriptsDrafts.scriptId,o.diagnoses.scriptId)).where((0,r.xD)((0,r.Ft)(o.diagnoses.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.diagnoses.diagnosisId,e):void 0,t.length?(0,r.d3)(o.diagnoses.scriptId,t):void 0));i.length&&await d.Z.insert(o.pendingDeletion).values(i),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_deleteDiagnoses ERROR",e.message)}finally{return!a?.errors?.length&&i&&c.Z.emit("data_changed","delete_diagnoses"),a}}async function y(){try{return await d.Z.delete(o.scriptsDrafts),!0}catch(e){throw e}}async function I({scriptsIds:e=[],broadcastAction:t,confirmDeleteAll:s}){let i={success:!1};try{if(!e.length&&!s)throw Error("You&apos;re about to delete all the scripts, please confirm this action!");await d.Z.delete(o.scriptsDrafts).where((0,r.or)((0,r.d3)(o.scriptsDrafts.scriptId,e),(0,r.d3)(o.scriptsDrafts.scriptDraftId,e)));let t=await d.Z.select({scriptId:o.scripts.scriptId,pendingDeletion:o.pendingDeletion}).from(o.scripts).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.scriptId,o.scripts.scriptId)).where((0,r.xD)((0,r.Ft)(o.scripts.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.scripts.scriptId,e):void 0));t.length&&(await d.Z.insert(o.pendingDeletion).values(t.map(e=>({scriptId:e.scriptId}))),await f({scriptsIds:t.map(e=>e.scriptId)}),await h({scriptsIds:t.map(e=>e.scriptId)})),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_deleteScripts ERROR",e.message)}finally{return!i?.errors?.length&&t&&c.Z.emit("data_changed","delete_scripts"),i}}var w=s(34149);async function m({previous:e,drafts:t}){try{let s=[];for(let r of t){let t={version:r?.data?.version||1,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)t.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let s=e.filter(e=>e.scriptId===r?.data?.scriptId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(r.data[e]),n={...s}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_script",description:"Update script",oldValues:i,newValues:a}}s.push(t)}await d.Z.insert(o.scriptsHistory).values(s)}catch(e){n.Z.error(e.message)}}async function D({previous:e,drafts:t}){try{let s=[];for(let r of t){let t={version:r?.data?.version||1,screenId:r?.data?.screenId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)t.changes={action:"create_screen",description:"Create screen",oldValues:[],newValues:[]};else{let s=e.filter(e=>e.screenId===r?.data?.screenId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(r.data[e]),n={...s}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_screen",description:"Update screen",oldValues:i,newValues:a}}s.push(t)}await d.Z.insert(o.screensHistory).values(s)}catch(e){n.Z.error(e.message)}}var Z=s(54491);async function v(e){let{scriptsIds:t,screensIds:s}={...e},i={success:!1};try{let e=[],n=[];if(t?.length||s?.length){let i=await d.Z.query.screensDrafts.findMany({where:(0,r.or)(t?.length?(0,r.d3)(o.screensDrafts.scriptId,t):void 0,t?.length?(0,r.d3)(o.screensDrafts.scriptDraftId,t):void 0,s?.length?(0,r.d3)(o.screensDrafts.screenId,s):void 0,s?.length?(0,r.d3)(o.screensDrafts.screenDraftId,s):void 0)});e=i.filter(e=>e.screenId),n=i.filter(e=>!e.screenId)}else{let t=await d.Z.query.screensDrafts.findMany({where:(0,r.K0)(o.screensDrafts.scriptId)});e=t.filter(e=>e.screenId),n=t.filter(e=>!e.screenId)}if(e.length){let t=[];for(let{screenId:s,data:i}of(e.filter(e=>e.screenId).length&&(t=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,e.filter(e=>e.screenId).map(e=>e.screenId))})),e)){let{screenId:e,id:t,oldScreenId:a,createdAt:n,updatedAt:c,deletedAt:l,...p}=i,u={...p,publishDate:new Date};await d.Z.update(o.screens).set(u).where((0,r.eq)(o.screens.screenId,s)).returning()}await D({drafts:e,previous:t})}if(n.length){let e=[];for(let{id:t,scriptId:s,scriptDraftId:i,data:c}of(n.filter(e=>e.screenId).length&&(e=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,n.filter(e=>e.screenId).map(e=>e.screenId))})),n)){let e=c.screenId||(0,a.Z)(),r=c.scriptId||s||i,l={...c,screenId:e,scriptId:r};n=n.map(s=>(s.id===t&&(s.data.screenId=e),s)),await d.Z.insert(o.screens).values(l)}await D({drafts:n,previous:e})}await d.Z.delete(o.screensDrafts);let c=await d.Z.query.pendingDeletion.findMany({where:(0,r.K0)(o.pendingDeletion.screenId),columns:{screenId:!0},with:{screen:{columns:{version:!0,scriptId:!0}}}});if((c=c.filter(e=>e.screen)).length){let e=new Date;await d.Z.update(o.screens).set({deletedAt:e}).where((0,r.d3)(o.screens.screenId,c.map(e=>e.screenId))),await d.Z.insert(o.screensHistory).values(c.map(t=>({version:t.screen.version,screenId:t.screenId,scriptId:t.screen.scriptId,changes:{action:"delete_screen",description:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.or)((0,r.K0)(o.pendingDeletion.screenId),(0,r.K0)(o.pendingDeletion.screenDraftId)));let l=[...e.map(e=>e.screenId),...c.map(e=>e.screenId)],p=Array.from(new Set((e??[]).map(e=>e.scriptId).filter(e=>!!e)));p.length&&await (0,Z.uW)(p),l.length&&await d.Z.update(o.screens).set({version:(0,w.i6)`${o.screens.version} + 1`}).where((0,r.d3)(o.screens.screenId,l)),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishScreens ERROR",e)}finally{return i}}async function b({previous:e,drafts:t}){try{let s=[];for(let r of t){let t={version:r?.data?.version||1,diagnosisId:r?.data?.diagnosisId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)t.changes={action:"create_diagnosis",description:"Create diagnosis",oldValues:[],newValues:[]};else{let s=e.filter(e=>e.diagnosisId===r?.data?.diagnosisId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(r.data[e]),n={...s}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_diagnosis",description:"Update diagnosis",oldValues:i,newValues:a}}s.push(t)}await d.Z.insert(o.diagnosesHistory).values(s)}catch(e){n.Z.error(e.message)}}async function q(e){let{scriptsIds:t,diagnosesIds:s}={...e},i={success:!1};try{let e=[],n=[];if(t?.length||s?.length){let i=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.or)(t?.length?(0,r.d3)(o.diagnosesDrafts.scriptId,t):void 0,t?.length?(0,r.d3)(o.diagnosesDrafts.scriptDraftId,t):void 0,s?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisId,s):void 0,s?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,s):void 0)});e=i.filter(e=>e.diagnosisId),n=i.filter(e=>!e.diagnosisId)}else{let t=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.K0)(o.diagnosesDrafts.scriptId)});e=t.filter(e=>e.diagnosisId),n=t.filter(e=>!e.diagnosisId)}if(e.length){let t=[];for(let{diagnosisId:s,data:i}of(e.filter(e=>e.diagnosisId).length&&(t=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,e.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),e)){let{diagnosisId:e,id:t,oldDiagnosisId:a,createdAt:n,updatedAt:c,deletedAt:l,...p}=i,u={...p,publishDate:new Date};await d.Z.update(o.diagnoses).set(u).where((0,r.eq)(o.diagnoses.diagnosisId,s)).returning()}await b({drafts:e,previous:t})}if(n.length){let e=[];for(let{id:t,scriptId:s,scriptDraftId:i,data:c}of(n.filter(e=>e.diagnosisId).length&&(e=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,n.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),n)){let e=c.diagnosisId||(0,a.Z)(),r=c.scriptId||s||i,l={...c,diagnosisId:e,scriptId:r};n=n.map(s=>(s.id===t&&(s.data.diagnosisId=e),s)),await d.Z.insert(o.diagnoses).values(l)}await b({drafts:n,previous:e})}await d.Z.delete(o.diagnosesDrafts);let c=await d.Z.query.pendingDeletion.findMany({where:(0,r.K0)(o.pendingDeletion.diagnosisId),columns:{diagnosisId:!0},with:{diagnosis:{columns:{version:!0,scriptId:!0}}}});if((c=c.filter(e=>e.diagnosis)).length){let e=new Date;await d.Z.update(o.diagnoses).set({deletedAt:e}).where((0,r.d3)(o.diagnoses.diagnosisId,c.map(e=>e.diagnosisId))),await d.Z.insert(o.diagnosesHistory).values(c.map(t=>({version:t.diagnosis.version,diagnosisId:t.diagnosisId,scriptId:t.diagnosis.scriptId,changes:{action:"delete_diagnosis",description:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.or)((0,r.K0)(o.pendingDeletion.diagnosisId),(0,r.K0)(o.pendingDeletion.diagnosisDraftId)));let l=[...e.map(e=>e.diagnosisId),...c.map(e=>e.diagnosisId)];l.length&&await d.Z.update(o.diagnoses).set({version:(0,w.i6)`${o.diagnoses.version} + 1`}).where((0,r.d3)(o.diagnoses.diagnosisId,l)),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishDiagnoses ERROR",e)}finally{return i}}async function L(){let e={success:!1};try{let t=await d.Z.query.scriptsDrafts.findMany(),s=t.filter(e=>!e.scriptId).map(e=>({...e,scriptId:e.data.scriptId||(0,a.Z)(),data:{...e.data,scriptId:e.data.scriptId||(0,a.Z)()}})),i=t.filter(e=>e.scriptId);[...s.map(e=>e.scriptId),...i.map(e=>e.scriptId)];let n=[];if(i.length){let e=[];for(let{scriptId:t,data:s}of(i.filter(e=>e.scriptId).length&&(e=await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,i.filter(e=>e.scriptId).map(e=>e.scriptId))})),i)){let{scriptId:e,id:i,oldScriptId:a,createdAt:c,updatedAt:l,deletedAt:p,...u}=s,f={...u,publishDate:new Date};await d.Z.update(o.scripts).set(f).where((0,r.eq)(o.scripts.scriptId,t)),n.push({scriptId:t})}await m({drafts:i,previous:e})}if(s.length){s.filter(e=>e.scriptId).length&&await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,s.filter(e=>e.scriptId).map(e=>e.scriptId))});let e=s.map(e=>({...e.data,scriptId:e.scriptDraftId}));for(let{scriptId:t}of(await d.Z.insert(o.scripts).values(e),e))n.push({scriptId:t}),await d.Z.update(o.screensDrafts).set({scriptId:t}).where((0,r.or)((0,r.eq)(o.screensDrafts.scriptId,t),(0,r.eq)(o.screensDrafts.scriptDraftId,t))),await d.Z.update(o.diagnosesDrafts).set({scriptId:t}).where((0,r.or)((0,r.eq)(o.diagnosesDrafts.scriptId,t),(0,r.eq)(o.diagnosesDrafts.scriptDraftId,t)))}if(n.length){let e=await v({scriptsIds:n.map(e=>e.scriptId)});if(e.errors)throw Error(e.errors.join(", "));let t=await q({scriptsIds:n.map(e=>e.scriptId)});if(t.errors)throw Error(t.errors.join(", "))}let c=await d.Z.query.pendingDeletion.findMany({where:(0,r.K0)(o.pendingDeletion.scriptId),columns:{scriptId:!0},with:{script:{columns:{version:!0}}}});if(await d.Z.delete(o.scriptsDrafts),(c=c.filter(e=>e.script)).length){let e=new Date;await d.Z.update(o.scripts).set({deletedAt:e}).where((0,r.d3)(o.scripts.scriptId,c.map(e=>e.scriptId))),await d.Z.insert(o.scriptsHistory).values(c.map(t=>({version:t.script.version,scriptId:t.scriptId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.or)((0,r.K0)(o.pendingDeletion.scriptId),(0,r.K0)(o.pendingDeletion.scriptDraftId)));let l=[...i.map(e=>e.scriptId),...c.map(e=>e.scriptId)];l.length&&await d.Z.update(o.scripts).set({version:(0,w.i6)`${o.scripts.version} + 1`}).where((0,r.d3)(o.scripts.scriptId,l)),e.success=!0}catch(t){e.success=!1,e.errors=[t.message],n.Z.error("_publishScripts ERROR",t.message)}finally{return e}}async function _({data:e,broadcastAction:t}){let s={success:!1};e=l(e);let p=[],u={};try{let t=0;for(let{screenId:s,...n}of e)try{t++;let e=s||a.Z();if(!p.length){let a=s?await d.Z.query.screensDrafts.findFirst({where:(0,r.eq)(o.screensDrafts.screenDraftId,e)}):null,c=a||!s?null:await d.Z.query.screens.findFirst({where:(0,r.eq)(o.screens.screenId,e)});if(a){let t={...a.data,...n},s=d.Z.update(o.screensDrafts).set({data:t,position:t.position}).where((0,r.eq)(o.screensDrafts.screenDraftId,e));u.query=s.toSQL(),await s.execute()}else{let s=n.position||c?.position;if(!s){let e=await d.Z.query.screens.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.screens.position)}),t=await d.Z.query.screensDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.screensDrafts.position)});s=Math.max(0,e?.position||0,t?.position||0)+1}let a={...c,...n,screenId:e,version:c?.version?c.version+1:1,position:s};if(a.scriptId){let s=await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,a.scriptId),columns:{scriptDraftId:!0}}),i=await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,a.scriptId),columns:{scriptId:!0}});if(s||i){let t=d.Z.insert(o.screensDrafts).values({data:a,type:a.type,scriptId:i?.scriptId,scriptDraftId:s?.scriptDraftId,screenDraftId:e,position:a.position,screenId:c?.screenId});u.query=t.toSQL(),await t.execute()}else p.push(`Could not save screen ${t}: ${a.title}, because script was not found`)}else p.push(`Could not save screen ${t}: ${a.title}, because scriptId was not specified`)}}}catch(e){p.push(e.message)}p.length?(s.errors=p,s.info=u):s.success=!0}catch(e){s.success=!1,s.errors=[e.message],s.info=u,n.Z.error("_saveScreens ERROR",e.message)}finally{return!s?.errors?.length&&t&&c.Z.emit("data_changed","save_screens"),s}}async function x({data:e,broadcastAction:t,syncSilently:s}){let p={success:!1};e=l(e);let u=[],f={};try{let t=0;for(let{diagnosisId:s,...c}of e)try{t++;let e=s||a.Z();if(!u.length){let a=d.Z.query.diagnosesDrafts.findFirst({where:(0,r.eq)(o.diagnosesDrafts.diagnosisDraftId,e)});f[`${e} - getDiagnosisDraftQuery`]=a.toSQL();let n=s?await a.execute():null,l=d.Z.query.diagnoses.findFirst({where:(0,r.eq)(o.diagnoses.diagnosisId,e)});f[`${e} - getPublishedDiagnosisQuery`]=l.toSQL();let p=n||!s?null:await l.execute();if(n){let t={...n.data,...c},s=d.Z.update(o.diagnosesDrafts).set({data:t,position:t.position}).where((0,r.eq)(o.diagnosesDrafts.diagnosisDraftId,e));f[`${e} - updateDiagnosisDraft`]=s.toSQL(),await s.execute()}else{let s=c.position||p?.position;if(!s){let e=await d.Z.query.diagnoses.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.diagnoses.position)}),t=await d.Z.query.diagnosesDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.diagnosesDrafts.position)});s=Math.max(0,e?.position||0,t?.position||0)+1}let a={...p,...c,diagnosisId:e,version:p?.version?p.version+1:1,position:s};if(a.scriptId){let s=await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,a.scriptId),columns:{scriptDraftId:!0}}),i=await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,a.scriptId),columns:{scriptId:!0}});if(s||i){let t=d.Z.insert(o.diagnosesDrafts).values({data:a,scriptId:i?.scriptId,scriptDraftId:s?.scriptDraftId,diagnosisDraftId:e,position:a.position,diagnosisId:p?.diagnosisId});f[`${e} - createDiagnosisDraft`]=t.toSQL(),await t.execute()}else u.push(`Could not save diagnosis ${t}: ${a.name}, because script was not found`)}else u.push(`Could not save diagnosis ${t}: ${a.name}, because scriptId was not specified`)}}}catch(e){u.push(e.message),n.Z.error("saveDiagnosis SQL (FAILED)",JSON.stringify(f))}u.length?p.errors=u:p.success=!0}catch(e){p.success=!1,p.errors=[e.message],n.Z.error("_saveDiagnoses ERROR",e.message)}finally{return p?.errors?.length||!t||s||c.Z.emit("data_changed","save_diagnoses"),p}}},20123:(e,t,s)=>{"use strict";s.d(t,{Ng:()=>l,_U:()=>g,QF:()=>c,YF:()=>f});var r=s(57745),i=s(81445),a=s(30900),n=s(10413),d=s(93567),o=s(57435);async function c(e){try{let{sitesIds:t,types:s=[],envs:o=[],links:c=[]}={...e},l=t||[],p=l?.length?(0,r.d3)(d.sites.siteId,l.filter(e=>a.Z(e))):void 0;c.length&&[...c].forEach(e=>{c.push(e.replace("http:","https:")),c.push(e.replace("https","http"))});let u=[(0,r.Ft)(d.sites.deletedAt),p,s.length?(0,r.d3)(d.sites.type,s):void 0,o.length?(0,r.d3)(d.sites.env,o):void 0,c.length?(0,r.d3)(d.sites.link,c):void 0];return{data:(await n.Z.select({site:d.sites}).from(d.sites).where(u.length?(0,r.xD)(...u):void 0).orderBy((0,i.d)(d.sites.id))).map(e=>e.site)}}catch(e){return o.Z.error("_getSites ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{siteId:t}={...e};try{if(!t)throw Error("Missing siteId");let e=a.Z(t)?(0,r.eq)(d.sites.siteId,t):void 0;return{data:await n.Z.query.sites.findFirst({where:(0,r.xD)((0,r.Ft)(d.sites.deletedAt),e)})}}catch(e){return o.Z.error("_getSite ERROR",e.message),{errors:[e.message]}}}var p=s(8328);let u=()=>{let e=(0,p.w)();return{webeditor:{name:"Local editor",siteId:"fb76af5a-bf86-4050-821e-44f1bf316bf4",link:e.origin,type:"webeditor",apiKey:"localhost"},nodeapi:{name:"Local editor",siteId:"5cb4aa54-2cfe-49e2-9cdd-392a9b8c124e",link:e.origin,type:"webeditor",apiKey:"localhost"}}};async function f(e){try{let{types:t=[]}={...e},s=[...t.length?[(0,r.d3)(d.sites.type,t)]:[]],i=await n.Z.query.sites.findMany({where:s.length?(0,r.xD)(...s):void 0,columns:{siteId:!0,type:!0,name:!0,link:!0}});return u(),{data:[...i]}}catch(e){return o.Z.error("_getSites ERROR",e.message),{data:[],errors:[e.message]}}}async function g(e){try{let t=await n.Z.query.sites.findFirst({where:(0,r.eq)(d.sites.siteId,e),columns:{apiKey:!0,link:!0}}),s=t||null;if(!t){let t=u();Object.values(t).forEach(t=>{t.siteId===e&&(s={link:t.link,apiKey:t.apiKey})})}return{data:s}}catch(e){return o.Z.error("_getSiteApiKey ERROR",e.message),{data:null,errors:[e.message]}}}},8328:(e,t,s)=>{"use strict";s.d(t,{w:()=>i});var r=s(71615);function i(){let e=(0,r.headers)(),t=e.get("x-api-key"),s=e.get("x-bearer-token"),i=e.get("x-url"),a=e.get("x-next-url-host"),n=e.get("x-next-url-href"),d=e.get("x-next-url-port"),o=e.get("x-next-url-hostname"),c=e.get("x-next-url-pathname"),l=e.get("x-next-url-search"),p=e.get("x-next-url-protocol"),u=e.get("x-next-url-username"),f=e.get("x-next-url-locale"),g=e.get("x-next-url-origin"),h=e.get("x-geo-city"),y=e.get("x-geo-country");return{apiKey:t,bearerToken:s,url:i||"",host:a||"",href:n||"",port:d||"",hostname:o||"",pathname:c||"",search:l||"",protocol:p||"",username:u||"",locale:f||"",origin:g||"",city:h||"",country:y||"",region:e.get("x-geo-region")||"",latitude:e.get("x-geo-latitude")||"",longitude:e.get("x-geo-longitude")||""}}},5286:(e,t,s)=>{"use strict";s.d(t,{U:()=>n});var r=s(29712),i=s(57435),a=s(20123);async function n(e,t){let s=t?.link,n=t?.baseURL;if(!e)throw Error("AXIOS init error: missing siteId");if(!t){let t=await (0,a._U)(e);if(t.errors?.length)throw Error("AXIOS init error: "+t.errors.join(", "));if(!t.data)throw Error("AXIOS init error: site not found");s=t.data.link,n=t.data.apiKey}let d=r.Z.create({baseURL:s});return d.interceptors.request.use(async e=>(e.headers&&(e.headers["x-api-key"]=n),i.Z.log(`AXIOS [${e.method}]`,[`${s}/api`,e.url].join("")),e)),d.interceptors.response.use(e=>e,e=>new Promise((t,s)=>s(e))),d}},88317:(e,t,s)=>{"use strict";s.d(t,{Z:()=>r});let r=(0,s(94901).io)(process.env.NEXT_PUBLIC_APP_URL)}};