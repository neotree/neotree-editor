"use strict";exports.id=2418,exports.ids=[2418],exports.modules={22418:(e,r,t)=>{t.d(r,{U5:()=>p,Ms:()=>w,Nq:()=>L,hA:()=>Z,E8:()=>m,$s:()=>b,cj:()=>h,Lr:()=>I});var i=t(60938),a=t(57745),s=t(81445),d=t(9576),n=t(57435),u=t(10413),l=t(93567),o=t(88317),y=t(30834),g=t(10970),f=t(927);async function m({keys:e}){try{let r=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),t=[];return r.data.forEach(r=>{let i=r.drugs.filter(r=>!e.includes(r.key)),a=r.fluids.filter(r=>!e.includes(r.key)),s=r.feeds.filter(r=>!e.includes(r.key));i.length!==r.drugs.length&&t.push({...r,drugs:i}),a.length!==r.fluids.length&&t.push({...r,fluids:a}),s.length!==r.feeds.length&&t.push({...r,feeds:s})}),t.length&&await (0,g.uD)({data:t}),{data:{success:!0}}}catch(e){return{errors:[e.message],data:{success:!1}}}}let c=async(e,r=1,t="")=>{let[{count:s}]=await u.Z.select({count:(0,i.QX)()}).from(l.drugsLibraryDrafts).where((0,a.eq)(l.drugsLibraryDrafts.key,e)),[{count:d}]=await u.Z.select({count:(0,i.QX)()}).from(l.drugsLibrary).where((0,a.eq)(l.drugsLibrary.key,e));return d||s?await c(`${t||e}-${r+1}`,r+1,t||e):e};async function p({data:e,...r}){try{let{data:t}=await (0,y.fP)({itemsIds:e.map(e=>e.itemId)}),i=[];for(let e of t){let r=await c(e.key);i.push({...e,key:r,itemId:d.Z(),position:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0})}return await b({data:i,...r})}catch(e){return n.Z.error("_copyDrugsLibraryItems ERROR",e.message),{success:!1,errors:[e.message]}}}async function h({data:e,broadcastAction:r}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let i=await (0,y.fP)({keys:t});if((e=e.filter(e=>!i.data.map(e=>e.key).includes(e.key)).map(e=>({...e,itemId:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0,position:void 0,version:void 0}))).length)return await b({data:e,broadcastAction:r})}return{success:!0}}catch(e){return n.Z.error("_saveDrugsLibraryItemsIfKeysNotExist ERROR",e.message),{errors:[e.message],success:!1}}}async function I({data:e,broadcastAction:r}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let i=await (0,y.fP)({keys:t});if((e=e.map(e=>{let r=i.data.find(r=>`${r.key}`.toLowerCase()===`${e.key}`.toLowerCase());return{...e,itemId:r?.itemId||e.itemId,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:r?.id||e.id,position:r?.position||e.position,version:r?.version||e.version}})).length)return await b({data:e,broadcastAction:r})}return{success:!0}}catch(e){return n.Z.error("_saveDrugsLibraryItemsAndUpdateIfExists ERROR",e.message),{errors:[e.message],success:!1}}}async function b({data:e,broadcastAction:r}){let t={success:!1};try{let r=[],i=[],n=[];for(let{itemId:t,...o}of e)try{let e=t||d.Z(),y="",g=o.key||"",f=null,m=o.type||null;if(!r.length){let r=t?await u.Z.query.drugsLibraryDrafts.findFirst({where:(0,a.eq)(l.drugsLibraryDrafts.itemDraftId,e)}):null,d=r||!t?null:await u.Z.query.drugsLibrary.findFirst({where:(0,a.eq)(l.drugsLibrary.itemId,e)});if(r){y=r.data.key,f=r.data.type||null;let t={...r.data,...o};await u.Z.update(l.drugsLibraryDrafts).set({data:t,position:t.position}).where((0,a.eq)(l.drugsLibraryDrafts.itemDraftId,e))}else{y=d?.key||"",f=d?.type||null;let r=o.position||d?.position;if(!r){let e=await u.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,s.C)(l.drugsLibrary.position)}),t=await u.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,s.C)(l.drugsLibraryDrafts.position)});r=Math.max(0,e?.position||0,t?.position||0)+1}let t={...d,...o,itemId:e,version:d?.version?d.version+1:1,position:r};await u.Z.insert(l.drugsLibraryDrafts).values({data:t,itemDraftId:e,position:t.position,itemId:d?.itemId,key:t.key,type:t.type})}y&&g&&y!==g&&i.push({old:y,new:g}),f&&m&&f!==m&&y&&n.push(y)}}catch(e){r.push(e.message)}if(n.length&&await m({keys:n}),i.length){let e=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),r=[];e.data.forEach(e=>{let t=!1,a=e.drugs.map(e=>{if(i.map(e=>e.old).includes(e.key)){let r=i.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e}),s=e.fluids.map(e=>{if(i.map(e=>e.old).includes(e.key)){let r=i.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e}),d=e.feeds.map(e=>{if(i.map(e=>e.old).includes(e.key)){let r=i.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e});t&&r.push({...e,drugs:a,fluids:s,feeds:d})}),r.length&&await (0,g.uD)({data:r})}r.length?t.errors=r:t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!t?.errors?.length&&r&&o.Z.emit("data_changed","save_drugs_library_items"),t}}async function w(){try{return await u.Z.delete(l.drugsLibraryDrafts),!0}catch(e){throw e}}async function L({itemsIds:e,broadcastAction:r}){let t={success:!1};try{let r=e||[];if(r.length){let e=await (0,y.fP)({itemsIds:r,returnDraftsIfExist:!0});await u.Z.delete(l.drugsLibraryDrafts).where((0,a.d3)(l.drugsLibraryDrafts.itemDraftId,r));let t=e.data.filter(e=>!e.isDraft).map(e=>({drugsLibraryItemId:e.itemId}));t.length&&await u.Z.insert(l.pendingDeletion).values(t),await m({keys:e.data.map(e=>e.key)})}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!t?.errors?.length&&r&&o.Z.emit("data_changed","delete_drugs_library_items"),t}}async function v({previous:e,drafts:r}){try{let t=[];for(let i of r){let r={version:i?.data?.version||1,itemId:i?.data?.itemId,changes:{}};if(i?.data?.version===1)r.changes={action:"create_drugs_library_item",description:"Create drugs library item",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.itemId===i?.data?.itemId)[0],a=[],s=[];Object.keys({...i?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let r=i.data[e],d={...t}[e];JSON.stringify(r)!==JSON.stringify(d)&&(a.push({[e]:d}),s.push({[e]:r}))}),r.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:a,newValues:s}}t.push(r)}await u.Z.insert(l.drugsLibraryHistory).values(t)}catch(e){n.Z.error(e.message)}}var D=t(34149);async function Z(e){let r={success:!1};try{let e=await u.Z.query.pendingDeletion.findMany({where:(0,a.K0)(l.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0,key:!0}}}});if((e=e.filter(e=>e.drugsLibraryItem)).length){let r=new Date;await u.Z.update(l.drugsLibrary).set({deletedAt:r,key:(0,D.i6)`CONCAT(${l.drugsLibrary.key}, '_', ${l.drugsLibrary.itemId})`}).where((0,a.d3)(l.drugsLibrary.itemId,e.map(e=>e.drugsLibraryItemId))),await u.Z.insert(l.drugsLibraryHistory).values(e.map(e=>({version:e.drugsLibraryItem.version,itemId:e.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null,key:e.drugsLibraryItem.key}],newValues:[{deletedAt:r,key:`${e.drugsLibraryItem.key}_${e.drugsLibraryItemId}`}]}})))}await u.Z.delete(l.pendingDeletion).where((0,a.or)((0,a.K0)(l.pendingDeletion.drugsLibraryItemId),(0,a.K0)(l.pendingDeletion.drugsLibraryItemDraftId)));let t=[],i=[],s=await u.Z.query.drugsLibraryDrafts.findMany();if(t=s.filter(e=>e.itemId),i=s.filter(e=>!e.itemId),t.length){let e=[];for(let{itemId:r,data:i}of(t.filter(e=>e.itemId).length&&(e=await u.Z.query.drugsLibrary.findMany({where:(0,a.d3)(l.drugsLibrary.itemId,t.filter(e=>e.itemId).map(e=>e.itemId))})),t)){let{itemId:e,id:t,createdAt:s,updatedAt:d,deletedAt:n,...o}=i,y={...o,publishDate:new Date};await u.Z.update(l.drugsLibrary).set(y).where((0,a.eq)(l.drugsLibrary.itemId,r)).returning()}await v({drafts:t,previous:e})}if(i.length){let e=[];for(let{id:r,data:t}of(i.filter(e=>e.itemId).length&&(e=await u.Z.query.drugsLibrary.findMany({where:(0,a.d3)(l.drugsLibrary.itemId,i.filter(e=>e.itemId).map(e=>e.itemId))})),i)){let e=t.itemId||(0,d.Z)(),a={...t,itemId:e};i=i.map(t=>(t.id===r&&(t.data.itemId=e),t)),await u.Z.insert(l.drugsLibrary).values(a)}await v({drafts:i,previous:e})}await u.Z.delete(l.drugsLibraryDrafts);let n=[...t.map(e=>e.itemId),...e.map(e=>e.drugsLibraryItemId)];n.length&&await u.Z.update(l.drugsLibrary).set({version:(0,D.i6)`${l.drugsLibrary.version} + 1`}).where((0,a.d3)(l.drugsLibrary.itemId,n)),r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_publishDrugsLibraryItems ERROR",e.message)}finally{return r}}}};