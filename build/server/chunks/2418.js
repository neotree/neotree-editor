"use strict";exports.id=2418,exports.ids=[2418],exports.modules={22418:(e,r,t)=>{t.d(r,{U5:()=>I,Ms:()=>w,Nq:()=>L,hA:()=>_,E8:()=>c,$s:()=>b,cj:()=>p,Lr:()=>h});var i=t(60938),s=t(57745),a=t(81445),d=t(9576),n=t(57435),u=t(10413),l=t(93567),o=t(88317),y=t(88781),g=t(45241),f=t(21162);async function c({keys:e,userId:r}){try{let t=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),i=[];return t.data.forEach(r=>{let t=r.drugs.filter(r=>!e.includes(r.key)),s=r.fluids.filter(r=>!e.includes(r.key)),a=r.feeds.filter(r=>!e.includes(r.key));t.length!==r.drugs.length&&i.push({...r,drugs:t}),s.length!==r.fluids.length&&i.push({...r,fluids:s}),a.length!==r.feeds.length&&i.push({...r,feeds:a})}),i.length&&await (0,g.uD)({data:i,userId:r}),{data:{success:!0}}}catch(e){return{errors:[e.message],data:{success:!1}}}}let m=async(e,r=1,t="")=>{let[{count:a}]=await u.Z.select({count:(0,i.QX)()}).from(l.drugsLibraryDrafts).where((0,s.eq)(l.drugsLibraryDrafts.key,e)),[{count:d}]=await u.Z.select({count:(0,i.QX)()}).from(l.drugsLibrary).where((0,s.eq)(l.drugsLibrary.key,e));return d||a?await m(`${t||e}-${r+1}`,r+1,t||e):e};async function I({data:e,...r}){try{let{data:t}=await (0,y.fP)({itemsIds:e.map(e=>e.itemId)}),i=[];for(let e of t){let r=await m(e.key);i.push({...e,key:r,itemId:d.Z(),position:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0})}return await b({data:i,...r})}catch(e){return n.Z.error("_copyDrugsLibraryItems ERROR",e.message),{success:!1,errors:[e.message]}}}async function p({data:e,...r}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let i=await (0,y.fP)({keys:t});if((e=e.filter(e=>!i.data.map(e=>e.key).includes(e.key)).map(e=>({...e,itemId:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0,position:void 0,version:void 0}))).length)return await b({data:e,...r})}return{success:!0}}catch(e){return n.Z.error("_saveDrugsLibraryItemsIfKeysNotExist ERROR",e.message),{errors:[e.message],success:!1}}}async function h({data:e,...r}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let i=await (0,y.fP)({keys:t});if((e=e.map(e=>{let r=i.data.find(r=>`${r.key}`.toLowerCase()===`${e.key}`.toLowerCase());return{...e,itemId:r?.itemId||e.itemId,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:r?.id||e.id,position:r?.position||e.position,version:r?.version||e.version}})).length)return await b({data:e,...r})}return{success:!0}}catch(e){return n.Z.error("_saveDrugsLibraryItemsAndUpdateIfExists ERROR",e.message),{errors:[e.message],success:!1}}}async function b({data:e,broadcastAction:r,userId:t}){let i={success:!1};try{let r=[],n=[],o=[];for(let{itemId:i,...y}of e)try{let e=i||d.Z(),g="",f=y.key||"",c=null,m=y.type||null;if(!r.length){let r=i?await u.Z.query.drugsLibraryDrafts.findFirst({where:(0,s.eq)(l.drugsLibraryDrafts.itemDraftId,e)}):null,d=r||!i?null:await u.Z.query.drugsLibrary.findFirst({where:(0,s.eq)(l.drugsLibrary.itemId,e)});if(r){g=r.data.key,c=r.data.type||null;let t={...r.data,...y};await u.Z.update(l.drugsLibraryDrafts).set({data:t,position:t.position}).where((0,s.eq)(l.drugsLibraryDrafts.itemDraftId,e))}else{g=d?.key||"",c=d?.type||null;let r=y.position||d?.position;if(!r){let e=await u.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,a.C)(l.drugsLibrary.position)}),t=await u.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,a.C)(l.drugsLibraryDrafts.position)});r=Math.max(0,e?.position||0,t?.position||0)+1}let i={...d,...y,itemId:e,version:d?.version?d.version+1:1,position:r};await u.Z.insert(l.drugsLibraryDrafts).values({data:i,itemDraftId:e,position:i.position,itemId:d?.itemId,key:i.key,type:i.type,createdByUserId:t})}g&&f&&g!==f&&n.push({old:g,new:f}),c&&m&&c!==m&&g&&o.push(g)}}catch(e){r.push(e.message)}if(o.length&&await c({keys:o,userId:t}),n.length){let e=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),r=[];e.data.forEach(e=>{let t=!1,i=e.drugs.map(e=>{if(n.map(e=>e.old).includes(e.key)){let r=n.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e}),s=e.fluids.map(e=>{if(n.map(e=>e.old).includes(e.key)){let r=n.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e}),a=e.feeds.map(e=>{if(n.map(e=>e.old).includes(e.key)){let r=n.filter(r=>r.old===e.key).map(e=>e.new)[0];e={...e,key:r},t=!0}return e});t&&r.push({...e,drugs:i,fluids:s,feeds:a})}),r.length&&await (0,g.uD)({data:r,userId:t})}r.length?i.errors=r:i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!i?.errors?.length&&r&&o.Z.emit("data_changed","save_drugs_library_items"),i}}async function w(e){try{return await u.Z.delete(l.drugsLibraryDrafts).where(e?.userId?(0,s.eq)(l.drugsLibraryDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function L({itemsIds:e,broadcastAction:r,userId:t}){let i={success:!1};try{let r=e||[];if(r.length){let e=await (0,y.fP)({itemsIds:r,returnDraftsIfExist:!0});await u.Z.delete(l.drugsLibraryDrafts).where((0,s.d3)(l.drugsLibraryDrafts.itemDraftId,r));let i=e.data.filter(e=>!e.isDraft).map(e=>({drugsLibraryItemId:e.itemId,createdByUserId:t}));i.length&&await u.Z.insert(l.pendingDeletion).values(i),await c({keys:e.data.map(e=>e.key),userId:t})}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!i?.errors?.length&&r&&o.Z.emit("data_changed","delete_drugs_library_items"),i}}async function v({previous:e,drafts:r,userId:t}){let i=[];try{let s=[];for(let a of r){let r=a?.data?.itemId;if(!r)continue;let d=1===(a?.data?.version||1),n=d?"Create drugs library item":"Update drugs library item",u={action:d?"create_drugs_library_item":"update_drugs_library_item",description:n,oldValues:[],newValues:[]},l=a?.data?.version||1,o={version:l,itemId:r,changes:u};if(!d){let t=e.find(e=>e.itemId===r);Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let r=a.data[e],i={...t}[e];JSON.stringify(r)!==JSON.stringify(i)&&(u.oldValues.push({[e]:i}),u.newValues.push({[e]:r}))})}if(s.push(o),t){let s=JSON.parse(JSON.stringify(a.data||{})),o=d?{}:JSON.parse(JSON.stringify(e.find(e=>e.itemId===r)||{}));i.push({entityId:r,entityType:"drugs_library",action:d?"create":"update",version:l,changes:u,fullSnapshot:s,previousSnapshot:o,baselineSnapshot:o,description:n,userId:t,drugsLibraryItemId:r})}}s.length&&await u.Z.insert(l.drugsLibraryHistory).values(s)}catch(e){n.Z.error(e.message)}return i}var D=t(34149),Z=t(36864),k=t(66776);async function _(e){let r={success:!1},t=[];try{let i=await u.Z.query.pendingDeletion.findMany({where:(0,s.xD)((0,s.K0)(l.pendingDeletion.drugsLibraryItemId),e?.userId?(0,s.eq)(l.pendingDeletion.createdByUserId,e.userId):void 0),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:!0}});if((i=i.filter(e=>e.drugsLibraryItem)).length){let r=new Date;await u.Z.update(l.drugsLibrary).set({deletedAt:r,key:(0,D.i6)`CONCAT(${l.drugsLibrary.key}, '_', ${l.drugsLibrary.itemId})`}).where((0,s.d3)(l.drugsLibrary.itemId,i.map(e=>e.drugsLibraryItemId)));let a=i.map(e=>({version:e.drugsLibraryItem.version,itemId:e.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null,key:e.drugsLibraryItem.key}],newValues:[{deletedAt:r,key:`${e.drugsLibraryItem.key}_${e.drugsLibraryItemId}`}]}}));if(await u.Z.insert(l.drugsLibraryHistory).values(a),e?.publisherUserId)for(let s=0;s<i.length;s++){let d=i[s],n=a[s];if(!d?.drugsLibraryItemId)continue;let u=(0,k.VL)({...d.drugsLibraryItem??{},deletedAt:r,key:`${d.drugsLibraryItem?.key??""}_${d.drugsLibraryItemId}`});t.push({entityId:d.drugsLibraryItemId,entityType:"drugs_library",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:u,description:n.changes.description,userId:e.publisherUserId,drugsLibraryItemId:d.drugsLibraryItemId,isActive:!1})}}await u.Z.delete(l.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.K0)(l.pendingDeletion.drugsLibraryItemId),(0,s.K0)(l.pendingDeletion.drugsLibraryItemDraftId)),e?.userId?(0,s.eq)(l.pendingDeletion.createdByUserId,e.userId):void 0));let a=[],o=[],y=await u.Z.query.drugsLibraryDrafts.findMany({where:e?.userId?(0,s.eq)(l.drugsLibraryDrafts.createdByUserId,e?.userId):void 0});if(a=y.filter(e=>e.itemId),o=y.filter(e=>!e.itemId),a.length){let r=[];for(let{itemId:e,data:t}of(a.filter(e=>e.itemId).length&&(r=await u.Z.query.drugsLibrary.findMany({where:(0,s.d3)(l.drugsLibrary.itemId,a.filter(e=>e.itemId).map(e=>e.itemId))})),a)){let{itemId:r,id:i,createdAt:a,updatedAt:d,deletedAt:n,...o}=t,y={...o,publishDate:new Date};await u.Z.update(l.drugsLibrary).set(y).where((0,s.eq)(l.drugsLibrary.itemId,e)).returning()}let i=await v({drafts:a,previous:r,userId:e?.publisherUserId});t.push(...i.map(r=>({...r,dataVersion:e?.dataVersion})))}if(o.length){let r=[];for(let{id:e,data:t}of(o.filter(e=>e.itemId).length&&(r=await u.Z.query.drugsLibrary.findMany({where:(0,s.d3)(l.drugsLibrary.itemId,o.filter(e=>e.itemId).map(e=>e.itemId))})),o)){let r=t.itemId||(0,d.Z)(),{id:i,...s}={...t,itemId:r};o=o.map(t=>(t.id===e&&(t.data.itemId=r),t)),await u.Z.insert(l.drugsLibrary).values(s)}let i=await v({drafts:o,previous:r,userId:e?.publisherUserId});t.push(...i.map(r=>({...r,dataVersion:e?.dataVersion})))}await u.Z.delete(l.drugsLibraryDrafts).where(e?.userId?(0,s.eq)(l.drugsLibraryDrafts.createdByUserId,e.userId):void 0);let g=[...a.map(e=>e.itemId),...i.map(e=>e.drugsLibraryItemId)];if(g.length&&await u.Z.update(l.drugsLibrary).set({version:(0,D.i6)`${l.drugsLibrary.version} + 1`}).where((0,s.d3)(l.drugsLibrary.itemId,g)),t.length){let e=await (0,Z.F)({data:t,allowPartial:!0});e.errors?.length&&n.Z.error("_publishDrugsLibraryItems changelog warnings",e.errors.join(", "))}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_publishDrugsLibraryItems ERROR",e.message)}finally{return r}}}};