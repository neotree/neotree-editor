"use strict";exports.id=927,exports.ids=[927],exports.modules={45064:(e,t,s)=>{s.d(t,{G$:()=>g,s:()=>f,t3:()=>c,fP:()=>o,HF:()=>y});var i=s(57745),r=s(30900),a=s(9576),d=s(10413),n=s(93567),l=s(57435);async function o(e){try{let{itemsIds:t,keys:s,returnDraftsIfExist:l=!0}={...e},o=(t||[]).map(e=>r.Z(e)?e:a.Z()),c=s||[],p=c?.length?(0,i.d3)(n.drugsLibraryDrafts.key,c):void 0,f=o?.length?(0,i.d3)(n.drugsLibraryDrafts.itemDraftId,o):void 0,g=[...p?[p]:[],...f?[f]:[]],u=l?await d.Z.query.drugsLibraryDrafts.findMany({where:(0,i.xD)(...g)}):[],I=u.map(e=>e.itemDraftId);o=o.map(e=>I.includes(e)?a.Z():e),c=c.map(e=>u.map(e=>e.key).includes(e)?a.Z():e);let y=c?.length?(0,i.d3)(n.drugsLibrary.key,c):void 0,m=o?.length?(0,i.d3)(n.drugsLibrary.itemId,o):void 0,h=[(0,i.Ft)(n.drugsLibrary.deletedAt),(0,i.Ft)(n.pendingDeletion),m,y,I.length?(0,i.Nl)(n.drugsLibrary.itemId,I):void 0],D=(await d.Z.select({drugsLibraryItem:n.drugsLibrary,pendingDeletion:n.pendingDeletion}).from(n.drugsLibrary).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.drugsLibraryItemId,n.drugsLibrary.itemId)).where(h.length?(0,i.xD)(...h):void 0)).map(e=>e.drugsLibraryItem),w=D.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.drugsLibraryItemId,D.map(e=>e.itemId)),columns:{drugsLibraryItemId:!0}}):[];return{data:[...D.map(e=>({...e,isDraft:!1,isDeleted:!1})),...u.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!w.map(e=>e.drugsLibraryItemId).includes(e.itemId))}}catch(e){return l.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){let{itemId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing itemId");let e=r.Z(t)?(0,i.eq)(n.drugsLibrary.itemId,t):void 0,a=e?(0,i.eq)(n.drugsLibraryDrafts.itemDraftId,t):void 0,l=s&&a?await d.Z.query.drugsLibraryDrafts.findFirst({where:e}):void 0,o=l?{...l.data,draftCreatedByUserId:l.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(o)return{data:o};let c=await d.Z.query.drugsLibrary.findFirst({where:(0,i.xD)((0,i.Ft)(n.drugsLibrary.deletedAt)),with:{draft:!0}});l=s?c?.draft:void 0;let p=l?.data||c;if(!(o=p?{...p,draftCreatedByUserId:l?.createdByUserId,isDraft:!!l?.data,isDeleted:!1}:null))return{data:null};return{data:o}}catch(e){return l.Z.error("_getDrugsLibraryItem ERROR",e.message),{errors:[e.message]}}}var p=s(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function g(){try{let[{count:e}]=await d.Z.select({count:(0,p.QX)()}).from(n.drugsLibraryDrafts),[{count:t}]=await d.Z.select({count:(0,p.QX)()}).from(n.drugsLibraryDrafts).where((0,i.Ft)(n.drugsLibraryDrafts.itemId)),[{count:s}]=await d.Z.select({count:(0,p.QX)()}).from(n.drugsLibraryDrafts).where((0,i.K0)(n.drugsLibraryDrafts.itemId)),[{count:r}]=await d.Z.select({count:(0,p.QX)()}).from(n.pendingDeletion).where((0,i.K0)(n.pendingDeletion.drugsLibraryItemId)),[{count:a}]=await d.Z.select({count:(0,p.QX)()}).from(n.drugsLibrary);return{data:{allPublished:a,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:r}}}catch(e){return l.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:f,errors:[e.message]}}}var u=s(34149);let I={title:"Title",type:"Type",key:"Key",keyId:"Key ID",gestationKey:"Gestation key",gestationKeyId:"Gestation key ID",weightKey:"Weight key",weightKeyId:"Weight key ID",diagnosisKey:"Diagnosis key",diagnosisKeyId:"Diagnosis key ID",ageKey:"Age key",ageKeyId:"Age key ID",dosageText:"Dosage text",managementText:"Management text",administrationFrequency:"Administration frequency",routeOfAdministration:"Route of administration",condition:"Conditional expression",preferenceKey:"Preference key",preferenceValue:"Preference value"};async function y({searchValue:e,returnDraftsIfExist:t=!0}){try{let s=`${e||""}`.trim().toLowerCase();if(!s)return{data:[]};let r=`%${s}%`,a=t?await d.Z.query.drugsLibraryDrafts.findMany({where:(0,u.i6)`lower(${n.drugsLibraryDrafts.data}::text) like ${r}`}):[],l=a.map(e=>e.itemId||e.data.itemId||null).filter(e=>!!e),o=await d.Z.select({item:n.drugsLibrary,pendingDeletion:n.pendingDeletion}).from(n.drugsLibrary).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.drugsLibraryItemId,n.drugsLibrary.itemId)).where((0,i.xD)((0,i.Ft)(n.pendingDeletion),(0,i.Ft)(n.drugsLibrary.deletedAt),l.length?(0,i.Nl)(n.drugsLibrary.itemId,l):void 0,(0,i.or)((0,u.i6)`lower(${n.drugsLibrary.key}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.keyId}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.gestationKey}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.gestationKeyId}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.weightKey}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.weightKeyId}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.diagnosisKey}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.diagnosisKeyId}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.ageKey}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.ageKeyId}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.drug}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.type}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.dosageText}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.managementText}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.administrationFrequency}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.routeOfAdministration}::text) like ${r}`,(0,u.i6)`lower(${n.drugsLibrary.condition}::text) like ${r}`))),c=(e,t)=>{if(e instanceof Date)return e;if("string"==typeof e||"number"==typeof e){let t=new Date(e);if(!Number.isNaN(t.getTime()))return t}return t},p=a.map(e=>{let t=e.data,s=t.itemId??e.itemId??e.itemDraftId;return s?{id:t.id??0,itemId:s,key:t.key??e.key,keyId:t.keyId??"",type:t.type??e.type,drug:t.drug??"",minGestation:t.minGestation??null,maxGestation:t.maxGestation??null,minWeight:t.minWeight??null,maxWeight:t.maxWeight??null,minAge:t.minAge??null,maxAge:t.maxAge??null,hourlyFeed:t.hourlyFeed??null,hourlyFeedDivider:t.hourlyFeedDivider??null,dosage:t.dosage??null,dosageMultiplier:t.dosageMultiplier??null,dayOfLife:t.dayOfLife??"",dosageText:t.dosageText??"",managementText:t.managementText??"",gestationKey:t.gestationKey??"",weightKey:t.weightKey??"",diagnosisKey:t.diagnosisKey??"",ageKey:t.ageKey??"",ageKeyId:t.ageKeyId??"",gestationKeyId:t.gestationKeyId??"",weightKeyId:t.weightKeyId??"",diagnosisKeyId:t.diagnosisKeyId??"",administrationFrequency:t.administrationFrequency??"",drugUnit:t.drugUnit??"",routeOfAdministration:t.routeOfAdministration??"",position:t.position??e.position,condition:t.condition??"",validationType:t.validationType??"default",version:t.version??0,publishDate:c(t.publishDate,new Date),createdAt:c(t.createdAt,e.createdAt),updatedAt:c(t.updatedAt,e.updatedAt),deletedAt:t.deletedAt?c(t.deletedAt,e.updatedAt):null,itemId:s,isDraft:!0,draftCreatedByUserId:e.createdByUserId,preferences:t.preferences??null}:null}).filter(e=>!!e),f=o.map(({item:e})=>e).filter(e=>!!e).map(e=>({...e,itemId:e.itemId,isDraft:!1})),g=[...p,...f].sort((e,t)=>(e.position??0)-(t.position??0));return{data:function({searchValue:e,items:t}){let s=`${e||""}`.trim().toLowerCase();return s?t.reduce((e,t)=>{let i=[],r=new Set,a=(e,t,a)=>{let d=`${t??""}`.trim();if(!d||!d.toLowerCase().includes(s))return;let n=`${e}:${d}:${a||""}`;r.has(n)||(r.add(n),i.push({field:e,fieldLabel:I[e],fieldValue:d,...a?{context:a}:{}}))};[["title",t.drug],["type",t.type],["key",t.key],["keyId",t.keyId],["gestationKey",t.gestationKey],["gestationKeyId",t.gestationKeyId],["weightKey",t.weightKey],["weightKeyId",t.weightKeyId],["diagnosisKey",t.diagnosisKey],["diagnosisKeyId",t.diagnosisKeyId],["ageKey",t.ageKey],["ageKeyId",t.ageKeyId],["dosageText",t.dosageText],["managementText",t.managementText],["administrationFrequency",t.administrationFrequency],["routeOfAdministration",t.routeOfAdministration],["condition",t.condition]].forEach(([e,t])=>a(e,t));let d=t.preferences;return d&&Object.entries(d).forEach(([e,t])=>{t&&Object.entries(t).forEach(([t,s])=>{a("preferenceKey",t,e),"string"==typeof s||"number"==typeof s?a("preferenceValue",s,e):Array.isArray(s)&&a("preferenceValue",s.join(", "),e)})}),i.length&&t.itemId&&e.push({itemId:t.itemId,title:`${t.drug||""}`,type:`${t.type||""}`,isDraft:!!t.isDraft,matches:i}),e},[]):[]}({searchValue:e,items:g})}}catch(e){return l.Z.error("_searchDrugsLibrary ERROR",e.message),{errors:[e.message],data:[]}}}},927:(e,t,s)=>{s.d(t,{tW:()=>v,co:()=>D,ix:()=>y,GM:()=>k,W0:()=>h,Zu:()=>I,XA:()=>Z,DX:()=>q,Ew:()=>L,eh:()=>o,A0:()=>c,NB:()=>b,uK:()=>w,pw:()=>x,bK:()=>f,Tw:()=>p,$F:()=>m,pd:()=>F,Sc:()=>K,f:()=>$,Yc:()=>B});var i=s(57745),r=s(30900),a=s(9576),d=s(10413),n=s(93567),l=s(57435);async function o(){let e=await d.Z.select({scriptId:n.scripts.scriptId}).from(n.scripts).where((0,i.Ft)(n.scripts.deletedAt));return e?.map(e=>e.scriptId)??[]}async function c(e){let t=await d.Z.select({oldScript:n.scripts.oldScriptId}).from(n.scripts).where((0,i.eq)(n.scripts.scriptId,e));return t?.map(e=>e.oldScript)??[]}async function p(e){try{let{scriptsIds:t=[],hospitalIds:s=[],returnDraftsIfExist:l=!0}={...e},o=t.filter(e=>!r.Z(e));t=t.filter(e=>r.Z(e));let c=s.filter(e=>!r.Z(e));if(s=s.filter(e=>r.Z(e)),o.length){let e=await d.Z.query.scripts.findMany({where:(0,i.d3)(n.scripts.oldScriptId,o),columns:{scriptId:!0,oldScriptId:!0}});o.forEach(s=>{let i=e.filter(e=>e.oldScriptId===s)[0];t.push(i?.scriptId||a.Z())})}if(c.length){let e=await d.Z.query.hospitals.findMany({where:(0,i.d3)(n.hospitals.oldHospitalId,c),columns:{hospitalId:!0,oldHospitalId:!0}});c.forEach(t=>{let i=e.filter(e=>e.oldHospitalId===t)[0];s.push(i?.hospitalId||a.Z())})}let p=(l?await d.Z.select({scriptDraft:n.scriptsDrafts,hospitalName:n.hospitals.name}).from(n.scriptsDrafts).leftJoin(n.hospitals,(0,i.eq)(n.hospitals.hospitalId,n.scriptsDrafts.hospitalId)).where((0,i.xD)(t?.length?(0,i.d3)(n.scriptsDrafts.scriptDraftId,t):void 0,s.length?(0,i.d3)(n.scriptsDrafts.hospitalId,s):void 0)):[]).map(e=>({...e.scriptDraft,hospitalName:e.hospitalName})),f=(await d.Z.select({script:n.scripts,pendingDeletion:n.pendingDeletion,hospitalName:n.hospitals.name}).from(n.scripts).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.scriptId,n.scripts.scriptId)).leftJoin(n.scriptsDrafts,(0,i.eq)(n.scriptsDrafts.scriptId,n.scripts.scriptId)).leftJoin(n.hospitals,(0,i.xD)((0,i.eq)(n.hospitals.hospitalId,n.scripts.hospitalId),(0,i.Ft)(n.hospitals.deletedAt))).where((0,i.xD)((0,i.Ft)(n.scripts.deletedAt),(0,i.Ft)(n.pendingDeletion),l?(0,i.Ft)(n.scriptsDrafts.scriptId):void 0,t.length?(0,i.d3)(n.scripts.scriptId,t):void 0,s.length?(0,i.d3)(n.scripts.hospitalId,s):void 0))).map(e=>({...e.script,hospitalName:e.hospitalName})),u=f.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.scriptId,f.map(e=>e.scriptId)),columns:{scriptId:!0}}):[],I=[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...p.map(e=>({...e.data,hospitalName:e.hospitalName,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!u.map(e=>e.scriptId).includes(e.scriptId)).map(e=>({...e,hospitalId:e.hospitalName?e.hospitalId:null})),y=0;for(let e of I){let{data:[t]}=await g({scriptsIds:[e.scriptId]});I[y].hasChangedItems=!!t?.hasChangedItems,I[y].itemsChangedByUserId=t?.itemsChangedByUserId||null,y++}return{data:I}}catch(e){return l.Z.error("_getScripts ERROR",e.message),{data:[],errors:[e.message]}}}async function f(e){let{scriptId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing scriptId");let e=r.Z(t)?(0,i.eq)(n.scripts.scriptId,t):void 0,a=r.Z(t)?void 0:(0,i.eq)(n.scripts.oldScriptId,t),l=e?(0,i.eq)(n.scriptsDrafts.scriptDraftId,t):void 0,o=s&&l?await d.Z.query.scriptsDrafts.findFirst({where:l}):void 0,c=o?{...o.data,draftCreatedByUserId:o.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(c){let{data:[e]}=await g({scriptsIds:[c.scriptId]});return c.hasChangedItems=!!e?.hasChangedItems,c.itemsChangedByUserId=e.itemsChangedByUserId||null,{data:c}}let p=await d.Z.select({script:n.scripts,pendingDeletion:n.pendingDeletion,draft:n.scriptsDrafts,hospitalName:n.hospitals.name}).from(n.scripts).leftJoin(n.hospitals,(0,i.xD)((0,i.eq)(n.hospitals.hospitalId,n.scripts.hospitalId),(0,i.Ft)(n.hospitals.deletedAt))).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.scriptId,n.scripts.scriptId)).leftJoin(n.scriptsDrafts,(0,i.eq)(n.scripts.scriptId,n.scriptsDrafts.scriptDraftId)).where((0,i.xD)((0,i.Ft)(n.scripts.deletedAt),(0,i.Ft)(n.pendingDeletion),(0,i.or)(e,a))),f=p[0]?{...p[0].script,draft:p[0].draft||void 0,hospitalName:p[0].hospitalName||""}:null;o=s?f?.draft:void 0;let u=o?.data||f;if(!(c=u?{...u,draftCreatedByUserId:o?.createdByUserId,isDraft:!!o?.data,isDeleted:!1,hospitalId:u.hospitalName?u.hospitalId:null}:null))return{data:null};let{data:[I]}=await g({scriptsIds:[c.scriptId]});return c.hasChangedItems=!!I?.hasChangedItems,c.itemsChangedByUserId=I.itemsChangedByUserId||null,{data:c}}catch(e){return l.Z.error("_getScript ERROR",e.message),{errors:[e.message]}}}async function g({scriptsIds:e=[],userId:t}){let s=[];try{for(let t of e){let e=await d.Z.query.screensDrafts.findFirst({where:(0,i.or)((0,i.eq)(n.screensDrafts.scriptDraftId,t),(0,i.eq)(n.screensDrafts.scriptId,t)),columns:{createdByUserId:!0}}),r=await d.Z.query.diagnosesDrafts.findFirst({where:(0,i.or)((0,i.eq)(n.diagnosesDrafts.scriptDraftId,t),(0,i.eq)(n.diagnosesDrafts.scriptId,t)),columns:{createdByUserId:!0}}),a=await d.Z.query.pendingDeletion.findMany({where:(0,i.or)((0,i.eq)(n.pendingDeletion.scriptDraftId,t),(0,i.eq)(n.pendingDeletion.screenScriptId,t),(0,i.eq)(n.pendingDeletion.diagnosisScriptId,t)),columns:{createdByUserId:!0}}),l=a.find(e=>e.createdByUserId),o={hasDraftedScreens:!!e?.createdByUserId,hasDraftedDiagnoses:!!r?.createdByUserId,hasDeletedItems:!!a?.length,hasChangedItems:!!e?.createdByUserId||!!r?.createdByUserId||!!a?.length,screensDraftsCreatedByUserId:e?.createdByUserId,diagnosesDraftsCreatedByUserId:r?.createdByUserId,itemsDeletedByUserId:l?.createdByUserId,itemsChangedByUserId:e?.createdByUserId||r?.createdByUserId||l?.createdByUserId};s.push(o)}return{data:s}}catch(e){return l.Z.error("_getScriptsRelationsChanges ERROR",e.message),{errors:[e.message],data:s}}}var u=s(60938);let I={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function y(){try{let[{count:e}]=await d.Z.select({count:(0,u.QX)()}).from(n.scriptsDrafts),[{count:t}]=await d.Z.select({count:(0,u.QX)()}).from(n.scriptsDrafts).where((0,i.Ft)(n.scriptsDrafts.scriptId)),[{count:s}]=await d.Z.select({count:(0,u.QX)()}).from(n.scriptsDrafts).where((0,i.K0)(n.scriptsDrafts.scriptId)),[{count:r}]=await d.Z.select({count:(0,u.QX)()}).from(n.pendingDeletion).where((0,i.K0)(n.pendingDeletion.scriptId)),[{count:a}]=await d.Z.select({count:(0,u.QX)()}).from(n.scripts);return{data:{allPublished:a,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:r}}}catch(e){return l.Z.error("_getScripts ERROR",e.message),{data:I,errors:[e.message]}}}async function m(e){try{let e={};return(await d.Z.query.scriptsHistory.findMany({})).forEach(t=>{e[t.scriptId]=e[t.scriptId]||{},e[t.scriptId][t.version]=e[t.scriptId][t.version]||[],e[t.scriptId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let h={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function D(e){let{scriptsIds:t=[],types:s=[]}={...e};try{let e=t.length?(0,i.d3)(n.screens.scriptId,t):void 0,r=t.length?(0,i.d3)(n.screensDrafts.scriptId,t):void 0,a=s.length?(0,i.d3)(n.screens.type,s):void 0,l=s.length?(0,i.d3)(n.screensDrafts.type,s):void 0,[{count:o}]=await d.Z.select({count:(0,u.QX)()}).from(n.screensDrafts).where((0,i.xD)(r,l)),[{count:c}]=await d.Z.select({count:(0,u.QX)()}).from(n.screensDrafts).where((0,i.xD)(r,l,(0,i.Ft)(n.screensDrafts.screenId))),[{count:p}]=await d.Z.select({count:(0,u.QX)()}).from(n.screensDrafts).where((0,i.xD)(r,l,(0,i.K0)(n.screensDrafts.screenId))),[{count:f}]=await d.Z.select({count:(0,u.QX)()}).from(n.pendingDeletion).where((0,i.xD)(t.length?(0,i.or)((0,i.d3)(n.pendingDeletion.screenScriptId,t)):void 0,(0,i.K0)(n.pendingDeletion.screenId))),[{count:g}]=await d.Z.select({count:(0,u.QX)()}).from(n.screens).where((0,i.xD)(e,a));return{data:{allPublished:g,publishedWithDrafts:p,allDrafts:o,newDrafts:c,pendingDeletion:f}}}catch(e){return l.Z.error("_getScreens ERROR",e.message),{data:h,errors:[e.message]}}}async function w(e){try{let{scriptsIds:t=[],screensIds:s=[],types:l=[],returnDraftsIfExist:o=!0,withImagesOnly:c}={...e},p=s.filter(e=>!r.Z(e));if(s=s.filter(e=>r.Z(e)),p.length){let e=await d.Z.query.screens.findMany({where:(0,i.d3)(n.screens.oldScreenId,p),columns:{screenId:!0,oldScreenId:!0}});p.forEach(t=>{let i=e.filter(e=>e.oldScreenId===t)[0];s.push(i?.screenId||a.Z())})}let f=(t=t.filter(e=>r.Z(e))).filter(e=>!r.Z(e));if(f.length){let e=await d.Z.query.scripts.findMany({where:(0,i.d3)(n.scripts.oldScriptId,f),columns:{scriptId:!0,oldScriptId:!0}});f.forEach(s=>{let i=e.filter(e=>e.oldScriptId===s)[0];t.push(i?.scriptId||a.Z())})}let g=o?await d.Z.query.screensDrafts.findMany({where:(0,i.xD)(t?.length?(0,i.or)((0,i.d3)(n.screensDrafts.scriptId,t),(0,i.d3)(n.screensDrafts.scriptDraftId,t)):void 0,s?.length?(0,i.d3)(n.screensDrafts.screenDraftId,s):void 0,l?.length?(0,i.d3)(n.screensDrafts.type,l):void 0)}):[],u=(await d.Z.select({screen:n.screens,pendingDeletion:n.pendingDeletion,script:{title:n.scripts.title,hospitalId:n.scripts.hospitalId},hospital:{name:n.hospitals.name}}).from(n.screens).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.screenId,n.screens.screenId)).leftJoin(n.screensDrafts,(0,i.eq)(n.screensDrafts.screenId,n.screens.screenId)).leftJoin(n.scripts,(0,i.eq)(n.scripts.scriptId,n.screens.scriptId)).leftJoin(n.hospitals,(0,i.xD)((0,i.eq)(n.scripts.scriptId,n.screens.scriptId),(0,i.eq)(n.scripts.hospitalId,n.hospitals.hospitalId))).where((0,i.xD)((0,i.Ft)(n.screens.deletedAt),(0,i.Ft)(n.pendingDeletion),o?(0,i.Ft)(n.screensDrafts.screenId):void 0,t?.length?(0,i.d3)(n.screens.scriptId,t):void 0,s?.length?(0,i.d3)(n.screens.screenId,s):void 0,l?.length?(0,i.d3)(n.screens.type,l):void 0,c?(0,i.or)((0,i.K0)(n.screens.image1),(0,i.K0)(n.screens.image2),(0,i.K0)(n.screens.image3)):void 0))).map(e=>({...e.screen,scriptTitle:e.script?.title||"",hospitalName:e.hospital?.name||""})),I=u.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.screenId,u.map(e=>e.screenId)),columns:{screenId:!0}}):[];return{data:[...u.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!I.map(e=>e.screenId).includes(e.screenId))}}catch(e){return l.Z.error("_getScreens ERROR",e.message),{data:[],errors:[e.message]}}}async function b(e){let{screenId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing screenId");let e=r.Z(t)?(0,i.eq)(n.screens.screenId,t):void 0,a=r.Z(t)?void 0:(0,i.eq)(n.screens.oldScreenId,t),l=e?(0,i.eq)(n.screensDrafts.screenDraftId,t):void 0,o=s&&l?await d.Z.query.screensDrafts.findFirst({where:l}):void 0,c=o?{...o.data,draftCreatedByUserId:o.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(c)return{data:c};let p=await d.Z.select({screen:n.screens,pendingDeletion:n.pendingDeletion,draft:n.screensDrafts}).from(n.screens).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.screenId,n.screens.screenId)).leftJoin(n.screensDrafts,(0,i.eq)(n.screens.screenId,n.screensDrafts.screenDraftId)).where((0,i.xD)((0,i.Ft)(n.screens.deletedAt),(0,i.Ft)(n.pendingDeletion),(0,i.or)(e,a))),f=p[0]?{...p[0].screen,draft:p[0].draft||void 0}:null;o=s?f?.draft:void 0;let g=o?.data||f;if(!(c=g?{...g,draftCreatedByUserId:o?.createdByUserId,isDraft:!!o?.data,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return l.Z.error("_getScreen ERROR",e.message),{errors:[e.message]}}}async function $(e){try{let{scriptsIds:t=[],screensIds:s=[],returnDraftsIfExist:l}={...e},o=s.filter(e=>!r.Z(e));if(s=s.filter(e=>r.Z(e)),o.length){let e=await d.Z.query.screens.findMany({where:(0,i.d3)(n.screens.oldScreenId,o),columns:{screenId:!0,oldScreenId:!0}});o.forEach(t=>{let i=e.filter(e=>e.oldScreenId===t)[0];s.push(i?.screenId||a.Z())})}let c=(t=t.filter(e=>r.Z(e))).filter(e=>!r.Z(e));if(c.length){let e=await d.Z.query.scripts.findMany({where:(0,i.d3)(n.scripts.oldScriptId,c),columns:{scriptId:!0,oldScriptId:!0}});c.forEach(s=>{let i=e.filter(e=>e.oldScriptId===s)[0];t.push(i?.scriptId||a.Z())})}let p=l?await d.Z.query.screensDrafts.findMany({where:(0,i.xD)(t?.length?(0,i.or)((0,i.d3)(n.screensDrafts.scriptId,t),(0,i.d3)(n.screensDrafts.scriptDraftId,t)):void 0,s?.length?(0,i.d3)(n.screensDrafts.screenDraftId,s):void 0)}):[],f=(await d.Z.select({screen:{title:n.screens.title,screenId:n.screens.screenId,oldScreenId:n.screens.oldScreenId,position:n.screens.position,type:n.screens.type,refId:n.screens.refId},pendingDeletion:n.pendingDeletion}).from(n.screens).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.screenId,n.screens.screenId)).leftJoin(n.screensDrafts,(0,i.eq)(n.screensDrafts.screenId,n.screens.screenId)).where((0,i.xD)((0,i.Ft)(n.screens.deletedAt),(0,i.Ft)(n.pendingDeletion),l?(0,i.Ft)(n.screensDrafts.screenId):void 0,t?.length?(0,i.d3)(n.screens.scriptId,t):void 0,s?.length?(0,i.d3)(n.screens.screenId,s):void 0))).map(e=>e.screen),g=f.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.screenId,f.map(e=>e.screenId)),columns:{screenId:!0}}):[];return{data:[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...p.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!g.map(e=>e.screenId).includes(e.screenId)).map((e,t)=>({...e,position:t+1}))}}catch(e){return l.Z.error("_listScreens ERROR",e.message),{data:[],errors:[e.message]}}}async function x(e){try{let e={};return(await d.Z.query.screensHistory.findMany({})).forEach(t=>{e[t.screenId]=e[t.screenId]||{},e[t.screenId][t.version]=e[t.screenId][t.version]||[],e[t.screenId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}let k={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function v(e){let{scriptsIds:t=[]}={...e};try{let e=t.length?(0,i.d3)(n.diagnoses.scriptId,t):void 0,s=t.length?(0,i.d3)(n.diagnosesDrafts.scriptId,t):void 0,[{count:r}]=await d.Z.select({count:(0,u.QX)()}).from(n.diagnosesDrafts).where(s),[{count:a}]=await d.Z.select({count:(0,u.QX)()}).from(n.diagnosesDrafts).where((0,i.xD)(s,(0,i.Ft)(n.diagnosesDrafts.diagnosisId))),[{count:l}]=await d.Z.select({count:(0,u.QX)()}).from(n.diagnosesDrafts).where((0,i.xD)(s,(0,i.K0)(n.diagnosesDrafts.diagnosisId))),[{count:o}]=await d.Z.select({count:(0,u.QX)()}).from(n.pendingDeletion).where((0,i.xD)(t.length?(0,i.or)((0,i.d3)(n.pendingDeletion.diagnosisScriptId,t)):void 0,(0,i.K0)(n.pendingDeletion.diagnosisId))),[{count:c}]=await d.Z.select({count:(0,u.QX)()}).from(n.diagnoses).where(e);return{data:{allPublished:c,publishedWithDrafts:l,allDrafts:r,newDrafts:a,pendingDeletion:o}}}catch(e){return l.Z.error("_getDiagnoses ERROR",e.message),{data:k,errors:[e.message]}}}async function Z(e){try{let{scriptsIds:t=[],diagnosesIds:s=[],returnDraftsIfExist:l=!0,withImagesOnly:o}={...e},c=s.filter(e=>!r.Z(e));if(s=s.filter(e=>r.Z(e)),c.length){let e=await d.Z.query.diagnoses.findMany({where:(0,i.d3)(n.diagnoses.oldDiagnosisId,c),columns:{diagnosisId:!0,oldDiagnosisId:!0}});c.forEach(t=>{let i=e.filter(e=>e.oldDiagnosisId===t)[0];s.push(i?.diagnosisId||a.Z())})}let p=(t=t.filter(e=>r.Z(e))).filter(e=>!r.Z(e));if(p.length){let e=await d.Z.query.scripts.findMany({where:(0,i.d3)(n.scripts.oldScriptId,p),columns:{scriptId:!0,oldScriptId:!0}});p.forEach(s=>{let i=e.filter(e=>e.oldScriptId===s)[0];t.push(i?.scriptId||a.Z())})}let f=l?await d.Z.query.diagnosesDrafts.findMany({where:(0,i.xD)(t?.length?(0,i.or)((0,i.d3)(n.diagnosesDrafts.scriptId,t),(0,i.d3)(n.diagnosesDrafts.scriptDraftId,t)):void 0,s?.length?(0,i.d3)(n.diagnosesDrafts.diagnosisDraftId,s):void 0)}):[],g=(await d.Z.select({diagnosis:n.diagnoses,pendingDeletion:n.pendingDeletion,script:{title:n.scripts.title,hospitalId:n.scripts.hospitalId},hospital:{name:n.hospitals.name}}).from(n.diagnoses).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.diagnosisId,n.diagnoses.diagnosisId)).leftJoin(n.diagnosesDrafts,(0,i.eq)(n.diagnosesDrafts.diagnosisId,n.diagnoses.diagnosisId)).leftJoin(n.scripts,(0,i.eq)(n.scripts.scriptId,n.diagnoses.scriptId)).leftJoin(n.hospitals,(0,i.xD)((0,i.eq)(n.scripts.scriptId,n.diagnoses.scriptId),(0,i.eq)(n.scripts.hospitalId,n.hospitals.hospitalId))).where((0,i.xD)((0,i.Ft)(n.diagnoses.deletedAt),(0,i.Ft)(n.pendingDeletion),l?(0,i.Ft)(n.diagnosesDrafts.diagnosisId):void 0,t?.length?(0,i.d3)(n.diagnoses.scriptId,t):void 0,s?.length?(0,i.d3)(n.diagnoses.diagnosisId,s):void 0,o?(0,i.or)((0,i.K0)(n.diagnoses.image1),(0,i.K0)(n.diagnoses.image2),(0,i.K0)(n.diagnoses.image3)):void 0))).map(e=>({...e.diagnosis,scriptTitle:e.script?.title||"",hospitalName:e.hospital?.name||""})),u=g.length?await d.Z.query.pendingDeletion.findMany({where:(0,i.d3)(n.pendingDeletion.diagnosisId,g.map(e=>e.diagnosisId)),columns:{diagnosisId:!0}}):[];return{data:[...g.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!u.map(e=>e.diagnosisId).includes(e.diagnosisId)).map(e=>({...e,scriptTitle:e.scriptTitle||"",hospitalName:e.hospitalName||""}))}}catch(e){return l.Z.error("_getDiagnoses ERROR",e.message),{data:[],errors:[e.message]}}}async function L(e){let{diagnosisId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing diagnosisId");let e=r.Z(t)?(0,i.eq)(n.diagnoses.diagnosisId,t):void 0,a=r.Z(t)?void 0:(0,i.eq)(n.diagnoses.oldDiagnosisId,t),l=e?(0,i.eq)(n.diagnosesDrafts.diagnosisDraftId,t):void 0,o=s&&l?await d.Z.query.diagnosesDrafts.findFirst({where:l}):void 0,c=o?{...o.data,draftCreatedByUserId:o.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(c)return{data:c};let p=await d.Z.select({diagnosis:n.diagnoses,pendingDeletion:n.pendingDeletion,draft:n.diagnosesDrafts}).from(n.diagnoses).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.diagnosisId,n.diagnoses.diagnosisId)).leftJoin(n.diagnosesDrafts,(0,i.eq)(n.diagnoses.diagnosisId,n.diagnosesDrafts.diagnosisDraftId)).where((0,i.xD)((0,i.Ft)(n.diagnoses.deletedAt),(0,i.Ft)(n.pendingDeletion),(0,i.or)(e,a))),f=p[0]?{...p[0].diagnosis,draft:p[0].draft||void 0}:null;o=s?f?.draft:void 0;let g=o?.data||f;if(!(c=g?{...g,draftCreatedByUserId:o?.createdByUserId,isDraft:!!o?.data,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return l.Z.error("_getDiagnosis ERROR",e.message),{errors:[e.message]}}}async function q(e){try{let e={};return(await d.Z.query.diagnosesHistory.findMany({})).forEach(t=>{e[t.diagnosisId]=e[t.diagnosisId]||{},e[t.diagnosisId][t.version]=e[t.diagnosisId][t.version]||[],e[t.diagnosisId][t.version].push(t.changes)}),{history:e}}catch(e){return{errors:[e.message],history:{}}}}async function K(e){try{let{scriptsIds:t=[],hospitalsIds:s=[],returnDraftsIfExist:l}={...e},o=await d.Z.query.hospitals.findMany({where:(0,i.xD)((0,i.Ft)(n.hospitals.deletedAt))}),c=t.filter(e=>!r.Z(e));if(c.length){let e=await d.Z.query.scripts.findMany({where:(0,i.d3)(n.scripts.oldScriptId,c),columns:{scriptId:!0,oldScriptId:!0}});c.forEach(s=>{let i=e.filter(e=>e.oldScriptId===s)[0];t.push(i?.scriptId||a.Z())})}let p=t.filter(e=>r.Z(e)),f=p.length?(0,i.d3)(n.scripts.scriptId,p):void 0,g=s.length?(0,i.d3)(n.scripts.hospitalId,s):void 0,u=await d.Z.query.scriptsDrafts.findMany({where:(0,i.xD)(g,p.length?(0,i.xD)((0,i.d3)(n.scriptsDrafts.scriptDraftId,p),(0,i.Ft)(n.scriptsDrafts.scriptId)):void 0),with:{screensDrafts:!0,diagnosesDrafts:!0}}),I=(l?await d.Z.query.scripts.findMany({where:(0,i.xD)(f,g),with:{draft:!!l||void 0,screens:{where:(0,i.Ft)(n.screens.deletedAt),with:{draft:!!l||void 0}},diagnoses:{where:(0,i.Ft)(n.screens.deletedAt),with:{draft:!!l||void 0}}}}):[]).map(e=>({...e,...l&&e.draft?e.draft.data:null,screens:e.screens.sort((e,t)=>e.position-t.position),diagnoses:e.diagnoses.sort((e,t)=>e.position-t.position)})),y=u.map(e=>({...e.data,scriptId:e.scriptDraftId,screens:e.screensDrafts.map(e=>({...e.data,screenId:e.screenDraftId})),diagnoses:e.diagnosesDrafts.map(e=>({...e.data,diagnosisId:e.diagnosisDraftId}))})),m=[...I,...y].sort((e,t)=>e.position-t.position),h=[];return m.forEach(e=>{let t=o.filter(t=>t.hospitalId===e.hospitalId)[0];h.push({scriptId:e.scriptId,title:e.title,hospitalName:t?.name||"",diagnoses:e.diagnoses.map(e=>({diagnosisId:e.diagnosisId,name:e.name,key:e.key||e.name,fields:[]})),screens:e.screens.map(e=>{let t=e.items,s=e.fields,i=[{label:e.label,key:e.key,type:e.type,...(e.type,{dataType:e.dataType,value:null,valueLabel:null,optional:e.skippable,confidential:e.confidential,minValue:e.minValue,maxValue:e.maxValue})}];switch(e.type){case"progress":case"edliz_summary_table":case"mwi_edliz_summary_table":case"zw_edliz_summary_table":case"management":i=[];break;case"yesno":i=[{value:"true",label:e.positiveLabel||"Yes"},{value:"false",label:e.negativeLabel||"Yes"}].map(t=>({label:e.label,key:e.key,type:e.type,dataType:"boolean",value:t.value,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"diagnosis":i=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.id,type:e.type,dataType:"diagnosis",optional:e.skippable,confidential:e.confidential}));break;case"checklist":i=t.map(t=>({value:t.id,valueLabel:t.label,label:t.label,key:t.key,type:e.type,dataType:null,optional:e.skippable,confidential:e.confidential}));break;case"form":i=s.map(e=>{let t=e.dataType;switch(e.type){case"datetime":t="datetime";break;case"date":t="date";break;case"time":t="time";break;case"dropdown":t="dropdown";break;case"multi_select":t="multi_select";break;case"number":t="number";break;case"text":t="string",("uid"===`${e.key}`.toLowerCase()||`${e.key}`.toLowerCase().includes("nuid"))&&(t="uid");break;default:t=e.dataType}if(["multi_select","dropdown"].includes(e.type)){let t="dropdown";return"multi_select"===e.type&&(t="multi_select"),(e.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).map(e=>({value:(e=e.split(","))[0],label:e[1]})).map(s=>({label:e.label,key:e.key,type:e.type,dataType:t,value:s.value,valueLabel:s.label,optional:e.optional,confidential:e.confidential}))}return[{label:e.label,key:e.key,type:e.type,dataType:t,value:null,valueLabel:null,optional:e.optional,confidential:e.confidential,minValue:e.minValue??e.minDate??e.minTime,maxValue:e.maxValue??e.maxDate??e.maxTime}]}).reduce((e,t)=>[...e,...t],[]);break;case"single_select":i=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"single_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}));break;case"multi_select":i=t.map(t=>({label:e.label,key:e.key,type:e.type,dataType:"multi_select_option",value:t.id,valueLabel:t.label,optional:e.skippable,confidential:e.confidential}))}return{screenId:e.screenId,type:e.type,title:e.title,ref:e.refId,fields:i}})})}),{data:h}}catch(e){return{errors:[e.message],data:[]}}}var C=s(45064);async function F(e){try{let t=await p(e),s=await w({types:["drugs","feeds","fluids"],scriptsIds:t.data.map(e=>e.scriptId),returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted}),i=Object.keys(s.data.reduce((e,t)=>([...t.drugs,...t.fluids,...t.feeds].forEach(t=>{e[t.key]=t.key}),e),{}));return await (0,C.fP)({keys:i,returnDraftsIfExist:e?.returnDraftsIfExist,withDeleted:e?.withDeleted})}catch(e){return l.Z.error("_getScriptsDrugsLibrary ERROR",e.message),{data:[],errors:[e.message]}}}var U=s(34149);async function B({searchValue:e,returnDraftsIfExist:t=!0}){try{if(!(e=`${e||""}`.trim().toLowerCase()))return{data:[]};let s=t?await d.Z.query.scriptsDrafts.findMany({where:(0,U.i6)`lower(${n.scriptsDrafts.data}::text) like ${`%${e}%`}`}):[],r=await d.Z.select({pendingDeletion:n.pendingDeletion,script:n.scripts}).from(n.scripts).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.scriptId,n.scripts.scriptId)).where((0,i.xD)((0,i.Ft)(n.pendingDeletion),(0,i.Ft)(n.scripts.deletedAt),s.length?(0,i.Nl)(n.scripts.scriptId,s.map(e=>e.scriptDraftId)):void 0,(0,i.or)((0,U.i6)`lower(${n.scripts.title}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.scripts.printTitle}::text) like ${`%${e}%`}`))),a=t?await d.Z.query.screensDrafts.findMany({where:(0,U.i6)`lower(${n.screensDrafts.data}::text) like ${`%${e}%`}`}):[],l=await d.Z.select({pendingDeletion:n.pendingDeletion,screen:n.screens}).from(n.screens).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.screenId,n.screens.screenId)).where((0,i.xD)((0,i.Ft)(n.pendingDeletion),(0,i.Ft)(n.screens.deletedAt),a.length?(0,i.Nl)(n.screens.screenId,a.map(e=>e.screenDraftId)):void 0,(0,i.or)((0,U.i6)`lower(${n.screens.condition}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.sectionTitle}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.previewTitle}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.previewPrintTitle}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.title}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.key}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.refId}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.label}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.fields}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.items}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.drugs}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.fluids}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.screens.feeds}::text) like ${`%${e}%`}`))),o=t?await d.Z.query.diagnosesDrafts.findMany({where:(0,U.i6)`lower(${n.diagnosesDrafts.data}::text) like ${`%${e}%`}`}):[],c=await d.Z.select({pendingDeletion:n.pendingDeletion,diagnosis:n.diagnoses}).from(n.diagnoses).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.diagnosisId,n.diagnoses.diagnosisId)).where((0,i.xD)((0,i.Ft)(n.pendingDeletion),(0,i.Ft)(n.diagnoses.deletedAt),o.length?(0,i.Nl)(n.diagnoses.diagnosisId,o.map(e=>e.diagnosisDraftId)):void 0,(0,i.or)((0,U.i6)`lower(${n.diagnoses.name}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.diagnoses.expression}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.diagnoses.symptoms}::text) like ${`%${e}%`}`,(0,U.i6)`lower(${n.diagnoses.key}::text) like ${`%${e}%`}`))),p=[...s.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,isDraft:!0})),...r.map(e=>({...e.script,isDraft:!1}))].sort((e,t)=>e.position-t.position),f=[...a.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,screenId:e.screenId||e.screenDraftId,isDraft:!0})),...l.map(e=>({...e.screen,isDraft:!1}))].sort((e,t)=>e.position-t.position),g=[...o.map(e=>({...e.data,scriptId:e.scriptId||e.scriptDraftId,diagnosisId:e.diagnosisId||e.diagnosisDraftId,isDraft:!0})),...c.map(e=>({...e.diagnosis,isDraft:!1}))].sort((e,t)=>e.position-t.position);return{data:function({searchValue:e,scripts:t,screens:s,diagnoses:i}){e=`${e||""}`.trim().toLowerCase();let r={};return t.forEach(t=>{let s=[];`${t.title||""}`.toLowerCase().match(e)&&s.push({field:"title",fieldValue:t.title}),`${t.printTitle||""}`.toLowerCase().match(e)&&s.push({field:"printTitle",fieldValue:t.printTitle}),s.length&&(r[t.scriptId]={title:t.title,scriptId:t.scriptId,diagnoses:[],screens:[],matches:s})}),s.forEach(t=>{let s=[];`${t.title||""}`.toLowerCase().match(e)&&s.push({field:"title",fieldValue:t.title}),`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"key",fieldValue:t.key}),`${t.refId||""}`.toLowerCase().match(e)&&s.push({field:"refId",fieldValue:`${t.refId||""}`}),`${t.label||""}`.toLowerCase().match(e)&&s.push({field:"label",fieldValue:t.label}),`${t.sectionTitle||""}`.toLowerCase().match(e)&&s.push({field:"sectionTitle",fieldValue:t.sectionTitle}),`${t.previewTitle||""}`.toLowerCase().match(e)&&s.push({field:"previewTitle",fieldValue:t.previewTitle}),`${t.previewPrintTitle||""}`.toLowerCase().match(e)&&s.push({field:"previewPrintTitle",fieldValue:t.previewPrintTitle}),`${t.condition||""}`.toLowerCase().match(e)&&s.push({field:"condition",fieldValue:t.condition}),(t.fields||[]).map((t,i)=>{`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"field_key",fieldIndex:i,fieldValue:t.key}),`${t.label||""}`.toLowerCase().match(e)&&s.push({field:"field_label",fieldIndex:i,fieldValue:t.label}),`${t.condition||""}`.toLowerCase().match(e)&&s.push({field:"field_condition",fieldIndex:i,fieldValue:t.condition}),(t.items||[]).map((t,r)=>{`${t.value||""}`.toLowerCase().match(e)&&s.push({field:"field_item_key",fieldIndex:i,fieldItemIndex:r,fieldValue:t.value}),`${t.label||""}`.toLowerCase().match(e)&&s.push({field:"field_item_label",fieldIndex:i,fieldItemIndex:r,fieldValue:t.label})})}),(t.items||[]).map((t,i)=>{`${t.id||""}`.toLowerCase().match(e)&&s.push({field:"item_id",fieldIndex:i,fieldValue:t.id}),`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"item_key",fieldIndex:i,fieldValue:t.key}),`${t.label||""}`.toLowerCase().match(e)&&s.push({field:"item_label",fieldIndex:i,fieldValue:t.label})}),(t.drugs||[]).map((t,i)=>{`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"drug",fieldIndex:i,fieldValue:t.key})}),(t.fluids||[]).map((t,i)=>{`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"fluid",fieldIndex:i,fieldValue:t.key})}),(t.feeds||[]).map((t,i)=>{`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"feed",fieldIndex:i,fieldValue:t.key})}),s.length&&(r[t.scriptId]=r[t.scriptId]||{title:"",scriptId:t.scriptId,diagnoses:[],screens:[],matches:[]},r[t.scriptId].screens.push({title:t.title,matches:s,screenId:t.screenId,isDraft:t.isDraft,fields:[...t.items.map(e=>({label:e.label,type:"item"})),...t.fields.map(e=>({label:e.label,type:"field"}))]}))}),i.forEach(t=>{let s=[];`${t.name||""}`.toLowerCase().match(e)&&s.push({field:"name",fieldValue:t.name}),`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"key",fieldValue:t.key}),`${t.expression||""}`.toLowerCase().match(e)&&s.push({field:"expression",fieldValue:t.expression}),(t.symptoms||[]).map((t,i)=>{`${t.key||""}`.toLowerCase().match(e)&&s.push({field:"diagnosis_symptom_key",fieldIndex:i,fieldValue:t.key}),`${t.name||""}`.toLowerCase().match(e)&&s.push({field:"diagnosis_symptom_name",fieldIndex:i,fieldValue:t.name}),`${t.expression||""}`.toLowerCase().match(e)&&s.push({field:"diagnosis_symptom_expression",fieldIndex:i,fieldValue:t.expression})}),s.length&&(r[t.scriptId]=r[t.scriptId]||{title:"",scriptId:t.scriptId,diagnoses:[],screens:[],matches:[]},r[t.scriptId].diagnoses.push({title:t.name||"",matches:s,diagnosisId:t.diagnosisId,isDraft:t.isDraft,fields:[...t.symptoms.map(e=>({label:e.name,type:"diagnosis_symptom"}))]}))}),Object.values(r)}({searchValue:e,screens:f,diagnoses:g,scripts:p})}}catch(e){return l.Z.error("_searchScripts ERROR",e.message),{errors:[e.message],data:[]}}}}};