"use strict";exports.id=1271,exports.ids=[1271],exports.modules={71271:(e,t,a)=>{a.r(t),a.d(t,{$$ACTION_0:()=>q,$$ACTION_1:()=>O,countAllDrafts:()=>E,discardDrafts:()=>F,getEditorDetails:()=>b,publishData:()=>C,revalidatePath:()=>A});var s=a(24330);a(60166);var i=a(57708),n=a(88317),r=a(57435),o=a(66267),d=a(57745),c=a(34149),l=a(10413),f=a(93567);async function g(e){try{let{items:t,broadcastAction:a}={...e},s=["configKeys"===t?(0,d.K0)(f.pendingDeletion.configKeyId):void 0,"drugsLibrary"===t?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0,"dataKeys"===t?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0,"scripts"===t?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,d.K0)(f.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0];return await l.Z.delete(f.pendingDeletion).where(s.length?(0,d.xD)(...s):void 0),a&&n.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return r.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function y(e){try{let{items:t}={...e},a=await l.Z.query.pendingDeletion.findMany({where:"configKeys"===t?(0,d.K0)(f.pendingDeletion.configKeyId):void 0});a.length&&await l.Z.update(f.configKeys).set({deletedAt:new Date}).where((0,d.d3)(f.configKeys.configKeyId,a.map(e=>e.configKeyId)));let s=await l.Z.query.pendingDeletion.findMany({where:"drugsLibrary"===t?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0}),i=await l.Z.query.pendingDeletion.findMany({where:"dataKeys"===t?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0});i.length&&await l.Z.update(f.dataKeys).set({deletedAt:new Date,name:(0,c.i6)`CONCAT(${f.dataKeys.name}, '_', ${f.dataKeys.uuid})`}).where((0,d.d3)(f.dataKeys.uuid,i.map(e=>e.dataKeyId))),s.length&&await l.Z.update(f.drugsLibrary).set({deletedAt:new Date,key:(0,c.i6)`CONCAT(${f.drugsLibrary.key}, '_', ${f.drugsLibrary.itemId})`}).where((0,d.d3)(f.drugsLibrary.itemId,s.map(e=>e.drugsLibraryItemId)));let n=await l.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId)):void 0});n.length&&(await l.Z.update(f.scripts).set({deletedAt:new Date}).where((0,d.d3)(f.scripts.scriptId,n.map(e=>e.scriptId))),await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.scriptId,n.map(e=>e.scriptId))),await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.scriptId,n.map(e=>e.scriptId))));let r=await l.Z.query.pendingDeletion.findMany({where:"screens"===t?(0,d.K0)(f.pendingDeletion.screenId):void 0});r.length&&await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.screenId,r.map(e=>e.screenId)));let o=await l.Z.query.pendingDeletion.findMany({where:"diagnoses"===t?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0});return o.length&&await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.diagnosisId,o.map(e=>e.diagnosisId))),await g(e),{success:!0}}catch(e){return r.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var u=a(25060),K=a(57368),p=a(10970),D=a(92963),w=a(17137),h=a(22418),m=a(30834),I=a(64102),Z=a(16916);async function v({data:e,increaseVersion:t,broadcastAction:a,syncSilently:s}){try{let i=await l.Z.query.editorInfo.findFirst();if(i){let a=t?i.dataVersion+1:i.dataVersion;await l.Z.update(f.editorInfo).set({...e,dataVersion:a}).where((0,d.eq)(f.editorInfo.id,i.id))}return(i=await l.Z.query.editorInfo.findFirst())&&a&&!s&&n.Z.emit("data_changed","save_editor_info"),{data:i||null,success:!!i}}catch(e){return r.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var R=a(18496),_=a(40618);async function b(){let e=[],t=!1;try{let a=await (0,R.y)();a.errors?.forEach(t=>e.push(t));let s=await u.Ur();s.errors?.forEach(t=>e.push(t));let{errors:i,...n}=await u.Yi();return i?.forEach(t=>e.push(t)),t=!!n.total||!!s.total,{pendingDeletion:s.total,drafts:n,errors:e.length?e:void 0,shouldPublishData:t,info:a.data}}catch(a){return r.Z.error("getEditorDetails ERROR",a.message),{errors:[a.message,...e],pendingDeletion:0,drafts:u.Ic,shouldPublishData:t,info:null}}}let A=(0,s.j)("ac5d4de4d5312ee7fa1967d05ccea3edfbd18033",q);async function q(e,t){return(0,i.revalidatePath)(e,t)}let E=(0,s.j)("294bf0d6332f28a618099d7c02669de60070f8a2",O);async function O(){try{let e=await w.G$(),t=await m.G$(),a=await Z.gc(),s=await K.co(),i=await K.ix(),n=await K.tW();return{configKeys:e.data.allDrafts,drugsLibrary:t.data.allDrafts,screens:s.data.allDrafts,scripts:i.data.allDrafts,diagnoses:n.data.allDrafts,dataKeys:a.data.allDrafts}}catch(e){return r.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,diagnoses:0}}}async function C(){let e={success:!0};try{await (0,o.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]);let t=await D.h(),a=await h.hA(),s=await I.Hc(),i=await p.Ls(),r=await p.Ry(),d=await p.gv(),c=await y();s.errors&&(e.success=!1,e.errors=[...e.errors||[],...s.errors]),t.errors&&(e.success=!1,e.errors=[...e.errors||[],...t.errors]),a.errors&&(e.success=!1,e.errors=[...e.errors||[],...a.errors]),i.errors&&(e.success=!1,e.errors=[...e.errors||[],...i.errors]),r.errors&&(e.success=!1,e.errors=[...e.errors||[],...r.errors]),d.errors&&(e.success=!1,e.errors=[...e.errors||[],...d.errors]),c.errors&&(e.success=!1,e.errors=[...e.errors||[],...c.errors]),await v({increaseVersion:e.success,broadcastAction:!0,data:{lastPublishDate:new Date}}),n.Z.emit("data_changed","publish_data")}catch(t){e.success=!1,e.errors=[t.message],r.Z.error("publishData ERROR",t.message)}finally{return e}}async function F(){let e={success:!0};try{await (0,o.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),await D.sj(),await h.Ms(),await I.F$(),await p.VQ(),await p.In(),await p.cF(),await g(),n.Z.emit("data_changed","discard_drafts")}catch(t){e.success=!1,e.errors=[t.message],r.Z.error("publishData ERROR",t.message)}finally{return e}}(0,_.h)([b,A,E,C,F]),(0,s.j)("354f249d3682e1a7ac814300889c8b929172be69",b),(0,s.j)("afc9c4d3ed7201152607116aa5f72d4579144ffc",A),(0,s.j)("3af78304ef3b80b391189cdb5be758ed14bb9be7",E),(0,s.j)("112a744ae93bf04aba1a4250d687a325a73a55c1",C),(0,s.j)("2995d4697010486034183adc4a3028bfd106123b",F)},92963:(e,t,a)=>{a.d(t,{sj:()=>f,LR:()=>g,h:()=>K,UZ:()=>l});var s=a(57745),i=a(81445),n=a(9576),r=a(57435),o=a(10413),d=a(93567),c=a(88317);async function l({data:e,broadcastAction:t}){let a={success:!1};try{let t=[];for(let{configKeyId:a,...r}of e)try{let e=a||n.Z();if(!t.length){let t=a?await o.Z.query.configKeysDrafts.findFirst({where:(0,s.eq)(d.configKeysDrafts.configKeyDraftId,e)}):null,n=t||!a?null:await o.Z.query.configKeys.findFirst({where:(0,s.eq)(d.configKeys.configKeyId,e)});if(t){let a={...t.data,...r};await o.Z.update(d.configKeysDrafts).set({data:a,position:a.position}).where((0,s.eq)(d.configKeysDrafts.configKeyDraftId,e))}else{let t=r.position||n?.position;if(!t){let e=await o.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeys.position)}),a=await o.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeysDrafts.position)});t=Math.max(0,e?.position||0,a?.position||0)+1}let a={...n,...r,configKeyId:e,version:n?.version?n.version+1:1,position:t};await o.Z.insert(d.configKeysDrafts).values({data:a,configKeyDraftId:e,position:a.position,configKeyId:n?.configKeyId})}}}catch(e){t.push(e.message)}t.length?a.errors=t:a.success=!0}catch(e){a.success=!1,a.errors=[e.message],r.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!a?.errors?.length&&t&&c.Z.emit("data_changed","save_config_keys"),a}}async function f(){try{return await o.Z.delete(d.configKeysDrafts),!0}catch(e){throw e}}async function g({configKeysIds:e,broadcastAction:t}){let a={success:!1};try{if(e.length){await o.Z.delete(d.configKeysDrafts).where((0,s.d3)(d.configKeysDrafts.configKeyDraftId,e));let t=(await o.Z.select({configKeyId:d.configKeys.configKeyId,pendingDeletion:d.pendingDeletion.configKeyId}).from(d.configKeys).leftJoin(d.pendingDeletion,(0,s.eq)(d.pendingDeletion.configKeyId,d.configKeys.configKeyId)).where((0,s.d3)(d.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion);t.length&&await o.Z.insert(d.pendingDeletion).values(t)}a.success=!0}catch(e){a.success=!1,a.errors=[e.message],r.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!a?.errors?.length&&t&&c.Z.emit("data_changed","delete_config_keys"),a}}async function y({previous:e,drafts:t}){try{let a=[];for(let s of t){let t={version:s?.data?.version||1,configKeyId:s?.data?.configKeyId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let a=e.filter(e=>e.configKeyId===s?.data?.configKeyId)[0],i=[],n=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=s.data[e],r={...a}[e];JSON.stringify(t)!==JSON.stringify(r)&&(i.push({[e]:r}),n.push({[e]:t}))}),t.changes={action:"update_config_key",description:"Update config key",oldValues:i,newValues:n}}a.push(t)}await o.Z.insert(d.configKeysHistory).values(a)}catch(e){r.Z.error(e.message)}}var u=a(34149);async function K(e){let t={success:!1};try{let e=[],a=[],i=await o.Z.query.configKeysDrafts.findMany();if(e=i.filter(e=>e.configKeyId),a=i.filter(e=>!e.configKeyId),e.length){let t=[];for(let{configKeyId:a,data:i}of(e.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,e.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),e)){let{configKeyId:e,id:t,oldConfigKeyId:n,createdAt:r,updatedAt:c,deletedAt:l,...f}=i,g={...f,publishDate:new Date};await o.Z.update(d.configKeys).set(g).where((0,s.eq)(d.configKeys.configKeyId,a)).returning()}await y({drafts:e,previous:t})}if(a.length){let e=[];for(let{id:t,data:i}of(a.filter(e=>e.configKeyId).length&&(e=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,a.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),a)){let e=i.configKeyId||(0,n.Z)(),s={...i,configKeyId:e};a=a.map(a=>(a.id===t&&(a.data.configKeyId=e),a)),await o.Z.insert(d.configKeys).values(s)}await y({drafts:a,previous:e})}await o.Z.delete(d.configKeysDrafts);let r=await o.Z.query.pendingDeletion.findMany({where:(0,s.K0)(d.pendingDeletion.configKeyId),columns:{configKeyId:!0},with:{configKey:{columns:{version:!0}}}});if((r=r.filter(e=>e.configKey)).length){let e=new Date;await o.Z.update(d.configKeys).set({deletedAt:e}).where((0,s.d3)(d.configKeys.configKeyId,r.map(e=>e.configKeyId))),await o.Z.insert(d.configKeysHistory).values(r.map(t=>({version:t.configKey.version,configKeyId:t.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await o.Z.delete(d.pendingDeletion).where((0,s.or)((0,s.K0)(d.pendingDeletion.configKeyId),(0,s.K0)(d.pendingDeletion.configKeyDraftId)));let c=[...e.map(e=>e.configKeyId),...r.map(e=>e.configKeyId)];c.length&&await o.Z.update(d.configKeys).set({version:(0,u.i6)`${d.configKeys.version} + 1`}).where((0,s.d3)(d.configKeys.configKeyId,c)),t.success=!0}catch(e){t.success=!1,t.errors=[e.message],r.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},17137:(e,t,a)=>{a.d(t,{G$:()=>y,ZV:()=>g,SL:()=>l,aP:()=>c});var s=a(57745),i=a(30900),n=a(9576),r=a(10413),o=a(93567),d=a(57435);async function c(e){try{let{configKeysIds:t,returnDraftsIfExist:a}={...e},d=t||[],c=d?.length?(0,s.d3)(o.configKeysDrafts.configKeyDraftId,d.map(e=>i.Z(e)?e:n.Z())):void 0,l=[...c?[c]:[]],f=a?await r.Z.query.configKeysDrafts.findMany({where:(0,s.xD)(...l)}):[];d=d.filter(e=>!f.map(e=>e.configKeyDraftId).includes(e));let g=f.length?(0,s.Nl)(o.configKeys.configKeyId,f.map(e=>e.configKeyDraftId)):void 0,y=d?.length?(0,s.d3)(o.configKeys.configKeyId,d.filter(e=>i.Z(e))):void 0,u=d?.length?(0,s.d3)(o.configKeys.oldConfigKeyId,d.filter(e=>!i.Z(e))):void 0,K=[(0,s.Ft)(o.configKeys.deletedAt),(0,s.Ft)(o.pendingDeletion),...y&&u?[(0,s.or)(y,u)]:[],g],p=(await r.Z.select({configKey:o.configKeys,pendingDeletion:o.pendingDeletion}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where(K.length?(0,s.xD)(...K):void 0)).map(e=>e.configKey),D=p.length?await r.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.configKeyId,p.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...p.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!D.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{configKeyId:t,returnDraftIfExists:a}={...e};try{if(!t)throw Error("Missing configKeyId");let e=i.Z(t)?(0,s.eq)(o.configKeys.configKeyId,t):void 0,n=i.Z(t)?void 0:(0,s.eq)(o.configKeys.oldConfigKeyId,t),d=e?(0,s.eq)(o.configKeysDrafts.configKeyDraftId,t):void 0,c=a&&d?await r.Z.query.configKeysDrafts.findFirst({where:e}):void 0,l=c?{...c.data,isDraft:!1,isDeleted:!1}:null;if(l)return{data:l};let f=await r.Z.query.configKeys.findFirst({where:(0,s.xD)((0,s.Ft)(o.configKeys.deletedAt),e||n),with:{draft:!0}});c=a?f?.draft:void 0;let g=c?.data||f;if(!(l=g?{...g,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:l}}catch(e){return d.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var f=a(60938);let g={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function y(){try{let[{count:e}]=await r.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts),[{count:t}]=await r.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,s.Ft)(o.configKeysDrafts.configKeyId)),[{count:a}]=await r.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,s.K0)(o.configKeysDrafts.configKeyId)),[{count:i}]=await r.Z.select({count:(0,f.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.configKeyId)),[{count:n}]=await r.Z.select({count:(0,f.QX)()}).from(o.configKeys);return{data:{allPublished:n,publishedWithDrafts:a,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:g,errors:[e.message]}}}},16916:(e,t,a)=>{a.d(t,{gc:()=>g,aW:()=>c});var s=a(57745),i=a(30900),n=a(9576),r=a(10413),o=a(93567),d=a(57435);async function c(e){try{let{dataKeysIds:t,returnDraftsIfExist:a=!0}={...e},d=t||[],c=d?.length?(0,s.d3)(o.dataKeysDrafts.uuid,d.map(e=>i.Z(e)?e:n.Z())):void 0,l=[...c?[c]:[]],f=a?await r.Z.query.dataKeysDrafts.findMany({where:(0,s.xD)(...l)}):[];d=d.filter(e=>!f.map(e=>e.uuid).includes(e));let g=f.length?(0,s.Nl)(o.dataKeys.uuid,f.map(e=>e.uuid)):void 0,y=d?.length?(0,s.d3)(o.dataKeys.uuid,d.filter(e=>i.Z(e))):void 0,u=[(0,s.Ft)(o.dataKeys.deletedAt),(0,s.Ft)(o.pendingDeletion),y,g],K=(await r.Z.select({dataKey:o.dataKeys,pendingDeletion:o.pendingDeletion}).from(o.dataKeys).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.dataKeyId,o.dataKeys.uuid)).where(u.length?(0,s.xD)(...u):void 0)).map(e=>e.dataKey),p=K.length?await r.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.dataKeyId,K.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...K.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>{let a=0;return e.label<t.label&&(a=-1),e.label>t.label&&(a=1),a}).filter(e=>!p.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return d.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var l=a(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function g(){try{let[{count:e}]=await r.Z.select({count:(0,l.QX)()}).from(o.dataKeysDrafts),[{count:t}]=await r.Z.select({count:(0,l.QX)()}).from(o.dataKeysDrafts).where((0,s.Ft)(o.dataKeysDrafts.dataKeyId)),[{count:a}]=await r.Z.select({count:(0,l.QX)()}).from(o.dataKeysDrafts).where((0,s.K0)(o.dataKeysDrafts.dataKeyId)),[{count:i}]=await r.Z.select({count:(0,l.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.dataKeyId)),[{count:n}]=await r.Z.select({count:(0,l.QX)()}).from(o.dataKeys);return{data:{allPublished:n,publishedWithDrafts:a,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getDataKeys ERROR",e.message),{data:f,errors:[e.message]}}}},18496:(e,t,a)=>{a.d(t,{y:()=>n});var s=a(10413),i=a(57435);async function n(){try{return{data:await s.Z.query.editorInfo.findFirst()||null}}catch(e){return i.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,t,a)=>{a.d(t,{Yi:()=>g,Ur:()=>l,Nb:()=>c,Ic:()=>f});var s=a(60938),i=a(57435),n=a(93567),r=a(10413),o=a(81445);let d={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function c(){try{let{lastPublishDate:e}={...await r.Z.query.editorInfo.findFirst()},t=await r.Z.select({configKeysDrafts:n.configKeysDrafts.updatedAt}).from(n.configKeysDrafts).orderBy((0,o.C)(n.configKeysDrafts.updatedAt)).limit(1),a=await r.Z.select({diagnosesDrafts:n.diagnosesDrafts.updatedAt}).from(n.diagnosesDrafts).orderBy((0,o.C)(n.diagnosesDrafts.updatedAt)).limit(1),s=await r.Z.select({screensDrafts:n.screensDrafts.updatedAt}).from(n.screensDrafts).orderBy((0,o.C)(n.screensDrafts.updatedAt)).limit(1),i=await r.Z.select({scriptsDrafts:n.scriptsDrafts.updatedAt}).from(n.scriptsDrafts).orderBy((0,o.C)(n.scriptsDrafts.updatedAt)).limit(1),c=await r.Z.select({configKeys:n.configKeys.updatedAt}).from(n.configKeys).orderBy((0,o.C)(n.configKeys.updatedAt)).limit(1),l=await r.Z.select({diagnoses:n.diagnoses.updatedAt}).from(n.diagnoses).orderBy((0,o.C)(n.diagnoses.updatedAt)).limit(1),f=await r.Z.select({screens:n.screens.updatedAt}).from(n.screens).orderBy((0,o.C)(n.screens.updatedAt)).limit(1),g=await r.Z.select({scripts:n.scripts.updatedAt}).from(n.scripts).orderBy((0,o.C)(n.scripts.updatedAt)).limit(1),y=await r.Z.select({pendingDeletion:n.pendingDeletion.createdAt}).from(n.pendingDeletion).orderBy((0,o.C)(n.pendingDeletion.createdAt)).limit(1),u={...d,...t[0],...a[0],...s[0],...i[0],...c[0],...l[0],...f[0],...g[0],...y[0],lastPublished:e||null},K=[e?new Date(e).getTime():null,...Object.values(u).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),p=e;return K.length&&(p=new Date(Math.max(...K))),{data:{...u,latestChangesDate:p}}}catch(e){return i.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:d,errors:[e.message]}}}async function l(){try{let e=await r.Z.select({count:(0,s.QX)()}).from(n.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return i.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let f={scripts:0,screens:0,diagnoses:0,configKeys:0,drugsLibraryItems:0,total:0,dataKeys:0};async function g(){let e={...f};try{let t=await r.Z.select({count:(0,s.QX)()}).from(n.scriptsDrafts);e.scripts=t[0]?.count||0;let a=await r.Z.select({count:(0,s.QX)()}).from(n.screensDrafts);e.screens=a[0]?.count||0;let i=await r.Z.select({count:(0,s.QX)()}).from(n.diagnosesDrafts);e.diagnoses=i[0]?.count||0;let o=await r.Z.select({count:(0,s.QX)()}).from(n.configKeysDrafts);e.configKeys=o[0]?.count||0;let d=await r.Z.select({count:(0,s.QX)()}).from(n.drugsLibraryDrafts);e.drugsLibraryItems=d[0]?.count||0;let c=await r.Z.select({count:(0,s.QX)()}).from(n.dataKeysDrafts);return e.dataKeys=c[0]?.count||0,e.total=Object.values(e).reduce((e,t)=>e+t,0),{...e}}catch(t){return i.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};