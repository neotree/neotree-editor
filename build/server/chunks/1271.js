"use strict";exports.id=1271,exports.ids=[1271],exports.modules={71271:(e,t,r)=>{r.r(t),r.d(t,{$$ACTION_0:()=>v,$$ACTION_1:()=>R,countAllDrafts:()=>_,discardDrafts:()=>A,getEditorDetails:()=>b,publishData:()=>q,revalidatePath:()=>L});var i=r(24330);r(60166);var s=r(57708),a=r(88317),n=r(57435),d=r(66267),o=r(57745),c=r(10413),l=r(43509);async function g(e){try{let{items:t,broadcastAction:r}={...e},i=["configKeys"===t?(0,o.K0)(l.pendingDeletion.configKeyId):void 0,"drugsLibrary"===t?(0,o.K0)(l.pendingDeletion.drugsLibraryItemId):void 0,"scripts"===t?(0,o.xD)((0,o.K0)(l.pendingDeletion.scriptId),(0,o.Ft)(l.pendingDeletion.screenId),(0,o.Ft)(l.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,o.K0)(l.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,o.K0)(l.pendingDeletion.diagnosisId):void 0];return await c.Z.delete(l.pendingDeletion).where(i.length?(0,o.xD)(...i):void 0),r&&a.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return n.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function f(e){try{let{items:t}={...e},r=await c.Z.query.pendingDeletion.findMany({where:"configKeys"===t?(0,o.K0)(l.pendingDeletion.configKeyId):void 0});r.length&&await c.Z.update(l.configKeys).set({deletedAt:new Date}).where((0,o.d3)(l.configKeys.configKeyId,r.map(e=>e.configKeyId)));let i=await c.Z.query.pendingDeletion.findMany({where:"drugsLibrary"===t?(0,o.K0)(l.pendingDeletion.drugsLibraryItemId):void 0});i.length&&await c.Z.update(l.drugsLibrary).set({deletedAt:new Date}).where((0,o.d3)(l.drugsLibrary.itemId,i.map(e=>e.drugsLibraryItemId)));let s=await c.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,o.xD)((0,o.K0)(l.pendingDeletion.scriptId),(0,o.Ft)(l.pendingDeletion.screenId),(0,o.Ft)(l.pendingDeletion.diagnosisId)):void 0});s.length&&(await c.Z.update(l.scripts).set({deletedAt:new Date}).where((0,o.d3)(l.scripts.scriptId,s.map(e=>e.scriptId))),await c.Z.update(l.screens).set({deletedAt:new Date}).where((0,o.d3)(l.screens.scriptId,s.map(e=>e.scriptId))),await c.Z.update(l.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(l.diagnoses.scriptId,s.map(e=>e.scriptId))));let a=await c.Z.query.pendingDeletion.findMany({where:"screens"===t?(0,o.K0)(l.pendingDeletion.screenId):void 0});a.length&&await c.Z.update(l.screens).set({deletedAt:new Date}).where((0,o.d3)(l.screens.screenId,a.map(e=>e.screenId)));let n=await c.Z.query.pendingDeletion.findMany({where:"diagnoses"===t?(0,o.K0)(l.pendingDeletion.diagnosisId):void 0});return n.length&&await c.Z.update(l.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(l.diagnoses.diagnosisId,n.map(e=>e.diagnosisId))),await g(e),{success:!0}}catch(e){return n.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var u=r(25060),y=r(38301),p=r(91966),m=r(92963),D=r(17137),w=r(41771),I=r(30834);async function h({data:e,increaseVersion:t,broadcastAction:r}){try{let i=await c.Z.query.editorInfo.findFirst();if(i){let r=t?i.dataVersion+1:i.dataVersion;await c.Z.update(l.editorInfo).set({...e,dataVersion:r}).where((0,o.eq)(l.editorInfo.id,i.id))}return(i=await c.Z.query.editorInfo.findFirst())&&r&&a.Z.emit("data_changed","save_editor_info"),{data:i||null,success:!!i}}catch(e){return n.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var K=r(18496),Z=r(40618);async function b(){let e=[],t=!1;try{let r=await (0,K.y)();r.errors?.forEach(t=>e.push(t));let i=await u.Ur();i.errors?.forEach(t=>e.push(t));let{errors:s,...a}=await u.Yi();return s?.forEach(t=>e.push(t)),t=!!a.total||!!i.total,{pendingDeletion:i.total,drafts:a,errors:e.length?e:void 0,shouldPublishData:t,info:r.data}}catch(r){return n.Z.error("getEditorDetails ERROR",r.message),{errors:[r.message,...e],pendingDeletion:0,drafts:u.Ic,shouldPublishData:t,info:null}}}let L=(0,i.j)("ac5d4de4d5312ee7fa1967d05ccea3edfbd18033",v);async function v(e,t){return(0,s.revalidatePath)(e,t)}let _=(0,i.j)("294bf0d6332f28a618099d7c02669de60070f8a2",R);async function R(){try{let e=await D.G$(),t=await I.G$(),r=await y.co(),i=await y.ix(),s=await y.tW();return{configKeys:e.data.allDrafts,drugsLibrary:t.data.allDrafts,screens:r.data.allDrafts,scripts:i.data.allDrafts,diagnoses:s.data.allDrafts}}catch(e){return n.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,diagnoses:0}}}async function q(){let e={success:!0};try{await (0,d.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]);let t=await m.h(),r=await w.hA(),i=await p.Ls(),s=await p.Ry(),n=await p.gv(),o=await f();t.errors&&(e.success=!1,e.errors=[...e.errors||[],...t.errors]),r.errors&&(e.success=!1,e.errors=[...e.errors||[],...r.errors]),i.errors&&(e.success=!1,e.errors=[...e.errors||[],...i.errors]),s.errors&&(e.success=!1,e.errors=[...e.errors||[],...s.errors]),n.errors&&(e.success=!1,e.errors=[...e.errors||[],...n.errors]),o.errors&&(e.success=!1,e.errors=[...e.errors||[],...o.errors]),await h({increaseVersion:e.success,broadcastAction:!0,data:{lastPublishDate:new Date}}),a.Z.emit("data_changed","publish_data")}catch(t){e.success=!1,e.errors=[t.message],n.Z.error("publishData ERROR",t.message)}finally{return e}}async function A(){let e={success:!0};try{await (0,d.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),await m.sj(),await w.Ms(),await p.VQ(),await p.In(),await p.cF(),await g(),a.Z.emit("data_changed","discard_drafts")}catch(t){e.success=!1,e.errors=[t.message],n.Z.error("publishData ERROR",t.message)}finally{return e}}(0,Z.h)([b,L,_,q,A]),(0,i.j)("354f249d3682e1a7ac814300889c8b929172be69",b),(0,i.j)("afc9c4d3ed7201152607116aa5f72d4579144ffc",L),(0,i.j)("3af78304ef3b80b391189cdb5be758ed14bb9be7",_),(0,i.j)("112a744ae93bf04aba1a4250d687a325a73a55c1",q),(0,i.j)("2995d4697010486034183adc4a3028bfd106123b",A)},92963:(e,t,r)=>{r.d(t,{sj:()=>g,LR:()=>f,h:()=>p,UZ:()=>l});var i=r(57745),s=r(81445),a=r(9576),n=r(57435),d=r(10413),o=r(43509),c=r(88317);async function l({data:e,broadcastAction:t}){let r={success:!1};try{let t=[];for(let{configKeyId:r,...n}of e)try{let e=r||a.Z();if(!t.length){let t=r?await d.Z.query.configKeysDrafts.findFirst({where:(0,i.eq)(o.configKeysDrafts.configKeyDraftId,e)}):null,a=t||!r?null:await d.Z.query.configKeys.findFirst({where:(0,i.eq)(o.configKeys.configKeyId,e)});if(t){let r={...t.data,...n};await d.Z.update(o.configKeysDrafts).set({data:r,position:r.position}).where((0,i.eq)(o.configKeysDrafts.configKeyDraftId,e))}else{let t=n.position||a?.position;if(!t){let e=await d.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,s.C)(o.configKeys.position)}),r=await d.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,s.C)(o.configKeysDrafts.position)});t=Math.max(0,e?.position||0,r?.position||0)+1}let r={...a,...n,configKeyId:e,version:a?.version?a.version+1:1,position:t};await d.Z.insert(o.configKeysDrafts).values({data:r,configKeyDraftId:e,position:r.position,configKeyId:a?.configKeyId})}}}catch(e){t.push(e.message)}t.length?r.errors=t:r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!r?.errors?.length&&t&&c.Z.emit("data_changed","save_config_keys"),r}}async function g(){try{return await d.Z.delete(o.configKeysDrafts),!0}catch(e){throw e}}async function f({configKeysIds:e,broadcastAction:t}){let r={success:!1};try{if(e.length){await d.Z.delete(o.configKeysDrafts).where((0,i.d3)(o.configKeysDrafts.configKeyDraftId,e));let t=(await d.Z.select({configKeyId:o.configKeys.configKeyId,pendingDeletion:o.pendingDeletion.configKeyId}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,i.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where((0,i.d3)(o.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion);t.length&&await d.Z.insert(o.pendingDeletion).values(t)}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!r?.errors?.length&&t&&c.Z.emit("data_changed","delete_config_keys"),r}}async function u({previous:e,drafts:t}){try{let r=[];for(let i of t){let t={version:i?.data?.version||1,configKeyId:i?.data?.configKeyId,changes:{}};if(i?.data?.version===1)t.changes={action:"create_config_key",deconfigKeyion:"Create config key",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.configKeyId===i?.data?.configKeyId)[0],s=[],a=[];Object.keys({...i?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=i.data[e],n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(s.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_config_key",description:"Update config key",oldValues:s,newValues:a}}r.push(t)}await d.Z.insert(o.configKeysHistory).values(r)}catch(e){n.Z.error(e.message)}}var y=r(34149);async function p(e){let t={success:!1};try{let e=[],r=[],s=await d.Z.query.configKeysDrafts.findMany();if(e=s.filter(e=>e.configKeyId),r=s.filter(e=>!e.configKeyId),e.length){let t=[];for(let{configKeyId:r,data:s}of(e.filter(e=>e.configKeyId).length&&(t=await d.Z.query.configKeys.findMany({where:(0,i.d3)(o.configKeys.configKeyId,e.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),e)){let{configKeyId:e,id:t,oldConfigKeyId:a,createdAt:n,updatedAt:c,deletedAt:l,...g}=s,f={...g,publishDate:new Date};await d.Z.update(o.configKeys).set(f).where((0,i.eq)(o.configKeys.configKeyId,r)).returning()}await u({drafts:e,previous:t})}if(r.length){let e=[];for(let{id:t,data:s}of(r.filter(e=>e.configKeyId).length&&(e=await d.Z.query.configKeys.findMany({where:(0,i.d3)(o.configKeys.configKeyId,r.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),r)){let e=s.configKeyId||(0,a.Z)(),i={...s,configKeyId:e};r=r.map(r=>(r.id===t&&(r.data.configKeyId=e),r)),await d.Z.insert(o.configKeys).values(i)}await u({drafts:r,previous:e})}await d.Z.delete(o.configKeysDrafts);let n=await d.Z.query.pendingDeletion.findMany({where:(0,i.K0)(o.pendingDeletion.configKeyId),columns:{configKeyId:!0},with:{configKey:{columns:{version:!0}}}});if((n=n.filter(e=>e.configKey)).length){let e=new Date;await d.Z.update(o.configKeys).set({deletedAt:e}).where((0,i.d3)(o.configKeys.configKeyId,n.map(e=>e.configKeyId))),await d.Z.insert(o.configKeysHistory).values(n.map(t=>({version:t.configKey.version,configKeyId:t.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,i.or)((0,i.K0)(o.pendingDeletion.configKeyId),(0,i.K0)(o.pendingDeletion.configKeyDraftId)));let c=[...e.map(e=>e.configKeyId),...n.map(e=>e.configKeyId)];c.length&&await d.Z.update(o.configKeys).set({version:(0,y.i6)`${o.configKeys.version} + 1`}).where((0,i.d3)(o.configKeys.configKeyId,c)),t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},41771:(e,t,r)=>{r.d(t,{Ms:()=>g,Nq:()=>f,hA:()=>p,$s:()=>l});var i=r(57745),s=r(81445),a=r(9576),n=r(57435),d=r(10413),o=r(43509),c=r(88317);async function l({data:e,broadcastAction:t}){let r={success:!1};try{let t=[];for(let{itemId:r,...n}of e)try{let e=r||a.Z();if(!t.length){let t=r?await d.Z.query.drugsLibraryDrafts.findFirst({where:(0,i.eq)(o.drugsLibraryDrafts.itemDraftId,e)}):null,a=t||!r?null:await d.Z.query.drugsLibrary.findFirst({where:(0,i.eq)(o.drugsLibrary.itemId,e)});if(t){let r={...t.data,...n};await d.Z.update(o.drugsLibraryDrafts).set({data:r,position:r.position}).where((0,i.eq)(o.drugsLibraryDrafts.itemDraftId,e))}else{let t=n.position||a?.position;if(!t){let e=await d.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,s.C)(o.drugsLibrary.position)}),r=await d.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,s.C)(o.drugsLibraryDrafts.position)});t=Math.max(0,e?.position||0,r?.position||0)+1}let r={...a,...n,itemId:e,version:a?.version?a.version+1:1,position:t};await d.Z.insert(o.drugsLibraryDrafts).values({data:r,itemDraftId:e,position:r.position,itemId:a?.itemId,key:r.key})}}}catch(e){t.push(e.message)}t.length?r.errors=t:r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&t&&c.Z.emit("data_changed","save_drugs_library_items"),r}}async function g(){try{return await d.Z.delete(o.drugsLibraryDrafts),!0}catch(e){throw e}}async function f({itemsIds:e,broadcastAction:t}){let r={success:!1};try{if(e.length){await d.Z.delete(o.drugsLibraryDrafts).where((0,i.d3)(o.drugsLibraryDrafts.itemDraftId,e));let t=(await d.Z.select({drugsLibraryItemId:o.drugsLibrary.itemId,pendingDeletion:o.pendingDeletion.drugsLibraryItemId}).from(o.drugsLibrary).leftJoin(o.pendingDeletion,(0,i.eq)(o.pendingDeletion.drugsLibraryItemId,o.drugsLibrary.itemId)).where((0,i.d3)(o.drugsLibrary.itemId,e))).filter(e=>!e.pendingDeletion);t.length&&await d.Z.insert(o.pendingDeletion).values(t)}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&t&&c.Z.emit("data_changed","delete_drugs_library_items"),r}}async function u({previous:e,drafts:t}){try{let r=[];for(let i of t){let t={version:i?.data?.version||1,itemId:i?.data?.itemId,changes:{}};if(i?.data?.version===1)t.changes={action:"create_drugs_library_item",dedrugsLibraryItemion:"Create drugs library item",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.itemId===i?.data?.itemId)[0],s=[],a=[];Object.keys({...i?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=i.data[e],n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(s.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:s,newValues:a}}r.push(t)}await d.Z.insert(o.drugsLibraryHistory).values(r)}catch(e){n.Z.error(e.message)}}var y=r(34149);async function p(e){let t={success:!1};try{let e=[],r=[],s=await d.Z.query.drugsLibraryDrafts.findMany();if(e=s.filter(e=>e.itemId),r=s.filter(e=>!e.itemId),e.length){let t=[];for(let{itemId:r,data:s}of(e.filter(e=>e.itemId).length&&(t=await d.Z.query.drugsLibrary.findMany({where:(0,i.d3)(o.drugsLibrary.itemId,e.filter(e=>e.itemId).map(e=>e.itemId))})),e)){let{itemId:e,id:t,createdAt:a,updatedAt:n,deletedAt:c,...l}=s,g={...l,publishDate:new Date};await d.Z.update(o.drugsLibrary).set(g).where((0,i.eq)(o.drugsLibrary.itemId,r)).returning()}await u({drafts:e,previous:t})}if(r.length){let e=[];for(let{id:t,data:s}of(r.filter(e=>e.itemId).length&&(e=await d.Z.query.drugsLibrary.findMany({where:(0,i.d3)(o.drugsLibrary.itemId,r.filter(e=>e.itemId).map(e=>e.itemId))})),r)){let e=s.itemId||(0,a.Z)(),i={...s,itemId:e};r=r.map(r=>(r.id===t&&(r.data.itemId=e),r)),await d.Z.insert(o.drugsLibrary).values(i)}await u({drafts:r,previous:e})}await d.Z.delete(o.drugsLibraryDrafts);let n=await d.Z.query.pendingDeletion.findMany({where:(0,i.K0)(o.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0}}}});if((n=n.filter(e=>e.drugsLibraryItem)).length){let e=new Date;await d.Z.update(o.drugsLibrary).set({deletedAt:e}).where((0,i.d3)(o.drugsLibrary.itemId,n.map(e=>e.drugsLibraryItemId))),await d.Z.insert(o.drugsLibraryHistory).values(n.map(t=>({version:t.drugsLibraryItem.version,itemId:t.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,i.or)((0,i.K0)(o.pendingDeletion.drugsLibraryItemId),(0,i.K0)(o.pendingDeletion.drugsLibraryItemDraftId)));let c=[...e.map(e=>e.itemId),...n.map(e=>e.drugsLibraryItemId)];c.length&&await d.Z.update(o.drugsLibrary).set({version:(0,y.i6)`${o.drugsLibrary.version} + 1`}).where((0,i.d3)(o.drugsLibrary.itemId,c)),t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_publishDrugsLibraryItems ERROR",e)}finally{return t}}},17137:(e,t,r)=>{r.d(t,{G$:()=>u,ZV:()=>f,SL:()=>l,aP:()=>c});var i=r(57745),s=r(30900),a=r(9576),n=r(10413),d=r(43509),o=r(57435);async function c(e){try{let{configKeysIds:t,returnDraftsIfExist:r}={...e},o=t||[],c=o?.length?(0,i.d3)(d.configKeysDrafts.configKeyDraftId,o.map(e=>s.Z(e)?e:a.Z())):void 0,l=[...c?[c]:[]],g=r?await n.Z.query.configKeysDrafts.findMany({where:(0,i.xD)(...l)}):[];o=o.filter(e=>!g.map(e=>e.configKeyDraftId).includes(e));let f=g.length?(0,i.Nl)(d.configKeys.configKeyId,g.map(e=>e.configKeyDraftId)):void 0,u=o?.length?(0,i.d3)(d.configKeys.configKeyId,o.filter(e=>s.Z(e))):void 0,y=o?.length?(0,i.d3)(d.configKeys.oldConfigKeyId,o.filter(e=>!s.Z(e))):void 0,p=[(0,i.Ft)(d.configKeys.deletedAt),(0,i.Ft)(d.pendingDeletion),...u&&y?[(0,i.or)(u,y)]:[],f],m=(await n.Z.select({configKey:d.configKeys,pendingDeletion:d.pendingDeletion}).from(d.configKeys).leftJoin(d.pendingDeletion,(0,i.eq)(d.pendingDeletion.configKeyId,d.configKeys.configKeyId)).where(p.length?(0,i.xD)(...p):void 0)).map(e=>e.configKey),D=m.length?await n.Z.query.pendingDeletion.findMany({where:(0,i.d3)(d.pendingDeletion.configKeyId,m.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...m.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!D.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return o.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{configKeyId:t,returnDraftIfExists:r}={...e};try{if(!t)throw Error("Missing configKeyId");let e=s.Z(t)?(0,i.eq)(d.configKeys.configKeyId,t):void 0,a=s.Z(t)?void 0:(0,i.eq)(d.configKeys.oldConfigKeyId,t),o=e?(0,i.eq)(d.configKeysDrafts.configKeyDraftId,t):void 0,c=r&&o?await n.Z.query.configKeysDrafts.findFirst({where:e}):void 0,l=c?{...c.data,isDraft:!1,isDeleted:!1}:null;if(l)return{data:l};let g=await n.Z.query.configKeys.findFirst({where:(0,i.xD)((0,i.Ft)(d.configKeys.deletedAt),e||a),with:{draft:!0}});c=r?g?.draft:void 0;let f=c?.data||g;if(!(l=f?{...f,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:l}}catch(e){return o.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var g=r(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await n.Z.select({count:(0,g.QX)()}).from(d.configKeysDrafts),[{count:t}]=await n.Z.select({count:(0,g.QX)()}).from(d.configKeysDrafts).where((0,i.Ft)(d.configKeysDrafts.configKeyId)),[{count:r}]=await n.Z.select({count:(0,g.QX)()}).from(d.configKeysDrafts).where((0,i.K0)(d.configKeysDrafts.configKeyId)),[{count:s}]=await n.Z.select({count:(0,g.QX)()}).from(d.pendingDeletion).where((0,i.K0)(d.pendingDeletion.configKeyId)),[{count:a}]=await n.Z.select({count:(0,g.QX)()}).from(d.configKeys);return{data:{allPublished:a,publishedWithDrafts:r,allDrafts:e,newDrafts:t,pendingDeletion:s}}}catch(e){return o.Z.error("_getConfigKeys ERROR",e.message),{data:f,errors:[e.message]}}}},30834:(e,t,r)=>{r.d(t,{G$:()=>u,s:()=>f,t3:()=>l,fP:()=>c});var i=r(57745),s=r(30900),a=r(9576),n=r(10413),d=r(43509),o=r(57435);async function c(e){try{let{itemsIds:t,keys:r,returnDraftsIfExist:o}={...e},c=t||[],l=r||[],g=l?.length?(0,i.d3)(d.drugsLibraryDrafts.key,l):void 0,f=c?.length?(0,i.d3)(d.drugsLibraryDrafts.itemDraftId,c.map(e=>s.Z(e)?e:a.Z())):void 0,u=[...g?[g]:[],...f?[f]:[]],y=o?await n.Z.query.drugsLibraryDrafts.findMany({where:(0,i.xD)(...u)}):[];c=c.filter(e=>!y.map(e=>e.itemDraftId).includes(e)),l=l.filter(e=>!y.map(e=>e.key).includes(e));let p=l?.length?(0,i.d3)(d.drugsLibrary.key,l):void 0,m=y.length?(0,i.Nl)(d.drugsLibrary.itemId,y.map(e=>e.itemDraftId)):void 0,D=c?.length?(0,i.d3)(d.drugsLibrary.itemId,c.filter(e=>s.Z(e))):void 0,w=[(0,i.Ft)(d.drugsLibrary.deletedAt),(0,i.Ft)(d.pendingDeletion),m,D,p],I=(await n.Z.select({drugsLibraryItem:d.drugsLibrary,pendingDeletion:d.pendingDeletion}).from(d.drugsLibrary).leftJoin(d.pendingDeletion,(0,i.eq)(d.pendingDeletion.drugsLibraryItemId,d.drugsLibrary.itemId)).where(w.length?(0,i.xD)(...w):void 0)).map(e=>e.drugsLibraryItem),h=I.length?await n.Z.query.pendingDeletion.findMany({where:(0,i.d3)(d.pendingDeletion.drugsLibraryItemId,I.map(e=>e.itemId)),columns:{drugsLibraryItemId:!0}}):[];return{data:[...I.map(e=>({...e,isDraft:!1,isDeleted:!1})),...y.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!h.map(e=>e.drugsLibraryItemId).includes(e.itemId))}}catch(e){return o.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{itemId:t,returnDraftIfExists:r}={...e};try{if(!t)throw Error("Missing itemId");let e=s.Z(t)?(0,i.eq)(d.drugsLibrary.itemId,t):void 0,a=e?(0,i.eq)(d.drugsLibraryDrafts.itemDraftId,t):void 0,o=r&&a?await n.Z.query.drugsLibraryDrafts.findFirst({where:e}):void 0,c=o?{...o.data,isDraft:!1,isDeleted:!1}:null;if(c)return{data:c};let l=await n.Z.query.drugsLibrary.findFirst({where:(0,i.xD)((0,i.Ft)(d.drugsLibrary.deletedAt)),with:{draft:!0}});o=r?l?.draft:void 0;let g=o?.data||l;if(!(c=g?{...g,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return o.Z.error("_getDrugsLibraryItem ERROR",e.message),{errors:[e.message]}}}var g=r(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await n.Z.select({count:(0,g.QX)()}).from(d.drugsLibraryDrafts),[{count:t}]=await n.Z.select({count:(0,g.QX)()}).from(d.drugsLibraryDrafts).where((0,i.Ft)(d.drugsLibraryDrafts.itemId)),[{count:r}]=await n.Z.select({count:(0,g.QX)()}).from(d.drugsLibraryDrafts).where((0,i.K0)(d.drugsLibraryDrafts.itemId)),[{count:s}]=await n.Z.select({count:(0,g.QX)()}).from(d.pendingDeletion).where((0,i.K0)(d.pendingDeletion.drugsLibraryItemId)),[{count:a}]=await n.Z.select({count:(0,g.QX)()}).from(d.drugsLibrary);return{data:{allPublished:a,publishedWithDrafts:r,allDrafts:e,newDrafts:t,pendingDeletion:s}}}catch(e){return o.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:f,errors:[e.message]}}}},18496:(e,t,r)=>{r.d(t,{y:()=>a});var i=r(10413),s=r(57435);async function a(){try{return{data:await i.Z.query.editorInfo.findFirst()||null}}catch(e){return s.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,t,r)=>{r.d(t,{Yi:()=>f,Ur:()=>l,Nb:()=>c,Ic:()=>g});var i=r(60938),s=r(57435),a=r(43509),n=r(10413),d=r(81445);let o={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function c(){try{let{lastPublishDate:e}={...await n.Z.query.editorInfo.findFirst()},t=await n.Z.select({configKeysDrafts:a.configKeysDrafts.updatedAt}).from(a.configKeysDrafts).orderBy((0,d.C)(a.configKeysDrafts.updatedAt)).limit(1),r=await n.Z.select({diagnosesDrafts:a.diagnosesDrafts.updatedAt}).from(a.diagnosesDrafts).orderBy((0,d.C)(a.diagnosesDrafts.updatedAt)).limit(1),i=await n.Z.select({screensDrafts:a.screensDrafts.updatedAt}).from(a.screensDrafts).orderBy((0,d.C)(a.screensDrafts.updatedAt)).limit(1),s=await n.Z.select({scriptsDrafts:a.scriptsDrafts.updatedAt}).from(a.scriptsDrafts).orderBy((0,d.C)(a.scriptsDrafts.updatedAt)).limit(1),c=await n.Z.select({configKeys:a.configKeys.updatedAt}).from(a.configKeys).orderBy((0,d.C)(a.configKeys.updatedAt)).limit(1),l=await n.Z.select({diagnoses:a.diagnoses.updatedAt}).from(a.diagnoses).orderBy((0,d.C)(a.diagnoses.updatedAt)).limit(1),g=await n.Z.select({screens:a.screens.updatedAt}).from(a.screens).orderBy((0,d.C)(a.screens.updatedAt)).limit(1),f=await n.Z.select({scripts:a.scripts.updatedAt}).from(a.scripts).orderBy((0,d.C)(a.scripts.updatedAt)).limit(1),u=await n.Z.select({pendingDeletion:a.pendingDeletion.createdAt}).from(a.pendingDeletion).orderBy((0,d.C)(a.pendingDeletion.createdAt)).limit(1),y={...o,...t[0],...r[0],...i[0],...s[0],...c[0],...l[0],...g[0],...f[0],...u[0],lastPublished:e||null},p=[e?new Date(e).getTime():null,...Object.values(y).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),m=e;return p.length&&(m=new Date(Math.max(...p))),{data:{...y,latestChangesDate:m}}}catch(e){return s.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:o,errors:[e.message]}}}async function l(){try{let e=await n.Z.select({count:(0,i.QX)()}).from(a.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return s.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let g={scripts:0,screens:0,diagnoses:0,configKeys:0,drugsLibraryItems:0,total:0};async function f(){let e={...g};try{let t=await n.Z.select({count:(0,i.QX)()}).from(a.scriptsDrafts);e.scripts=t[0]?.count||0;let r=await n.Z.select({count:(0,i.QX)()}).from(a.screensDrafts);e.screens=r[0]?.count||0;let s=await n.Z.select({count:(0,i.QX)()}).from(a.diagnosesDrafts);e.diagnoses=s[0]?.count||0;let d=await n.Z.select({count:(0,i.QX)()}).from(a.configKeysDrafts);e.configKeys=d[0]?.count||0;let o=await n.Z.select({count:(0,i.QX)()}).from(a.drugsLibraryDrafts);return e.drugsLibraryItems=o[0]?.count||0,e.total=e.configKeys+e.diagnoses+e.screens+e.scripts+e.drugsLibraryItems,{...e}}catch(t){return s.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};