"use strict";exports.id=1271,exports.ids=[1271],exports.modules={71271:(e,a,t)=>{t.r(a),t.d(a,{$$ACTION_0:()=>S,$$ACTION_1:()=>B,countAllDrafts:()=>V,discardDrafts:()=>C,getEditorDetails:()=>O,publishData:()=>E,revalidatePath:()=>P});var s=t(24330);t(60166);var r=t(57708),i=t(88317),n=t(57435),o=t(66267),d=t(57745),c=t(34149),l=t(10413),f=t(93567);async function u(e){try{let{items:a,broadcastAction:t}={...e},s=["configKeys"===a?(0,d.K0)(f.pendingDeletion.configKeyId):void 0,"drugsLibrary"===a?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0,"dataKeys"===a?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0,"scripts"===a?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId)):void 0,"screens"===a?(0,d.K0)(f.pendingDeletion.screenId):void 0,"diagnoses"===a?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0];return await l.Z.delete(f.pendingDeletion).where(s.length?(0,d.xD)(...s):void 0),t&&i.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return n.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function p(e){try{let{items:a}={...e},t=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("configKeys"===a?(0,d.K0)(f.pendingDeletion.configKeyId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});t.length&&await l.Z.update(f.configKeys).set({deletedAt:new Date}).where((0,d.d3)(f.configKeys.configKeyId,t.map(e=>e.configKeyId)));let s=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("drugsLibrary"===a?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)}),r=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("dataKeys"===a?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});r.length&&await l.Z.update(f.dataKeys).set({deletedAt:new Date,name:(0,c.i6)`CONCAT(${f.dataKeys.name}, '_', ${f.dataKeys.uuid})`}).where((0,d.d3)(f.dataKeys.uuid,r.map(e=>e.dataKeyId))),s.length&&await l.Z.update(f.drugsLibrary).set({deletedAt:new Date,key:(0,c.i6)`CONCAT(${f.drugsLibrary.key}, '_', ${f.drugsLibrary.itemId})`}).where((0,d.d3)(f.drugsLibrary.itemId,s.map(e=>e.drugsLibraryItemId)));let i=await l.Z.query.pendingDeletion.findMany({where:"scripts"===a?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId),e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0):void 0});i.length&&(await l.Z.update(f.scripts).set({deletedAt:new Date}).where((0,d.d3)(f.scripts.scriptId,i.map(e=>e.scriptId))),await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.scriptId,i.map(e=>e.scriptId))),await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.scriptId,i.map(e=>e.scriptId))));let n=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("screens"===a?(0,d.K0)(f.pendingDeletion.screenId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});n.length&&await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.screenId,n.map(e=>e.screenId)));let o=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("diagnoses"===a?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});return o.length&&await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.diagnosisId,o.map(e=>e.diagnosisId))),await u(e),{success:!0}}catch(e){return n.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var g=t(25060),y=t(21162),h=t(45241),D=t(92963),w=t(17137),I=t(73543),K=t(20084),m=t(22418),Z=t(88781),R=t(88778),v=t(48578),b=t(16916),k=t(82102);async function _({data:e,increaseVersion:a,broadcastAction:t,syncSilently:s}){try{let r=await l.Z.query.editorInfo.findFirst();if(r){let t=a?r.dataVersion+1:r.dataVersion;await l.Z.update(f.editorInfo).set({...e,dataVersion:t}).where((0,d.eq)(f.editorInfo.id,r.id))}return(r=await l.Z.query.editorInfo.findFirst())&&t&&!s&&i.Z.emit("data_changed","save_editor_info"),{data:r||null,success:!!r}}catch(e){return n.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var q=t(18496),U=t(36864),A=t(40618);async function O(){let e=[],a=!1;try{let t=await (0,q.y)();t.errors?.forEach(a=>e.push(a));let s=await g.Ur();s.errors?.forEach(a=>e.push(a));let{errors:r,...i}=await g.Yi();return r?.forEach(a=>e.push(a)),a=!!i.total||!!s.total,{pendingDeletion:s.total,drafts:i,errors:e.length?e:void 0,shouldPublishData:a,info:t.data}}catch(t){return n.Z.error("getEditorDetails ERROR",t.message),{errors:[t.message,...e],pendingDeletion:0,drafts:g.Ic,shouldPublishData:a,info:null}}}let P=(0,s.j)("a51a2d6c6369fbe75939846346b95c575004df1d",S);async function S(e,a){return(0,r.revalidatePath)(e,a)}let V=(0,s.j)("e5fa07e4fdc4dcce863b886208c69a80b05c95d4",B);async function B(){try{let e=await w.G$(),a=await K.Py(),t=await Z.G$(),s=await b.gc(),r=await y.co(),i=await y.ix(),n=await y.tW(),o=await k.Eu(),d=await k.Du();return{configKeys:e.data.allDrafts,hospitals:a.data.allDrafts,drugsLibrary:t.data.allDrafts,screens:r.data.allDrafts,scripts:i.data.allDrafts,diagnoses:n.data.allDrafts,dataKeys:s.data.allDrafts,appUpdatePolicies:o.data.allDrafts,apkReleases:d.data.allDrafts}}catch(e){return n.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,hospitals:0,diagnoses:0}}}async function E({scope:e}){let a={success:!0};try{let t=await (0,o.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]),s=t?.user?.userId||null,r=s;1===e&&(r=null);let d=await (0,q.y)(),c=(d.data?.dataVersion||1)+1,l=await D.h({userId:r,publisherUserId:s,dataVersion:c}),f=await I.fn({userId:r,publisherUserId:s,dataVersion:c}),u=await m.hA({userId:r,publisherUserId:s,dataVersion:c}),g=await R.Hc({userId:r,publisherUserId:s,dataVersion:c}),y=await h.Ls({userId:r,publisherUserId:s,dataVersion:c}),w=await h.Ry({userId:r,publisherUserId:s,dataVersion:c}),K=await h.gv({userId:r,publisherUserId:s,dataVersion:c}),Z=await v.CA({userId:r}),b=await v.O0({userId:r}),k=await p({userId:r,publisherUserId:s||void 0});g.errors&&(a.success=!1,a.errors=[...a.errors||[],...g.errors]),l.errors&&(a.success=!1,a.errors=[...a.errors||[],...l.errors]),f.errors&&(a.success=!1,a.errors=[...a.errors||[],...f.errors]),u.errors&&(a.success=!1,a.errors=[...a.errors||[],...u.errors]),y.errors&&(a.success=!1,a.errors=[...a.errors||[],...y.errors]),w.errors&&(a.success=!1,a.errors=[...a.errors||[],...w.errors]),K.errors&&(a.success=!1,a.errors=[...a.errors||[],...K.errors]),Z.errors&&(a.success=!1,a.errors=[...a.errors||[],...Z.errors]),b.errors&&(a.success=!1,a.errors=[...a.errors||[],...b.errors]),k.errors&&(a.success=!1,a.errors=[...a.errors||[],...k.errors]);let A=await _({increaseVersion:a.success,broadcastAction:!0,data:{lastPublishDate:new Date}});if(a.success&&A.success&&A.data?.dataVersion&&s){let e=A.data.dataVersion,a=new Date,t=await (0,U.C)({data:{entityId:"00000000-0000-0000-0000-000000000000",entityType:"release",action:"publish",dataVersion:e,changes:[{action:"publish",description:`Release v${e} published`,fromDataVersion:e-1,toDataVersion:e}],fullSnapshot:{dataVersion:e,publishedAt:a.toISOString(),publishedBy:s},previousSnapshot:{},baselineSnapshot:{dataVersion:e,publishedAt:a.toISOString(),publishedBy:s},description:`Release v${e} published`,changeReason:`Release v${e} published`,isActive:!1,userId:s}});t.success||n.Z.error("publishData release changelog warning",t.errors?.join(", ")||"Unknown error")}i.Z.emit("data_changed","publish_data")}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return a}}async function C({scope:e}){let a={success:!0};try{let a=await (0,o.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),t=a?.user?.userId;1===e&&(t=void 0),await D.sj({userId:t}),await I.q5({userId:t}),await m.Ms({userId:t}),await R.F$({userId:t}),await h.VQ({userId:t}),await h.In({userId:t}),await h.cF({userId:t}),await u({userId:t}),i.Z.emit("data_changed","discard_drafts")}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return a}}(0,A.h)([O,P,V,E,C]),(0,s.j)("cb9a2ec0d6364666ae991ca69a1ccc30f74a5220",O),(0,s.j)("d7b5dfae0e5e175752e21d0929fede082af11157",P),(0,s.j)("c7b55d6a1f3e2e1bcaf7d0c11dca2a32d5a604ca",V),(0,s.j)("ed96721a8cdb9e337ce13bba84ed504642533051",E),(0,s.j)("a3f2c9f22a2d74bc5c52f0a99bf5982daa41ae01",C)},48578:(e,a,t)=>{t.d(a,{O0:()=>p,CA:()=>u,tP:()=>l,uf:()=>c});var s=t(57745),r=t(9576),i=t(57435),n=t(10413),o=t(93567),d=t(88317);async function c({data:e,broadcastAction:a=!0,userId:t}){let c={success:!1};try{let a=[];for(let{policyId:i,...d}of e){let{countryISO:e,...c}=d;try{let e=await n.Z.query.appUpdatePolicies.findFirst(),a=i||e?.policyId||r.Z(),d=await n.Z.query.appUpdatePoliciesDrafts.findFirst({where:(0,s.eq)(o.appUpdatePoliciesDrafts.policyDraftId,a)});if(d){let e={...d.data,...c,policyId:a};await n.Z.update(o.appUpdatePoliciesDrafts).set({data:e}).where((0,s.eq)(o.appUpdatePoliciesDrafts.policyDraftId,a))}else{let s={...e||{},...c,policyId:a};await n.Z.insert(o.appUpdatePoliciesDrafts).values({data:s,policyDraftId:a,policyId:e?.policyId,createdByUserId:t})}}catch(e){a.push(e.message)}}a.length?c.errors=a:c.success=!0}catch(e){c.success=!1,c.errors=[e.message],i.Z.error("_saveAppUpdatePolicies ERROR",e.message)}finally{return!c?.errors?.length&&a&&d.Z.emit("data_changed","save_app_update_policies"),c}}async function l({data:e,broadcastAction:a=!0,userId:t}){let c={success:!1};try{let a=[];for(let{apkReleaseId:i,...d}of e){let{countryISO:e,...c}=d;try{let e=i||r.Z(),a=await n.Z.query.apkReleases.findFirst({where:(0,s.eq)(o.apkReleases.apkReleaseId,e)}),l=null;if(d?.fileId){let e=await n.Z.query.files.findFirst({where:(0,s.eq)(o.files.fileId,d.fileId),columns:{size:!0,metadata:!0}});l=e?.metadata||null}let f=await n.Z.query.apkReleasesDrafts.findFirst({where:(0,s.eq)(o.apkReleasesDrafts.apkReleaseDraftId,e)}),u={...c,fileSize:d.fileSize??l?.size??void 0,checksumSha256:d.checksumSha256??l?.apkChecksumSha256??void 0,signatureSha256:d.signatureSha256??l?.apkSignatureSha256??void 0};if(f){let a={...f.data,...u,apkReleaseId:e};await n.Z.update(o.apkReleasesDrafts).set({data:a}).where((0,s.eq)(o.apkReleasesDrafts.apkReleaseDraftId,e))}else{let s={...a||{},...u,apkReleaseId:e};await n.Z.insert(o.apkReleasesDrafts).values({data:s,apkReleaseDraftId:e,apkReleaseId:a?.apkReleaseId,createdByUserId:t})}}catch(e){a.push(e.message)}}a.length?c.errors=a:c.success=!0}catch(e){c.success=!1,c.errors=[e.message],i.Z.error("_saveApkReleases ERROR",e.message)}finally{return!c?.errors?.length&&a&&d.Z.emit("data_changed","save_apk_releases"),c}}var f=t(36864);async function u(e){let a={success:!1},t=[],r=[];try{for(let a of(await n.Z.query.appUpdatePoliciesDrafts.findMany({where:e?.userId?(0,s.eq)(o.appUpdatePoliciesDrafts.createdByUserId,e.userId):void 0})))try{let t=a.policyId||a.data.policyId||a.policyDraftId,{countryISO:i,...d}={...a.data,policyId:t},c=await n.Z.query.appUpdatePolicies.findFirst({where:(0,s.eq)(o.appUpdatePolicies.policyId,t),columns:{policyVersion:!0}}),l=c?.policyVersion?c.policyVersion+1:d.policyVersion||1;if(c?await n.Z.update(o.appUpdatePolicies).set({...d,policyVersion:l}).where((0,s.eq)(o.appUpdatePolicies.policyId,t)):await n.Z.insert(o.appUpdatePolicies).values({...d,policyId:t,policyVersion:l}),e?.userId){let a=structuredClone(d);r.push({entityId:t,entityType:"app_update_policy",action:"publish",version:l,dataVersion:e.dataVersion,changes:[{action:"publish",description:"App update policy published"}],fullSnapshot:a,previousSnapshot:a,baselineSnapshot:a,description:"App update policy published",changeReason:"App update policy published",userId:e.userId})}}catch(e){t.push(e.message)}if(await n.Z.delete(o.appUpdatePoliciesDrafts).where(e?.userId?(0,s.eq)(o.appUpdatePoliciesDrafts.createdByUserId,e.userId):void 0),r.length&&Number.isFinite(e?.dataVersion)){let e=await (0,f.F)({data:r,allowPartial:!0});e.errors?.length&&i.Z.error("_publishAppUpdatePolicies changelog warnings",e.errors.join(", "))}t.length?a.errors=t:a.success=!0}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishAppUpdatePolicies ERROR",e.message)}return a}async function p(e){let a={success:!1},t=[],r=[];try{for(let a of(await n.Z.query.apkReleasesDrafts.findMany({where:e?.userId?(0,s.eq)(o.apkReleasesDrafts.createdByUserId,e.userId):void 0})))try{let t=a.apkReleaseId||a.data.apkReleaseId||a.apkReleaseDraftId,{countryISO:i,...d}={...a.data,apkReleaseId:t};if(await n.Z.query.apkReleases.findFirst({where:(0,s.eq)(o.apkReleases.apkReleaseId,t),columns:{apkReleaseId:!0}})?await n.Z.update(o.apkReleases).set({...d}).where((0,s.eq)(o.apkReleases.apkReleaseId,t)):await n.Z.insert(o.apkReleases).values({...d,apkReleaseId:t,releasedAt:d.releasedAt||new Date}),e?.userId){let a=structuredClone(d);r.push({entityId:t,entityType:"apk_release",action:"publish",dataVersion:e.dataVersion,changes:[{action:"publish",description:`APK release published (${d.versionName})`}],fullSnapshot:a,previousSnapshot:a,baselineSnapshot:a,description:`APK release published (${d.versionName})`,changeReason:`APK release published (${d.versionName})`,userId:e.userId})}}catch(e){t.push(e.message)}if(await n.Z.delete(o.apkReleasesDrafts).where(e?.userId?(0,s.eq)(o.apkReleasesDrafts.createdByUserId,e.userId):void 0),r.length&&Number.isFinite(e?.dataVersion)){let e=await (0,f.F)({data:r,allowPartial:!0});e.errors?.length&&i.Z.error("_publishApkReleases changelog warnings",e.errors.join(", "))}t.length?a.errors=t:a.success=!0}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishApkReleases ERROR",e.message)}return a}},92963:(e,a,t)=>{t.d(a,{sj:()=>f,LR:()=>u,h:()=>h,UZ:()=>l});var s=t(57745),r=t(81445),i=t(9576),n=t(57435),o=t(10413),d=t(93567),c=t(88317);async function l({data:e,broadcastAction:a,userId:t}){let l={success:!1};try{let a=[];for(let{configKeyId:n,...c}of e)try{let e=n||i.Z();if(!a.length){let a=n?await o.Z.query.configKeysDrafts.findFirst({where:(0,s.eq)(d.configKeysDrafts.configKeyDraftId,e)}):null,i=a||!n?null:await o.Z.query.configKeys.findFirst({where:(0,s.eq)(d.configKeys.configKeyId,e)});if(a){let t={...a.data,...c};await o.Z.update(d.configKeysDrafts).set({data:t,position:t.position}).where((0,s.eq)(d.configKeysDrafts.configKeyDraftId,e))}else{let a=c.position||i?.position;if(!a){let e=await o.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,r.C)(d.configKeys.position)}),t=await o.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,r.C)(d.configKeysDrafts.position)});a=Math.max(0,e?.position||0,t?.position||0)+1}let s={...i,...c,configKeyId:e,version:i?.version?i.version+1:1,position:a};await o.Z.insert(d.configKeysDrafts).values({data:s,configKeyDraftId:e,position:s.position,configKeyId:i?.configKeyId,createdByUserId:t})}}}catch(e){a.push(e.message)}a.length?l.errors=a:l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!l?.errors?.length&&a&&c.Z.emit("data_changed","save_config_keys"),l}}async function f(e){try{return await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function u({configKeysIds:e,broadcastAction:a,userId:t}){let r={success:!1};try{if(e.length){await o.Z.delete(d.configKeysDrafts).where((0,s.d3)(d.configKeysDrafts.configKeyDraftId,e));let a=(await o.Z.select({configKeyId:d.configKeys.configKeyId,pendingDeletion:d.pendingDeletion.configKeyId}).from(d.configKeys).leftJoin(d.pendingDeletion,(0,s.eq)(d.pendingDeletion.configKeyId,d.configKeys.configKeyId)).where((0,s.d3)(d.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:t}));a.length&&await o.Z.insert(d.pendingDeletion).values(a)}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],n.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!r?.errors?.length&&a&&c.Z.emit("data_changed","delete_config_keys"),r}}async function p({previous:e,drafts:a,userId:t}){let s=[];try{let r=[];for(let i of a){let a=i?.data?.configKeyId;if(!a)continue;let n={version:i?.data?.version||1,configKeyId:a,changes:{}},o=1===(i?.data?.version||1);if(o)n.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let t=e.find(e=>e.configKeyId===a),s=[],r=[];Object.keys({...i?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=i.data[e],n={...t}[e];JSON.stringify(a)!==JSON.stringify(n)&&(s.push({[e]:n}),r.push({[e]:a}))}),n.changes={action:"update_config_key",description:"Update config key",oldValues:s,newValues:r}}if(r.push(n),t){let{...r}=i.data||{},d=JSON.parse(JSON.stringify(r)),c=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.configKeyId===a)||{}));s.push({entityId:a,entityType:"config_key",action:o?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:d,previousSnapshot:c,baselineSnapshot:c,userId:t,configKeyId:a})}}r.length&&await o.Z.insert(d.configKeysHistory).values(r)}catch(e){n.Z.error(e.message)}return s}var g=t(34149),y=t(36864);async function h(e){let a={success:!1},t=[];try{let r=[],c=[],l=await o.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e?.userId):void 0});if(r=l.filter(e=>e.configKeyId),c=l.filter(e=>!e.configKeyId),r.length){let a=[];for(let{configKeyId:e,data:t}of(r.filter(e=>e.configKeyId).length&&(a=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,r.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),r)){let{configKeyId:a,id:r,oldConfigKeyId:i,createdAt:n,updatedAt:c,deletedAt:l,...f}=t,u={...f,publishDate:new Date};await o.Z.update(d.configKeys).set(u).where((0,s.eq)(d.configKeys.configKeyId,e)).returning()}let i=await p({drafts:r,previous:a,userId:e?.publisherUserId});t.push(...i.map(a=>({...a,dataVersion:e?.dataVersion})))}if(c.length){let a=[];for(let{id:e,data:t}of(c.filter(e=>e.configKeyId).length&&(a=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,c.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),c)){let a=t.configKeyId||(0,i.Z)(),s={...t,configKeyId:a};c=c.map(t=>(t.id===e&&(t.data.configKeyId=a),t)),await o.Z.insert(d.configKeys).values(s)}let r=await p({drafts:c,previous:a,userId:e?.publisherUserId});t.push(...r.map(a=>({...a,dataVersion:e?.dataVersion})))}await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0);let f=await o.Z.query.pendingDeletion.findMany({where:(0,s.xD)((0,s.K0)(d.pendingDeletion.configKeyId),e?.userId?(0,s.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:!0}});if((f=f.filter(e=>e.configKey)).length){let a=new Date;await o.Z.update(d.configKeys).set({deletedAt:a}).where((0,s.d3)(d.configKeys.configKeyId,f.map(e=>e.configKeyId)));let r=f.map(e=>({version:e.configKey.version,configKeyId:e.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:a}]}}));if(await o.Z.insert(d.configKeysHistory).values(r),e?.publisherUserId)for(let s=0;s<f.length;s++){let i=f[s],n=r[s];if(!i?.configKeyId)continue;let o={...i.configKey??{},deletedAt:a};t.push({entityId:i.configKeyId,entityType:"config_key",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),previousSnapshot:JSON.parse(JSON.stringify(o)),baselineSnapshot:JSON.parse(JSON.stringify(o)),description:n.changes.description,userId:e.publisherUserId,configKeyId:i.configKeyId,isActive:!1})}}await o.Z.delete(d.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.K0)(d.pendingDeletion.configKeyId),(0,s.K0)(d.pendingDeletion.configKeyDraftId)),e?.userId?(0,s.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let u=[...r.map(e=>e.configKeyId),...f.map(e=>e.configKeyId)];if(u.length&&await o.Z.update(d.configKeys).set({version:(0,g.i6)`${d.configKeys.version} + 1`}).where((0,s.d3)(d.configKeys.configKeyId,u)),t.length){let e=await (0,y.F)({data:t,allowPartial:!0});e.errors?.length&&n.Z.error("_publishConfigKeys changelog warnings",e.errors.join(", "))}a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_publishConfigKeys ERROR",e)}finally{return a}}},82102:(e,a,t)=>{t.d(a,{Du:()=>y,Dy:()=>d,Eu:()=>p,LW:()=>l,MO:()=>c,vQ:()=>f});var s=t(57745),r=t(60938),i=t(10413),n=t(93567),o=t(57435);async function d(){try{return{data:await i.Z.query.appUpdatePolicies.findFirst({where:void 0,with:{currentApkRelease:!0,rollbackApkRelease:!0}})||null}}catch(e){return o.Z.error("_getAppUpdatePolicy ERROR",e.message),{data:null,errors:[e.message]}}}async function c(e){try{return{data:await i.Z.query.appUpdatePoliciesDrafts.findMany()}}catch(e){return o.Z.error("_getAppUpdatePolicyDrafts ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){try{let{statuses:a=[]}={...e};return{data:(await i.Z.query.apkReleasesDrafts.findMany()).filter(e=>{let t=e.data;return!a.length||a.includes(t?.status)})}}catch(e){return o.Z.error("_getApkReleaseDrafts ERROR",e.message),{data:[],errors:[e.message]}}}async function f(e){try{let{apkReleaseIds:a=[],statuses:t=[]}={...e},r=[...a.length?[(0,s.d3)(n.apkReleases.apkReleaseId,a)]:[],...t.length?[(0,s.d3)(n.apkReleases.status,t)]:[]];return{data:await i.Z.query.apkReleases.findMany({where:r.length?(0,s.xD)(...r):void 0})}}catch(e){return o.Z.error("_getApkReleases ERROR",e.message),{data:[],errors:[e.message]}}}let u={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0};async function p(){try{let[{count:e}]=await i.Z.select({count:(0,r.QX)()}).from(n.appUpdatePoliciesDrafts),[{count:a}]=await i.Z.select({count:(0,r.QX)()}).from(n.appUpdatePoliciesDrafts).where((0,s.Ft)(n.appUpdatePoliciesDrafts.policyId)),[{count:t}]=await i.Z.select({count:(0,r.QX)()}).from(n.appUpdatePoliciesDrafts).where((0,s.K0)(n.appUpdatePoliciesDrafts.policyId)),[{count:o}]=await i.Z.select({count:(0,r.QX)()}).from(n.appUpdatePolicies);return{data:{allPublished:o,publishedWithDrafts:t,allDrafts:e,newDrafts:a}}}catch(e){return o.Z.error("_countAppUpdatePolicies ERROR",e.message),{data:u,errors:[e.message]}}}let g={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0};async function y(){try{let[{count:e}]=await i.Z.select({count:(0,r.QX)()}).from(n.apkReleasesDrafts),[{count:a}]=await i.Z.select({count:(0,r.QX)()}).from(n.apkReleasesDrafts).where((0,s.Ft)(n.apkReleasesDrafts.apkReleaseId)),[{count:t}]=await i.Z.select({count:(0,r.QX)()}).from(n.apkReleasesDrafts).where((0,s.K0)(n.apkReleasesDrafts.apkReleaseId)),[{count:o}]=await i.Z.select({count:(0,r.QX)()}).from(n.apkReleases);return{data:{allPublished:o,publishedWithDrafts:t,allDrafts:e,newDrafts:a}}}catch(e){return o.Z.error("_countApkReleases ERROR",e.message),{data:g,errors:[e.message]}}}},17137:(e,a,t)=>{t.d(a,{G$:()=>p,ZV:()=>u,SL:()=>l,aP:()=>c});var s=t(57745),r=t(30900),i=t(9576),n=t(10413),o=t(93567),d=t(57435);async function c(e){try{let{configKeysIds:a,returnDraftsIfExist:t}={...e},d=a||[],c=d?.length?(0,s.d3)(o.configKeysDrafts.configKeyDraftId,d.map(e=>r.Z(e)?e:i.Z())):void 0,l=[...c?[c]:[]],f=t?await n.Z.query.configKeysDrafts.findMany({where:(0,s.xD)(...l)}):[];d=d.filter(e=>!f.map(e=>e.configKeyDraftId).includes(e));let u=f.length?(0,s.Nl)(o.configKeys.configKeyId,f.map(e=>e.configKeyDraftId)):void 0,p=d?.length?(0,s.d3)(o.configKeys.configKeyId,d.filter(e=>r.Z(e))):void 0,g=d?.length?(0,s.d3)(o.configKeys.oldConfigKeyId,d.filter(e=>!r.Z(e))):void 0,y=[(0,s.Ft)(o.configKeys.deletedAt),(0,s.Ft)(o.pendingDeletion),...p&&g?[(0,s.or)(p,g)]:[],u],h=(await n.Z.select({configKey:o.configKeys,pendingDeletion:o.pendingDeletion}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where(y.length?(0,s.xD)(...y):void 0)).map(e=>e.configKey),D=h.length?await n.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.configKeyId,h.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,a)=>e.position-a.position).filter(e=>!D.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{configKeyId:a,returnDraftIfExists:t}={...e};try{if(!a)throw Error("Missing configKeyId");let e=r.Z(a)?(0,s.eq)(o.configKeys.configKeyId,a):void 0,i=r.Z(a)?void 0:(0,s.eq)(o.configKeys.oldConfigKeyId,a),d=e?(0,s.eq)(o.configKeysDrafts.configKeyDraftId,a):void 0,c=t&&d?await n.Z.query.configKeysDrafts.findFirst({where:e}):void 0,l=c?{...c.data,draftCreatedByUserId:c.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(l)return{data:l};let f=await n.Z.query.configKeys.findFirst({where:(0,s.xD)((0,s.Ft)(o.configKeys.deletedAt),e||i),with:{draft:!0}});c=t?f?.draft:void 0;let u=c?.data||f;if(!(l=u?{...u,draftCreatedByUserId:c?.createdByUserId,isDraft:!!c?.data,isDeleted:!1}:null))return{data:null};return{data:l}}catch(e){return d.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var f=t(60938);let u={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function p(){try{let[{count:e}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts),[{count:a}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,s.Ft)(o.configKeysDrafts.configKeyId)),[{count:t}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,s.K0)(o.configKeysDrafts.configKeyId)),[{count:r}]=await n.Z.select({count:(0,f.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.configKeyId)),[{count:i}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeys);return{data:{allPublished:i,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:r}}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:u,errors:[e.message]}}}},18496:(e,a,t)=>{t.d(a,{y:()=>i});var s=t(10413),r=t(57435);async function i(){try{return{data:await s.Z.query.editorInfo.findFirst()||null}}catch(e){return r.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,a,t)=>{t.d(a,{Yi:()=>u,Ur:()=>l,Nb:()=>c,Ic:()=>f});var s=t(60938),r=t(57435),i=t(93567),n=t(10413),o=t(81445);let d={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function c(){try{let{lastPublishDate:e}={...await n.Z.query.editorInfo.findFirst()},a=await n.Z.select({configKeysDrafts:i.configKeysDrafts.updatedAt}).from(i.configKeysDrafts).orderBy((0,o.C)(i.configKeysDrafts.updatedAt)).limit(1),t=await n.Z.select({diagnosesDrafts:i.diagnosesDrafts.updatedAt}).from(i.diagnosesDrafts).orderBy((0,o.C)(i.diagnosesDrafts.updatedAt)).limit(1),s=await n.Z.select({screensDrafts:i.screensDrafts.updatedAt}).from(i.screensDrafts).orderBy((0,o.C)(i.screensDrafts.updatedAt)).limit(1),r=await n.Z.select({scriptsDrafts:i.scriptsDrafts.updatedAt}).from(i.scriptsDrafts).orderBy((0,o.C)(i.scriptsDrafts.updatedAt)).limit(1),c=await n.Z.select({configKeys:i.configKeys.updatedAt}).from(i.configKeys).orderBy((0,o.C)(i.configKeys.updatedAt)).limit(1),l=await n.Z.select({diagnoses:i.diagnoses.updatedAt}).from(i.diagnoses).orderBy((0,o.C)(i.diagnoses.updatedAt)).limit(1),f=await n.Z.select({screens:i.screens.updatedAt}).from(i.screens).orderBy((0,o.C)(i.screens.updatedAt)).limit(1),u=await n.Z.select({scripts:i.scripts.updatedAt}).from(i.scripts).orderBy((0,o.C)(i.scripts.updatedAt)).limit(1),p=await n.Z.select({pendingDeletion:i.pendingDeletion.createdAt}).from(i.pendingDeletion).orderBy((0,o.C)(i.pendingDeletion.createdAt)).limit(1),g={...d,...a[0],...t[0],...s[0],...r[0],...c[0],...l[0],...f[0],...u[0],...p[0],lastPublished:e||null},y=[e?new Date(e).getTime():null,...Object.values(g).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),h=e;return y.length&&(h=new Date(Math.max(...y))),{data:{...g,latestChangesDate:h}}}catch(e){return r.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:d,errors:[e.message]}}}async function l(){try{let e=await n.Z.select({count:(0,s.QX)()}).from(i.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return r.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let f={scripts:0,screens:0,diagnoses:0,configKeys:0,hospitals:0,drugsLibraryItems:0,total:0,dataKeys:0,appUpdatePolicies:0,apkReleases:0};async function u(){let e={...f};try{let a=await n.Z.select({count:(0,s.QX)()}).from(i.scriptsDrafts);e.scripts=a[0]?.count||0;let t=await n.Z.select({count:(0,s.QX)()}).from(i.screensDrafts);e.screens=t[0]?.count||0;let r=await n.Z.select({count:(0,s.QX)()}).from(i.diagnosesDrafts);e.diagnoses=r[0]?.count||0;let o=await n.Z.select({count:(0,s.QX)()}).from(i.configKeysDrafts);e.configKeys=o[0]?.count||0;let d=await n.Z.select({count:(0,s.QX)()}).from(i.hospitalsDrafts);e.hospitals=d[0]?.count||0;let c=await n.Z.select({count:(0,s.QX)()}).from(i.drugsLibraryDrafts);e.drugsLibraryItems=c[0]?.count||0;let l=await n.Z.select({count:(0,s.QX)()}).from(i.dataKeysDrafts);e.dataKeys=l[0]?.count||0;let f=await n.Z.select({count:(0,s.QX)()}).from(i.appUpdatePoliciesDrafts);e.appUpdatePolicies=f[0]?.count||0;let u=await n.Z.select({count:(0,s.QX)()}).from(i.apkReleasesDrafts);return e.apkReleases=u[0]?.count||0,e.total=Object.values(e).reduce((e,a)=>e+a,0),{...e}}catch(a){return r.Z.error("_countDrafts ERROR",a.message),{...e,errors:[a.message]}}}}};