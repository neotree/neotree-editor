"use strict";exports.id=1271,exports.ids=[1271],exports.modules={71271:(e,t,a)=>{a.r(t),a.d(t,{$$ACTION_0:()=>S,$$ACTION_1:()=>V,countAllDrafts:()=>B,discardDrafts:()=>F,getEditorDetails:()=>O,publishData:()=>E,revalidatePath:()=>P});var s=a(24330);a(60166);var i=a(57708),r=a(88317),n=a(57435),o=a(66267),d=a(57745),l=a(34149),c=a(10413),p=a(93567);async function f(e){try{let{items:t,broadcastAction:a}={...e},s=["configKeys"===t?(0,d.K0)(p.pendingDeletion.configKeyId):void 0,"drugsLibrary"===t?(0,d.K0)(p.pendingDeletion.drugsLibraryItemId):void 0,"dataKeys"===t?(0,d.K0)(p.pendingDeletion.dataKeyId):void 0,"scripts"===t?(0,d.xD)((0,d.K0)(p.pendingDeletion.scriptId),(0,d.Ft)(p.pendingDeletion.screenId),(0,d.Ft)(p.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,d.K0)(p.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,d.K0)(p.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0];return await c.Z.delete(p.pendingDeletion).where(s.length?(0,d.xD)(...s):void 0),a&&r.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return n.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function u(e){try{let{items:t}={...e},a=await c.Z.query.pendingDeletion.findMany({where:(0,d.xD)("configKeys"===t?(0,d.K0)(p.pendingDeletion.configKeyId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0)});a.length&&await c.Z.update(p.configKeys).set({deletedAt:new Date}).where((0,d.d3)(p.configKeys.configKeyId,a.map(e=>e.configKeyId)));let s=await c.Z.query.pendingDeletion.findMany({where:(0,d.xD)("drugsLibrary"===t?(0,d.K0)(p.pendingDeletion.drugsLibraryItemId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0)}),i=await c.Z.query.pendingDeletion.findMany({where:(0,d.xD)("dataKeys"===t?(0,d.K0)(p.pendingDeletion.dataKeyId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0)});i.length&&await c.Z.update(p.dataKeys).set({deletedAt:new Date,name:(0,l.i6)`CONCAT(${p.dataKeys.name}, '_', ${p.dataKeys.uuid})`}).where((0,d.d3)(p.dataKeys.uuid,i.map(e=>e.dataKeyId))),s.length&&await c.Z.update(p.drugsLibrary).set({deletedAt:new Date,key:(0,l.i6)`CONCAT(${p.drugsLibrary.key}, '_', ${p.drugsLibrary.itemId})`}).where((0,d.d3)(p.drugsLibrary.itemId,s.map(e=>e.drugsLibraryItemId)));let r=await c.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,d.xD)((0,d.K0)(p.pendingDeletion.scriptId),(0,d.Ft)(p.pendingDeletion.screenId),(0,d.Ft)(p.pendingDeletion.diagnosisId),e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0):void 0});r.length&&(await c.Z.update(p.scripts).set({deletedAt:new Date}).where((0,d.d3)(p.scripts.scriptId,r.map(e=>e.scriptId))),await c.Z.update(p.screens).set({deletedAt:new Date}).where((0,d.d3)(p.screens.scriptId,r.map(e=>e.scriptId))),await c.Z.update(p.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(p.diagnoses.scriptId,r.map(e=>e.scriptId))));let n=await c.Z.query.pendingDeletion.findMany({where:(0,d.xD)("screens"===t?(0,d.K0)(p.pendingDeletion.screenId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0)});n.length&&await c.Z.update(p.screens).set({deletedAt:new Date}).where((0,d.d3)(p.screens.screenId,n.map(e=>e.screenId)));let o=await c.Z.query.pendingDeletion.findMany({where:(0,d.xD)("diagnoses"===t?(0,d.K0)(p.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(p.pendingDeletion.createdByUserId,e.userId):void 0)});return o.length&&await c.Z.update(p.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(p.diagnoses.diagnosisId,o.map(e=>e.diagnosisId))),await f(e),{success:!0}}catch(e){return n.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var g=a(25060),h=a(21162),y=a(45241),I=a(92963),D=a(17137),w=a(73543),m=a(20084),K=a(22418),Z=a(88781),R=a(88778),v=a(48578),b=a(16916),q=a(82102);async function _({data:e,increaseVersion:t,broadcastAction:a,syncSilently:s}){try{let i=await c.Z.query.editorInfo.findFirst();if(i){let a=t?i.dataVersion+1:i.dataVersion;await c.Z.update(p.editorInfo).set({...e,dataVersion:a}).where((0,d.eq)(p.editorInfo.id,i.id))}return(i=await c.Z.query.editorInfo.findFirst())&&a&&!s&&r.Z.emit("data_changed","save_editor_info"),{data:i||null,success:!!i}}catch(e){return n.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var U=a(18496),k=a(36864),A=a(40618);async function O(){let e=[],t=!1;try{let a=await (0,U.y)();a.errors?.forEach(t=>e.push(t));let s=await g.Ur();s.errors?.forEach(t=>e.push(t));let{errors:i,...r}=await g.Yi();return i?.forEach(t=>e.push(t)),t=!!r.total||!!s.total,{pendingDeletion:s.total,drafts:r,errors:e.length?e:void 0,shouldPublishData:t,info:a.data}}catch(a){return n.Z.error("getEditorDetails ERROR",a.message),{errors:[a.message,...e],pendingDeletion:0,drafts:g.Ic,shouldPublishData:t,info:null}}}let P=(0,s.j)("a51a2d6c6369fbe75939846346b95c575004df1d",S);async function S(e,t){return(0,i.revalidatePath)(e,t)}let B=(0,s.j)("e5fa07e4fdc4dcce863b886208c69a80b05c95d4",V);async function V(){try{let e=await D.G$(),t=await m.Py(),a=await Z.G$(),s=await b.gc(),i=await h.co(),r=await h.ix(),n=await h.tW(),o=await q.Eu(),d=await q.Du();return{configKeys:e.data.allDrafts,hospitals:t.data.allDrafts,drugsLibrary:a.data.allDrafts,screens:i.data.allDrafts,scripts:r.data.allDrafts,diagnoses:n.data.allDrafts,dataKeys:s.data.allDrafts,appUpdatePolicies:o.data.allDrafts,apkReleases:d.data.allDrafts}}catch(e){return n.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,hospitals:0,diagnoses:0}}}async function E({scope:e}){let t={success:!0};try{let a=await (0,o.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]),s=a?.user?.userId||null,i=s;1===e&&(i=null);let d=await (0,U.y)(),l=(d.data?.dataVersion||1)+1,c=await I.h({userId:i,publisherUserId:s,dataVersion:l}),p=await w.fn({userId:i,publisherUserId:s,dataVersion:l}),f=await K.hA({userId:i,publisherUserId:s,dataVersion:l}),g=await R.Hc({userId:i,publisherUserId:s,dataVersion:l}),h=await y.Ls({userId:i,publisherUserId:s,dataVersion:l}),D=await y.Ry({userId:i,publisherUserId:s,dataVersion:l}),m=await y.gv({userId:i,publisherUserId:s,dataVersion:l}),Z=await v.CA({userId:i}),b=await v.O0({userId:i}),q=await u({userId:i,publisherUserId:s||void 0});g.errors&&(t.success=!1,t.errors=[...t.errors||[],...g.errors]),c.errors&&(t.success=!1,t.errors=[...t.errors||[],...c.errors]),p.errors&&(t.success=!1,t.errors=[...t.errors||[],...p.errors]),f.errors&&(t.success=!1,t.errors=[...t.errors||[],...f.errors]),h.errors&&(t.success=!1,t.errors=[...t.errors||[],...h.errors]),D.errors&&(t.success=!1,t.errors=[...t.errors||[],...D.errors]),m.errors&&(t.success=!1,t.errors=[...t.errors||[],...m.errors]),Z.errors&&(t.success=!1,t.errors=[...t.errors||[],...Z.errors]),b.errors&&(t.success=!1,t.errors=[...t.errors||[],...b.errors]),q.errors&&(t.success=!1,t.errors=[...t.errors||[],...q.errors]);let A=await _({increaseVersion:t.success,broadcastAction:!0,data:{lastPublishDate:new Date}});if(t.success&&A.success&&A.data?.dataVersion&&s){let e=A.data.dataVersion,t=new Date,a=await (0,k.C)({data:{entityId:"00000000-0000-0000-0000-000000000000",entityType:"release",action:"publish",dataVersion:e,changes:[{action:"publish",description:`Release v${e} published`,fromDataVersion:e-1,toDataVersion:e}],fullSnapshot:{dataVersion:e,publishedAt:t.toISOString(),publishedBy:s},previousSnapshot:{},baselineSnapshot:{dataVersion:e,publishedAt:t.toISOString(),publishedBy:s},description:`Release v${e} published`,changeReason:`Release v${e} published`,isActive:!1,userId:s}});a.success||n.Z.error("publishData release changelog warning",a.errors?.join(", ")||"Unknown error")}r.Z.emit("data_changed","publish_data")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}async function F({scope:e}){let t={success:!0};try{let t=await (0,o.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),a=t?.user?.userId;1===e&&(a=void 0),await I.sj({userId:a}),await w.q5({userId:a}),await K.Ms({userId:a}),await R.F$({userId:a}),await y.VQ({userId:a}),await y.In({userId:a}),await y.cF({userId:a}),await f({userId:a}),r.Z.emit("data_changed","discard_drafts")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}(0,A.h)([O,P,B,E,F]),(0,s.j)("cb9a2ec0d6364666ae991ca69a1ccc30f74a5220",O),(0,s.j)("d7b5dfae0e5e175752e21d0929fede082af11157",P),(0,s.j)("c7b55d6a1f3e2e1bcaf7d0c11dca2a32d5a604ca",B),(0,s.j)("ed96721a8cdb9e337ce13bba84ed504642533051",E),(0,s.j)("a3f2c9f22a2d74bc5c52f0a99bf5982daa41ae01",F)},48578:(e,t,a)=>{a.d(t,{O0:()=>u,CA:()=>f,tP:()=>c,uf:()=>l});var s=a(57745),i=a(9576),r=a(57435),n=a(10413),o=a(93567),d=a(88317);async function l({data:e,broadcastAction:t=!0,userId:a}){let l={success:!1};try{let t=[];for(let{policyId:r,...d}of e){let{countryISO:e,...l}=d;try{let e=await n.Z.query.appUpdatePolicies.findFirst(),t=r||e?.policyId||i.Z(),d=await n.Z.query.appUpdatePoliciesDrafts.findFirst({where:(0,s.eq)(o.appUpdatePoliciesDrafts.policyDraftId,t)});if(d){let e={...d.data,...l,policyId:t};await n.Z.update(o.appUpdatePoliciesDrafts).set({data:e}).where((0,s.eq)(o.appUpdatePoliciesDrafts.policyDraftId,t))}else{let s={...e||{},...l,policyId:t};await n.Z.insert(o.appUpdatePoliciesDrafts).values({data:s,policyDraftId:t,policyId:e?.policyId,createdByUserId:a})}}catch(e){t.push(e.message)}}t.length?l.errors=t:l.success=!0}catch(e){l.success=!1,l.errors=[e.message],r.Z.error("_saveAppUpdatePolicies ERROR",e.message)}finally{return!l?.errors?.length&&t&&d.Z.emit("data_changed","save_app_update_policies"),l}}async function c({data:e,broadcastAction:t=!0,userId:a}){let l={success:!1};try{let t=[];for(let{apkReleaseId:r,...d}of e){let{countryISO:e,...l}=d;try{let e=r||i.Z(),t=await n.Z.query.apkReleases.findFirst({where:(0,s.eq)(o.apkReleases.apkReleaseId,e)}),c=null;if(d?.fileId){let e=await n.Z.query.files.findFirst({where:(0,s.eq)(o.files.fileId,d.fileId),columns:{size:!0,metadata:!0}});c=e?.metadata||null}let p=await n.Z.query.apkReleasesDrafts.findFirst({where:(0,s.eq)(o.apkReleasesDrafts.apkReleaseDraftId,e)}),f={...l,fileSize:d.fileSize??c?.size??void 0,checksumSha256:d.checksumSha256??c?.apkChecksumSha256??void 0,signatureSha256:d.signatureSha256??c?.apkSignatureSha256??void 0};if(p){let t={...p.data,...f,apkReleaseId:e};await n.Z.update(o.apkReleasesDrafts).set({data:t}).where((0,s.eq)(o.apkReleasesDrafts.apkReleaseDraftId,e))}else{let s={...t||{},...f,apkReleaseId:e};await n.Z.insert(o.apkReleasesDrafts).values({data:s,apkReleaseDraftId:e,apkReleaseId:t?.apkReleaseId,createdByUserId:a})}}catch(e){t.push(e.message)}}t.length?l.errors=t:l.success=!0}catch(e){l.success=!1,l.errors=[e.message],r.Z.error("_saveApkReleases ERROR",e.message)}finally{return!l?.errors?.length&&t&&d.Z.emit("data_changed","save_apk_releases"),l}}var p=a(36864);async function f(e){let t={success:!1},a=[],i=[];try{for(let t of(await n.Z.query.appUpdatePoliciesDrafts.findMany({where:e?.userId?(0,s.eq)(o.appUpdatePoliciesDrafts.createdByUserId,e.userId):void 0})))try{let a=t.policyId||t.data.policyId||t.policyDraftId,{countryISO:r,...d}={...t.data,policyId:a},l=await n.Z.query.appUpdatePolicies.findFirst({where:(0,s.eq)(o.appUpdatePolicies.policyId,a),columns:{policyVersion:!0}}),c=l?.policyVersion?l.policyVersion+1:d.policyVersion||1;if(l?await n.Z.update(o.appUpdatePolicies).set({...d,policyVersion:c}).where((0,s.eq)(o.appUpdatePolicies.policyId,a)):await n.Z.insert(o.appUpdatePolicies).values({...d,policyId:a,policyVersion:c}),e?.userId){let t=structuredClone(d);i.push({entityId:a,entityType:"app_update_policy",action:"publish",version:c,dataVersion:e.dataVersion,changes:[{action:"publish",description:"App update policy published"}],fullSnapshot:t,previousSnapshot:t,baselineSnapshot:t,description:"App update policy published",changeReason:"App update policy published",userId:e.userId})}}catch(e){a.push(e.message)}if(await n.Z.delete(o.appUpdatePoliciesDrafts).where(e?.userId?(0,s.eq)(o.appUpdatePoliciesDrafts.createdByUserId,e.userId):void 0),i.length&&Number.isFinite(e?.dataVersion)){let e=await (0,p.F)({data:i,allowPartial:!0});e.errors?.length&&r.Z.error("_publishAppUpdatePolicies changelog warnings",e.errors.join(", "))}a.length?t.errors=a:t.success=!0}catch(e){t.success=!1,t.errors=[e.message],r.Z.error("_publishAppUpdatePolicies ERROR",e.message)}return t}async function u(e){let t={success:!1},a=[],i=[];try{for(let t of(await n.Z.query.apkReleasesDrafts.findMany({where:e?.userId?(0,s.eq)(o.apkReleasesDrafts.createdByUserId,e.userId):void 0})))try{let a=t.apkReleaseId||t.data.apkReleaseId||t.apkReleaseDraftId,{countryISO:r,...d}={...t.data,apkReleaseId:a};if(await n.Z.query.apkReleases.findFirst({where:(0,s.eq)(o.apkReleases.apkReleaseId,a),columns:{apkReleaseId:!0}})?await n.Z.update(o.apkReleases).set({...d}).where((0,s.eq)(o.apkReleases.apkReleaseId,a)):await n.Z.insert(o.apkReleases).values({...d,apkReleaseId:a,releasedAt:d.releasedAt||new Date}),e?.userId){let t=structuredClone(d);i.push({entityId:a,entityType:"apk_release",action:"publish",dataVersion:e.dataVersion,changes:[{action:"publish",description:`APK release published (${d.versionName})`}],fullSnapshot:t,previousSnapshot:t,baselineSnapshot:t,description:`APK release published (${d.versionName})`,changeReason:`APK release published (${d.versionName})`,userId:e.userId})}}catch(e){a.push(e.message)}if(await n.Z.delete(o.apkReleasesDrafts).where(e?.userId?(0,s.eq)(o.apkReleasesDrafts.createdByUserId,e.userId):void 0),i.length&&Number.isFinite(e?.dataVersion)){let e=await (0,p.F)({data:i,allowPartial:!0});e.errors?.length&&r.Z.error("_publishApkReleases changelog warnings",e.errors.join(", "))}a.length?t.errors=a:t.success=!0}catch(e){t.success=!1,t.errors=[e.message],r.Z.error("_publishApkReleases ERROR",e.message)}return t}},92963:(e,t,a)=>{a.d(t,{sj:()=>p,LR:()=>f,h:()=>y,UZ:()=>c});var s=a(57745),i=a(81445),r=a(9576),n=a(57435),o=a(10413),d=a(93567),l=a(88317);async function c({data:e,broadcastAction:t,userId:a}){let c={success:!1};try{let t=[];for(let{configKeyId:n,...l}of e)try{let e=n||r.Z();if(!t.length){let t=n?await o.Z.query.configKeysDrafts.findFirst({where:(0,s.eq)(d.configKeysDrafts.configKeyDraftId,e)}):null,r=t||!n?null:await o.Z.query.configKeys.findFirst({where:(0,s.eq)(d.configKeys.configKeyId,e)});if(t){let a={...t.data,...l};await o.Z.update(d.configKeysDrafts).set({data:a,position:a.position}).where((0,s.eq)(d.configKeysDrafts.configKeyDraftId,e))}else{let t=l.position||r?.position;if(!t){let e=await o.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeys.position)}),a=await o.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeysDrafts.position)});t=Math.max(0,e?.position||0,a?.position||0)+1}let s={...r,...l,configKeyId:e,version:r?.version?r.version+1:1,position:t};await o.Z.insert(d.configKeysDrafts).values({data:s,configKeyDraftId:e,position:s.position,configKeyId:r?.configKeyId,createdByUserId:a})}}}catch(e){t.push(e.message)}t.length?c.errors=t:c.success=!0}catch(e){c.success=!1,c.errors=[e.message],n.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!c?.errors?.length&&t&&l.Z.emit("data_changed","save_config_keys"),c}}async function p(e){try{return await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function f({configKeysIds:e,broadcastAction:t,userId:a}){let i={success:!1};try{if(e.length){await o.Z.delete(d.configKeysDrafts).where((0,s.d3)(d.configKeysDrafts.configKeyDraftId,e));let t=(await o.Z.select({configKeyId:d.configKeys.configKeyId,pendingDeletion:d.pendingDeletion.configKeyId}).from(d.configKeys).leftJoin(d.pendingDeletion,(0,s.eq)(d.pendingDeletion.configKeyId,d.configKeys.configKeyId)).where((0,s.d3)(d.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:a}));t.length&&await o.Z.insert(d.pendingDeletion).values(t)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!i?.errors?.length&&t&&l.Z.emit("data_changed","delete_config_keys"),i}}async function u({previous:e,drafts:t,userId:a}){let s=[];try{let i=[];for(let r of t){let t=r?.data?.configKeyId;if(!t)continue;let n={version:r?.data?.version||1,configKeyId:t,changes:{}},o=1===(r?.data?.version||1);if(o)n.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let a=e.find(e=>e.configKeyId===t),s=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=r.data[e],n={...a}[e];JSON.stringify(t)!==JSON.stringify(n)&&(s.push({[e]:n}),i.push({[e]:t}))}),n.changes={action:"update_config_key",description:"Update config key",oldValues:s,newValues:i}}if(i.push(n),a){let{...i}=r.data||{},d=JSON.parse(JSON.stringify(i)),l=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.configKeyId===t)||{}));s.push({entityId:t,entityType:"config_key",action:o?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:d,previousSnapshot:l,baselineSnapshot:l,userId:a,configKeyId:t})}}i.length&&await o.Z.insert(d.configKeysHistory).values(i)}catch(e){n.Z.error(e.message)}return s}var g=a(34149),h=a(36864);async function y(e){let t={success:!1},a=[];try{let i=[],l=[],c=await o.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e?.userId):void 0});if(i=c.filter(e=>e.configKeyId),l=c.filter(e=>!e.configKeyId),i.length){let t=[];for(let{configKeyId:e,data:a}of(i.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,i.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),i)){let{configKeyId:t,id:i,oldConfigKeyId:r,createdAt:n,updatedAt:l,deletedAt:c,...p}=a,f={...p,publishDate:new Date};await o.Z.update(d.configKeys).set(f).where((0,s.eq)(d.configKeys.configKeyId,e)).returning()}let r=await u({drafts:i,previous:t,userId:e?.publisherUserId});a.push(...r.map(t=>({...t,dataVersion:e?.dataVersion})))}if(l.length){let t=[];for(let{id:e,data:a}of(l.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,s.d3)(d.configKeys.configKeyId,l.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),l)){let t=a.configKeyId||(0,r.Z)(),s={...a,configKeyId:t};l=l.map(a=>(a.id===e&&(a.data.configKeyId=t),a)),await o.Z.insert(d.configKeys).values(s)}let i=await u({drafts:l,previous:t,userId:e?.publisherUserId});a.push(...i.map(t=>({...t,dataVersion:e?.dataVersion})))}await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,s.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0);let p=await o.Z.query.pendingDeletion.findMany({where:(0,s.xD)((0,s.K0)(d.pendingDeletion.configKeyId),e?.userId?(0,s.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:!0}});if((p=p.filter(e=>e.configKey)).length){let t=new Date;await o.Z.update(d.configKeys).set({deletedAt:t}).where((0,s.d3)(d.configKeys.configKeyId,p.map(e=>e.configKeyId)));let i=p.map(e=>({version:e.configKey.version,configKeyId:e.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await o.Z.insert(d.configKeysHistory).values(i),e?.publisherUserId)for(let s=0;s<p.length;s++){let r=p[s],n=i[s];if(!r?.configKeyId)continue;let o={...r.configKey??{},deletedAt:t};a.push({entityId:r.configKeyId,entityType:"config_key",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),previousSnapshot:JSON.parse(JSON.stringify(o)),baselineSnapshot:JSON.parse(JSON.stringify(o)),description:n.changes.description,userId:e.publisherUserId,configKeyId:r.configKeyId,isActive:!1})}}await o.Z.delete(d.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.K0)(d.pendingDeletion.configKeyId),(0,s.K0)(d.pendingDeletion.configKeyDraftId)),e?.userId?(0,s.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let f=[...i.map(e=>e.configKeyId),...p.map(e=>e.configKeyId)];if(f.length&&await o.Z.update(d.configKeys).set({version:(0,g.i6)`${d.configKeys.version} + 1`}).where((0,s.d3)(d.configKeys.configKeyId,f)),a.length){let e=await (0,h.F)({data:a,allowPartial:!0});e.errors?.length&&n.Z.error("_publishConfigKeys changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},73543:(e,t,a)=>{a.d(t,{q5:()=>c,x0:()=>p,fn:()=>h,rr:()=>l});var s=a(57745),i=a(9576),r=a(57435),n=a(10413),o=a(93567),d=a(88317);async function l({data:e,broadcastAction:t=!0,userId:a}){let l={success:!1};try{let t=[];for(let{hospitalId:r,...d}of e)try{let e=r||i.Z();if(!t.length){let t=r?await n.Z.query.hospitalsDrafts.findFirst({where:(0,s.eq)(o.hospitalsDrafts.hospitalDraftId,e)}):null,i=t||!r?null:await n.Z.query.hospitals.findFirst({where:(0,s.eq)(o.hospitals.hospitalId,e)});if(t){let a={...t.data,...d};await n.Z.update(o.hospitalsDrafts).set({data:a}).where((0,s.eq)(o.hospitalsDrafts.hospitalDraftId,e))}else{let t={...i,...d,hospitalId:e,version:i?.version?i.version+1:1};await n.Z.insert(o.hospitalsDrafts).values({data:t,hospitalDraftId:e,hospitalId:i?.hospitalId,createdByUserId:a})}}}catch(e){t.push(e.message)}t.length?l.errors=t:l.success=!0}catch(e){l.success=!1,l.errors=[e.message],r.Z.error("_saveHospitals ERROR",e.message)}finally{return!l?.errors?.length&&t&&d.Z.emit("data_changed","save_hospitals"),l}}async function c(e){try{return await n.Z.delete(o.hospitalsDrafts).where(e?.userId?(0,s.eq)(o.hospitalsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function p({hospitalsIds:e,broadcastAction:t=!0,userId:a}){let i={success:!1};try{if(e.length){await n.Z.delete(o.hospitalsDrafts).where((0,s.d3)(o.hospitalsDrafts.hospitalDraftId,e));let t=(await n.Z.select({hospitalId:o.hospitals.hospitalId,pendingDeletion:o.pendingDeletion.hospitalId}).from(o.hospitals).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.hospitalId,o.hospitals.hospitalId)).where((0,s.d3)(o.hospitals.hospitalId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:a}));t.length&&await n.Z.insert(o.pendingDeletion).values(t)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],r.Z.error("_deleteHospitals ERROR",e.message)}finally{return!i?.errors?.length&&t&&d.Z.emit("data_changed","delete_hospitals"),i}}async function f({previous:e,drafts:t,userId:a}){let s=[];try{let i=[];for(let r of t){let t=r?.data?.hospitalId;if(!t)continue;let n={version:r?.data?.version||1,hospitalId:t,changes:{}},o=1===(r?.data?.version||1);if(o)n.changes={action:"create_hospital",description:"Create hospital",oldValues:[],newValues:[]};else{let a=e.find(e=>e.hospitalId===t),s=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=r.data[e],n={...a}[e];JSON.stringify(t)!==JSON.stringify(n)&&(s.push({[e]:n}),i.push({[e]:t}))}),n.changes={action:"update_hospital",description:"Update hospital",oldValues:s,newValues:i}}if(i.push(n),a){let{...i}=r.data||{},d=JSON.parse(JSON.stringify(i)),l=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.hospitalId===t)||{}));s.push({entityId:t,entityType:"hospital",action:o?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:d,previousSnapshot:l,baselineSnapshot:l,userId:a,hospitalId:t})}}i.length&&await n.Z.insert(o.hospitalsHistory).values(i)}catch(e){r.Z.error(e.message)}return s}var u=a(34149),g=a(36864);async function h(e){let t={success:!1},a=[];try{let d=[],l=[],c=await n.Z.query.hospitalsDrafts.findMany({where:e?.userId?(0,s.eq)(o.hospitalsDrafts.createdByUserId,e?.userId):void 0});if(d=c.filter(e=>e.hospitalId),l=c.filter(e=>!e.hospitalId),d.length){let t=[];for(let{hospitalId:e,data:a}of(d.filter(e=>e.hospitalId).length&&(t=await n.Z.query.hospitals.findMany({where:(0,s.d3)(o.hospitals.hospitalId,d.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),d)){let{hospitalId:t,id:i,oldHospitalId:r,createdAt:d,updatedAt:l,deletedAt:c,...p}=a,f={...p,publishDate:new Date};await n.Z.update(o.hospitals).set(f).where((0,s.eq)(o.hospitals.hospitalId,e)).returning()}let i=await f({drafts:d,previous:t,userId:e?.publisherUserId});a.push(...i.map(t=>({...t,dataVersion:e?.dataVersion})))}if(l.length){let t=[];for(let{id:e,data:a}of(l.filter(e=>e.hospitalId).length&&(t=await n.Z.query.hospitals.findMany({where:(0,s.d3)(o.hospitals.hospitalId,l.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),l)){let t=a.hospitalId||(0,i.Z)(),s={...a,hospitalId:t};l=l.map(a=>(a.id===e&&(a.data.hospitalId=t),a)),await n.Z.insert(o.hospitals).values(s)}let r=await f({drafts:l,previous:t,userId:e?.publisherUserId});a.push(...r.map(t=>({...t,dataVersion:e?.dataVersion})))}await n.Z.delete(o.hospitalsDrafts).where(e?.userId?(0,s.eq)(o.hospitalsDrafts.createdByUserId,e.userId):void 0);let p=await n.Z.query.pendingDeletion.findMany({where:(0,s.xD)((0,s.K0)(o.pendingDeletion.hospitalId),e?.userId?(0,s.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0),columns:{hospitalId:!0},with:{hospital:!0}});if((p=p.filter(e=>e.hospital)).length){let t=new Date;await n.Z.update(o.hospitals).set({deletedAt:t}).where((0,s.d3)(o.hospitals.hospitalId,p.map(e=>e.hospitalId)));let i=p.map(e=>({version:e.hospital.version,hospitalId:e.hospitalId,changes:{action:"delete_hospital",description:"Delete hospital",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await n.Z.insert(o.hospitalsHistory).values(i),e?.publisherUserId)for(let s=0;s<p.length;s++){let r=p[s],n=i[s];if(!r?.hospitalId)continue;let o={...r.hospital??{},deletedAt:t};a.push({entityId:r.hospitalId,entityType:"hospital",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),description:n.changes.description,userId:e.publisherUserId,hospitalId:r.hospitalId,isActive:!1})}}await n.Z.delete(o.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.K0)(o.pendingDeletion.hospitalId),(0,s.K0)(o.pendingDeletion.hospitalDraftId)),e?.userId?(0,s.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0));let h=[...d.map(e=>e.hospitalId),...p.map(e=>e.hospitalId)];if(h.length&&await n.Z.update(o.hospitals).set({version:(0,u.i6)`${o.hospitals.version} + 1`}).where((0,s.d3)(o.hospitals.hospitalId,h)),a.length){let e=await (0,g.F)({data:a,allowPartial:!0});e.errors?.length&&r.Z.error("_publishHospitals changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],r.Z.error("_publishHospitals ERROR",e)}finally{return t}}},82102:(e,t,a)=>{a.d(t,{Du:()=>h,Dy:()=>d,Eu:()=>u,LW:()=>c,MO:()=>l,vQ:()=>p});var s=a(57745),i=a(60938),r=a(10413),n=a(93567),o=a(57435);async function d(){try{return{data:await r.Z.query.appUpdatePolicies.findFirst({where:void 0,with:{currentApkRelease:!0,rollbackApkRelease:!0}})||null}}catch(e){return o.Z.error("_getAppUpdatePolicy ERROR",e.message),{data:null,errors:[e.message]}}}async function l(e){try{return{data:await r.Z.query.appUpdatePoliciesDrafts.findMany()}}catch(e){return o.Z.error("_getAppUpdatePolicyDrafts ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){try{let{statuses:t=[]}={...e};return{data:(await r.Z.query.apkReleasesDrafts.findMany()).filter(e=>{let a=e.data;return!t.length||t.includes(a?.status)})}}catch(e){return o.Z.error("_getApkReleaseDrafts ERROR",e.message),{data:[],errors:[e.message]}}}async function p(e){try{let{apkReleaseIds:t=[],statuses:a=[]}={...e},i=[...t.length?[(0,s.d3)(n.apkReleases.apkReleaseId,t)]:[],...a.length?[(0,s.d3)(n.apkReleases.status,a)]:[]];return{data:await r.Z.query.apkReleases.findMany({where:i.length?(0,s.xD)(...i):void 0})}}catch(e){return o.Z.error("_getApkReleases ERROR",e.message),{data:[],errors:[e.message]}}}let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0};async function u(){try{let[{count:e}]=await r.Z.select({count:(0,i.QX)()}).from(n.appUpdatePoliciesDrafts),[{count:t}]=await r.Z.select({count:(0,i.QX)()}).from(n.appUpdatePoliciesDrafts).where((0,s.Ft)(n.appUpdatePoliciesDrafts.policyId)),[{count:a}]=await r.Z.select({count:(0,i.QX)()}).from(n.appUpdatePoliciesDrafts).where((0,s.K0)(n.appUpdatePoliciesDrafts.policyId)),[{count:o}]=await r.Z.select({count:(0,i.QX)()}).from(n.appUpdatePolicies);return{data:{allPublished:o,publishedWithDrafts:a,allDrafts:e,newDrafts:t}}}catch(e){return o.Z.error("_countAppUpdatePolicies ERROR",e.message),{data:f,errors:[e.message]}}}let g={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0};async function h(){try{let[{count:e}]=await r.Z.select({count:(0,i.QX)()}).from(n.apkReleasesDrafts),[{count:t}]=await r.Z.select({count:(0,i.QX)()}).from(n.apkReleasesDrafts).where((0,s.Ft)(n.apkReleasesDrafts.apkReleaseId)),[{count:a}]=await r.Z.select({count:(0,i.QX)()}).from(n.apkReleasesDrafts).where((0,s.K0)(n.apkReleasesDrafts.apkReleaseId)),[{count:o}]=await r.Z.select({count:(0,i.QX)()}).from(n.apkReleases);return{data:{allPublished:o,publishedWithDrafts:a,allDrafts:e,newDrafts:t}}}catch(e){return o.Z.error("_countApkReleases ERROR",e.message),{data:g,errors:[e.message]}}}},17137:(e,t,a)=>{a.d(t,{G$:()=>u,ZV:()=>f,SL:()=>c,aP:()=>l});var s=a(57745),i=a(30900),r=a(9576),n=a(10413),o=a(93567),d=a(57435);async function l(e){try{let{configKeysIds:t,returnDraftsIfExist:a}={...e},d=t||[],l=d?.length?(0,s.d3)(o.configKeysDrafts.configKeyDraftId,d.map(e=>i.Z(e)?e:r.Z())):void 0,c=[...l?[l]:[]],p=a?await n.Z.query.configKeysDrafts.findMany({where:(0,s.xD)(...c)}):[];d=d.filter(e=>!p.map(e=>e.configKeyDraftId).includes(e));let f=p.length?(0,s.Nl)(o.configKeys.configKeyId,p.map(e=>e.configKeyDraftId)):void 0,u=d?.length?(0,s.d3)(o.configKeys.configKeyId,d.filter(e=>i.Z(e))):void 0,g=d?.length?(0,s.d3)(o.configKeys.oldConfigKeyId,d.filter(e=>!i.Z(e))):void 0,h=[(0,s.Ft)(o.configKeys.deletedAt),(0,s.Ft)(o.pendingDeletion),...u&&g?[(0,s.or)(u,g)]:[],f],y=(await n.Z.select({configKey:o.configKeys,pendingDeletion:o.pendingDeletion}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where(h.length?(0,s.xD)(...h):void 0)).map(e=>e.configKey),I=y.length?await n.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.configKeyId,y.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...y.map(e=>({...e,isDraft:!1,isDeleted:!1})),...p.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!I.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){let{configKeyId:t,returnDraftIfExists:a}={...e};try{if(!t)throw Error("Missing configKeyId");let e=i.Z(t)?(0,s.eq)(o.configKeys.configKeyId,t):void 0,r=i.Z(t)?void 0:(0,s.eq)(o.configKeys.oldConfigKeyId,t),d=e?(0,s.eq)(o.configKeysDrafts.configKeyDraftId,t):void 0,l=a&&d?await n.Z.query.configKeysDrafts.findFirst({where:e}):void 0,c=l?{...l.data,draftCreatedByUserId:l.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(c)return{data:c};let p=await n.Z.query.configKeys.findFirst({where:(0,s.xD)((0,s.Ft)(o.configKeys.deletedAt),e||r),with:{draft:!0}});l=a?p?.draft:void 0;let f=l?.data||p;if(!(c=f?{...f,draftCreatedByUserId:l?.createdByUserId,isDraft:!!l?.data,isDeleted:!1}:null))return{data:null};return{data:c}}catch(e){return d.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var p=a(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await n.Z.select({count:(0,p.QX)()}).from(o.configKeysDrafts),[{count:t}]=await n.Z.select({count:(0,p.QX)()}).from(o.configKeysDrafts).where((0,s.Ft)(o.configKeysDrafts.configKeyId)),[{count:a}]=await n.Z.select({count:(0,p.QX)()}).from(o.configKeysDrafts).where((0,s.K0)(o.configKeysDrafts.configKeyId)),[{count:i}]=await n.Z.select({count:(0,p.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.configKeyId)),[{count:r}]=await n.Z.select({count:(0,p.QX)()}).from(o.configKeys);return{data:{allPublished:r,publishedWithDrafts:a,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:f,errors:[e.message]}}}},18496:(e,t,a)=>{a.d(t,{y:()=>r});var s=a(10413),i=a(57435);async function r(){try{return{data:await s.Z.query.editorInfo.findFirst()||null}}catch(e){return i.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},20084:(e,t,a)=>{a.d(t,{Py:()=>u,SE:()=>f,C9:()=>c,O8:()=>l});var s=a(57745),i=a(30900),r=a(9576),n=a(10413),o=a(93567),d=a(57435);async function l(e){try{let{hospitalsIds:t,returnDraftsIfExist:a=!0}={...e},d=t||[],l=d?.length?(0,s.d3)(o.hospitalsDrafts.hospitalDraftId,d.map(e=>i.Z(e)?e:r.Z())):void 0,c=[...l?[l]:[]],p=a?await n.Z.query.hospitalsDrafts.findMany({where:(0,s.xD)(...c)}):[];d=d.filter(e=>!p.map(e=>e.hospitalDraftId).includes(e));let f=p.length?(0,s.Nl)(o.hospitals.hospitalId,p.map(e=>e.hospitalDraftId)):void 0,u=d?.length?(0,s.d3)(o.hospitals.hospitalId,d.filter(e=>i.Z(e))):void 0,g=d?.length?(0,s.d3)(o.hospitals.oldHospitalId,d.filter(e=>!i.Z(e))):void 0,h=[(0,s.Ft)(o.hospitals.deletedAt),(0,s.Ft)(o.pendingDeletion),...u&&g?[(0,s.or)(u,g)]:[],f],y=(await n.Z.select({hospital:o.hospitals,pendingDeletion:o.pendingDeletion}).from(o.hospitals).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.hospitalId,o.hospitals.hospitalId)).where(h.length?(0,s.xD)(...h):void 0)).map(e=>e.hospital),I=y.length?await n.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.hospitalId,y.map(e=>e.hospitalId)),columns:{hospitalId:!0}}):[];return{data:[...y.map(e=>({...e,isDraft:!1,isDeleted:!1,isUnpublishedDraft:!1})),...p.map(e=>({...e.data,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!e.hospitalId,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()).filter(e=>!I.map(e=>e.hospitalId).includes(e.hospitalId))}}catch(e){return d.Z.error("_getHospitals ERROR",e.message),{data:[],errors:[e.message]}}}async function c(e){let{hospitalId:t,returnDraftIfExists:a=!0}={...e};try{if(!t)throw Error("Missing hospitalId");let e=i.Z(t)?(0,s.eq)(o.hospitals.hospitalId,t):void 0,r=i.Z(t)?void 0:(0,s.eq)(o.hospitals.oldHospitalId,t),d=e?(0,s.eq)(o.hospitalsDrafts.hospitalDraftId,t):void 0,l=a&&d?await n.Z.query.hospitalsDrafts.findFirst({where:d}):void 0,c=l?{...l.data,draftCreatedByUserId:l.createdByUserId,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!l.hospitalId}:null;if(c)return{data:c};let p=await n.Z.query.hospitals.findFirst({where:(0,s.xD)((0,s.Ft)(o.hospitals.deletedAt),e||r),with:{draft:!0}});l=a?p?.draft:void 0;let f=l?.data||p;if(!(c=f?{...f,draftCreatedByUserId:l?.createdByUserId,isDraft:!!l?.data,isDeleted:!1,isUnpublishedDraft:!1}:null))return{data:null};return{data:c}}catch(e){return d.Z.error("_getHospital ERROR",e.message),{errors:[e.message]}}}var p=a(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await n.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts),[{count:t}]=await n.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts).where((0,s.Ft)(o.hospitalsDrafts.hospitalId)),[{count:a}]=await n.Z.select({count:(0,p.QX)()}).from(o.hospitalsDrafts).where((0,s.K0)(o.hospitalsDrafts.hospitalId)),[{count:i}]=await n.Z.select({count:(0,p.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.hospitalId)),[{count:r}]=await n.Z.select({count:(0,p.QX)()}).from(o.hospitals);return{data:{allPublished:r,publishedWithDrafts:a,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getHospitals ERROR",e.message),{data:f,errors:[e.message]}}}},25060:(e,t,a)=>{a.d(t,{Yi:()=>f,Ur:()=>c,Nb:()=>l,Ic:()=>p});var s=a(60938),i=a(57435),r=a(93567),n=a(10413),o=a(81445);let d={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function l(){try{let{lastPublishDate:e}={...await n.Z.query.editorInfo.findFirst()},t=await n.Z.select({configKeysDrafts:r.configKeysDrafts.updatedAt}).from(r.configKeysDrafts).orderBy((0,o.C)(r.configKeysDrafts.updatedAt)).limit(1),a=await n.Z.select({diagnosesDrafts:r.diagnosesDrafts.updatedAt}).from(r.diagnosesDrafts).orderBy((0,o.C)(r.diagnosesDrafts.updatedAt)).limit(1),s=await n.Z.select({screensDrafts:r.screensDrafts.updatedAt}).from(r.screensDrafts).orderBy((0,o.C)(r.screensDrafts.updatedAt)).limit(1),i=await n.Z.select({scriptsDrafts:r.scriptsDrafts.updatedAt}).from(r.scriptsDrafts).orderBy((0,o.C)(r.scriptsDrafts.updatedAt)).limit(1),l=await n.Z.select({configKeys:r.configKeys.updatedAt}).from(r.configKeys).orderBy((0,o.C)(r.configKeys.updatedAt)).limit(1),c=await n.Z.select({diagnoses:r.diagnoses.updatedAt}).from(r.diagnoses).orderBy((0,o.C)(r.diagnoses.updatedAt)).limit(1),p=await n.Z.select({screens:r.screens.updatedAt}).from(r.screens).orderBy((0,o.C)(r.screens.updatedAt)).limit(1),f=await n.Z.select({scripts:r.scripts.updatedAt}).from(r.scripts).orderBy((0,o.C)(r.scripts.updatedAt)).limit(1),u=await n.Z.select({pendingDeletion:r.pendingDeletion.createdAt}).from(r.pendingDeletion).orderBy((0,o.C)(r.pendingDeletion.createdAt)).limit(1),g={...d,...t[0],...a[0],...s[0],...i[0],...l[0],...c[0],...p[0],...f[0],...u[0],lastPublished:e||null},h=[e?new Date(e).getTime():null,...Object.values(g).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),y=e;return h.length&&(y=new Date(Math.max(...h))),{data:{...g,latestChangesDate:y}}}catch(e){return i.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:d,errors:[e.message]}}}async function c(){try{let e=await n.Z.select({count:(0,s.QX)()}).from(r.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return i.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let p={scripts:0,screens:0,diagnoses:0,configKeys:0,hospitals:0,drugsLibraryItems:0,total:0,dataKeys:0,appUpdatePolicies:0,apkReleases:0};async function f(){let e={...p};try{let t=await n.Z.select({count:(0,s.QX)()}).from(r.scriptsDrafts);e.scripts=t[0]?.count||0;let a=await n.Z.select({count:(0,s.QX)()}).from(r.screensDrafts);e.screens=a[0]?.count||0;let i=await n.Z.select({count:(0,s.QX)()}).from(r.diagnosesDrafts);e.diagnoses=i[0]?.count||0;let o=await n.Z.select({count:(0,s.QX)()}).from(r.configKeysDrafts);e.configKeys=o[0]?.count||0;let d=await n.Z.select({count:(0,s.QX)()}).from(r.hospitalsDrafts);e.hospitals=d[0]?.count||0;let l=await n.Z.select({count:(0,s.QX)()}).from(r.drugsLibraryDrafts);e.drugsLibraryItems=l[0]?.count||0;let c=await n.Z.select({count:(0,s.QX)()}).from(r.dataKeysDrafts);e.dataKeys=c[0]?.count||0;let p=await n.Z.select({count:(0,s.QX)()}).from(r.appUpdatePoliciesDrafts);e.appUpdatePolicies=p[0]?.count||0;let f=await n.Z.select({count:(0,s.QX)()}).from(r.apkReleasesDrafts);return e.apkReleases=f[0]?.count||0,e.total=Object.values(e).reduce((e,t)=>e+t,0),{...e}}catch(t){return i.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};