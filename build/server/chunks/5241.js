"use strict";exports.id=5241,exports.ids=[5241],exports.modules={54491:(e,s,t)=>{t.d(s,{hf:()=>f,uW:()=>I});var i=t(21162),r=t(10413),n=t(57745),a=t(81445),d=t(93567),o=t(57435);function c(e){if(!e||""===e)return"A";let s=e.match(/^([A-Z]+)(\d*)$/);if(!s)throw Error("Invalid alias format");let[t,i,r]=s,n=r?parseInt(r,10):0,a=(e=>{let s="";do s=String.fromCharCode(e%26+65)+s,e=Math.floor(e/26)-1;while(e>=0);return s})(i.split("").reduce((e,s)=>26*e+(s.charCodeAt(0)-65),0)+1);return a.length>i.length?(a="A")+(n+1):a+(r||"")}async function l(e,s,t,i){let r=[],n=t;for(let t of s)if(!["management","mwi_edliz_summary_table","progress","zw_edliz_summary_table","diagnosis","drugs","fluids","feeds"].includes(t.type)){if("form"===t.type&&Array.isArray(t.fields))for(let s of t.fields)Array.isArray(s.prePopulate)&&s.prePopulate.length>0&&!await p({name:s.key,script:e})&&(n=c(n))&&r.push({name:s.key,alias:n,script:e,oldScript:i});else Array.isArray(t.prePopulate)&&t.prePopulate.length>0&&!await p({name:t.key,script:e})&&(n=c(n))&&r.push({name:t.key,alias:n,script:e,oldScript:i})}return r}async function p(e){return!!await r.Z.query.aliases.findFirst({where:(0,n.xD)((0,n.eq)(d.aliases.script,e.script),(0,n.eq)(d.aliases.name,e.name))})}async function g(){return!!await r.Z.query.aliases.findFirst()}async function u(e){let s={success:!1},t=[],i={};try{for(let s of e)try{if(!await r.Z.query.aliases.findFirst({where:(0,n.xD)((0,n.eq)(d.aliases.script,s.script),(0,n.eq)(d.aliases.name,s.name)),orderBy:(0,a.C)(d.aliases.createdAt)})){let e=r.Z.insert(d.aliases).values({alias:s.alias,name:s.name,script:s.script,oldScript:s.oldScript});i.query=e.toSQL(),await e.execute()}}catch(e){o.Z.error(e.message),t.push(e.message)}t.length?(s.errors=t,s.info=i):s.success=!0}catch(e){s.success=!1,s.errors=[e.message],s.info=i}}async function h(e){try{let s=e?await r.Z.query.aliases.findFirst({where:(0,n.eq)(d.aliases.script,e),orderBy:(0,a.C)(d.aliases.createdAt)}):"";return s?s.alias:""}catch(e){}}async function f(){try{let e=await (0,i.eh)();await g()||await I(e)}catch(e){}}async function I(e){try{for(let s of e)if(s){let e=await (0,i.A0)(s),t=await h(s),r=[s],{data:n,errors:a}=await (0,i.uK)({scriptsIds:r});if(!a||0===a.length){let i=await l(s,n,t||"",e?.[0]??null);i&&i.length>0&&await u(i)}}}catch(e){o.Z.error("Error in _generateScreenAliases:",e)}}},36864:(e,s,t)=>{t.d(s,{C:()=>V,F:()=>_});var i=t(57745),r=t(81445),n=t(84770),a=t(30900),d=t(9576),o=t(57435),c=t(10413),l=t(93567),p=t(88317),g=t(34149);let u={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},h={screen:["scriptId"],diagnosis:["scriptId"]},f=["alias","release"],I=["release"],y={script:{table:l.scripts,idColumn:l.scripts.scriptId,versionColumn:l.scripts.version,entityLabel:"script"},screen:{table:l.screens,idColumn:l.screens.screenId,versionColumn:l.screens.version,entityLabel:"screen"},diagnosis:{table:l.diagnoses,idColumn:l.diagnoses.diagnosisId,versionColumn:l.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:l.configKeys,idColumn:l.configKeys.configKeyId,versionColumn:l.configKeys.version,entityLabel:"config key"},drugs_library:{table:l.drugsLibrary,idColumn:l.drugsLibrary.itemId,versionColumn:l.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:l.dataKeys,idColumn:l.dataKeys.uuid,versionColumn:l.dataKeys.version,entityLabel:"data key"},hospital:{table:l.hospitals,idColumn:l.hospitals.hospitalId,versionColumn:l.hospitals.version,entityLabel:"hospital"}},w={script:{table:l.scripts,idColumn:l.scripts.scriptId,entityLabel:"script"},screen:{table:l.screens,idColumn:l.screens.screenId,entityLabel:"screen"},diagnosis:{table:l.diagnoses,idColumn:l.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:l.configKeys,idColumn:l.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:l.drugsLibrary,idColumn:l.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:l.dataKeys,idColumn:l.dataKeys.uuid,entityLabel:"data key"},alias:{table:l.aliases,idColumn:l.aliases.uuid,entityLabel:"alias"},hospital:{table:l.hospitals,idColumn:l.hospitals.hospitalId,entityLabel:"hospital"}};function v(e){let s=0;for(let t=0;t<e.length;t++)s=31*s+e.charCodeAt(t)|0;return s}async function m(e,s,t){let i=v(s),r=v(t);await e.execute((0,g.i6)`select pg_advisory_xact_lock(${i}, ${r})`)}function D(e){return(0,n.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function b(e,s){let t=y[s.entityType];if(!t)throw Error(`Unknown entityType ${s.entityType}`);let r=await e.select({version:t.versionColumn}).from(t.table).where((0,i.eq)(t.idColumn,s.entityId)).limit(1),n=r?.[0]?.version;if(!Number.isFinite(n))throw Error(`Missing ${t.entityLabel} or version for entityId ${s.entityId}`);return Number(n)}async function Z(e,s,t){let n=await e.select({version:l.changeLogs.version}).from(l.changeLogs).where((0,i.xD)((0,i.eq)(l.changeLogs.entityId,s),(0,i.eq)(l.changeLogs.entityType,t))).orderBy((0,r.C)(l.changeLogs.version)).limit(1);return n?.[0]?.version}async function q(e,s){let t=w[s.entityType];if(!t)throw Error(`Unknown entityType ${s.entityType}`);let r=await e.select().from(t.table).where((0,i.eq)(t.idColumn,s.entityId)).limit(1);if(!r?.[0])throw Error(`Entity not found for snapshot (${t.entityLabel} ${s.entityId})`);return r[0]}async function L({client:e,data:s,computedVersion:t,dataVersion:i,baselineSnapshot:r}){if(Number.isFinite(await Z(e,s.entityId,s.entityType)))return;let n=r??s.previousSnapshot;if(void 0===n)try{n=await q(e,s),o.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:s.entityId,entityType:s.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,t-1),c=D(n),p={changeLogId:d.Z(),entityId:s.entityId,entityType:s.entityType,action:"create",version:a,dataVersion:i,changes:[],fullSnapshot:n,previousSnapshot:n,snapshotHash:c,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:s.userId,scriptId:s.scriptId,screenId:s.screenId,diagnosisId:s.diagnosisId,configKeyId:s.configKeyId,hospitalId:s.hospitalId,drugsLibraryItemId:s.drugsLibraryItemId,dataKeyId:s.dataKeyId,aliasId:s.aliasId,dateOfChange:new Date};return await e.insert(l.changeLogs).values(p),a}async function V({data:e,broadcastAction:s,client:t}){let r={success:!1};try{!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!a.Z(e.userId))throw Error("Invalid userId");if(I.includes(e.entityType)){if(Object.values(u).map(s=>e[s]).filter(e=>null!=e).length)throw Error(`No foreign keys should be provided for entityType ${e.entityType}`);return}let s=u[e.entityType];if(!s)throw Error(`Unknown entityType ${e.entityType}`);let t=e[s];if(!t||"string"!=typeof t||!a.Z(t))throw Error(`Missing or invalid ${s} for entityType ${e.entityType}`);if(t!==e.entityId)throw Error(`entityId must match ${s} for entityType ${e.entityType}`);let i=h[e.entityType]||[];for(let s of i){let t=e[s];if(null!=t&&("string"!=typeof t||!a.Z(t)))throw Error(`Invalid ${String(s)} for entityType ${e.entityType}`)}if(Object.entries(u).map(([s,t])=>({type:s,key:t,value:e[t]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(s=>s.type!==e.entityType&&!i.includes(s.key)))throw Error(`Only the ${s} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let s=Number(e.dataVersion);if(!Number.isFinite(s)||s<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let n=async s=>{var t;let r,n,a;await m(s,e.entityType,e.entityId);let c=d.Z(),p=(t=e.entityType,f.includes(t)),g=Number.isFinite(e.version)?Number(e.version):null,u=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(p){let t=await Z(s,e.entityId,e.entityType);if(n=t,r=(t??0)+1,a=await L({client:s,data:e,computedVersion:r,dataVersion:u,baselineSnapshot:e.baselineSnapshot}),null!==g&&g!==r){if(g<r);else throw o.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:g,latestChangeLogVersion:t,computedVersion:r}),Error(`Provided version (${e.version}) does not match expected changelog version (${r}) for versionless entity ${e.entityType}`)}}else{let t=e.entityType,i=await b(s,{...e,entityType:t}),d=y[t],c=await Z(s,e.entityId,e.entityType);if(n=c,Number.isFinite(c)){let e=Number(c)+1;r=i<=Number(c)?e:i}else r=i;if(a=await L({client:s,data:e,computedVersion:r,dataVersion:u,baselineSnapshot:e.baselineSnapshot}),null!==g&&g!==r){if(g<r);else throw o.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:g,entityVersion:i,latestChangeLogVersion:c,computedVersion:r}),Error(`Provided version (${e.version}) does not match ${d.entityLabel} version (${r})`)}}let h=e.snapshotHash||D(e.fullSnapshot);if(!h)throw Error("snapshotHash is required");let I=e.previousSnapshot??e.baselineSnapshot??{},w={changeLogId:c,entityId:e.entityId,entityType:e.entityType,action:e.action,version:r,dataVersion:u,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:I,snapshotHash:h,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===n?a:n),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,hospitalId:e.hospitalId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[v]=await s.insert(l.changeLogs).values(w).returning();return v&&v.entityId&&Number.isFinite(v.version)&&await s.update(l.changeLogs).set({isActive:!1,supersededBy:v.version,supersededAt:v.dateOfChange??new Date}).where((0,i.xD)((0,i.eq)(l.changeLogs.entityId,v.entityId),(0,i.eq)(l.changeLogs.entityType,v.entityType),(0,i.lt)(l.changeLogs.version,v.version),(0,i.eq)(l.changeLogs.isActive,!0))),v},g=t?await n(t):await c.Z.transaction(n);return r.success=!0,r.data=g,s&&p.Z.emit("data_changed","save_change_log"),r}catch(e){return r.success=!1,r.errors=[e.message],o.Z.error("_saveChangeLog ERROR",e.message),r}}async function _({data:e,broadcastAction:s,allowPartial:t}){let i=0,r=[];try{if(t&&e.some(e=>"rollback"===e.action))throw Error("allowPartial is not permitted for rollback changelog writes");if(t)for(let s of e){let e=await V({data:s});if(e.errors?.length){r.push(...e.errors);continue}i++}else await c.Z.transaction(async s=>{for(let t of e){let e=await V({data:t,client:s});if(e.errors?.length)throw r.push(...e.errors),Error(r.join(", "));i++}});return s&&!r.length&&p.Z.emit("data_changed","save_change_logs"),{success:!r.length,errors:r.length?r:void 0,saved:i}}catch(e){return o.Z.error("_saveChangeLogs ERROR",e.message),i=0,{success:!1,errors:[e.message],saved:i}}}},45241:(e,s,t)=>{t.d(s,{cF:()=>p,In:()=>c,VQ:()=>u,Bx:()=>g,GH:()=>l,Es:()=>h,gv:()=>q,Ry:()=>b,Ls:()=>L,Pk:()=>_.P,uD:()=>V.u,Or:()=>i.O});var i=t(4454),r=t(57745),n=t(57435),a=t(10413),d=t(93567),o=t(88317);async function c(e){try{return await a.Z.delete(d.screensDrafts).where(e?.userId?(0,r.eq)(d.screensDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function l({screensIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:i,userId:c}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the screens, please confirm this action!");await a.Z.delete(d.screensDrafts).where((0,r.xD)(e.length?(0,r.d3)(d.screensDrafts.screenDraftId,e):void 0,s.length?(0,r.or)((0,r.d3)(d.screensDrafts.scriptId,s),(0,r.d3)(d.screensDrafts.scriptDraftId,s)):void 0));let i=(await a.Z.select({screenId:d.screens.screenId,screenScriptId:d.screens.scriptId,scriptDraftId:d.scriptsDrafts.scriptDraftId,pendingDeletion:d.pendingDeletion}).from(d.screens).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.screenId,d.screens.screenId)).leftJoin(d.scriptsDrafts,(0,r.eq)(d.scriptsDrafts.scriptId,d.screens.scriptId)).where((0,r.xD)((0,r.Ft)(d.screens.deletedAt),(0,r.Ft)(d.pendingDeletion),e.length?(0,r.d3)(d.screens.screenId,e):void 0,s.length?(0,r.d3)(d.screens.scriptId,s):void 0))).map(e=>({...e,createdByUserId:c}));i.length&&await a.Z.insert(d.pendingDeletion).values(i),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_deleteScreens ERROR",e.message)}finally{return!l?.errors?.length&&i&&o.Z.emit("data_changed","delete_screens"),l}}async function p(e){try{return await a.Z.delete(d.diagnosesDrafts).where(e?.userId?(0,r.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function g({diagnosesIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:i,userId:c}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the diagnoses, please confirm this action!");await a.Z.delete(d.diagnosesDrafts).where((0,r.xD)(e.length?(0,r.d3)(d.diagnosesDrafts.diagnosisDraftId,e):void 0,s.length?(0,r.or)((0,r.d3)(d.diagnosesDrafts.scriptId,s),(0,r.d3)(d.diagnosesDrafts.scriptDraftId,s)):void 0));let i=(await a.Z.select({diagnosisId:d.diagnoses.diagnosisId,diagnosisScriptId:d.diagnoses.scriptId,scriptDraftId:d.scriptsDrafts.scriptDraftId,pendingDeletion:d.pendingDeletion}).from(d.diagnoses).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.diagnosisId,d.diagnoses.diagnosisId)).leftJoin(d.scriptsDrafts,(0,r.eq)(d.scriptsDrafts.scriptId,d.diagnoses.scriptId)).where((0,r.xD)((0,r.Ft)(d.diagnoses.deletedAt),(0,r.Ft)(d.pendingDeletion),e.length?(0,r.d3)(d.diagnoses.diagnosisId,e):void 0,s.length?(0,r.d3)(d.diagnoses.scriptId,s):void 0))).map(e=>({...e,createdByUserId:c}));i.length&&await a.Z.insert(d.pendingDeletion).values(i),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_deleteDiagnoses ERROR",e.message)}finally{return!l?.errors?.length&&i&&o.Z.emit("data_changed","delete_diagnoses"),l}}async function u(e){try{return await a.Z.delete(d.scriptsDrafts).where(e?.userId?(0,r.eq)(d.scriptsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function h({scriptsIds:e=[],broadcastAction:s,confirmDeleteAll:t,userId:i}){let c={success:!1};try{if(!e.length&&!t)throw Error("You&apos;re about to delete all the scripts, please confirm this action!");await a.Z.delete(d.scriptsDrafts).where((0,r.or)((0,r.d3)(d.scriptsDrafts.scriptId,e),(0,r.d3)(d.scriptsDrafts.scriptDraftId,e)));let s=await a.Z.select({scriptId:d.scripts.scriptId,pendingDeletion:d.pendingDeletion}).from(d.scripts).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.scriptId,d.scripts.scriptId)).where((0,r.xD)((0,r.Ft)(d.scripts.deletedAt),(0,r.Ft)(d.pendingDeletion),e.length?(0,r.d3)(d.scripts.scriptId,e):void 0));(s=s.map(e=>({...e,createdByUserId:i}))).length&&(await a.Z.insert(d.pendingDeletion).values(s.map(e=>({scriptId:e.scriptId}))),await l({scriptsIds:s.map(e=>e.scriptId)}),await g({scriptsIds:s.map(e=>e.scriptId)})),c.success=!0}catch(e){c.success=!1,c.errors=[e.message],n.Z.error("_deleteScripts ERROR",e.message)}finally{return!c?.errors?.length&&s&&o.Z.emit("data_changed","delete_scripts"),c}}var f=t(34149),I=t(9576),y=t(36864),w=t(66776);async function v({previous:e,drafts:s,userId:t}){let i=[];try{let r=[];for(let n of s){let s=n?.data?.scriptId;if(!s)continue;let a={version:n?.data?.version||1,scriptId:s,changes:{}},d=1===(n?.data?.version||1);if(d)a.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let t=e.find(e=>e.scriptId===s),i=[],r=[];Object.keys({...n?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,w.VL)(n.data[e]),a={...t}[e];JSON.stringify(s)!==JSON.stringify(a)&&(i.push({[e]:a}),r.push({[e]:s}))}),a.changes={action:"update_script",description:"Update script",oldValues:i,newValues:r}}if(r.push(a),t){let{...r}=n.data||{},o=(0,w.VL)(r),c=d?{}:(0,w.VL)(e.find(e=>e.scriptId===s)||{});i.push({entityId:s,entityType:"script",action:d?"create":"update",version:a.version||1,changes:a.changes,fullSnapshot:o,previousSnapshot:c,baselineSnapshot:c,userId:t,scriptId:s})}}r.length&&await a.Z.insert(d.scriptsHistory).values(r)}catch(e){n.Z.error(e.message)}return i}async function m({previous:e,drafts:s,userId:t}){let i=[];try{let r=[];for(let n of s){let s=n?.data?.screenId;if(!s)continue;let a={version:n?.data?.version||1,screenId:s,scriptId:n?.data?.scriptId,changes:{}},d=1===(n?.data?.version||1);if(d)a.changes={action:"create_screen",description:"Create screen",oldValues:[],newValues:[]};else{let t=e.find(e=>e.screenId===s),i=[],r=[];Object.keys({...n?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,w.VL)(n.data[e]),a={...t}[e];JSON.stringify(s)!==JSON.stringify(a)&&(i.push({[e]:a}),r.push({[e]:s}))}),a.changes={action:"update_screen",description:"Update screen",oldValues:i,newValues:r}}if(r.push(a),t){let{...r}=n.data||{},o=(0,w.VL)(r),c=d?{}:(0,w.VL)(e.find(e=>e.screenId===s)||{});i.push({entityId:s,entityType:"screen",action:d?"create":"update",version:a.version||1,changes:a.changes,fullSnapshot:o,previousSnapshot:c,baselineSnapshot:c,userId:t,scriptId:n?.data?.scriptId||null,screenId:s})}}r.length&&await a.Z.insert(d.screensHistory).values(r)}catch(e){n.Z.error(e.message)}return i}var D=t(54491);async function b(e){let{scriptsIds:s,screensIds:t}={...e},i={success:!1},o=[];try{let c=[],l=[];if(s?.length||t?.length){let i=await a.Z.query.screensDrafts.findMany({where:(0,r.xD)((0,r.or)(s?.length?(0,r.d3)(d.screensDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(d.screensDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(d.screensDrafts.screenId,t):void 0,t?.length?(0,r.d3)(d.screensDrafts.screenDraftId,t):void 0),e?.userId?(0,r.eq)(d.screensDrafts.createdByUserId,e.userId):void 0)});c=i.filter(e=>e.screenId),l=i.filter(e=>!e.screenId)}else{let s=await a.Z.query.screensDrafts.findMany({where:(0,r.xD)((0,r.K0)(d.screensDrafts.scriptId),e?.userId?(0,r.eq)(d.screensDrafts.createdByUserId,e.userId):void 0)});c=s.filter(e=>e.screenId),l=s.filter(e=>!e.screenId)}if(c.length){let s=[];for(let{screenId:e,data:t}of(c.filter(e=>e.screenId).length&&(s=await a.Z.query.screens.findMany({where:(0,r.d3)(d.screens.screenId,c.filter(e=>e.screenId).map(e=>e.screenId))})),c)){let{screenId:s,id:i,oldScreenId:n,createdAt:o,updatedAt:c,deletedAt:l,...p}=t,g={...p,publishDate:new Date};await a.Z.update(d.screens).set(g).where((0,r.eq)(d.screens.screenId,e)).returning()}let t=await m({drafts:c,previous:s,userId:e?.publisherUserId});o.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}if(l.length){let s=[];for(let{id:e,scriptId:t,scriptDraftId:i,data:n}of(l.filter(e=>e.screenId).length&&(s=await a.Z.query.screens.findMany({where:(0,r.d3)(d.screens.screenId,l.filter(e=>e.screenId).map(e=>e.screenId))})),l)){let s=n.screenId||(0,I.Z)(),r=n.scriptId||t||i,o={...n,screenId:s,scriptId:r};l=l.map(t=>(t.id===e&&(t.data.screenId=s),t)),await a.Z.insert(d.screens).values(o)}let t=await m({drafts:l,previous:s,userId:e?.publisherUserId});o.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}await a.Z.delete(d.screensDrafts).where(e?.userId?(0,r.eq)(d.screensDrafts.createdByUserId,e.userId):void 0);let p=await a.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(d.pendingDeletion.screenId),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{screenId:!0},with:{screen:!0}});if((p=p.filter(e=>e.screen)).length){let s=new Date;await a.Z.update(d.screens).set({deletedAt:s}).where((0,r.d3)(d.screens.screenId,p.map(e=>e.screenId)));let t=p.map(e=>({version:e.screen.version,screenId:e.screenId,scriptId:e.screen.scriptId,changes:{action:"delete_screen",description:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:s}]}}));if(await a.Z.insert(d.screensHistory).values(t),e?.publisherUserId)for(let i=0;i<p.length;i++){let r=p[i],n=t[i];if(!r?.screenId)continue;let a=(0,w.VL)({...r.screen??{},deletedAt:s});o.push({entityId:r.screenId,entityType:"screen",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:a,description:n.changes.description,userId:e.publisherUserId,scriptId:r.screen?.scriptId||null,screenId:r.screenId,isActive:!1})}}await a.Z.delete(d.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(d.pendingDeletion.screenId),(0,r.K0)(d.pendingDeletion.screenDraftId)),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...c.map(e=>e.screenId),...p.map(e=>e.screenId)],u=Array.from(new Set((c??[]).map(e=>e.scriptId).filter(e=>!!e)));if(u.length&&await (0,D.uW)(u),g.length&&await a.Z.update(d.screens).set({version:(0,f.i6)`${d.screens.version} + 1`}).where((0,r.d3)(d.screens.screenId,g)),o.length){let e=await (0,y.F)({data:o,allowPartial:!0});e.errors?.length&&n.Z.error("_publishScreens changelog warnings",e.errors.join(", "))}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishScreens ERROR",e)}finally{return i}}async function Z({previous:e,drafts:s,userId:t}){let i=[];try{let r=[];for(let n of s){let s=n?.data?.diagnosisId;if(!s)continue;let a=1===(n?.data?.version||1),d=a?"Create diagnosis":"Update diagnosis",o={action:a?"create_diagnosis":"update_diagnosis",description:d,oldValues:[],newValues:[]},c=n?.data?.version||1,l={version:c,diagnosisId:s,scriptId:n?.data?.scriptId??"",changes:o};if(!a){let t=e.find(e=>e.diagnosisId===s);Object.keys({...n?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,w.VL)(n.data[e]),i={...t}[e];JSON.stringify(s)!==JSON.stringify(i)&&(o.oldValues.push({[e]:i}),o.newValues.push({[e]:s}))})}if(r.push(l),t){let r=(0,w.VL)(n.data||{}),l=a?{}:(0,w.VL)(e.find(e=>e.diagnosisId===s)||{});i.push({entityId:s,entityType:"diagnosis",action:a?"create":"update",version:c,changes:o,fullSnapshot:r,previousSnapshot:l,baselineSnapshot:l,description:d,userId:t,scriptId:n?.data?.scriptId||null,diagnosisId:s})}}r.length&&await a.Z.insert(d.diagnosesHistory).values(r)}catch(e){n.Z.error(e.message)}return i}async function q(e){let{scriptsIds:s,diagnosesIds:t}={...e},i={success:!1},o=[];try{let c=[],l=[];if(s?.length||t?.length){let i=await a.Z.query.diagnosesDrafts.findMany({where:(0,r.xD)((0,r.or)(s?.length?(0,r.d3)(d.diagnosesDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(d.diagnosesDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(d.diagnosesDrafts.diagnosisId,t):void 0,t?.length?(0,r.d3)(d.diagnosesDrafts.diagnosisDraftId,t):void 0),e?.userId?(0,r.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0)});c=i.filter(e=>e.diagnosisId),l=i.filter(e=>!e.diagnosisId)}else{let s=await a.Z.query.diagnosesDrafts.findMany({where:(0,r.xD)((0,r.K0)(d.diagnosesDrafts.scriptId),e?.userId?(0,r.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0)});c=s.filter(e=>e.diagnosisId),l=s.filter(e=>!e.diagnosisId)}if(c.length){let s=[];for(let{diagnosisId:e,data:t}of(c.filter(e=>e.diagnosisId).length&&(s=await a.Z.query.diagnoses.findMany({where:(0,r.d3)(d.diagnoses.diagnosisId,c.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),c)){let{diagnosisId:s,id:i,oldDiagnosisId:n,createdAt:o,updatedAt:c,deletedAt:l,...p}=t,g={...p,publishDate:new Date};await a.Z.update(d.diagnoses).set(g).where((0,r.eq)(d.diagnoses.diagnosisId,e)).returning()}let t=await Z({drafts:c,previous:s,userId:e?.publisherUserId});o.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}if(l.length){let s=[];for(let{id:e,scriptId:t,scriptDraftId:i,data:n}of(l.filter(e=>e.diagnosisId).length&&(s=await a.Z.query.diagnoses.findMany({where:(0,r.d3)(d.diagnoses.diagnosisId,l.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),l)){let s=n.diagnosisId||(0,I.Z)(),r=n.scriptId||t||i,o={...n,diagnosisId:s,scriptId:r};l=l.map(t=>(t.id===e&&(t.data.diagnosisId=s),t)),await a.Z.insert(d.diagnoses).values(o)}let t=await Z({drafts:l,previous:s,userId:e?.publisherUserId});o.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}await a.Z.delete(d.diagnosesDrafts).where(e?.userId?(0,r.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0);let p=await a.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(d.pendingDeletion.diagnosisId),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{diagnosisId:!0},with:{diagnosis:!0}});if((p=p.filter(e=>e.diagnosis)).length){let s=new Date;await a.Z.update(d.diagnoses).set({deletedAt:s}).where((0,r.d3)(d.diagnoses.diagnosisId,p.map(e=>e.diagnosisId)));let t=p.map(e=>({version:e.diagnosis.version,diagnosisId:e.diagnosisId,scriptId:e.diagnosis.scriptId,changes:{action:"delete_diagnosis",description:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:s}]}}));if(await a.Z.insert(d.diagnosesHistory).values(t),e?.publisherUserId)for(let i=0;i<p.length;i++){let r=p[i],n=t[i];if(!r?.diagnosisId)continue;let a=(0,w.VL)({...r.diagnosis??{},deletedAt:s});o.push({entityId:r.diagnosisId,entityType:"diagnosis",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:a,description:n.changes.description,userId:e.publisherUserId,scriptId:r.diagnosis?.scriptId||null,diagnosisId:r.diagnosisId,isActive:!1})}}await a.Z.delete(d.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(d.pendingDeletion.diagnosisId),(0,r.K0)(d.pendingDeletion.diagnosisDraftId)),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...c.map(e=>e.diagnosisId),...p.map(e=>e.diagnosisId)];if(g.length&&await a.Z.update(d.diagnoses).set({version:(0,f.i6)`${d.diagnoses.version} + 1`}).where((0,r.d3)(d.diagnoses.diagnosisId,g)),o.length){let e=await (0,y.F)({data:o,allowPartial:!0});e.errors?.length&&n.Z.error("_publishDiagnoses changelog warnings",e.errors.join(", "))}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishDiagnoses ERROR",e)}finally{return i}}async function L({userId:e,publisherUserId:s,dataVersion:t}){let i={success:!1},o=[];try{let c=await a.Z.query.scriptsDrafts.findMany({where:e?(0,r.eq)(d.scriptsDrafts.createdByUserId,e):void 0}),l=c.filter(e=>!e.scriptId).map(e=>({...e,scriptId:e.data.scriptId||(0,I.Z)(),data:{...e.data,scriptId:e.data.scriptId||(0,I.Z)()}})),p=c.filter(e=>e.scriptId);[...l.map(e=>e.scriptId),...p.map(e=>e.scriptId)];let g=[];if(p.length){let e=[];for(let{scriptId:s,data:t}of(p.filter(e=>e.scriptId).length&&(e=await a.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.scriptId,p.filter(e=>e.scriptId).map(e=>e.scriptId))})),p)){let{scriptId:e,id:i,oldScriptId:n,createdAt:o,updatedAt:c,deletedAt:l,...p}=t,u={...p,publishDate:new Date};await a.Z.update(d.scripts).set(u).where((0,r.eq)(d.scripts.scriptId,s)),g.push({scriptId:s})}let i=await v({drafts:p,previous:e,userId:s});o.push(...i.map(e=>({...e,dataVersion:t})))}if(l.length){let e=[];l.filter(e=>e.scriptId).length&&(e=await a.Z.query.scripts.findMany({where:(0,r.d3)(d.scripts.scriptId,l.filter(e=>e.scriptId).map(e=>e.scriptId))}));let i=l.map(e=>({...e.data,scriptId:e.scriptDraftId}));for(let{scriptId:e}of(await a.Z.insert(d.scripts).values(i),i))g.push({scriptId:e}),await a.Z.update(d.screensDrafts).set({scriptId:e}).where((0,r.or)((0,r.eq)(d.screensDrafts.scriptId,e),(0,r.eq)(d.screensDrafts.scriptDraftId,e))),await a.Z.update(d.diagnosesDrafts).set({scriptId:e}).where((0,r.or)((0,r.eq)(d.diagnosesDrafts.scriptId,e),(0,r.eq)(d.diagnosesDrafts.scriptDraftId,e)));let n=await v({drafts:l,previous:e,userId:s});o.push(...n.map(e=>({...e,dataVersion:t})))}if(g.length){let i=await b({userId:e,publisherUserId:s,scriptsIds:g.map(e=>e.scriptId),dataVersion:t});if(i.errors)throw Error(i.errors.join(", "));let r=await q({userId:e,publisherUserId:s,scriptsIds:g.map(e=>e.scriptId),dataVersion:t});if(r.errors)throw Error(r.errors.join(", "))}let u=await a.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(d.pendingDeletion.scriptId),e?(0,r.eq)(d.pendingDeletion.createdByUserId,e):void 0),columns:{scriptId:!0},with:{script:!0}});if(await a.Z.delete(d.scriptsDrafts).where(e?(0,r.eq)(d.scriptsDrafts.createdByUserId,e):void 0),(u=u.filter(e=>e.script)).length){let e=new Date;await a.Z.update(d.scripts).set({deletedAt:e}).where((0,r.d3)(d.scripts.scriptId,u.map(e=>e.scriptId)));let i=u.map(s=>({version:s.script.version,scriptId:s.scriptId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}}));if(await a.Z.insert(d.scriptsHistory).values(i),s)for(let r=0;r<u.length;r++){let n=u[r],a=i[r];if(!n?.scriptId)continue;let d=(0,w.VL)({...n.script??{},deletedAt:e});o.push({entityId:n.scriptId,entityType:"script",action:"delete",version:a.version||1,dataVersion:t,changes:a.changes,fullSnapshot:d,previousSnapshot:d,baselineSnapshot:d,description:a.changes.description,userId:s,scriptId:n.scriptId,isActive:!1})}}await a.Z.delete(d.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(d.pendingDeletion.scriptId),(0,r.K0)(d.pendingDeletion.scriptDraftId)),e?(0,r.eq)(d.pendingDeletion.createdByUserId,e):void 0));let h=[...p.map(e=>e.scriptId),...u.map(e=>e.scriptId)];if(h.length&&await a.Z.update(d.scripts).set({version:(0,f.i6)`${d.scripts.version} + 1`}).where((0,r.d3)(d.scripts.scriptId,h)),o.length){let e=await (0,y.F)({data:o,allowPartial:!0});e.errors?.length&&n.Z.error("_publishScripts changelog warnings",e.errors.join(", "))}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishScripts ERROR",e.message)}finally{return i}}var V=t(55090),_=t(94081)}};