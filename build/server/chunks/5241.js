"use strict";exports.id=5241,exports.ids=[5241],exports.modules={54491:(e,s,t)=>{t.d(s,{hf:()=>u,uW:()=>h});var r=t(21162),i=t(10413),a=t(57745),n=t(81445),d=t(93567),c=t(57435);function o(e){if(!e||""===e)return"A";let s=e.match(/^([A-Z]+)(\d*)$/);if(!s)throw Error("Invalid alias format");let[t,r,i]=s,a=i?parseInt(i,10):0,n=(e=>{let s="";do s=String.fromCharCode(e%26+65)+s,e=Math.floor(e/26)-1;while(e>=0);return s})(r.split("").reduce((e,s)=>26*e+(s.charCodeAt(0)-65),0)+1);return n.length>r.length?(n="A")+(a+1):n+(i||"")}async function l(e,s,t,r){let i=[],a=t;for(let t of s)if(!["management","mwi_edliz_summary_table","progress","zw_edliz_summary_table","diagnosis","drugs","fluids","feeds"].includes(t.type)){if("form"===t.type&&Array.isArray(t.fields))for(let s of t.fields)Array.isArray(s.prePopulate)&&s.prePopulate.length>0&&!await p({name:s.key,script:e})&&(a=o(a))&&i.push({name:s.key,alias:a,script:e,oldScript:r});else Array.isArray(t.prePopulate)&&t.prePopulate.length>0&&!await p({name:t.key,script:e})&&(a=o(a))&&i.push({name:t.key,alias:a,script:e,oldScript:r})}return i}async function p(e){return!!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,e.script),(0,a.eq)(d.aliases.name,e.name))})}async function g(){return!!await i.Z.query.aliases.findFirst()}async function f(e){let s={success:!1},t=[],r={};try{for(let s of e)try{if(!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,s.script),(0,a.eq)(d.aliases.name,s.name)),orderBy:(0,n.C)(d.aliases.createdAt)})){let e=i.Z.insert(d.aliases).values({alias:s.alias,name:s.name,script:s.script,oldScript:s.oldScript});r.query=e.toSQL(),await e.execute()}}catch(e){c.Z.error(e.message),t.push(e.message)}t.length?(s.errors=t,s.info=r):s.success=!0}catch(e){s.success=!1,s.errors=[e.message],s.info=r}}async function I(e){try{let s=e?await i.Z.query.aliases.findFirst({where:(0,a.eq)(d.aliases.script,e),orderBy:(0,n.C)(d.aliases.createdAt)}):"";return s?s.alias:""}catch(e){}}async function u(){try{let e=await (0,r.eh)();await g()||await h(e)}catch(e){}}async function h(e){try{for(let s of e)if(s){let e=await (0,r.A0)(s),t=await I(s),i=[s],{data:a,errors:n}=await (0,r.uK)({scriptsIds:i});if(!n||0===n.length){let r=await l(s,a,t||"",e?.[0]??null);r&&r.length>0&&await f(r)}}}catch(e){c.Z.error("Error in _generateScreenAliases:",e)}}},45241:(e,s,t)=>{t.d(s,{cF:()=>p,In:()=>o,VQ:()=>f,Bx:()=>g,GH:()=>l,Es:()=>I,gv:()=>V,Ry:()=>Z,Ls:()=>S,Pk:()=>U.P,uD:()=>_.u,Or:()=>r.O});var r=t(4454),i=t(57745),a=t(57435),n=t(10413),d=t(93567),c=t(88317);async function o(e){try{return await n.Z.delete(d.screensDrafts).where(e?.userId?(0,i.eq)(d.screensDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function l({screensIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:r,userId:o}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the screens, please confirm this action!");await n.Z.delete(d.screensDrafts).where((0,i.xD)(e.length?(0,i.d3)(d.screensDrafts.screenDraftId,e):void 0,s.length?(0,i.or)((0,i.d3)(d.screensDrafts.scriptId,s),(0,i.d3)(d.screensDrafts.scriptDraftId,s)):void 0));let r=(await n.Z.select({screenId:d.screens.screenId,screenScriptId:d.screens.scriptId,scriptDraftId:d.scriptsDrafts.scriptDraftId,pendingDeletion:d.pendingDeletion}).from(d.screens).leftJoin(d.pendingDeletion,(0,i.eq)(d.pendingDeletion.screenId,d.screens.screenId)).leftJoin(d.scriptsDrafts,(0,i.eq)(d.scriptsDrafts.scriptId,d.screens.scriptId)).where((0,i.xD)((0,i.Ft)(d.screens.deletedAt),(0,i.Ft)(d.pendingDeletion),e.length?(0,i.d3)(d.screens.screenId,e):void 0,s.length?(0,i.d3)(d.screens.scriptId,s):void 0))).map(e=>({...e,createdByUserId:o}));r.length&&await n.Z.insert(d.pendingDeletion).values(r),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],a.Z.error("_deleteScreens ERROR",e.message)}finally{return!l?.errors?.length&&r&&c.Z.emit("data_changed","delete_screens"),l}}async function p(e){try{return await n.Z.delete(d.diagnosesDrafts).where(e?.userId?(0,i.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function g({diagnosesIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:r,userId:o}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the diagnoses, please confirm this action!");await n.Z.delete(d.diagnosesDrafts).where((0,i.xD)(e.length?(0,i.d3)(d.diagnosesDrafts.diagnosisDraftId,e):void 0,s.length?(0,i.or)((0,i.d3)(d.diagnosesDrafts.scriptId,s),(0,i.d3)(d.diagnosesDrafts.scriptDraftId,s)):void 0));let r=(await n.Z.select({diagnosisId:d.diagnoses.diagnosisId,diagnosisScriptId:d.diagnoses.scriptId,scriptDraftId:d.scriptsDrafts.scriptDraftId,pendingDeletion:d.pendingDeletion}).from(d.diagnoses).leftJoin(d.pendingDeletion,(0,i.eq)(d.pendingDeletion.diagnosisId,d.diagnoses.diagnosisId)).leftJoin(d.scriptsDrafts,(0,i.eq)(d.scriptsDrafts.scriptId,d.diagnoses.scriptId)).where((0,i.xD)((0,i.Ft)(d.diagnoses.deletedAt),(0,i.Ft)(d.pendingDeletion),e.length?(0,i.d3)(d.diagnoses.diagnosisId,e):void 0,s.length?(0,i.d3)(d.diagnoses.scriptId,s):void 0))).map(e=>({...e,createdByUserId:o}));r.length&&await n.Z.insert(d.pendingDeletion).values(r),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],a.Z.error("_deleteDiagnoses ERROR",e.message)}finally{return!l?.errors?.length&&r&&c.Z.emit("data_changed","delete_diagnoses"),l}}async function f(e){try{return await n.Z.delete(d.scriptsDrafts).where(e?.userId?(0,i.eq)(d.scriptsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function I({scriptsIds:e=[],broadcastAction:s,confirmDeleteAll:t,userId:r}){let o={success:!1};try{if(!e.length&&!t)throw Error("You&apos;re about to delete all the scripts, please confirm this action!");await n.Z.delete(d.scriptsDrafts).where((0,i.or)((0,i.d3)(d.scriptsDrafts.scriptId,e),(0,i.d3)(d.scriptsDrafts.scriptDraftId,e)));let s=await n.Z.select({scriptId:d.scripts.scriptId,pendingDeletion:d.pendingDeletion}).from(d.scripts).leftJoin(d.pendingDeletion,(0,i.eq)(d.pendingDeletion.scriptId,d.scripts.scriptId)).where((0,i.xD)((0,i.Ft)(d.scripts.deletedAt),(0,i.Ft)(d.pendingDeletion),e.length?(0,i.d3)(d.scripts.scriptId,e):void 0));(s=s.map(e=>({...e,createdByUserId:r}))).length&&(await n.Z.insert(d.pendingDeletion).values(s.map(e=>({scriptId:e.scriptId}))),await l({scriptsIds:s.map(e=>e.scriptId)}),await g({scriptsIds:s.map(e=>e.scriptId)})),o.success=!0}catch(e){o.success=!1,o.errors=[e.message],a.Z.error("_deleteScripts ERROR",e.message)}finally{return!o?.errors?.length&&s&&c.Z.emit("data_changed","delete_scripts"),o}}var u=t(34149),h=t(9576),w=t(36864),y=t(66776);async function D({previous:e,drafts:s,userId:t}){let r=[];try{let i=[];for(let a of s){let s=a?.data?.scriptId;if(!s)continue;let n={version:a?.data?.version||1,scriptId:s,changes:{}},d=1===(a?.data?.version||1);if(d)n.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let t=e.find(e=>e.scriptId===s),r=[],i=[];Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,y.VL)(a.data[e]),n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(r.push({[e]:n}),i.push({[e]:s}))}),n.changes={action:"update_script",description:"Update script",oldValues:r,newValues:i}}if(i.push(n),t){let{...i}=a.data||{},c=(0,y.VL)(i),o=d?{}:(0,y.VL)(e.find(e=>e.scriptId===s)||{});r.push({entityId:s,entityType:"script",action:d?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:c,previousSnapshot:o,baselineSnapshot:o,userId:t,scriptId:s})}}i.length&&await n.Z.insert(d.scriptsHistory).values(i)}catch(e){a.Z.error(e.message)}return r}async function v({previous:e,drafts:s,userId:t}){let r=[];try{let i=[];for(let a of s){let s=a?.data?.screenId;if(!s)continue;let n={version:a?.data?.version||1,screenId:s,scriptId:a?.data?.scriptId,changes:{}},d=1===(a?.data?.version||1);if(d)n.changes={action:"create_screen",description:"Create screen",oldValues:[],newValues:[]};else{let t=e.find(e=>e.screenId===s),r=[],i=[];Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,y.VL)(a.data[e]),n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(r.push({[e]:n}),i.push({[e]:s}))}),n.changes={action:"update_screen",description:"Update screen",oldValues:r,newValues:i}}if(i.push(n),t){let{...i}=a.data||{},c=(0,y.VL)(i),o=d?{}:(0,y.VL)(e.find(e=>e.screenId===s)||{});r.push({entityId:s,entityType:"screen",action:d?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:c,previousSnapshot:o,baselineSnapshot:o,userId:t,scriptId:a?.data?.scriptId||null,screenId:s})}}i.length&&await n.Z.insert(d.screensHistory).values(i)}catch(e){a.Z.error(e.message)}return r}var m=t(54491);async function Z(e){let{scriptsIds:s,screensIds:t}={...e},r={success:!1},c=[];try{let o=[],l=[];if(s?.length||t?.length){let r=await n.Z.query.screensDrafts.findMany({where:(0,i.xD)((0,i.or)(s?.length?(0,i.d3)(d.screensDrafts.scriptId,s):void 0,s?.length?(0,i.d3)(d.screensDrafts.scriptDraftId,s):void 0,t?.length?(0,i.d3)(d.screensDrafts.screenId,t):void 0,t?.length?(0,i.d3)(d.screensDrafts.screenDraftId,t):void 0),e?.userId?(0,i.eq)(d.screensDrafts.createdByUserId,e.userId):void 0)});o=r.filter(e=>e.screenId),l=r.filter(e=>!e.screenId)}else{let s=await n.Z.query.screensDrafts.findMany({where:(0,i.xD)((0,i.K0)(d.screensDrafts.scriptId),e?.userId?(0,i.eq)(d.screensDrafts.createdByUserId,e.userId):void 0)});o=s.filter(e=>e.screenId),l=s.filter(e=>!e.screenId)}if(o.length){let s=[];for(let{screenId:e,data:t}of(o.filter(e=>e.screenId).length&&(s=await n.Z.query.screens.findMany({where:(0,i.d3)(d.screens.screenId,o.filter(e=>e.screenId).map(e=>e.screenId))})),o)){let{screenId:s,id:r,oldScreenId:a,createdAt:c,updatedAt:o,deletedAt:l,...p}=t,g={...p,publishDate:new Date};await n.Z.update(d.screens).set(g).where((0,i.eq)(d.screens.screenId,e)).returning()}let t=await v({drafts:o,previous:s,userId:e?.publisherUserId});c.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}if(l.length){let s=[];for(let{id:e,scriptId:t,scriptDraftId:r,data:a}of(l.filter(e=>e.screenId).length&&(s=await n.Z.query.screens.findMany({where:(0,i.d3)(d.screens.screenId,l.filter(e=>e.screenId).map(e=>e.screenId))})),l)){let s=a.screenId||(0,h.Z)(),i=a.scriptId||t||r,c={...a,screenId:s,scriptId:i};l=l.map(t=>(t.id===e&&(t.data.screenId=s),t)),await n.Z.insert(d.screens).values(c)}let t=await v({drafts:l,previous:s,userId:e?.publisherUserId});c.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}await n.Z.delete(d.screensDrafts).where(e?.userId?(0,i.eq)(d.screensDrafts.createdByUserId,e.userId):void 0);let p=await n.Z.query.pendingDeletion.findMany({where:(0,i.xD)((0,i.K0)(d.pendingDeletion.screenId),e?.userId?(0,i.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{screenId:!0},with:{screen:!0}});if((p=p.filter(e=>e.screen)).length){let s=new Date;await n.Z.update(d.screens).set({deletedAt:s}).where((0,i.d3)(d.screens.screenId,p.map(e=>e.screenId)));let t=p.map(e=>({version:e.screen.version,screenId:e.screenId,scriptId:e.screen.scriptId,changes:{action:"delete_screen",description:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:s}]}}));if(await n.Z.insert(d.screensHistory).values(t),e?.publisherUserId)for(let r=0;r<p.length;r++){let i=p[r],a=t[r];if(!i?.screenId)continue;let n=(0,y.VL)({...i.screen??{},deletedAt:s});c.push({entityId:i.screenId,entityType:"screen",action:"delete",version:a.version||1,dataVersion:e.dataVersion,changes:a.changes,fullSnapshot:n,description:a.changes.description,userId:e.publisherUserId,scriptId:i.screen?.scriptId||null,screenId:i.screenId,isActive:!1})}}await n.Z.delete(d.pendingDeletion).where((0,i.xD)((0,i.or)((0,i.K0)(d.pendingDeletion.screenId),(0,i.K0)(d.pendingDeletion.screenDraftId)),e?.userId?(0,i.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...o.map(e=>e.screenId),...p.map(e=>e.screenId)],f=Array.from(new Set((o??[]).map(e=>e.scriptId).filter(e=>!!e)));if(f.length&&await (0,m.uW)(f),g.length&&await n.Z.update(d.screens).set({version:(0,u.i6)`${d.screens.version} + 1`}).where((0,i.d3)(d.screens.screenId,g)),c.length){let e=await (0,w.F)({data:c,allowPartial:!0});e.errors?.length&&a.Z.error("_publishScreens changelog warnings",e.errors.join(", "))}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],a.Z.error("_publishScreens ERROR",e)}finally{return r}}async function q({previous:e,drafts:s,userId:t}){let r=[];try{let i=[];for(let a of s){let s=a?.data?.diagnosisId;if(!s)continue;let n=1===(a?.data?.version||1),d=n?"Create diagnosis":"Update diagnosis",c={action:n?"create_diagnosis":"update_diagnosis",description:d,oldValues:[],newValues:[]},o=a?.data?.version||1,l={version:o,diagnosisId:s,scriptId:a?.data?.scriptId??"",changes:c};if(!n){let t=e.find(e=>e.diagnosisId===s);Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=(0,y.VL)(a.data[e]),r={...t}[e];JSON.stringify(s)!==JSON.stringify(r)&&(c.oldValues.push({[e]:r}),c.newValues.push({[e]:s}))})}if(i.push(l),t){let i=(0,y.VL)(a.data||{}),l=n?{}:(0,y.VL)(e.find(e=>e.diagnosisId===s)||{});r.push({entityId:s,entityType:"diagnosis",action:n?"create":"update",version:o,changes:c,fullSnapshot:i,previousSnapshot:l,baselineSnapshot:l,description:d,userId:t,scriptId:a?.data?.scriptId||null,diagnosisId:s})}}i.length&&await n.Z.insert(d.diagnosesHistory).values(i)}catch(e){a.Z.error(e.message)}return r}async function V(e){let{scriptsIds:s,diagnosesIds:t}={...e},r={success:!1},c=[];try{let o=[],l=[];if(s?.length||t?.length){let r=await n.Z.query.diagnosesDrafts.findMany({where:(0,i.xD)((0,i.or)(s?.length?(0,i.d3)(d.diagnosesDrafts.scriptId,s):void 0,s?.length?(0,i.d3)(d.diagnosesDrafts.scriptDraftId,s):void 0,t?.length?(0,i.d3)(d.diagnosesDrafts.diagnosisId,t):void 0,t?.length?(0,i.d3)(d.diagnosesDrafts.diagnosisDraftId,t):void 0),e?.userId?(0,i.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0)});o=r.filter(e=>e.diagnosisId),l=r.filter(e=>!e.diagnosisId)}else{let s=await n.Z.query.diagnosesDrafts.findMany({where:(0,i.xD)((0,i.K0)(d.diagnosesDrafts.scriptId),e?.userId?(0,i.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0)});o=s.filter(e=>e.diagnosisId),l=s.filter(e=>!e.diagnosisId)}if(o.length){let s=[];for(let{diagnosisId:e,data:t}of(o.filter(e=>e.diagnosisId).length&&(s=await n.Z.query.diagnoses.findMany({where:(0,i.d3)(d.diagnoses.diagnosisId,o.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),o)){let{diagnosisId:s,id:r,oldDiagnosisId:a,createdAt:c,updatedAt:o,deletedAt:l,...p}=t,g={...p,publishDate:new Date};await n.Z.update(d.diagnoses).set(g).where((0,i.eq)(d.diagnoses.diagnosisId,e)).returning()}let t=await q({drafts:o,previous:s,userId:e?.publisherUserId});c.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}if(l.length){let s=[];for(let{id:e,scriptId:t,scriptDraftId:r,data:a}of(l.filter(e=>e.diagnosisId).length&&(s=await n.Z.query.diagnoses.findMany({where:(0,i.d3)(d.diagnoses.diagnosisId,l.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),l)){let s=a.diagnosisId||(0,h.Z)(),i=a.scriptId||t||r,c={...a,diagnosisId:s,scriptId:i};l=l.map(t=>(t.id===e&&(t.data.diagnosisId=s),t)),await n.Z.insert(d.diagnoses).values(c)}let t=await q({drafts:l,previous:s,userId:e?.publisherUserId});c.push(...t.map(s=>({...s,dataVersion:e?.dataVersion})))}await n.Z.delete(d.diagnosesDrafts).where(e?.userId?(0,i.eq)(d.diagnosesDrafts.createdByUserId,e.userId):void 0);let p=await n.Z.query.pendingDeletion.findMany({where:(0,i.xD)((0,i.K0)(d.pendingDeletion.diagnosisId),e?.userId?(0,i.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{diagnosisId:!0},with:{diagnosis:!0}});if((p=p.filter(e=>e.diagnosis)).length){let s=new Date;await n.Z.update(d.diagnoses).set({deletedAt:s}).where((0,i.d3)(d.diagnoses.diagnosisId,p.map(e=>e.diagnosisId)));let t=p.map(e=>({version:e.diagnosis.version,diagnosisId:e.diagnosisId,scriptId:e.diagnosis.scriptId,changes:{action:"delete_diagnosis",description:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:s}]}}));if(await n.Z.insert(d.diagnosesHistory).values(t),e?.publisherUserId)for(let r=0;r<p.length;r++){let i=p[r],a=t[r];if(!i?.diagnosisId)continue;let n=(0,y.VL)({...i.diagnosis??{},deletedAt:s});c.push({entityId:i.diagnosisId,entityType:"diagnosis",action:"delete",version:a.version||1,dataVersion:e.dataVersion,changes:a.changes,fullSnapshot:n,description:a.changes.description,userId:e.publisherUserId,scriptId:i.diagnosis?.scriptId||null,diagnosisId:i.diagnosisId,isActive:!1})}}await n.Z.delete(d.pendingDeletion).where((0,i.xD)((0,i.or)((0,i.K0)(d.pendingDeletion.diagnosisId),(0,i.K0)(d.pendingDeletion.diagnosisDraftId)),e?.userId?(0,i.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...o.map(e=>e.diagnosisId),...p.map(e=>e.diagnosisId)];if(g.length&&await n.Z.update(d.diagnoses).set({version:(0,u.i6)`${d.diagnoses.version} + 1`}).where((0,i.d3)(d.diagnoses.diagnosisId,g)),c.length){let e=await (0,w.F)({data:c,allowPartial:!0});e.errors?.length&&a.Z.error("_publishDiagnoses changelog warnings",e.errors.join(", "))}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],a.Z.error("_publishDiagnoses ERROR",e)}finally{return r}}async function S({userId:e,publisherUserId:s,dataVersion:t}){let r={success:!1},c=[];try{let o=await n.Z.query.scriptsDrafts.findMany({where:e?(0,i.eq)(d.scriptsDrafts.createdByUserId,e):void 0}),l=o.filter(e=>!e.scriptId).map(e=>({...e,scriptId:e.data.scriptId||(0,h.Z)(),data:{...e.data,scriptId:e.data.scriptId||(0,h.Z)()}})),p=o.filter(e=>e.scriptId);[...l.map(e=>e.scriptId),...p.map(e=>e.scriptId)];let g=[];if(p.length){let e=[];for(let{scriptId:s,data:t}of(p.filter(e=>e.scriptId).length&&(e=await n.Z.query.scripts.findMany({where:(0,i.d3)(d.scripts.scriptId,p.filter(e=>e.scriptId).map(e=>e.scriptId))})),p)){let{scriptId:e,id:r,oldScriptId:a,createdAt:c,updatedAt:o,deletedAt:l,...p}=t,f={...p,publishDate:new Date};await n.Z.update(d.scripts).set(f).where((0,i.eq)(d.scripts.scriptId,s)),g.push({scriptId:s})}let r=await D({drafts:p,previous:e,userId:s});c.push(...r.map(e=>({...e,dataVersion:t})))}if(l.length){let e=[];l.filter(e=>e.scriptId).length&&(e=await n.Z.query.scripts.findMany({where:(0,i.d3)(d.scripts.scriptId,l.filter(e=>e.scriptId).map(e=>e.scriptId))}));let r=l.map(e=>({...e.data,scriptId:e.scriptDraftId}));for(let{scriptId:e}of(await n.Z.insert(d.scripts).values(r),r))g.push({scriptId:e}),await n.Z.update(d.screensDrafts).set({scriptId:e}).where((0,i.or)((0,i.eq)(d.screensDrafts.scriptId,e),(0,i.eq)(d.screensDrafts.scriptDraftId,e))),await n.Z.update(d.diagnosesDrafts).set({scriptId:e}).where((0,i.or)((0,i.eq)(d.diagnosesDrafts.scriptId,e),(0,i.eq)(d.diagnosesDrafts.scriptDraftId,e)));let a=await D({drafts:l,previous:e,userId:s});c.push(...a.map(e=>({...e,dataVersion:t})))}if(g.length){let r=await Z({userId:e,publisherUserId:s,scriptsIds:g.map(e=>e.scriptId),dataVersion:t});if(r.errors)throw Error(r.errors.join(", "));let i=await V({userId:e,publisherUserId:s,scriptsIds:g.map(e=>e.scriptId),dataVersion:t});if(i.errors)throw Error(i.errors.join(", "))}let f=await n.Z.query.pendingDeletion.findMany({where:(0,i.xD)((0,i.K0)(d.pendingDeletion.scriptId),e?(0,i.eq)(d.pendingDeletion.createdByUserId,e):void 0),columns:{scriptId:!0},with:{script:!0}});if(await n.Z.delete(d.scriptsDrafts).where(e?(0,i.eq)(d.scriptsDrafts.createdByUserId,e):void 0),(f=f.filter(e=>e.script)).length){let e=new Date;await n.Z.update(d.scripts).set({deletedAt:e}).where((0,i.d3)(d.scripts.scriptId,f.map(e=>e.scriptId)));let r=f.map(s=>({version:s.script.version,scriptId:s.scriptId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}}));if(await n.Z.insert(d.scriptsHistory).values(r),s)for(let i=0;i<f.length;i++){let a=f[i],n=r[i];if(!a?.scriptId)continue;let d=(0,y.VL)({...a.script??{},deletedAt:e});c.push({entityId:a.scriptId,entityType:"script",action:"delete",version:n.version||1,dataVersion:t,changes:n.changes,fullSnapshot:d,previousSnapshot:d,baselineSnapshot:d,description:n.changes.description,userId:s,scriptId:a.scriptId,isActive:!1})}}await n.Z.delete(d.pendingDeletion).where((0,i.xD)((0,i.or)((0,i.K0)(d.pendingDeletion.scriptId),(0,i.K0)(d.pendingDeletion.scriptDraftId)),e?(0,i.eq)(d.pendingDeletion.createdByUserId,e):void 0));let I=[...p.map(e=>e.scriptId),...f.map(e=>e.scriptId)];if(I.length&&await n.Z.update(d.scripts).set({version:(0,u.i6)`${d.scripts.version} + 1`}).where((0,i.d3)(d.scripts.scriptId,I)),c.length){let e=await (0,w.F)({data:c,allowPartial:!0});e.errors?.length&&a.Z.error("_publishScripts changelog warnings",e.errors.join(", "))}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],a.Z.error("_publishScripts ERROR",e.message)}finally{return r}}var _=t(55090),U=t(94081)}};