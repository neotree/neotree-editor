"use strict";exports.id=9183,exports.ids=[9183],exports.modules={29183:(e,a,t)=>{t.d(a,{F$:()=>o,pG:()=>c,bv:()=>K,Hc:()=>f,MM:()=>u,ZU:()=>g,FG:()=>h});var d=t(57745),s=t(9576),i=t(57435),r=t(10413),n=t(24161),l=t(88317),y=t(16916);async function u({data:e,broadcastAction:a}){let t={success:!1};try{let a=[],i=e.map(e=>({...e,uuid:e.uuid||s.Z(),isNewUuid:!e.uuid})),{data:{drafts:u,published:o}}=await (0,y.l3)(i.filter(e=>e.name).map(e=>e.name),{uuidNot:i.filter(e=>e.name).map(e=>e.uuid)}),c={...u,...o};if(Object.keys(c).length)return{success:!1,errors:[`Duplicate keys: ${Object.keys(c).join(", ")}`]};for(let{uuid:e,isNewUuid:t,...s}of i)try{if(!a.length){let a=t?null:await r.Z.query.dataKeysDrafts.findFirst({where:(0,d.eq)(n.dataKeysDrafts.uuid,e)}),i=a||t?null:await r.Z.query.dataKeys.findFirst({where:(0,d.eq)(n.dataKeys.uuid,e)});if(a){let t={...a.data,...s};await r.Z.update(n.dataKeysDrafts).set({data:t,name:t.name}).where((0,d.eq)(n.dataKeysDrafts.uuid,e))}else{let a={...i,...s,uuid:e,version:i?.version?i.version+1:1};await r.Z.insert(n.dataKeysDrafts).values({data:a,uuid:e,dataKeyId:i?.uuid,name:a.name})}}}catch(e){a.push(e.message)}return a.length?t.errors=a:(l.Z.emit("data_changed","save_data_keys"),t.success=!0),t}catch(e){return t.success=!1,t.errors=[e.message],i.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function o(){try{return await r.Z.delete(n.dataKeysDrafts),!0}catch(e){throw e}}async function c({dataKeysIds:e,broadcastAction:a}){let t={success:!1};try{if(e.length){await r.Z.delete(n.dataKeysDrafts).where((0,d.d3)(n.dataKeysDrafts.uuid,e));let a=(await r.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,d.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion);a.length&&await r.Z.insert(n.pendingDeletion).values(a)}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],i.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!t?.errors?.length&&a&&l.Z.emit("data_changed","delete_data_keys"),t}}async function m({previous:e,drafts:a}){try{let t=[];for(let d of a){let a={version:d?.data?.version||1,dataKeyId:d?.data?.uuid,changes:{}};if(d?.data?.version===1)a.changes={action:"create_data_key",description:"Create data key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.uuid===d?.data?.uuid)[0],s=[],i=[];Object.keys({...d?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=d.data[e],r={...t}[e];JSON.stringify(a)!==JSON.stringify(r)&&(s.push({[e]:r}),i.push({[e]:a}))}),a.changes={action:"update_data_key",description:"Update data key",oldValues:s,newValues:i}}t.push(a)}await r.Z.insert(n.dataKeysHistory).values(t)}catch(e){i.Z.error(e.message)}}var p=t(34149);async function f(e){let a={success:!1};try{let e=await r.Z.query.pendingDeletion.findMany({where:(0,d.K0)(n.pendingDeletion.dataKeyId),columns:{dataKeyId:!0},with:{dataKey:{columns:{version:!0,name:!0}}}});if((e=e.filter(e=>e.dataKey)).length){let a=new Date;await r.Z.update(n.dataKeys).set({deletedAt:a,name:(0,p.i6)`CONCAT(${n.dataKeys.name}, '_', ${n.dataKeys.uuid})`}).where((0,d.d3)(n.dataKeys.uuid,e.map(e=>e.dataKeyId))),await r.Z.insert(n.dataKeysHistory).values(e.map(e=>({version:e.dataKey.version,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null,name:e.dataKey.name}],newValues:[{deletedAt:a,name:`${e.dataKey.name}_${e.dataKeyId}`}]}})))}await r.Z.delete(n.pendingDeletion).where((0,d.or)((0,d.K0)(n.pendingDeletion.dataKeyId),(0,d.K0)(n.pendingDeletion.dataKeyDraftId)));let t=[],i=[],l=await r.Z.query.dataKeysDrafts.findMany();if(t=l.filter(e=>e.dataKeyId),i=l.filter(e=>!e.dataKeyId),t.length){let e=[];for(let{dataKeyId:a,data:s}of(t.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,t.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),t)){let{uuid:e,id:t,createdAt:i,updatedAt:l,deletedAt:y,...u}=s,o={...u,publishDate:new Date};await r.Z.update(n.dataKeys).set(o).where((0,d.eq)(n.dataKeys.uuid,a)).returning()}await m({drafts:t,previous:e})}if(i.length){let e=[];for(let{id:a,data:t}of(i.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,i.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),i)){let e=t.uuid||(0,s.Z)(),d={...t,uuid:e};i=i.map(t=>(t.id===a&&(t.data.uuid=e),t)),await r.Z.insert(n.dataKeys).values(d)}await m({drafts:i,previous:e})}await r.Z.delete(n.dataKeysDrafts);let y=[...t.map(e=>e.dataKeyId),...e.map(e=>e.dataKeyId)];y.length&&await r.Z.update(n.dataKeys).set({version:(0,p.i6)`${n.dataKeys.version} + 1`}).where((0,d.d3)(n.dataKeys.uuid,y)),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishDataKeys ERROR",e)}finally{return a}}async function K(){try{let e=await r.Z.query.screens.findMany(),a=await r.Z.query.diagnoses.findMany(),t=await r.Z.query.drugsLibrary.findMany(),i=[];for(let d of(e.forEach(e=>{if(e.key){let a={id:void 0,uuid:(0,s.Z)(),name:e.key,label:e.label||"",dataType:null,parentKeys:[],version:1};switch(e.type){case"timer":a.dataType="timer";break;case"yesno":a.dataType="yesno";break;case"single_select":a.dataType="single_select";break;case"multi_select":a.dataType="multi_select"}i.push(a)}e.items.forEach(a=>{let t=a.id||a.key;if(t){let d={id:void 0,uuid:(0,s.Z)(),name:t,label:a.label||"",dataType:null,parentKeys:e.key?[e.key]:[],version:1,defaults:{dataType:a.subType||void 0,severity_order:a.severity_order||void 0,score:a.score||void 0}};switch(e.type){case"single_select":d.dataType="single_select_option";break;case"multi_select":d.dataType="multi_select_option";break;case"diagnosis":d.dataType="diagnosis";break;case"checklist":d.name=a.key||a.id,d.dataType="checklist_option";break;case"zw_edliz_summary_table":d.dataType="zw_edliz_summary_table_option";break;case"mwi_edliz_summary_table":d.dataType="mwi_edliz_summary_table_option";break;case"edliz_summary_table":d.dataType="edliz_summary_table_option"}i.push(d)}}),e.fields.forEach((a,t)=>{let d={id:void 0,uuid:(0,s.Z)(),name:a.key,label:a.label||"",dataType:a.type,parentKeys:e.key?[e.key]:[],version:1,defaults:{dataType:a.dataType||void 0}};i.push(d),"dropdown"===a.type&&(a.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).forEach(e=>{e=e.split(","),i.push({uuid:(0,s.Z)(),id:void 0,name:e[0],label:e[1],dataType:"dropdown_option",parentKeys:a.key?[a.key]:[],version:1})})})}),a.forEach(e=>{e.key&&i.push({id:void 0,uuid:(0,s.Z)(),name:e.key,label:e.name,dataType:"diagnosis",parentKeys:[],version:1})}),t.forEach(e=>{e.key&&i.push({id:void 0,uuid:(0,s.Z)(),name:e.key,label:e.drug,dataType:e.type,parentKeys:[],version:1})}),i)){let e=d.parentKeys||[];i.filter(e=>e.name&&d.name&&e.name.toLowerCase()===d.name.toLowerCase()).forEach(a=>{e=[...e,...a.parentKeys]})}if((i=i.map(e=>{let a=e.parentKeys||[];return i.filter(a=>a.name&&e.name&&a.name.toLowerCase()===e.name.toLowerCase()).forEach(e=>{a=[...a,...e.parentKeys]}),{...e,parentKeys:a.filter((e,t)=>a.map(e=>e.toLowerCase()).indexOf(e.toLowerCase())===t)}}).map(e=>("EDLIZSummaryTableScore"===e.name&&(e.dataType=e.dataType||"number"),{...e,label:e.label||""})).filter((e,a)=>i.map(e=>e.name.toLowerCase()).indexOf(e.name.toLowerCase())===a)).length){let e=await r.Z.select({name:n.dataKeys.name}).from(n.dataKeys).where((0,d.d3)((0,p.i6)`lower(${n.dataKeys.name})`,i.map(e=>e.name.toLowerCase()))),a=await r.Z.select({name:n.dataKeysDrafts.name}).from(n.dataKeysDrafts).where((0,d.d3)((0,p.i6)`lower(${n.dataKeysDrafts.name})`,i.map(e=>e.name.toLowerCase()))),t=[...e,...a];(i=i.filter(e=>!t.map(e=>e.name.toLowerCase()).includes(e.name.toLowerCase()))).length&&await u({data:i})}return{data:{extracted:i.length}}}catch(e){return i.Z.log("db_extract_data_keys",e.message),{data:{extracted:0},errors:[e.message]}}}let h={synced:{scripts:0,screens:0,diagnoses:0}};async function g(){try{return{data:h}}catch(e){return i.Z.log("db_sync_data_keys",e.message),{data:h,errors:[e.message]}}}},16916:(e,a,t)=>{t.d(a,{gc:()=>c,aW:()=>y,l3:()=>p});var d=t(57745),s=t(30900),i=t(9576),r=t(10413),n=t(24161),l=t(57435);async function y(e){try{let{dataKeysIds:a,returnDraftsIfExist:t=!0}={...e},l=a||[],y=l?.length?(0,d.d3)(n.dataKeysDrafts.uuid,l.map(e=>s.Z(e)?e:i.Z())):void 0,u=[...y?[y]:[]],o=t?await r.Z.query.dataKeysDrafts.findMany({where:(0,d.xD)(...u)}):[];l=l.filter(e=>!o.map(e=>e.uuid).includes(e));let c=o.length?(0,d.Nl)(n.dataKeys.uuid,o.map(e=>e.uuid)):void 0,m=l?.length?(0,d.d3)(n.dataKeys.uuid,l.filter(e=>s.Z(e))):void 0,p=[(0,d.Ft)(n.dataKeys.deletedAt),(0,d.Ft)(n.pendingDeletion),m,c],f=(await r.Z.select({dataKey:n.dataKeys,pendingDeletion:n.pendingDeletion}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where(p.length?(0,d.xD)(...p):void 0)).map(e=>e.dataKey),K=f.length?await r.Z.query.pendingDeletion.findMany({where:(0,d.d3)(n.pendingDeletion.dataKeyId,f.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...o.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!K.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var u=t(60938);let o={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function c(){try{let[{count:e}]=await r.Z.select({count:(0,u.QX)()}).from(n.dataKeysDrafts),[{count:a}]=await r.Z.select({count:(0,u.QX)()}).from(n.dataKeysDrafts).where((0,d.Ft)(n.dataKeysDrafts.dataKeyId)),[{count:t}]=await r.Z.select({count:(0,u.QX)()}).from(n.dataKeysDrafts).where((0,d.K0)(n.dataKeysDrafts.dataKeyId)),[{count:s}]=await r.Z.select({count:(0,u.QX)()}).from(n.pendingDeletion).where((0,d.K0)(n.pendingDeletion.dataKeyId)),[{count:i}]=await r.Z.select({count:(0,u.QX)()}).from(n.dataKeys);return{data:{allPublished:i,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:s}}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:o,errors:[e.message]}}}var m=t(34149);async function p(e,a){let t=Array.isArray(e)?e:[e],s=a?Array.isArray(a.uuidNot)?a.uuidNot:[a.uuidNot]:[];try{if(!t.length)return{data:{drafts:{},published:{}}};let a=e.length?await r.Z.query.dataKeysDrafts.findMany({where:(0,d.xD)((0,d.d3)(n.dataKeysDrafts.name,t),s.length?(0,d.Nl)(n.dataKeysDrafts.uuid,s):void 0),columns:{name:!0,uuid:!0}}):[],i=e.length?await r.Z.select({name:n.dataKeys.name,uuid:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,d.xD)((0,d.d3)((0,m.i6)`lower(${n.dataKeys.name})`,t.map(e=>e.toLowerCase())),s.length?(0,d.Nl)(n.dataKeys.uuid,s):void 0,(0,d.Ft)(n.pendingDeletion))):[],l=a.reduce((e,a)=>({...e,[a.name]:a.uuid}),{}),y=i.reduce((e,a)=>({...e,[a.name]:a.uuid}),{});return{data:{drafts:l,published:y}}}catch(e){return{errors:[e.message],data:{drafts:{},published:{}}}}}}};