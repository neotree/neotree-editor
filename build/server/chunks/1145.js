exports.id=1145,exports.ids=[1145],exports.modules={14442:(e,s,t)=>{Promise.resolve().then(t.bind(t,25813)),Promise.resolve().then(t.bind(t,93254)),Promise.resolve().then(t.bind(t,15086)),Promise.resolve().then(t.bind(t,97043)),Promise.resolve().then(t.bind(t,32520)),Promise.resolve().then(t.bind(t,72346)),Promise.resolve().then(t.bind(t,9645))},69807:(e,s,t)=>{Promise.resolve().then(t.t.bind(t,12994,23)),Promise.resolve().then(t.t.bind(t,96114,23)),Promise.resolve().then(t.t.bind(t,9727,23)),Promise.resolve().then(t.t.bind(t,79671,23)),Promise.resolve().then(t.t.bind(t,41868,23)),Promise.resolve().then(t.t.bind(t,84759,23))},25813:(e,s,t)=>{"use strict";t.d(s,{AlertModal:()=>l});var r=t(10326),a=t(17577),i=t(12534),n=t(99440),d=t(96221),o=t(90772),c=t(77863);function l(){let{isOpen:e,title:s,message:t,variant:l,buttonLabel:f,close:p,onClose:g}=(0,d.s)(),u=(0,a.useCallback)(()=>{g?.(),p()},[p,g]);return r.jsx(n.aR,{open:e,onOpenChange:u,children:(0,r.jsxs)(n._T,{children:[(0,r.jsxs)(n.fY,{children:[r.jsx(n.f$,{className:(0,c.cn)(!s&&"hidden"),children:s}),!!t&&(0,r.jsxs)("div",{className:(0,c.cn)("flex gap-y-4 flex-col sm:items-start sm:flex-row sm:gap-x-4"),children:["error"===l&&r.jsx("div",{className:"flex justify-center",children:r.jsx(i.BJv,{className:"text-red-600 min-w-12 min-h-12 w-12 h-12"})}),"success"===l&&r.jsx("div",{className:"flex justify-center",children:r.jsx(i._rq,{className:"text-green-600 min-w-12 min-h-12 w-12 h-12"})}),r.jsx("div",{className:"flex-1 text-lg",children:t})]})]}),r.jsx(n.xo,{children:r.jsx("div",{className:"flex justify-end",children:r.jsx(o.z,{onClick:u,variant:"outline",children:f})})})]})})}},93254:(e,s,t)=>{"use strict";t.d(s,{ConfirmModal:()=>c});var r=t(10326),a=t(99440),i=t(12534),n=t(46670),d=t(90772),o=t(77863);function c(){let{isOpen:e,danger:s,title:t,message:c,positiveLabel:l,negativeLabel:f,close:p,onConfirm:g}=(0,n.t)();return r.jsx(a.aR,{open:e,onOpenChange:p,children:(0,r.jsxs)(a._T,{className:"p-0 max-h-[80%] flex flex-col",children:[!!t&&r.jsx(a.fY,{className:"py-2 px-4",children:r.jsx(a.f$,{children:t})}),(0,r.jsxs)("div",{className:(0,o.cn)("px-4 flex-1 flex flex-col gap-y-4 items-center sm:items-start sm:flex-row sm:gap-x-4 overflow-y-auto",!t&&"py-2"),children:[s&&r.jsx(i.bcx,{className:"text-red-600 min-w-10 min-h-10 w-10 h-10"}),r.jsx("div",{dangerouslySetInnerHTML:{__html:c}})]}),(0,r.jsxs)(a.xo,{className:"px-4 py-2",children:[r.jsx(a.le,{children:f}),r.jsx(d.z,{variant:s?"destructive":void 0,asChild:!0,children:r.jsx(a.OL,{onClick:()=>g?.(),children:l})})]})]})})}},15086:(e,s,t)=>{"use strict";t.d(s,{AuthContextProvider:()=>i});var r=t(10326),a=t(77109);function i({children:e}){return r.jsx(a.SessionProvider,{children:e})}},97043:(e,s,t)=>{"use strict";t.d(s,{ThemeProvider:()=>i});var r=t(10326);t(17577);var a=t(14831);function i({children:e,...s}){return r.jsx(a.f,{...s,children:e})}},32520:(e,s,t)=>{"use strict";t.d(s,{SocketEventsListener:()=>n});var r=t(17577),a=t(35047),i=t(68848);function n({events:e}){return(0,r.useRef)({eventsTimeouts:{},eventsTimestamps:{}}),(0,r.useRef)(new Date().getTime()),(0,a.useRouter)(),null}console.log("process.env.NEXT_PUBLIC_APP_URL","https://webeditor-dev.neotree.org"),(0,i.io)("https://webeditor-dev.neotree.org")},99440:(e,s,t)=>{"use strict";t.d(s,{OL:()=>h,_T:()=>f,aR:()=>o,f$:()=>u,fY:()=>p,le:()=>y,xo:()=>g});var r=t(10326),a=t(17577),i=t(80440),n=t(77863),d=t(90772);let o=i.fC;i.xz;let c=i.h_,l=a.forwardRef(({className:e,...s},t)=>r.jsx(i.aV,{className:(0,n.cn)("fixed inset-0 z-[99999999999] bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...s,ref:t}));l.displayName=i.aV.displayName;let f=a.forwardRef(({className:e,...s},t)=>(0,r.jsxs)(c,{children:[r.jsx(l,{}),r.jsx(i.VY,{ref:t,className:(0,n.cn)("fixed left-[50%] top-[50%] z-[99999999999] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",e),...s})]}));f.displayName=i.VY.displayName;let p=({className:e,...s})=>r.jsx("div",{className:(0,n.cn)("flex flex-col space-y-2 text-center sm:text-left",e),...s});p.displayName="AlertDialogHeader";let g=({className:e,...s})=>r.jsx("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...s});g.displayName="AlertDialogFooter";let u=a.forwardRef(({className:e,...s},t)=>r.jsx(i.Dx,{ref:t,className:(0,n.cn)("text-lg font-semibold",e),...s}));u.displayName=i.Dx.displayName,a.forwardRef(({className:e,...s},t)=>r.jsx(i.dk,{ref:t,className:(0,n.cn)("text-sm text-muted-foreground",e),...s})).displayName=i.dk.displayName;let h=a.forwardRef(({className:e,...s},t)=>r.jsx(i.aU,{ref:t,className:(0,n.cn)((0,d.d)(),e),...s}));h.displayName=i.aU.displayName;let y=a.forwardRef(({className:e,...s},t)=>r.jsx(i.$j,{ref:t,className:(0,n.cn)((0,d.d)({variant:"outline"}),"mt-2 sm:mt-0",e),...s}));y.displayName=i.$j.displayName},90772:(e,s,t)=>{"use strict";t.d(s,{d:()=>o,z:()=>c});var r=t(10326),a=t(17577),i=t(34214),n=t(28671),d=t(77863);let o=(0,n.j)(`
    inline-flex
    items-center
    justify-center
    whitespace-nowrap
    rounded-md
    text-sm
    font-medium
    transition-colors
    focus-visible:outline-none
    disabled:pointer-events-none
    disabled:opacity-50
  `,{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"border border-input bg-background hover:bg-primary/20","primary-outline":"border border-primary text-primary bg-transparent hover:bg-primary/20",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/90",ghost:"hover:bg-primary/20 hover:text-primary",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),c=a.forwardRef(({className:e,variant:s,size:t,asChild:a=!1,...n},c)=>{let l=a?i.g7:"button";return r.jsx(l,{className:(0,d.cn)(o({variant:s,size:t,className:e})),ref:c,...n})});c.displayName="Button"},72346:(e,s,t)=>{"use strict";t.d(s,{Toaster:()=>n});var r=t(10326),a=t(14831),i=t(85999);let n=({...e})=>{let{theme:s="system"}=(0,a.F)();return r.jsx(i.x7,{theme:s,richColors:!0,position:"top-center",...e})}},9645:(e,s,t)=>{"use strict";t.d(s,{AppContextProvider:()=>o,b:()=>d});var r=t(10326),a=t(17577),i=t(14831);let n=(0,a.createContext)(null),d=()=>(0,a.useContext)(n);function o({children:e,...s}){let{authenticatedUser:t,mode:d,sys:o}=s,{setTheme:c}=(0,i.F)(),l=(0,a.useMemo)(()=>{let e=t?.role==="admin",s=t?.role==="super_user";return{isDefaultUser:!e&&!s,isAdmin:e,isSuperUser:s}},[t]),f=(0,a.useMemo)(()=>!l.isAdmin&&!l.isSuperUser||"view"===d,[l,d]),p={...s,...l,viewOnly:f};return r.jsx(n.Provider,{value:p,children:e})}},96221:(e,s,t)=>{"use strict";t.d(s,{s:()=>i});var r=t(60114);let a={title:"",message:"",buttonLabel:"Ok",variant:"info",onClose:void 0},i=(0,r.Ue)(e=>({isOpen:!1,...a,alert:s=>e({isOpen:!0,...a,...s}),close:()=>e({isOpen:!1,onClose:void 0,...a})}))},46670:(e,s,t)=>{"use strict";t.d(s,{t:()=>i});var r=t(60114);let a={danger:!1,title:"Confirm",message:"Are you sure?",positiveLabel:"Ok",negativeLabel:"Cancel"},i=(0,r.Ue)(e=>({isOpen:!1,...a,confirm:(s,t)=>e({isOpen:!0,...a,...t,onConfirm:s}),close:()=>e({isOpen:!1,onConfirm:void 0,...a})}))},77863:(e,s,t)=>{"use strict";t.d(s,{cn:()=>i});var r=t(41135),a=t(31009);function i(...e){return(0,a.m6)((0,r.W)(e))}},11844:(e,s,t)=>{"use strict";t.r(s),t.d(s,{$$ACTION_0:()=>B,$$ACTION_1:()=>H,countAllDrafts:()=>L,discardDrafts:()=>J,getCookie:()=>Q,getEditorDetails:()=>U,getMode:()=>Y,publishData:()=>X,revalidatePath:()=>F,setCookie:()=>z,setMode:()=>G});var r=t(24330);t(60166);var a=t(71615),i=t(57708),n=t(88317),d=t(57435),o=t(20706),c=t(57745),l=t(9576),f=t(10413),p=t(57418),g=t(34149),u=t(60938),h=t(81445),y=t(30900),m=t(41502);async function I(e){let s=y.Z(e)?(0,c.eq)(p.configKeys.configKeyId,e):(0,c.eq)(p.configKeys.oldConfigKeyId,e);return await f.Z.query.configKeys.findFirst({where:(0,c.xD)(s,(0,c.Ft)(p.configKeys.deletedAt)),columns:{id:!0,configKeyId:!0,oldConfigKeyId:!0,label:!0,key:!0,summary:!0,version:!0,position:!0}})}async function w({limit:e,page:s=1,configKeyIds:t,searchValue:r,archived:a}){s=Math.max(0,s);let i=[];if(a?i.push((0,c.K0)(p.configKeys.deletedAt)):i.push((0,c.Ft)(p.configKeys.deletedAt)),t?.length&&i.push((0,c.d3)(p.configKeys.configKeyId,t)),r=`${r||""}`.trim()){let e=["%",r,"%"].join("");i.push((0,g.i6)`LOWER(configKeys.name) like LOWER(${e})`)}let n=f.Z.select({count:(0,u.QX)()}).from(p.configKeys);i.length&&n.where((0,c.xD)(...i));let[{count:d}]=await n.execute(),o=1;d&&(s=Math.min(s,o=(0,m.x)(e)?1:Math.ceil(d/e)));let l=(0,m.x)(e)?void 0:Math.max(0,(s-1)*e),y=f.Z.select({id:p.configKeys.id,configKeyId:p.configKeys.configKeyId,oldConfigKeyId:p.configKeys.oldConfigKeyId,label:p.configKeys.label,key:p.configKeys.key,summary:p.configKeys.summary,version:p.configKeys.version,position:p.configKeys.position,configKeyDraftId:p.configKeysDrafts.configKeyDraftId}).from(p.configKeys).leftJoin(p.configKeysDrafts,(0,c.eq)(p.configKeys.configKeyId,p.configKeysDrafts.configKeyId)).orderBy((0,h.C)(p.configKeys.id));return(0,m.x)(e)||y.limit(e),l&&y.offset(l),i.length&&y.where((0,c.xD)(...i)),{page:s,limit:e,data:(await y.execute()).map(e=>({...e,publishedVersion:e.version})),totalRows:d,totalPages:o,searchValue:r,error:void 0}}let D={page:1,limit:void 0,totalRows:0,totalPages:1,data:[],searchValue:void 0,error:void 0};async function v(e){let s=D;try{s=await w({...e})}catch(e){d.Z.error("_getConfigKeys ERROR",e),s.error=e.message}finally{return s}}async function x(e){let s={success:!0};try{let e=await f.Z.query.configKeysDrafts.findMany({columns:{configKeyDraftId:!0,configKeyId:!0}}),t=e.filter(e=>!e.configKeyId),r=e.filter(e=>e.configKeyId).map(e=>({...e,configKeyId:e.configKeyId})),a=[];if(t.length){let{error:e}=await b(t);e&&a.push(e)}r.length&&(await Z(r)).forEach(e=>e.error&&a.push(e.error)),a.length&&(s.success=!1,s.errors=a)}catch(e){s.success=!1,s.errors=[e.message],d.Z.error("_publishConfigKeys ERROR",e.message)}finally{return s}}async function b(e,s){let t={inserted:[],success:!1};try{let r=[],a=e.length?await f.Z.query.configKeysDrafts.findMany({where:(0,c.d3)(p.configKeysDrafts.configKeyDraftId,e.map(e=>e.configKeyDraftId))}):[],i=[];for(let{id:e,data:s}of(a.filter(e=>e.configKeyId).length&&(i=await f.Z.query.configKeys.findMany({where:(0,c.d3)(p.configKeys.configKeyId,a.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),a)){let t=s.configKeyId||(0,l.Z)();r.push({...s,configKeyId:t}),a=a.map(s=>(s.id===e&&(s.data.configKeyId=t),s))}await f.Z.insert(p.configKeys).values(r);let d=await v({configKeyIds:r.map(e=>e.configKeyId)});t.inserted=s?.returnInserted?d.data:[],t.success=!0,await _({drafts:a,previous:i}),a.length&&await f.Z.delete(p.configKeysDrafts).where((0,c.d3)(p.configKeysDrafts.id,a.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","create_config_keys")}catch(e){t.error=e.message}finally{return t}}async function Z(e,s){let t=[],r=e.length?await f.Z.query.configKeysDrafts.findMany({where:(0,c.d3)(p.configKeysDrafts.configKeyId,e.map(e=>e.configKeyId))}):[],a=[];for(let{configKeyId:e,data:i}of(r.filter(e=>e.configKeyId).length&&(a=await f.Z.query.configKeys.findMany({where:(0,c.d3)(p.configKeys.configKeyId,r.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),r)){let a=e,{configKeyId:n,oldConfigKeyId:o,id:l,createdAt:g,updatedAt:u,deletedAt:h,...y}=i;try{let e={...y,publishDate:new Date};await f.Z.update(p.configKeys).set(e).where((0,c.eq)(p.configKeys.configKeyId,a));let r=s?.returnUpdated?await I(a):void 0;t.push({configKeyId:a,configKey:r})}catch(e){d.Z.error(`_updateConfigKeys configKeyId=${a}`,e.message),t.push({configKeyId:a,error:e.message}),r=r.filter(e=>e.data.configKeyId!==a)}}return await _({drafts:r,previous:a}),r.length&&await f.Z.delete(p.configKeysDrafts).where((0,c.d3)(p.configKeysDrafts.id,r.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","update_config_keys"),t}async function _({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,configKeyId:r?.data?.configKeyId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.configKeyId===r?.data?.configKeyId)[0],a=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=r.data[e],n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(a.push({[e]:n}),i.push({[e]:s}))}),s.changes={action:"update_config_key",description:"Update config key",oldValues:a,newValues:i}}t.push(s)}await f.Z.insert(p.configKeysHistory).values(t)}catch(e){d.Z.error(e.message)}}var R=t(66267),K=t(28422);async function S(e){let s=e?.firstVersion?[(0,c.Ft)(p.configKeysDrafts.configKeyId)]:[];e?.configKeysDraftsIds&&s.push((0,c.d3)(p.configKeysDrafts.configKeyDraftId,e.configKeysDraftsIds)),e?.configKeysIds&&s.push((0,c.d3)(p.configKeysDrafts.configKeyId,e.configKeysIds));let t=f.Z.select({count:(0,u.QX)()}).from(p.configKeysDrafts);s.length&&t.where((0,c.xD)(...s));let r=await t.execute();return r[0]?.count||0}async function A(e){let s=f.Z.select({count:(0,u.QX)()}).from(p.screensDrafts);e?.firstVersion&&s.where((0,c.Ft)(p.screensDrafts.screenId)),e?.scriptId&&s.where((0,c.eq)(p.screensDrafts.scriptId,e.scriptId));let t=await s.execute();return t[0]?.count||0}async function j(e){let s=f.Z.select({count:(0,u.QX)()}).from(p.scriptsDrafts);e?.firstVersion&&s.where((0,c.Ft)(p.scriptsDrafts.scriptId));let t=await s.execute();return t[0]?.count||0}async function q(e){let s=await f.Z.delete(p.configKeysDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_screens_drafts"),s}async function E(e){let s=await f.Z.delete(p.screensDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_screens_drafts"),s}t(27457),t(57040);var N=t(18100);async function O(e){let s=await f.Z.query.scriptsDrafts.findMany({columns:{scriptDraftId:!0,scriptId:!0}}),t=await f.Z.delete(p.scriptsDrafts);return s.length&&(await (0,N.j)({restoreKeys:s.map(e=>`script_draft_${e.scriptDraftId}`)}),await f.Z.update(p.screensHistory).set({restoreKey:null}).where((0,c.d3)(p.screensHistory.restoreKey,s.map(e=>`script_draft_${e.scriptDraftId}`)))),e?.broadcastAction&&n.Z.emit("data_changed","delete_scripts_drafts"),t}async function M(e){let s=f.Z.select({count:(0,u.QX)()}).from(p.diagnosesDrafts);e?.firstVersion&&s.where((0,c.Ft)(p.diagnosesDrafts.diagnosisId)),e?.scriptId&&s.where((0,c.eq)(p.diagnosesDrafts.scriptId,e.scriptId));let t=await s.execute();return t[0]?.count||0}async function $(e){let s=await f.Z.delete(p.diagnosesDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_diagnoses_drafts"),s}t(85336);var P=t(28585);async function k(e){try{let{items:s,broadcastAction:t}={...e},r=["configKeys"===s?(0,c.K0)(p.pendingDeletion.configKeyId):void 0,"scripts"===s?(0,c.xD)((0,c.K0)(p.pendingDeletion.scriptId),(0,c.Ft)(p.pendingDeletion.screenId),(0,c.Ft)(p.pendingDeletion.diagnosisId)):void 0,"screens"===s?(0,c.K0)(p.pendingDeletion.screenId):void 0,"diagnoses"===s?(0,c.K0)(p.pendingDeletion.diagnosisId):void 0];return await f.Z.delete(p.pendingDeletion).where(r.length?(0,c.xD)(...r):void 0),t&&n.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return d.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function T(){try{let e=await f.Z.select({count:(0,u.QX)()}).from(p.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return d.Z.log("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let C={scripts:0,screens:0,diagnoses:0,configKeys:0,total:0};async function W(){let e={...C};try{let s=await f.Z.select({count:(0,u.QX)()}).from(p.scriptsDrafts);e.scripts=s[0]?.count||0;let t=await f.Z.select({count:(0,u.QX)()}).from(p.screensDrafts);e.screens=t[0]?.count||0;let r=await f.Z.select({count:(0,u.QX)()}).from(p.diagnosesDrafts);e.diagnoses=r[0]?.count||0;let a=await f.Z.select({count:(0,u.QX)()}).from(p.configKeysDrafts);return e.configKeys=a[0]?.count||0,e.total=e.configKeys+e.diagnoses+e.screens+e.scripts,{...e}}catch(s){return d.Z.log("_countDrafts ERROR",s.message),{...e,errors:[s.message]}}}var V=t(40618);async function U(){let e=[],s=!1;try{let t=await T();t.errors?.forEach(s=>e.push(s));let{errors:r,...a}=await W();r?.forEach(s=>e.push(s));let i=await Y();return s="development"===i&&(!!a.total||!!t.total),{pendingDeletion:t.total,drafts:a,errors:e.length?e:void 0,shouldPublishData:s}}catch(t){return d.Z.log("getEditorDetails ERROR",t.message),{errors:[t.message,...e],pendingDeletion:0,drafts:C,shouldPublishData:s}}}let F=(0,r.j)("6631df3cf85446a0818ac2dde947f63d2fad6c89",B);async function B(e,s){return(0,i.revalidatePath)(e,s)}let L=(0,r.j)("64f3a633dace3ede963f725b16dc2b5f210bdd56",H);async function H(){try{let e=await S(),s=await A(),t=await j(),r=await M();return{configKeys:e,screens:s,scripts:t,diagnoses:r}}catch(e){return d.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,diagnoses:0}}}async function X(){let e={success:!0};try{await (0,R.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]);let s=await x(),t=await (0,o.Ls)(),r=await (0,K.Ry)(),a=await (0,P.gv)();s.errors&&(e.success=!1,e.errors=[...e.errors||[],...s.errors]),t.errors&&(e.success=!1,e.errors=[...e.errors||[],...t.errors]),r.errors&&(e.success=!1,e.errors=[...e.errors||[],...r.errors]),a.errors&&(e.success=!1,e.errors=[...e.errors||[],...a.errors]),n.Z.emit("data_changed","publish_data")}catch(s){e.success=!1,e.errors=[s.message],d.Z.error("publishData ERROR",s.message)}finally{return e}}async function J(){let e={success:!0};try{await (0,R.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),await q(),await O(),await E(),await $(),await k(),n.Z.emit("data_changed","discard_drafts")}catch(s){e.success=!1,e.errors=[s.message],d.Z.error("publishData ERROR",s.message)}finally{return e}}async function Q(e){let s=(0,a.cookies)().get(e);return s?.value||null}async function z(e){(0,a.cookies)().set(e)}async function Y(){let e="view";try{let s=await Q("mode");s?e=s:await z({name:"mode",value:e})}catch(e){d.Z.error("getMode ERROR",e.message)}finally{return e}}async function G(e){try{await z({name:"mode",value:e}),n.Z.emit("mode_changed",e)}catch(e){d.Z.error("setMode ERROR",e.message)}}(0,V.h)([U,F,L,X,J,Q,z,Y,G]),(0,r.j)("7b75f487e334a946b63829017d9aa902b59378e0",U),(0,r.j)("893d510641fbd37b4cbe2a75916de7869dd43ca6",F),(0,r.j)("3b2ac91bc81489809370d893a7d7c83a162e1a96",L),(0,r.j)("1deaec5322a5d4e3e3d426178bd61a39c0c28ae9",X),(0,r.j)("e8515d84060942f8f3866c65cc44204f02ef54e2",J),(0,r.j)("4958dc639faa75249a639ef7ce81c8c71ee4c24a",Q),(0,r.j)("88f9dd170a821c7d7365f4d4939c7fe794c4c2e9",z),(0,r.j)("98e38f6190d1550c36102fe6acadfd92953e95cf",Y),(0,r.j)("ab746bc027c1a6df89eba1266023bcc3935f86c4",G)},65376:(e,s,t)=>{"use strict";t.r(s),t.d(s,{$$ACTION_0:()=>I,getSites:()=>y,importRemoteScripts:()=>m});var r=t(24330);t(60166);var a=t(92237),i=t(57435),n=t(66267),d=t(29712),o=t(57745),c=t(88317),l=t(10413),f=t(57418),p=t(49530),g=t(20706);async function u({siteId:e,scriptsIds:s},t){let r={success:!1};try{if(!e)throw Error("Missing siteId");let a=await l.Z.query.sites.findFirst({where:(0,o.eq)(f.sites.siteId,e)});if(!a)throw Error("Site not found");let n="https://webeditor-dev.neotree.org",u=d.Z.create({baseURL:`${n}/api`});for(let{scriptId:e,overWriteExistingScriptWithId:t}of(u.interceptors.request.use(async e=>(e.headers&&(e.headers["x-api-key"]=a.apiKey),i.Z.error(e.method,[`${n}/api`,e.url].join("")),e)),u.interceptors.response.use(e=>e,e=>new Promise((s,t)=>t(e))),s)){let{data:s=[],errors:a}=(await u.get("/scripts/with-items?"+p.Z.stringify({scriptsIds:JSON.stringify([e])}))).data;if(a?.length)r.success=!1,r.errors=a;else{let e=await (0,g.gX)(s.map(e=>({...e,scriptId:t||e.scriptId})),{overWriteScriptId:!t});e.errors&&(r.success=!1,r.errors=[...r.errors||[],...e.errors])}}!r.errors?.length&&(r.success=!0,t?.broadcastAction&&c.Z.emit("data_changed","create_scripts_drafts"))}catch(s){let e=s.response?.data?.message||s.response?.data||s.message;r.success=!1,r.errors=[e],i.Z.error("importRemoteScripts ERROR",e)}finally{return r}}var h=t(40618);let y=a.Q,m=(0,r.j)("0c0d3a976a0d3670bfcd783a4eda74ef47d08486",I);async function I(...e){let s={success:!1};try{await (0,n.isAllowed)(["import_scripts"]),s=await u(...e)}catch(e){s.errors=[e.message],i.Z.error("importRemoteScripts ERROR",e.message)}finally{return s}}(0,h.h)([y,m]),(0,r.j)("fb88c3f5187f1ae67c65c11fdc8ca29dc4350c9d",y),(0,r.j)("eb767362e2857509ccd48c4eb7968f5169ef228f",m)},60563:(e,s,t)=>{"use strict";t.r(s),t.d(s,{$$ACTION_0:()=>g,$$ACTION_1:()=>h,getSys:()=>p,updateSys:()=>u});var r=t(24330);t(60166);var a=t(57745),i=t(88317),n=t(57435),d=t(10413),o=t(57418);async function c(e={},s){let t={success:!1};try{for(let s of Object.keys(e))try{await d.Z.update(o.sys).set({value:e[s]}).where((0,a.eq)(o.sys.key,s))}catch(e){t.errors=[...t?.errors||[],e.message]}!t.errors?.length&&(t.success=!0,s?.broadcastAction&&i.Z.emit("update_system"))}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_updateSys ERROR",e.message)}finally{return t}}async function l(){let e={data:{}};try{let s=(await d.Z.query.sys.findMany()).reduce((e,s)=>({...e,[s.key]:s.value}),{});e.data=s}catch(s){e.errors=[s.message],n.Z.error("_getSys ERROR",s.message)}finally{return e}}var f=t(40618);let p=(0,r.j)("458e0bb776cc3d544fd3487595ecc0d4d43114fc",g);async function g(...e){return await l(...e)}let u=(0,r.j)("33d8b15ec8dd98c91eac63d85211264cf0a630b8",h);async function h(...e){let s={success:!1};try{s=await c(...e)}catch(e){s.errors=[e.message],n.Z.error("getSys ERROR",e.message)}finally{return s}}(0,f.h)([p,u]),(0,r.j)("b0d634be4cc158e4043dd09673ee30e8e18999af",p),(0,r.j)("62ecd67a03f8f29d7d9a14399a69f12cd0186bad",u)},69684:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>C,metadata:()=>T});var r=t(19510),a=t(81082),i=t.n(a);t(3641);var n=t(68570);let d=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/providers/auth-context-provider.tsx`),{__esModule:o,$$typeof:c}=d;d.default;let l=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/providers/auth-context-provider.tsx#AuthContextProvider`),f=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/providers/theme-provider.tsx`),{__esModule:p,$$typeof:g}=f;f.default;let u=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/providers/theme-provider.tsx#ThemeProvider`),h=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/ui/sonner.tsx`),{__esModule:y,$$typeof:m}=h;h.default;let I=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/ui/sonner.tsx#Toaster`),w=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/modals/confirm.tsx`),{__esModule:D,$$typeof:v}=w;w.default;let x=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/modals/confirm.tsx#ConfirmModal`),b=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/modals/alert.tsx`),{__esModule:Z,$$typeof:_}=b;b.default;let R=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/modals/alert.tsx#AlertModal`),K=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/contexts/app/index.tsx`),{__esModule:S,$$typeof:A}=K;K.default,(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/contexts/app/index.tsx#AppContext`),(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/contexts/app/index.tsx#useAppContext`);let j=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/contexts/app/index.tsx#AppContextProvider`);var q=t(60563),E=t(65376),N=t(40801),O=t(11844);t(67272);let M=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/socket-events-listener.tsx`),{__esModule:$,$$typeof:P}=M;M.default;let k=(0,n.createProxy)(String.raw`/Users/lafarai/Werq/BWS/NeoTree/neotree-webeditor/components/socket-events-listener.tsx#SocketEventsListener`),T={title:"Neotree",description:"Neotree",icons:[{media:"(prefers-color-scheme: light)",url:"/images/favicon.ico",href:"/images/favicon.ico"},{media:"(prefers-color-scheme: dark)",url:"/images/favicon.ico",href:"/images/favicon.ico"}]};async function C({children:e}){let[s,t,a,n]=await Promise.all([O.getEditorDetails(),(0,N.getAuthenticatedUser)(),O.getMode(),(0,q.getSys)()]);return r.jsx("html",{lang:"en",children:r.jsx("body",{className:i().className,children:r.jsx(l,{children:(0,r.jsxs)(u,{attribute:"class",defaultTheme:"light",enableSystem:!0,disableTransitionOnChange:!0,children:[(0,r.jsxs)(j,{...O,...q,...s,sys:n,mode:a||"view",getSites:E.getSites,authenticatedUser:t,children:[e,r.jsx(k,{events:[{name:"mode_changed",onEvent:{refreshRouter:!0}},{name:"update_system",onEvent:{refreshRouter:!0}},{name:"data_changed",onEvent:{refreshRouter:!0}}]})]}),r.jsx(I,{}),r.jsx(x,{}),r.jsx(R,{})]})})})})}},18100:(e,s,t)=>{"use strict";t.d(s,{j:()=>o});var r=t(57745),a=t(88317),i=t(10413),n=t(57435),d=t(57418);async function o({restoreKeys:e},s){let t={success:!1};try{let n=e.length?await i.Z.query.screensHistory.findMany({where:(0,r.d3)(d.screensHistory.restoreKey,e),columns:{id:!0,screenId:!0}}):[],o=n.map(e=>e.screenId);o.length&&(await i.Z.update(d.screens).set({deletedAt:null}).where((0,r.d3)(d.screens.screenId,o)),await i.Z.delete(d.screensHistory).where((0,r.d3)(d.screensHistory.id,n.map(e=>e.id)))),!t.errors?.length&&(t.success=!0,o.length&&s?.broadcastAction&&s?.broadcastAction&&a.Z.emit("data_changed","update_screens"))}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_restoreScreens ERROR",e.message)}finally{return t}}},20706:(e,s,t)=>{"use strict";t.d(s,{gX:()=>h,Ls:()=>y});var r=t(57745),a=t(9576),i=t(88317),n=t(57435),d=t(10413),o=t(57418),c=t(57040),l=t(28422),f=t(18100),p=t(28585);async function g(e,s){let t={success:!1};try{let{diagnosisIds:a,scriptsIds:n,restoreKey:c,force:l}={...e},f=[...a||n?[(0,r.or)(a?.filter(e=>e)?.length?(0,r.d3)(o.diagnoses.diagnosisId,a):void 0,n?.filter(e=>e)?.length?(0,r.d3)(o.diagnoses.scriptId,n):void 0)]:[]];if(!f.length&&!l)throw Error("You&apos;re trying to delete all the diagnoses, please provide a force parameter.");let p=await d.Z.query.diagnoses.findMany({where:(0,r.xD)(...f)}),g=new Date;await d.Z.update(o.diagnoses).set({deletedAt:g}).where((0,r.xD)(...f)),p.length&&await d.Z.delete(o.diagnosesDrafts).where((0,r.xD)((0,r.K0)(o.diagnosesDrafts.diagnosisId),(0,r.d3)(o.diagnosesDrafts.diagnosisId,p.map(e=>e.diagnosisId)))),await d.Z.insert(o.diagnosesHistory).values(p.map(e=>({version:e.version,diagnosisId:e.diagnosisId,scriptId:e.scriptId,restoreKey:c,changes:{action:"delete_diagnosis",dediagnosision:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:g}]}}))),!t.errors?.length&&(t.success=!0,s?.broadcastAction&&i.Z.emit("data_changed","delete_diagnoses"))}catch(e){n.Z.error("_deleteDiagnoses ERROR",e.message),t.success=!1,t.errors=[e.message]}finally{return t}}async function u(e,s){let t={success:!1};try{let{screenIds:a,scriptsIds:n,restoreKey:c,force:l}={...e},f=[...a||n?[(0,r.or)(a?.filter(e=>e)?.length?(0,r.d3)(o.screens.screenId,a):void 0,n?.filter(e=>e)?.length?(0,r.d3)(o.screens.scriptId,n):void 0)]:[]];if(!f.length&&!l)throw Error("You&apos;re trying to delete all the screens, please provide a force parameter.");let p=await d.Z.query.screens.findMany({where:(0,r.xD)(...f)}),g=new Date;await d.Z.update(o.screens).set({deletedAt:g}).where((0,r.xD)(...f)),p.length&&await d.Z.delete(o.screensDrafts).where((0,r.xD)((0,r.K0)(o.screensDrafts.screenId),(0,r.d3)(o.screensDrafts.screenId,p.map(e=>e.screenId)))),await d.Z.insert(o.screensHistory).values(p.map(e=>({version:e.version,screenId:e.screenId,scriptId:e.scriptId,restoreKey:c,changes:{action:"delete_screen",descreenion:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:g}]}}))),!t.errors?.length&&(t.success=!0,s?.broadcastAction&&i.Z.emit("data_changed","delete_screens"))}catch(e){n.Z.error("_deleteScreens ERROR",e.message),t.success=!1,t.errors=[e.message]}finally{return t}}async function h(e,s){let t={success:!1};try{let n=s?.overWriteScriptId===void 0||s.overWriteScriptId,l=await (0,c.Tx)(),f=(l.data.length?Math.max(...l.data.map(e=>e.position)):0)+1;for(let{screens:s=[],diagnoses:i=[],...c}of e)try{let e=await (n?null:d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,c.scriptId),with:{draft:!0}})),l=await (n?null:e?.draft||d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,c.scriptId)})),p={...function(e){let s=(0,a.Z)(),t={...e,scriptId:s,version:1,oldScriptId:void 0,publishDate:void 0,createdAt:void 0,deletedAt:void 0,updatedAt:void 0,isDraft:void 0,publishedVersion:void 0};return["id","oldScriptId","publishDate","createdAt","deletedAt","updatedAt","isDraft","publishedVersion","draft"].forEach(e=>{delete t[e]}),t}(c),position:f};for(let i of(f++,p.scriptId=l?.scriptDraftId||e?.scriptId||p.scriptId,p.position=l?.data?.position||e?.position||f,p.version=l?.data?.version||(e?.version?e.version+1:p.version),l?await d.Z.update(o.scriptsDrafts).set({data:p}).where((0,r.eq)(o.scriptsDrafts.scriptDraftId,l.scriptDraftId)):await d.Z.insert(o.scriptsDrafts).values([{data:p,scriptDraftId:p.scriptId,scriptId:e?.scriptId,position:p.position}]),(l||e)&&(await u({scriptsIds:[p.scriptId],restoreKey:`script_draft_${p.scriptId}`}),await d.Z.delete(o.screensDrafts).where((0,r.eq)(o.screensDrafts.scriptDraftId,p.scriptId))),s)){let e=function(e){let s=(0,a.Z)(),t={...e,screenId:s,version:1};return["id","scriptId","oldScreenId","oldScriptId","publishDate","createdAt","deletedAt","updatedAt","isDraft","publishedVersion","draft"].forEach(e=>{delete t[e]}),t}(i);try{await d.Z.insert(o.screensDrafts).values([{data:e,position:e.position,screenDraftId:e.screenId,scriptDraftId:p.scriptId,type:e.type}])}catch(e){t.success=!1,t.errors=t.errors||[],t.errors.push(`Failed to save script: ${c.title} (${e.message})`)}}for(let s of((l||e)&&(await g({scriptsIds:[p.scriptId],restoreKey:`script_draft_${p.scriptId}`}),await d.Z.delete(o.diagnosesDrafts).where((0,r.eq)(o.diagnosesDrafts.scriptDraftId,p.scriptId))),i)){let e=function(e){let s=(0,a.Z)(),t={...e,diagnosisId:s,version:1};return["id","scriptId","oldDiagnosisId","oldScriptId","publishDate","createdAt","deletedAt","updatedAt","isDraft","publishedVersion","draft"].forEach(e=>{delete t[e]}),t}(s);try{await d.Z.insert(o.diagnosesDrafts).values([{data:e,position:e.position,diagnosisDraftId:e.diagnosisId,scriptDraftId:p.scriptId}])}catch(e){t.success=!1,t.errors=t.errors||[],t.errors.push(`Failed to save script: ${c.title} (${e.message})`)}}}catch(e){t.success=!1,t.errors=t.errors||[],t.errors.push(`Failed to save script: ${c.title} (${e.message})`)}!t.errors?.length&&(t.success=!0,s?.broadcastAction&&i.Z.emit("data_changed","create_scripts_drafts"))}catch(s){let e=s.response?.data?.message||s.response?.data||s.message;t.success=!1,t.errors=[e],n.Z.error("importScripts ERROR",e)}finally{return t}}async function y(){let e={success:!0};try{let s=await d.Z.query.scriptsDrafts.findMany({columns:{scriptDraftId:!0,scriptId:!0}}),t=s.filter(e=>!e.scriptId).map(e=>({scriptDraftId:e.scriptDraftId})),r=s.filter(e=>e.scriptId).map(e=>({scriptId:e.scriptId})),a=[];if(r.length){let e=await I(r);e.data.forEach(e=>e.errors?.forEach(e=>a.push(e))),e.errors?.forEach(e=>a.push(e))}if(t.length){let e=await m(t);e.errors?.forEach(e=>a.push(e))}a.length&&(e.success=!1,e.errors=a)}catch(s){e.success=!1,e.errors=[s.message],n.Z.error("_publishScripts ERROR",s.message)}finally{return e}}async function m(e,s){let t={inserted:[],success:!1};try{let n=[],g=e.length?await d.Z.query.scriptsDrafts.findMany({where:(0,r.d3)(o.scriptsDrafts.scriptDraftId,e.map(e=>e.scriptDraftId))}):[],u=[];for(let{id:e,data:s}of(g.filter(e=>e.scriptId).length&&(u=await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,g.filter(e=>e.scriptId).map(e=>e.scriptId))})),g)){let t=s.scriptId||(0,a.Z)();n.push({...s,scriptId:t}),g=g.map(s=>(s.id===e&&(s.data.scriptId=t),s))}await d.Z.insert(o.scripts).values(n);let h=await (0,c.Tw)({scriptIds:n.map(e=>e.scriptId)});for(let{scriptId:e}of h.data){let s=g.filter(s=>s.data.scriptId===e)[0];await d.Z.update(o.screensDrafts).set({scriptId:e}).where((0,r.eq)(o.screensDrafts.scriptDraftId,s.scriptDraftId)),await d.Z.update(o.diagnosesDrafts).set({scriptId:e}).where((0,r.eq)(o.diagnosesDrafts.scriptDraftId,s.scriptDraftId))}let y=await (0,l.Ry)({scriptsReferences:e.map(e=>e.scriptDraftId)});y.errors&&(t.errors=[...t.errors||[],...y.errors]);let m=await (0,p.gv)({scriptsReferences:e.map(e=>e.scriptDraftId)});m.errors&&(t.errors=[...t.errors||[],...m.errors]),t.inserted=s?.returnInserted?h.data:[],t.success=!0,await w({drafts:g,previous:u}),g.length&&(await d.Z.delete(o.scriptsDrafts).where((0,r.d3)(o.scriptsDrafts.id,g.map(e=>e.id))),g.length&&(await (0,f.j)({restoreKeys:g.map(e=>`script_draft_${e.scriptDraftId}`)}),await d.Z.update(o.screensHistory).set({restoreKey:null}).where((0,r.d3)(o.screensHistory.restoreKey,g.map(e=>`script_draft_${e.scriptDraftId}`))))),s?.broadcastAction&&i.Z.emit("data_changed","create_scripts")}catch(e){t.errors=[e.message],n.Z.error("_createScripts ERROR",e.message)}finally{return t}}async function I(e,s){let t={data:[]};try{let a=e.length?await d.Z.query.scriptsDrafts.findMany({where:(0,r.d3)(o.scriptsDrafts.scriptId,e.map(e=>e.scriptId))}):[],p=[];for(let{scriptId:e,data:i}of(a.filter(e=>e.scriptId).length&&(p=await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,a.filter(e=>e.scriptId).map(e=>e.scriptId))})),a)){let l=e,{scriptId:f,id:p,oldScriptId:g,createdAt:u,updatedAt:h,deletedAt:y,...m}=i;try{let e={...m,publishDate:new Date};await d.Z.update(o.scripts).set(e).where((0,r.eq)(o.scripts.scriptId,l));let a=s?.returnUpdated?await (0,c.bK)(l):void 0;t.data.push({scriptId:l,script:a})}catch(e){n.Z.error(`_updateScripts scriptId=${l}`,e.message),t.data.push({scriptId:l,errors:[e.message]}),a=a.filter(e=>e.data.scriptId!==l)}}await w({drafts:a,previous:p});let g=await (0,l.Ry)({scriptsReferences:e.map(e=>e.scriptId)});g.errors&&(t.errors=[...t.errors||[],...g.errors]),a.length&&(await d.Z.delete(o.scriptsDrafts).where((0,r.d3)(o.scriptsDrafts.id,a.map(e=>e.id))),a.length&&(await (0,f.j)({restoreKeys:a.map(e=>`script_draft_${e.scriptDraftId}`)}),await d.Z.update(o.screensHistory).set({restoreKey:null}).where((0,r.d3)(o.screensHistory.restoreKey,a.map(e=>`script_draft_${e.scriptDraftId}`))))),s?.broadcastAction&&i.Z.emit("data_changed","update_scripts")}catch(e){n.Z.error("_updateScripts ERROR",e),t.errors=[e.message,...t.errors||[]]}finally{return t}}async function w({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.scriptId===r?.data?.scriptId)[0],a=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=r.data[e],n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(a.push({[e]:n}),i.push({[e]:s}))}),s.changes={action:"update_script",description:"Update script",oldValues:a,newValues:i}}t.push(s)}await d.Z.insert(o.scriptsHistory).values(t)}catch(e){n.Z.error(e.message)}}},28585:(e,s,t)=>{"use strict";t.d(s,{gv:()=>l});var r=t(57745),a=t(9576),i=t(57435),n=t(88317),d=t(10413),o=t(57418),c=t(85336);async function l(e){let{scriptsReferences:s,diagnosesReferences:t}={...e},a={success:!0},n=[];try{let e=[],c=[];if(s?.length||t?.length){let a=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.or)(s?.length?(0,r.d3)(o.diagnosesDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(o.diagnosesDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisId,t):void 0,t?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,t):void 0),columns:{diagnosisId:!0,diagnosisDraftId:!0}});e=a.filter(e=>e.diagnosisId).map(e=>({diagnosisId:e.diagnosisId})),c=a.filter(e=>!e.diagnosisId).map(e=>({diagnosisDraftId:e.diagnosisDraftId}))}else{let s=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.K0)(o.diagnosesDrafts.scriptId),columns:{diagnosisId:!0,diagnosisDraftId:!0}});e=s.filter(e=>e.diagnosisId).map(e=>({diagnosisId:e.diagnosisId})),c=s.filter(e=>!e.diagnosisId).map(e=>({diagnosisDraftId:e.diagnosisDraftId}))}if(e.length&&(await p(e)).forEach(e=>e.error&&n.push(e.error)),c.length){let e=await f(c);e.errors?.forEach(e=>n.push(e))}n.length&&(a.success=!1,a.errors=n,i.Z.error("_publishDiagnoses ERRORS",n))}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishDiagnoses ERROR",e)}finally{return a}}async function f(e,s){let t={inserted:[],success:!1};try{let i=[],l=e.length?await d.Z.query.diagnosesDrafts.findMany({where:(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,e.map(e=>e.diagnosisDraftId))}):[],f=[];for(let{id:e,scriptId:s,data:n}of(l.filter(e=>e.diagnosisId).length&&(f=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,l.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),l)){let r=n.diagnosisId||(0,a.Z)(),c=n.scriptId||s,f={...n,diagnosisId:r,scriptId:c};i.push(f),l=l.map(s=>(s.id===e&&(s.data.diagnosisId=r),s));try{await d.Z.insert(o.diagnoses).values(f)}catch(e){t.errors=[...t.errors||[],`Error inserting ${n.name} - ${e.message}`]}}let p=await (0,c.XA)({diagnosisIds:i.map(e=>e.diagnosisId)});t.inserted=s?.returnInserted?p.data:[],t.success=!0,await g({drafts:l,previous:f}),l.length&&await d.Z.delete(o.diagnosesDrafts).where((0,r.d3)(o.diagnosesDrafts.id,l.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","create_diagnoses")}catch(e){t.errors=[e.message],i.Z.error("_createDiagnoses ERROR",e.message)}finally{return t}}async function p(e,s){let t=[],a=e.length?await d.Z.query.diagnosesDrafts.findMany({where:(0,r.d3)(o.diagnosesDrafts.diagnosisId,e.map(e=>e.diagnosisId))}):[],l=[];for(let{diagnosisId:e,data:n}of(a.filter(e=>e.diagnosisId).length&&(l=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,a.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),a)){let l=e,{diagnosisId:f,id:p,oldDiagnosisId:g,createdAt:u,updatedAt:h,deletedAt:y,...m}=n;try{let e={...m,publishDate:new Date};await d.Z.update(o.diagnoses).set(e).where((0,r.eq)(o.diagnoses.diagnosisId,l));let a=s?.returnUpdated?await (0,c.Ew)(l):void 0;t.push({diagnosisId:l,diagnosis:a})}catch(e){i.Z.error(`_updateDiagnoses diagnosisId=${l}`,e.message),t.push({diagnosisId:l,error:e.message}),a=a.filter(e=>e.data.diagnosisId!==l)}}return await g({drafts:a,previous:l}),a.length&&await d.Z.delete(o.diagnosesDrafts).where((0,r.d3)(o.diagnosesDrafts.id,a.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","create_diagnoses"),t}async function g({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,diagnosisId:r?.data?.diagnosisId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_diagnosis",dediagnosision:"Create diagnosis",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.diagnosisId===r?.data?.diagnosisId)[0],a=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=r.data[e],n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(a.push({[e]:n}),i.push({[e]:s}))}),s.changes={action:"update_diagnosis",dediagnosision:"Update diagnosis",oldValues:a,newValues:i}}t.push(s)}await d.Z.insert(o.diagnosesHistory).values(t)}catch(e){i.Z.error(e.message)}}t(57040)},28422:(e,s,t)=>{"use strict";t.d(s,{Ry:()=>l});var r=t(57745),a=t(9576),i=t(57435),n=t(88317),d=t(10413),o=t(57418),c=t(27457);async function l(e){let{scriptsReferences:s,screensReferences:t}={...e},a={success:!0},n=[];try{let e=[],c=[];if(s?.length||t?.length){let a=await d.Z.query.screensDrafts.findMany({where:(0,r.or)(s?.length?(0,r.d3)(o.screensDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(o.screensDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(o.screensDrafts.screenId,t):void 0,t?.length?(0,r.d3)(o.screensDrafts.screenDraftId,t):void 0),columns:{screenId:!0,screenDraftId:!0}});e=a.filter(e=>e.screenId).map(e=>({screenId:e.screenId})),c=a.filter(e=>!e.screenId).map(e=>({screenDraftId:e.screenDraftId}))}else{let s=await d.Z.query.screensDrafts.findMany({where:(0,r.K0)(o.screensDrafts.scriptId),columns:{screenId:!0,screenDraftId:!0}});e=s.filter(e=>e.screenId).map(e=>({screenId:e.screenId})),c=s.filter(e=>!e.screenId).map(e=>({screenDraftId:e.screenDraftId}))}if(e.length&&(await p(e)).forEach(e=>e.error&&n.push(e.error)),c.length){let e=await f(c);e.errors?.forEach(e=>n.push(e))}n.length&&(a.success=!1,a.errors=n,i.Z.error("_publishScreens ERRORS",n))}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishScreens ERROR",e)}finally{return a}}async function f(e,s){let t={inserted:[],success:!1};try{let i=[],l=e.length?await d.Z.query.screensDrafts.findMany({where:(0,r.d3)(o.screensDrafts.screenDraftId,e.map(e=>e.screenDraftId))}):[],f=[];for(let{id:e,scriptId:s,data:n}of(l.filter(e=>e.screenId).length&&(f=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,l.filter(e=>e.screenId).map(e=>e.screenId))})),l)){let r=n.screenId||(0,a.Z)(),c=n.scriptId||s,f={...n,screenId:r,scriptId:c};i.push(f),l=l.map(s=>(s.id===e&&(s.data.screenId=r),s));try{await d.Z.insert(o.screens).values(f)}catch(e){t.errors=[...t.errors||[],`Error inserting ${n.title} - ${e.message}`]}}let p=await (0,c.uK)({screenIds:i.map(e=>e.screenId)});t.inserted=s?.returnInserted?p.data:[],t.success=!0,await g({drafts:l,previous:f}),l.length&&await d.Z.delete(o.screensDrafts).where((0,r.d3)(o.screensDrafts.id,l.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","create_screens")}catch(e){t.errors=[e.message],i.Z.error("_createScreens ERROR",e.message)}finally{return t}}async function p(e,s){let t=[],a=e.length?await d.Z.query.screensDrafts.findMany({where:(0,r.d3)(o.screensDrafts.screenId,e.map(e=>e.screenId))}):[],l=[];for(let{screenId:e,data:n}of(a.filter(e=>e.screenId).length&&(l=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,a.filter(e=>e.screenId).map(e=>e.screenId))})),a)){let l=e,{screenId:f,id:p,oldScreenId:g,createdAt:u,updatedAt:h,deletedAt:y,...m}=n;try{let e={...m,publishDate:new Date};await d.Z.update(o.screens).set(e).where((0,r.eq)(o.screens.screenId,l));let a=s?.returnUpdated?await (0,c.NB)(l):void 0;t.push({screenId:l,screen:a})}catch(e){i.Z.error(`_updateScreens screenId=${l}`,e.message),t.push({screenId:l,error:e.message}),a=a.filter(e=>e.data.screenId!==l)}}return await g({drafts:a,previous:l}),a.length&&await d.Z.delete(o.screensDrafts).where((0,r.d3)(o.screensDrafts.id,a.map(e=>e.id))),s?.broadcastAction&&n.Z.emit("data_changed","create_screens"),t}async function g({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,screenId:r?.data?.screenId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_screen",descreenion:"Create screen",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.screenId===r?.data?.screenId)[0],a=[],i=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=r.data[e],n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(a.push({[e]:n}),i.push({[e]:s}))}),s.changes={action:"update_screen",descreenion:"Update screen",oldValues:a,newValues:i}}t.push(s)}await d.Z.insert(o.screensHistory).values(t)}catch(e){i.Z.error(e.message)}}t(57040)},57040:(e,s,t)=>{"use strict";t.d(s,{bK:()=>g,Tw:()=>y,Tx:()=>p});var r=t(57745),a=t(34149),i=t(60938),n=t(81445),d=t(30900),o=t(57435),c=t(41502),l=t(10413),f=t(57418);async function p(e){let s={data:[]};try{let t=await l.Z.query.scriptsDrafts.findMany({where:e?.length?(0,r.or)((0,r.d3)(f.scriptsDrafts.scriptId,e),(0,r.d3)(f.scriptsDrafts.scriptDraftId,e)):void 0,columns:{scriptId:!0,scriptDraftId:!0,data:!0}}),a=await l.Z.query.scripts.findMany({where:(0,r.xD)((0,r.Ft)(f.scripts.deletedAt),...t.length?[(0,r.Nl)(f.scripts.scriptId,t.map(e=>e.data.scriptId))]:[]),columns:{scriptId:!0,position:!0,title:!0}});return s.data=[...s.data,...t.map(e=>({scriptReference:e.scriptDraftId,scriptId:e.scriptId||void 0,scriptDraftId:e.scriptDraftId,isDraft:!0,title:e.data.title,position:e.data.position}))],s.data=[...s.data,...a.map(e=>({scriptReference:e.scriptId,scriptId:e.scriptId,isDraft:!1,title:e.title,position:e.position}))].sort((e,s)=>e.position-s.position),s}catch(e){s.error=e.message,o.Z.error("_listScripts ERROR",e.message)}finally{return s}}async function g(e){let s=d.Z(e)?(0,r.eq)(f.scripts.scriptId,e):(0,r.eq)(f.scripts.oldScriptId,e),t=await l.Z.query.scripts.findFirst({where:(0,r.xD)(s,(0,r.Ft)(f.scripts.deletedAt)),columns:{id:!0,scriptId:!0,oldScriptId:!0,publishDate:!0,createdAt:!0,updatedAt:!0,version:!0,type:!0,position:!0,title:!0,printTitle:!0,description:!0,hospitalId:!0,exportable:!0,nuidSearchEnabled:!0,nuidSearchFields:!0}});return t?{...t,nuidSearchFields:t.nuidSearchFields}:null}async function u({limit:e,page:s=1,scriptIds:t,searchValue:d,archived:o}){s=Math.max(0,s);let p=[];if(o?p.push((0,r.K0)(f.scripts.deletedAt)):p.push((0,r.Ft)(f.scripts.deletedAt)),t?.length&&p.push((0,r.d3)(f.scripts.scriptId,t)),d=`${d||""}`.trim()){let e=["%",d,"%"].join("");p.push((0,a.i6)`LOWER(scripts.name) like LOWER(${e})`)}let g=l.Z.select({count:(0,i.QX)()}).from(f.scripts);p.length&&g.where((0,r.xD)(...p));let[{count:u}]=await g.execute(),h=1;u&&(s=Math.min(s,h=(0,c.x)(e)?1:Math.ceil(u/e)));let y=(0,c.x)(e)?void 0:Math.max(0,(s-1)*e),m=l.Z.select({id:f.scripts.id,scriptId:f.scripts.scriptId,oldScriptId:f.scripts.oldScriptId,publishDate:f.scripts.publishDate,createdAt:f.scripts.createdAt,updatedAt:f.scripts.updatedAt,version:f.scripts.version,type:f.scripts.type,position:f.scripts.position,title:f.scripts.title,printTitle:f.scripts.printTitle,description:f.scripts.description,hospitalId:f.scripts.hospitalId,exportable:f.scripts.exportable,nuidSearchEnabled:f.scripts.nuidSearchEnabled,scriptDraftId:f.scriptsDrafts.scriptDraftId}).from(f.scripts).leftJoin(f.scriptsDrafts,(0,r.eq)(f.scripts.scriptId,f.scriptsDrafts.scriptId)).orderBy((0,n.C)(f.scripts.position));return(0,c.x)(e)||m.limit(e),y&&m.offset(y),p.length&&m.where((0,r.xD)(...p)),{page:s,limit:e,data:(await m.execute()).map(e=>({...e,publishedVersion:e.version})),totalRows:u,totalPages:h,searchValue:d,error:void 0}}let h={page:1,limit:void 0,totalRows:0,totalPages:1,data:[],searchValue:void 0,error:void 0};async function y(e){let s=h;try{s=await u({...e})}catch(e){o.Z.error("_getScripts ERROR",e),s.error=e.message}finally{return s}}},85336:(e,s,t)=>{"use strict";t.d(s,{Ew:()=>p,XA:()=>h});var r=t(57745),a=t(34149),i=t(60938),n=t(81445),d=t(30900),o=t(41502),c=t(10413),l=t(57418),f=t(57435);async function p(e){let s=d.Z(e)?(0,r.eq)(l.diagnoses.diagnosisId,e):(0,r.eq)(l.diagnoses.oldDiagnosisId,e),t=await c.Z.query.diagnoses.findFirst({where:(0,r.xD)(s,(0,r.Ft)(l.diagnoses.deletedAt))});return t?{...t,symptoms:t.symptoms,image1:t.image1,image2:t.image2,image3:t.image3}:null}async function g({limit:e,page:s=1,diagnosisIds:t,searchValue:d,archived:f,scriptsIds:p}){s=Math.max(0,s);let g=[];if(f?g.push((0,r.K0)(l.diagnoses.deletedAt)):g.push((0,r.Ft)(l.diagnoses.deletedAt)),t?.length&&g.push((0,r.d3)(l.diagnoses.diagnosisId,t)),p?.length&&g.push((0,r.d3)(l.diagnoses.scriptId,p)),d=`${d||""}`.trim()){let e=["%",d,"%"].join("");g.push((0,a.i6)`LOWER(diagnoses.name) like LOWER(${e})`)}let u=c.Z.select({count:(0,i.QX)()}).from(l.diagnoses);g.length&&u.where((0,r.xD)(...g));let[{count:h}]=await u.execute(),y=1;h&&(s=Math.min(s,y=(0,o.x)(e)?1:Math.ceil(h/e)));let m=(0,o.x)(e)?void 0:Math.max(0,(s-1)*e),I=c.Z.select({id:l.diagnoses.id,diagnosisId:l.diagnoses.diagnosisId,oldDiagnosisId:l.diagnoses.oldDiagnosisId,version:l.diagnoses.version,scriptId:l.diagnoses.scriptId,key:l.diagnoses.key,position:l.diagnoses.position,name:l.diagnoses.name,description:l.diagnoses.description,source:l.diagnoses.source,expression:l.diagnoses.expression,severityOrder:l.diagnoses.severityOrder,expressionMeaning:l.diagnoses.expressionMeaning,text1:l.diagnoses.text1,text2:l.diagnoses.text2,text3:l.diagnoses.text3,image1:l.diagnoses.image1,image2:l.diagnoses.image2,image3:l.diagnoses.image3,symptoms:l.diagnoses.symptoms,publishDate:l.diagnoses.publishDate,createdAt:l.diagnoses.createdAt,updatedAt:l.diagnoses.updatedAt,deletedAt:l.diagnoses.deletedAt,diagnosisDraftId:l.diagnosesDrafts.diagnosisDraftId,scriptDraftId:l.diagnosesDrafts.scriptDraftId}).from(l.diagnoses).leftJoin(l.diagnosesDrafts,(0,r.eq)(l.diagnoses.diagnosisId,l.diagnosesDrafts.diagnosisId)).orderBy((0,n.C)(l.diagnoses.position));return(0,o.x)(e)||I.limit(e),m&&I.offset(m),g.length&&I.where((0,r.xD)(...g)),{page:s,limit:e,data:(await I.execute()).map(e=>({...e,publishedVersion:e.version,isDraft:!1,diagnosisDraftId:e.diagnosisDraftId,scriptDraftId:e.scriptDraftId})),totalRows:h,totalPages:y,searchValue:d,error:void 0}}let u={page:1,limit:void 0,totalRows:0,totalPages:1,data:[],searchValue:void 0,error:void 0};async function h(e){let s=u;try{s=await g({...e})}catch(e){f.Z.error("_getDiagnoses ERROR",e),s.error=e.message}finally{return s}}},27457:(e,s,t)=>{"use strict";t.d(s,{NB:()=>p,uK:()=>h});var r=t(57745),a=t(34149),i=t(60938),n=t(81445),d=t(30900),o=t(41502),c=t(10413),l=t(57418),f=t(57435);async function p(e){let s=d.Z(e)?(0,r.eq)(l.screens.screenId,e):(0,r.eq)(l.screens.oldScreenId,e),t=await c.Z.query.screens.findFirst({where:(0,r.xD)(s,(0,r.Ft)(l.screens.deletedAt))});return t?{...t,fields:t.fields,items:t.items,image1:t.image1,image2:t.image2,image3:t.image3}:null}async function g({limit:e,page:s=1,screenIds:t,searchValue:d,archived:f,scriptsIds:p}){s=Math.max(0,s);let g=[];if(f?g.push((0,r.K0)(l.screens.deletedAt)):g.push((0,r.Ft)(l.screens.deletedAt)),t?.length&&g.push((0,r.d3)(l.screens.screenId,t)),p?.length&&g.push((0,r.d3)(l.screens.scriptId,p)),d=`${d||""}`.trim()){let e=["%",d,"%"].join("");g.push((0,a.i6)`LOWER(screens.name) like LOWER(${e})`)}let u=c.Z.select({count:(0,i.QX)()}).from(l.screens);g.length&&u.where((0,r.xD)(...g));let[{count:h}]=await u.execute(),y=1;h&&(s=Math.min(s,y=(0,o.x)(e)?1:Math.ceil(h/e)));let m=(0,o.x)(e)?void 0:Math.max(0,(s-1)*e),I=c.Z.select({id:l.screens.id,screenId:l.screens.screenId,oldScreenId:l.screens.oldScreenId,version:l.screens.version,scriptId:l.screens.scriptId,type:l.screens.type,position:l.screens.position,sectionTitle:l.screens.sectionTitle,condition:l.screens.condition,epicId:l.screens.epicId,storyId:l.screens.storyId,refId:l.screens.refId,step:l.screens.step,actionText:l.screens.actionText,contentText:l.screens.contentText,title:l.screens.title,title1:l.screens.title1,title2:l.screens.title2,title3:l.screens.title3,title4:l.screens.title4,instructions:l.screens.instructions,instructions2:l.screens.instructions2,instructions3:l.screens.instructions3,instructions4:l.screens.instructions4,text1:l.screens.text1,text2:l.screens.text2,text3:l.screens.text3,image1:l.screens.image1,image2:l.screens.image2,image3:l.screens.image3,hcwDiagnosesInstructions:l.screens.hcwDiagnosesInstructions,suggestedDiagnosesInstructions:l.screens.suggestedDiagnosesInstructions,notes:l.screens.notes,dataType:l.screens.dataType,confidential:l.screens.confidential,key:l.screens.key,label:l.screens.label,negativeLabel:l.screens.negativeLabel,positiveLabel:l.screens.positiveLabel,timerValue:l.screens.timerValue,multiplier:l.screens.multiplier,minValue:l.screens.minValue,maxValue:l.screens.maxValue,exportable:l.screens.exportable,skippable:l.screens.skippable,prePopulate:l.screens.prePopulate,fields:l.screens.fields,items:l.screens.items,publishDate:l.screens.publishDate,createdAt:l.screens.createdAt,updatedAt:l.screens.updatedAt,deletedAt:l.screens.deletedAt,screenDraftId:l.screensDrafts.screenDraftId,scriptDraftId:l.screensDrafts.scriptDraftId}).from(l.screens).leftJoin(l.screensDrafts,(0,r.eq)(l.screens.screenId,l.screensDrafts.screenId)).orderBy((0,n.C)(l.screens.position));return(0,o.x)(e)||I.limit(e),m&&I.offset(m),g.length&&I.where((0,r.xD)(...g)),{page:s,limit:e,data:(await I.execute()).map(e=>({...e,publishedVersion:e.version,isDraft:!1,screenDraftId:e.screenDraftId,scriptDraftId:e.scriptDraftId})),totalRows:h,totalPages:y,searchValue:d,error:void 0}}let u={page:1,limit:void 0,totalRows:0,totalPages:1,data:[],searchValue:void 0,error:void 0};async function h(e){let s=u;try{s=await g({...e})}catch(e){f.Z.error("_getScreens ERROR",e),s.error=e.message}finally{return s}}},3641:()=>{},67272:()=>{}};