"use strict";exports.id=3911,exports.ids=[3911],exports.modules={53911:(e,t,s)=>{s.r(t),s.d(t,{$$ACTION_0:()=>T,$$ACTION_1:()=>H,countAllDrafts:()=>W,discardDrafts:()=>L,getEditorDetails:()=>N,publishData:()=>J,revalidatePath:()=>U});var r=s(24330);s(60166);var a=s(57708),n=s(88317),i=s(57435),c=s(20706),o=s(57745),d=s(9576),f=s(10413),l=s(57418),g=s(34149),y=s(60938),u=s(81445),p=s(30900),K=s(41502);async function w(e){let t=p.Z(e)?(0,o.eq)(l.configKeys.configKeyId,e):(0,o.eq)(l.configKeys.oldConfigKeyId,e);return await f.Z.query.configKeys.findFirst({where:(0,o.xD)(t,(0,o.Ft)(l.configKeys.deletedAt)),columns:{id:!0,configKeyId:!0,oldConfigKeyId:!0,label:!0,key:!0,summary:!0,version:!0,position:!0}})}async function D({limit:e,page:t=1,configKeyIds:s,searchValue:r,archived:a}){t=Math.max(0,t);let n=[];if(a?n.push((0,o.K0)(l.configKeys.deletedAt)):n.push((0,o.Ft)(l.configKeys.deletedAt)),s?.length&&n.push((0,o.d3)(l.configKeys.configKeyId,s)),r=`${r||""}`.trim()){let e=["%",r,"%"].join("");n.push((0,g.i6)`LOWER(configKeys.name) like LOWER(${e})`)}let i=f.Z.select({count:(0,y.QX)()}).from(l.configKeys);n.length&&i.where((0,o.xD)(...n));let[{count:c}]=await i.execute(),d=1;c&&(t=Math.min(t,d=(0,K.x)(e)?1:Math.ceil(c/e)));let p=(0,K.x)(e)?void 0:Math.max(0,(t-1)*e),w=f.Z.select({id:l.configKeys.id,configKeyId:l.configKeys.configKeyId,oldConfigKeyId:l.configKeys.oldConfigKeyId,label:l.configKeys.label,key:l.configKeys.key,summary:l.configKeys.summary,version:l.configKeys.version,position:l.configKeys.position,configKeyDraftId:l.configKeysDrafts.configKeyDraftId}).from(l.configKeys).leftJoin(l.configKeysDrafts,(0,o.eq)(l.configKeys.configKeyId,l.configKeysDrafts.configKeyId)).orderBy((0,u.C)(l.configKeys.id));return(0,K.x)(e)||w.limit(e),p&&w.offset(p),n.length&&w.where((0,o.xD)(...n)),{page:t,limit:e,data:(await w.execute()).map(e=>({...e,publishedVersion:e.version})),totalRows:c,totalPages:d,searchValue:r,error:void 0}}let h={page:1,limit:void 0,totalRows:0,totalPages:1,data:[],searchValue:void 0,error:void 0};async function m(e){let t=h;try{t=await D({...e})}catch(e){i.Z.error("_getConfigKeys ERROR",e),t.error=e.message}finally{return t}}async function I(e){let t={success:!0};try{let e=await f.Z.query.configKeysDrafts.findMany({columns:{configKeyDraftId:!0,configKeyId:!0}}),s=e.filter(e=>!e.configKeyId),r=e.filter(e=>e.configKeyId).map(e=>({...e,configKeyId:e.configKeyId})),a=[];if(s.length){let{error:e}=await Z(s);e&&a.push(e)}r.length&&(await _(r)).forEach(e=>e.error&&a.push(e.error)),a.length&&(t.success=!1,t.errors=a)}catch(e){t.success=!1,t.errors=[e.message],i.Z.error("_publishConfigKeys ERROR",e.message)}finally{return t}}async function Z(e,t){let s={inserted:[],success:!1};try{let r=[],a=e.length?await f.Z.query.configKeysDrafts.findMany({where:(0,o.d3)(l.configKeysDrafts.configKeyDraftId,e.map(e=>e.configKeyDraftId))}):[],i=[];for(let{id:e,data:t}of(a.filter(e=>e.configKeyId).length&&(i=await f.Z.query.configKeys.findMany({where:(0,o.d3)(l.configKeys.configKeyId,a.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),a)){let s=t.configKeyId||(0,d.Z)();r.push({...t,configKeyId:s}),a=a.map(t=>(t.id===e&&(t.data.configKeyId=s),t))}await f.Z.insert(l.configKeys).values(r);let c=await m({configKeyIds:r.map(e=>e.configKeyId)});s.inserted=t?.returnInserted?c.data:[],s.success=!0,await v({drafts:a,previous:i}),a.length&&await f.Z.delete(l.configKeysDrafts).where((0,o.d3)(l.configKeysDrafts.id,a.map(e=>e.id))),t?.broadcastAction&&n.Z.emit("data_changed","create_config_keys")}catch(e){s.error=e.message}finally{return s}}async function _(e,t){let s=[],r=e.length?await f.Z.query.configKeysDrafts.findMany({where:(0,o.d3)(l.configKeysDrafts.configKeyId,e.map(e=>e.configKeyId))}):[],a=[];for(let{configKeyId:e,data:n}of(r.filter(e=>e.configKeyId).length&&(a=await f.Z.query.configKeys.findMany({where:(0,o.d3)(l.configKeys.configKeyId,r.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),r)){let a=e,{configKeyId:c,oldConfigKeyId:d,id:g,createdAt:y,updatedAt:u,deletedAt:p,...K}=n;try{let e={...K,publishDate:new Date};await f.Z.update(l.configKeys).set(e).where((0,o.eq)(l.configKeys.configKeyId,a));let r=t?.returnUpdated?await w(a):void 0;s.push({configKeyId:a,configKey:r})}catch(e){i.Z.error(`_updateConfigKeys configKeyId=${a}`,e.message),s.push({configKeyId:a,error:e.message}),r=r.filter(e=>e.data.configKeyId!==a)}}return await v({drafts:r,previous:a}),r.length&&await f.Z.delete(l.configKeysDrafts).where((0,o.d3)(l.configKeysDrafts.id,r.map(e=>e.id))),t?.broadcastAction&&n.Z.emit("data_changed","update_config_keys"),s}async function v({previous:e,drafts:t}){try{let s=[];for(let r of t){let t={version:r?.data?.version||1,configKeyId:r?.data?.configKeyId,changes:{}};if(r?.data?.version===1)t.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let s=e.filter(e=>e.configKeyId===r?.data?.configKeyId)[0],a=[],n=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=r.data[e],i={...s}[e];JSON.stringify(t)!==JSON.stringify(i)&&(a.push({[e]:i}),n.push({[e]:t}))}),t.changes={action:"update_config_key",description:"Update config key",oldValues:a,newValues:n}}s.push(t)}await f.Z.insert(l.configKeysHistory).values(s)}catch(e){i.Z.error(e.message)}}var R=s(66267),A=s(28422);async function b(e){let t=e?.firstVersion?[(0,o.Ft)(l.configKeysDrafts.configKeyId)]:[];e?.configKeysDraftsIds&&t.push((0,o.d3)(l.configKeysDrafts.configKeyDraftId,e.configKeysDraftsIds)),e?.configKeysIds&&t.push((0,o.d3)(l.configKeysDrafts.configKeyId,e.configKeysIds));let s=f.Z.select({count:(0,y.QX)()}).from(l.configKeysDrafts);t.length&&s.where((0,o.xD)(...t));let r=await s.execute();return r[0]?.count||0}async function E(e){let t=f.Z.select({count:(0,y.QX)()}).from(l.screensDrafts);e?.firstVersion&&t.where((0,o.Ft)(l.screensDrafts.screenId)),e?.scriptId&&t.where((0,o.eq)(l.screensDrafts.scriptId,e.scriptId));let s=await t.execute();return s[0]?.count||0}async function q(e){let t=f.Z.select({count:(0,y.QX)()}).from(l.scriptsDrafts);e?.firstVersion&&t.where((0,o.Ft)(l.scriptsDrafts.scriptId));let s=await t.execute();return s[0]?.count||0}async function x(e){let t=await f.Z.delete(l.configKeysDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_screens_drafts"),t}async function C(e){let t=await f.Z.delete(l.screensDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_screens_drafts"),t}s(27457),s(57040);var O=s(18100);async function M(e){let t=await f.Z.query.scriptsDrafts.findMany({columns:{scriptDraftId:!0,scriptId:!0}}),s=await f.Z.delete(l.scriptsDrafts);return t.length&&(await (0,O.j)({restoreKeys:t.map(e=>`script_draft_${e.scriptDraftId}`)}),await f.Z.update(l.screensHistory).set({restoreKey:null}).where((0,o.d3)(l.screensHistory.restoreKey,t.map(e=>`script_draft_${e.scriptDraftId}`)))),e?.broadcastAction&&n.Z.emit("data_changed","delete_scripts_drafts"),s}async function F(e){let t=f.Z.select({count:(0,y.QX)()}).from(l.diagnosesDrafts);e?.firstVersion&&t.where((0,o.Ft)(l.diagnosesDrafts.diagnosisId)),e?.scriptId&&t.where((0,o.eq)(l.diagnosesDrafts.scriptId,e.scriptId));let s=await t.execute();return s[0]?.count||0}async function k(e){let t=await f.Z.delete(l.diagnosesDrafts);return e?.broadcastAction&&n.Z.emit("data_changed","delete_diagnoses_drafts"),t}s(85336);var j=s(28585);async function V(e){try{let{items:t,broadcastAction:s}={...e},r=["configKeys"===t?(0,o.K0)(l.pendingDeletion.configKeyId):void 0,"scripts"===t?(0,o.xD)((0,o.K0)(l.pendingDeletion.scriptId),(0,o.Ft)(l.pendingDeletion.screenId),(0,o.Ft)(l.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,o.K0)(l.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,o.K0)(l.pendingDeletion.diagnosisId):void 0];return await f.Z.delete(l.pendingDeletion).where(r.length?(0,o.xD)(...r):void 0),s&&n.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return i.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function B(e){try{let{items:t}={...e},s=await f.Z.query.pendingDeletion.findMany({where:"configKeys"===t?(0,o.K0)(l.pendingDeletion.configKeyId):void 0});s.length&&await f.Z.update(l.configKeys).set({deletedAt:new Date}).where((0,o.d3)(l.configKeys.configKeyId,s.map(e=>e.configKeyId)));let r=await f.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,o.xD)((0,o.K0)(l.pendingDeletion.scriptId),(0,o.Ft)(l.pendingDeletion.screenId),(0,o.Ft)(l.pendingDeletion.diagnosisId)):void 0});r.length&&(await f.Z.update(l.scripts).set({deletedAt:new Date}).where((0,o.d3)(l.scripts.scriptId,r.map(e=>e.scriptId))),await f.Z.update(l.screens).set({deletedAt:new Date}).where((0,o.d3)(l.screens.scriptId,r.map(e=>e.scriptId))),await f.Z.update(l.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(l.diagnoses.scriptId,r.map(e=>e.scriptId))));let a=await f.Z.query.pendingDeletion.findMany({where:"screens"===t?(0,o.K0)(l.pendingDeletion.screenId):void 0});a.length&&await f.Z.update(l.screens).set({deletedAt:new Date}).where((0,o.d3)(l.screens.screenId,a.map(e=>e.screenId)));let n=await f.Z.query.pendingDeletion.findMany({where:"diagnoses"===t?(0,o.K0)(l.pendingDeletion.diagnosisId):void 0});return n.length&&await f.Z.update(l.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(l.diagnoses.diagnosisId,n.map(e=>e.diagnosisId))),await V(e),{success:!0}}catch(e){return i.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var Q=s(25060);async function X({data:e,increaseVersion:t,broadcastAction:s}){try{let r=await f.Z.query.editorInfo.findFirst();if(r){let s=t?r.dataVersion+1:r.dataVersion;await f.Z.update(l.editorInfo).set({...e,dataVersion:s}).where((0,o.eq)(l.editorInfo.id,r.id))}return(r=await f.Z.query.editorInfo.findFirst())&&s&&n.Z.emit("data_changed","save_editor_info"),{data:r||null,success:!!r}}catch(e){return i.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var P=s(18496),$=s(40618);async function N(){let e=[],t=!1;try{let s=await (0,P.y)();s.errors?.forEach(t=>e.push(t));let r=await Q.Ur();r.errors?.forEach(t=>e.push(t));let{errors:a,...n}=await Q.Yi();return a?.forEach(t=>e.push(t)),t=!!n.total||!!r.total,{pendingDeletion:r.total,drafts:n,errors:e.length?e:void 0,shouldPublishData:t,info:s.data}}catch(s){return i.Z.error("getEditorDetails ERROR",s.message),{errors:[s.message,...e],pendingDeletion:0,drafts:Q.Ic,shouldPublishData:t,info:null}}}let U=(0,r.j)("ac5d4de4d5312ee7fa1967d05ccea3edfbd18033",T);async function T(e,t){return(0,a.revalidatePath)(e,t)}let W=(0,r.j)("294bf0d6332f28a618099d7c02669de60070f8a2",H);async function H(){try{let e=await b(),t=await E(),s=await q(),r=await F();return{configKeys:e,screens:t,scripts:s,diagnoses:r}}catch(e){return i.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,diagnoses:0}}}async function J(){let e={success:!0};try{await (0,R.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]);let t=await I(),s=await (0,c.Ls)(),r=await (0,A.Ry)(),a=await (0,j.gv)(),i=await B();t.errors&&(e.success=!1,e.errors=[...e.errors||[],...t.errors]),s.errors&&(e.success=!1,e.errors=[...e.errors||[],...s.errors]),r.errors&&(e.success=!1,e.errors=[...e.errors||[],...r.errors]),a.errors&&(e.success=!1,e.errors=[...e.errors||[],...a.errors]),i.errors&&(e.success=!1,e.errors=[...e.errors||[],...i.errors]),await X({increaseVersion:e.success,broadcastAction:!0,data:{lastPublishDate:new Date}}),n.Z.emit("data_changed","publish_data")}catch(t){e.success=!1,e.errors=[t.message],i.Z.error("publishData ERROR",t.message)}finally{return e}}async function L(){let e={success:!0};try{await (0,R.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),await x(),await M(),await C(),await k(),await V(),n.Z.emit("data_changed","discard_drafts")}catch(t){e.success=!1,e.errors=[t.message],i.Z.error("publishData ERROR",t.message)}finally{return e}}(0,$.h)([N,U,W,J,L]),(0,r.j)("354f249d3682e1a7ac814300889c8b929172be69",N),(0,r.j)("afc9c4d3ed7201152607116aa5f72d4579144ffc",U),(0,r.j)("3af78304ef3b80b391189cdb5be758ed14bb9be7",W),(0,r.j)("112a744ae93bf04aba1a4250d687a325a73a55c1",J),(0,r.j)("2995d4697010486034183adc4a3028bfd106123b",L)},18496:(e,t,s)=>{s.d(t,{y:()=>n});var r=s(10413),a=s(57435);async function n(){try{return{data:await r.Z.query.editorInfo.findFirst()||null}}catch(e){return a.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,t,s)=>{s.d(t,{Yi:()=>g,Ur:()=>f,Nb:()=>d,Ic:()=>l});var r=s(60938),a=s(57435),n=s(57418),i=s(10413),c=s(81445);let o={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function d(){try{let{lastPublishDate:e}={...await i.Z.query.editorInfo.findFirst()},t=await i.Z.select({configKeysDrafts:n.configKeysDrafts.updatedAt}).from(n.configKeysDrafts).orderBy((0,c.C)(n.configKeysDrafts.updatedAt)).limit(1),s=await i.Z.select({diagnosesDrafts:n.diagnosesDrafts.updatedAt}).from(n.diagnosesDrafts).orderBy((0,c.C)(n.diagnosesDrafts.updatedAt)).limit(1),r=await i.Z.select({screensDrafts:n.screensDrafts.updatedAt}).from(n.screensDrafts).orderBy((0,c.C)(n.screensDrafts.updatedAt)).limit(1),a=await i.Z.select({scriptsDrafts:n.scriptsDrafts.updatedAt}).from(n.scriptsDrafts).orderBy((0,c.C)(n.scriptsDrafts.updatedAt)).limit(1),d=await i.Z.select({configKeys:n.configKeys.updatedAt}).from(n.configKeys).orderBy((0,c.C)(n.configKeys.updatedAt)).limit(1),f=await i.Z.select({diagnoses:n.diagnoses.updatedAt}).from(n.diagnoses).orderBy((0,c.C)(n.diagnoses.updatedAt)).limit(1),l=await i.Z.select({screens:n.screens.updatedAt}).from(n.screens).orderBy((0,c.C)(n.screens.updatedAt)).limit(1),g=await i.Z.select({scripts:n.scripts.updatedAt}).from(n.scripts).orderBy((0,c.C)(n.scripts.updatedAt)).limit(1),y=await i.Z.select({pendingDeletion:n.pendingDeletion.createdAt}).from(n.pendingDeletion).orderBy((0,c.C)(n.pendingDeletion.createdAt)).limit(1),u={...o,...t[0],...s[0],...r[0],...a[0],...d[0],...f[0],...l[0],...g[0],...y[0],lastPublished:e||null},p=[e?new Date(e).getTime():null,...Object.values(u).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),K=e;return p.length&&(K=new Date(Math.max(...p))),{data:{...u,latestChangesDate:K}}}catch(e){return a.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:o,errors:[e.message]}}}async function f(){try{let e=await i.Z.select({count:(0,r.QX)()}).from(n.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return a.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let l={scripts:0,screens:0,diagnoses:0,configKeys:0,total:0};async function g(){let e={...l};try{let t=await i.Z.select({count:(0,r.QX)()}).from(n.scriptsDrafts);e.scripts=t[0]?.count||0;let s=await i.Z.select({count:(0,r.QX)()}).from(n.screensDrafts);e.screens=s[0]?.count||0;let a=await i.Z.select({count:(0,r.QX)()}).from(n.diagnosesDrafts);e.diagnoses=a[0]?.count||0;let c=await i.Z.select({count:(0,r.QX)()}).from(n.configKeysDrafts);return e.configKeys=c[0]?.count||0,e.total=e.configKeys+e.diagnoses+e.screens+e.scripts,{...e}}catch(t){return a.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};