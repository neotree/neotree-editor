"use strict";exports.id=4997,exports.ids=[4997],exports.modules={44997:(e,a,t)=>{t.d(a,{F$:()=>K,pG:()=>f,Hc:()=>h,MM:()=>y,Jv:()=>o,gy:()=>c});var d=t(57745),s=t(9576),i=t(57435),r=t(10413),n=t(93567),u=t(88317),l=t(16916);async function y({data:e,broadcastAction:a,userId:t}){let l={success:!1};try{let a=[];for(let{uuid:i,isNewUuid:u,...l}of e.map(e=>({...e,uuid:e.uuid||s.Z(),isNewUuid:!e.uuid})))try{if(!a.length){let e=u?null:await r.Z.query.dataKeysDrafts.findFirst({where:(0,d.or)((0,d.eq)(n.dataKeysDrafts.uuid,i),l.uniqueKey?(0,d.eq)(n.dataKeysDrafts.uniqueKey,l.uniqueKey):void 0)}),a=e||u?null:await r.Z.query.dataKeys.findFirst({where:(0,d.eq)(n.dataKeys.uuid,i)});if(e){let a={...e.data,...l};await r.Z.update(n.dataKeysDrafts).set({data:a,name:a.name}).where((0,d.eq)(n.dataKeysDrafts.uuid,i))}else{let e=a?.uniqueKey||l.uniqueKey||s.Z(),d={...a,...l,uniqueKey:e,uuid:i,version:a?.version?a.version+1:1};await r.Z.insert(n.dataKeysDrafts).values({data:d,uuid:i,dataKeyId:a?.uuid,name:d.name,uniqueKey:e,createdByUserId:t})}}}catch(e){a.push(e.message)}return a.length?l.errors=a:(u.Z.emit("data_changed","save_data_keys"),l.success=!0),l}catch(e){return l.success=!1,l.errors=[e.message],i.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function o({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,l.aW)({uniqueKeys:a});return e=e.filter(e=>!t.data.find(a=>a.uniqueKey===e.uniqueKey)),await y({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function c({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,l.aW)({uniqueKeys:a});return await y({data:e.map(e=>{let a=t.data.find(a=>a.uniqueKey===e.uniqueKey);return console.log("existing?.uuid",a?.uuid),{...e,uuid:a?.uuid,id:a?.id,createdAt:a?.createdAt,updatedAt:a?.updatedAt,publishDate:a?.publishDate,deletedAt:a?.deletedAt,version:a?.version}})})}catch(e){return{success:!1,errors:[e.message]}}}async function K(e){try{return await r.Z.delete(n.dataKeysDrafts).where(e?.userId?(0,d.eq)(n.dataKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function f({dataKeysIds:e,broadcastAction:a,userId:t}){let s={success:!1};try{if(e.length){await r.Z.delete(n.dataKeysDrafts).where((0,d.d3)(n.dataKeysDrafts.uuid,e));let a=(await r.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,d.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:t}));a.length&&await r.Z.insert(n.pendingDeletion).values(a)}s.success=!0}catch(e){s.success=!1,s.errors=[e.message],i.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!s?.errors?.length&&a&&u.Z.emit("data_changed","delete_data_keys"),s}}async function g({previous:e,drafts:a}){try{let t=[];for(let d of a){let a={version:d?.data?.version||1,dataKeyId:d?.data?.uuid,changes:{}};if(d?.data?.version===1)a.changes={action:"create_data_key",description:"Create data key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.uuid===d?.data?.uuid)[0],s=[],i=[];Object.keys({...d?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=d.data[e],r={...t}[e];JSON.stringify(a)!==JSON.stringify(r)&&(s.push({[e]:r}),i.push({[e]:a}))}),a.changes={action:"update_data_key",description:"Update data key",oldValues:s,newValues:i}}t.push(a)}await r.Z.insert(n.dataKeysHistory).values(t)}catch(e){i.Z.error(e.message)}}var p=t(34149);async function h(e){let a={success:!1};try{let t=await r.Z.query.pendingDeletion.findMany({where:(0,d.xD)((0,d.K0)(n.pendingDeletion.dataKeyId),e?.userId?(0,d.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0),columns:{dataKeyId:!0},with:{dataKey:{columns:{version:!0}}}});if((t=t.filter(e=>e.dataKey)).length){let e=new Date;await r.Z.update(n.dataKeys).set({deletedAt:e}).where((0,d.d3)(n.dataKeys.uuid,t.map(e=>e.dataKeyId))),await r.Z.insert(n.dataKeysHistory).values(t.map(a=>({version:a.dataKey.version,dataKeyId:a.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await r.Z.delete(n.pendingDeletion).where((0,d.xD)((0,d.or)((0,d.K0)(n.pendingDeletion.dataKeyId),(0,d.K0)(n.pendingDeletion.dataKeyDraftId)),e?.userId?(0,d.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0));let i=[],u=[],l=await r.Z.query.dataKeysDrafts.findMany({where:e?.userId?(0,d.eq)(n.dataKeysDrafts.createdByUserId,e?.userId):void 0});if(i=l.filter(e=>e.dataKeyId),u=l.filter(e=>!e.dataKeyId),i.length){let e=[];for(let{dataKeyId:a,data:t}of(i.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,i.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),i)){let{uuid:e,id:s,createdAt:i,updatedAt:u,deletedAt:l,...y}=t,o={...y,publishDate:new Date};await r.Z.update(n.dataKeys).set(o).where((0,d.eq)(n.dataKeys.uuid,a)).returning()}await g({drafts:i,previous:e})}if(u.length){let e=[];for(let{id:a,data:t}of(u.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,u.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),u)){let e=t.uuid||(0,s.Z)(),d={...t,uuid:e};u=u.map(t=>(t.id===a&&(t.data.uuid=e),t)),await r.Z.insert(n.dataKeys).values(d)}await g({drafts:u,previous:e})}await r.Z.delete(n.dataKeysDrafts);let y=[...i.map(e=>e.dataKeyId),...t.map(e=>e.dataKeyId)];y.length&&await r.Z.update(n.dataKeys).set({version:(0,p.i6)`${n.dataKeys.version} + 1`}).where((0,d.d3)(n.dataKeys.uuid,y)),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishDataKeys ERROR",e)}finally{return a}}},16916:(e,a,t)=>{t.d(a,{gc:()=>K,aW:()=>y});var d=t(57745),s=t(34149),i=t(30900),r=t(9576),n=t(10413),u=t(93567),l=t(57435);async function y(e){try{let{dataKeysIds:a,names:t=[],uniqueKeys:l=[],returnDraftsIfExist:y=!0}={...e},o=a||[],c=t.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),K=l.filter(e=>e),f=[o?.length?(0,d.d3)(u.dataKeysDrafts.uuid,o.map(e=>i.Z(e)?e:r.Z())):void 0,c?.length?(0,d.d3)((0,s.i6)`lower(${u.dataKeysDrafts.name})`,c):void 0,K?.length?(0,d.d3)(u.dataKeysDrafts.uniqueKey,K):void 0].filter(e=>e),g=y?await n.Z.query.dataKeysDrafts.findMany({where:f.length?(0,d.xD)(...f):void 0}):[];o=o.filter(e=>!g.map(e=>e.uuid).includes(e));let p=[(0,d.Ft)(u.dataKeys.deletedAt),(0,d.Ft)(u.pendingDeletion),g.length?(0,d.Nl)(u.dataKeys.uuid,g.map(e=>e.uuid)):void 0,o?.length?(0,d.d3)(u.dataKeys.uuid,o.filter(e=>i.Z(e))):void 0,c?.length?(0,d.d3)((0,s.i6)`lower(${u.dataKeys.name})`,c):void 0,K?.length?(0,d.d3)(u.dataKeys.uniqueKey,K):void 0].filter(e=>e),h=(await n.Z.select({dataKey:u.dataKeys,pendingDeletion:u.pendingDeletion}).from(u.dataKeys).leftJoin(u.pendingDeletion,(0,d.eq)(u.pendingDeletion.dataKeyId,u.dataKeys.uuid)).where(p.length?(0,d.xD)(...p):void 0)).map(e=>e.dataKey),D=h.length?await n.Z.query.pendingDeletion.findMany({where:(0,d.d3)(u.pendingDeletion.dataKeyId,h.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!D.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var o=t(60938);let c={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function K(){try{let[{count:e}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts),[{count:a}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts).where((0,d.Ft)(u.dataKeysDrafts.dataKeyId)),[{count:t}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts).where((0,d.K0)(u.dataKeysDrafts.dataKeyId)),[{count:s}]=await n.Z.select({count:(0,o.QX)()}).from(u.pendingDeletion).where((0,d.K0)(u.pendingDeletion.dataKeyId)),[{count:i}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeys);return{data:{allPublished:i,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:s}}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:c,errors:[e.message]}}}}};