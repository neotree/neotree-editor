"use strict";exports.id=4997,exports.ids=[4997],exports.modules={44997:(e,a,t)=>{t.d(a,{F$:()=>p,pG:()=>h,Hc:()=>g,MM:()=>o,Jv:()=>c,gy:()=>f});var d=t(57745),i=t(9576),s=t(57435),r=t(10413),n=t(88728),l=t(88317),u=t(16916),y=t(48148);async function o({data:e,broadcastAction:a}){let t={success:!1};try{let a=[];for(let{uuid:t,isNewUuid:s,...l}of e.map(e=>({...e,uuid:e.uuid||i.Z(),isNewUuid:!e.uuid})))try{if(!a.length){let e=s?null:await r.Z.query.dataKeysDrafts.findFirst({where:(0,d.eq)(n.dataKeysDrafts.uuid,t)}),a=e||s?null:await r.Z.query.dataKeys.findFirst({where:(0,d.eq)(n.dataKeys.uuid,t)});if(e){let a={...e.data,...l};await r.Z.update(n.dataKeysDrafts).set({data:a,name:a.name}).where((0,d.eq)(n.dataKeysDrafts.uuid,t))}else{let e={...a,...l,uuid:t,version:a?.version?a.version+1:1};await r.Z.insert(n.dataKeysDrafts).values({data:e,uuid:t,dataKeyId:a?.uuid,name:e.name})}}}catch(e){a.push(e.message)}return a.length?t.errors=a:(l.Z.emit("data_changed","save_data_keys"),t.success=!0),t}catch(e){return t.success=!1,t.errors=[e.message],s.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function c({data:e}){try{let a=e.map(e=>e.name).filter(e=>e),t=await (0,u.aW)({names:a});return e=e.filter(e=>!t.data.find(a=>(0,y.l)(a,e))),await o({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function f({data:e}){try{let a=e.map(e=>e.name).filter(e=>e),t=await (0,u.aW)({names:a});return await o({data:e.map(e=>{let a=t.data.find(a=>(0,y.l)(a,e));return{...e,uuid:a?.uuid,id:a?.id,createdAt:a?.createdAt,updatedAt:a?.updatedAt,publishDate:a?.publishDate,deletedAt:a?.deletedAt,version:a?.version}})})}catch(e){return{success:!1,errors:[e.message]}}}async function p(){try{return await r.Z.delete(n.dataKeysDrafts),!0}catch(e){throw e}}async function h({dataKeysIds:e,broadcastAction:a}){let t={success:!1};try{if(e.length){await r.Z.delete(n.dataKeysDrafts).where((0,d.d3)(n.dataKeysDrafts.uuid,e));let a=(await r.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,d.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion);a.length&&await r.Z.insert(n.pendingDeletion).values(a)}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],s.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!t?.errors?.length&&a&&l.Z.emit("data_changed","delete_data_keys"),t}}async function K({previous:e,drafts:a}){try{let t=[];for(let d of a){let a={version:d?.data?.version||1,dataKeyId:d?.data?.uuid,changes:{}};if(d?.data?.version===1)a.changes={action:"create_data_key",description:"Create data key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.uuid===d?.data?.uuid)[0],i=[],s=[];Object.keys({...d?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=d.data[e],r={...t}[e];JSON.stringify(a)!==JSON.stringify(r)&&(i.push({[e]:r}),s.push({[e]:a}))}),a.changes={action:"update_data_key",description:"Update data key",oldValues:i,newValues:s}}t.push(a)}await r.Z.insert(n.dataKeysHistory).values(t)}catch(e){s.Z.error(e.message)}}var m=t(34149);async function g(e){let a={success:!1};try{let e=await r.Z.query.pendingDeletion.findMany({where:(0,d.K0)(n.pendingDeletion.dataKeyId),columns:{dataKeyId:!0},with:{dataKey:{columns:{version:!0}}}});if((e=e.filter(e=>e.dataKey)).length){let a=new Date;await r.Z.update(n.dataKeys).set({deletedAt:a}).where((0,d.d3)(n.dataKeys.uuid,e.map(e=>e.dataKeyId))),await r.Z.insert(n.dataKeysHistory).values(e.map(e=>({version:e.dataKey.version,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:a}]}})))}await r.Z.delete(n.pendingDeletion).where((0,d.or)((0,d.K0)(n.pendingDeletion.dataKeyId),(0,d.K0)(n.pendingDeletion.dataKeyDraftId)));let t=[],s=[],l=await r.Z.query.dataKeysDrafts.findMany();if(t=l.filter(e=>e.dataKeyId),s=l.filter(e=>!e.dataKeyId),t.length){let e=[];for(let{dataKeyId:a,data:i}of(t.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,t.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),t)){let{uuid:e,id:t,createdAt:s,updatedAt:l,deletedAt:u,...y}=i,o={...y,publishDate:new Date};await r.Z.update(n.dataKeys).set(o).where((0,d.eq)(n.dataKeys.uuid,a)).returning()}await K({drafts:t,previous:e})}if(s.length){let e=[];for(let{id:a,data:t}of(s.filter(e=>e.dataKeyId).length&&(e=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,s.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),s)){let e=t.uuid||(0,i.Z)(),d={...t,uuid:e};s=s.map(t=>(t.id===a&&(t.data.uuid=e),t)),await r.Z.insert(n.dataKeys).values(d)}await K({drafts:s,previous:e})}await r.Z.delete(n.dataKeysDrafts);let u=[...t.map(e=>e.dataKeyId),...e.map(e=>e.dataKeyId)];u.length&&await r.Z.update(n.dataKeys).set({version:(0,m.i6)`${n.dataKeys.version} + 1`}).where((0,d.d3)(n.dataKeys.uuid,u)),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],s.Z.error("_publishDataKeys ERROR",e)}finally{return a}}},16916:(e,a,t)=>{t.d(a,{gc:()=>p,aW:()=>y,jH:()=>o});var d=t(57745),i=t(34149),s=t(30900),r=t(9576),n=t(10413),l=t(88728),u=t(57435);async function y(e){try{let{dataKeysIds:a,names:t=[],returnDraftsIfExist:u=!0}={...e},y=a||[],o=t.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),c=[y?.length?(0,d.d3)(l.dataKeysDrafts.uuid,y.map(e=>s.Z(e)?e:r.Z())):void 0,o?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeysDrafts.name})`,o):void 0].filter(e=>e),f=u?await n.Z.query.dataKeysDrafts.findMany({where:c.length?(0,d.xD)(...c):void 0}):[];y=y.filter(e=>!f.map(e=>e.uuid).includes(e));let p=[(0,d.Ft)(l.dataKeys.deletedAt),(0,d.Ft)(l.pendingDeletion),f.length?(0,d.Nl)(l.dataKeys.uuid,f.map(e=>e.uuid)):void 0,y?.length?(0,d.d3)(l.dataKeys.uuid,y.filter(e=>s.Z(e))):void 0,o?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeys.name})`,o):void 0].filter(e=>e),h=(await n.Z.select({dataKey:l.dataKeys,pendingDeletion:l.pendingDeletion}).from(l.dataKeys).leftJoin(l.pendingDeletion,(0,d.eq)(l.pendingDeletion.dataKeyId,l.dataKeys.uuid)).where(p.length?(0,d.xD)(...p):void 0)).map(e=>e.dataKey),K=h.length?await n.Z.query.pendingDeletion.findMany({where:(0,d.d3)(l.pendingDeletion.dataKeyId,h.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!K.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function o(){let e=await y(),a=[];e.data.forEach(({children:e=[],uuid:t,...d})=>{a.map(e=>JSON.stringify(e)).includes(JSON.stringify(d))||a.push({...d,children:e,uuid:void 0}),e.forEach(({uuid:e,...t})=>{a.map(e=>JSON.stringify(e)).includes(JSON.stringify(t))||a.push({...t,uuid:void 0,isChild:!0})})});let t=a.map(e=>({label:e.name,value:e.name,description:e.label,caption:e.dataType||"",defaults:e.defaults,data:{label:e.label,key:e.name,isChild:e.isChild,children:e.children.map(e=>({label:e.label,value:e.name,dataType:e.dataType}))}}));return t=t.filter(e=>e.data?.key).sort((e,a)=>e.value<a.value?-1:e.value>a.value?1:0).map((e,a)=>({...e,value:e.value+a})),{errors:e.errors,data:t}}var c=t(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function p(){try{let[{count:e}]=await n.Z.select({count:(0,c.QX)()}).from(l.dataKeysDrafts),[{count:a}]=await n.Z.select({count:(0,c.QX)()}).from(l.dataKeysDrafts).where((0,d.Ft)(l.dataKeysDrafts.dataKeyId)),[{count:t}]=await n.Z.select({count:(0,c.QX)()}).from(l.dataKeysDrafts).where((0,d.K0)(l.dataKeysDrafts.dataKeyId)),[{count:i}]=await n.Z.select({count:(0,c.QX)()}).from(l.pendingDeletion).where((0,d.K0)(l.pendingDeletion.dataKeyId)),[{count:s}]=await n.Z.select({count:(0,c.QX)()}).from(l.dataKeys);return{data:{allPublished:s,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:i}}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:f,errors:[e.message]}}}},48148:(e,a,t)=>{t.d(a,{c:()=>r,l:()=>s});var d=t(9576);let i=t(39566).y0.map(e=>e.value);function s(e,a){let t={dataType:e.dataType,name:e.name,label:e.label,defaults:{...e.defaults},children:e.children||[]},d={dataType:a.dataType,name:a.name,label:a.label,defaults:{...a.defaults},children:a.children||[]};return JSON.stringify(t)===JSON.stringify(d)}function r({screens:e,diagnoses:a,drugsLibrary:t}){let s=[];return e.forEach(e=>{let a=e.key,t=e.label,d=e.type;i.filter(e=>!e.includes("edliz")).includes(d)&&(t=t||e.title,a=a||t);let r=[];e.items.forEach(a=>{let t={uuid:"",label:a.label,name:a.key||a.id,dataType:`${e.type}_option`,children:[],defaults:{}};e.type.includes("edliz")?s.push(t):r.push(t)}),e.fields.forEach(e=>{let a=(()=>{switch(e.type){case"multi_select":case"dropdown":return(e.items||[]).map(a=>({uuid:"",label:a.label,name:a.value,dataType:`${e.type}_option`,children:[],defaults:{}}));default:return[]}})();s.push({label:e.label,name:e.key,dataType:e.type,children:a,defaults:{}})});let n={name:a,label:t,dataType:d,children:r,defaults:{}};s.push(n)}),a.forEach(e=>{e.key&&s.push({name:e.key,label:e.name,dataType:"diagnosis",children:[],defaults:{}})}),t.forEach(e=>{e.key&&s.push({name:e.key,label:e.drug,dataType:e.type,children:[],defaults:{}})}),s=(s=s.filter(e=>e.name&&e.label)).filter((e,a)=>s.map(e=>JSON.stringify(e)).indexOf(JSON.stringify(e))===a).map(e=>({...e,children:e.children.map(e=>({...e,uuid:(0,d.Z)()}))}))}}};