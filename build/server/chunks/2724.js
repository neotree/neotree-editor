"use strict";exports.id=2724,exports.ids=[2724],exports.modules={22724:(e,a,t)=>{t.d(a,{F$:()=>q,pG:()=>v,T7:()=>Z,Hc:()=>$,MM:()=>I,Jv:()=>D,gy:()=>w});var i=t(57745),s=t(9576),d=t(57435),r=t(10413),n=t(93567),u=t(88317),l=t(16916),y=t(34149),o=t(21162),c=t(45241);function f(e,a){if(a<=0)return[e];let t=[];for(let i=0;i<e.length;i+=a)t.push(e.slice(i,i+a));return t}function K(e,a){if(!a.length)return;let t=a.map(a=>(0,y.i6)`${e}::text ILIKE ${a}`);return 1===t.length?t[0]:(0,i.or)(...t)}function p(e,a){return`${`${a||""}`.trim()}::${e.trim()}`}function g(e){return e.replace(/[\\%_]/g,"\\$&")}async function m(e,a,t){let i=Math.max(1,Math.min(a,e.length||1)),s=0;async function d(){for(;s<e.length;){let a=e[s];s++,await t(a)}}await Promise.all(Array.from({length:i}).map(()=>d()))}async function h({dataKeys:e,dryRun:a=!1,previousDataKeys:t=[],broadcastAction:s,userId:l}){try{let d={candidateScripts:0,fetchedScreens:0,fetchedDiagnoses:0,updatedScreens:0,updatedDiagnoses:0,savedScreens:0,savedDiagnoses:0,chunkRetries:0,matchedByUniqueKey:0,matchedByLegacyName:0,matchedByLegacyLabel:0,ambiguousLegacySkips:0},h=new Map;e.forEach(e=>{e.uniqueKey&&h.set(e.uniqueKey,e)});let I=Array.from(h.keys()),D=new Map,w=new Map,q=new Set,v=new Set,k=new Set,b=new Set;t.forEach(e=>{if(!e.uniqueKey)return;let a=h.get(e.uniqueKey);if(!a)return;let t=`${e.name||""}`.trim(),i=`${e.label||""}`.trim();if(t&&t!==a.name){k.add(t);let i=p(t,e.dataType),s=D.get(i);s&&s!==a.uniqueKey&&q.add(i),D.set(i,a.uniqueKey)}if(i&&i!==a.label){b.add(i);let t=p(i,e.dataType),s=w.get(t);s&&s!==a.uniqueKey&&v.add(t),w.set(t,a.uniqueKey)}});let $=({uniqueKey:e,key:a,label:t,dataType:i})=>{if(e){let a=h.get(e);if(a)return{dataKey:a,source:"uniqueKey"}}let s=`${a||""}`.trim(),r=`${t||""}`.trim();if(s){let e=p(s,i);if(q.has(e))d.ambiguousLegacySkips++;else{let a=D.get(e);if(a){let e=h.get(a);if(e)return{dataKey:e,source:"legacyName"}}}}if(r){let e=p(r,i);if(v.has(e))d.ambiguousLegacySkips++;else{let a=w.get(e);if(a){let e=h.get(a);if(e)return{dataKey:e,source:"legacyLabel"}}}}return{}},Z=e=>{"uniqueKey"===e&&d.matchedByUniqueKey++,"legacyName"===e&&d.matchedByLegacyName++,"legacyLabel"===e&&d.matchedByLegacyLabel++},S=Array.from(k),T=Array.from(b),_=I.filter(Boolean).slice(0,120).flatMap(e=>{let a=g(e);return[`%"keyId":"${a}"%`,`%"keyId": "${a}"%`,`%"keyId"%"${a}"%`]}),R=S.filter(Boolean).slice(0,80).flatMap(e=>{let a=g(e);return[`%"key":"${a}"%`,`%"key": "${a}"%`,`%"key"%"${a}"%`,`%"id":"${a}"%`,`%"id": "${a}"%`,`%"id"%"${a}"%`,`%"value":"${a}"%`,`%"value": "${a}"%`,`%"value"%"${a}"%`,`%"refKey":"${a}"%`,`%"refKey": "${a}"%`,`%"refKey"%"${a}"%`]}),B=T.filter(Boolean).slice(0,80).flatMap(e=>{let a=g(e);return[`%"label":"${a}"%`,`%"label": "${a}"%`,`%"label"%"${a}"%`,`%"name":"${a}"%`,`%"name": "${a}"%`,`%"name"%"${a}"%`]}),x=Array.from(new Set([..._,...R,...B])).slice(0,240),A=new Set;(I.length||k.size||b.size||x.length)&&((await r.Z.select({scriptId:n.screens.scriptId}).from(n.screens).where((0,i.xD)((0,i.Ft)(n.screens.deletedAt),(0,i.or)(I.length?(0,i.d3)(n.screens.keyId,I):void 0,I.length?(0,i.d3)(n.screens.refIdDataKey,I):void 0,S.length?(0,i.d3)(n.screens.key,S):void 0,T.length?(0,i.d3)(n.screens.label,T):void 0,S.length?(0,i.d3)(n.screens.refId,S):void 0,K((0,y.i6)`${n.screens.fields}`,x),K((0,y.i6)`${n.screens.items}`,x))))).forEach(e=>{e.scriptId&&A.add(e.scriptId)}),(await r.Z.select({scriptId:n.diagnoses.scriptId}).from(n.diagnoses).where((0,i.xD)((0,i.Ft)(n.diagnoses.deletedAt),(0,i.or)(I.length?(0,i.d3)(n.diagnoses.keyId,I):void 0,S.length?(0,i.d3)(n.diagnoses.key,S):void 0,T.length?(0,i.d3)(n.diagnoses.name,T):void 0,K((0,y.i6)`${n.diagnoses.symptoms}`,x))))).forEach(e=>{e.scriptId&&A.add(e.scriptId)}),x.length&&((await r.Z.select({scriptId:n.screensDrafts.scriptId,scriptDraftId:n.screensDrafts.scriptDraftId}).from(n.screensDrafts).where(K((0,y.i6)`${n.screensDrafts.data}`,x))).forEach(e=>{e.scriptId&&A.add(e.scriptId),e.scriptDraftId&&A.add(e.scriptDraftId)}),(await r.Z.select({scriptId:n.diagnosesDrafts.scriptId,scriptDraftId:n.diagnosesDrafts.scriptDraftId}).from(n.diagnosesDrafts).where(K((0,y.i6)`${n.diagnosesDrafts.data}`,x))).forEach(e=>{e.scriptId&&A.add(e.scriptId),e.scriptDraftId&&A.add(e.scriptDraftId)}))),d.candidateScripts=A.size;let L=!A.size&&(I.length>0||S.length>0||T.length>0),E=a||L;if(!A.size&&!E)return{success:!0,info:d,affected:{scripts:[],screens:[],diagnoses:[]}};let M=E?void 0:Array.from(A),{data:O,errors:U}=await (0,o.uK)(M?.length?{scriptsIds:M}:void 0),{data:N,errors:J}=await (0,o.XA)(M?.length?{scriptsIds:M}:void 0),V=[...U||[],...J||[]];if(V.length)return{success:!1,errors:V,info:d};d.fetchedScreens=O.length,d.fetchedDiagnoses=N.length;let F=O.map(e=>{let{dataKey:a,source:t}=$({uniqueKey:e.refIdDataKey||e.refId,key:e.refId});Z(t);let{dataKey:i,source:s}=$({uniqueKey:e.keyId,key:e.key,label:e.label,dataType:e.type||void 0});Z(s);let d=!!i||!!a,r=(e.items||[]).map(a=>{let{dataKey:t,source:i}=$({uniqueKey:a.keyId,key:a.key||a.id,label:a.label,dataType:"diagnosis"===e.type?"diagnosis":"option"});return Z(i),t&&(d=!0),{...a,...t?{keyId:t.uniqueKey,label:t.label,...`${a.key||""}`.length?{key:t.name}:{},...`${a.id||""}`.length?{id:t.name}:{}}:{}}}),n=(e.fields||[]).map(e=>{let{dataKey:a,source:t}=$({uniqueKey:e.keyId,key:e.key,label:e.label,dataType:e.type||void 0});Z(t);let{dataKey:i,source:s}=$({uniqueKey:e.refKeyId,key:e.refKey});Z(s);let{dataKey:r,source:n}=$({uniqueKey:e.minDateKeyId,key:e.minDateKey});Z(n);let{dataKey:u,source:l}=$({uniqueKey:e.maxDateKeyId,key:e.maxDateKey});Z(l);let{dataKey:y,source:o}=$({uniqueKey:e.minTimeKeyId,key:e.minTimeKey});Z(o);let{dataKey:c,source:f}=$({uniqueKey:e.maxTimeKeyId,key:e.maxTimeKey});return Z(f),(a||i||r||u||y||c)&&(d=!0),{...e,...a?{keyId:a.uniqueKey,key:a.name,label:a.label}:{},...i?{refKeyId:i.uniqueKey,refKey:i.name}:{},...r?{minDateKeyId:r.uniqueKey,minDateKey:r.name}:{},...u?{maxDateKeyId:u.uniqueKey,maxDateKey:u.name}:{},...y?{minTimeKeyId:y.uniqueKey,minTimeKey:y.name}:{},...c?{maxTimeKeyId:c.uniqueKey,maxTimeKey:c.name}:{},items:(e.items||[]).map(e=>{let{dataKey:a,source:t}=$({uniqueKey:e.keyId,key:`${e.value||""}`,label:`${e.label||""}`,dataType:"option"});return Z(t),a&&(d=!0),{...e,...a?{keyId:a.uniqueKey,value:a.name,label:a.label}:{}}})}});return{...e,updated:d,items:r,fields:n,...i?{keyId:i.uniqueKey,key:i.name,label:i.label}:{},...a?{refId:a.name,refIdDataKey:a.uniqueKey}:{}}}).filter(e=>!!e.updated).map(({updated:e,...a})=>a),P=N.map(e=>{let a=e.key||e.name||"",{dataKey:t,source:i}=$({uniqueKey:e.keyId,key:e.key,label:e.name,dataType:"diagnosis"});Z(i);let s=!!t,d=(e.symptoms||[]).map(e=>{let{dataKey:a,source:t}=$({uniqueKey:e.keyId,key:e.key,label:e.name,dataType:`diagnosis_symptom_${e.type}`});return Z(t),a&&(s=!0),{...e,...a?{keyId:a.uniqueKey,key:a.name,name:a.label}:{}}});return{...e,key:a,symptoms:d,updated:s,...t?{keyId:t.uniqueKey,key:t.name,name:t.label}:{}}}).filter(e=>!!e.updated).map(({updated:e,...a})=>a);d.updatedScreens=F.length,d.updatedDiagnoses=P.length;let W=F.map(e=>({id:e.screenId,scriptId:e.scriptId,scriptTitle:e.scriptTitle||void 0,title:e.title||e.label||e.refId||e.screenId,type:"screen"})),C=P.map(e=>({id:e.diagnosisId,scriptId:e.scriptId,scriptTitle:e.scriptTitle||void 0,title:e.name||e.key||e.diagnosisId,type:"diagnosis"})),X={};[...W,...C].forEach(e=>{e.scriptId&&!X[e.scriptId]&&(X[e.scriptId]={scriptId:e.scriptId,scriptTitle:e.scriptTitle})});let z={scripts:Object.values(X),screens:W,diagnoses:C};if(a)return{success:!0,info:d,affected:z};let Q=[],j=async()=>{for(let e of f(P,50)){let a=await (0,c.Pk)({data:e,userId:l});a.errors?.length?(d.chunkRetries++,await m(e,5,async e=>{let a=await (0,c.Pk)({data:[e],userId:l});a.errors?.length?Q.push(...a.errors.map(a=>`[diagnosis:${e.diagnosisId}] ${a}`)):d.savedDiagnoses++})):d.savedDiagnoses+=e.length}},H=async()=>{for(let e of f(F,50)){let a=await (0,c.uD)({data:e,userId:l});a.errors?.length?(d.chunkRetries++,await m(e,5,async e=>{let a=await (0,c.uD)({data:[e],userId:l});a.errors?.length?Q.push(...a.errors.map(a=>`[screen:${e.screenId}] ${a}`)):d.savedScreens++})):d.savedScreens+=e.length}};if(await Promise.all([j(),H()]),Q.length)return{success:!1,errors:Q,info:d,affected:z};let G=d.savedDiagnoses+d.savedScreens;return s&&G&&u.Z.emit("data_changed","save_scripts"),{success:!0,info:d,affected:z}}catch(e){return d.Z.error("_updateDataKeysRefs ERROR",e.message),{success:!1,errors:[e.message]}}}async function I({data:e,broadcastAction:a,updateRefs:t=!0,userId:y}){let o={success:!1};try{let d=[],c=e.map(e=>({...e,uuid:e.uuid||s.Z(),isNewUuid:!e.uuid})),f=[],K=[];for(let{uuid:e,isNewUuid:a,createdAt:t,publishDate:u,deletedAt:l,updatedAt:o,...p}of c)try{if(p.name=`${p.name||""}`.trim(),p.label=`${p.label||""}`.trim(),!d.length){let t=a?null:await r.Z.query.dataKeysDrafts.findFirst({where:(0,i.or)((0,i.eq)(n.dataKeysDrafts.uuid,e),p.uniqueKey?(0,i.eq)(n.dataKeysDrafts.uniqueKey,p.uniqueKey):void 0)}),d=t||a?null:await r.Z.query.dataKeys.findFirst({where:(0,i.or)((0,i.eq)(n.dataKeys.uuid,e),p.uniqueKey?(0,i.eq)(n.dataKeys.uniqueKey,p.uniqueKey):void 0)});if(t){let a={...t.data,...p};a.uniqueKey&&K.push({uniqueKey:a.uniqueKey,name:t.data?.name,label:t.data?.label,dataType:t.data?.dataType||void 0}),await r.Z.update(n.dataKeysDrafts).set({data:a,name:a.name,uniqueKey:a.uniqueKey}).where((0,i.eq)(n.dataKeysDrafts.uuid,e)),a.uniqueKey&&f.push(a.uniqueKey)}else{let a=d?.uniqueKey||p.uniqueKey||s.Z(),t={...d,...p,uniqueKey:a,uuid:e,version:d?.version?d.version+1:1};K.push({uniqueKey:t.uniqueKey,name:d?.name,label:d?.label,dataType:d?.dataType||void 0}),await r.Z.insert(n.dataKeysDrafts).values({data:t,uuid:e,dataKeyId:d?.uuid,name:t.name,uniqueKey:a,createdByUserId:y}),f.push(t.uniqueKey)}}}catch(e){d.push(e.message)}if(d.length)o.errors=d;else{if(t&&f.length){let{data:e}=await (0,l.aW)({uniqueKeys:f}),t=await h({dataKeys:e,previousDataKeys:K,broadcastAction:a,userId:y});if(t.errors?.length||!t.success)return o.success=!1,o.errors=t.errors?.length?t.errors:["Failed to update related scripts references"],o;o.info={...o.info,refs:{info:t.info,affected:t.affected}}}u.Z.emit("data_changed","save_data_keys"),o.success=!0}return o}catch(e){return o.success=!1,o.errors=[e.message],d.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function D({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,l.aW)({uniqueKeys:a});return e=e.filter(e=>!t.data.find(a=>a.uniqueKey===e.uniqueKey)),await I({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function w({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,l.aW)({uniqueKeys:a});return await I({data:e.map(e=>{let a=t.data.find(a=>a.uniqueKey===e.uniqueKey);return console.log("existing?.uuid",a?.uuid),{...e,uuid:a?.uuid,id:a?.id,createdAt:a?.createdAt,updatedAt:a?.updatedAt,publishDate:a?.publishDate,deletedAt:a?.deletedAt,version:a?.version}})})}catch(e){return{success:!1,errors:[e.message]}}}async function q(e){try{return await r.Z.delete(n.dataKeysDrafts).where(e?.userId?(0,i.eq)(n.dataKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function v({dataKeysIds:e,broadcastAction:a,userId:t}){let s={success:!1};try{if(e.length){await r.Z.delete(n.dataKeysDrafts).where((0,i.d3)(n.dataKeysDrafts.uuid,e));let a=(await r.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,i.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,i.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:t}));a.length&&await r.Z.insert(n.pendingDeletion).values(a)}s.success=!0}catch(e){s.success=!1,s.errors=[e.message],d.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!s?.errors?.length&&a&&u.Z.emit("data_changed","delete_data_keys"),s}}async function k({previous:e,drafts:a,userId:t}){let i=[];try{let s=[];for(let d of a){let a=d?.data?.uuid;if(!a)continue;let r=1===(d?.data?.version||1),n=r?"Create data key":"Update data key",u={action:r?"create_data_key":"update_data_key",description:n,oldValues:[],newValues:[]},l=d?.data?.version||1,y={version:l,dataKeyId:a,changes:u};if(!r){let t=e.find(e=>e.uuid===a);Object.keys({...d?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=d.data[e],i={...t}[e];JSON.stringify(a)!==JSON.stringify(i)&&(u.oldValues.push({[e]:i}),u.newValues.push({[e]:a}))})}if(s.push(y),t){let s=JSON.parse(JSON.stringify(d.data||{})),y=r?{}:JSON.parse(JSON.stringify(e.find(e=>e.uuid===a)||{}));i.push({entityId:a,entityType:"data_key",action:r?"create":"update",version:l,changes:u,fullSnapshot:s,previousSnapshot:y,baselineSnapshot:y,description:n,userId:t,dataKeyId:a})}}s.length&&await r.Z.insert(n.dataKeysHistory).values(s)}catch(e){d.Z.error(e.message)}return i}var b=t(36864);async function $(e){let a={success:!1},t=[];try{let u=await r.Z.query.pendingDeletion.findMany({where:(0,i.xD)((0,i.K0)(n.pendingDeletion.dataKeyId),e?.userId?(0,i.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0),columns:{dataKeyId:!0},with:{dataKey:!0}});if((u=u.filter(e=>e.dataKey)).length){let a=new Date;await r.Z.update(n.dataKeys).set({deletedAt:a}).where((0,i.d3)(n.dataKeys.uuid,u.map(e=>e.dataKeyId)));let s=u.map(e=>({version:(e.dataKey?.version??0)+1,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:a}]}}));if(await r.Z.insert(n.dataKeysHistory).values(s),e?.publisherUserId)for(let i=0;i<u.length;i++){let d=u[i],r=s[i];if(!d?.dataKeyId)continue;let n={...d.dataKey??{},deletedAt:a},l=r.version||(d.dataKey?.version??0)+1;t.push({entityId:d.dataKeyId,entityType:"data_key",action:"delete",version:l,dataVersion:e.dataVersion,changes:r.changes,fullSnapshot:JSON.parse(JSON.stringify(n)),description:r.changes.description,userId:e.publisherUserId,dataKeyId:d.dataKeyId,isActive:!1})}}await r.Z.delete(n.pendingDeletion).where((0,i.xD)((0,i.or)((0,i.K0)(n.pendingDeletion.dataKeyId),(0,i.K0)(n.pendingDeletion.dataKeyDraftId)),e?.userId?(0,i.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0));let l=[],o=[],c=await r.Z.query.dataKeysDrafts.findMany({where:e?.userId?(0,i.eq)(n.dataKeysDrafts.createdByUserId,e?.userId):void 0});if(l=c.filter(e=>e.dataKeyId),o=c.filter(e=>!e.dataKeyId),l.length){let a=[];for(let{dataKeyId:e,data:t}of(l.filter(e=>e.dataKeyId).length&&(a=await r.Z.query.dataKeys.findMany({where:(0,i.d3)(n.dataKeys.uuid,l.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),l)){let{uuid:a,id:s,createdAt:d,updatedAt:u,deletedAt:l,...y}=t,o={...y,publishDate:new Date};await r.Z.update(n.dataKeys).set(o).where((0,i.eq)(n.dataKeys.uuid,e)).returning()}let s=await k({drafts:l,previous:a,userId:e?.publisherUserId});t.push(...s.map(a=>({...a,dataVersion:e?.dataVersion})))}if(o.length){let a=[];for(let{id:e,data:t}of(o.filter(e=>e.dataKeyId).length&&(a=await r.Z.query.dataKeys.findMany({where:(0,i.d3)(n.dataKeys.uuid,o.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),o)){let a=t.uuid||(0,s.Z)(),{id:i,...d}={...t,uuid:a};o=o.map(t=>(t.id===e&&(t.data.uuid=a),t)),await r.Z.insert(n.dataKeys).values(d)}let d=await k({drafts:o,previous:a,userId:e?.publisherUserId});t.push(...d.map(a=>({...a,dataVersion:e?.dataVersion})))}await r.Z.delete(n.dataKeysDrafts).where(e?.userId?(0,i.eq)(n.dataKeysDrafts.createdByUserId,e.userId):void 0);let f=[...l.map(e=>e.dataKeyId),...u.map(e=>e.dataKeyId)];if(f.length&&await r.Z.update(n.dataKeys).set({version:(0,y.i6)`${n.dataKeys.version} + 1`}).where((0,i.d3)(n.dataKeys.uuid,f)),t.length){let e=await (0,b.F)({data:t,allowPartial:!0});e.errors?.length&&d.Z.error("_publishDataKeys changelog warnings",e.errors.join(", "))}a.success=!0}catch(e){a.success=!1,a.errors=[e.message],d.Z.error("_publishDataKeys ERROR",e)}finally{return a}}async function Z({data:e}){try{let a=e.map(e=>e.uuid||"").filter(Boolean),t=e.map(e=>e.uniqueKey||"").filter(Boolean),i=await (0,l.aW)({dataKeysIds:a,returnDraftsIfExist:!0}),s=await (0,l.aW)({uniqueKeys:t,returnDraftsIfExist:!0}),d={};[...i.data,...s.data].forEach(e=>{e.uuid&&(d[e.uuid]=e),e.uniqueKey&&(d[e.uniqueKey]=e)});let r=[],n=[];if(e.forEach(e=>{let a=(e.uuid?d[e.uuid]:void 0)||(e.uniqueKey?d[e.uniqueKey]:void 0);a?.uniqueKey&&(r.push({uniqueKey:a.uniqueKey,name:a.name,label:a.label,dataType:a.dataType}),n.push({...a,...e,uniqueKey:a.uniqueKey}))}),!n.length)return{success:!0,info:{candidateScripts:0,fetchedScreens:0,fetchedDiagnoses:0,updatedScreens:0,updatedDiagnoses:0,savedScreens:0,savedDiagnoses:0,chunkRetries:0,matchedByUniqueKey:0,matchedByLegacyName:0,matchedByLegacyLabel:0,ambiguousLegacySkips:0},affected:{scripts:[],screens:[],diagnoses:[]}};return await h({dataKeys:n,previousDataKeys:r,dryRun:!0})}catch(e){return{success:!1,errors:[e.message]}}}},16916:(e,a,t)=>{t.d(a,{gc:()=>f,aW:()=>y});var i=t(57745),s=t(34149),d=t(30900),r=t(9576),n=t(10413),u=t(93567),l=t(57435);async function y(e){try{let{keys:a=[],dataKeysIds:t,names:l=[],uniqueKeys:y=[],returnDraftsIfExist:o=!0,pagination:c}={...e},f=t||[],K=l.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),p=y.filter(e=>e),g=[];if(a.length)g=(g=(g=await n.Z.query.dataKeysDrafts.findMany()).filter(e=>!f.length||f.includes(e.uuid)).filter(e=>!K.length||K.includes(e.name)).filter(e=>!p.length||p.includes(e.uniqueKey))).filter(e=>a.map(e=>JSON.stringify({name:e.name,label:e.label,dataType:e.dataType}).toLowerCase()).includes(JSON.stringify({name:e.data.name,label:e.data.label,dataType:e.data.dataType}).toLowerCase()));else{let e=[f?.length?(0,i.d3)(u.dataKeysDrafts.uuid,f.map(e=>d.Z(e)?e:r.Z())):void 0,K?.length?(0,i.d3)((0,s.i6)`lower(${u.dataKeysDrafts.name})`,K):void 0,p?.length?(0,i.d3)(u.dataKeysDrafts.uniqueKey,p):void 0].filter(e=>e);g=o?await n.Z.query.dataKeysDrafts.findMany({where:e.length?(0,i.xD)(...e):void 0}):[]}f=f.filter(e=>!g.map(e=>e.uuid).includes(e));let m=[(0,i.Ft)(u.dataKeys.deletedAt),(0,i.Ft)(u.pendingDeletion),g.length?(0,i.Nl)(u.dataKeys.uuid,g.map(e=>e.uuid)):void 0,a.length?(0,i.d3)((0,s.i6)`lower(concat(${u.dataKeys.name},',',${u.dataKeys.label},',',${u.dataKeys.dataType}))`,a.map(e=>`${e.name},${e.label},${e.dataType}`.toLowerCase())):void 0,f?.length?(0,i.d3)(u.dataKeys.uuid,f.filter(e=>d.Z(e))):void 0,K?.length?(0,i.d3)((0,s.i6)`lower(${u.dataKeys.name})`,K):void 0,p?.length?(0,i.d3)(u.dataKeys.uniqueKey,p):void 0].filter(e=>e),h=(await n.Z.select({dataKey:u.dataKeys,pendingDeletion:u.pendingDeletion}).from(u.dataKeys).leftJoin(u.pendingDeletion,(0,i.eq)(u.pendingDeletion.dataKeyId,u.dataKeys.uuid)).where(m.length?(0,i.xD)(...m):void 0)).map(e=>e.dataKey),I=h.length?await n.Z.query.pendingDeletion.findMany({where:(0,i.d3)(u.pendingDeletion.dataKeyId,h.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[],D=[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!I.map(e=>e.dataKeyId).includes(e.uuid));if(c){let{limit:e,page:a}=c,t=function(e,a,t){let i=e.length,s=(a-1)*t;return{data:e.slice(s,s+t),pagination:{page:a,limit:t,total:i,totalPages:Math.ceil(i/t)}}}(D,a,e);return{data:t.data,pagination:t.pagination}}return{data:D}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var o=t(60938);let c={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function f(){try{let[{count:e}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts),[{count:a}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts).where((0,i.Ft)(u.dataKeysDrafts.dataKeyId)),[{count:t}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeysDrafts).where((0,i.K0)(u.dataKeysDrafts.dataKeyId)),[{count:s}]=await n.Z.select({count:(0,o.QX)()}).from(u.pendingDeletion).where((0,i.K0)(u.pendingDeletion.dataKeyId)),[{count:d}]=await n.Z.select({count:(0,o.QX)()}).from(u.dataKeys);return{data:{allPublished:d,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:s}}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:c,errors:[e.message]}}}}};