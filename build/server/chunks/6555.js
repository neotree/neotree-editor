exports.id=6555,exports.ids=[6555],exports.modules={58359:()=>{},93739:()=>{},54491:(e,s,t)=>{"use strict";t.d(s,{hf:()=>I,uW:()=>y});var r=t(57368),i=t(10413),a=t(57745),n=t(81445),d=t(88728),o=t(57435);function c(e){if(!e||""===e)return"A";let s=e.match(/^([A-Z]+)(\d*)$/);if(!s)throw Error("Invalid alias format");let[t,r,i]=s,a=i?parseInt(i,10):0,n=(e=>{let s="";do s=String.fromCharCode(e%26+65)+s,e=Math.floor(e/26)-1;while(e>=0);return s})(r.split("").reduce((e,s)=>26*e+(s.charCodeAt(0)-65),0)+1);return n.length>r.length?(n="A")+(a+1):n+(i||"")}async function l(e,s,t,r){let i=[],a=t;for(let t of s)if(!["management","mwi_edliz_summary_table","progress","zw_edliz_summary_table","diagnosis","drugs","fluids","feeds"].includes(t.type)){if("form"===t.type&&Array.isArray(t.fields))for(let s of t.fields)Array.isArray(s.prePopulate)&&s.prePopulate.length>0&&!await p({name:s.key,script:e})&&(a=c(a))&&i.push({name:s.key,alias:a,script:e,oldScript:r});else Array.isArray(t.prePopulate)&&t.prePopulate.length>0&&!await p({name:t.key,script:e})&&(a=c(a))&&i.push({name:t.key,alias:a,script:e,oldScript:r})}return i}async function p(e){return!!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,e.script),(0,a.eq)(d.aliases.name,e.name))})}async function u(){return!!await i.Z.query.aliases.findFirst()}async function f(e){let s={success:!1},t=[],r={};try{for(let s of e)try{if(!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,s.script),(0,a.eq)(d.aliases.name,s.name)),orderBy:(0,n.C)(d.aliases.createdAt)})){let e=i.Z.insert(d.aliases).values({alias:s.alias,name:s.name,script:s.script,oldScript:s.oldScript});r.query=e.toSQL(),await e.execute()}}catch(e){o.Z.error(e.message),t.push(e.message)}t.length?(s.errors=t,s.info=r):s.success=!0}catch(e){s.success=!1,s.errors=[e.message],s.info=r}}async function g(e){try{let s=e?await i.Z.query.aliases.findFirst({where:(0,a.eq)(d.aliases.script,e),orderBy:(0,n.C)(d.aliases.createdAt)}):"";return s?s.alias:""}catch(e){}}async function I(){try{let e=await (0,r.eh)();await u()||await y(e)}catch(e){}}async function y(e){try{for(let s of e)if(s){let e=await (0,r.A0)(s),t=await g(s),i=[s],{data:a,errors:n}=await (0,r.uK)({scriptsIds:i});if(!n||0===n.length){let r=await l(s,a,t||"",e?.[0]??null);r&&r.length>0&&await f(r)}}}catch(e){o.Z.error("Error in _generateScreenAliases:",e)}}},22418:(e,s,t)=>{"use strict";t.d(s,{U5:()=>y,Ms:()=>m,Nq:()=>v,hA:()=>b,E8:()=>g,$s:()=>D,cj:()=>h,Lr:()=>w});var r=t(60938),i=t(57745),a=t(81445),n=t(9576),d=t(57435),o=t(10413),c=t(88728),l=t(88317),p=t(30834),u=t(10970),f=t(57368);async function g({keys:e,userId:s}){try{let t=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),r=[];return t.data.forEach(s=>{let t=s.drugs.filter(s=>!e.includes(s.key)),i=s.fluids.filter(s=>!e.includes(s.key)),a=s.feeds.filter(s=>!e.includes(s.key));t.length!==s.drugs.length&&r.push({...s,drugs:t}),i.length!==s.fluids.length&&r.push({...s,fluids:i}),a.length!==s.feeds.length&&r.push({...s,feeds:a})}),r.length&&await (0,u.uD)({data:r,userId:s}),{data:{success:!0}}}catch(e){return{errors:[e.message],data:{success:!1}}}}let I=async(e,s=1,t="")=>{let[{count:a}]=await o.Z.select({count:(0,r.QX)()}).from(c.drugsLibraryDrafts).where((0,i.eq)(c.drugsLibraryDrafts.key,e)),[{count:n}]=await o.Z.select({count:(0,r.QX)()}).from(c.drugsLibrary).where((0,i.eq)(c.drugsLibrary.key,e));return n||a?await I(`${t||e}-${s+1}`,s+1,t||e):e};async function y({data:e,...s}){try{let{data:t}=await (0,p.fP)({itemsIds:e.map(e=>e.itemId)}),r=[];for(let e of t){let s=await I(e.key);r.push({...e,key:s,itemId:n.Z(),position:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0})}return await D({data:r,...s})}catch(e){return d.Z.error("_copyDrugsLibraryItems ERROR",e.message),{success:!1,errors:[e.message]}}}async function h({data:e,...s}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let r=await (0,p.fP)({keys:t});if((e=e.filter(e=>!r.data.map(e=>e.key).includes(e.key)).map(e=>({...e,itemId:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0,position:void 0,version:void 0}))).length)return await D({data:e,...s})}return{success:!0}}catch(e){return d.Z.error("_saveDrugsLibraryItemsIfKeysNotExist ERROR",e.message),{errors:[e.message],success:!1}}}async function w({data:e,...s}){try{let t=e.map(e=>e.key).filter(e=>e);if(t.length){let r=await (0,p.fP)({keys:t});if((e=e.map(e=>{let s=r.data.find(s=>`${s.key}`.toLowerCase()===`${e.key}`.toLowerCase());return{...e,itemId:s?.itemId||e.itemId,createdAt:s?.createdAt||e.createdAt,updatedAt:s?.updatedAt||e.updatedAt,deletedAt:s?.deletedAt||e.deletedAt,publishDate:s?.publishDate||e.publishDate,id:s?.id||e.id,position:s?.position||e.position,version:s?.version||e.version}})).length)return await D({data:e,...s})}return{success:!0}}catch(e){return d.Z.error("_saveDrugsLibraryItemsAndUpdateIfExists ERROR",e.message),{errors:[e.message],success:!1}}}async function D({data:e,broadcastAction:s,userId:t}){let r={success:!1};try{let s=[],d=[],l=[];for(let{itemId:r,...p}of e)try{let e=r||n.Z(),u="",f=p.key||"",g=null,I=p.type||null;if(!s.length){let s=r?await o.Z.query.drugsLibraryDrafts.findFirst({where:(0,i.eq)(c.drugsLibraryDrafts.itemDraftId,e)}):null,n=s||!r?null:await o.Z.query.drugsLibrary.findFirst({where:(0,i.eq)(c.drugsLibrary.itemId,e)});if(s){u=s.data.key,g=s.data.type||null;let t={...s.data,...p};await o.Z.update(c.drugsLibraryDrafts).set({data:t,position:t.position}).where((0,i.eq)(c.drugsLibraryDrafts.itemDraftId,e))}else{u=n?.key||"",g=n?.type||null;let s=p.position||n?.position;if(!s){let e=await o.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,a.C)(c.drugsLibrary.position)}),t=await o.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,a.C)(c.drugsLibraryDrafts.position)});s=Math.max(0,e?.position||0,t?.position||0)+1}let r={...n,...p,itemId:e,version:n?.version?n.version+1:1,position:s};await o.Z.insert(c.drugsLibraryDrafts).values({data:r,itemDraftId:e,position:r.position,itemId:n?.itemId,key:r.key,type:r.type,createdByUserId:t})}u&&f&&u!==f&&d.push({old:u,new:f}),g&&I&&g!==I&&u&&l.push(u)}}catch(e){s.push(e.message)}if(l.length&&await g({keys:l,userId:t}),d.length){let e=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),s=[];e.data.forEach(e=>{let t=!1,r=e.drugs.map(e=>{if(d.map(e=>e.old).includes(e.key)){let s=d.filter(s=>s.old===e.key).map(e=>e.new)[0];e={...e,key:s},t=!0}return e}),i=e.fluids.map(e=>{if(d.map(e=>e.old).includes(e.key)){let s=d.filter(s=>s.old===e.key).map(e=>e.new)[0];e={...e,key:s},t=!0}return e}),a=e.feeds.map(e=>{if(d.map(e=>e.old).includes(e.key)){let s=d.filter(s=>s.old===e.key).map(e=>e.new)[0];e={...e,key:s},t=!0}return e});t&&s.push({...e,drugs:r,fluids:i,feeds:a})}),s.length&&await (0,u.uD)({data:s,userId:t})}s.length?r.errors=s:r.success=!0}catch(e){r.success=!1,r.errors=[e.message],d.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&s&&l.Z.emit("data_changed","save_drugs_library_items"),r}}async function m(e){try{return await o.Z.delete(c.drugsLibraryDrafts).where(e?.userId?(0,i.eq)(c.drugsLibraryDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function v({itemsIds:e,broadcastAction:s,userId:t}){let r={success:!1};try{let s=e||[];if(s.length){let e=await (0,p.fP)({itemsIds:s,returnDraftsIfExist:!0});await o.Z.delete(c.drugsLibraryDrafts).where((0,i.d3)(c.drugsLibraryDrafts.itemDraftId,s));let r=e.data.filter(e=>!e.isDraft).map(e=>({drugsLibraryItemId:e.itemId,createdByUserId:t}));r.length&&await o.Z.insert(c.pendingDeletion).values(r),await g({keys:e.data.map(e=>e.key),userId:t})}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],d.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&s&&l.Z.emit("data_changed","delete_drugs_library_items"),r}}async function Z({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,itemId:r?.data?.itemId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_drugs_library_item",description:"Create drugs library item",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.itemId===r?.data?.itemId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=r.data[e],n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:s}))}),s.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:i,newValues:a}}t.push(s)}await o.Z.insert(c.drugsLibraryHistory).values(t)}catch(e){d.Z.error(e.message)}}var q=t(34149);async function b(e){let s={success:!1};try{let t=await o.Z.query.pendingDeletion.findMany({where:(0,i.xD)((0,i.K0)(c.pendingDeletion.drugsLibraryItemId),e?.userId?(0,i.eq)(c.pendingDeletion.createdByUserId,e.userId):void 0),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0,key:!0}}}});if((t=t.filter(e=>e.drugsLibraryItem)).length){let e=new Date;await o.Z.update(c.drugsLibrary).set({deletedAt:e,key:(0,q.i6)`CONCAT(${c.drugsLibrary.key}, '_', ${c.drugsLibrary.itemId})`}).where((0,i.d3)(c.drugsLibrary.itemId,t.map(e=>e.drugsLibraryItemId))),await o.Z.insert(c.drugsLibraryHistory).values(t.map(s=>({version:s.drugsLibraryItem.version,itemId:s.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null,key:s.drugsLibraryItem.key}],newValues:[{deletedAt:e,key:`${s.drugsLibraryItem.key}_${s.drugsLibraryItemId}`}]}})))}await o.Z.delete(c.pendingDeletion).where((0,i.xD)((0,i.or)((0,i.K0)(c.pendingDeletion.drugsLibraryItemId),(0,i.K0)(c.pendingDeletion.drugsLibraryItemDraftId)),e?.userId?(0,i.eq)(c.pendingDeletion.createdByUserId,e.userId):void 0));let r=[],a=[],d=await o.Z.query.drugsLibraryDrafts.findMany({where:e?.userId?(0,i.eq)(c.drugsLibraryDrafts.createdByUserId,e?.userId):void 0});if(r=d.filter(e=>e.itemId),a=d.filter(e=>!e.itemId),r.length){let e=[];for(let{itemId:s,data:t}of(r.filter(e=>e.itemId).length&&(e=await o.Z.query.drugsLibrary.findMany({where:(0,i.d3)(c.drugsLibrary.itemId,r.filter(e=>e.itemId).map(e=>e.itemId))})),r)){let{itemId:e,id:r,createdAt:a,updatedAt:n,deletedAt:d,...l}=t,p={...l,publishDate:new Date};await o.Z.update(c.drugsLibrary).set(p).where((0,i.eq)(c.drugsLibrary.itemId,s)).returning()}await Z({drafts:r,previous:e})}if(a.length){let e=[];for(let{id:s,data:t}of(a.filter(e=>e.itemId).length&&(e=await o.Z.query.drugsLibrary.findMany({where:(0,i.d3)(c.drugsLibrary.itemId,a.filter(e=>e.itemId).map(e=>e.itemId))})),a)){let e=t.itemId||(0,n.Z)(),r={...t,itemId:e};a=a.map(t=>(t.id===s&&(t.data.itemId=e),t)),await o.Z.insert(c.drugsLibrary).values(r)}await Z({drafts:a,previous:e})}await o.Z.delete(c.drugsLibraryDrafts);let l=[...r.map(e=>e.itemId),...t.map(e=>e.drugsLibraryItemId)];l.length&&await o.Z.update(c.drugsLibrary).set({version:(0,q.i6)`${c.drugsLibrary.version} + 1`}).where((0,i.d3)(c.drugsLibrary.itemId,l)),s.success=!0}catch(e){s.success=!1,s.errors=[e.message],d.Z.error("_publishDrugsLibraryItems ERROR",e.message)}finally{return s}}},10970:(e,s,t)=>{"use strict";t.d(s,{cF:()=>g,In:()=>u,VQ:()=>y,Bx:()=>I,GH:()=>f,Es:()=>h,gv:()=>b,Ry:()=>Z,Ls:()=>L,Pk:()=>R,uD:()=>_,Or:()=>p});var r=t(57745),i=t(81445),a=t(9576),n=t(57435),d=t(10413),o=t(88728),c=t(88317);function l(e){if("string"==typeof e)return e.replace(/0x[0-9A-Fa-f]+/g,"");if(Array.isArray(e))return e.map(l);if("object"==typeof e&&null!==e){let s={};for(let t in e)e.hasOwnProperty(t)&&(s[t]=l(e[t]));return s}return e}async function p({data:e,broadcastAction:s,syncSilently:t,userId:p}){let u={success:!1},f=[],g={};e=l(e);try{for(let{scriptId:s,...t}of e)try{let e=s||a.Z();if(!f.length){let a=s?await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,e)}):null,n=a||!s?null:await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,e)});if(a){let s={...a.data,...t},i=d.Z.update(o.scriptsDrafts).set({data:s,position:s.position,hospitalId:s.hospitalId}).where((0,r.eq)(o.scriptsDrafts.scriptDraftId,e));g.query=i.toSQL(),await i.execute()}else{let s=t.position||n?.position;if(!s){let e=await d.Z.query.scripts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.scripts.position)}),t=await d.Z.query.scriptsDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.scriptsDrafts.position)});s=Math.max(0,e?.position||0,t?.position||0)+1}let r={...n,...t,scriptId:e,version:n?.version?n.version+1:1,position:s},a=d.Z.insert(o.scriptsDrafts).values({data:r,scriptDraftId:e,position:r.position,hospitalId:r.hospitalId,scriptId:n?.scriptId,createdByUserId:p});g.query=a.toSQL(),await a.execute()}}}catch(e){f.push(e.message)}f.length?(u.errors=f,u.info=g):u.success=!0}catch(e){u.success=!1,u.errors=[e.message],u.info=g,n.Z.error("_saveScripts ERROR",e.message)}finally{return u?.errors?.length||!s||t||c.Z.emit("data_changed","save_scripts"),u}}async function u(e){try{return await d.Z.delete(o.screensDrafts).where(e?.userId?(0,r.eq)(o.screensDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function f({screensIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:i,userId:a}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the screens, please confirm this action!");await d.Z.delete(o.screensDrafts).where((0,r.xD)(e.length?(0,r.d3)(o.screensDrafts.screenDraftId,e):void 0,s.length?(0,r.or)((0,r.d3)(o.screensDrafts.scriptId,s),(0,r.d3)(o.screensDrafts.scriptDraftId,s)):void 0));let i=(await d.Z.select({screenId:o.screens.screenId,screenScriptId:o.screens.scriptId,scriptDraftId:o.scriptsDrafts.scriptDraftId,pendingDeletion:o.pendingDeletion}).from(o.screens).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.screenId,o.screens.screenId)).leftJoin(o.scriptsDrafts,(0,r.eq)(o.scriptsDrafts.scriptId,o.screens.scriptId)).where((0,r.xD)((0,r.Ft)(o.screens.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.screens.screenId,e):void 0,s.length?(0,r.d3)(o.screens.scriptId,s):void 0))).map(e=>({...e,createdByUserId:a}));i.length&&await d.Z.insert(o.pendingDeletion).values(i),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_deleteScreens ERROR",e.message)}finally{return!l?.errors?.length&&i&&c.Z.emit("data_changed","delete_screens"),l}}async function g(e){try{return await d.Z.delete(o.diagnosesDrafts).where(e?.userId?(0,r.eq)(o.diagnosesDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function I({diagnosesIds:e=[],scriptsIds:s=[],confirmDeleteAll:t,broadcastAction:i,userId:a}){let l={success:!1};try{if(!s.length&&!e.length&&!t)throw Error("You&apos;re about to delete all the diagnoses, please confirm this action!");await d.Z.delete(o.diagnosesDrafts).where((0,r.xD)(e.length?(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,e):void 0,s.length?(0,r.or)((0,r.d3)(o.diagnosesDrafts.scriptId,s),(0,r.d3)(o.diagnosesDrafts.scriptDraftId,s)):void 0));let i=(await d.Z.select({diagnosisId:o.diagnoses.diagnosisId,diagnosisScriptId:o.diagnoses.scriptId,scriptDraftId:o.scriptsDrafts.scriptDraftId,pendingDeletion:o.pendingDeletion}).from(o.diagnoses).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.diagnosisId,o.diagnoses.diagnosisId)).leftJoin(o.scriptsDrafts,(0,r.eq)(o.scriptsDrafts.scriptId,o.diagnoses.scriptId)).where((0,r.xD)((0,r.Ft)(o.diagnoses.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.diagnoses.diagnosisId,e):void 0,s.length?(0,r.d3)(o.diagnoses.scriptId,s):void 0))).map(e=>({...e,createdByUserId:a}));i.length&&await d.Z.insert(o.pendingDeletion).values(i),l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_deleteDiagnoses ERROR",e.message)}finally{return!l?.errors?.length&&i&&c.Z.emit("data_changed","delete_diagnoses"),l}}async function y(e){try{return await d.Z.delete(o.scriptsDrafts).where(e?.userId?(0,r.eq)(o.scriptsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function h({scriptsIds:e=[],broadcastAction:s,confirmDeleteAll:t,userId:i}){let a={success:!1};try{if(!e.length&&!t)throw Error("You&apos;re about to delete all the scripts, please confirm this action!");await d.Z.delete(o.scriptsDrafts).where((0,r.or)((0,r.d3)(o.scriptsDrafts.scriptId,e),(0,r.d3)(o.scriptsDrafts.scriptDraftId,e)));let s=await d.Z.select({scriptId:o.scripts.scriptId,pendingDeletion:o.pendingDeletion}).from(o.scripts).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.scriptId,o.scripts.scriptId)).where((0,r.xD)((0,r.Ft)(o.scripts.deletedAt),(0,r.Ft)(o.pendingDeletion),e.length?(0,r.d3)(o.scripts.scriptId,e):void 0));(s=s.map(e=>({...e,createdByUserId:i}))).length&&(await d.Z.insert(o.pendingDeletion).values(s.map(e=>({scriptId:e.scriptId}))),await f({scriptsIds:s.map(e=>e.scriptId)}),await I({scriptsIds:s.map(e=>e.scriptId)})),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_deleteScripts ERROR",e.message)}finally{return!a?.errors?.length&&s&&c.Z.emit("data_changed","delete_scripts"),a}}var w=t(34149);async function D({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.scriptId===r?.data?.scriptId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=l(r.data[e]),n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:s}))}),s.changes={action:"update_script",description:"Update script",oldValues:i,newValues:a}}t.push(s)}await d.Z.insert(o.scriptsHistory).values(t)}catch(e){n.Z.error(e.message)}}async function m({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,screenId:r?.data?.screenId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_screen",description:"Create screen",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.screenId===r?.data?.screenId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=l(r.data[e]),n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:s}))}),s.changes={action:"update_screen",description:"Update screen",oldValues:i,newValues:a}}t.push(s)}await d.Z.insert(o.screensHistory).values(t)}catch(e){n.Z.error(e.message)}}var v=t(54491);async function Z(e){let{scriptsIds:s,screensIds:t}={...e},i={success:!1};try{let n=[],c=[];if(s?.length||t?.length){let i=await d.Z.query.screensDrafts.findMany({where:(0,r.xD)((0,r.or)(s?.length?(0,r.d3)(o.screensDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(o.screensDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(o.screensDrafts.screenId,t):void 0,t?.length?(0,r.d3)(o.screensDrafts.screenDraftId,t):void 0),e?.userId?(0,r.eq)(o.screensDrafts.createdByUserId,e.userId):void 0)});n=i.filter(e=>e.screenId),c=i.filter(e=>!e.screenId)}else{let s=await d.Z.query.screensDrafts.findMany({where:(0,r.xD)((0,r.K0)(o.screensDrafts.scriptId),e?.userId?(0,r.eq)(o.screensDrafts.createdByUserId,e.userId):void 0)});n=s.filter(e=>e.screenId),c=s.filter(e=>!e.screenId)}if(n.length){let e=[];for(let{screenId:s,data:t}of(n.filter(e=>e.screenId).length&&(e=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,n.filter(e=>e.screenId).map(e=>e.screenId))})),n)){let{screenId:e,id:i,oldScreenId:a,createdAt:n,updatedAt:c,deletedAt:l,...p}=t,u={...p,publishDate:new Date};await d.Z.update(o.screens).set(u).where((0,r.eq)(o.screens.screenId,s)).returning()}await m({drafts:n,previous:e})}if(c.length){let e=[];for(let{id:s,scriptId:t,scriptDraftId:i,data:n}of(c.filter(e=>e.screenId).length&&(e=await d.Z.query.screens.findMany({where:(0,r.d3)(o.screens.screenId,c.filter(e=>e.screenId).map(e=>e.screenId))})),c)){let e=n.screenId||(0,a.Z)(),r=n.scriptId||t||i,l={...n,screenId:e,scriptId:r};c=c.map(t=>(t.id===s&&(t.data.screenId=e),t)),await d.Z.insert(o.screens).values(l)}await m({drafts:c,previous:e})}await d.Z.delete(o.screensDrafts);let l=await d.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(o.pendingDeletion.screenId),e?.userId?(0,r.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0),columns:{screenId:!0},with:{screen:{columns:{version:!0,scriptId:!0}}}});if((l=l.filter(e=>e.screen)).length){let e=new Date;await d.Z.update(o.screens).set({deletedAt:e}).where((0,r.d3)(o.screens.screenId,l.map(e=>e.screenId))),await d.Z.insert(o.screensHistory).values(l.map(s=>({version:s.screen.version,screenId:s.screenId,scriptId:s.screen.scriptId,changes:{action:"delete_screen",description:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(o.pendingDeletion.screenId),(0,r.K0)(o.pendingDeletion.screenDraftId)),e?.userId?(0,r.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0));let p=[...n.map(e=>e.screenId),...l.map(e=>e.screenId)],u=Array.from(new Set((n??[]).map(e=>e.scriptId).filter(e=>!!e)));u.length&&await (0,v.uW)(u),p.length&&await d.Z.update(o.screens).set({version:(0,w.i6)`${o.screens.version} + 1`}).where((0,r.d3)(o.screens.screenId,p)),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishScreens ERROR",e)}finally{return i}}async function q({previous:e,drafts:s}){try{let t=[];for(let r of s){let s={version:r?.data?.version||1,diagnosisId:r?.data?.diagnosisId,scriptId:r?.data?.scriptId,changes:{}};if(r?.data?.version===1)s.changes={action:"create_diagnosis",description:"Create diagnosis",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.diagnosisId===r?.data?.diagnosisId)[0],i=[],a=[];Object.keys({...r?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let s=l(r.data[e]),n={...t}[e];JSON.stringify(s)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:s}))}),s.changes={action:"update_diagnosis",description:"Update diagnosis",oldValues:i,newValues:a}}t.push(s)}await d.Z.insert(o.diagnosesHistory).values(t)}catch(e){n.Z.error(e.message)}}async function b(e){let{scriptsIds:s,diagnosesIds:t}={...e},i={success:!1};try{let n=[],c=[];if(s?.length||t?.length){let i=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.xD)((0,r.or)(s?.length?(0,r.d3)(o.diagnosesDrafts.scriptId,s):void 0,s?.length?(0,r.d3)(o.diagnosesDrafts.scriptDraftId,s):void 0,t?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisId,t):void 0,t?.length?(0,r.d3)(o.diagnosesDrafts.diagnosisDraftId,t):void 0),e?.userId?(0,r.eq)(o.diagnosesDrafts.createdByUserId,e.userId):void 0)});n=i.filter(e=>e.diagnosisId),c=i.filter(e=>!e.diagnosisId)}else{let s=await d.Z.query.diagnosesDrafts.findMany({where:(0,r.xD)((0,r.K0)(o.diagnosesDrafts.scriptId),e?.userId?(0,r.eq)(o.diagnosesDrafts.createdByUserId,e.userId):void 0)});n=s.filter(e=>e.diagnosisId),c=s.filter(e=>!e.diagnosisId)}if(n.length){let e=[];for(let{diagnosisId:s,data:t}of(n.filter(e=>e.diagnosisId).length&&(e=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,n.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),n)){let{diagnosisId:e,id:i,oldDiagnosisId:a,createdAt:n,updatedAt:c,deletedAt:l,...p}=t,u={...p,publishDate:new Date};await d.Z.update(o.diagnoses).set(u).where((0,r.eq)(o.diagnoses.diagnosisId,s)).returning()}await q({drafts:n,previous:e})}if(c.length){let e=[];for(let{id:s,scriptId:t,scriptDraftId:i,data:n}of(c.filter(e=>e.diagnosisId).length&&(e=await d.Z.query.diagnoses.findMany({where:(0,r.d3)(o.diagnoses.diagnosisId,c.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),c)){let e=n.diagnosisId||(0,a.Z)(),r=n.scriptId||t||i,l={...n,diagnosisId:e,scriptId:r};c=c.map(t=>(t.id===s&&(t.data.diagnosisId=e),t)),await d.Z.insert(o.diagnoses).values(l)}await q({drafts:c,previous:e})}await d.Z.delete(o.diagnosesDrafts);let l=await d.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(o.pendingDeletion.diagnosisId),e?.userId?(0,r.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0),columns:{diagnosisId:!0},with:{diagnosis:{columns:{version:!0,scriptId:!0}}}});if((l=l.filter(e=>e.diagnosis)).length){let e=new Date;await d.Z.update(o.diagnoses).set({deletedAt:e}).where((0,r.d3)(o.diagnoses.diagnosisId,l.map(e=>e.diagnosisId))),await d.Z.insert(o.diagnosesHistory).values(l.map(s=>({version:s.diagnosis.version,diagnosisId:s.diagnosisId,scriptId:s.diagnosis.scriptId,changes:{action:"delete_diagnosis",description:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(o.pendingDeletion.diagnosisId),(0,r.K0)(o.pendingDeletion.diagnosisDraftId)),e?.userId?(0,r.eq)(o.pendingDeletion.createdByUserId,e.userId):void 0));let p=[...n.map(e=>e.diagnosisId),...l.map(e=>e.diagnosisId)];p.length&&await d.Z.update(o.diagnoses).set({version:(0,w.i6)`${o.diagnoses.version} + 1`}).where((0,r.d3)(o.diagnoses.diagnosisId,p)),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishDiagnoses ERROR",e)}finally{return i}}async function L({userId:e}){let s={success:!1};try{let t=await d.Z.query.scriptsDrafts.findMany({where:e?(0,r.eq)(o.scriptsDrafts.createdByUserId,e):void 0}),i=t.filter(e=>!e.scriptId).map(e=>({...e,scriptId:e.data.scriptId||(0,a.Z)(),data:{...e.data,scriptId:e.data.scriptId||(0,a.Z)()}})),n=t.filter(e=>e.scriptId);[...i.map(e=>e.scriptId),...n.map(e=>e.scriptId)];let c=[];if(n.length){let e=[];for(let{scriptId:s,data:t}of(n.filter(e=>e.scriptId).length&&(e=await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,n.filter(e=>e.scriptId).map(e=>e.scriptId))})),n)){let{scriptId:e,id:i,oldScriptId:a,createdAt:n,updatedAt:l,deletedAt:p,...u}=t,f={...u,publishDate:new Date};await d.Z.update(o.scripts).set(f).where((0,r.eq)(o.scripts.scriptId,s)),c.push({scriptId:s})}await D({drafts:n,previous:e})}if(i.length){i.filter(e=>e.scriptId).length&&await d.Z.query.scripts.findMany({where:(0,r.d3)(o.scripts.scriptId,i.filter(e=>e.scriptId).map(e=>e.scriptId))});let e=i.map(e=>({...e.data,scriptId:e.scriptDraftId}));for(let{scriptId:s}of(await d.Z.insert(o.scripts).values(e),e))c.push({scriptId:s}),await d.Z.update(o.screensDrafts).set({scriptId:s}).where((0,r.or)((0,r.eq)(o.screensDrafts.scriptId,s),(0,r.eq)(o.screensDrafts.scriptDraftId,s))),await d.Z.update(o.diagnosesDrafts).set({scriptId:s}).where((0,r.or)((0,r.eq)(o.diagnosesDrafts.scriptId,s),(0,r.eq)(o.diagnosesDrafts.scriptDraftId,s)))}if(c.length){let s=await Z({userId:e,scriptsIds:c.map(e=>e.scriptId)});if(s.errors)throw Error(s.errors.join(", "));let t=await b({userId:e,scriptsIds:c.map(e=>e.scriptId)});if(t.errors)throw Error(t.errors.join(", "))}let l=await d.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(o.pendingDeletion.scriptId),e?(0,r.eq)(o.pendingDeletion.createdByUserId,e):void 0),columns:{scriptId:!0},with:{script:{columns:{version:!0}}}});if(await d.Z.delete(o.scriptsDrafts),(l=l.filter(e=>e.script)).length){let e=new Date;await d.Z.update(o.scripts).set({deletedAt:e}).where((0,r.d3)(o.scripts.scriptId,l.map(e=>e.scriptId))),await d.Z.insert(o.scriptsHistory).values(l.map(s=>({version:s.script.version,scriptId:s.scriptId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(o.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(o.pendingDeletion.scriptId),(0,r.K0)(o.pendingDeletion.scriptDraftId)),e?(0,r.eq)(o.pendingDeletion.createdByUserId,e):void 0));let p=[...n.map(e=>e.scriptId),...l.map(e=>e.scriptId)];p.length&&await d.Z.update(o.scripts).set({version:(0,w.i6)`${o.scripts.version} + 1`}).where((0,r.d3)(o.scripts.scriptId,p)),s.success=!0}catch(e){s.success=!1,s.errors=[e.message],n.Z.error("_publishScripts ERROR",e.message)}finally{return s}}async function _({data:e,broadcastAction:s,userId:t}){let p={success:!1};e=l(e);let u=[],f={};try{let s=0;for(let{screenId:n,...c}of e)try{s++;let e=n||a.Z();if(!u.length){let a=n?await d.Z.query.screensDrafts.findFirst({where:(0,r.eq)(o.screensDrafts.screenDraftId,e)}):null,l=a||!n?null:await d.Z.query.screens.findFirst({where:(0,r.eq)(o.screens.screenId,e)});if(a){let s={...a.data,...c},t=d.Z.update(o.screensDrafts).set({data:s,position:s.position}).where((0,r.eq)(o.screensDrafts.screenDraftId,e));f.query=t.toSQL(),await t.execute()}else{let a=c.position||l?.position;if(!a){let e=await d.Z.query.screens.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.screens.position)}),s=await d.Z.query.screensDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.screensDrafts.position)});a=Math.max(0,e?.position||0,s?.position||0)+1}let n={...l,...c,screenId:e,version:l?.version?l.version+1:1,position:a};if(n.scriptId){let i=await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,n.scriptId),columns:{scriptDraftId:!0}}),a=await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,n.scriptId),columns:{scriptId:!0}});if(i||a){let s=d.Z.insert(o.screensDrafts).values({data:n,type:n.type,scriptId:a?.scriptId,scriptDraftId:i?.scriptDraftId,screenDraftId:e,position:n.position,screenId:l?.screenId,createdByUserId:t});f.query=s.toSQL(),await s.execute()}else u.push(`Could not save screen ${s}: ${n.title}, because script was not found`)}else u.push(`Could not save screen ${s}: ${n.title}, because scriptId was not specified`)}}}catch(e){u.push(e.message)}u.length?(p.errors=u,p.info=f):p.success=!0}catch(e){p.success=!1,p.errors=[e.message],p.info=f,n.Z.error("_saveScreens ERROR",e.message)}finally{return!p?.errors?.length&&s&&c.Z.emit("data_changed","save_screens"),p}}async function R({data:e,broadcastAction:s,syncSilently:t,userId:p}){let u={success:!1};e=l(e);let f=[],g={};try{let s=0;for(let{diagnosisId:t,...c}of e)try{s++;let e=t||a.Z();if(!f.length){let a=d.Z.query.diagnosesDrafts.findFirst({where:(0,r.eq)(o.diagnosesDrafts.diagnosisDraftId,e)});g[`${e} - getDiagnosisDraftQuery`]=a.toSQL();let n=t?await a.execute():null,l=d.Z.query.diagnoses.findFirst({where:(0,r.eq)(o.diagnoses.diagnosisId,e)});g[`${e} - getPublishedDiagnosisQuery`]=l.toSQL();let u=n||!t?null:await l.execute();if(n){let s={...n.data,...c},t=d.Z.update(o.diagnosesDrafts).set({data:s,position:s.position}).where((0,r.eq)(o.diagnosesDrafts.diagnosisDraftId,e));g[`${e} - updateDiagnosisDraft`]=t.toSQL(),await t.execute()}else{let t=c.position||u?.position;if(!t){let e=await d.Z.query.diagnoses.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.diagnoses.position)}),s=await d.Z.query.diagnosesDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(o.diagnosesDrafts.position)});t=Math.max(0,e?.position||0,s?.position||0)+1}let a={...u,...c,diagnosisId:e,version:u?.version?u.version+1:1,position:t};if(a.scriptId){let t=await d.Z.query.scriptsDrafts.findFirst({where:(0,r.eq)(o.scriptsDrafts.scriptDraftId,a.scriptId),columns:{scriptDraftId:!0}}),i=await d.Z.query.scripts.findFirst({where:(0,r.eq)(o.scripts.scriptId,a.scriptId),columns:{scriptId:!0}});if(t||i){let s=d.Z.insert(o.diagnosesDrafts).values({data:a,scriptId:i?.scriptId,scriptDraftId:t?.scriptDraftId,diagnosisDraftId:e,position:a.position,diagnosisId:u?.diagnosisId,createdByUserId:p});g[`${e} - createDiagnosisDraft`]=s.toSQL(),await s.execute()}else f.push(`Could not save diagnosis ${s}: ${a.name}, because script was not found`)}else f.push(`Could not save diagnosis ${s}: ${a.name}, because scriptId was not specified`)}}}catch(e){f.push(e.message),n.Z.error("saveDiagnosis SQL (FAILED)",JSON.stringify(g))}f.length?u.errors=f:u.success=!0}catch(e){u.success=!1,u.errors=[e.message],n.Z.error("_saveDiagnoses ERROR",e.message)}finally{return u?.errors?.length||!s||t||c.Z.emit("data_changed","save_diagnoses"),u}}},88317:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(94901).io)(process.env.NEXT_PUBLIC_APP_URL)}};