exports.id=6555,exports.ids=[6555],exports.modules={58359:()=>{},93739:()=>{},54491:(e,t,r)=>{"use strict";r.d(t,{hf:()=>y,uW:()=>I});var s=r(57368),i=r(10413),a=r(57745),n=r(81445),d=r(93567),c=r(57435);function o(e){if(!e||""===e)return"A";let t=e.match(/^([A-Z]+)(\d*)$/);if(!t)throw Error("Invalid alias format");let[r,s,i]=t,a=i?parseInt(i,10):0,n=(e=>{let t="";do t=String.fromCharCode(e%26+65)+t,e=Math.floor(e/26)-1;while(e>=0);return t})(s.split("").reduce((e,t)=>26*e+(t.charCodeAt(0)-65),0)+1);return n.length>s.length?(n="A")+(a+1):n+(i||"")}async function l(e,t,r,s){let i=[],a=r;for(let r of t)if(!["management","mwi_edliz_summary_table","progress","zw_edliz_summary_table","diagnosis","drugs","fluids","feeds"].includes(r.type)){if("form"===r.type&&Array.isArray(r.fields))for(let t of r.fields)Array.isArray(t.prePopulate)&&t.prePopulate.length>0&&!await p({name:t.key,script:e})&&(a=o(a))&&i.push({name:t.key,alias:a,script:e,oldScript:s});else Array.isArray(r.prePopulate)&&r.prePopulate.length>0&&!await p({name:r.key,script:e})&&(a=o(a))&&i.push({name:r.key,alias:a,script:e,oldScript:s})}return i}async function p(e){return!!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,e.script),(0,a.eq)(d.aliases.name,e.name))})}async function u(){return!!await i.Z.query.aliases.findFirst()}async function f(e){let t={success:!1},r=[],s={};try{for(let t of e)try{if(!await i.Z.query.aliases.findFirst({where:(0,a.xD)((0,a.eq)(d.aliases.script,t.script),(0,a.eq)(d.aliases.name,t.name)),orderBy:(0,n.C)(d.aliases.createdAt)})){let e=i.Z.insert(d.aliases).values({alias:t.alias,name:t.name,script:t.script,oldScript:t.oldScript});s.query=e.toSQL(),await e.execute()}}catch(e){c.Z.error(e.message),r.push(e.message)}r.length?(t.errors=r,t.info=s):t.success=!0}catch(e){t.success=!1,t.errors=[e.message],t.info=s}}async function g(e){try{let t=e?await i.Z.query.aliases.findFirst({where:(0,a.eq)(d.aliases.script,e),orderBy:(0,n.C)(d.aliases.createdAt)}):"";return t?t.alias:""}catch(e){}}async function y(){try{let e=await (0,s.eh)();await u()||await I(e)}catch(e){}}async function I(e){try{for(let t of e)if(t){let e=await (0,s.A0)(t),r=await g(t),i=[t],{data:a,errors:n}=await (0,s.uK)({scriptsIds:i});if(!n||0===n.length){let s=await l(t,a,r||"",e?.[0]??null);s&&s.length>0&&await f(s)}}}catch(e){c.Z.error("Error in _generateScreenAliases:",e)}}},22418:(e,t,r)=>{"use strict";r.d(t,{U5:()=>I,Ms:()=>m,Nq:()=>Z,hA:()=>S,E8:()=>g,$s:()=>h,gk:()=>w});var s=r(60938),i=r(57745),a=r(81445),n=r(9576),d=r(57435),c=r(10413),o=r(93567),l=r(88317),p=r(30834),u=r(10970),f=r(57368);async function g({keys:e}){try{let t=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),r=[];return t.data.forEach(t=>{let s=t.drugs.filter(t=>!e.includes(t.key)),i=t.fluids.filter(t=>!e.includes(t.key)),a=t.feeds.filter(t=>!e.includes(t.key));s.length!==t.drugs.length&&r.push({...t,drugs:s}),i.length!==t.fluids.length&&r.push({...t,fluids:i}),a.length!==t.feeds.length&&r.push({...t,feeds:a})}),r.length&&await (0,u.uD)({data:r}),{data:{success:!0}}}catch(e){return{errors:[e.message],data:{success:!1}}}}let y=async(e,t=1,r="")=>{let[{count:a}]=await c.Z.select({count:(0,s.QX)()}).from(o.drugsLibraryDrafts).where((0,i.eq)(o.drugsLibraryDrafts.key,e)),[{count:n}]=await c.Z.select({count:(0,s.QX)()}).from(o.drugsLibrary).where((0,i.eq)(o.drugsLibrary.key,e));return n||a?await y(`${r||e}-${t+1}`,t+1,r||e):e};async function I({data:e,...t}){try{let{data:r}=await (0,p.fP)({itemsIds:e.map(e=>e.itemId)}),s=[];for(let e of r){let t=await y(e.key);s.push({...e,key:t,itemId:n.Z(),position:void 0,createdAt:void 0,updatedAt:void 0,deletedAt:void 0,publishDate:void 0,id:void 0})}return await h({data:s,...t})}catch(e){return d.Z.error("_copyDrugsLibraryItems ERROR",e.message),{success:!1,errors:[e.message]}}}async function w({data:e,broadcastAction:t}){try{let r=e.map(e=>e.key).filter(e=>e);if(r.length){let s=await (0,p.fP)({keys:r});if((e=e.map(e=>{let t=s.data.find(t=>`${t.key}`.toLowerCase()===`${e.key}`.toLowerCase());return{...e,itemId:t?.itemId||e.itemId,createdAt:t?.createdAt||e.createdAt,updatedAt:t?.updatedAt||e.updatedAt,deletedAt:t?.deletedAt||e.deletedAt,publishDate:t?.publishDate||e.publishDate,id:t?.id||e.id,position:t?.position||e.position}})).length)return await h({data:e,broadcastAction:t})}return{success:!0}}catch(e){return d.Z.error("_saveDrugsLibraryItemsAndUpdateIfExists ERROR",e.message),{errors:[e.message],success:!1}}}async function h({data:e,broadcastAction:t}){let r={success:!1};try{let t=[],s=[],d=[];for(let{itemId:r,...l}of e)try{let e=r||n.Z(),p="",u=l.key||"",f=null,g=l.type||null;if(!t.length){let t=r?await c.Z.query.drugsLibraryDrafts.findFirst({where:(0,i.eq)(o.drugsLibraryDrafts.itemDraftId,e)}):null,n=t||!r?null:await c.Z.query.drugsLibrary.findFirst({where:(0,i.eq)(o.drugsLibrary.itemId,e)});if(t){p=t.data.key,f=t.data.type||null;let r={...t.data,...l};await c.Z.update(o.drugsLibraryDrafts).set({data:r,position:r.position}).where((0,i.eq)(o.drugsLibraryDrafts.itemDraftId,e))}else{p=n?.key||"",f=n?.type||null;let t=l.position||n?.position;if(!t){let e=await c.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,a.C)(o.drugsLibrary.position)}),r=await c.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,a.C)(o.drugsLibraryDrafts.position)});t=Math.max(0,e?.position||0,r?.position||0)+1}let r={...n,...l,itemId:e,version:n?.version?n.version+1:1,position:t};await c.Z.insert(o.drugsLibraryDrafts).values({data:r,itemDraftId:e,position:r.position,itemId:n?.itemId,key:r.key,type:r.type})}p&&u&&p!==u&&s.push({old:p,new:u}),f&&g&&f!==g&&p&&d.push(p)}}catch(e){t.push(e.message)}if(d.length&&await g({keys:d}),s.length){let e=await (0,f.uK)({types:["drugs","fluids","feeds"],returnDraftsIfExist:!0}),t=[];e.data.forEach(e=>{let r=!1,i=e.drugs.map(e=>{if(s.map(e=>e.old).includes(e.key)){let t=s.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},r=!0}return e}),a=e.fluids.map(e=>{if(s.map(e=>e.old).includes(e.key)){let t=s.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},r=!0}return e}),n=e.feeds.map(e=>{if(s.map(e=>e.old).includes(e.key)){let t=s.filter(t=>t.old===e.key).map(e=>e.new)[0];e={...e,key:t},r=!0}return e});r&&t.push({...e,drugs:i,fluids:a,feeds:n})}),t.length&&await (0,u.uD)({data:t})}t.length?r.errors=t:r.success=!0}catch(e){r.success=!1,r.errors=[e.message],d.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&t&&l.Z.emit("data_changed","save_drugs_library_items"),r}}var D=r(17754);async function m(){try{return(await (0,D.UU)()).length>0&&await c.Z.delete(o.drugsLibraryDrafts),!0}catch(e){throw e}}async function Z({itemsIds:e,broadcastAction:t}){let r={success:!1};try{let t=e||[];if(t.length){let e=await (0,p.fP)({itemsIds:t,returnDraftsIfExist:!0});await c.Z.delete(o.drugsLibraryDrafts).where((0,i.d3)(o.drugsLibraryDrafts.itemDraftId,t));let r=e.data.filter(e=>!e.isDraft).map(e=>({drugsLibraryItemId:e.itemId}));r.length&&await c.Z.insert(o.pendingDeletion).values(r),await g({keys:e.data.map(e=>e.key)})}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],d.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!r?.errors?.length&&t&&l.Z.emit("data_changed","delete_drugs_library_items"),r}}async function q({previous:e,drafts:t}){try{let r=[];for(let s of t){let t={version:s?.data?.version||1,itemId:s?.data?.itemId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_drugs_library_item",description:"Create drugs library item",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.itemId===s?.data?.itemId)[0],i=[],a=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=s.data[e],n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:i,newValues:a}}r.push(t)}await c.Z.insert(o.drugsLibraryHistory).values(r)}catch(e){d.Z.error(e.message)}}var k=r(34149),L=r(24316);async function S(e){let t={success:!1};try{if(await (0,L.V4)("drug_library")){let e=await c.Z.query.pendingDeletion.findMany({where:(0,i.K0)(o.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0,key:!0}}}});if((e=e.filter(e=>e.drugsLibraryItem)).length){let t=new Date;await c.Z.update(o.drugsLibrary).set({deletedAt:t,key:(0,k.i6)`CONCAT(${o.drugsLibrary.key}, '_', ${o.drugsLibrary.itemId})`}).where((0,i.d3)(o.drugsLibrary.itemId,e.map(e=>e.drugsLibraryItemId))),await c.Z.insert(o.drugsLibraryHistory).values(e.map(e=>({version:e.drugsLibraryItem.version,itemId:e.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null,key:e.drugsLibraryItem.key}],newValues:[{deletedAt:t,key:`${e.drugsLibraryItem.key}_${e.drugsLibraryItemId}`}]}})))}await c.Z.delete(o.pendingDeletion).where((0,i.or)((0,i.K0)(o.pendingDeletion.drugsLibraryItemId),(0,i.K0)(o.pendingDeletion.drugsLibraryItemDraftId)));let r=[],s=[],a=await c.Z.query.drugsLibraryDrafts.findMany();if(r=a.filter(e=>e.itemId),s=a.filter(e=>!e.itemId),r.length){let e=[];for(let{itemId:t,data:s}of(r.filter(e=>e.itemId).length&&(e=await c.Z.query.drugsLibrary.findMany({where:(0,i.d3)(o.drugsLibrary.itemId,r.filter(e=>e.itemId).map(e=>e.itemId))})),r)){let{itemId:e,id:r,createdAt:a,updatedAt:n,deletedAt:d,...l}=s,p={...l,publishDate:new Date};await c.Z.update(o.drugsLibrary).set(p).where((0,i.eq)(o.drugsLibrary.itemId,t)).returning()}await q({drafts:r,previous:e})}if(s.length){let e=[];for(let{id:t,data:r}of(s.filter(e=>e.itemId).length&&(e=await c.Z.query.drugsLibrary.findMany({where:(0,i.d3)(o.drugsLibrary.itemId,s.filter(e=>e.itemId).map(e=>e.itemId))})),s)){let e=r.itemId||(0,n.Z)(),i={...r,itemId:e};s=s.map(r=>(r.id===t&&(r.data.itemId=e),r)),await c.Z.insert(o.drugsLibrary).values(i)}await q({drafts:s,previous:e})}await c.Z.delete(o.drugsLibraryDrafts);let d=[...r.map(e=>e.itemId),...e.map(e=>e.drugsLibraryItemId)];d.length&&await c.Z.update(o.drugsLibrary).set({version:(0,k.i6)`${o.drugsLibrary.version} + 1`}).where((0,i.d3)(o.drugsLibrary.itemId,d)),t.success=!0}else t.success=!0}catch(e){t.success=!1,t.errors=[e.message],d.Z.error("_publishDrugsLibraryItems ERROR",e.message)}finally{return t}}},17754:(e,t,r)=>{"use strict";r.d(t,{Bv:()=>l,FR:()=>u,UU:()=>h,V4:()=>o,Xe:()=>w,Ze:()=>g,d6:()=>f,nI:()=>D,ny:()=>I,oM:()=>y,p1:()=>p});var s=r(10413),i=r(57745),a=r(93567),n=r(57435),d=r(40801);async function c(e){let{script:t,lockType:r="script"}=e;if(!t&&"script"===r)return!1;let n=t?(0,i.xD)((0,i.or)((0,i.eq)(a.ntScriptLock.scriptId,t),(0,i.eq)(a.ntScriptLock.newScriptId,t)),(0,i.eq)(a.ntScriptLock.lockType,r)):(0,i.eq)(a.ntScriptLock.lockType,r);return!!await s.Z.query.ntScriptLock.findFirst({where:n})}async function o(e){let t=await (0,d.getAuthenticatedUser)();return!!e&&!!t&&!!await s.Z.query.ntScriptLock.findFirst({where:(0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,e),(0,i.eq)(a.ntScriptLock.userId,t?.userId))})}async function l(){let e=await (0,d.getAuthenticatedUser)();return!!e&&!!await s.Z.query.ntScriptLock.findFirst({where:(0,i.eq)(a.ntScriptLock.userId,e?.userId)})}async function p(e){let t=await (0,d.getAuthenticatedUser)();if(!t)return!0;let{script:r,lockType:n="script"}=e;if(r){if(await s.Z.query.ntScriptLock.findFirst({where:(0,i.xD)((0,i.or)((0,i.eq)(a.ntScriptLock.scriptId,r),(0,i.eq)(a.ntScriptLock.newScriptId,r)),(0,i.eq)(a.ntScriptLock.userId,t.userId),(0,i.eq)(a.ntScriptLock.lockType,n))}))return!1}else if("script"!==n&&await s.Z.query.ntScriptLock.findFirst({where:(0,i.xD)((0,i.eq)(a.ntScriptLock.userId,t.userId),(0,i.eq)(a.ntScriptLock.lockType,n))}))return!1;return c(e)}async function u(e){return await I({script:e.script,lockType:e.lockType}),await p({script:e.script,lockType:e.lockType})}async function f(e){let t=await (0,d.getAuthenticatedUser)(),r=t?.userId||"";for(let e of(await s.Z.query.ntScriptLock.findMany({})).map(e=>e.scriptId||e.newScriptId).filter(e=>null!=e)||[]){let[t,n,d,c]=await Promise.all([s.Z.query.scriptsDrafts.findFirst({where:(0,i.or)((0,i.eq)(a.scriptsDrafts.scriptId,e),(0,i.eq)(a.scriptsDrafts.scriptDraftId,e))}),s.Z.query.screensDrafts.findFirst({where:(0,i.eq)(a.screensDrafts.scriptId,e)}),s.Z.query.diagnosesDrafts.findFirst({where:(0,i.eq)(a.diagnosesDrafts.scriptId,e)}),s.Z.query.pendingDeletion.findFirst({where:(0,i.or)((0,i.eq)(a.pendingDeletion.scriptId,e),(0,i.eq)(a.pendingDeletion.screenScriptId,e))})]);t||n||d||c||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.or)(((0,i.eq)(a.ntScriptLock.scriptId,e),(0,i.eq)(a.ntScriptLock.newScriptId,e)),(0,i.eq)(a.ntScriptLock.userId,r))));let[o,l]=await Promise.all([s.Z.query.drugsLibraryDrafts.findFirst({}),s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion.drugsLibraryItemId)})]);o||l||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"drug_library"),(0,i.eq)(a.ntScriptLock.userId,r)));let[p,u]=await Promise.all([s.Z.query.dataKeys.findFirst({}),s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion.dataKeyId)})]);p||u||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"data_key"),(0,i.eq)(a.ntScriptLock.userId,r)))}if("drug_library"!==e.lockType){let[e,t]=await Promise.all([s.Z.query.drugsLibraryDrafts.findFirst({}),s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion.drugsLibraryItemId)})]);e||t||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"drug_library"),(0,i.eq)(a.ntScriptLock.userId,r)))}if("data_key"!==e.lockType){let[e,t]=await Promise.all([s.Z.query.dataKeys.findFirst({}),s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion.dataKeyId)})]);e||t||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"data_key"),(0,i.eq)(a.ntScriptLock.userId,r)))}}async function g(){let e=await s.Z.query.ntScriptLock.findMany({columns:{scriptId:!0,lockType:!0,newScriptId:!0}}),t=await (0,d.getAuthenticatedUser)();for(let r of e)if(r.scriptId){let e=await s.Z.query.scriptsDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(r.scriptId))}),n=await s.Z.query.screensDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(r.scriptId))}),d=await s.Z.query.diagnosesDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(r.scriptId))});e||n||d||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.scriptId,String(r.scriptId)),(0,i.eq)(a.ntScriptLock.userId,t?.userId||"")))}else if(r.newScriptId)await s.Z.query.scriptsDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptDraftId,r.newScriptId)})||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.newScriptId,String(r.scriptId)),(0,i.eq)(a.ntScriptLock.userId,t?.userId||"")));else{if("drug_library"==r.lockType){let e=await s.Z.query.drugsLibraryDrafts.findFirst({}),r=await s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion?.drugsLibraryItemId)});e||r||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"drug_library"),(0,i.eq)(a.ntScriptLock.userId,t?.userId||"")))}if("data_key"==r.lockType){let e=await s.Z.query.dataKeys.findFirst({}),r=await s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion?.dataKeyId)});e||r||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"data_key"),(0,i.eq)(a.ntScriptLock.userId,t?.userId||"")))}}}async function y(){for(let t of(await s.Z.query.ntScriptLock.findMany({columns:{scriptId:!0,lockType:!0,newScriptId:!0,lockedAt:!0}}))){var e;let r=(e=t.lockedAt,Date.now()-e.getTime()>=72e5);if(console.log("...MY IDLE",r),r){if(t.scriptId){let e=await s.Z.query.scriptsDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(t.scriptId))}),r=await s.Z.query.screensDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(t.scriptId))}),n=await s.Z.query.diagnosesDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptId,String(t.scriptId))});e||r||n||await s.Z.delete(a.ntScriptLock).where((0,i.eq)(a.ntScriptLock.scriptId,String(t.scriptId)))}else if(t.newScriptId)await s.Z.query.scriptsDrafts.findFirst({where:(0,i.eq)(a.scriptsDrafts.scriptDraftId,t.newScriptId)})||await s.Z.delete(a.ntScriptLock).where((0,i.eq)(a.ntScriptLock.newScriptId,String(t.scriptId)));else{if("drug_library"==t.lockType){let e=await s.Z.query.drugsLibraryDrafts.findFirst({}),t=await s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion?.drugsLibraryItemId)});e||t||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"drug_library")))}if("data_key"==t.lockType){let e=await s.Z.query.dataKeys.findFirst({}),t=await s.Z.query.pendingDeletion.findFirst({where:(0,i.K0)(a.pendingDeletion?.dataKeyId)});e||t||await s.Z.delete(a.ntScriptLock).where((0,i.xD)((0,i.eq)(a.ntScriptLock.lockType,"data_key")))}}}}}async function I(e){let t={success:!1},r=[],o={};try{try{let t=await c({script:e.script,lockType:e.lockType}),r=await s.Z.query.scripts.findFirst({where:(0,i.eq)(a.scripts.scriptId,e.script)});if(!t){let t=await (0,d.getAuthenticatedUser)();if(r){let r=s.Z.insert(a.ntScriptLock).values({userId:t?.userId,scriptId:e.script||null,lockType:e.lockType,lockedAt:new Date(new Date().toISOString())});o.query=r.toSQL(),await r.execute()}else{let r=s.Z.insert(a.ntScriptLock).values({userId:t?.userId,scriptId:null,newScriptId:e.script,lockType:e.lockType,lockedAt:new Date(new Date().toISOString())});o.query=r.toSQL(),await r.execute()}}}catch(e){n.Z.error(e.message),r.push(e.message)}r.length?(t.errors=r,t.info=o):t.success=!0}catch(e){t.success=!1,t.errors=[e.message],t.info=o}return t}async function w(){let e=await (0,d.getAuthenticatedUser)();return await s.Z.query.ntScriptLock.findMany({where:(0,i.xD)((0,i.eq)(a.ntScriptLock.userId,e?.userId||""),(0,i.or)((0,i.K0)(a.ntScriptLock.scriptId),(0,i.K0)(a.ntScriptLock.newScriptId)))}).then(e=>e.flatMap(e=>[e.scriptId,e.newScriptId]).filter(Boolean))}async function h(){let e=await (0,d.getAuthenticatedUser)();return await s.Z.query.ntScriptLock.findMany({where:(0,i.xD)((0,i.eq)(a.ntScriptLock.userId,e?.userId||""),(0,i.eq)(a.ntScriptLock.lockType,"drug_library"))}).then(e=>e.flatMap(e=>[e.userId]).filter(Boolean))}async function D(){let e=await (0,d.getAuthenticatedUser)();return await s.Z.query.ntScriptLock.findMany({where:(0,i.xD)((0,i.eq)(a.ntScriptLock.userId,e?.userId||""),(0,i.eq)(a.ntScriptLock.lockType,"data_key"))}).then(e=>e.flatMap(e=>[e.userId]).filter(Boolean))}},24316:(e,t,r)=>{"use strict";r.d(t,{Bv:()=>s.Bv,FR:()=>s.FR,V4:()=>s.V4,Ze:()=>s.Ze,d6:()=>s.d6,ny:()=>s.ny,oM:()=>s.oM,p1:()=>s.p1});var s=r(17754)},10970:(e,t,r)=>{"use strict";r.d(t,{cF:()=>I,In:()=>g,VQ:()=>h,Bx:()=>w,GH:()=>y,Es:()=>D,gv:()=>v,Ry:()=>L,Ls:()=>b,Pk:()=>F,uD:()=>_,Or:()=>u});var s=r(57745),i=r(81445),a=r(9576),n=r(57435),d=r(10413),c=r(93567),o=r(88317);function l(e){if("string"==typeof e)return e.replace(/0x[0-9A-Fa-f]+/g,"");if(Array.isArray(e))return e.map(l);if("object"==typeof e&&null!==e){let t={};for(let r in e)e.hasOwnProperty(r)&&(t[r]=l(e[r]));return t}return e}var p=r(24316);async function u({data:e,broadcastAction:t,syncSilently:r}){let u={success:!1},f=[],g={};e=l(e);try{for(let{scriptId:t,...r}of e)try{let e=t||a.Z();if(!f.length){let a=t?await d.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(c.scriptsDrafts.scriptDraftId,e)}):null,n=a||!t?null:await d.Z.query.scripts.findFirst({where:(0,s.eq)(c.scripts.scriptId,e)});if(a){let t={...a.data,...r},i=d.Z.update(c.scriptsDrafts).set({data:t,position:t.position,hospitalId:t.hospitalId}).where((0,s.eq)(c.scriptsDrafts.scriptDraftId,e));g.query=i.toSQL(),await i.execute()}else{let t=r.position||n?.position;if(!t){let e=await d.Z.query.scripts.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.scripts.position)}),r=await d.Z.query.scriptsDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.scriptsDrafts.position)});t=Math.max(0,e?.position||0,r?.position||0)+1}let s={...n,...r,scriptId:e,version:n?.version?n.version+1:1,position:t},a=d.Z.insert(c.scriptsDrafts).values({data:s,scriptDraftId:e,position:s.position,hospitalId:s.hospitalId,scriptId:n?.scriptId});g.query=a.toSQL(),await a.execute(),await (0,p.ny)({script:e,lockType:"script"})}}}catch(e){f.push(e.message)}f.length?(u.errors=f,u.info=g):u.success=!0}catch(e){u.success=!1,u.errors=[e.message],u.info=g,n.Z.error("_saveScripts ERROR",e.message)}finally{return u?.errors?.length||!t||r||o.Z.emit("data_changed","save_scripts"),u}}var f=r(17754);async function g(){try{let e=await (0,f.Xe)();return e&&e.length>0&&await d.Z.delete(c.screensDrafts).where((0,s.or)((0,s.d3)(c.screensDrafts.scriptId,e),(0,s.d3)(c.screensDrafts.scriptDraftId,e))),!0}catch(e){throw e}}async function y({screensIds:e=[],scriptsIds:t=[],confirmDeleteAll:r,broadcastAction:i}){let a={success:!1};try{if(!t.length&&!e.length&&!r)throw Error("You&apos;re about to delete all the screens, please confirm this action!");await d.Z.delete(c.screensDrafts).where((0,s.xD)(e.length?(0,s.d3)(c.screensDrafts.screenDraftId,e):void 0,t.length?(0,s.or)((0,s.d3)(c.screensDrafts.scriptId,t),(0,s.d3)(c.screensDrafts.scriptDraftId,t)):void 0));let i=await d.Z.select({screenId:c.screens.screenId,screenScriptId:c.screens.scriptId,scriptDraftId:c.scriptsDrafts.scriptDraftId,pendingDeletion:c.pendingDeletion}).from(c.screens).leftJoin(c.pendingDeletion,(0,s.eq)(c.pendingDeletion.screenId,c.screens.screenId)).leftJoin(c.scriptsDrafts,(0,s.eq)(c.scriptsDrafts.scriptId,c.screens.scriptId)).where((0,s.xD)((0,s.Ft)(c.screens.deletedAt),(0,s.Ft)(c.pendingDeletion),e.length?(0,s.d3)(c.screens.screenId,e):void 0,t.length?(0,s.d3)(c.screens.scriptId,t):void 0));i.length&&await d.Z.insert(c.pendingDeletion).values(i),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_deleteScreens ERROR",e.message)}finally{return!a?.errors?.length&&i&&o.Z.emit("data_changed","delete_screens"),a}}async function I(){try{return await d.Z.delete(c.diagnosesDrafts),!0}catch(e){throw e}}async function w({diagnosesIds:e=[],scriptsIds:t=[],confirmDeleteAll:r,broadcastAction:i}){let a={success:!1};try{if(!t.length&&!e.length&&!r)throw Error("You&apos;re about to delete all the diagnoses, please confirm this action!");let i=await (0,f.Xe)();if(i&&i.length>0){await d.Z.delete(c.diagnosesDrafts).where((0,s.or)((0,s.d3)(c.diagnosesDrafts.scriptId,i),(0,s.d3)(c.diagnosesDrafts.scriptDraftId,i)));let e=await d.Z.select({diagnosisId:c.diagnoses.diagnosisId,diagnosisScriptId:c.diagnoses.scriptId,scriptDraftId:c.scriptsDrafts.scriptDraftId,pendingDeletion:c.pendingDeletion}).from(c.diagnoses).leftJoin(c.pendingDeletion,(0,s.eq)(c.pendingDeletion.diagnosisId,c.diagnoses.diagnosisId)).leftJoin(c.scriptsDrafts,(0,s.eq)(c.scriptsDrafts.scriptId,c.diagnoses.scriptId)).where((0,s.xD)((0,s.Ft)(c.diagnoses.deletedAt),(0,s.Ft)(c.pendingDeletion),(0,s.d3)(c.diagnoses.scriptId,i)));e.length&&await d.Z.insert(c.pendingDeletion).values(e)}a.success=!0}catch(e){a.success=!1,a.errors=[e.message],n.Z.error("_deleteDiagnoses ERROR",e.message)}finally{return!a?.errors?.length&&i&&o.Z.emit("data_changed","delete_diagnoses"),a}}async function h(){try{let e=await (0,f.Xe)();return e&&e.length>0&&await d.Z.delete(c.scriptsDrafts).where((0,s.or)((0,s.d3)(c.scriptsDrafts.scriptId,e),(0,s.d3)(c.scriptsDrafts.scriptDraftId,e))),!0}catch(e){throw e}}async function D({scriptsIds:e=[],broadcastAction:t,confirmDeleteAll:r}){let i={success:!1};try{if(!e.length&&!r)throw Error("You&apos;re about to delete all the scripts, please confirm this action!");await d.Z.delete(c.scriptsDrafts).where((0,s.or)((0,s.d3)(c.scriptsDrafts.scriptId,e),(0,s.d3)(c.scriptsDrafts.scriptDraftId,e)));let t=await d.Z.select({scriptId:c.scripts.scriptId,pendingDeletion:c.pendingDeletion}).from(c.scripts).leftJoin(c.pendingDeletion,(0,s.eq)(c.pendingDeletion.scriptId,c.scripts.scriptId)).where((0,s.xD)((0,s.Ft)(c.scripts.deletedAt),(0,s.Ft)(c.pendingDeletion),e.length?(0,s.d3)(c.scripts.scriptId,e):void 0));t.length&&(await d.Z.insert(c.pendingDeletion).values(t.map(e=>({scriptId:e.scriptId}))),await y({scriptsIds:t.map(e=>e.scriptId)}),await w({scriptsIds:t.map(e=>e.scriptId)}),await Promise.all(t.map(e=>(0,p.ny)({script:e.scriptId,lockType:"script"})))),i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_deleteScripts ERROR",e.message)}finally{return!i?.errors?.length&&t&&o.Z.emit("data_changed","delete_scripts"),i}}var m=r(34149);async function Z({previous:e,drafts:t}){try{let r=[];for(let s of t){let t={version:s?.data?.version||1,scriptId:s?.data?.scriptId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_script",description:"Create script",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.scriptId===s?.data?.scriptId)[0],i=[],a=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(s.data[e]),n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_script",description:"Update script",oldValues:i,newValues:a}}r.push(t)}await d.Z.insert(c.scriptsHistory).values(r)}catch(e){n.Z.error(e.message)}}async function q({previous:e,drafts:t}){try{let r=[];for(let s of t){let t={version:s?.data?.version||1,screenId:s?.data?.screenId,scriptId:s?.data?.scriptId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_screen",description:"Create screen",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.screenId===s?.data?.screenId)[0],i=[],a=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(s.data[e]),n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_screen",description:"Update screen",oldValues:i,newValues:a}}r.push(t)}await d.Z.insert(c.screensHistory).values(r)}catch(e){n.Z.error(e.message)}}var k=r(54491);async function L(e){let{scriptsIds:t,screensIds:r}={...e},i={success:!1},o=await (0,f.Xe)();try{if(o&&o.length>0){let e=[],t=[],r=await d.Z.query.screensDrafts.findMany({where:(0,s.d3)(c.screensDrafts.scriptId,o)});if(e=r.filter(e=>e.screenId),t=r.filter(e=>!e.screenId),e.length){let t=[];for(let{screenId:r,data:i}of(e.filter(e=>e.screenId).length&&(t=await d.Z.query.screens.findMany({where:(0,s.d3)(c.screens.screenId,e.filter(e=>e.screenId).map(e=>e.screenId))})),e)){let{screenId:e,id:t,oldScreenId:a,createdAt:n,updatedAt:o,deletedAt:l,...p}=i,u={...p,publishDate:new Date};await d.Z.update(c.screens).set(u).where((0,s.eq)(c.screens.screenId,r)).returning()}await q({drafts:e,previous:t})}if(t.length){let e=[];for(let{id:r,scriptId:i,scriptDraftId:n,data:o}of(t.filter(e=>e.screenId).length&&(e=await d.Z.query.screens.findMany({where:(0,s.d3)(c.screens.screenId,t.filter(e=>e.screenId).map(e=>e.screenId))})),t)){let e=o.screenId||(0,a.Z)(),s=o.scriptId||i||n,l={...o,screenId:e,scriptId:s};t=t.map(t=>(t.id===r&&(t.data.screenId=e),t)),await d.Z.insert(c.screens).values(l)}await q({drafts:t,previous:e})}await d.Z.delete(c.screensDrafts).where((0,s.or)((0,s.d3)(c.screensDrafts.scriptId,o),(0,s.d3)(c.screensDrafts.scriptDraftId,o)));let i=await d.Z.query.pendingDeletion.findMany({where:(0,s.K0)(c.pendingDeletion.screenId),columns:{screenId:!0},with:{screen:{columns:{version:!0,scriptId:!0}}}});if((i=i.filter(e=>e.screen)).length){let e=new Date;await d.Z.update(c.screens).set({deletedAt:e}).where((0,s.d3)(c.screens.screenId,i.map(e=>e.screenId))),await d.Z.insert(c.screensHistory).values(i.map(t=>({version:t.screen.version,screenId:t.screenId,scriptId:t.screen.scriptId,changes:{action:"delete_screen",description:"Delete screen",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(c.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.or)((0,s.K0)(c.pendingDeletion.screenId),(0,s.K0)(c.pendingDeletion.screenDraftId)),(0,s.d3)(c.pendingDeletion.scriptId,o),(0,s.d3)(c.pendingDeletion.scriptDraftId,o))));let n=[...e.map(e=>e.screenId),...i.map(e=>e.screenId)],l=Array.from(new Set((e??[]).map(e=>e.scriptId).filter(e=>!!e)));l.length&&await (0,k.uW)(l),n.length&&await d.Z.update(c.screens).set({version:(0,m.i6)`${c.screens.version} + 1`}).where((0,s.d3)(c.screens.screenId,n))}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishScreens ERROR",e)}finally{return i}}async function S({previous:e,drafts:t}){try{let r=[];for(let s of t){let t={version:s?.data?.version||1,diagnosisId:s?.data?.diagnosisId,scriptId:s?.data?.scriptId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_diagnosis",description:"Create diagnosis",oldValues:[],newValues:[]};else{let r=e.filter(e=>e.diagnosisId===s?.data?.diagnosisId)[0],i=[],a=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=l(s.data[e]),n={...r}[e];JSON.stringify(t)!==JSON.stringify(n)&&(i.push({[e]:n}),a.push({[e]:t}))}),t.changes={action:"update_diagnosis",description:"Update diagnosis",oldValues:i,newValues:a}}r.push(t)}await d.Z.insert(c.diagnosesHistory).values(r)}catch(e){n.Z.error(e.message)}}async function v(e){let{scriptsIds:t,diagnosesIds:r}={...e},i={success:!1},o=await (0,f.Xe)();try{let e=[],t=[];if(o&&o.length>0){let r=await d.Z.query.diagnosesDrafts.findMany({where:(0,s.or)((0,s.d3)(c.diagnosesDrafts.scriptId,o))});if(e=r.filter(e=>e.diagnosisId),t=r.filter(e=>!e.diagnosisId),e.length){let r=[];for(let{diagnosisId:t,data:i}of(e.filter(e=>e.diagnosisId).length&&(r=await d.Z.query.diagnoses.findMany({where:(0,s.d3)(c.diagnoses.diagnosisId,e.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),e)){let{diagnosisId:e,id:r,oldDiagnosisId:a,createdAt:n,updatedAt:o,deletedAt:l,...p}=i,u={...p,publishDate:new Date};await d.Z.update(c.diagnoses).set(u).where((0,s.eq)(c.diagnoses.diagnosisId,t)).returning()}if(await S({drafts:e,previous:r}),t.length){let e=[];for(let{id:r,scriptId:i,scriptDraftId:n,data:o}of(t.filter(e=>e.diagnosisId).length&&(e=await d.Z.query.diagnoses.findMany({where:(0,s.d3)(c.diagnoses.diagnosisId,t.filter(e=>e.diagnosisId).map(e=>e.diagnosisId))})),t)){let e=o.diagnosisId||(0,a.Z)(),s=o.scriptId||i||n,l={...o,diagnosisId:e,scriptId:s};t=t.map(t=>(t.id===r&&(t.data.diagnosisId=e),t)),await d.Z.insert(c.diagnoses).values(l)}await S({drafts:t,previous:e})}await d.Z.delete(c.diagnosesDrafts).where((0,s.or)((0,s.d3)(c.diagnosesDrafts.scriptId,o),(0,s.d3)(c.diagnosesDrafts.scriptId,o)));let i=await d.Z.query.pendingDeletion.findMany({where:(0,s.K0)(c.pendingDeletion.diagnosisId),columns:{diagnosisId:!0},with:{diagnosis:{columns:{version:!0,scriptId:!0}}}});if((i=i.filter(e=>e.diagnosis)).length){let e=new Date;await d.Z.update(c.diagnoses).set({deletedAt:e}).where((0,s.d3)(c.diagnoses.diagnosisId,i.map(e=>e.diagnosisId))),await d.Z.insert(c.diagnosesHistory).values(i.map(t=>({version:t.diagnosis.version,diagnosisId:t.diagnosisId,scriptId:t.diagnosis.scriptId,changes:{action:"delete_diagnosis",description:"Delete diagnosis",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(c.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.or)((0,s.K0)(c.pendingDeletion.diagnosisId),(0,s.K0)(c.pendingDeletion.diagnosisDraftId)),(0,s.d3)(c.pendingDeletion.scriptId,o),(0,s.d3)(c.pendingDeletion.scriptDraftId,o))));let n=[...e.map(e=>e.diagnosisId),...i.map(e=>e.diagnosisId)];n.length&&await d.Z.update(c.diagnoses).set({version:(0,m.i6)`${c.diagnoses.version} + 1`}).where((0,s.d3)(c.diagnoses.diagnosisId,n))}}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_publishDiagnoses ERROR",e)}finally{return i}}async function b(){let e={success:!1};try{let t=await (0,f.Xe)();if(t&&t.length>0){let e=(await d.Z.query.scriptsDrafts.findMany()).filter(e=>t.includes(e.scriptId||e.scriptDraftId)),r=e.filter(e=>!e.scriptId).map(e=>({...e,scriptId:e.scriptId||e.data.scriptId||(0,a.Z)(),data:{...e.data,scriptId:e.scriptId||e.data.scriptId||(0,a.Z)()}}));console.log("---INSERTS..",r);let i=e.filter(e=>e.scriptId);[...r.map(e=>e.scriptId),...i.map(e=>e.scriptId)];let n=[];if(i.length){let e=[];for(let{scriptId:t,data:r}of(i.filter(e=>e.scriptId).length&&(e=await d.Z.query.scripts.findMany({where:(0,s.d3)(c.scripts.scriptId,i.filter(e=>e.scriptId).map(e=>e.scriptId))})),i)){let{scriptId:e,id:i,oldScriptId:a,createdAt:o,updatedAt:l,deletedAt:p,...u}=r,f={...u,publishDate:new Date};await d.Z.update(c.scripts).set(f).where((0,s.eq)(c.scripts.scriptId,t)),n.push({scriptId:t})}await Z({drafts:i,previous:e})}if(r.length){r.filter(e=>e.scriptId).length&&await d.Z.query.scripts.findMany({where:(0,s.d3)(c.scripts.scriptId,r.filter(e=>e.scriptId).map(e=>e.scriptId))});let e=r.map(e=>({...e.data,scriptId:e.scriptDraftId}));for(let{scriptId:t}of(await d.Z.insert(c.scripts).values(e),e))n.push({scriptId:t}),await d.Z.update(c.screensDrafts).set({scriptId:t}).where((0,s.or)((0,s.eq)(c.screensDrafts.scriptId,t),(0,s.eq)(c.screensDrafts.scriptDraftId,t))),await d.Z.update(c.diagnosesDrafts).set({scriptId:t}).where((0,s.or)((0,s.eq)(c.diagnosesDrafts.scriptId,t),(0,s.eq)(c.diagnosesDrafts.scriptDraftId,t)))}if(n.length){let e=await L({scriptsIds:n.map(e=>e.scriptId)});if(e.errors)throw Error(e.errors.join(", "));let t=await v({scriptsIds:n.map(e=>e.scriptId)});if(t.errors)throw Error(t.errors.join(", "))}let o=await d.Z.query.pendingDeletion.findMany({where:(0,s.K0)(c.pendingDeletion.scriptId),columns:{scriptId:!0},with:{script:{columns:{version:!0}}}});if(await d.Z.delete(c.scriptsDrafts).where((0,s.or)((0,s.d3)(c.scriptsDrafts.scriptId,t),(0,s.d3)(c.scriptsDrafts.scriptDraftId,t))),(o=o.filter(e=>e.script&&t.includes(e.scriptId||""))).length){let e=new Date;await d.Z.update(c.scripts).set({deletedAt:e}).where((0,s.d3)(c.scripts.scriptId,o.map(e=>e.scriptId))),await d.Z.insert(c.scriptsHistory).values(o.map(t=>({version:t.script.version,scriptId:t.scriptId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await d.Z.delete(c.pendingDeletion).where((0,s.xD)((0,s.or)((0,s.K0)(c.pendingDeletion.scriptId),(0,s.K0)(c.pendingDeletion.scriptDraftId)),(0,s.d3)(c.pendingDeletion.scriptId,t)));let l=[...i.map(e=>e.scriptId),...o.map(e=>e.scriptId)];l.length&&await d.Z.update(c.scripts).set({version:(0,m.i6)`${c.scripts.version} + 1`}).where((0,s.d3)(c.scripts.scriptId,l))}e.success=!0}catch(t){e.success=!1,e.errors=[t.message],n.Z.error("_publishScripts ERROR",t.message)}finally{return e}}async function _({data:e,broadcastAction:t}){let r={success:!1};e=l(e);let p=[],u={};try{let t=0;for(let{screenId:r,...n}of e)try{t++;let e=r||a.Z();if(!p.length){let a=r?await d.Z.query.screensDrafts.findFirst({where:(0,s.eq)(c.screensDrafts.screenDraftId,e)}):null,o=a||!r?null:await d.Z.query.screens.findFirst({where:(0,s.eq)(c.screens.screenId,e)});if(a){let t={...a.data,...n},r=d.Z.update(c.screensDrafts).set({data:t,position:t.position}).where((0,s.eq)(c.screensDrafts.screenDraftId,e));u.query=r.toSQL(),await r.execute()}else{let r=n.position||o?.position;if(!r){let e=await d.Z.query.screens.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.screens.position)}),t=await d.Z.query.screensDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.screensDrafts.position)});r=Math.max(0,e?.position||0,t?.position||0)+1}let a={...o,...n,screenId:e,version:o?.version?o.version+1:1,position:r};if(a.scriptId){let r=await d.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(c.scriptsDrafts.scriptDraftId,a.scriptId),columns:{scriptDraftId:!0}}),i=await d.Z.query.scripts.findFirst({where:(0,s.eq)(c.scripts.scriptId,a.scriptId),columns:{scriptId:!0}});if(r||i){let t=d.Z.insert(c.screensDrafts).values({data:a,type:a.type,scriptId:i?.scriptId,scriptDraftId:r?.scriptDraftId,screenDraftId:e,position:a.position,screenId:o?.screenId});u.query=t.toSQL(),await t.execute()}else p.push(`Could not save screen ${t}: ${a.title}, because script was not found`)}else p.push(`Could not save screen ${t}: ${a.title}, because scriptId was not specified`)}}}catch(e){p.push(e.message)}p.length?(r.errors=p,r.info=u):r.success=!0}catch(e){r.success=!1,r.errors=[e.message],r.info=u,n.Z.error("_saveScreens ERROR",e.message)}finally{return!r?.errors?.length&&t&&o.Z.emit("data_changed","save_screens"),r}}async function F({data:e,broadcastAction:t,syncSilently:r}){let p={success:!1};e=l(e);let u=[],f={};try{let t=0;for(let{diagnosisId:r,...o}of e)try{t++;let e=r||a.Z();if(!u.length){let a=d.Z.query.diagnosesDrafts.findFirst({where:(0,s.eq)(c.diagnosesDrafts.diagnosisDraftId,e)});f[`${e} - getDiagnosisDraftQuery`]=a.toSQL();let n=r?await a.execute():null,l=d.Z.query.diagnoses.findFirst({where:(0,s.eq)(c.diagnoses.diagnosisId,e)});f[`${e} - getPublishedDiagnosisQuery`]=l.toSQL();let p=n||!r?null:await l.execute();if(n){let t={...n.data,...o},r=d.Z.update(c.diagnosesDrafts).set({data:t,position:t.position}).where((0,s.eq)(c.diagnosesDrafts.diagnosisDraftId,e));f[`${e} - updateDiagnosisDraft`]=r.toSQL(),await r.execute()}else{let r=o.position||p?.position;if(!r){let e=await d.Z.query.diagnoses.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.diagnoses.position)}),t=await d.Z.query.diagnosesDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(c.diagnosesDrafts.position)});r=Math.max(0,e?.position||0,t?.position||0)+1}let a={...p,...o,diagnosisId:e,version:p?.version?p.version+1:1,position:r};if(a.scriptId){let r=await d.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(c.scriptsDrafts.scriptDraftId,a.scriptId),columns:{scriptDraftId:!0}}),i=await d.Z.query.scripts.findFirst({where:(0,s.eq)(c.scripts.scriptId,a.scriptId),columns:{scriptId:!0}});if(r||i){let t=d.Z.insert(c.diagnosesDrafts).values({data:a,scriptId:i?.scriptId,scriptDraftId:r?.scriptDraftId,diagnosisDraftId:e,position:a.position,diagnosisId:p?.diagnosisId});f[`${e} - createDiagnosisDraft`]=t.toSQL(),await t.execute()}else u.push(`Could not save diagnosis ${t}: ${a.name}, because script was not found`)}else u.push(`Could not save diagnosis ${t}: ${a.name}, because scriptId was not specified`)}}}catch(e){u.push(e.message),n.Z.error("saveDiagnosis SQL (FAILED)",JSON.stringify(f))}u.length?p.errors=u:p.success=!0}catch(e){p.success=!1,p.errors=[e.message],n.Z.error("_saveDiagnoses ERROR",e.message)}finally{return p?.errors?.length||!t||r||o.Z.emit("data_changed","save_diagnoses"),p}}},88317:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(94901).io)(process.env.NEXT_PUBLIC_APP_URL)}};