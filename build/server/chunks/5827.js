exports.id=5827,exports.ids=[5827],exports.modules={58359:()=>{},93739:()=>{},47423:(e,r,t)=>{"use strict";t.d(r,{Qt:()=>c,l5:()=>l,yE:()=>I});var a=t(24330);t(60166);var i=t(41771),s=t(30834),d=t(57435),n=t(66267),u=t(40618);let l=(0,a.j)("35750e76ddff8149c8c873fad4fac12f0be0d6e3",o);async function o(...e){try{return await (0,n.isAllowed)(),await (0,i.Nq)(...e)}catch(e){return d.Z.error("deleteDrugsLibraryItems ERROR",e.message),{errors:[e.message],success:!1}}}let g=(0,a.j)("265168937394ecbe40ed4ebb06e9fa06d76a1a1f",y);async function y(...e){try{return await (0,n.isAllowed)(),await (0,s.G$)(...e)}catch(e){return d.Z.error("countDrugsLibraryItems ERROR",e.message),{errors:[e.message],data:s.s}}}let c=(0,a.j)("e5f489be6768923e3bd1baa1f775dcce2a7be387",f);async function f(...e){try{return await (0,n.isAllowed)(),await (0,s.fP)(...e)}catch(e){return d.Z.error("getDrugsLibraryItems ERROR",e.message),{errors:[e.message],data:[]}}}let m=(0,a.j)("cf467c9be0296767c437a1a6702f42c2f4f29c48",b);async function b(...e){return await (0,n.isAllowed)(),await (0,s.t3)(...e)}let I=(0,a.j)("ce33ab979d6b9353ecef2022366070b05f494c2f",L);async function L(...e){try{return await (0,n.isAllowed)(),await (0,i.$s)(...e)}catch(e){return d.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,u.h)([l,g,c,m,I]),(0,a.j)("47cca1361ddc15896e08a96474b34e8cb92ad43a",l),(0,a.j)("a528325866fe4fdfe3cc018395b2fa53e5cea400",g),(0,a.j)("548040c2395e12c7371c99c934381a7006886443",c),(0,a.j)("6390bdcc6e8e79a4515a451b842de584d9c40385",m),(0,a.j)("fd97fdbd0488c5dbf58e1ce5812a7f095954ba89",I)},41771:(e,r,t)=>{"use strict";t.d(r,{Ms:()=>g,Nq:()=>y,hA:()=>m,$s:()=>o});var a=t(57745),i=t(81445),s=t(9576),d=t(57435),n=t(10413),u=t(43509),l=t(88317);async function o({data:e,broadcastAction:r}){let t={success:!1};try{let r=[];for(let{itemId:t,...d}of e)try{let e=t||s.Z();if(!r.length){let r=t?await n.Z.query.drugsLibraryDrafts.findFirst({where:(0,a.eq)(u.drugsLibraryDrafts.itemDraftId,e)}):null,s=r||!t?null:await n.Z.query.drugsLibrary.findFirst({where:(0,a.eq)(u.drugsLibrary.itemId,e)});if(r){let t={...r.data,...d};await n.Z.update(u.drugsLibraryDrafts).set({data:t,position:t.position}).where((0,a.eq)(u.drugsLibraryDrafts.itemDraftId,e))}else{let r=d.position||s?.position;if(!r){let e=await n.Z.query.drugsLibrary.findFirst({columns:{position:!0},orderBy:(0,i.C)(u.drugsLibrary.position)}),t=await n.Z.query.drugsLibraryDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(u.drugsLibraryDrafts.position)});r=Math.max(0,e?.position||0,t?.position||0)+1}let t={...s,...d,itemId:e,version:s?.version?s.version+1:1,position:r};await n.Z.insert(u.drugsLibraryDrafts).values({data:t,itemDraftId:e,position:t.position,itemId:s?.itemId,key:t.key})}}}catch(e){r.push(e.message)}r.length?t.errors=r:t.success=!0}catch(e){t.success=!1,t.errors=[e.message],d.Z.error("_saveDrugsLibraryItems ERROR",e.message)}finally{return!t?.errors?.length&&r&&l.Z.emit("data_changed","save_drugs_library_items"),t}}async function g(){try{return await n.Z.delete(u.drugsLibraryDrafts),!0}catch(e){throw e}}async function y({itemsIds:e,broadcastAction:r}){let t={success:!1};try{if(e.length){await n.Z.delete(u.drugsLibraryDrafts).where((0,a.d3)(u.drugsLibraryDrafts.itemDraftId,e));let r=(await n.Z.select({drugsLibraryItemId:u.drugsLibrary.itemId,pendingDeletion:u.pendingDeletion.drugsLibraryItemId}).from(u.drugsLibrary).leftJoin(u.pendingDeletion,(0,a.eq)(u.pendingDeletion.drugsLibraryItemId,u.drugsLibrary.itemId)).where((0,a.d3)(u.drugsLibrary.itemId,e))).filter(e=>!e.pendingDeletion);r.length&&await n.Z.insert(u.pendingDeletion).values(r)}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],d.Z.error("_deleteDrugsLibraryItems ERROR",e.message)}finally{return!t?.errors?.length&&r&&l.Z.emit("data_changed","delete_drugs_library_items"),t}}async function c({previous:e,drafts:r}){try{let t=[];for(let a of r){let r={version:a?.data?.version||1,itemId:a?.data?.itemId,changes:{}};if(a?.data?.version===1)r.changes={action:"create_drugs_library_item",dedrugsLibraryItemion:"Create drugs library item",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.itemId===a?.data?.itemId)[0],i=[],s=[];Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let r=a.data[e],d={...t}[e];JSON.stringify(r)!==JSON.stringify(d)&&(i.push({[e]:d}),s.push({[e]:r}))}),r.changes={action:"update_drugs_library_item",description:"Update drugs library item",oldValues:i,newValues:s}}t.push(r)}await n.Z.insert(u.drugsLibraryHistory).values(t)}catch(e){d.Z.error(e.message)}}var f=t(34149);async function m(e){let r={success:!1};try{let e=[],t=[],i=await n.Z.query.drugsLibraryDrafts.findMany();if(e=i.filter(e=>e.itemId),t=i.filter(e=>!e.itemId),e.length){let r=[];for(let{itemId:t,data:i}of(e.filter(e=>e.itemId).length&&(r=await n.Z.query.drugsLibrary.findMany({where:(0,a.d3)(u.drugsLibrary.itemId,e.filter(e=>e.itemId).map(e=>e.itemId))})),e)){let{itemId:e,id:r,createdAt:s,updatedAt:d,deletedAt:l,...o}=i,g={...o,publishDate:new Date};await n.Z.update(u.drugsLibrary).set(g).where((0,a.eq)(u.drugsLibrary.itemId,t)).returning()}await c({drafts:e,previous:r})}if(t.length){let e=[];for(let{id:r,data:i}of(t.filter(e=>e.itemId).length&&(e=await n.Z.query.drugsLibrary.findMany({where:(0,a.d3)(u.drugsLibrary.itemId,t.filter(e=>e.itemId).map(e=>e.itemId))})),t)){let e=i.itemId||(0,s.Z)(),a={...i,itemId:e};t=t.map(t=>(t.id===r&&(t.data.itemId=e),t)),await n.Z.insert(u.drugsLibrary).values(a)}await c({drafts:t,previous:e})}await n.Z.delete(u.drugsLibraryDrafts);let d=await n.Z.query.pendingDeletion.findMany({where:(0,a.K0)(u.pendingDeletion.drugsLibraryItemId),columns:{drugsLibraryItemId:!0},with:{drugsLibraryItem:{columns:{version:!0}}}});if((d=d.filter(e=>e.drugsLibraryItem)).length){let e=new Date;await n.Z.update(u.drugsLibrary).set({deletedAt:e}).where((0,a.d3)(u.drugsLibrary.itemId,d.map(e=>e.drugsLibraryItemId))),await n.Z.insert(u.drugsLibraryHistory).values(d.map(r=>({version:r.drugsLibraryItem.version,itemId:r.drugsLibraryItemId,changes:{action:"delete_drugs_library_item",description:"Delete drugs library item",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await n.Z.delete(u.pendingDeletion).where((0,a.or)((0,a.K0)(u.pendingDeletion.drugsLibraryItemId),(0,a.K0)(u.pendingDeletion.drugsLibraryItemDraftId)));let l=[...e.map(e=>e.itemId),...d.map(e=>e.drugsLibraryItemId)];l.length&&await n.Z.update(u.drugsLibrary).set({version:(0,f.i6)`${u.drugsLibrary.version} + 1`}).where((0,a.d3)(u.drugsLibrary.itemId,l)),r.success=!0}catch(e){r.success=!1,r.errors=[e.message],d.Z.error("_publishDrugsLibraryItems ERROR",e)}finally{return r}}},30834:(e,r,t)=>{"use strict";t.d(r,{G$:()=>c,s:()=>y,t3:()=>o,fP:()=>l});var a=t(57745),i=t(30900),s=t(9576),d=t(10413),n=t(43509),u=t(57435);async function l(e){try{let{itemsIds:r,keys:t,returnDraftsIfExist:u}={...e},l=r||[],o=t||[],g=o?.length?(0,a.d3)(n.drugsLibraryDrafts.key,o):void 0,y=l?.length?(0,a.d3)(n.drugsLibraryDrafts.itemDraftId,l.map(e=>i.Z(e)?e:s.Z())):void 0,c=[...g?[g]:[],...y?[y]:[]],f=u?await d.Z.query.drugsLibraryDrafts.findMany({where:(0,a.xD)(...c)}):[];l=l.filter(e=>!f.map(e=>e.itemDraftId).includes(e)),o=o.filter(e=>!f.map(e=>e.key).includes(e));let m=o?.length?(0,a.d3)(n.drugsLibrary.key,o):void 0,b=f.length?(0,a.Nl)(n.drugsLibrary.itemId,f.map(e=>e.itemDraftId)):void 0,I=l?.length?(0,a.d3)(n.drugsLibrary.itemId,l.filter(e=>i.Z(e))):void 0,L=[(0,a.Ft)(n.drugsLibrary.deletedAt),(0,a.Ft)(n.pendingDeletion),b,I,m],D=(await d.Z.select({drugsLibraryItem:n.drugsLibrary,pendingDeletion:n.pendingDeletion}).from(n.drugsLibrary).leftJoin(n.pendingDeletion,(0,a.eq)(n.pendingDeletion.drugsLibraryItemId,n.drugsLibrary.itemId)).where(L.length?(0,a.xD)(...L):void 0)).map(e=>e.drugsLibraryItem),w=D.length?await d.Z.query.pendingDeletion.findMany({where:(0,a.d3)(n.pendingDeletion.drugsLibraryItemId,D.map(e=>e.itemId)),columns:{drugsLibraryItemId:!0}}):[];return{data:[...D.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,r)=>e.position-r.position).filter(e=>!w.map(e=>e.drugsLibraryItemId).includes(e.itemId))}}catch(e){return u.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:[],errors:[e.message]}}}async function o(e){let{itemId:r,returnDraftIfExists:t}={...e};try{if(!r)throw Error("Missing itemId");let e=i.Z(r)?(0,a.eq)(n.drugsLibrary.itemId,r):void 0,s=e?(0,a.eq)(n.drugsLibraryDrafts.itemDraftId,r):void 0,u=t&&s?await d.Z.query.drugsLibraryDrafts.findFirst({where:e}):void 0,l=u?{...u.data,isDraft:!1,isDeleted:!1}:null;if(l)return{data:l};let o=await d.Z.query.drugsLibrary.findFirst({where:(0,a.xD)((0,a.Ft)(n.drugsLibrary.deletedAt)),with:{draft:!0}});u=t?o?.draft:void 0;let g=u?.data||o;if(!(l=g?{...g,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:l}}catch(e){return u.Z.error("_getDrugsLibraryItem ERROR",e.message),{errors:[e.message]}}}var g=t(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function c(){try{let[{count:e}]=await d.Z.select({count:(0,g.QX)()}).from(n.drugsLibraryDrafts),[{count:r}]=await d.Z.select({count:(0,g.QX)()}).from(n.drugsLibraryDrafts).where((0,a.Ft)(n.drugsLibraryDrafts.itemId)),[{count:t}]=await d.Z.select({count:(0,g.QX)()}).from(n.drugsLibraryDrafts).where((0,a.K0)(n.drugsLibraryDrafts.itemId)),[{count:i}]=await d.Z.select({count:(0,g.QX)()}).from(n.pendingDeletion).where((0,a.K0)(n.pendingDeletion.drugsLibraryItemId)),[{count:s}]=await d.Z.select({count:(0,g.QX)()}).from(n.drugsLibrary);return{data:{allPublished:s,publishedWithDrafts:t,allDrafts:e,newDrafts:r,pendingDeletion:i}}}catch(e){return u.Z.error("_getDrugsLibraryItems ERROR",e.message),{data:y,errors:[e.message]}}}},88317:(e,r,t)=>{"use strict";t.d(r,{Z:()=>a});let a=(0,t(55802).io)(process.env.NEXT_PUBLIC_APP_URL)}};