exports.id=5002,exports.ids=[5002],exports.modules={58359:()=>{},93739:()=>{},36864:(e,t,i)=>{"use strict";i.d(t,{C:()=>k,F:()=>Z});var n=i(57745),s=i(81445),r=i(84770),a=i(30900),o=i(9576),d=i(57435),l=i(84878),y=i(10413),c=i(40801),u=i(93567),g=i(88317),p=i(34149);let h={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},I={screen:["scriptId"],diagnosis:["scriptId"]},f=["alias","release"],m=["release"],v={script:{table:u.scripts,idColumn:u.scripts.scriptId,versionColumn:u.scripts.version,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,versionColumn:u.screens.version,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,versionColumn:u.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,versionColumn:u.configKeys.version,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,versionColumn:u.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,versionColumn:u.dataKeys.version,entityLabel:"data key"},hospital:{table:u.hospitals,idColumn:u.hospitals.hospitalId,versionColumn:u.hospitals.version,entityLabel:"hospital"}},b={script:{table:u.scripts,idColumn:u.scripts.scriptId,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,entityLabel:"data key"},alias:{table:u.aliases,idColumn:u.aliases.uuid,entityLabel:"alias"},hospital:{table:u.hospitals,idColumn:u.hospitals.hospitalId,entityLabel:"hospital"}};function w(e){let t=0;for(let i=0;i<e.length;i++)t=31*t+e.charCodeAt(i)|0;return t}async function L(e,t,i){let n=w(t),s=w(i);await e.execute((0,p.i6)`select pg_advisory_xact_lock(${n}, ${s})`)}function T(e){return(0,r.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function C(e){let t="string"==typeof e.userId?e.userId.trim():"",i=t&&(0,l.X)(t);if(!t||!i)try{let t=await (0,c.getAuthenticatedUser)(),i=t?.userId;if(i&&(0,l.X)(i))return d.Z.error("saveChangeLog warning: invalid or missing userId; using authenticated userId",{providedUserId:e.userId,authenticatedUserId:i}),{...e,userId:i}}catch(e){d.Z.error("saveChangeLog warning: failed to resolve authenticated userId",e?.message||e)}return i||d.Z.error("saveChangeLog warning: invalid userId",{providedUserId:e.userId,entityType:e.entityType,entityId:e.entityId}),{...e,userId:t||e.userId}}async function $(e,t){let i=v[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select({version:i.versionColumn}).from(i.table).where((0,n.eq)(i.idColumn,t.entityId)).limit(1),r=s?.[0]?.version;if(!Number.isFinite(r))throw Error(`Missing ${i.entityLabel} or version for entityId ${t.entityId}`);return Number(r)}async function E(e,t,i){let r=await e.select({version:u.changeLogs.version}).from(u.changeLogs).where((0,n.xD)((0,n.eq)(u.changeLogs.entityId,t),(0,n.eq)(u.changeLogs.entityType,i))).orderBy((0,s.C)(u.changeLogs.version)).limit(1);return r?.[0]?.version}async function K(e,t){let i=b[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select().from(i.table).where((0,n.eq)(i.idColumn,t.entityId)).limit(1);if(!s?.[0])throw Error(`Entity not found for snapshot (${i.entityLabel} ${t.entityId})`);return s[0]}async function _({client:e,data:t,computedVersion:i,dataVersion:n,baselineSnapshot:s}){if(Number.isFinite(await E(e,t.entityId,t.entityType)))return;let r=s??t.previousSnapshot;if(void 0===r)try{r=await K(e,t),d.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,i-1),l=T(r),y={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:a,dataVersion:n,changes:[],fullSnapshot:r,previousSnapshot:r,snapshotHash:l,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(u.changeLogs).values(y),a}async function k({data:e,broadcastAction:t,client:i}){let s={success:!1};try{let r=await C(e);!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!(0,l.X)(e.userId))throw Error("Invalid userId");if(m.includes(e.entityType)){if(Object.values(h).map(t=>e[t]).filter(e=>null!=e).length)throw Error(`No foreign keys should be provided for entityType ${e.entityType}`);return}let t=h[e.entityType];if(!t)throw Error(`Unknown entityType ${e.entityType}`);let i=e[t];if(!i||"string"!=typeof i||!a.Z(i))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(i!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let n=I[e.entityType]||[];for(let t of n){let i=e[t];if(null!=i&&("string"!=typeof i||!a.Z(i)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(h).map(([t,i])=>({type:t,key:i,value:e[i]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!n.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(r);let c=async e=>{var t;let i,s,a;await L(e,r.entityType,r.entityId);let l=o.Z(),y=(t=r.entityType,f.includes(t)),c=Number.isFinite(r.version)?Number(r.version):null,g=Number.isFinite(r.dataVersion)?Number(r.dataVersion):null;if(y){let t=await E(e,r.entityId,r.entityType);if(s=t,i=(t??0)+1,a=await _({client:e,data:r,computedVersion:i,dataVersion:g,baselineSnapshot:r.baselineSnapshot}),null!==c&&c!==i){if(c<i);else throw d.Z.error("saveChangeLog versionless mismatch",{entityType:r.entityType,entityId:r.entityId,providedVersion:c,latestChangeLogVersion:t,computedVersion:i}),Error(`Provided version (${r.version}) does not match expected changelog version (${i}) for versionless entity ${r.entityType}`)}}else{let t=r.entityType,n=await $(e,{...r,entityType:t}),o=v[t],l=await E(e,r.entityId,r.entityType);if(s=l,Number.isFinite(l)){let e=Number(l)+1;i=n<=Number(l)?e:n}else i=n;if(a=await _({client:e,data:r,computedVersion:i,dataVersion:g,baselineSnapshot:r.baselineSnapshot}),null!==c&&c!==i){if(c<i);else throw d.Z.error("saveChangeLog version mismatch",{entityType:r.entityType,entityId:r.entityId,providedVersion:c,entityVersion:n,latestChangeLogVersion:l,computedVersion:i}),Error(`Provided version (${r.version}) does not match ${o.entityLabel} version (${i})`)}}let p=r.snapshotHash||T(r.fullSnapshot);if(!p)throw Error("snapshotHash is required");let h=r.previousSnapshot??r.baselineSnapshot??{},I={changeLogId:l,entityId:r.entityId,entityType:r.entityType,action:r.action,version:i,dataVersion:g,changes:r.changes||[],fullSnapshot:r.fullSnapshot||{},previousSnapshot:h,snapshotHash:p,description:r.description,changeReason:r.changeReason,parentVersion:r.parentVersion??(void 0===s?a:s),mergedFromVersion:r.mergedFromVersion,isActive:!1!==r.isActive,userId:r.userId,scriptId:r.scriptId,screenId:r.screenId,diagnosisId:r.diagnosisId,configKeyId:r.configKeyId,hospitalId:r.hospitalId,drugsLibraryItemId:r.drugsLibraryItemId,dataKeyId:r.dataKeyId,aliasId:r.aliasId,dateOfChange:new Date},[m]=await e.insert(u.changeLogs).values(I).returning();return m&&m.entityId&&Number.isFinite(m.version)&&await e.update(u.changeLogs).set({isActive:!1,supersededBy:m.version,supersededAt:m.dateOfChange??new Date}).where((0,n.xD)((0,n.eq)(u.changeLogs.entityId,m.entityId),(0,n.eq)(u.changeLogs.entityType,m.entityType),(0,n.lt)(u.changeLogs.version,m.version),(0,n.eq)(u.changeLogs.isActive,!0))),m},p=i?await c(i):await y.Z.transaction(c);return s.success=!0,s.data=p,t&&g.Z.emit("data_changed","save_change_log"),s}catch(e){return s.success=!1,s.errors=[e.message],d.Z.error("_saveChangeLog ERROR",e.message),s}}async function Z({data:e,broadcastAction:t,allowPartial:i}){let n=0,s=[];try{if(i&&e.some(e=>"rollback"===e.action))throw Error("allowPartial is not permitted for rollback changelog writes");if(i)for(let t of e){let e=await k({data:t});if(e.errors?.length){s.push(...e.errors);continue}n++}else await y.Z.transaction(async t=>{for(let i of e){let e=await k({data:i,client:t});if(e.errors?.length)throw s.push(...e.errors),Error(s.join(", "));n++}});return t&&!s.length&&g.Z.emit("data_changed","save_change_logs"),{success:!s.length,errors:s.length?s:void 0,saved:n}}catch(e){return d.Z.error("_saveChangeLogs ERROR",e.message),n=0,{success:!1,errors:[e.message],saved:n}}}},88317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});let n=(0,i(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},84878:(e,t,i)=>{"use strict";i.d(t,{X:()=>s});let n=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function s(e){return"string"==typeof e&&n.test(e)}}};