exports.id=5002,exports.ids=[5002],exports.modules={58359:()=>{},93739:()=>{},36864:(e,t,i)=>{"use strict";i.d(t,{C:()=>K,F:()=>Z});var n=i(57745),s=i(81445),r=i(84770),a=i(30900),o=i(9576),d=i(57435),l=i(10413),y=i(40801),c=i(93567),u=i(88317),g=i(34149);let p={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},h={screen:["scriptId"],diagnosis:["scriptId"]},I=["alias","release","app_update_policy","apk_release"],f=["release","app_update_policy","apk_release"],m={script:{table:c.scripts,idColumn:c.scripts.scriptId,versionColumn:c.scripts.version,entityLabel:"script"},screen:{table:c.screens,idColumn:c.screens.screenId,versionColumn:c.screens.version,entityLabel:"screen"},diagnosis:{table:c.diagnoses,idColumn:c.diagnoses.diagnosisId,versionColumn:c.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:c.configKeys,idColumn:c.configKeys.configKeyId,versionColumn:c.configKeys.version,entityLabel:"config key"},drugs_library:{table:c.drugsLibrary,idColumn:c.drugsLibrary.itemId,versionColumn:c.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:c.dataKeys,idColumn:c.dataKeys.uuid,versionColumn:c.dataKeys.version,entityLabel:"data key"},hospital:{table:c.hospitals,idColumn:c.hospitals.hospitalId,versionColumn:c.hospitals.version,entityLabel:"hospital"}},v={script:{table:c.scripts,idColumn:c.scripts.scriptId,entityLabel:"script"},screen:{table:c.screens,idColumn:c.screens.screenId,entityLabel:"screen"},diagnosis:{table:c.diagnoses,idColumn:c.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:c.configKeys,idColumn:c.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:c.drugsLibrary,idColumn:c.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:c.dataKeys,idColumn:c.dataKeys.uuid,entityLabel:"data key"},alias:{table:c.aliases,idColumn:c.aliases.uuid,entityLabel:"alias"},hospital:{table:c.hospitals,idColumn:c.hospitals.hospitalId,entityLabel:"hospital"}};function b(e){let t=0;for(let i=0;i<e.length;i++)t=31*t+e.charCodeAt(i)|0;return t}async function w(e,t,i){let n=b(t),s=b(i);await e.execute((0,g.i6)`select pg_advisory_xact_lock(${n}, ${s})`)}function L(e){return(0,r.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function T(e){let t="string"==typeof e.userId?e.userId.trim():"",i=t&&a.Z(t);if(!t||!i)try{let t=await (0,y.getAuthenticatedUser)(),i=t?.userId;if(i&&a.Z(i))return d.Z.error("saveChangeLog warning: invalid or missing userId; using authenticated userId",{providedUserId:e.userId,authenticatedUserId:i}),{...e,userId:i}}catch(e){d.Z.error("saveChangeLog warning: failed to resolve authenticated userId",e?.message||e)}return i||d.Z.error("saveChangeLog warning: invalid userId",{providedUserId:e.userId,entityType:e.entityType,entityId:e.entityId}),{...e,userId:t||e.userId}}async function C(e,t){let i=m[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select({version:i.versionColumn}).from(i.table).where((0,n.eq)(i.idColumn,t.entityId)).limit(1),r=s?.[0]?.version;if(!Number.isFinite(r))throw Error(`Missing ${i.entityLabel} or version for entityId ${t.entityId}`);return Number(r)}async function _(e,t,i){let r=await e.select({version:c.changeLogs.version}).from(c.changeLogs).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,t),(0,n.eq)(c.changeLogs.entityType,i))).orderBy((0,s.C)(c.changeLogs.version)).limit(1);return r?.[0]?.version}async function $(e,t){let i=v[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select().from(i.table).where((0,n.eq)(i.idColumn,t.entityId)).limit(1);if(!s?.[0])throw Error(`Entity not found for snapshot (${i.entityLabel} ${t.entityId})`);return s[0]}async function E({client:e,data:t,computedVersion:i,dataVersion:n,baselineSnapshot:s}){if(Number.isFinite(await _(e,t.entityId,t.entityType)))return;let r=s??t.previousSnapshot;if(void 0===r)try{r=await $(e,t),d.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,i-1),l=L(r),y={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:a,dataVersion:n,changes:[],fullSnapshot:r,previousSnapshot:r,snapshotHash:l,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(c.changeLogs).values(y),a}async function K({data:e,broadcastAction:t,client:i}){let s={success:!1};try{let r=await T(e);!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!a.Z(e.userId))throw Error("Invalid userId");if(f.includes(e.entityType)){if(Object.values(p).map(t=>e[t]).filter(e=>null!=e).length)throw Error(`No foreign keys should be provided for entityType ${e.entityType}`);return}let t=p[e.entityType];if(!t)throw Error(`Unknown entityType ${e.entityType}`);let i=e[t];if(!i||"string"!=typeof i||!a.Z(i))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(i!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let n=h[e.entityType]||[];for(let t of n){let i=e[t];if(null!=i&&("string"!=typeof i||!a.Z(i)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(p).map(([t,i])=>({type:t,key:i,value:e[i]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!n.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(r);let y=async e=>{var t;let i,s,a;await w(e,r.entityType,r.entityId);let l=o.Z(),y=(t=r.entityType,I.includes(t)),u=Number.isFinite(r.version)?Number(r.version):null,g=Number.isFinite(r.dataVersion)?Number(r.dataVersion):null;if(y){let t=await _(e,r.entityId,r.entityType);if(s=t,i=(t??0)+1,a=await E({client:e,data:r,computedVersion:i,dataVersion:g,baselineSnapshot:r.baselineSnapshot}),null!==u&&u!==i){if(u<i);else throw d.Z.error("saveChangeLog versionless mismatch",{entityType:r.entityType,entityId:r.entityId,providedVersion:u,latestChangeLogVersion:t,computedVersion:i}),Error(`Provided version (${r.version}) does not match expected changelog version (${i}) for versionless entity ${r.entityType}`)}}else{let t=r.entityType,n=await C(e,{...r,entityType:t}),o=m[t],l=await _(e,r.entityId,r.entityType);if(s=l,Number.isFinite(l)){let e=Number(l)+1;i=n<=Number(l)?e:n}else i=n;if(a=await E({client:e,data:r,computedVersion:i,dataVersion:g,baselineSnapshot:r.baselineSnapshot}),null!==u&&u!==i){if(u<i);else throw d.Z.error("saveChangeLog version mismatch",{entityType:r.entityType,entityId:r.entityId,providedVersion:u,entityVersion:n,latestChangeLogVersion:l,computedVersion:i}),Error(`Provided version (${r.version}) does not match ${o.entityLabel} version (${i})`)}}let p=r.snapshotHash||L(r.fullSnapshot);if(!p)throw Error("snapshotHash is required");let h=r.previousSnapshot??r.baselineSnapshot??{},f={changeLogId:l,entityId:r.entityId,entityType:r.entityType,action:r.action,version:i,dataVersion:g,changes:r.changes||[],fullSnapshot:r.fullSnapshot||{},previousSnapshot:h,snapshotHash:p,description:r.description,changeReason:r.changeReason,parentVersion:r.parentVersion??(void 0===s?a:s),mergedFromVersion:r.mergedFromVersion,isActive:!1!==r.isActive,userId:r.userId,scriptId:r.scriptId,screenId:r.screenId,diagnosisId:r.diagnosisId,configKeyId:r.configKeyId,hospitalId:r.hospitalId,drugsLibraryItemId:r.drugsLibraryItemId,dataKeyId:r.dataKeyId,aliasId:r.aliasId,dateOfChange:new Date},[v]=await e.insert(c.changeLogs).values(f).returning();return v&&v.entityId&&Number.isFinite(v.version)&&await e.update(c.changeLogs).set({isActive:!1,supersededBy:v.version,supersededAt:v.dateOfChange??new Date}).where((0,n.xD)((0,n.eq)(c.changeLogs.entityId,v.entityId),(0,n.eq)(c.changeLogs.entityType,v.entityType),(0,n.lt)(c.changeLogs.version,v.version),(0,n.eq)(c.changeLogs.isActive,!0))),v},g=i?await y(i):await l.Z.transaction(y);return s.success=!0,s.data=g,t&&u.Z.emit("data_changed","save_change_log"),s}catch(e){return s.success=!1,s.errors=[e.message],d.Z.error("_saveChangeLog ERROR",e.message),s}}async function Z({data:e,broadcastAction:t,allowPartial:i}){let n=0,s=[];try{if(i&&e.some(e=>"rollback"===e.action))throw Error("allowPartial is not permitted for rollback changelog writes");if(i)for(let t of e){let e=await K({data:t});if(e.errors?.length){s.push(...e.errors);continue}n++}else await l.Z.transaction(async t=>{for(let i of e){let e=await K({data:i,client:t});if(e.errors?.length)throw s.push(...e.errors),Error(s.join(", "));n++}});return t&&!s.length&&u.Z.emit("data_changed","save_change_logs"),{success:!s.length,errors:s.length?s:void 0,saved:n}}catch(e){return d.Z.error("_saveChangeLogs ERROR",e.message),n=0,{success:!1,errors:[e.message],saved:n}}}},88317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});let n=(0,i(94901).io)(process.env.NEXT_PUBLIC_APP_URL)}};