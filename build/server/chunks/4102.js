"use strict";exports.id=4102,exports.ids=[4102],exports.modules={64102:(e,a,t)=>{t.d(a,{F$:()=>c,pG:()=>g,bv:()=>h,Hc:()=>m,MM:()=>y,Jv:()=>u,ZU:()=>v,cQ:()=>K,FG:()=>w});var s=t(57745),r=t(9576),i=t(57435),d=t(10413),n=t(93567),o=t(88317),l=t(16916);async function y({data:e,broadcastAction:a}){let t={success:!1};try{let a=[];for(let{uuid:t,isNewUuid:i,...o}of e.map(e=>({...e,uuid:e.uuid||r.Z(),isNewUuid:!e.uuid})))try{if(!a.length){let e=i?null:await d.Z.query.dataKeysDrafts.findFirst({where:(0,s.eq)(n.dataKeysDrafts.uuid,t)}),a=e||i?null:await d.Z.query.dataKeys.findFirst({where:(0,s.eq)(n.dataKeys.uuid,t)});if(e){let a={...e.data,...o};await d.Z.update(n.dataKeysDrafts).set({data:a,name:a.name}).where((0,s.eq)(n.dataKeysDrafts.uuid,t))}else{let e={...a,...o,uuid:t,version:a?.version?a.version+1:1};await d.Z.insert(n.dataKeysDrafts).values({data:e,uuid:t,dataKeyId:a?.uuid,name:e.name})}}}catch(e){a.push(e.message)}return a.length?t.errors=a:(o.Z.emit("data_changed","save_data_keys"),t.success=!0),t}catch(e){return t.success=!1,t.errors=[e.message],i.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function u({data:e}){try{let a=e.map(e=>e.name).filter(e=>e),t=await (0,l.aW)({names:a});return e=e.filter(e=>{let a=t.data.find(a=>`${a.name||""}`.toLowerCase()===`${e.name||""}`.toLowerCase()),s=t.data.find(a=>`${a.label||""}`.toLowerCase()===`${e.label||""}`.toLowerCase()),r=t.data.find(a=>`${a.dataType||""}`.toLowerCase()===`${e.dataType||""}`.toLowerCase());return!a||!s||!r}),await y({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function c(){try{return await d.Z.delete(n.dataKeysDrafts),!0}catch(e){throw e}}async function g({dataKeysIds:e,broadcastAction:a}){let t={success:!1};try{if(e.length){await d.Z.delete(n.dataKeysDrafts).where((0,s.d3)(n.dataKeysDrafts.uuid,e));let a=(await d.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,s.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,s.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion);a.length&&await d.Z.insert(n.pendingDeletion).values(a)}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],i.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!t?.errors?.length&&a&&o.Z.emit("data_changed","delete_data_keys"),t}}async function p({previous:e,drafts:a}){try{let t=[];for(let s of a){let a={version:s?.data?.version||1,dataKeyId:s?.data?.uuid,changes:{}};if(s?.data?.version===1)a.changes={action:"create_data_key",description:"Create data key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.uuid===s?.data?.uuid)[0],r=[],i=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=s.data[e],d={...t}[e];JSON.stringify(a)!==JSON.stringify(d)&&(r.push({[e]:d}),i.push({[e]:a}))}),a.changes={action:"update_data_key",description:"Update data key",oldValues:r,newValues:i}}t.push(a)}await d.Z.insert(n.dataKeysHistory).values(t)}catch(e){i.Z.error(e.message)}}var f=t(34149);async function m(e){let a={success:!1};try{let e=await d.Z.query.pendingDeletion.findMany({where:(0,s.K0)(n.pendingDeletion.dataKeyId),columns:{dataKeyId:!0},with:{dataKey:{columns:{version:!0,name:!0}}}});if((e=e.filter(e=>e.dataKey)).length){let a=new Date;await d.Z.update(n.dataKeys).set({deletedAt:a,name:(0,f.i6)`CONCAT(${n.dataKeys.name}, '_', ${n.dataKeys.uuid})`}).where((0,s.d3)(n.dataKeys.uuid,e.map(e=>e.dataKeyId))),await d.Z.insert(n.dataKeysHistory).values(e.map(e=>({version:e.dataKey.version,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null,name:e.dataKey.name}],newValues:[{deletedAt:a,name:`${e.dataKey.name}_${e.dataKeyId}`}]}})))}await d.Z.delete(n.pendingDeletion).where((0,s.or)((0,s.K0)(n.pendingDeletion.dataKeyId),(0,s.K0)(n.pendingDeletion.dataKeyDraftId)));let t=[],i=[],o=await d.Z.query.dataKeysDrafts.findMany();if(t=o.filter(e=>e.dataKeyId),i=o.filter(e=>!e.dataKeyId),t.length){let e=[];for(let{dataKeyId:a,data:r}of(t.filter(e=>e.dataKeyId).length&&(e=await d.Z.query.dataKeys.findMany({where:(0,s.d3)(n.dataKeys.uuid,t.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),t)){let{uuid:e,id:t,createdAt:i,updatedAt:o,deletedAt:l,...y}=r,u={...y,publishDate:new Date};await d.Z.update(n.dataKeys).set(u).where((0,s.eq)(n.dataKeys.uuid,a)).returning()}await p({drafts:t,previous:e})}if(i.length){let e=[];for(let{id:a,data:t}of(i.filter(e=>e.dataKeyId).length&&(e=await d.Z.query.dataKeys.findMany({where:(0,s.d3)(n.dataKeys.uuid,i.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),i)){let e=t.uuid||(0,r.Z)(),s={...t,uuid:e};i=i.map(t=>(t.id===a&&(t.data.uuid=e),t)),await d.Z.insert(n.dataKeys).values(s)}await p({drafts:i,previous:e})}await d.Z.delete(n.dataKeysDrafts);let l=[...t.map(e=>e.dataKeyId),...e.map(e=>e.dataKeyId)];l.length&&await d.Z.update(n.dataKeys).set({version:(0,f.i6)`${n.dataKeys.version} + 1`}).where((0,s.d3)(n.dataKeys.uuid,l)),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],i.Z.error("_publishDataKeys ERROR",e)}finally{return a}}async function h(){try{console.log("Fetching screens...");let e=await d.Z.query.screens.findMany();console.log("Fetching screens... DONE"),console.log("Fetching diagnoses...");let a=await d.Z.query.diagnoses.findMany();console.log("Fetching diagnoses... DONE"),console.log("Fetching drugsLibrary...");let t=await d.Z.query.drugsLibrary.findMany();console.log("Fetching drugsLibrary... DONE");let r=K({screens:e,diagnoses:a,drugsLibrary:t});for(let e of(console.log(`Processing extracted keys (${r.length}) ...`),r)){let a=e.parentKeys||[];r.filter(a=>a.name&&e.name&&a.name.toLowerCase()===e.name.toLowerCase()).forEach(e=>{a=[...a,...e.parentKeys]})}if(console.log("Processing extracted keys... DONE"),r=r.map(e=>{let a=e.parentKeys||[];return r.filter(a=>a.name&&e.name&&a.name.toLowerCase()===e.name.toLowerCase()).forEach(e=>{a=[...a,...e.parentKeys]}),{...e,parentKeys:a.filter((e,t)=>a.map(e=>e.toLowerCase()).indexOf(e.toLowerCase())===t)}}).map(e=>("EDLIZSummaryTableScore"===e.name&&(e.dataType=e.dataType||"number"),{...e,label:e.label||""})).filter((e,a)=>r.map(e=>e.name.toLowerCase()).indexOf(e.name.toLowerCase())===a),console.log(`Extracted ${r.length} keys...`),r.length){console.log(`Saving ${r.length} keys...`);let e=await d.Z.select({name:n.dataKeys.name}).from(n.dataKeys).where((0,s.d3)((0,f.i6)`lower(${n.dataKeys.name})`,r.map(e=>e.name.toLowerCase()))),a=await d.Z.select({name:n.dataKeysDrafts.name}).from(n.dataKeysDrafts).where((0,s.d3)((0,f.i6)`lower(${n.dataKeysDrafts.name})`,r.map(e=>e.name.toLowerCase()))),t=[...e,...a];(r=r.filter(e=>!t.map(e=>e.name.toLowerCase()).includes(e.name.toLowerCase()))).length&&await y({data:r})}return{data:{extracted:r.length}}}catch(e){return i.Z.log("db_extract_data_keys",e.message),{data:{extracted:0},errors:[e.message]}}}function K({screens:e=[],diagnoses:a=[],drugsLibrary:t=[]}){let s=[];return console.log("Scrapping screens keys..."),e.forEach(e=>{if(e.key){let a={id:void 0,uuid:(0,r.Z)(),name:e.key,label:e.label||"",dataType:null,parentKeys:[],version:1};switch(e.type){case"timer":a.dataType="timer";break;case"yesno":a.dataType="yesno";break;case"single_select":a.dataType="single_select";break;case"multi_select":a.dataType="multi_select"}s.push(a)}e.items.forEach(a=>{let t=a.id||a.key;if(t){let i={id:void 0,uuid:(0,r.Z)(),name:t,label:a.label||"",dataType:null,parentKeys:e.key?[e.key]:[],version:1,defaults:{dataType:a.subType||void 0,severity_order:a.severity_order||void 0,score:a.score||void 0}};switch(e.type){case"single_select":i.dataType="single_select_option";break;case"multi_select":i.dataType="multi_select_option";break;case"diagnosis":i.dataType="diagnosis";break;case"checklist":i.name=a.key||a.id,i.dataType="checklist_option";break;case"zw_edliz_summary_table":i.dataType="zw_edliz_summary_table_option";break;case"mwi_edliz_summary_table":i.dataType="mwi_edliz_summary_table_option";break;case"edliz_summary_table":i.dataType="edliz_summary_table_option"}s.push(i)}}),e.fields.forEach((a,t)=>{let i={id:void 0,uuid:(0,r.Z)(),name:a.key,label:a.label||"",dataType:a.type,parentKeys:e.key?[e.key]:[],version:1,defaults:{dataType:a.dataType||void 0}};s.push(i),"dropdown"===a.type&&(a.values||"").split("\n").map((e="")=>e.trim()).filter(e=>e).forEach(e=>{e=e.split(","),s.push({uuid:(0,r.Z)(),id:void 0,name:e[0],label:e[1],dataType:"dropdown_option",parentKeys:a.key?[a.key]:[],version:1})})})}),console.log("Scrapping diagnoses keys..."),a.forEach(e=>{e.key&&s.push({id:void 0,uuid:(0,r.Z)(),name:e.key,label:e.name,dataType:"diagnosis",parentKeys:[],version:1})}),console.log("Scrapping drugsLibrary keys..."),t.forEach(e=>{e.key&&s.push({id:void 0,uuid:(0,r.Z)(),name:e.key,label:e.drug,dataType:e.type,parentKeys:[],version:1})}),s}t(5286);let w={synced:{scripts:0,screens:0,diagnoses:0}};async function v(){try{return{data:w}}catch(e){return i.Z.log("db_sync_data_keys",e.message),{data:w,errors:[e.message]}}}},16916:(e,a,t)=>{t.d(a,{gc:()=>g,aW:()=>y});var s=t(57745),r=t(34149),i=t(30900),d=t(9576),n=t(10413),o=t(93567),l=t(57435);async function y(e){try{let{dataKeysIds:a,names:t=[],returnDraftsIfExist:l=!0}={...e},y=a||[],u=t.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),c=[y?.length?(0,s.d3)(o.dataKeysDrafts.uuid,y.map(e=>i.Z(e)?e:d.Z())):void 0,u?.length?(0,s.d3)((0,r.i6)`lower(${o.dataKeysDrafts.name})`,u):void 0].filter(e=>e),g=l?await n.Z.query.dataKeysDrafts.findMany({where:c.length?(0,s.xD)(...c):void 0}):[];y=y.filter(e=>!g.map(e=>e.uuid).includes(e));let p=[(0,s.Ft)(o.dataKeys.deletedAt),(0,s.Ft)(o.pendingDeletion),g.length?(0,s.Nl)(o.dataKeys.uuid,g.map(e=>e.uuid)):void 0,y?.length?(0,s.d3)(o.dataKeys.uuid,y.filter(e=>i.Z(e))):void 0,u?.length?(0,s.d3)((0,r.i6)`lower(${o.dataKeys.name})`,u):void 0].filter(e=>e),f=(await n.Z.select({dataKey:o.dataKeys,pendingDeletion:o.pendingDeletion}).from(o.dataKeys).leftJoin(o.pendingDeletion,(0,s.eq)(o.pendingDeletion.dataKeyId,o.dataKeys.uuid)).where(p.length?(0,s.xD)(...p):void 0)).map(e=>e.dataKey),m=f.length?await n.Z.query.pendingDeletion.findMany({where:(0,s.d3)(o.pendingDeletion.dataKeyId,f.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...f.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!m.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var u=t(60938);let c={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function g(){try{let[{count:e}]=await n.Z.select({count:(0,u.QX)()}).from(o.dataKeysDrafts),[{count:a}]=await n.Z.select({count:(0,u.QX)()}).from(o.dataKeysDrafts).where((0,s.Ft)(o.dataKeysDrafts.dataKeyId)),[{count:t}]=await n.Z.select({count:(0,u.QX)()}).from(o.dataKeysDrafts).where((0,s.K0)(o.dataKeysDrafts.dataKeyId)),[{count:r}]=await n.Z.select({count:(0,u.QX)()}).from(o.pendingDeletion).where((0,s.K0)(o.pendingDeletion.dataKeyId)),[{count:i}]=await n.Z.select({count:(0,u.QX)()}).from(o.dataKeys);return{data:{allPublished:i,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:r}}}catch(e){return l.Z.error("_getDataKeys ERROR",e.message),{data:c,errors:[e.message]}}}},20123:(e,a,t)=>{t.d(a,{Ng:()=>y,_U:()=>p,QF:()=>l,YF:()=>g});var s=t(57745),r=t(81445),i=t(30900),d=t(10413),n=t(93567),o=t(57435);async function l(e){try{let{sitesIds:a,types:t=[],envs:o=[],links:l=[]}={...e},y=a||[],u=y?.length?(0,s.d3)(n.sites.siteId,y.filter(e=>i.Z(e))):void 0;l.length&&[...l].forEach(e=>{l.push(e.replace("http:","https:")),l.push(e.replace("https","http"))});let c=[(0,s.Ft)(n.sites.deletedAt),u,t.length?(0,s.d3)(n.sites.type,t):void 0,o.length?(0,s.d3)(n.sites.env,o):void 0,l.length?(0,s.d3)(n.sites.link,l):void 0];return{data:(await d.Z.select({site:n.sites}).from(n.sites).where(c.length?(0,s.xD)(...c):void 0).orderBy((0,r.d)(n.sites.id))).map(e=>e.site)}}catch(e){return o.Z.error("_getSites ERROR",e.message),{data:[],errors:[e.message]}}}async function y(e){let{siteId:a}={...e};try{if(!a)throw Error("Missing siteId");let e=i.Z(a)?(0,s.eq)(n.sites.siteId,a):void 0;return{data:await d.Z.query.sites.findFirst({where:(0,s.xD)((0,s.Ft)(n.sites.deletedAt),e)})}}catch(e){return o.Z.error("_getSite ERROR",e.message),{errors:[e.message]}}}var u=t(8328);let c=()=>{let e=(0,u.w)();return{webeditor:{name:"Local editor",siteId:"fb76af5a-bf86-4050-821e-44f1bf316bf4",link:e.origin,type:"webeditor",apiKey:"localhost"},nodeapi:{name:"Local editor",siteId:"5cb4aa54-2cfe-49e2-9cdd-392a9b8c124e",link:e.origin,type:"webeditor",apiKey:"localhost"}}};async function g(e){try{let{types:a=[]}={...e},t=[...a.length?[(0,s.d3)(n.sites.type,a)]:[]],r=await d.Z.query.sites.findMany({where:t.length?(0,s.xD)(...t):void 0,columns:{siteId:!0,type:!0,name:!0,link:!0}});return c(),{data:[...r]}}catch(e){return o.Z.error("_getSites ERROR",e.message),{data:[],errors:[e.message]}}}async function p(e){try{let a=await d.Z.query.sites.findFirst({where:(0,s.eq)(n.sites.siteId,e),columns:{apiKey:!0,link:!0}}),t=a||null;if(!a){let a=c();Object.values(a).forEach(a=>{a.siteId===e&&(t={link:a.link,apiKey:a.apiKey})})}return{data:t}}catch(e){return o.Z.error("_getSiteApiKey ERROR",e.message),{data:null,errors:[e.message]}}}},8328:(e,a,t)=>{t.d(a,{w:()=>r});var s=t(71615);function r(){let e=(0,s.headers)(),a=e.get("x-api-key"),t=e.get("x-bearer-token"),r=e.get("x-url"),i=e.get("x-next-url-host"),d=e.get("x-next-url-href"),n=e.get("x-next-url-port"),o=e.get("x-next-url-hostname"),l=e.get("x-next-url-pathname"),y=e.get("x-next-url-search"),u=e.get("x-next-url-protocol"),c=e.get("x-next-url-username"),g=e.get("x-next-url-locale"),p=e.get("x-next-url-origin"),f=e.get("x-geo-city"),m=e.get("x-geo-country");return{apiKey:a,bearerToken:t,url:r||"",host:i||"",href:d||"",port:n||"",hostname:o||"",pathname:l||"",search:y||"",protocol:u||"",username:c||"",locale:g||"",origin:p||"",city:f||"",country:m||"",region:e.get("x-geo-region")||"",latitude:e.get("x-geo-latitude")||"",longitude:e.get("x-geo-longitude")||""}}},5286:(e,a,t)=>{t.d(a,{U:()=>d});var s=t(29712),r=t(57435),i=t(20123);async function d(e,a){let t=a?.link,d=a?.baseURL;if(!e)throw Error("AXIOS init error: missing siteId");if(!a){let a=await (0,i._U)(e);if(a.errors?.length)throw Error("AXIOS init error: "+a.errors.join(", "));if(!a.data)throw Error("AXIOS init error: site not found");t=a.data.link,d=a.data.apiKey}let n=s.Z.create({baseURL:t});return n.interceptors.request.use(async e=>(e.headers&&(e.headers["x-api-key"]=d),r.Z.log(`AXIOS [${e.method}]`,[`${t}/api`,e.url].join("")),e)),n.interceptors.response.use(e=>e,e=>new Promise((a,t)=>t(e))),n}}};