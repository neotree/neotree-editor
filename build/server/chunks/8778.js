"use strict";exports.id=8778,exports.ids=[8778],exports.modules={88778:(e,a,t)=>{t.d(a,{F$:()=>p,pG:()=>g,Hc:()=>D,MM:()=>K,Jv:()=>f,gy:()=>m});var d=t(57745),i=t(9576),s=t(57435),n=t(10413),r=t(93567),l=t(88317),u=t(16916),y=t(927),o=t(10970);async function c({dataKeys:e,broadcastAction:a}){try{let t=a=>e.find(e=>e.uniqueKey===a),{data:d}=await (0,y.uK)(),{data:i}=await (0,y.XA)(),s=d,n=i;n=n.map(e=>{let a=e.key||e.name||"",d=t(e.keyId),i=!!d,s=(e.symptoms||[]).map(e=>{let a=t(e.keyId);return a&&(i=!0),{...e,...a?{key:a.name,name:a.label}:{}}});return{...e,key:a,symptoms:s,updated:i,...d?{key:d.name,name:d.label}:{}}}),s=s.map(e=>{let a=e.refId?t(e.refId):void 0,d=t(e.keyId),i=!!d||!!a,s=e.items.map(e=>{let a=t(e.keyId);a&&(i=!0);let d=e.key?"key":"id";return{...e,...a?{label:a.label,[d]:a.name}:{}}}),n=e.fields.map(e=>{let a=t(e.keyId);return a&&(i=!0),{...e,...a?{key:a.name,label:a.label}:{},items:(e.items||[]).map(e=>{let a=t(e.keyId);return a&&(i=!0),{...e,...a?{value:a.name,label:a.label}:{}}})}});return{...e,updated:i,items:s,fields:n,...d?{key:d.name,label:d.label}:{},...a?{refId:a.name}:{}}}),n=n.filter(e=>e.updated).map(({updated:e,...a})=>a),s=s.filter(e=>e.updated).map(({updated:e,...a})=>a),n.length&&await (0,o.Pk)({data:n}),s.length&&await (0,o.uD)({data:s});let r=n.length||s.length;return a&&r&&l.Z.emit("data_changed","save_scripts"),{success:!0}}catch(e){return s.Z.error("_updateDataKeysRefs ERROR",e.message),{success:!1,errors:[e.message]}}}async function K({data:e,broadcastAction:a}){let t={success:!1};try{let s=[],y=e.map(e=>({...e,uuid:e.uuid||i.Z(),isNewUuid:!e.uuid})),o=[];for(let{uuid:e,isNewUuid:a,...t}of y)try{if(t.name=`${t.name||""}`.trim(),t.label=`${t.label||""}`.trim(),!s.length){let s=a?null:await n.Z.query.dataKeysDrafts.findFirst({where:(0,d.or)((0,d.eq)(r.dataKeysDrafts.uuid,e),t.uniqueKey?(0,d.eq)(r.dataKeysDrafts.uniqueKey,t.uniqueKey):void 0)}),l=s||a?null:await n.Z.query.dataKeys.findFirst({where:(0,d.eq)(r.dataKeys.uuid,e)});if(s){let a={...s.data,...t};await n.Z.update(r.dataKeysDrafts).set({data:a,name:a.name,uniqueKey:a.uniqueKey}).where((0,d.eq)(r.dataKeysDrafts.uuid,e)),a.uniqueKey&&o.push(a.uniqueKey)}else{let a=l?.uniqueKey||t.uniqueKey||i.Z(),d={...l,...t,uniqueKey:a,uuid:e,version:l?.version?l.version+1:1};await n.Z.insert(r.dataKeysDrafts).values({data:d,uuid:e,dataKeyId:l?.uuid,name:d.name,uniqueKey:a}),o.push(d.uniqueKey)}}}catch(e){s.push(e.message)}if(s.length)t.errors=s;else{if(o.length){let{data:e}=await (0,u.aW)({uniqueKeys:o});await c({dataKeys:e,broadcastAction:a})}l.Z.emit("data_changed","save_data_keys"),t.success=!0}return t}catch(e){return t.success=!1,t.errors=[e.message],s.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function f({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,u.aW)({uniqueKeys:a});return e=e.filter(e=>!t.data.find(a=>a.uniqueKey===e.uniqueKey)),await K({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function m({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,u.aW)({uniqueKeys:a});return await K({data:e.map(e=>{let a=t.data.find(a=>a.uniqueKey===e.uniqueKey);return console.log("existing?.uuid",a?.uuid),{...e,uuid:a?.uuid,id:a?.id,createdAt:a?.createdAt,updatedAt:a?.updatedAt,publishDate:a?.publishDate,deletedAt:a?.deletedAt,version:a?.version}})})}catch(e){return{success:!1,errors:[e.message]}}}async function p(){try{return await n.Z.delete(r.dataKeysDrafts),!0}catch(e){throw e}}async function g({dataKeysIds:e,broadcastAction:a}){let t={success:!1};try{if(e.length){await n.Z.delete(r.dataKeysDrafts).where((0,d.d3)(r.dataKeysDrafts.uuid,e));let a=(await n.Z.select({dataKeyId:r.dataKeys.uuid,pendingDeletion:r.pendingDeletion.dataKeyId}).from(r.dataKeys).leftJoin(r.pendingDeletion,(0,d.eq)(r.pendingDeletion.dataKeyId,r.dataKeys.uuid)).where((0,d.d3)(r.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion);a.length&&await n.Z.insert(r.pendingDeletion).values(a)}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],s.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!t?.errors?.length&&a&&l.Z.emit("data_changed","delete_data_keys"),t}}async function h({previous:e,drafts:a}){try{let t=[];for(let d of a){let a={version:d?.data?.version||1,dataKeyId:d?.data?.uuid,changes:{}};if(d?.data?.version===1)a.changes={action:"create_data_key",description:"Create data key",oldValues:[],newValues:[]};else{let t=e.filter(e=>e.uuid===d?.data?.uuid)[0],i=[],s=[];Object.keys({...d?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=d.data[e],n={...t}[e];JSON.stringify(a)!==JSON.stringify(n)&&(i.push({[e]:n}),s.push({[e]:a}))}),a.changes={action:"update_data_key",description:"Update data key",oldValues:i,newValues:s}}t.push(a)}await n.Z.insert(r.dataKeysHistory).values(t)}catch(e){s.Z.error(e.message)}}var w=t(34149);async function D(e){let a={success:!1};try{let e=await n.Z.query.pendingDeletion.findMany({where:(0,d.K0)(r.pendingDeletion.dataKeyId),columns:{dataKeyId:!0},with:{dataKey:{columns:{version:!0}}}});if((e=e.filter(e=>e.dataKey)).length){let a=new Date;await n.Z.update(r.dataKeys).set({deletedAt:a}).where((0,d.d3)(r.dataKeys.uuid,e.map(e=>e.dataKeyId))),await n.Z.insert(r.dataKeysHistory).values(e.map(e=>({version:e.dataKey.version,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:a}]}})))}await n.Z.delete(r.pendingDeletion).where((0,d.or)((0,d.K0)(r.pendingDeletion.dataKeyId),(0,d.K0)(r.pendingDeletion.dataKeyDraftId)));let t=[],s=[],l=await n.Z.query.dataKeysDrafts.findMany();if(t=l.filter(e=>e.dataKeyId),s=l.filter(e=>!e.dataKeyId),t.length){let e=[];for(let{dataKeyId:a,data:i}of(t.filter(e=>e.dataKeyId).length&&(e=await n.Z.query.dataKeys.findMany({where:(0,d.d3)(r.dataKeys.uuid,t.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),t)){let{uuid:e,id:t,createdAt:s,updatedAt:l,deletedAt:u,...y}=i,o={...y,publishDate:new Date};await n.Z.update(r.dataKeys).set(o).where((0,d.eq)(r.dataKeys.uuid,a)).returning()}await h({drafts:t,previous:e})}if(s.length){let e=[];for(let{id:a,data:t}of(s.filter(e=>e.dataKeyId).length&&(e=await n.Z.query.dataKeys.findMany({where:(0,d.d3)(r.dataKeys.uuid,s.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),s)){let e=t.uuid||(0,i.Z)(),d={...t,uuid:e};s=s.map(t=>(t.id===a&&(t.data.uuid=e),t)),await n.Z.insert(r.dataKeys).values(d)}await h({drafts:s,previous:e})}await n.Z.delete(r.dataKeysDrafts);let u=[...t.map(e=>e.dataKeyId),...e.map(e=>e.dataKeyId)];u.length&&await n.Z.update(r.dataKeys).set({version:(0,w.i6)`${r.dataKeys.version} + 1`}).where((0,d.d3)(r.dataKeys.uuid,u)),a.success=!0}catch(e){a.success=!1,a.errors=[e.message],s.Z.error("_publishDataKeys ERROR",e)}finally{return a}}},16916:(e,a,t)=>{t.d(a,{gc:()=>K,aW:()=>y});var d=t(57745),i=t(34149),s=t(30900),n=t(9576),r=t(10413),l=t(93567),u=t(57435);async function y(e){try{let{keys:a=[],dataKeysIds:t,names:u=[],uniqueKeys:y=[],returnDraftsIfExist:o=!0}={...e},c=t||[],K=u.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),f=y.filter(e=>e),m=[];if(a.length)m=(m=(m=await r.Z.query.dataKeysDrafts.findMany()).filter(e=>!c.length||c.includes(e.uuid)).filter(e=>!K.length||K.includes(e.name)).filter(e=>!f.length||f.includes(e.uniqueKey))).filter(e=>a.map(e=>JSON.stringify({name:e.name,label:e.label,dataType:e.dataType}).toLowerCase()).includes(JSON.stringify({name:e.data.name,label:e.data.label,dataType:e.data.dataType}).toLowerCase()));else{let e=[c?.length?(0,d.d3)(l.dataKeysDrafts.uuid,c.map(e=>s.Z(e)?e:n.Z())):void 0,K?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeysDrafts.name})`,K):void 0,f?.length?(0,d.d3)(l.dataKeysDrafts.uniqueKey,f):void 0].filter(e=>e);m=o?await r.Z.query.dataKeysDrafts.findMany({where:e.length?(0,d.xD)(...e):void 0}):[]}c=c.filter(e=>!m.map(e=>e.uuid).includes(e));let p=[(0,d.Ft)(l.dataKeys.deletedAt),(0,d.Ft)(l.pendingDeletion),m.length?(0,d.Nl)(l.dataKeys.uuid,m.map(e=>e.uuid)):void 0,a.length?(0,d.d3)((0,i.i6)`lower(concat(${l.dataKeys.name},',',${l.dataKeys.label},',',${l.dataKeys.dataType}))`,a.map(e=>`${e.name},${e.label},${e.dataType}`.toLowerCase())):void 0,c?.length?(0,d.d3)(l.dataKeys.uuid,c.filter(e=>s.Z(e))):void 0,K?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeys.name})`,K):void 0,f?.length?(0,d.d3)(l.dataKeys.uniqueKey,f):void 0].filter(e=>e),g=(await r.Z.select({dataKey:l.dataKeys,pendingDeletion:l.pendingDeletion}).from(l.dataKeys).leftJoin(l.pendingDeletion,(0,d.eq)(l.pendingDeletion.dataKeyId,l.dataKeys.uuid)).where(p.length?(0,d.xD)(...p):void 0)).map(e=>e.dataKey),h=g.length?await r.Z.query.pendingDeletion.findMany({where:(0,d.d3)(l.pendingDeletion.dataKeyId,g.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[];return{data:[...g.map(e=>({...e,isDraft:!1,isDeleted:!1})),...m.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!h.map(e=>e.dataKeyId).includes(e.uuid))}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var o=t(60938);let c={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function K(){try{let[{count:e}]=await r.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts),[{count:a}]=await r.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts).where((0,d.Ft)(l.dataKeysDrafts.dataKeyId)),[{count:t}]=await r.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts).where((0,d.K0)(l.dataKeysDrafts.dataKeyId)),[{count:i}]=await r.Z.select({count:(0,o.QX)()}).from(l.pendingDeletion).where((0,d.K0)(l.pendingDeletion.dataKeyId)),[{count:s}]=await r.Z.select({count:(0,o.QX)()}).from(l.dataKeys);return{data:{allPublished:s,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:i}}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:c,errors:[e.message]}}}}};