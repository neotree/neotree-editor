"use strict";exports.id=8778,exports.ids=[8778],exports.modules={88778:(e,a,t)=>{t.d(a,{F$:()=>h,pG:()=>g,Hc:()=>I,MM:()=>K,Jv:()=>f,gy:()=>p});var d=t(57745),i=t(9576),s=t(57435),r=t(10413),n=t(93567),l=t(88317),u=t(16916),y=t(21162),o=t(45241);async function c({dataKeys:e,broadcastAction:a,userId:t}){try{let d=a=>e.find(e=>e.uniqueKey===a),{data:i}=await (0,y.uK)(),{data:s}=await (0,y.XA)(),r=i,n=s;n=n.map(e=>{let a=e.key||e.name||"",t=d(e.keyId),i=!!t,s=(e.symptoms||[]).map(e=>{let a=d(e.keyId);return a&&(i=!0),{...e,...a?{key:a.name,name:a.label}:{}}});return{...e,key:a,symptoms:s,updated:i,...t?{key:t.name,name:t.label}:{}}}),r=r.map(e=>{let a=e.refId?d(e.refId):void 0,t=d(e.keyId),i=!!t||!!a,s=e.items.map(e=>{let a=d(e.keyId);a&&(i=!0);let t=e.key?"key":"id";return{...e,...a?{label:a.label,[t]:a.name}:{}}}),r=e.fields.map(e=>{let a=d(e.keyId);return a&&(i=!0),{...e,...a?{key:a.name,label:a.label}:{},items:(e.items||[]).map(e=>{let a=d(e.keyId);return a&&(i=!0),{...e,...a?{value:a.name,label:a.label}:{}}})}});return{...e,updated:i,items:s,fields:r,...t?{key:t.name,label:t.label}:{},...a?{refId:a.name}:{}}}),n=n.filter(e=>e.updated).map(({updated:e,...a})=>a),r=r.filter(e=>e.updated).map(({updated:e,...a})=>a),n.length&&await (0,o.Pk)({data:n,userId:t}),r.length&&await (0,o.uD)({data:r,userId:t});let u=n.length||r.length;return a&&u&&l.Z.emit("data_changed","save_scripts"),{success:!0}}catch(e){return s.Z.error("_updateDataKeysRefs ERROR",e.message),{success:!1,errors:[e.message]}}}async function K({data:e,broadcastAction:a,updateRefs:t=!0,userId:y}){let o={success:!1};try{let s=[],K=e.map(e=>({...e,uuid:e.uuid||i.Z(),isNewUuid:!e.uuid})),f=[];for(let{uuid:e,isNewUuid:a,createdAt:t,publishDate:l,deletedAt:u,updatedAt:o,...c}of K)try{if(c.name=`${c.name||""}`.trim(),c.label=`${c.label||""}`.trim(),!s.length){let t=a?null:await r.Z.query.dataKeysDrafts.findFirst({where:(0,d.or)((0,d.eq)(n.dataKeysDrafts.uuid,e),c.uniqueKey?(0,d.eq)(n.dataKeysDrafts.uniqueKey,c.uniqueKey):void 0)}),s=t||a?null:await r.Z.query.dataKeys.findFirst({where:(0,d.or)((0,d.eq)(n.dataKeys.uuid,e),c.uniqueKey?(0,d.eq)(n.dataKeys.uniqueKey,c.uniqueKey):void 0)});if(t){let a={...t.data,...c};await r.Z.update(n.dataKeysDrafts).set({data:a,name:a.name,uniqueKey:a.uniqueKey}).where((0,d.eq)(n.dataKeysDrafts.uuid,e)),a.uniqueKey&&f.push(a.uniqueKey)}else{let a=s?.uniqueKey||c.uniqueKey||i.Z(),t={...s,...c,uniqueKey:a,uuid:e,version:s?.version?s.version+1:1};await r.Z.insert(n.dataKeysDrafts).values({data:t,uuid:e,dataKeyId:s?.uuid,name:t.name,uniqueKey:a,createdByUserId:y}),f.push(t.uniqueKey)}}}catch(e){s.push(e.message)}if(s.length)o.errors=s;else{if(t&&f.length){let{data:e}=await (0,u.aW)({uniqueKeys:f});await c({dataKeys:e,broadcastAction:a,userId:y})}l.Z.emit("data_changed","save_data_keys"),o.success=!0}return o}catch(e){return o.success=!1,o.errors=[e.message],s.Z.error("_saveDataKeys ERROR",e.message),{success:!1,errors:[e.message]}}}async function f({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,u.aW)({uniqueKeys:a});return e=e.filter(e=>!t.data.find(a=>a.uniqueKey===e.uniqueKey)),await K({data:e.map(e=>({...e,uuid:void 0,id:void 0,createdAt:void 0,updatedAt:void 0,publishDate:void 0,deletedAt:void 0,version:void 0}))})}catch(e){return{success:!1,errors:[e.message]}}}async function p({data:e}){try{let a=e.map(e=>e.uniqueKey).filter(e=>e),t=await (0,u.aW)({uniqueKeys:a});return await K({data:e.map(e=>{let a=t.data.find(a=>a.uniqueKey===e.uniqueKey);return console.log("existing?.uuid",a?.uuid),{...e,uuid:a?.uuid,id:a?.id,createdAt:a?.createdAt,updatedAt:a?.updatedAt,publishDate:a?.publishDate,deletedAt:a?.deletedAt,version:a?.version}})})}catch(e){return{success:!1,errors:[e.message]}}}async function h(e){try{return await r.Z.delete(n.dataKeysDrafts).where(e?.userId?(0,d.eq)(n.dataKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function g({dataKeysIds:e,broadcastAction:a,userId:t}){let i={success:!1};try{if(e.length){await r.Z.delete(n.dataKeysDrafts).where((0,d.d3)(n.dataKeysDrafts.uuid,e));let a=(await r.Z.select({dataKeyId:n.dataKeys.uuid,pendingDeletion:n.pendingDeletion.dataKeyId}).from(n.dataKeys).leftJoin(n.pendingDeletion,(0,d.eq)(n.pendingDeletion.dataKeyId,n.dataKeys.uuid)).where((0,d.d3)(n.dataKeys.uuid,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:t}));a.length&&await r.Z.insert(n.pendingDeletion).values(a)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],s.Z.error("_deleteDataKeys ERROR",e.message)}finally{return!i?.errors?.length&&a&&l.Z.emit("data_changed","delete_data_keys"),i}}async function m({previous:e,drafts:a,userId:t}){let d=[];try{let i=[];for(let s of a){let a=s?.data?.uuid;if(!a)continue;let r=1===(s?.data?.version||1),n=r?"Create data key":"Update data key",l={action:r?"create_data_key":"update_data_key",description:n,oldValues:[],newValues:[]},u=s?.data?.version||1,y={version:u,dataKeyId:a,changes:l};if(!r){let t=e.find(e=>e.uuid===a);Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let a=s.data[e],d={...t}[e];JSON.stringify(a)!==JSON.stringify(d)&&(l.oldValues.push({[e]:d}),l.newValues.push({[e]:a}))})}if(i.push(y),t){let i=JSON.parse(JSON.stringify(s.data||{})),y=r?{}:JSON.parse(JSON.stringify(e.find(e=>e.uuid===a)||{}));d.push({entityId:a,entityType:"data_key",action:r?"create":"update",version:u,changes:l,fullSnapshot:i,previousSnapshot:y,baselineSnapshot:y,description:n,userId:t,dataKeyId:a})}}i.length&&await r.Z.insert(n.dataKeysHistory).values(i)}catch(e){s.Z.error(e.message)}return d}var w=t(34149),D=t(36864);async function I(e){let a={success:!1},t=[];try{let l=await r.Z.query.pendingDeletion.findMany({where:(0,d.xD)((0,d.K0)(n.pendingDeletion.dataKeyId),e?.userId?(0,d.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0),columns:{dataKeyId:!0},with:{dataKey:!0}});if((l=l.filter(e=>e.dataKey)).length){let a=new Date;await r.Z.update(n.dataKeys).set({deletedAt:a}).where((0,d.d3)(n.dataKeys.uuid,l.map(e=>e.dataKeyId)));let i=l.map(e=>({version:(e.dataKey?.version??0)+1,dataKeyId:e.dataKeyId,changes:{action:"delete_data_key",description:"Delete data key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:a}]}}));if(await r.Z.insert(n.dataKeysHistory).values(i),e?.publisherUserId)for(let d=0;d<l.length;d++){let s=l[d],r=i[d];if(!s?.dataKeyId)continue;let n={...s.dataKey??{},deletedAt:a},u=r.version||(s.dataKey?.version??0)+1;t.push({entityId:s.dataKeyId,entityType:"data_key",action:"delete",version:u,dataVersion:e.dataVersion,changes:r.changes,fullSnapshot:JSON.parse(JSON.stringify(n)),description:r.changes.description,userId:e.publisherUserId,dataKeyId:s.dataKeyId,isActive:!1})}}await r.Z.delete(n.pendingDeletion).where((0,d.xD)((0,d.or)((0,d.K0)(n.pendingDeletion.dataKeyId),(0,d.K0)(n.pendingDeletion.dataKeyDraftId)),e?.userId?(0,d.eq)(n.pendingDeletion.createdByUserId,e.userId):void 0));let u=[],y=[],o=await r.Z.query.dataKeysDrafts.findMany({where:e?.userId?(0,d.eq)(n.dataKeysDrafts.createdByUserId,e?.userId):void 0});if(u=o.filter(e=>e.dataKeyId),y=o.filter(e=>!e.dataKeyId),u.length){let a=[];for(let{dataKeyId:e,data:t}of(u.filter(e=>e.dataKeyId).length&&(a=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,u.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),u)){let{uuid:a,id:i,createdAt:s,updatedAt:l,deletedAt:u,...y}=t,o={...y,publishDate:new Date};await r.Z.update(n.dataKeys).set(o).where((0,d.eq)(n.dataKeys.uuid,e)).returning()}let i=await m({drafts:u,previous:a,userId:e?.publisherUserId});t.push(...i.map(a=>({...a,dataVersion:e?.dataVersion})))}if(y.length){let a=[];for(let{id:e,data:t}of(y.filter(e=>e.dataKeyId).length&&(a=await r.Z.query.dataKeys.findMany({where:(0,d.d3)(n.dataKeys.uuid,y.filter(e=>e.dataKeyId).map(e=>e.dataKeyId))})),y)){let a=t.uuid||(0,i.Z)(),{id:d,...s}={...t,uuid:a};y=y.map(t=>(t.id===e&&(t.data.uuid=a),t)),await r.Z.insert(n.dataKeys).values(s)}let s=await m({drafts:y,previous:a,userId:e?.publisherUserId});t.push(...s.map(a=>({...a,dataVersion:e?.dataVersion})))}await r.Z.delete(n.dataKeysDrafts).where(e?.userId?(0,d.eq)(n.dataKeysDrafts.createdByUserId,e.userId):void 0);let c=[...u.map(e=>e.dataKeyId),...l.map(e=>e.dataKeyId)];if(c.length&&await r.Z.update(n.dataKeys).set({version:(0,w.i6)`${n.dataKeys.version} + 1`}).where((0,d.d3)(n.dataKeys.uuid,c)),t.length){let e=await (0,D.F)({data:t,allowPartial:!0});e.errors?.length&&s.Z.error("_publishDataKeys changelog warnings",e.errors.join(", "))}a.success=!0}catch(e){a.success=!1,a.errors=[e.message],s.Z.error("_publishDataKeys ERROR",e)}finally{return a}}},16916:(e,a,t)=>{t.d(a,{gc:()=>K,aW:()=>y});var d=t(57745),i=t(34149),s=t(30900),r=t(9576),n=t(10413),l=t(93567),u=t(57435);async function y(e){try{let{keys:a=[],dataKeysIds:t,names:u=[],uniqueKeys:y=[],returnDraftsIfExist:o=!0,pagination:c}={...e},K=t||[],f=u.map(e=>`${e||""}`.toLowerCase()).filter(e=>e),p=y.filter(e=>e),h=[];if(a.length)h=(h=(h=await n.Z.query.dataKeysDrafts.findMany()).filter(e=>!K.length||K.includes(e.uuid)).filter(e=>!f.length||f.includes(e.name)).filter(e=>!p.length||p.includes(e.uniqueKey))).filter(e=>a.map(e=>JSON.stringify({name:e.name,label:e.label,dataType:e.dataType}).toLowerCase()).includes(JSON.stringify({name:e.data.name,label:e.data.label,dataType:e.data.dataType}).toLowerCase()));else{let e=[K?.length?(0,d.d3)(l.dataKeysDrafts.uuid,K.map(e=>s.Z(e)?e:r.Z())):void 0,f?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeysDrafts.name})`,f):void 0,p?.length?(0,d.d3)(l.dataKeysDrafts.uniqueKey,p):void 0].filter(e=>e);h=o?await n.Z.query.dataKeysDrafts.findMany({where:e.length?(0,d.xD)(...e):void 0}):[]}K=K.filter(e=>!h.map(e=>e.uuid).includes(e));let g=[(0,d.Ft)(l.dataKeys.deletedAt),(0,d.Ft)(l.pendingDeletion),h.length?(0,d.Nl)(l.dataKeys.uuid,h.map(e=>e.uuid)):void 0,a.length?(0,d.d3)((0,i.i6)`lower(concat(${l.dataKeys.name},',',${l.dataKeys.label},',',${l.dataKeys.dataType}))`,a.map(e=>`${e.name},${e.label},${e.dataType}`.toLowerCase())):void 0,K?.length?(0,d.d3)(l.dataKeys.uuid,K.filter(e=>s.Z(e))):void 0,f?.length?(0,d.d3)((0,i.i6)`lower(${l.dataKeys.name})`,f):void 0,p?.length?(0,d.d3)(l.dataKeys.uniqueKey,p):void 0].filter(e=>e),m=(await n.Z.select({dataKey:l.dataKeys,pendingDeletion:l.pendingDeletion}).from(l.dataKeys).leftJoin(l.pendingDeletion,(0,d.eq)(l.pendingDeletion.dataKeyId,l.dataKeys.uuid)).where(g.length?(0,d.xD)(...g):void 0)).map(e=>e.dataKey),w=m.length?await n.Z.query.pendingDeletion.findMany({where:(0,d.d3)(l.pendingDeletion.dataKeyId,m.map(e=>e.uuid)),columns:{dataKeyId:!0}}):[],D=[...m.map(e=>({...e,isDraft:!1,isDeleted:!1})),...h.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,a)=>{let t=0;return e.label<a.label&&(t=-1),e.label>a.label&&(t=1),t}).filter(e=>!w.map(e=>e.dataKeyId).includes(e.uuid));if(c){let{limit:e,page:a}=c,t=function(e,a,t){let d=e.length,i=(a-1)*t;return{data:e.slice(i,i+t),pagination:{page:a,limit:t,total:d,totalPages:Math.ceil(d/t)}}}(D,a,e);return{data:t.data,pagination:t.pagination}}return{data:D}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:[],errors:[e.message]}}}var o=t(60938);let c={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function K(){try{let[{count:e}]=await n.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts),[{count:a}]=await n.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts).where((0,d.Ft)(l.dataKeysDrafts.dataKeyId)),[{count:t}]=await n.Z.select({count:(0,o.QX)()}).from(l.dataKeysDrafts).where((0,d.K0)(l.dataKeysDrafts.dataKeyId)),[{count:i}]=await n.Z.select({count:(0,o.QX)()}).from(l.pendingDeletion).where((0,d.K0)(l.pendingDeletion.dataKeyId)),[{count:s}]=await n.Z.select({count:(0,o.QX)()}).from(l.dataKeys);return{data:{allPublished:s,publishedWithDrafts:t,allDrafts:e,newDrafts:a,pendingDeletion:i}}}catch(e){return u.Z.error("_getDataKeys ERROR",e.message),{data:c,errors:[e.message]}}}}};