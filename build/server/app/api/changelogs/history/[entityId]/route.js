(()=>{var e={};e.id=720,e.ids=[720],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},96119:e=>{"use strict";e.exports=require("perf_hooks")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},58359:()=>{},93739:()=>{},54254:(e,t,i)=>{"use strict";i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>I,requestAsyncStorage:()=>p,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var s={};i.r(s),i.d(s,{GET:()=>c});var r=i(49303),n=i(88716),a=i(60670),o=i(87070),d=i(57435),l=i(72761),u=i(48298);async function c(e,{params:t}){try{if(!(await (0,l.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]},{status:401});let i=JSON.parse(e.nextUrl.searchParams.get("data")||"{}"),s=await (0,u.getEntityHistory)({entityId:t.entityId,...i});return o.NextResponse.json(s)}catch(e){return d.Z.error("[GET] /api/changelogs/history/[entityId]",e.message),o.NextResponse.json({errors:["Internal Error"]})}}let y=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/changelogs/history/[entityId]/route",pathname:"/api/changelogs/history/[entityId]",filename:"route",bundlePath:"app/api/changelogs/history/[entityId]/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/changelogs/history/[entityId]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:h}=y,f="/api/changelogs/history/[entityId]/route";function I(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},36864:(e,t,i)=>{"use strict";i.d(t,{C:()=>x,F:()=>w});var s=i(57745),r=i(81445),n=i(84770),a=i(30900),o=i(9576),d=i(57435),l=i(10413),u=i(93567),c=i(88317);let y={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},p={screen:["scriptId"],diagnosis:["scriptId"]},g=["alias"],h={script:{table:u.scripts,idColumn:u.scripts.scriptId,versionColumn:u.scripts.version,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,versionColumn:u.screens.version,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,versionColumn:u.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,versionColumn:u.configKeys.version,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,versionColumn:u.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,versionColumn:u.dataKeys.version,entityLabel:"data key"},hospital:{table:u.hospitals,idColumn:u.hospitals.hospitalId,versionColumn:u.hospitals.version,entityLabel:"hospital"}},f={script:{table:u.scripts,idColumn:u.scripts.scriptId,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,entityLabel:"data key"},alias:{table:u.aliases,idColumn:u.aliases.uuid,entityLabel:"alias"},hospital:{table:u.hospitals,idColumn:u.hospitals.hospitalId,entityLabel:"hospital"}};function I(e){return(0,n.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function m(e,t){let i=h[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let r=await e.select({version:i.versionColumn}).from(i.table).where((0,s.eq)(i.idColumn,t.entityId)).limit(1),n=r?.[0]?.version;if(!Number.isFinite(n))throw Error(`Missing ${i.entityLabel} or version for entityId ${t.entityId}`);return Number(n)}async function v(e,t,i){let n=await e.select({version:u.changeLogs.version}).from(u.changeLogs).where((0,s.xD)((0,s.eq)(u.changeLogs.entityId,t),(0,s.eq)(u.changeLogs.entityType,i))).orderBy((0,r.C)(u.changeLogs.version)).limit(1);return n?.[0]?.version}async function b(e,t){let i=f[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let r=await e.select().from(i.table).where((0,s.eq)(i.idColumn,t.entityId)).limit(1);if(!r?.[0])throw Error(`Entity not found for snapshot (${i.entityLabel} ${t.entityId})`);return r[0]}async function L({client:e,data:t,computedVersion:i,dataVersion:s,baselineSnapshot:r}){if(Number.isFinite(await v(e,t.entityId,t.entityType)))return;let n=r??t.previousSnapshot;if(void 0===n)try{n=await b(e,t),d.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,i-1),l=I(n),c={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:a,dataVersion:s,changes:[],fullSnapshot:n,previousSnapshot:n,snapshotHash:l,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(u.changeLogs).values(c),a}async function x({data:e,broadcastAction:t,client:i}){let r={success:!1};try{!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!a.Z(e.userId))throw Error("Invalid userId");let t=y[e.entityType],i=e[t];if(!i||"string"!=typeof i||!a.Z(i))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(i!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let s=p[e.entityType]||[];for(let t of s){let i=e[t];if(null!=i&&("string"!=typeof i||!a.Z(i)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(y).map(([t,i])=>({type:t,key:i,value:e[i]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!s.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let n=async t=>{var i;let r,n,a;let l=o.Z(),c=(i=e.entityType,g.includes(i)),y=Number.isFinite(e.version)?Number(e.version):null,p=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(c){let i=await v(t,e.entityId,e.entityType);if(n=i,r=(i??0)+1,a=await L({client:t,data:e,computedVersion:r,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==r){if(y<r);else throw d.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,latestChangeLogVersion:i,computedVersion:r}),Error(`Provided version (${e.version}) does not match expected changelog version (${r}) for versionless entity ${e.entityType}`)}}else{let i=e.entityType,s=await m(t,{...e,entityType:i}),o=h[i],l=await v(t,e.entityId,e.entityType);if(n=l,Number.isFinite(l)){let e=Number(l)+1;r=s<=Number(l)?e:s}else r=s;if(a=await L({client:t,data:e,computedVersion:r,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==r){if(y<r);else throw d.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,entityVersion:s,latestChangeLogVersion:l,computedVersion:r}),Error(`Provided version (${e.version}) does not match ${o.entityLabel} version (${r})`)}}let f=e.snapshotHash||I(e.fullSnapshot);if(!f)throw Error("snapshotHash is required");let b=e.previousSnapshot??e.baselineSnapshot??{},x={changeLogId:l,entityId:e.entityId,entityType:e.entityType,action:e.action,version:r,dataVersion:p,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:b,snapshotHash:f,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===n?a:n),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,hospitalId:e.hospitalId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[w]=await t.insert(u.changeLogs).values(x).returning();return w&&w.entityId&&Number.isFinite(w.version)&&await t.update(u.changeLogs).set({isActive:!1,supersededBy:w.version,supersededAt:w.dateOfChange??new Date}).where((0,s.xD)((0,s.eq)(u.changeLogs.entityId,w.entityId),(0,s.eq)(u.changeLogs.entityType,w.entityType),(0,s.lt)(u.changeLogs.version,w.version),(0,s.eq)(u.changeLogs.isActive,!0))),w},f=i?await n(i):await l.Z.transaction(n);return r.success=!0,r.data=f,t&&c.Z.emit("data_changed","save_change_log"),r}catch(e){return r.success=!1,r.errors=[e.message],d.Z.error("_saveChangeLog ERROR",e.message),r}}async function w({data:e,broadcastAction:t}){let i=0,s=[];try{return await l.Z.transaction(async t=>{for(let r of e){let e=await x({data:r,client:t});if(e.errors?.length)throw s.push(...e.errors),Error(s.join(", "));i++}}),t&&!s.length&&c.Z.emit("data_changed","save_change_logs"),{success:!s.length,errors:s.length?s:void 0,saved:i}}catch(e){return d.Z.error("_saveChangeLogs ERROR",e.message),i=0,{success:!1,errors:[e.message],saved:i}}}},88317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});let s=(0,i(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});let s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,r=function(e){return"string"==typeof e&&s.test(e)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[9380,1744,1337,3788,2758,4901,5059,413,6267,8298],()=>i(54254));module.exports=s})();