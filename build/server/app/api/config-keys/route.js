(()=>{var e={};e.id=4353,e.ids=[4353],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},96119:e=>{"use strict";e.exports=require("perf_hooks")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},58359:()=>{},93739:()=>{},65311:(e,t,i)=>{"use strict";i.r(t),i.d(t,{originalPathname:()=>I,patchFetch:()=>K,requestAsyncStorage:()=>u,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var r={};i.r(r),i.d(r,{DELETE:()=>y,GET:()=>l});var s=i(49303),n=i(88716),a=i(60670),o=i(87070),c=i(57435),d=i(72761),f=i(82984);async function l(e){try{if(!(await (0,d.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]});let t=JSON.parse(e.nextUrl.searchParams.get("data")||"{}"),i=await (0,f.getConfigKeys)(t);return o.NextResponse.json(i)}catch(e){return c.Z.error("[GET] /api/config-keys",e.message),o.NextResponse.json({errors:["Internal Error"]})}}async function y(e){try{if(!(await (0,d.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]});let t=JSON.parse(e.nextUrl.searchParams.get("data")||"{}"),i=await (0,f.deleteConfigKeys)(t);return o.NextResponse.json(i)}catch(e){return c.Z.error("[GET] /api/config-keys",e.message),o.NextResponse.json({errors:["Internal Error"]})}}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/config-keys/route",pathname:"/api/config-keys",filename:"route",bundlePath:"app/api/config-keys/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/config-keys/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:h}=g,I="/api/config-keys/route";function K(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},82984:(e,t,i)=>{"use strict";i.r(t),i.d(t,{$$ACTION_0:()=>f,$$ACTION_1:()=>y,$$ACTION_2:()=>u,$$ACTION_3:()=>h,$$ACTION_4:()=>K,countConfigKeys:()=>l,deleteConfigKeys:()=>d,getConfigKey:()=>p,getConfigKeys:()=>g,saveConfigKeys:()=>I});var r=i(24330);i(60166);var s=i(92963),n=i(17137),a=i(57435),o=i(66267),c=i(40618);let d=(0,r.j)("fe497951e1112ca68d62894eefa1c51165cbb7c6",f);async function f(e){try{let t=await (0,o.isAllowed)();return await (0,s.LR)({...e,userId:t.user?.userId})}catch(e){return a.Z.error("deleteConfigKeys ERROR",e.message),{errors:[e.message],success:!1}}}let l=(0,r.j)("63ec7791c7ce0e740a8a8b54321f644ed390ac91",y);async function y(...e){try{return await (0,o.isAllowed)(),await (0,n.G$)(...e)}catch(e){return a.Z.error("countConfigKeys ERROR",e.message),{errors:[e.message],data:n.ZV}}}let g=(0,r.j)("b2da4c38e5d01f11debd1dd7c9eb4651bfbbf61f",u);async function u(...e){try{return await (0,o.isAllowed)(),await (0,n.aP)(...e)}catch(e){return a.Z.error("getConfigKeys ERROR",e.message),{errors:[e.message],data:[]}}}let p=(0,r.j)("30f44075bb43c162ae34a4506cbc82e9b1b93474",h);async function h(...e){return await (0,o.isAllowed)(),await (0,n.SL)(...e)}let I=(0,r.j)("16262094b81b056901134f4169f3d346f4ec013a",K);async function K(e){try{let t=await (0,o.isAllowed)();return await (0,s.UZ)({...e,userId:t.user?.userId})}catch(e){return a.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,c.h)([d,l,g,p,I]),(0,r.j)("ea3a611cf241c4b0cc6585638ab2951fb0d1471b",d),(0,r.j)("92531094708e80bbacf90f44a414a77e0bd3ab28",l),(0,r.j)("3b0734b816628136609a5dd9c738d6801c9a52f6",g),(0,r.j)("bce0d6f8f079a0673655c744621c7cf137ef9e1d",p),(0,r.j)("627e92af8c0226b5e044a31db9cc4989fc3dc3ee",I)},36864:(e,t,i)=>{"use strict";i.d(t,{C:()=>q,F:()=>x});var r=i(57745),s=i(81445),n=i(84770),a=i(30900),o=i(9576),c=i(57435),d=i(10413),f=i(93567),l=i(88317),y=i(34149);let g={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},u={screen:["scriptId"],diagnosis:["scriptId"]},p=["alias","release"],h=["release"],I={script:{table:f.scripts,idColumn:f.scripts.scriptId,versionColumn:f.scripts.version,entityLabel:"script"},screen:{table:f.screens,idColumn:f.screens.screenId,versionColumn:f.screens.version,entityLabel:"screen"},diagnosis:{table:f.diagnoses,idColumn:f.diagnoses.diagnosisId,versionColumn:f.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:f.configKeys,idColumn:f.configKeys.configKeyId,versionColumn:f.configKeys.version,entityLabel:"config key"},drugs_library:{table:f.drugsLibrary,idColumn:f.drugsLibrary.itemId,versionColumn:f.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:f.dataKeys,idColumn:f.dataKeys.uuid,versionColumn:f.dataKeys.version,entityLabel:"data key"},hospital:{table:f.hospitals,idColumn:f.hospitals.hospitalId,versionColumn:f.hospitals.version,entityLabel:"hospital"}},K={script:{table:f.scripts,idColumn:f.scripts.scriptId,entityLabel:"script"},screen:{table:f.screens,idColumn:f.screens.screenId,entityLabel:"screen"},diagnosis:{table:f.diagnoses,idColumn:f.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:f.configKeys,idColumn:f.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:f.drugsLibrary,idColumn:f.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:f.dataKeys,idColumn:f.dataKeys.uuid,entityLabel:"data key"},alias:{table:f.aliases,idColumn:f.aliases.uuid,entityLabel:"alias"},hospital:{table:f.hospitals,idColumn:f.hospitals.hospitalId,entityLabel:"hospital"}};function m(e){let t=0;for(let i=0;i<e.length;i++)t=31*t+e.charCodeAt(i)|0;return t}async function w(e,t,i){let r=m(t),s=m(i);await e.execute((0,y.i6)`select pg_advisory_xact_lock(${r}, ${s})`)}function v(e){return(0,n.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function b(e,t){let i=I[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select({version:i.versionColumn}).from(i.table).where((0,r.eq)(i.idColumn,t.entityId)).limit(1),n=s?.[0]?.version;if(!Number.isFinite(n))throw Error(`Missing ${i.entityLabel} or version for entityId ${t.entityId}`);return Number(n)}async function D(e,t,i){let n=await e.select({version:f.changeLogs.version}).from(f.changeLogs).where((0,r.xD)((0,r.eq)(f.changeLogs.entityId,t),(0,r.eq)(f.changeLogs.entityType,i))).orderBy((0,s.C)(f.changeLogs.version)).limit(1);return n?.[0]?.version}async function Z(e,t){let i=K[t.entityType];if(!i)throw Error(`Unknown entityType ${t.entityType}`);let s=await e.select().from(i.table).where((0,r.eq)(i.idColumn,t.entityId)).limit(1);if(!s?.[0])throw Error(`Entity not found for snapshot (${i.entityLabel} ${t.entityId})`);return s[0]}async function C({client:e,data:t,computedVersion:i,dataVersion:r,baselineSnapshot:s}){if(Number.isFinite(await D(e,t.entityId,t.entityType)))return;let n=s??t.previousSnapshot;if(void 0===n)try{n=await Z(e,t),c.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,i-1),d=v(n),l={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:a,dataVersion:r,changes:[],fullSnapshot:n,previousSnapshot:n,snapshotHash:d,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(f.changeLogs).values(l),a}async function q({data:e,broadcastAction:t,client:i}){let s={success:!1};try{!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!a.Z(e.userId))throw Error("Invalid userId");if(h.includes(e.entityType)){if(Object.values(g).map(t=>e[t]).filter(e=>null!=e).length)throw Error(`No foreign keys should be provided for entityType ${e.entityType}`);return}let t=g[e.entityType];if(!t)throw Error(`Unknown entityType ${e.entityType}`);let i=e[t];if(!i||"string"!=typeof i||!a.Z(i))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(i!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let r=u[e.entityType]||[];for(let t of r){let i=e[t];if(null!=i&&("string"!=typeof i||!a.Z(i)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(g).map(([t,i])=>({type:t,key:i,value:e[i]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!r.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let n=async t=>{var i;let s,n,a;await w(t,e.entityType,e.entityId);let d=o.Z(),l=(i=e.entityType,p.includes(i)),y=Number.isFinite(e.version)?Number(e.version):null,g=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(l){let i=await D(t,e.entityId,e.entityType);if(n=i,s=(i??0)+1,a=await C({client:t,data:e,computedVersion:s,dataVersion:g,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==s){if(y<s);else throw c.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,latestChangeLogVersion:i,computedVersion:s}),Error(`Provided version (${e.version}) does not match expected changelog version (${s}) for versionless entity ${e.entityType}`)}}else{let i=e.entityType,r=await b(t,{...e,entityType:i}),o=I[i],d=await D(t,e.entityId,e.entityType);if(n=d,Number.isFinite(d)){let e=Number(d)+1;s=r<=Number(d)?e:r}else s=r;if(a=await C({client:t,data:e,computedVersion:s,dataVersion:g,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==s){if(y<s);else throw c.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,entityVersion:r,latestChangeLogVersion:d,computedVersion:s}),Error(`Provided version (${e.version}) does not match ${o.entityLabel} version (${s})`)}}let u=e.snapshotHash||v(e.fullSnapshot);if(!u)throw Error("snapshotHash is required");let h=e.previousSnapshot??e.baselineSnapshot??{},K={changeLogId:d,entityId:e.entityId,entityType:e.entityType,action:e.action,version:s,dataVersion:g,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:h,snapshotHash:u,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===n?a:n),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,hospitalId:e.hospitalId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[m]=await t.insert(f.changeLogs).values(K).returning();return m&&m.entityId&&Number.isFinite(m.version)&&await t.update(f.changeLogs).set({isActive:!1,supersededBy:m.version,supersededAt:m.dateOfChange??new Date}).where((0,r.xD)((0,r.eq)(f.changeLogs.entityId,m.entityId),(0,r.eq)(f.changeLogs.entityType,m.entityType),(0,r.lt)(f.changeLogs.version,m.version),(0,r.eq)(f.changeLogs.isActive,!0))),m},y=i?await n(i):await d.Z.transaction(n);return s.success=!0,s.data=y,t&&l.Z.emit("data_changed","save_change_log"),s}catch(e){return s.success=!1,s.errors=[e.message],c.Z.error("_saveChangeLog ERROR",e.message),s}}async function x({data:e,broadcastAction:t,allowPartial:i}){let r=0,s=[];try{if(i&&e.some(e=>"rollback"===e.action))throw Error("allowPartial is not permitted for rollback changelog writes");if(i)for(let t of e){let e=await q({data:t});if(e.errors?.length){s.push(...e.errors);continue}r++}else await d.Z.transaction(async t=>{for(let i of e){let e=await q({data:i,client:t});if(e.errors?.length)throw s.push(...e.errors),Error(s.join(", "));r++}});return t&&!s.length&&l.Z.emit("data_changed","save_change_logs"),{success:!s.length,errors:s.length?s:void 0,saved:r}}catch(e){return c.Z.error("_saveChangeLogs ERROR",e.message),r=0,{success:!1,errors:[e.message],saved:r}}}},92963:(e,t,i)=>{"use strict";i.d(t,{sj:()=>l,LR:()=>y,h:()=>h,UZ:()=>f});var r=i(57745),s=i(81445),n=i(9576),a=i(57435),o=i(10413),c=i(93567),d=i(88317);async function f({data:e,broadcastAction:t,userId:i}){let f={success:!1};try{let t=[];for(let{configKeyId:a,...d}of e)try{let e=a||n.Z();if(!t.length){let t=a?await o.Z.query.configKeysDrafts.findFirst({where:(0,r.eq)(c.configKeysDrafts.configKeyDraftId,e)}):null,n=t||!a?null:await o.Z.query.configKeys.findFirst({where:(0,r.eq)(c.configKeys.configKeyId,e)});if(t){let i={...t.data,...d};await o.Z.update(c.configKeysDrafts).set({data:i,position:i.position}).where((0,r.eq)(c.configKeysDrafts.configKeyDraftId,e))}else{let t=d.position||n?.position;if(!t){let e=await o.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,s.C)(c.configKeys.position)}),i=await o.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,s.C)(c.configKeysDrafts.position)});t=Math.max(0,e?.position||0,i?.position||0)+1}let r={...n,...d,configKeyId:e,version:n?.version?n.version+1:1,position:t};await o.Z.insert(c.configKeysDrafts).values({data:r,configKeyDraftId:e,position:r.position,configKeyId:n?.configKeyId,createdByUserId:i})}}}catch(e){t.push(e.message)}t.length?f.errors=t:f.success=!0}catch(e){f.success=!1,f.errors=[e.message],a.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!f?.errors?.length&&t&&d.Z.emit("data_changed","save_config_keys"),f}}async function l(e){try{return await o.Z.delete(c.configKeysDrafts).where(e?.userId?(0,r.eq)(c.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function y({configKeysIds:e,broadcastAction:t,userId:i}){let s={success:!1};try{if(e.length){await o.Z.delete(c.configKeysDrafts).where((0,r.d3)(c.configKeysDrafts.configKeyDraftId,e));let t=(await o.Z.select({configKeyId:c.configKeys.configKeyId,pendingDeletion:c.pendingDeletion.configKeyId}).from(c.configKeys).leftJoin(c.pendingDeletion,(0,r.eq)(c.pendingDeletion.configKeyId,c.configKeys.configKeyId)).where((0,r.d3)(c.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:i}));t.length&&await o.Z.insert(c.pendingDeletion).values(t)}s.success=!0}catch(e){s.success=!1,s.errors=[e.message],a.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!s?.errors?.length&&t&&d.Z.emit("data_changed","delete_config_keys"),s}}async function g({previous:e,drafts:t,userId:i}){let r=[];try{let s=[];for(let n of t){let t=n?.data?.configKeyId;if(!t)continue;let a={version:n?.data?.version||1,configKeyId:t,changes:{}},o=1===(n?.data?.version||1);if(o)a.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let i=e.find(e=>e.configKeyId===t),r=[],s=[];Object.keys({...n?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=n.data[e],a={...i}[e];JSON.stringify(t)!==JSON.stringify(a)&&(r.push({[e]:a}),s.push({[e]:t}))}),a.changes={action:"update_config_key",description:"Update config key",oldValues:r,newValues:s}}if(s.push(a),i){let{...s}=n.data||{},c=JSON.parse(JSON.stringify(s)),d=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.configKeyId===t)||{}));r.push({entityId:t,entityType:"config_key",action:o?"create":"update",version:a.version||1,changes:a.changes,fullSnapshot:c,previousSnapshot:d,baselineSnapshot:d,userId:i,configKeyId:t})}}s.length&&await o.Z.insert(c.configKeysHistory).values(s)}catch(e){a.Z.error(e.message)}return r}var u=i(34149),p=i(36864);async function h(e){let t={success:!1},i=[];try{let s=[],d=[],f=await o.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,r.eq)(c.configKeysDrafts.createdByUserId,e?.userId):void 0});if(s=f.filter(e=>e.configKeyId),d=f.filter(e=>!e.configKeyId),s.length){let t=[];for(let{configKeyId:e,data:i}of(s.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,r.d3)(c.configKeys.configKeyId,s.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),s)){let{configKeyId:t,id:s,oldConfigKeyId:n,createdAt:a,updatedAt:d,deletedAt:f,...l}=i,y={...l,publishDate:new Date};await o.Z.update(c.configKeys).set(y).where((0,r.eq)(c.configKeys.configKeyId,e)).returning()}let n=await g({drafts:s,previous:t,userId:e?.publisherUserId});i.push(...n.map(t=>({...t,dataVersion:e?.dataVersion})))}if(d.length){let t=[];for(let{id:e,data:i}of(d.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,r.d3)(c.configKeys.configKeyId,d.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),d)){let t=i.configKeyId||(0,n.Z)(),r={...i,configKeyId:t};d=d.map(i=>(i.id===e&&(i.data.configKeyId=t),i)),await o.Z.insert(c.configKeys).values(r)}let s=await g({drafts:d,previous:t,userId:e?.publisherUserId});i.push(...s.map(t=>({...t,dataVersion:e?.dataVersion})))}await o.Z.delete(c.configKeysDrafts).where(e?.userId?(0,r.eq)(c.configKeysDrafts.createdByUserId,e.userId):void 0);let l=await o.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(c.pendingDeletion.configKeyId),e?.userId?(0,r.eq)(c.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:!0}});if((l=l.filter(e=>e.configKey)).length){let t=new Date;await o.Z.update(c.configKeys).set({deletedAt:t}).where((0,r.d3)(c.configKeys.configKeyId,l.map(e=>e.configKeyId)));let s=l.map(e=>({version:e.configKey.version,configKeyId:e.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await o.Z.insert(c.configKeysHistory).values(s),e?.publisherUserId)for(let r=0;r<l.length;r++){let n=l[r],a=s[r];if(!n?.configKeyId)continue;let o={...n.configKey??{},deletedAt:t};i.push({entityId:n.configKeyId,entityType:"config_key",action:"delete",version:a.version||1,dataVersion:e.dataVersion,changes:a.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),previousSnapshot:JSON.parse(JSON.stringify(o)),baselineSnapshot:JSON.parse(JSON.stringify(o)),description:a.changes.description,userId:e.publisherUserId,configKeyId:n.configKeyId,isActive:!1})}}await o.Z.delete(c.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(c.pendingDeletion.configKeyId),(0,r.K0)(c.pendingDeletion.configKeyDraftId)),e?.userId?(0,r.eq)(c.pendingDeletion.createdByUserId,e.userId):void 0));let y=[...s.map(e=>e.configKeyId),...l.map(e=>e.configKeyId)];if(y.length&&await o.Z.update(c.configKeys).set({version:(0,u.i6)`${c.configKeys.version} + 1`}).where((0,r.d3)(c.configKeys.configKeyId,y)),i.length){let e=await (0,p.F)({data:i,allowPartial:!0});e.errors?.length&&a.Z.error("_publishConfigKeys changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],a.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},17137:(e,t,i)=>{"use strict";i.d(t,{G$:()=>g,ZV:()=>y,SL:()=>f,aP:()=>d});var r=i(57745),s=i(30900),n=i(9576),a=i(10413),o=i(93567),c=i(57435);async function d(e){try{let{configKeysIds:t,returnDraftsIfExist:i}={...e},c=t||[],d=c?.length?(0,r.d3)(o.configKeysDrafts.configKeyDraftId,c.map(e=>s.Z(e)?e:n.Z())):void 0,f=[...d?[d]:[]],l=i?await a.Z.query.configKeysDrafts.findMany({where:(0,r.xD)(...f)}):[];c=c.filter(e=>!l.map(e=>e.configKeyDraftId).includes(e));let y=l.length?(0,r.Nl)(o.configKeys.configKeyId,l.map(e=>e.configKeyDraftId)):void 0,g=c?.length?(0,r.d3)(o.configKeys.configKeyId,c.filter(e=>s.Z(e))):void 0,u=c?.length?(0,r.d3)(o.configKeys.oldConfigKeyId,c.filter(e=>!s.Z(e))):void 0,p=[(0,r.Ft)(o.configKeys.deletedAt),(0,r.Ft)(o.pendingDeletion),...g&&u?[(0,r.or)(g,u)]:[],y],h=(await a.Z.select({configKey:o.configKeys,pendingDeletion:o.pendingDeletion}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where(p.length?(0,r.xD)(...p):void 0)).map(e=>e.configKey),I=h.length?await a.Z.query.pendingDeletion.findMany({where:(0,r.d3)(o.pendingDeletion.configKeyId,h.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...l.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!I.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return c.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function f(e){let{configKeyId:t,returnDraftIfExists:i}={...e};try{if(!t)throw Error("Missing configKeyId");let e=s.Z(t)?(0,r.eq)(o.configKeys.configKeyId,t):void 0,n=s.Z(t)?void 0:(0,r.eq)(o.configKeys.oldConfigKeyId,t),c=e?(0,r.eq)(o.configKeysDrafts.configKeyDraftId,t):void 0,d=i&&c?await a.Z.query.configKeysDrafts.findFirst({where:e}):void 0,f=d?{...d.data,draftCreatedByUserId:d.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(f)return{data:f};let l=await a.Z.query.configKeys.findFirst({where:(0,r.xD)((0,r.Ft)(o.configKeys.deletedAt),e||n),with:{draft:!0}});d=i?l?.draft:void 0;let y=d?.data||l;if(!(f=y?{...y,draftCreatedByUserId:d?.createdByUserId,isDraft:!!d?.data,isDeleted:!1}:null))return{data:null};return{data:f}}catch(e){return c.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var l=i(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function g(){try{let[{count:e}]=await a.Z.select({count:(0,l.QX)()}).from(o.configKeysDrafts),[{count:t}]=await a.Z.select({count:(0,l.QX)()}).from(o.configKeysDrafts).where((0,r.Ft)(o.configKeysDrafts.configKeyId)),[{count:i}]=await a.Z.select({count:(0,l.QX)()}).from(o.configKeysDrafts).where((0,r.K0)(o.configKeysDrafts.configKeyId)),[{count:s}]=await a.Z.select({count:(0,l.QX)()}).from(o.pendingDeletion).where((0,r.K0)(o.pendingDeletion.configKeyId)),[{count:n}]=await a.Z.select({count:(0,l.QX)()}).from(o.configKeys);return{data:{allPublished:n,publishedWithDrafts:i,allDrafts:e,newDrafts:t,pendingDeletion:s}}}catch(e){return c.Z.error("_getConfigKeys ERROR",e.message),{data:y,errors:[e.message]}}}},88317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});let r=(0,i(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});let r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,s=function(e){return"string"==typeof e&&r.test(e)}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[9380,1744,1337,3788,2758,9092,4901,5059,413,6267],()=>i(65311));module.exports=r})();