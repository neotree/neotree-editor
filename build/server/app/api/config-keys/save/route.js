(()=>{var e={};e.id=398,e.ids=[398],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},22037:e=>{"use strict";e.exports=require("os")},4074:e=>{"use strict";e.exports=require("perf_hooks")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},81227:(e,t,i)=>{"use strict";i.r(t),i.d(t,{originalPathname:()=>p,patchFetch:()=>h,requestAsyncStorage:()=>l,routeModule:()=>y,serverHooks:()=>K,staticGenerationAsyncStorage:()=>u});var s={};i.r(s),i.d(s,{POST:()=>g});var n=i(49303),r=i(88716),o=i(60670),a=i(87070),c=i(72761),f=i(82984),d=i(57435);async function g(e){try{if(!(await (0,c.$)()).yes)return a.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),i=await (0,f.saveConfigKeys)(t);return a.NextResponse.json(i)}catch(e){return d.Z.log("/api/config-keys/save",e),a.NextResponse.json({errors:[e.message]})}}let y=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/config-keys/save/route",pathname:"/api/config-keys/save",filename:"route",bundlePath:"app/api/config-keys/save/route"},resolvedPagePath:"/home/morris/Documents/NEOTREE/REPOS/neotree-editor/app/api/config-keys/save/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:u,serverHooks:K}=y,p="/api/config-keys/save/route";function h(){return(0,o.patchFetch)({serverHooks:K,staticGenerationAsyncStorage:u})}},82984:(e,t,i)=>{"use strict";i.r(t),i.d(t,{$$ACTION_0:()=>d,$$ACTION_1:()=>y,$$ACTION_2:()=>u,$$ACTION_3:()=>p,$$ACTION_4:()=>w,countConfigKeys:()=>g,deleteConfigKeys:()=>f,getConfigKey:()=>K,getConfigKeys:()=>l,saveConfigKeys:()=>h});var s=i(24330);i(60166);var n=i(92963),r=i(17137),o=i(57435),a=i(66267),c=i(40618);let f=(0,s.j)("6b8759fc594374aad8bdb6b03d52d1c4df8e4fc7",d);async function d(...e){try{return await (0,a.isAllowed)(),await (0,n.LR)(...e)}catch(e){return o.Z.error("deleteConfigKeys ERROR",e.message),{errors:[e.message],success:!1}}}let g=(0,s.j)("70542260a226bfc6114ce889f6541e08e745bb19",y);async function y(...e){try{return await (0,a.isAllowed)(),await (0,r.G$)(...e)}catch(e){return o.Z.error("countConfigKeys ERROR",e.message),{errors:[e.message],data:r.ZV}}}let l=(0,s.j)("d803f4ed36e916a2efa9cf581bacc6a764bb4db0",u);async function u(...e){try{return await (0,a.isAllowed)(),await (0,r.aP)(...e)}catch(e){return o.Z.error("getConfigKeys ERROR",e.message),{errors:[e.message],data:[]}}}let K=(0,s.j)("532985f204764ffa1ea3c5a8acb3093e3a19de88",p);async function p(...e){return await (0,a.isAllowed)(),await (0,r.SL)(...e)}let h=(0,s.j)("74defc61cce14e40db4a3c66a81b949e80103d35",w);async function w(...e){try{return await (0,a.isAllowed)(),await (0,n.UZ)(...e)}catch(e){return o.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,c.h)([f,g,l,K,h]),(0,s.j)("c7b64e4a1e804b99a5ef88e27936eccbf3cf985c",f),(0,s.j)("5056f921eba51dcd4ecfb5038f1f7a5063d2d2a3",g),(0,s.j)("c077629ddb773ef45963774ea8b5e33f4d9974ea",l),(0,s.j)("0bff5a82c49e99c12bd5e4b321e2d5c7e92d338a",K),(0,s.j)("add46788eb6c5df875b0df222b87723f5b5b6220",h)},92963:(e,t,i)=>{"use strict";i.d(t,{sj:()=>g,LR:()=>y,h:()=>K,UZ:()=>d});var s=i(57745),n=i(81445),r=i(9576),o=i(57435),a=i(10413),c=i(93567),f=i(88317);async function d({data:e,broadcastAction:t}){let i={success:!1};try{let t=[];for(let{configKeyId:i,...o}of e)try{let e=i||r.Z();if(!t.length){let t=i?await a.Z.query.configKeysDrafts.findFirst({where:(0,s.eq)(c.configKeysDrafts.configKeyDraftId,e)}):null,r=t||!i?null:await a.Z.query.configKeys.findFirst({where:(0,s.eq)(c.configKeys.configKeyId,e)});if(t){let i={...t.data,...o};await a.Z.update(c.configKeysDrafts).set({data:i,position:i.position}).where((0,s.eq)(c.configKeysDrafts.configKeyDraftId,e))}else{let t=o.position||r?.position;if(!t){let e=await a.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,n.C)(c.configKeys.position)}),i=await a.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,n.C)(c.configKeysDrafts.position)});t=Math.max(0,e?.position||0,i?.position||0)+1}let i={...r,...o,configKeyId:e,version:r?.version?r.version+1:1,position:t};await a.Z.insert(c.configKeysDrafts).values({data:i,configKeyDraftId:e,position:i.position,configKeyId:r?.configKeyId})}}}catch(e){t.push(e.message)}t.length?i.errors=t:i.success=!0}catch(e){i.success=!1,i.errors=[e.message],o.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!i?.errors?.length&&t&&f.Z.emit("data_changed","save_config_keys"),i}}async function g(){try{return await a.Z.delete(c.configKeysDrafts),!0}catch(e){throw e}}async function y({configKeysIds:e,broadcastAction:t}){let i={success:!1};try{if(e.length){await a.Z.delete(c.configKeysDrafts).where((0,s.d3)(c.configKeysDrafts.configKeyDraftId,e));let t=(await a.Z.select({configKeyId:c.configKeys.configKeyId,pendingDeletion:c.pendingDeletion.configKeyId}).from(c.configKeys).leftJoin(c.pendingDeletion,(0,s.eq)(c.pendingDeletion.configKeyId,c.configKeys.configKeyId)).where((0,s.d3)(c.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion);t.length&&await a.Z.insert(c.pendingDeletion).values(t)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],o.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!i?.errors?.length&&t&&f.Z.emit("data_changed","delete_config_keys"),i}}async function l({previous:e,drafts:t}){try{let i=[];for(let s of t){let t={version:s?.data?.version||1,configKeyId:s?.data?.configKeyId,changes:{}};if(s?.data?.version===1)t.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let i=e.filter(e=>e.configKeyId===s?.data?.configKeyId)[0],n=[],r=[];Object.keys({...s?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=s.data[e],o={...i}[e];JSON.stringify(t)!==JSON.stringify(o)&&(n.push({[e]:o}),r.push({[e]:t}))}),t.changes={action:"update_config_key",description:"Update config key",oldValues:n,newValues:r}}i.push(t)}await a.Z.insert(c.configKeysHistory).values(i)}catch(e){o.Z.error(e.message)}}var u=i(34149);async function K(e){let t={success:!1};try{let e=[],i=[],n=await a.Z.query.configKeysDrafts.findMany();if(e=n.filter(e=>e.configKeyId),i=n.filter(e=>!e.configKeyId),e.length){let t=[];for(let{configKeyId:i,data:n}of(e.filter(e=>e.configKeyId).length&&(t=await a.Z.query.configKeys.findMany({where:(0,s.d3)(c.configKeys.configKeyId,e.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),e)){let{configKeyId:e,id:t,oldConfigKeyId:r,createdAt:o,updatedAt:f,deletedAt:d,...g}=n,y={...g,publishDate:new Date};await a.Z.update(c.configKeys).set(y).where((0,s.eq)(c.configKeys.configKeyId,i)).returning()}await l({drafts:e,previous:t})}if(i.length){let e=[];for(let{id:t,data:n}of(i.filter(e=>e.configKeyId).length&&(e=await a.Z.query.configKeys.findMany({where:(0,s.d3)(c.configKeys.configKeyId,i.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),i)){let e=n.configKeyId||(0,r.Z)(),s={...n,configKeyId:e};i=i.map(i=>(i.id===t&&(i.data.configKeyId=e),i)),await a.Z.insert(c.configKeys).values(s)}await l({drafts:i,previous:e})}await a.Z.delete(c.configKeysDrafts);let o=await a.Z.query.pendingDeletion.findMany({where:(0,s.K0)(c.pendingDeletion.configKeyId),columns:{configKeyId:!0},with:{configKey:{columns:{version:!0}}}});if((o=o.filter(e=>e.configKey)).length){let e=new Date;await a.Z.update(c.configKeys).set({deletedAt:e}).where((0,s.d3)(c.configKeys.configKeyId,o.map(e=>e.configKeyId))),await a.Z.insert(c.configKeysHistory).values(o.map(t=>({version:t.configKey.version,configKeyId:t.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:e}]}})))}await a.Z.delete(c.pendingDeletion).where((0,s.or)((0,s.K0)(c.pendingDeletion.configKeyId),(0,s.K0)(c.pendingDeletion.configKeyDraftId)));let f=[...e.map(e=>e.configKeyId),...o.map(e=>e.configKeyId)];f.length&&await a.Z.update(c.configKeys).set({version:(0,u.i6)`${c.configKeys.version} + 1`}).where((0,s.d3)(c.configKeys.configKeyId,f)),t.success=!0}catch(e){t.success=!1,t.errors=[e.message],o.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},17137:(e,t,i)=>{"use strict";i.d(t,{G$:()=>l,ZV:()=>y,SL:()=>d,aP:()=>f});var s=i(57745),n=i(30900),r=i(9576),o=i(10413),a=i(93567),c=i(57435);async function f(e){try{let{configKeysIds:t,returnDraftsIfExist:i}={...e},c=t||[],f=c?.length?(0,s.d3)(a.configKeysDrafts.configKeyDraftId,c.map(e=>n.Z(e)?e:r.Z())):void 0,d=[...f?[f]:[]],g=i?await o.Z.query.configKeysDrafts.findMany({where:(0,s.xD)(...d)}):[];c=c.filter(e=>!g.map(e=>e.configKeyDraftId).includes(e));let y=g.length?(0,s.Nl)(a.configKeys.configKeyId,g.map(e=>e.configKeyDraftId)):void 0,l=c?.length?(0,s.d3)(a.configKeys.configKeyId,c.filter(e=>n.Z(e))):void 0,u=c?.length?(0,s.d3)(a.configKeys.oldConfigKeyId,c.filter(e=>!n.Z(e))):void 0,K=[(0,s.Ft)(a.configKeys.deletedAt),(0,s.Ft)(a.pendingDeletion),...l&&u?[(0,s.or)(l,u)]:[],y],p=(await o.Z.select({configKey:a.configKeys,pendingDeletion:a.pendingDeletion}).from(a.configKeys).leftJoin(a.pendingDeletion,(0,s.eq)(a.pendingDeletion.configKeyId,a.configKeys.configKeyId)).where(K.length?(0,s.xD)(...K):void 0)).map(e=>e.configKey),h=p.length?await o.Z.query.pendingDeletion.findMany({where:(0,s.d3)(a.pendingDeletion.configKeyId,p.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...p.map(e=>({...e,isDraft:!1,isDeleted:!1})),...g.map(e=>({...e.data,isDraft:!0,isDeleted:!1}))].sort((e,t)=>e.position-t.position).filter(e=>!h.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return c.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function d(e){let{configKeyId:t,returnDraftIfExists:i}={...e};try{if(!t)throw Error("Missing configKeyId");let e=n.Z(t)?(0,s.eq)(a.configKeys.configKeyId,t):void 0,r=n.Z(t)?void 0:(0,s.eq)(a.configKeys.oldConfigKeyId,t),c=e?(0,s.eq)(a.configKeysDrafts.configKeyDraftId,t):void 0,f=i&&c?await o.Z.query.configKeysDrafts.findFirst({where:e}):void 0,d=f?{...f.data,isDraft:!1,isDeleted:!1}:null;if(d)return{data:d};let g=await o.Z.query.configKeys.findFirst({where:(0,s.xD)((0,s.Ft)(a.configKeys.deletedAt),e||r),with:{draft:!0}});f=i?g?.draft:void 0;let y=f?.data||g;if(!(d=y?{...y,isDraft:!1,isDeleted:!1}:null))return{data:null};return{data:d}}catch(e){return c.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var g=i(60938);let y={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function l(){try{let[{count:e}]=await o.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts),[{count:t}]=await o.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,s.Ft)(a.configKeysDrafts.configKeyId)),[{count:i}]=await o.Z.select({count:(0,g.QX)()}).from(a.configKeysDrafts).where((0,s.K0)(a.configKeysDrafts.configKeyId)),[{count:n}]=await o.Z.select({count:(0,g.QX)()}).from(a.pendingDeletion).where((0,s.K0)(a.pendingDeletion.configKeyId)),[{count:r}]=await o.Z.select({count:(0,g.QX)()}).from(a.configKeys);return{data:{allPublished:r,publishedWithDrafts:i,allDrafts:e,newDrafts:t,pendingDeletion:n}}}catch(e){return c.Z.error("_getConfigKeys ERROR",e.message),{data:y,errors:[e.message]}}}},88317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});let s=(0,i(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});let s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,n=function(e){return"string"==typeof e&&s.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[1633,1744,9234,3788,2758,4901,5059,413,6267],()=>i(81227));module.exports=s})();