(()=>{var e={};e.id=398,e.ids=[398],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},22037:e=>{"use strict";e.exports=require("os")},4074:e=>{"use strict";e.exports=require("perf_hooks")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},16349:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>y});var i=r(49303),n=r(88716),a=r(60670),o=r(87070),c=r(72761),d=r(82984),u=r(57435);async function y(e){try{if(!(await (0,c.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),r=await (0,d.saveConfigKeys)(t);return o.NextResponse.json(r)}catch(e){return u.Z.log("/api/config-keys/save",e),o.NextResponse.json({errors:[e.message]})}}let l=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/config-keys/save/route",pathname:"/api/config-keys/save",filename:"route",bundlePath:"app/api/config-keys/save/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/config-keys/save/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:p}=l,h="/api/config-keys/save/route";function b(){return(0,a.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:f})}},82984:(e,t,r)=>{"use strict";r.r(t),r.d(t,{$$ACTION_0:()=>u,$$ACTION_1:()=>l,$$ACTION_2:()=>f,$$ACTION_3:()=>h,$$ACTION_4:()=>m,countConfigKeys:()=>y,deleteConfigKeys:()=>d,getConfigKey:()=>p,getConfigKeys:()=>g,saveConfigKeys:()=>b});var s=r(24330);r(60166);var i=r(92963),n=r(17137),a=r(57435),o=r(66267),c=r(40618);let d=(0,s.j)("fe497951e1112ca68d62894eefa1c51165cbb7c6",u);async function u(e){try{let t=await (0,o.isAllowed)();return await (0,i.LR)({...e,userId:t.user?.userId})}catch(e){return a.Z.error("deleteConfigKeys ERROR",e.message),{errors:[e.message],success:!1}}}let y=(0,s.j)("63ec7791c7ce0e740a8a8b54321f644ed390ac91",l);async function l(...e){try{return await (0,o.isAllowed)(),await (0,n.G$)(...e)}catch(e){return a.Z.error("countConfigKeys ERROR",e.message),{errors:[e.message],data:n.ZV}}}let g=(0,s.j)("b2da4c38e5d01f11debd1dd7c9eb4651bfbbf61f",f);async function f(...e){try{return await (0,o.isAllowed)(),await (0,n.aP)(...e)}catch(e){return a.Z.error("getConfigKeys ERROR",e.message),{errors:[e.message],data:[]}}}let p=(0,s.j)("30f44075bb43c162ae34a4506cbc82e9b1b93474",h);async function h(...e){return await (0,o.isAllowed)(),await (0,n.SL)(...e)}let b=(0,s.j)("16262094b81b056901134f4169f3d346f4ec013a",m);async function m(e){try{let t=await (0,o.isAllowed)();return await (0,i.UZ)({...e,userId:t.user?.userId})}catch(e){return a.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,c.h)([d,y,g,p,b]),(0,s.j)("ea3a611cf241c4b0cc6585638ab2951fb0d1471b",d),(0,s.j)("92531094708e80bbacf90f44a414a77e0bd3ab28",y),(0,s.j)("3b0734b816628136609a5dd9c738d6801c9a52f6",g),(0,s.j)("bce0d6f8f079a0673655c744621c7cf137ef9e1d",p),(0,s.j)("627e92af8c0226b5e044a31db9cc4989fc3dc3ee",b)},36864:(e,t,r)=>{"use strict";r.d(t,{C:()=>C,F:()=>L});var s=r(57745),i=r(81445),n=r(6113),a=r(30900),o=r(9576),c=r(57435),d=r(10413),u=r(93567),y=r(88317);let l={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId"},g={screen:["scriptId"],diagnosis:["scriptId"]},f=["alias"],p={script:{table:u.scripts,idColumn:u.scripts.scriptId,versionColumn:u.scripts.version,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,versionColumn:u.screens.version,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,versionColumn:u.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,versionColumn:u.configKeys.version,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,versionColumn:u.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,versionColumn:u.dataKeys.version,entityLabel:"data key"}},h={script:{table:u.scripts,idColumn:u.scripts.scriptId,entityLabel:"script"},screen:{table:u.screens,idColumn:u.screens.screenId,entityLabel:"screen"},diagnosis:{table:u.diagnoses,idColumn:u.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:u.configKeys,idColumn:u.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:u.drugsLibrary,idColumn:u.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:u.dataKeys,idColumn:u.dataKeys.uuid,entityLabel:"data key"},alias:{table:u.aliases,idColumn:u.aliases.uuid,entityLabel:"alias"}};function b(e){return(0,n.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function m(e,t){let r=p[t.entityType];if(!r)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select({version:r.versionColumn}).from(r.table).where((0,s.eq)(r.idColumn,t.entityId)).limit(1),n=i?.[0]?.version;if(!Number.isFinite(n))throw Error(`Missing ${r.entityLabel} or version for entityId ${t.entityId}`);return Number(n)}async function I(e,t,r){let n=await e.select({version:u.changeLogs.version}).from(u.changeLogs).where((0,s.xD)((0,s.eq)(u.changeLogs.entityId,t),(0,s.eq)(u.changeLogs.entityType,r))).orderBy((0,i.C)(u.changeLogs.version)).limit(1);return n?.[0]?.version}async function v(e,t){let r=h[t.entityType];if(!r)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select().from(r.table).where((0,s.eq)(r.idColumn,t.entityId)).limit(1);if(!i?.[0])throw Error(`Entity not found for snapshot (${r.entityLabel} ${t.entityId})`);return i[0]}async function w({client:e,data:t,computedVersion:r,dataVersion:s,baselineSnapshot:i}){if(Number.isFinite(await I(e,t.entityId,t.entityType)))return;let n=i??t.previousSnapshot;if(void 0===n)try{n=await v(e,t),c.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let a=Math.max(0,r-1),d=b(n),y={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:a,dataVersion:s,changes:[],fullSnapshot:n,previousSnapshot:n,snapshotHash:d,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(u.changeLogs).values(y),a}async function C({data:e,broadcastAction:t,client:r}){let i={success:!1};try{!function(e){if(!a.Z(e.entityId))throw Error("Invalid entityId");if(!a.Z(e.userId))throw Error("Invalid userId");let t=l[e.entityType],r=e[t];if(!r||"string"!=typeof r||!a.Z(r))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(r!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let s=g[e.entityType]||[];for(let t of s){let r=e[t];if(null!=r&&("string"!=typeof r||!a.Z(r)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(l).map(([t,r])=>({type:t,key:r,value:e[r]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!s.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let n=async t=>{var r;let i,n,a;let d=o.Z(),y=(r=e.entityType,f.includes(r)),l=Number.isFinite(e.version)?Number(e.version):null,g=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(y){let r=await I(t,e.entityId,e.entityType);if(n=r,i=(r??0)+1,a=await w({client:t,data:e,computedVersion:i,dataVersion:g,baselineSnapshot:e.baselineSnapshot}),null!==l&&l!==i){if(l<i);else throw c.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:l,latestChangeLogVersion:r,computedVersion:i}),Error(`Provided version (${e.version}) does not match expected changelog version (${i}) for versionless entity ${e.entityType}`)}}else{let r=e.entityType,s=await m(t,{...e,entityType:r}),o=p[r],d=await I(t,e.entityId,e.entityType);if(n=d,Number.isFinite(d)){let e=Number(d)+1;i=s<=Number(d)?e:s}else i=s;if(a=await w({client:t,data:e,computedVersion:i,dataVersion:g,baselineSnapshot:e.baselineSnapshot}),null!==l&&l!==i){if(l<i);else throw c.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:l,entityVersion:s,latestChangeLogVersion:d,computedVersion:i}),Error(`Provided version (${e.version}) does not match ${o.entityLabel} version (${i})`)}}let h=e.snapshotHash||b(e.fullSnapshot);if(!h)throw Error("snapshotHash is required");let v=e.previousSnapshot??e.baselineSnapshot??{},C={changeLogId:d,entityId:e.entityId,entityType:e.entityType,action:e.action,version:i,dataVersion:g,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:v,snapshotHash:h,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===n?a:n),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[L]=await t.insert(u.changeLogs).values(C).returning();return L&&L.entityId&&Number.isFinite(L.version)&&await t.update(u.changeLogs).set({isActive:!1,supersededBy:L.version,supersededAt:L.dateOfChange??new Date}).where((0,s.xD)((0,s.eq)(u.changeLogs.entityId,L.entityId),(0,s.eq)(u.changeLogs.entityType,L.entityType),(0,s.lt)(u.changeLogs.version,L.version),(0,s.eq)(u.changeLogs.isActive,!0))),L},h=r?await n(r):await d.Z.transaction(n);return i.success=!0,i.data=h,t&&y.Z.emit("data_changed","save_change_log"),i}catch(e){return i.success=!1,i.errors=[e.message],c.Z.error("_saveChangeLog ERROR",e.message),i}}async function L({data:e,broadcastAction:t}){let r=0,s=[];try{return await d.Z.transaction(async t=>{for(let i of e){let e=await C({data:i,client:t});if(e.errors?.length)throw s.push(...e.errors),Error(s.join(", "));r++}}),t&&!s.length&&y.Z.emit("data_changed","save_change_logs"),{success:!s.length,errors:s.length?s:void 0,saved:r}}catch(e){return c.Z.error("_saveChangeLogs ERROR",e.message),r=0,{success:!1,errors:[e.message],saved:r}}}},88317:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});let s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,i=function(e){return"string"==typeof e&&s.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1633,1744,1337,3788,2758,4901,5059,413,6267,3883],()=>r(16349));module.exports=s})();