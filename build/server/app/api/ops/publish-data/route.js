"use strict";(()=>{var e={};e.id=981,e.ids=[981],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},96119:e=>{e.exports=require("perf_hooks")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},49411:e=>{e.exports=require("node:path")},91919:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>h,patchFetch:()=>K,requestAsyncStorage:()=>u,routeModule:()=>g,serverHooks:()=>p,staticGenerationAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{POST:()=>f});var i=s(49303),a=s(88716),n=s(60670),o=s(87070),d=s(72761),c=s(71271),l=s(57435);async function f(e){try{if(!(await (0,d.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),s=await (0,c.publishData)(t);return o.NextResponse.json(s)}catch(e){return l.Z.log("/api/ops/publish-data",e),o.NextResponse.json({errors:[e.message]})}}let g=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/ops/publish-data/route",pathname:"/api/ops/publish-data",filename:"route",bundlePath:"app/api/ops/publish-data/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/ops/publish-data/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:y,serverHooks:p}=g,h="/api/ops/publish-data/route";function K(){return(0,n.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:y})}},71271:(e,t,s)=>{s.r(t),s.d(t,{$$ACTION_0:()=>C,$$ACTION_1:()=>U,countAllDrafts:()=>B,discardDrafts:()=>S,getEditorDetails:()=>A,publishData:()=>V,revalidatePath:()=>O});var r=s(24330);s(60166);var i=s(57708),a=s(88317),n=s(57435),o=s(66267),d=s(57745),c=s(34149),l=s(10413),f=s(93567);async function g(e){try{let{items:t,broadcastAction:s}={...e},r=["configKeys"===t?(0,d.K0)(f.pendingDeletion.configKeyId):void 0,"drugsLibrary"===t?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0,"dataKeys"===t?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0,"scripts"===t?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,d.K0)(f.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0];return await l.Z.delete(f.pendingDeletion).where(r.length?(0,d.xD)(...r):void 0),s&&a.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return n.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function u(e){try{let{items:t}={...e},s=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("configKeys"===t?(0,d.K0)(f.pendingDeletion.configKeyId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});s.length&&await l.Z.update(f.configKeys).set({deletedAt:new Date}).where((0,d.d3)(f.configKeys.configKeyId,s.map(e=>e.configKeyId)));let r=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("drugsLibrary"===t?(0,d.K0)(f.pendingDeletion.drugsLibraryItemId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)}),i=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("dataKeys"===t?(0,d.K0)(f.pendingDeletion.dataKeyId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});i.length&&await l.Z.update(f.dataKeys).set({deletedAt:new Date,name:(0,c.i6)`CONCAT(${f.dataKeys.name}, '_', ${f.dataKeys.uuid})`}).where((0,d.d3)(f.dataKeys.uuid,i.map(e=>e.dataKeyId))),r.length&&await l.Z.update(f.drugsLibrary).set({deletedAt:new Date,key:(0,c.i6)`CONCAT(${f.drugsLibrary.key}, '_', ${f.drugsLibrary.itemId})`}).where((0,d.d3)(f.drugsLibrary.itemId,r.map(e=>e.drugsLibraryItemId)));let a=await l.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,d.xD)((0,d.K0)(f.pendingDeletion.scriptId),(0,d.Ft)(f.pendingDeletion.screenId),(0,d.Ft)(f.pendingDeletion.diagnosisId),e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0):void 0});a.length&&(await l.Z.update(f.scripts).set({deletedAt:new Date}).where((0,d.d3)(f.scripts.scriptId,a.map(e=>e.scriptId))),await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.scriptId,a.map(e=>e.scriptId))),await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.scriptId,a.map(e=>e.scriptId))));let n=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("screens"===t?(0,d.K0)(f.pendingDeletion.screenId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});n.length&&await l.Z.update(f.screens).set({deletedAt:new Date}).where((0,d.d3)(f.screens.screenId,n.map(e=>e.screenId)));let o=await l.Z.query.pendingDeletion.findMany({where:(0,d.xD)("diagnoses"===t?(0,d.K0)(f.pendingDeletion.diagnosisId):void 0,e?.userId?(0,d.eq)(f.pendingDeletion.createdByUserId,e.userId):void 0)});return o.length&&await l.Z.update(f.diagnoses).set({deletedAt:new Date}).where((0,d.d3)(f.diagnoses.diagnosisId,o.map(e=>e.diagnosisId))),await g(e),{success:!0}}catch(e){return n.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var y=s(25060),p=s(21162),h=s(45241),K=s(92963),D=s(17137),I=s(73543),w=s(20084),m=s(22418),Z=s(88781),v=s(88778),b=s(16916);async function q({data:e,increaseVersion:t,broadcastAction:s,syncSilently:r}){try{let i=await l.Z.query.editorInfo.findFirst();if(i){let s=t?i.dataVersion+1:i.dataVersion;await l.Z.update(f.editorInfo).set({...e,dataVersion:s}).where((0,d.eq)(f.editorInfo.id,i.id))}return(i=await l.Z.query.editorInfo.findFirst())&&s&&!r&&a.Z.emit("data_changed","save_editor_info"),{data:i||null,success:!!i}}catch(e){return n.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var R=s(18496),_=s(36864),x=s(40618);async function A(){let e=[],t=!1;try{let s=await (0,R.y)();s.errors?.forEach(t=>e.push(t));let r=await y.Ur();r.errors?.forEach(t=>e.push(t));let{errors:i,...a}=await y.Yi();return i?.forEach(t=>e.push(t)),t=!!a.total||!!r.total,{pendingDeletion:r.total,drafts:a,errors:e.length?e:void 0,shouldPublishData:t,info:s.data}}catch(s){return n.Z.error("getEditorDetails ERROR",s.message),{errors:[s.message,...e],pendingDeletion:0,drafts:y.Ic,shouldPublishData:t,info:null}}}let O=(0,r.j)("e584eea53fe697cdba6835e3a5f23e256760fd14",C);async function C(e,t){return(0,i.revalidatePath)(e,t)}let B=(0,r.j)("6c4c8093da4330fc3d7393832fd9d8e2f17a4bd3",U);async function U(){try{let e=await D.G$(),t=await w.Py(),s=await Z.G$(),r=await b.gc(),i=await p.co(),a=await p.ix(),n=await p.tW();return{configKeys:e.data.allDrafts,hospitals:t.data.allDrafts,drugsLibrary:s.data.allDrafts,screens:i.data.allDrafts,scripts:a.data.allDrafts,diagnoses:n.data.allDrafts,dataKeys:r.data.allDrafts}}catch(e){return n.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,hospitals:0,diagnoses:0}}}async function V({scope:e}){let t={success:!0};try{let s=await (0,o.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]),r=s?.user?.userId||null,i=r;1===e&&(i=null);let d=await (0,R.y)(),c=(d.data?.dataVersion||1)+1,l=await K.h({userId:i,publisherUserId:r,dataVersion:c}),f=await I.fn({userId:i,publisherUserId:r,dataVersion:c}),g=await m.hA({userId:i,publisherUserId:r,dataVersion:c}),y=await v.Hc({userId:i,publisherUserId:r,dataVersion:c}),p=await h.Ls({userId:i,publisherUserId:r,dataVersion:c}),D=await h.Ry({userId:i,publisherUserId:r,dataVersion:c}),w=await h.gv({userId:i,publisherUserId:r,dataVersion:c}),Z=await u({userId:i,publisherUserId:r||void 0});y.errors&&(t.success=!1,t.errors=[...t.errors||[],...y.errors]),l.errors&&(t.success=!1,t.errors=[...t.errors||[],...l.errors]),f.errors&&(t.success=!1,t.errors=[...t.errors||[],...f.errors]),g.errors&&(t.success=!1,t.errors=[...t.errors||[],...g.errors]),p.errors&&(t.success=!1,t.errors=[...t.errors||[],...p.errors]),D.errors&&(t.success=!1,t.errors=[...t.errors||[],...D.errors]),w.errors&&(t.success=!1,t.errors=[...t.errors||[],...w.errors]),Z.errors&&(t.success=!1,t.errors=[...t.errors||[],...Z.errors]);let b=await q({increaseVersion:t.success,broadcastAction:!0,data:{lastPublishDate:new Date}});if(t.success&&b.success&&b.data?.dataVersion&&r){let e=b.data.dataVersion,t=new Date,s=await (0,_.C)({data:{entityId:"00000000-0000-0000-0000-000000000000",entityType:"release",action:"publish",dataVersion:e,changes:[{action:"publish",description:`Release v${e} published`,fromDataVersion:e-1,toDataVersion:e}],fullSnapshot:{dataVersion:e,publishedAt:t.toISOString(),publishedBy:r},previousSnapshot:{},baselineSnapshot:{dataVersion:e,publishedAt:t.toISOString(),publishedBy:r},description:`Release v${e} published`,changeReason:`Release v${e} published`,isActive:!1,userId:r}});s.success||n.Z.error("publishData release changelog warning",s.errors?.join(", ")||"Unknown error")}a.Z.emit("data_changed","publish_data")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}async function S({scope:e}){let t={success:!0};try{let t=await (0,o.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),s=t?.user?.userId;1===e&&(s=void 0),await K.sj({userId:s}),await I.q5({userId:s}),await m.Ms({userId:s}),await v.F$({userId:s}),await h.VQ({userId:s}),await h.In({userId:s}),await h.cF({userId:s}),await g({userId:s}),a.Z.emit("data_changed","discard_drafts")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}(0,x.h)([A,O,B,V,S]),(0,r.j)("49172b38c10122728aa1b2fc14d20f7760f2abd3",A),(0,r.j)("bc2ee616f8ba694d4ae301d1c34ff957771a7cfb",O),(0,r.j)("93f98a1a18e2ffbbcd9b86311fd7e5a2204d9828",B),(0,r.j)("3628525f9968b3410608c9eeaf253358ba48d9fe",V),(0,r.j)("f28667e6446bdcb1da1b47a90e98f363919ccac6",S)},92963:(e,t,s)=>{s.d(t,{sj:()=>f,LR:()=>g,h:()=>h,UZ:()=>l});var r=s(57745),i=s(81445),a=s(9576),n=s(57435),o=s(10413),d=s(93567),c=s(88317);async function l({data:e,broadcastAction:t,userId:s}){let l={success:!1};try{let t=[];for(let{configKeyId:n,...c}of e)try{let e=n||a.Z();if(!t.length){let t=n?await o.Z.query.configKeysDrafts.findFirst({where:(0,r.eq)(d.configKeysDrafts.configKeyDraftId,e)}):null,a=t||!n?null:await o.Z.query.configKeys.findFirst({where:(0,r.eq)(d.configKeys.configKeyId,e)});if(t){let s={...t.data,...c};await o.Z.update(d.configKeysDrafts).set({data:s,position:s.position}).where((0,r.eq)(d.configKeysDrafts.configKeyDraftId,e))}else{let t=c.position||a?.position;if(!t){let e=await o.Z.query.configKeys.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeys.position)}),s=await o.Z.query.configKeysDrafts.findFirst({columns:{position:!0},orderBy:(0,i.C)(d.configKeysDrafts.position)});t=Math.max(0,e?.position||0,s?.position||0)+1}let r={...a,...c,configKeyId:e,version:a?.version?a.version+1:1,position:t};await o.Z.insert(d.configKeysDrafts).values({data:r,configKeyDraftId:e,position:r.position,configKeyId:a?.configKeyId,createdByUserId:s})}}}catch(e){t.push(e.message)}t.length?l.errors=t:l.success=!0}catch(e){l.success=!1,l.errors=[e.message],n.Z.error("_saveConfigKeys ERROR",e.message)}finally{return!l?.errors?.length&&t&&c.Z.emit("data_changed","save_config_keys"),l}}async function f(e){try{return await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,r.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function g({configKeysIds:e,broadcastAction:t,userId:s}){let i={success:!1};try{if(e.length){await o.Z.delete(d.configKeysDrafts).where((0,r.d3)(d.configKeysDrafts.configKeyDraftId,e));let t=(await o.Z.select({configKeyId:d.configKeys.configKeyId,pendingDeletion:d.pendingDeletion.configKeyId}).from(d.configKeys).leftJoin(d.pendingDeletion,(0,r.eq)(d.pendingDeletion.configKeyId,d.configKeys.configKeyId)).where((0,r.d3)(d.configKeys.configKeyId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:s}));t.length&&await o.Z.insert(d.pendingDeletion).values(t)}i.success=!0}catch(e){i.success=!1,i.errors=[e.message],n.Z.error("_deleteConfigKeys ERROR",e.message)}finally{return!i?.errors?.length&&t&&c.Z.emit("data_changed","delete_config_keys"),i}}async function u({previous:e,drafts:t,userId:s}){let r=[];try{let i=[];for(let a of t){let t=a?.data?.configKeyId;if(!t)continue;let n={version:a?.data?.version||1,configKeyId:t,changes:{}},o=1===(a?.data?.version||1);if(o)n.changes={action:"create_config_key",description:"Create config key",oldValues:[],newValues:[]};else{let s=e.find(e=>e.configKeyId===t),r=[],i=[];Object.keys({...a?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=a.data[e],n={...s}[e];JSON.stringify(t)!==JSON.stringify(n)&&(r.push({[e]:n}),i.push({[e]:t}))}),n.changes={action:"update_config_key",description:"Update config key",oldValues:r,newValues:i}}if(i.push(n),s){let{...i}=a.data||{},d=JSON.parse(JSON.stringify(i)),c=o?{}:JSON.parse(JSON.stringify(e.find(e=>e.configKeyId===t)||{}));r.push({entityId:t,entityType:"config_key",action:o?"create":"update",version:n.version||1,changes:n.changes,fullSnapshot:d,previousSnapshot:c,baselineSnapshot:c,userId:s,configKeyId:t})}}i.length&&await o.Z.insert(d.configKeysHistory).values(i)}catch(e){n.Z.error(e.message)}return r}var y=s(34149),p=s(36864);async function h(e){let t={success:!1},s=[];try{let i=[],c=[],l=await o.Z.query.configKeysDrafts.findMany({where:e?.userId?(0,r.eq)(d.configKeysDrafts.createdByUserId,e?.userId):void 0});if(i=l.filter(e=>e.configKeyId),c=l.filter(e=>!e.configKeyId),i.length){let t=[];for(let{configKeyId:e,data:s}of(i.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,r.d3)(d.configKeys.configKeyId,i.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),i)){let{configKeyId:t,id:i,oldConfigKeyId:a,createdAt:n,updatedAt:c,deletedAt:l,...f}=s,g={...f,publishDate:new Date};await o.Z.update(d.configKeys).set(g).where((0,r.eq)(d.configKeys.configKeyId,e)).returning()}let a=await u({drafts:i,previous:t,userId:e?.publisherUserId});s.push(...a.map(t=>({...t,dataVersion:e?.dataVersion})))}if(c.length){let t=[];for(let{id:e,data:s}of(c.filter(e=>e.configKeyId).length&&(t=await o.Z.query.configKeys.findMany({where:(0,r.d3)(d.configKeys.configKeyId,c.filter(e=>e.configKeyId).map(e=>e.configKeyId))})),c)){let t=s.configKeyId||(0,a.Z)(),r={...s,configKeyId:t};c=c.map(s=>(s.id===e&&(s.data.configKeyId=t),s)),await o.Z.insert(d.configKeys).values(r)}let i=await u({drafts:c,previous:t,userId:e?.publisherUserId});s.push(...i.map(t=>({...t,dataVersion:e?.dataVersion})))}await o.Z.delete(d.configKeysDrafts).where(e?.userId?(0,r.eq)(d.configKeysDrafts.createdByUserId,e.userId):void 0);let f=await o.Z.query.pendingDeletion.findMany({where:(0,r.xD)((0,r.K0)(d.pendingDeletion.configKeyId),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0),columns:{configKeyId:!0},with:{configKey:!0}});if((f=f.filter(e=>e.configKey)).length){let t=new Date;await o.Z.update(d.configKeys).set({deletedAt:t}).where((0,r.d3)(d.configKeys.configKeyId,f.map(e=>e.configKeyId)));let i=f.map(e=>({version:e.configKey.version,configKeyId:e.configKeyId,changes:{action:"delete_config_key",description:"Delete config key",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await o.Z.insert(d.configKeysHistory).values(i),e?.publisherUserId)for(let r=0;r<f.length;r++){let a=f[r],n=i[r];if(!a?.configKeyId)continue;let o={...a.configKey??{},deletedAt:t};s.push({entityId:a.configKeyId,entityType:"config_key",action:"delete",version:n.version||1,dataVersion:e.dataVersion,changes:n.changes,fullSnapshot:JSON.parse(JSON.stringify(o)),previousSnapshot:JSON.parse(JSON.stringify(o)),baselineSnapshot:JSON.parse(JSON.stringify(o)),description:n.changes.description,userId:e.publisherUserId,configKeyId:a.configKeyId,isActive:!1})}}await o.Z.delete(d.pendingDeletion).where((0,r.xD)((0,r.or)((0,r.K0)(d.pendingDeletion.configKeyId),(0,r.K0)(d.pendingDeletion.configKeyDraftId)),e?.userId?(0,r.eq)(d.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...i.map(e=>e.configKeyId),...f.map(e=>e.configKeyId)];if(g.length&&await o.Z.update(d.configKeys).set({version:(0,y.i6)`${d.configKeys.version} + 1`}).where((0,r.d3)(d.configKeys.configKeyId,g)),s.length){let e=await (0,p.F)({data:s,allowPartial:!0});e.errors?.length&&n.Z.error("_publishConfigKeys changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("_publishConfigKeys ERROR",e)}finally{return t}}},17137:(e,t,s)=>{s.d(t,{G$:()=>u,ZV:()=>g,SL:()=>l,aP:()=>c});var r=s(57745),i=s(30900),a=s(9576),n=s(10413),o=s(93567),d=s(57435);async function c(e){try{let{configKeysIds:t,returnDraftsIfExist:s}={...e},d=t||[],c=d?.length?(0,r.d3)(o.configKeysDrafts.configKeyDraftId,d.map(e=>i.Z(e)?e:a.Z())):void 0,l=[...c?[c]:[]],f=s?await n.Z.query.configKeysDrafts.findMany({where:(0,r.xD)(...l)}):[];d=d.filter(e=>!f.map(e=>e.configKeyDraftId).includes(e));let g=f.length?(0,r.Nl)(o.configKeys.configKeyId,f.map(e=>e.configKeyDraftId)):void 0,u=d?.length?(0,r.d3)(o.configKeys.configKeyId,d.filter(e=>i.Z(e))):void 0,y=d?.length?(0,r.d3)(o.configKeys.oldConfigKeyId,d.filter(e=>!i.Z(e))):void 0,p=[(0,r.Ft)(o.configKeys.deletedAt),(0,r.Ft)(o.pendingDeletion),...u&&y?[(0,r.or)(u,y)]:[],g],h=(await n.Z.select({configKey:o.configKeys,pendingDeletion:o.pendingDeletion}).from(o.configKeys).leftJoin(o.pendingDeletion,(0,r.eq)(o.pendingDeletion.configKeyId,o.configKeys.configKeyId)).where(p.length?(0,r.xD)(...p):void 0)).map(e=>e.configKey),K=h.length?await n.Z.query.pendingDeletion.findMany({where:(0,r.d3)(o.pendingDeletion.configKeyId,h.map(e=>e.configKeyId)),columns:{configKeyId:!0}}):[];return{data:[...h.map(e=>({...e,isDraft:!1,isDeleted:!1})),...f.map(e=>({...e.data,isDraft:!0,isDeleted:!1,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>e.position-t.position).filter(e=>!K.map(e=>e.configKeyId).includes(e.configKeyId))}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:[],errors:[e.message]}}}async function l(e){let{configKeyId:t,returnDraftIfExists:s}={...e};try{if(!t)throw Error("Missing configKeyId");let e=i.Z(t)?(0,r.eq)(o.configKeys.configKeyId,t):void 0,a=i.Z(t)?void 0:(0,r.eq)(o.configKeys.oldConfigKeyId,t),d=e?(0,r.eq)(o.configKeysDrafts.configKeyDraftId,t):void 0,c=s&&d?await n.Z.query.configKeysDrafts.findFirst({where:e}):void 0,l=c?{...c.data,draftCreatedByUserId:c.createdByUserId,isDraft:!0,isDeleted:!1}:null;if(l)return{data:l};let f=await n.Z.query.configKeys.findFirst({where:(0,r.xD)((0,r.Ft)(o.configKeys.deletedAt),e||a),with:{draft:!0}});c=s?f?.draft:void 0;let g=c?.data||f;if(!(l=g?{...g,draftCreatedByUserId:c?.createdByUserId,isDraft:!!c?.data,isDeleted:!1}:null))return{data:null};return{data:l}}catch(e){return d.Z.error("_getConfigKey ERROR",e.message),{errors:[e.message]}}}var f=s(60938);let g={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts),[{count:t}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,r.Ft)(o.configKeysDrafts.configKeyId)),[{count:s}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeysDrafts).where((0,r.K0)(o.configKeysDrafts.configKeyId)),[{count:i}]=await n.Z.select({count:(0,f.QX)()}).from(o.pendingDeletion).where((0,r.K0)(o.pendingDeletion.configKeyId)),[{count:a}]=await n.Z.select({count:(0,f.QX)()}).from(o.configKeys);return{data:{allPublished:a,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:i}}}catch(e){return d.Z.error("_getConfigKeys ERROR",e.message),{data:g,errors:[e.message]}}}},18496:(e,t,s)=>{s.d(t,{y:()=>a});var r=s(10413),i=s(57435);async function a(){try{return{data:await r.Z.query.editorInfo.findFirst()||null}}catch(e){return i.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,t,s)=>{s.d(t,{Yi:()=>g,Ur:()=>l,Nb:()=>c,Ic:()=>f});var r=s(60938),i=s(57435),a=s(93567),n=s(10413),o=s(81445);let d={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function c(){try{let{lastPublishDate:e}={...await n.Z.query.editorInfo.findFirst()},t=await n.Z.select({configKeysDrafts:a.configKeysDrafts.updatedAt}).from(a.configKeysDrafts).orderBy((0,o.C)(a.configKeysDrafts.updatedAt)).limit(1),s=await n.Z.select({diagnosesDrafts:a.diagnosesDrafts.updatedAt}).from(a.diagnosesDrafts).orderBy((0,o.C)(a.diagnosesDrafts.updatedAt)).limit(1),r=await n.Z.select({screensDrafts:a.screensDrafts.updatedAt}).from(a.screensDrafts).orderBy((0,o.C)(a.screensDrafts.updatedAt)).limit(1),i=await n.Z.select({scriptsDrafts:a.scriptsDrafts.updatedAt}).from(a.scriptsDrafts).orderBy((0,o.C)(a.scriptsDrafts.updatedAt)).limit(1),c=await n.Z.select({configKeys:a.configKeys.updatedAt}).from(a.configKeys).orderBy((0,o.C)(a.configKeys.updatedAt)).limit(1),l=await n.Z.select({diagnoses:a.diagnoses.updatedAt}).from(a.diagnoses).orderBy((0,o.C)(a.diagnoses.updatedAt)).limit(1),f=await n.Z.select({screens:a.screens.updatedAt}).from(a.screens).orderBy((0,o.C)(a.screens.updatedAt)).limit(1),g=await n.Z.select({scripts:a.scripts.updatedAt}).from(a.scripts).orderBy((0,o.C)(a.scripts.updatedAt)).limit(1),u=await n.Z.select({pendingDeletion:a.pendingDeletion.createdAt}).from(a.pendingDeletion).orderBy((0,o.C)(a.pendingDeletion.createdAt)).limit(1),y={...d,...t[0],...s[0],...r[0],...i[0],...c[0],...l[0],...f[0],...g[0],...u[0],lastPublished:e||null},p=[e?new Date(e).getTime():null,...Object.values(y).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),h=e;return p.length&&(h=new Date(Math.max(...p))),{data:{...y,latestChangesDate:h}}}catch(e){return i.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:d,errors:[e.message]}}}async function l(){try{let e=await n.Z.select({count:(0,r.QX)()}).from(a.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return i.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let f={scripts:0,screens:0,diagnoses:0,configKeys:0,hospitals:0,drugsLibraryItems:0,total:0,dataKeys:0};async function g(){let e={...f};try{let t=await n.Z.select({count:(0,r.QX)()}).from(a.scriptsDrafts);e.scripts=t[0]?.count||0;let s=await n.Z.select({count:(0,r.QX)()}).from(a.screensDrafts);e.screens=s[0]?.count||0;let i=await n.Z.select({count:(0,r.QX)()}).from(a.diagnosesDrafts);e.diagnoses=i[0]?.count||0;let o=await n.Z.select({count:(0,r.QX)()}).from(a.configKeysDrafts);e.configKeys=o[0]?.count||0;let d=await n.Z.select({count:(0,r.QX)()}).from(a.hospitalsDrafts);e.hospitals=d[0]?.count||0;let c=await n.Z.select({count:(0,r.QX)()}).from(a.drugsLibraryDrafts);e.drugsLibraryItems=c[0]?.count||0;let l=await n.Z.select({count:(0,r.QX)()}).from(a.dataKeysDrafts);return e.dataKeys=l[0]?.count||0,e.total=Object.values(e).reduce((e,t)=>e+t,0),{...e}}catch(t){return i.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9380,1744,1337,3788,2758,9092,4901,5059,1121,413,6267,6741,8781,1162,6826,5241,2418,8778,2303],()=>s(91919));module.exports=r})();