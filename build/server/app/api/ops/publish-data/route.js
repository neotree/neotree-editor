"use strict";(()=>{var e={};e.id=981,e.ids=[981],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},96119:e=>{e.exports=require("perf_hooks")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},49411:e=>{e.exports=require("node:path")},91919:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>D,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>u});var a=r(49303),i=r(88716),n=r(60670),d=r(87070),o=r(72761),c=r(71271),l=r(57435);async function u(e){try{if(!(await (0,o.$)()).yes)return d.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),r=await (0,c.publishData)(t);return d.NextResponse.json(r)}catch(e){return l.Z.log("/api/ops/publish-data",e),d.NextResponse.json({errors:[e.message]})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/ops/publish-data/route",pathname:"/api/ops/publish-data",filename:"route",bundlePath:"app/api/ops/publish-data/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/ops/publish-data/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y}=p,D="/api/ops/publish-data/route";function w(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},71271:(e,t,r)=>{r.r(t),r.d(t,{$$ACTION_0:()=>j,$$ACTION_1:()=>E,countAllDrafts:()=>O,discardDrafts:()=>B,getEditorDetails:()=>R,publishData:()=>C,revalidatePath:()=>_});var s=r(24330);r(60166);var a=r(57708),i=r(88317),n=r(57435),d=r(66267),o=r(57745),c=r(34149),l=r(10413),u=r(93567);async function p(e){try{let{items:t,broadcastAction:r}={...e},s=["configKeys"===t?(0,o.K0)(u.pendingDeletion.configKeyId):void 0,"drugsLibrary"===t?(0,o.K0)(u.pendingDeletion.drugsLibraryItemId):void 0,"dataKeys"===t?(0,o.K0)(u.pendingDeletion.dataKeyId):void 0,"scripts"===t?(0,o.xD)((0,o.K0)(u.pendingDeletion.scriptId),(0,o.Ft)(u.pendingDeletion.screenId),(0,o.Ft)(u.pendingDeletion.diagnosisId)):void 0,"screens"===t?(0,o.K0)(u.pendingDeletion.screenId):void 0,"diagnoses"===t?(0,o.K0)(u.pendingDeletion.diagnosisId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0];return await l.Z.delete(u.pendingDeletion).where(s.length?(0,o.xD)(...s):void 0),r&&i.Z.emit("data_changed","clear_pending_deletion"),{success:!0}}catch(e){return n.Z.error("_clearPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}async function g(e){try{let{items:t}={...e},r=await l.Z.query.pendingDeletion.findMany({where:(0,o.xD)("configKeys"===t?(0,o.K0)(u.pendingDeletion.configKeyId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0)});r.length&&await l.Z.update(u.configKeys).set({deletedAt:new Date}).where((0,o.d3)(u.configKeys.configKeyId,r.map(e=>e.configKeyId)));let s=await l.Z.query.pendingDeletion.findMany({where:(0,o.xD)("drugsLibrary"===t?(0,o.K0)(u.pendingDeletion.drugsLibraryItemId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0)}),a=await l.Z.query.pendingDeletion.findMany({where:(0,o.xD)("dataKeys"===t?(0,o.K0)(u.pendingDeletion.dataKeyId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0)});a.length&&await l.Z.update(u.dataKeys).set({deletedAt:new Date,name:(0,c.i6)`CONCAT(${u.dataKeys.name}, '_', ${u.dataKeys.uuid})`}).where((0,o.d3)(u.dataKeys.uuid,a.map(e=>e.dataKeyId))),s.length&&await l.Z.update(u.drugsLibrary).set({deletedAt:new Date,key:(0,c.i6)`CONCAT(${u.drugsLibrary.key}, '_', ${u.drugsLibrary.itemId})`}).where((0,o.d3)(u.drugsLibrary.itemId,s.map(e=>e.drugsLibraryItemId)));let i=await l.Z.query.pendingDeletion.findMany({where:"scripts"===t?(0,o.xD)((0,o.K0)(u.pendingDeletion.scriptId),(0,o.Ft)(u.pendingDeletion.screenId),(0,o.Ft)(u.pendingDeletion.diagnosisId),e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0):void 0});i.length&&(await l.Z.update(u.scripts).set({deletedAt:new Date}).where((0,o.d3)(u.scripts.scriptId,i.map(e=>e.scriptId))),await l.Z.update(u.screens).set({deletedAt:new Date}).where((0,o.d3)(u.screens.scriptId,i.map(e=>e.scriptId))),await l.Z.update(u.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(u.diagnoses.scriptId,i.map(e=>e.scriptId))));let n=await l.Z.query.pendingDeletion.findMany({where:(0,o.xD)("screens"===t?(0,o.K0)(u.pendingDeletion.screenId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0)});n.length&&await l.Z.update(u.screens).set({deletedAt:new Date}).where((0,o.d3)(u.screens.screenId,n.map(e=>e.screenId)));let d=await l.Z.query.pendingDeletion.findMany({where:(0,o.xD)("diagnoses"===t?(0,o.K0)(u.pendingDeletion.diagnosisId):void 0,e?.userId?(0,o.eq)(u.pendingDeletion.createdByUserId,e.userId):void 0)});return d.length&&await l.Z.update(u.diagnoses).set({deletedAt:new Date}).where((0,o.d3)(u.diagnoses.diagnosisId,d.map(e=>e.diagnosisId))),await p(e),{success:!0}}catch(e){return n.Z.error("_processPendingDeletion ERROR",e.message),{success:!1,errors:[e.message]}}}var f=r(25060),y=r(21162),D=r(45241),w=r(92963),h=r(17137),m=r(73543),I=r(20084),b=r(22418),x=r(88781),Z=r(88778),q=r(16916);async function K({data:e,increaseVersion:t,broadcastAction:r,syncSilently:s}){try{let a=await l.Z.query.editorInfo.findFirst();if(a){let r=t?a.dataVersion+1:a.dataVersion;await l.Z.update(u.editorInfo).set({...e,dataVersion:r}).where((0,o.eq)(u.editorInfo.id,a.id))}return(a=await l.Z.query.editorInfo.findFirst())&&r&&!s&&i.Z.emit("data_changed","save_editor_info"),{data:a||null,success:!!a}}catch(e){return n.Z.error("_saveEditorInfo ERROR",e.message),{data:null,success:!1,errors:[e.message]}}}var v=r(18496),A=r(40618);async function R(){let e=[],t=!1;try{let r=await (0,v.y)();r.errors?.forEach(t=>e.push(t));let s=await f.Ur();s.errors?.forEach(t=>e.push(t));let{errors:a,...i}=await f.Yi();return a?.forEach(t=>e.push(t)),t=!!i.total||!!s.total,{pendingDeletion:s.total,drafts:i,errors:e.length?e:void 0,shouldPublishData:t,info:r.data}}catch(r){return n.Z.error("getEditorDetails ERROR",r.message),{errors:[r.message,...e],pendingDeletion:0,drafts:f.Ic,shouldPublishData:t,info:null}}}let _=(0,s.j)("e584eea53fe697cdba6835e3a5f23e256760fd14",j);async function j(e,t){return(0,a.revalidatePath)(e,t)}let O=(0,s.j)("6c4c8093da4330fc3d7393832fd9d8e2f17a4bd3",E);async function E(){try{let e=await h.G$(),t=await I.Py(),r=await x.G$(),s=await q.gc(),a=await y.co(),i=await y.ix(),n=await y.tW();return{configKeys:e.data.allDrafts,hospitals:t.data.allDrafts,drugsLibrary:r.data.allDrafts,screens:a.data.allDrafts,scripts:i.data.allDrafts,diagnoses:n.data.allDrafts,dataKeys:s.data.allDrafts}}catch(e){return n.Z.error("countAllDrafts ERROR",e.message),{screens:0,scripts:0,configKeys:0,hospitals:0,diagnoses:0}}}async function C({scope:e}){let t={success:!0};try{let r=await (0,d.isAllowed)(["create_config_keys","update_config_keys","create_scripts","update_scripts","create_diagnoses","update_diagnoses","create_screens","update_screens"]),s=r?.user?.userId||null,a=s;1===e&&(a=null);let n=await (0,v.y)(),o=(n.data?.dataVersion||1)+1,c=await w.h({userId:a,publisherUserId:s,dataVersion:o}),l=await m.fn({userId:a,publisherUserId:s,dataVersion:o}),u=await b.hA({userId:a,publisherUserId:s,dataVersion:o}),p=await Z.Hc({userId:a,publisherUserId:s,dataVersion:o}),f=await D.Ls({userId:a,publisherUserId:s,dataVersion:o}),y=await D.Ry({userId:a,publisherUserId:s,dataVersion:o}),h=await D.gv({userId:a,publisherUserId:s,dataVersion:o}),I=await g({userId:a,publisherUserId:s||void 0});p.errors&&(t.success=!1,t.errors=[...t.errors||[],...p.errors]),c.errors&&(t.success=!1,t.errors=[...t.errors||[],...c.errors]),l.errors&&(t.success=!1,t.errors=[...t.errors||[],...l.errors]),u.errors&&(t.success=!1,t.errors=[...t.errors||[],...u.errors]),f.errors&&(t.success=!1,t.errors=[...t.errors||[],...f.errors]),y.errors&&(t.success=!1,t.errors=[...t.errors||[],...y.errors]),h.errors&&(t.success=!1,t.errors=[...t.errors||[],...h.errors]),I.errors&&(t.success=!1,t.errors=[...t.errors||[],...I.errors]),await K({increaseVersion:t.success,broadcastAction:!0,data:{lastPublishDate:new Date}}),i.Z.emit("data_changed","publish_data")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}async function B({scope:e}){let t={success:!0};try{let t=await (0,d.isAllowed)(["delete_config_keys","delete_scripts","delete_diagnoses","delete_screens"]),r=t?.user?.userId;1===e&&(r=void 0),await w.sj({userId:r}),await m.q5({userId:r}),await b.Ms({userId:r}),await Z.F$({userId:r}),await D.VQ({userId:r}),await D.In({userId:r}),await D.cF({userId:r}),await p({userId:r}),i.Z.emit("data_changed","discard_drafts")}catch(e){t.success=!1,t.errors=[e.message],n.Z.error("publishData ERROR",e.message)}finally{return t}}(0,A.h)([R,_,O,C,B]),(0,s.j)("49172b38c10122728aa1b2fc14d20f7760f2abd3",R),(0,s.j)("bc2ee616f8ba694d4ae301d1c34ff957771a7cfb",_),(0,s.j)("93f98a1a18e2ffbbcd9b86311fd7e5a2204d9828",O),(0,s.j)("3628525f9968b3410608c9eeaf253358ba48d9fe",C),(0,s.j)("f28667e6446bdcb1da1b47a90e98f363919ccac6",B)},18496:(e,t,r)=>{r.d(t,{y:()=>i});var s=r(10413),a=r(57435);async function i(){try{return{data:await s.Z.query.editorInfo.findFirst()||null}}catch(e){return a.Z.error("_getEditorInfo ERROR",e.message),{data:null,errors:[e.message]}}}},25060:(e,t,r)=>{r.d(t,{Yi:()=>p,Ur:()=>l,Nb:()=>c,Ic:()=>u});var s=r(60938),a=r(57435),i=r(93567),n=r(10413),d=r(81445);let o={configKeys:null,diagnoses:null,screens:null,scripts:null,configKeysDrafts:null,diagnosesDrafts:null,screensDrafts:null,scriptsDrafts:null,pendingDeletion:null,lastPublished:null,latestChangesDate:null};async function c(){try{let{lastPublishDate:e}={...await n.Z.query.editorInfo.findFirst()},t=await n.Z.select({configKeysDrafts:i.configKeysDrafts.updatedAt}).from(i.configKeysDrafts).orderBy((0,d.C)(i.configKeysDrafts.updatedAt)).limit(1),r=await n.Z.select({diagnosesDrafts:i.diagnosesDrafts.updatedAt}).from(i.diagnosesDrafts).orderBy((0,d.C)(i.diagnosesDrafts.updatedAt)).limit(1),s=await n.Z.select({screensDrafts:i.screensDrafts.updatedAt}).from(i.screensDrafts).orderBy((0,d.C)(i.screensDrafts.updatedAt)).limit(1),a=await n.Z.select({scriptsDrafts:i.scriptsDrafts.updatedAt}).from(i.scriptsDrafts).orderBy((0,d.C)(i.scriptsDrafts.updatedAt)).limit(1),c=await n.Z.select({configKeys:i.configKeys.updatedAt}).from(i.configKeys).orderBy((0,d.C)(i.configKeys.updatedAt)).limit(1),l=await n.Z.select({diagnoses:i.diagnoses.updatedAt}).from(i.diagnoses).orderBy((0,d.C)(i.diagnoses.updatedAt)).limit(1),u=await n.Z.select({screens:i.screens.updatedAt}).from(i.screens).orderBy((0,d.C)(i.screens.updatedAt)).limit(1),p=await n.Z.select({scripts:i.scripts.updatedAt}).from(i.scripts).orderBy((0,d.C)(i.scripts.updatedAt)).limit(1),g=await n.Z.select({pendingDeletion:i.pendingDeletion.createdAt}).from(i.pendingDeletion).orderBy((0,d.C)(i.pendingDeletion.createdAt)).limit(1),f={...o,...t[0],...r[0],...s[0],...a[0],...c[0],...l[0],...u[0],...p[0],...g[0],lastPublished:e||null},y=[e?new Date(e).getTime():null,...Object.values(f).filter(e=>e).map(e=>new Date(e).getTime())].filter(e=>e),D=e;return y.length&&(D=new Date(Math.max(...y))),{data:{...f,latestChangesDate:D}}}catch(e){return a.Z.error("_getDatesWhenUpdatesWereMade ERROR",e.message),{data:o,errors:[e.message]}}}async function l(){try{let e=await n.Z.select({count:(0,s.QX)()}).from(i.pendingDeletion);return{total:e[0]?.count||0}}catch(e){return a.Z.error("_countPendingDeletion ERROR",e.message),{total:0,errors:[e.message]}}}let u={scripts:0,screens:0,diagnoses:0,configKeys:0,hospitals:0,drugsLibraryItems:0,total:0,dataKeys:0};async function p(){let e={...u};try{let t=await n.Z.select({count:(0,s.QX)()}).from(i.scriptsDrafts);e.scripts=t[0]?.count||0;let r=await n.Z.select({count:(0,s.QX)()}).from(i.screensDrafts);e.screens=r[0]?.count||0;let a=await n.Z.select({count:(0,s.QX)()}).from(i.diagnosesDrafts);e.diagnoses=a[0]?.count||0;let d=await n.Z.select({count:(0,s.QX)()}).from(i.configKeysDrafts);e.configKeys=d[0]?.count||0;let o=await n.Z.select({count:(0,s.QX)()}).from(i.hospitalsDrafts);e.hospitals=o[0]?.count||0;let c=await n.Z.select({count:(0,s.QX)()}).from(i.drugsLibraryDrafts);e.drugsLibraryItems=c[0]?.count||0;let l=await n.Z.select({count:(0,s.QX)()}).from(i.dataKeysDrafts);return e.dataKeys=l[0]?.count||0,e.total=Object.values(e).reduce((e,t)=>e+t,0),{...e}}catch(t){return a.Z.error("_countDrafts ERROR",t.message),{...e,errors:[t.message]}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,1744,1337,3788,2758,4901,5059,1121,413,6267,6741,8781,1162,9132,2418,8778,2303,3883],()=>r(91919));module.exports=s})();