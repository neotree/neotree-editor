(()=>{var e={};e.id=5205,e.ids=[5205],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},96119:e=>{"use strict";e.exports=require("perf_hooks")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},58359:()=>{},93739:()=>{},28397:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>b,requestAsyncStorage:()=>p,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>u});var i=r(49303),a=r(88716),n=r(60670),o=r(87070),d=r(72761),l=r(57848),c=r(57435);async function u(e){try{if(!(await (0,d.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),r=await (0,l.saveHospitals)({broadcastAction:!0,...t.data});return o.NextResponse.json(r)}catch(e){return c.Z.log("/api/hospitals/update",e),o.NextResponse.json({errors:[e.message]})}}let y=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/hospitals/update/route",pathname:"/api/hospitals/update",filename:"route",bundlePath:"app/api/hospitals/update/route"},resolvedPagePath:"/home/farai/Workbench/Neotree/neotree-editor/app/api/hospitals/update/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:g}=y,h="/api/hospitals/update/route";function b(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},57848:(e,t,r)=>{"use strict";r.r(t),r.d(t,{$$ACTION_0:()=>c,$$ACTION_1:()=>y,$$ACTION_2:()=>f,$$ACTION_3:()=>h,$$ACTION_4:()=>m,countHospitals:()=>u,deleteHospitals:()=>l,getHospital:()=>g,getHospitals:()=>p,saveHospitals:()=>b});var s=r(24330);r(60166);var i=r(73543),a=r(20084),n=r(57435),o=r(66267),d=r(40618);let l=(0,s.j)("6de319d88ede8d5835179324860b5e1ff73d9704",c);async function c(e){try{let t=await (0,o.isAllowed)();return await (0,i.x0)({...e,userId:t.user?.userId})}catch(e){return n.Z.error("deleteHospitals ERROR",e.message),{errors:[e.message],success:!1}}}let u=(0,s.j)("71e5d401b0a17ddbc2421e65bac974cca1b7c7a7",y);async function y(...e){try{return await (0,o.isAllowed)(),await (0,a.Py)(...e)}catch(e){return n.Z.error("countHospitals ERROR",e.message),{errors:[e.message],data:a.SE}}}let p=(0,s.j)("154f78406dd26c01e23c8e2ef62c68bdf4e1abcf",f);async function f(...e){try{return await (0,o.isAllowed)(),await (0,a.O8)(...e)}catch(e){return n.Z.error("getHospitals ERROR",e.message),{errors:[e.message],data:[]}}}let g=(0,s.j)("543eca7d1d5d6f1f356da58f10c82babfdbf02f6",h);async function h(...e){return await (0,o.isAllowed)(),await (0,a.C9)(...e)}let b=(0,s.j)("5d9cef658a17d9e70bae50010807b43db6139a16",m);async function m(e){try{let t=await (0,o.isAllowed)();return await (0,i.rr)({...e,userId:t.user?.userId})}catch(e){return n.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,d.h)([l,u,p,g,b]),(0,s.j)("e7b323b5a91d3ba50c223a3ebae732dba4578b76",l),(0,s.j)("a73b0dc955eb46a83ccb322ce8d75df54bb64801",u),(0,s.j)("f7c1f5ff22d757d951b19ffc8a35ce8b645bb416",p),(0,s.j)("38b982b33c6c0b287d82028b1f16e51b649bb0d8",g),(0,s.j)("bacdad7028d175f340f534690829ca2e20a8ccf5",b)},36864:(e,t,r)=>{"use strict";r.d(t,{C:()=>q,F:()=>$});var s=r(57745),i=r(81445),a=r(84770),n=r(30900),o=r(9576),d=r(57435),l=r(10413),c=r(93567),u=r(88317),y=r(34149);let p={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},f={screen:["scriptId"],diagnosis:["scriptId"]},g=["alias","release"],h=["release"],b={script:{table:c.scripts,idColumn:c.scripts.scriptId,versionColumn:c.scripts.version,entityLabel:"script"},screen:{table:c.screens,idColumn:c.screens.screenId,versionColumn:c.screens.version,entityLabel:"screen"},diagnosis:{table:c.diagnoses,idColumn:c.diagnoses.diagnosisId,versionColumn:c.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:c.configKeys,idColumn:c.configKeys.configKeyId,versionColumn:c.configKeys.version,entityLabel:"config key"},drugs_library:{table:c.drugsLibrary,idColumn:c.drugsLibrary.itemId,versionColumn:c.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:c.dataKeys,idColumn:c.dataKeys.uuid,versionColumn:c.dataKeys.version,entityLabel:"data key"},hospital:{table:c.hospitals,idColumn:c.hospitals.hospitalId,versionColumn:c.hospitals.version,entityLabel:"hospital"}},m={script:{table:c.scripts,idColumn:c.scripts.scriptId,entityLabel:"script"},screen:{table:c.screens,idColumn:c.screens.screenId,entityLabel:"screen"},diagnosis:{table:c.diagnoses,idColumn:c.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:c.configKeys,idColumn:c.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:c.drugsLibrary,idColumn:c.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:c.dataKeys,idColumn:c.dataKeys.uuid,entityLabel:"data key"},alias:{table:c.aliases,idColumn:c.aliases.uuid,entityLabel:"alias"},hospital:{table:c.hospitals,idColumn:c.hospitals.hospitalId,entityLabel:"hospital"}};function I(e){let t=0;for(let r=0;r<e.length;r++)t=31*t+e.charCodeAt(r)|0;return t}async function v(e,t,r){let s=I(t),i=I(r);await e.execute((0,y.i6)`select pg_advisory_xact_lock(${s}, ${i})`)}function w(e){return(0,a.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function x(e,t){let r=b[t.entityType];if(!r)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select({version:r.versionColumn}).from(r.table).where((0,s.eq)(r.idColumn,t.entityId)).limit(1),a=i?.[0]?.version;if(!Number.isFinite(a))throw Error(`Missing ${r.entityLabel} or version for entityId ${t.entityId}`);return Number(a)}async function L(e,t,r){let a=await e.select({version:c.changeLogs.version}).from(c.changeLogs).where((0,s.xD)((0,s.eq)(c.changeLogs.entityId,t),(0,s.eq)(c.changeLogs.entityType,r))).orderBy((0,i.C)(c.changeLogs.version)).limit(1);return a?.[0]?.version}async function T(e,t){let r=m[t.entityType];if(!r)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select().from(r.table).where((0,s.eq)(r.idColumn,t.entityId)).limit(1);if(!i?.[0])throw Error(`Entity not found for snapshot (${r.entityLabel} ${t.entityId})`);return i[0]}async function C({client:e,data:t,computedVersion:r,dataVersion:s,baselineSnapshot:i}){if(Number.isFinite(await L(e,t.entityId,t.entityType)))return;let a=i??t.previousSnapshot;if(void 0===a)try{a=await T(e,t),d.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let n=Math.max(0,r-1),l=w(a),u={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:n,dataVersion:s,changes:[],fullSnapshot:a,previousSnapshot:a,snapshotHash:l,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(c.changeLogs).values(u),n}async function q({data:e,broadcastAction:t,client:r}){let i={success:!1};try{!function(e){if(!n.Z(e.entityId))throw Error("Invalid entityId");if(!n.Z(e.userId))throw Error("Invalid userId");if(h.includes(e.entityType)){if(Object.values(p).map(t=>e[t]).filter(e=>null!=e).length)throw Error(`No foreign keys should be provided for entityType ${e.entityType}`);return}let t=p[e.entityType];if(!t)throw Error(`Unknown entityType ${e.entityType}`);let r=e[t];if(!r||"string"!=typeof r||!n.Z(r))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(r!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let s=f[e.entityType]||[];for(let t of s){let r=e[t];if(null!=r&&("string"!=typeof r||!n.Z(r)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(p).map(([t,r])=>({type:t,key:r,value:e[r]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!s.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let a=async t=>{var r;let i,a,n;await v(t,e.entityType,e.entityId);let l=o.Z(),u=(r=e.entityType,g.includes(r)),y=Number.isFinite(e.version)?Number(e.version):null,p=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(u){let r=await L(t,e.entityId,e.entityType);if(a=r,i=(r??0)+1,n=await C({client:t,data:e,computedVersion:i,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==i){if(y<i);else throw d.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,latestChangeLogVersion:r,computedVersion:i}),Error(`Provided version (${e.version}) does not match expected changelog version (${i}) for versionless entity ${e.entityType}`)}}else{let r=e.entityType,s=await x(t,{...e,entityType:r}),o=b[r],l=await L(t,e.entityId,e.entityType);if(a=l,Number.isFinite(l)){let e=Number(l)+1;i=s<=Number(l)?e:s}else i=s;if(n=await C({client:t,data:e,computedVersion:i,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==i){if(y<i);else throw d.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,entityVersion:s,latestChangeLogVersion:l,computedVersion:i}),Error(`Provided version (${e.version}) does not match ${o.entityLabel} version (${i})`)}}let f=e.snapshotHash||w(e.fullSnapshot);if(!f)throw Error("snapshotHash is required");let h=e.previousSnapshot??e.baselineSnapshot??{},m={changeLogId:l,entityId:e.entityId,entityType:e.entityType,action:e.action,version:i,dataVersion:p,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:h,snapshotHash:f,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===a?n:a),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,hospitalId:e.hospitalId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[I]=await t.insert(c.changeLogs).values(m).returning();return I&&I.entityId&&Number.isFinite(I.version)&&await t.update(c.changeLogs).set({isActive:!1,supersededBy:I.version,supersededAt:I.dateOfChange??new Date}).where((0,s.xD)((0,s.eq)(c.changeLogs.entityId,I.entityId),(0,s.eq)(c.changeLogs.entityType,I.entityType),(0,s.lt)(c.changeLogs.version,I.version),(0,s.eq)(c.changeLogs.isActive,!0))),I},y=r?await a(r):await l.Z.transaction(a);return i.success=!0,i.data=y,t&&u.Z.emit("data_changed","save_change_log"),i}catch(e){return i.success=!1,i.errors=[e.message],d.Z.error("_saveChangeLog ERROR",e.message),i}}async function $({data:e,broadcastAction:t,allowPartial:r}){let s=0,i=[];try{if(r&&e.some(e=>"rollback"===e.action))throw Error("allowPartial is not permitted for rollback changelog writes");if(r)for(let t of e){let e=await q({data:t});if(e.errors?.length){i.push(...e.errors);continue}s++}else await l.Z.transaction(async t=>{for(let r of e){let e=await q({data:r,client:t});if(e.errors?.length)throw i.push(...e.errors),Error(i.join(", "));s++}});return t&&!i.length&&u.Z.emit("data_changed","save_change_logs"),{success:!i.length,errors:i.length?i:void 0,saved:s}}catch(e){return d.Z.error("_saveChangeLogs ERROR",e.message),s=0,{success:!1,errors:[e.message],saved:s}}}},88317:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});let s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,i=function(e){return"string"==typeof e&&s.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,1744,1337,3788,2758,9092,4901,5059,413,6267,2303],()=>r(28397));module.exports=s})();