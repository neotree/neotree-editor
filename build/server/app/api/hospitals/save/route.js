"use strict";(()=>{var e={};e.id=7908,e.ids=[7908],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},96119:e=>{e.exports=require("perf_hooks")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},49411:e=>{e.exports=require("node:path")},53910:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>I,patchFetch:()=>w,requestAsyncStorage:()=>u,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c});var a={};s.r(a),s.d(a,{POST:()=>h});var r=s(49303),i=s(88716),o=s(60670),l=s(87070),n=s(72761),d=s(57848),p=s(57435);async function h(e){try{if(!(await (0,n.$)()).yes)return l.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),s=await (0,d.saveHospitals)({broadcastAction:!0,...t.data});return l.NextResponse.json(s)}catch(e){return p.Z.log("/api/hospitals/save",e),l.NextResponse.json({errors:[e.message]})}}let f=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/hospitals/save/route",pathname:"/api/hospitals/save",filename:"route",bundlePath:"app/api/hospitals/save/route"},resolvedPagePath:"C:\\Users\\HomePC\\Neotree Projects\\neotree-editor\\app\\api\\hospitals\\save\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:c,serverHooks:g}=f,I="/api/hospitals/save/route";function w(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},57848:(e,t,s)=>{s.r(t),s.d(t,{$$ACTION_0:()=>p,$$ACTION_1:()=>f,$$ACTION_2:()=>c,$$ACTION_3:()=>I,$$ACTION_4:()=>y,countHospitals:()=>h,deleteHospitals:()=>d,getHospital:()=>g,getHospitals:()=>u,saveHospitals:()=>w});var a=s(24330);s(60166);var r=s(73543),i=s(20084),o=s(57435),l=s(66267),n=s(40618);let d=(0,a.j)("45fc9b73f0105a3c01c0105233b9dcee848c1014",p);async function p(e){try{let t=await (0,l.isAllowed)();return await (0,r.x0)({...e,userId:t.user?.userId})}catch(e){return o.Z.error("deleteHospitals ERROR",e.message),{errors:[e.message],success:!1}}}let h=(0,a.j)("f7d5033ed07f08e193f6f9961ae50955c4b5f78e",f);async function f(...e){try{return await (0,l.isAllowed)(),await (0,i.Py)(...e)}catch(e){return o.Z.error("countHospitals ERROR",e.message),{errors:[e.message],data:i.SE}}}let u=(0,a.j)("43d0037c602e6e44d9b4683e862d53f43a281d8e",c);async function c(...e){try{return await (0,l.isAllowed)(),await (0,i.O8)(...e)}catch(e){return o.Z.error("getHospitals ERROR",e.message),{errors:[e.message],data:[]}}}let g=(0,a.j)("ae6eaff80f0ec9ee8fd62c0f6f86427986b90aab",I);async function I(...e){return await (0,l.isAllowed)(),await (0,i.C9)(...e)}let w=(0,a.j)("29c5faae5a16955eb0d51d3fd1823ccbbaa0ef05",y);async function y(e){try{let t=await (0,l.isAllowed)();return await (0,r.rr)({...e,userId:t.user?.userId})}catch(e){return o.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,n.h)([d,h,u,g,w]),(0,a.j)("fab009e6e702ae5024ee0d907e2cdc4cf7f48755",d),(0,a.j)("e85d0a973a0b1f327c8afd1ca0ee6d4d489ccd40",h),(0,a.j)("acd2c8889e9493daaf7221816633f7db8d969ae5",u),(0,a.j)("0cdd8f5b7719b52451fa16d8ad133f0f2507727c",g),(0,a.j)("d1f1ab626300d54aa052d5cb14835767258da9df",w)},73543:(e,t,s)=>{s.d(t,{q5:()=>p,x0:()=>h,fn:()=>g,rr:()=>d});var a=s(57745),r=s(9576),i=s(57435),o=s(10413),l=s(93567),n=s(88317);async function d({data:e,broadcastAction:t=!0,userId:s}){let d={success:!1};try{let t=[];for(let{hospitalId:i,...n}of e)try{let e=i||r.Z();if(!t.length){let t=i?await o.Z.query.hospitalsDrafts.findFirst({where:(0,a.eq)(l.hospitalsDrafts.hospitalDraftId,e)}):null,r=t||!i?null:await o.Z.query.hospitals.findFirst({where:(0,a.eq)(l.hospitals.hospitalId,e)});if(t){let s={...t.data,...n};await o.Z.update(l.hospitalsDrafts).set({data:s}).where((0,a.eq)(l.hospitalsDrafts.hospitalDraftId,e))}else{let t={...r,...n,hospitalId:e,version:r?.version?r.version+1:1};await o.Z.insert(l.hospitalsDrafts).values({data:t,hospitalDraftId:e,hospitalId:r?.hospitalId,createdByUserId:s})}}}catch(e){t.push(e.message)}t.length?d.errors=t:d.success=!0}catch(e){d.success=!1,d.errors=[e.message],i.Z.error("_saveHospitals ERROR",e.message)}finally{return!d?.errors?.length&&t&&n.Z.emit("data_changed","save_hospitals"),d}}async function p(e){try{return await o.Z.delete(l.hospitalsDrafts).where(e?.userId?(0,a.eq)(l.hospitalsDrafts.createdByUserId,e.userId):void 0),!0}catch(e){throw e}}async function h({hospitalsIds:e,broadcastAction:t=!0,userId:s}){let r={success:!1};try{if(e.length){await o.Z.delete(l.hospitalsDrafts).where((0,a.d3)(l.hospitalsDrafts.hospitalDraftId,e));let t=(await o.Z.select({hospitalId:l.hospitals.hospitalId,pendingDeletion:l.pendingDeletion.hospitalId}).from(l.hospitals).leftJoin(l.pendingDeletion,(0,a.eq)(l.pendingDeletion.hospitalId,l.hospitals.hospitalId)).where((0,a.d3)(l.hospitals.hospitalId,e))).filter(e=>!e.pendingDeletion).map(e=>({...e,createdByUserId:s}));t.length&&await o.Z.insert(l.pendingDeletion).values(t)}r.success=!0}catch(e){r.success=!1,r.errors=[e.message],i.Z.error("_deleteHospitals ERROR",e.message)}finally{return!r?.errors?.length&&t&&n.Z.emit("data_changed","delete_hospitals"),r}}async function f({previous:e,drafts:t,userId:s}){let a=[];try{let r=[];for(let i of t){let t=i?.data?.hospitalId;if(!t)continue;let o={version:i?.data?.version||1,hospitalId:t,changes:{}},l=1===(i?.data?.version||1);if(l)o.changes={action:"create_hospital",description:"Create hospital",oldValues:[],newValues:[]};else{let s=e.find(e=>e.hospitalId===t),a=[],r=[];Object.keys({...i?.data}).filter(e=>!["version","draft"].includes(e)).forEach(e=>{let t=i.data[e],o={...s}[e];JSON.stringify(t)!==JSON.stringify(o)&&(a.push({[e]:o}),r.push({[e]:t}))}),o.changes={action:"update_hospital",description:"Update hospital",oldValues:a,newValues:r}}if(r.push(o),s){let{...r}=i.data||{},n=JSON.parse(JSON.stringify(r)),d=l?{}:JSON.parse(JSON.stringify(e.find(e=>e.hospitalId===t)||{}));a.push({entityId:t,entityType:"hospital",action:l?"create":"update",version:o.version||1,changes:o.changes,fullSnapshot:n,previousSnapshot:d,baselineSnapshot:d,userId:s,hospitalId:t})}}r.length&&await o.Z.insert(l.hospitalsHistory).values(r)}catch(e){i.Z.error(e.message)}return a}var u=s(34149),c=s(36864);async function g(e){let t={success:!1},s=[];try{let n=[],d=[],p=await o.Z.query.hospitalsDrafts.findMany({where:e?.userId?(0,a.eq)(l.hospitalsDrafts.createdByUserId,e?.userId):void 0});if(n=p.filter(e=>e.hospitalId),d=p.filter(e=>!e.hospitalId),n.length){let t=[];for(let{hospitalId:e,data:s}of(n.filter(e=>e.hospitalId).length&&(t=await o.Z.query.hospitals.findMany({where:(0,a.d3)(l.hospitals.hospitalId,n.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),n)){let{hospitalId:t,id:r,oldHospitalId:i,createdAt:n,updatedAt:d,deletedAt:p,...h}=s,f={...h,publishDate:new Date};await o.Z.update(l.hospitals).set(f).where((0,a.eq)(l.hospitals.hospitalId,e)).returning()}let r=await f({drafts:n,previous:t,userId:e?.publisherUserId});s.push(...r.map(t=>({...t,dataVersion:e?.dataVersion})))}if(d.length){let t=[];for(let{id:e,data:s}of(d.filter(e=>e.hospitalId).length&&(t=await o.Z.query.hospitals.findMany({where:(0,a.d3)(l.hospitals.hospitalId,d.filter(e=>e.hospitalId).map(e=>e.hospitalId))})),d)){let t=s.hospitalId||(0,r.Z)(),a={...s,hospitalId:t};d=d.map(s=>(s.id===e&&(s.data.hospitalId=t),s)),await o.Z.insert(l.hospitals).values(a)}let i=await f({drafts:d,previous:t,userId:e?.publisherUserId});s.push(...i.map(t=>({...t,dataVersion:e?.dataVersion})))}await o.Z.delete(l.hospitalsDrafts).where(e?.userId?(0,a.eq)(l.hospitalsDrafts.createdByUserId,e.userId):void 0);let h=await o.Z.query.pendingDeletion.findMany({where:(0,a.xD)((0,a.K0)(l.pendingDeletion.hospitalId),e?.userId?(0,a.eq)(l.pendingDeletion.createdByUserId,e.userId):void 0),columns:{hospitalId:!0},with:{hospital:!0}});if((h=h.filter(e=>e.hospital)).length){let t=new Date;await o.Z.update(l.hospitals).set({deletedAt:t}).where((0,a.d3)(l.hospitals.hospitalId,h.map(e=>e.hospitalId)));let r=h.map(e=>({version:e.hospital.version,hospitalId:e.hospitalId,changes:{action:"delete_hospital",description:"Delete hospital",oldValues:[{deletedAt:null}],newValues:[{deletedAt:t}]}}));if(await o.Z.insert(l.hospitalsHistory).values(r),e?.publisherUserId)for(let a=0;a<h.length;a++){let i=h[a],o=r[a];if(!i?.hospitalId)continue;let l={...i.hospital??{},deletedAt:t};s.push({entityId:i.hospitalId,entityType:"hospital",action:"delete",version:o.version||1,dataVersion:e.dataVersion,changes:o.changes,fullSnapshot:JSON.parse(JSON.stringify(l)),description:o.changes.description,userId:e.publisherUserId,hospitalId:i.hospitalId,isActive:!1})}}await o.Z.delete(l.pendingDeletion).where((0,a.xD)((0,a.or)((0,a.K0)(l.pendingDeletion.hospitalId),(0,a.K0)(l.pendingDeletion.hospitalDraftId)),e?.userId?(0,a.eq)(l.pendingDeletion.createdByUserId,e.userId):void 0));let g=[...n.map(e=>e.hospitalId),...h.map(e=>e.hospitalId)];if(g.length&&await o.Z.update(l.hospitals).set({version:(0,u.i6)`${l.hospitals.version} + 1`}).where((0,a.d3)(l.hospitals.hospitalId,g)),s.length){let e=await (0,c.F)({data:s,allowPartial:!0});e.errors?.length&&i.Z.error("_publishHospitals changelog warnings",e.errors.join(", "))}t.success=!0}catch(e){t.success=!1,t.errors=[e.message],i.Z.error("_publishHospitals ERROR",e)}finally{return t}}},20084:(e,t,s)=>{s.d(t,{Py:()=>u,SE:()=>f,C9:()=>p,O8:()=>d});var a=s(57745),r=s(30900),i=s(9576),o=s(10413),l=s(93567),n=s(57435);async function d(e){try{let{hospitalsIds:t,returnDraftsIfExist:s=!0}={...e},n=t||[],d=n?.length?(0,a.d3)(l.hospitalsDrafts.hospitalDraftId,n.map(e=>r.Z(e)?e:i.Z())):void 0,p=[...d?[d]:[]],h=s?await o.Z.query.hospitalsDrafts.findMany({where:(0,a.xD)(...p)}):[];n=n.filter(e=>!h.map(e=>e.hospitalDraftId).includes(e));let f=h.length?(0,a.Nl)(l.hospitals.hospitalId,h.map(e=>e.hospitalDraftId)):void 0,u=n?.length?(0,a.d3)(l.hospitals.hospitalId,n.filter(e=>r.Z(e))):void 0,c=n?.length?(0,a.d3)(l.hospitals.oldHospitalId,n.filter(e=>!r.Z(e))):void 0,g=[(0,a.Ft)(l.hospitals.deletedAt),(0,a.Ft)(l.pendingDeletion),...u&&c?[(0,a.or)(u,c)]:[],f],I=(await o.Z.select({hospital:l.hospitals,pendingDeletion:l.pendingDeletion}).from(l.hospitals).leftJoin(l.pendingDeletion,(0,a.eq)(l.pendingDeletion.hospitalId,l.hospitals.hospitalId)).where(g.length?(0,a.xD)(...g):void 0)).map(e=>e.hospital),w=I.length?await o.Z.query.pendingDeletion.findMany({where:(0,a.d3)(l.pendingDeletion.hospitalId,I.map(e=>e.hospitalId)),columns:{hospitalId:!0}}):[];return{data:[...I.map(e=>({...e,isDraft:!1,isDeleted:!1,isUnpublishedDraft:!1})),...h.map(e=>({...e.data,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!e.hospitalId,draftCreatedByUserId:e.createdByUserId}))].sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()).filter(e=>!w.map(e=>e.hospitalId).includes(e.hospitalId))}}catch(e){return n.Z.error("_getHospitals ERROR",e.message),{data:[],errors:[e.message]}}}async function p(e){let{hospitalId:t,returnDraftIfExists:s=!0}={...e};try{if(!t)throw Error("Missing hospitalId");let e=r.Z(t)?(0,a.eq)(l.hospitals.hospitalId,t):void 0,i=r.Z(t)?void 0:(0,a.eq)(l.hospitals.oldHospitalId,t),n=e?(0,a.eq)(l.hospitalsDrafts.hospitalDraftId,t):void 0,d=s&&n?await o.Z.query.hospitalsDrafts.findFirst({where:n}):void 0,p=d?{...d.data,draftCreatedByUserId:d.createdByUserId,isDraft:!0,isDeleted:!1,isUnpublishedDraft:!d.hospitalId}:null;if(p)return{data:p};let h=await o.Z.query.hospitals.findFirst({where:(0,a.xD)((0,a.Ft)(l.hospitals.deletedAt),e||i),with:{draft:!0}});d=s?h?.draft:void 0;let f=d?.data||h;if(!(p=f?{...f,draftCreatedByUserId:d?.createdByUserId,isDraft:!!d?.data,isDeleted:!1,isUnpublishedDraft:!1}:null))return{data:null};return{data:p}}catch(e){return n.Z.error("_getHospital ERROR",e.message),{errors:[e.message]}}}var h=s(60938);let f={allPublished:0,publishedWithDrafts:0,allDrafts:0,newDrafts:0,pendingDeletion:0};async function u(){try{let[{count:e}]=await o.Z.select({count:(0,h.QX)()}).from(l.hospitalsDrafts),[{count:t}]=await o.Z.select({count:(0,h.QX)()}).from(l.hospitalsDrafts).where((0,a.Ft)(l.hospitalsDrafts.hospitalId)),[{count:s}]=await o.Z.select({count:(0,h.QX)()}).from(l.hospitalsDrafts).where((0,a.K0)(l.hospitalsDrafts.hospitalId)),[{count:r}]=await o.Z.select({count:(0,h.QX)()}).from(l.pendingDeletion).where((0,a.K0)(l.pendingDeletion.hospitalId)),[{count:i}]=await o.Z.select({count:(0,h.QX)()}).from(l.hospitals);return{data:{allPublished:i,publishedWithDrafts:s,allDrafts:e,newDrafts:t,pendingDeletion:r}}}catch(e){return n.Z.error("_getHospitals ERROR",e.message),{data:f,errors:[e.message]}}}},30900:(e,t,s)=>{s.d(t,{Z:()=>r});let a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,r=function(e){return"string"==typeof e&&a.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[9380,1744,1337,3788,2758,9092,4901,5059,413,6267,5002],()=>s(53910));module.exports=a})();