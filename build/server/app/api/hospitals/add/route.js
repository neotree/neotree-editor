(()=>{var e={};e.id=9060,e.ids=[9060],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},6005:e=>{"use strict";e.exports=require("node:crypto")},87561:e=>{"use strict";e.exports=require("node:fs")},49411:e=>{"use strict";e.exports=require("node:path")},22037:e=>{"use strict";e.exports=require("os")},4074:e=>{"use strict";e.exports=require("perf_hooks")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},13982:(e,t,s)=>{"use strict";s.r(t),s.d(t,{originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>p,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{POST:()=>u});var i=s(49303),a=s(88716),n=s(60670),o=s(87070),d=s(72761),c=s(57848),l=s(57435);async function u(e){try{if(!(await (0,d.$)()).yes)return o.NextResponse.json({errors:["Unauthorised"]},{status:200});let t=await e.json(),s=await (0,c.saveHospitals)({broadcastAction:!0,...t.data});return o.NextResponse.json(s)}catch(e){return l.Z.log("/api/hospitals/add",e),o.NextResponse.json({errors:[e.message]})}}let y=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/hospitals/add/route",pathname:"/api/hospitals/add",filename:"route",bundlePath:"app/api/hospitals/add/route"},resolvedPagePath:"C:\\Users\\HomePC\\Neotree Projects\\neotree-editor\\app\\api\\hospitals\\add\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:g}=y,h="/api/hospitals/add/route";function I(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},57848:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$ACTION_0:()=>l,$$ACTION_1:()=>y,$$ACTION_2:()=>f,$$ACTION_3:()=>h,$$ACTION_4:()=>m,countHospitals:()=>u,deleteHospitals:()=>c,getHospital:()=>g,getHospitals:()=>p,saveHospitals:()=>I});var r=s(24330);s(60166);var i=s(73543),a=s(20084),n=s(57435),o=s(66267),d=s(40618);let c=(0,r.j)("45fc9b73f0105a3c01c0105233b9dcee848c1014",l);async function l(e){try{let t=await (0,o.isAllowed)();return await (0,i.x0)({...e,userId:t.user?.userId})}catch(e){return n.Z.error("deleteHospitals ERROR",e.message),{errors:[e.message],success:!1}}}let u=(0,r.j)("f7d5033ed07f08e193f6f9961ae50955c4b5f78e",y);async function y(...e){try{return await (0,o.isAllowed)(),await (0,a.Py)(...e)}catch(e){return n.Z.error("countHospitals ERROR",e.message),{errors:[e.message],data:a.SE}}}let p=(0,r.j)("43d0037c602e6e44d9b4683e862d53f43a281d8e",f);async function f(...e){try{return await (0,o.isAllowed)(),await (0,a.O8)(...e)}catch(e){return n.Z.error("getHospitals ERROR",e.message),{errors:[e.message],data:[]}}}let g=(0,r.j)("ae6eaff80f0ec9ee8fd62c0f6f86427986b90aab",h);async function h(...e){return await (0,o.isAllowed)(),await (0,a.C9)(...e)}let I=(0,r.j)("29c5faae5a16955eb0d51d3fd1823ccbbaa0ef05",m);async function m(e){try{let t=await (0,o.isAllowed)();return await (0,i.rr)({...e,userId:t.user?.userId})}catch(e){return n.Z.error("getSys ERROR",e.message),{errors:[e.message],data:void 0,success:!1}}}(0,d.h)([c,u,p,g,I]),(0,r.j)("fab009e6e702ae5024ee0d907e2cdc4cf7f48755",c),(0,r.j)("e85d0a973a0b1f327c8afd1ca0ee6d4d489ccd40",u),(0,r.j)("acd2c8889e9493daaf7221816633f7db8d969ae5",p),(0,r.j)("0cdd8f5b7719b52451fa16d8ad133f0f2507727c",g),(0,r.j)("d1f1ab626300d54aa052d5cb14835767258da9df",I)},36864:(e,t,s)=>{"use strict";s.d(t,{C:()=>L,F:()=>x});var r=s(57745),i=s(81445),a=s(6113),n=s(30900),o=s(9576),d=s(57435),c=s(10413),l=s(93567),u=s(88317);let y={script:"scriptId",screen:"screenId",diagnosis:"diagnosisId",config_key:"configKeyId",drugs_library:"drugsLibraryItemId",data_key:"dataKeyId",alias:"aliasId",hospital:"hospitalId"},p={screen:["scriptId"],diagnosis:["scriptId"]},f=["alias"],g={script:{table:l.scripts,idColumn:l.scripts.scriptId,versionColumn:l.scripts.version,entityLabel:"script"},screen:{table:l.screens,idColumn:l.screens.screenId,versionColumn:l.screens.version,entityLabel:"screen"},diagnosis:{table:l.diagnoses,idColumn:l.diagnoses.diagnosisId,versionColumn:l.diagnoses.version,entityLabel:"diagnosis"},config_key:{table:l.configKeys,idColumn:l.configKeys.configKeyId,versionColumn:l.configKeys.version,entityLabel:"config key"},drugs_library:{table:l.drugsLibrary,idColumn:l.drugsLibrary.itemId,versionColumn:l.drugsLibrary.version,entityLabel:"drugs library item"},data_key:{table:l.dataKeys,idColumn:l.dataKeys.uuid,versionColumn:l.dataKeys.version,entityLabel:"data key"},hospital:{table:l.hospitals,idColumn:l.hospitals.hospitalId,versionColumn:l.hospitals.version,entityLabel:"hospital"}},h={script:{table:l.scripts,idColumn:l.scripts.scriptId,entityLabel:"script"},screen:{table:l.screens,idColumn:l.screens.screenId,entityLabel:"screen"},diagnosis:{table:l.diagnoses,idColumn:l.diagnoses.diagnosisId,entityLabel:"diagnosis"},config_key:{table:l.configKeys,idColumn:l.configKeys.configKeyId,entityLabel:"config key"},drugs_library:{table:l.drugsLibrary,idColumn:l.drugsLibrary.itemId,entityLabel:"drugs library item"},data_key:{table:l.dataKeys,idColumn:l.dataKeys.uuid,entityLabel:"data key"},alias:{table:l.aliases,idColumn:l.aliases.uuid,entityLabel:"alias"},hospital:{table:l.hospitals,idColumn:l.hospitals.hospitalId,entityLabel:"hospital"}};function I(e){return(0,a.createHash)("sha256").update(JSON.stringify(e??{})).digest("hex")}async function m(e,t){let s=g[t.entityType];if(!s)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select({version:s.versionColumn}).from(s.table).where((0,r.eq)(s.idColumn,t.entityId)).limit(1),a=i?.[0]?.version;if(!Number.isFinite(a))throw Error(`Missing ${s.entityLabel} or version for entityId ${t.entityId}`);return Number(a)}async function b(e,t,s){let a=await e.select({version:l.changeLogs.version}).from(l.changeLogs).where((0,r.xD)((0,r.eq)(l.changeLogs.entityId,t),(0,r.eq)(l.changeLogs.entityType,s))).orderBy((0,i.C)(l.changeLogs.version)).limit(1);return a?.[0]?.version}async function v(e,t){let s=h[t.entityType];if(!s)throw Error(`Unknown entityType ${t.entityType}`);let i=await e.select().from(s.table).where((0,r.eq)(s.idColumn,t.entityId)).limit(1);if(!i?.[0])throw Error(`Entity not found for snapshot (${s.entityLabel} ${t.entityId})`);return i[0]}async function w({client:e,data:t,computedVersion:s,dataVersion:r,baselineSnapshot:i}){if(Number.isFinite(await b(e,t.entityId,t.entityType)))return;let a=i??t.previousSnapshot;if(void 0===a)try{a=await v(e,t),d.Z.error("saveChangeLog baselineSnapshot missing; captured current entity state as baseline",{entityId:t.entityId,entityType:t.entityType})}catch(e){throw Error("baselineSnapshot is required for the first changelog of an entity to capture the pre-change state")}let n=Math.max(0,s-1),c=I(a),u={changeLogId:o.Z(),entityId:t.entityId,entityType:t.entityType,action:"create",version:n,dataVersion:r,changes:[],fullSnapshot:a,previousSnapshot:a,snapshotHash:c,description:"Baseline snapshot",changeReason:"Baseline snapshot",parentVersion:null,mergedFromVersion:null,isActive:!1,userId:t.userId,scriptId:t.scriptId,screenId:t.screenId,diagnosisId:t.diagnosisId,configKeyId:t.configKeyId,hospitalId:t.hospitalId,drugsLibraryItemId:t.drugsLibraryItemId,dataKeyId:t.dataKeyId,aliasId:t.aliasId,dateOfChange:new Date};return await e.insert(l.changeLogs).values(u),n}async function L({data:e,broadcastAction:t,client:s}){let i={success:!1};try{!function(e){if(!n.Z(e.entityId))throw Error("Invalid entityId");if(!n.Z(e.userId))throw Error("Invalid userId");let t=y[e.entityType],s=e[t];if(!s||"string"!=typeof s||!n.Z(s))throw Error(`Missing or invalid ${t} for entityType ${e.entityType}`);if(s!==e.entityId)throw Error(`entityId must match ${t} for entityType ${e.entityType}`);let r=p[e.entityType]||[];for(let t of r){let s=e[t];if(null!=s&&("string"!=typeof s||!n.Z(s)))throw Error(`Invalid ${String(t)} for entityType ${e.entityType}`)}if(Object.entries(y).map(([t,s])=>({type:t,key:s,value:e[s]})).filter(e=>void 0!==e.value&&null!==e.value).filter(e=>e.value).some(t=>t.type!==e.entityType&&!r.includes(t.key)))throw Error(`Only the ${t} FK should be provided for entityType ${e.entityType}`);if("publish"===e.action){let t=Number(e.dataVersion);if(!Number.isFinite(t)||t<=0)throw Error("dataVersion is required and must be a positive number for publish actions")}}(e);let a=async t=>{var s;let i,a,n;let c=o.Z(),u=(s=e.entityType,f.includes(s)),y=Number.isFinite(e.version)?Number(e.version):null,p=Number.isFinite(e.dataVersion)?Number(e.dataVersion):null;if(u){let s=await b(t,e.entityId,e.entityType);if(a=s,i=(s??0)+1,n=await w({client:t,data:e,computedVersion:i,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==i){if(y<i);else throw d.Z.error("saveChangeLog versionless mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,latestChangeLogVersion:s,computedVersion:i}),Error(`Provided version (${e.version}) does not match expected changelog version (${i}) for versionless entity ${e.entityType}`)}}else{let s=e.entityType,r=await m(t,{...e,entityType:s}),o=g[s],c=await b(t,e.entityId,e.entityType);if(a=c,Number.isFinite(c)){let e=Number(c)+1;i=r<=Number(c)?e:r}else i=r;if(n=await w({client:t,data:e,computedVersion:i,dataVersion:p,baselineSnapshot:e.baselineSnapshot}),null!==y&&y!==i){if(y<i);else throw d.Z.error("saveChangeLog version mismatch",{entityType:e.entityType,entityId:e.entityId,providedVersion:y,entityVersion:r,latestChangeLogVersion:c,computedVersion:i}),Error(`Provided version (${e.version}) does not match ${o.entityLabel} version (${i})`)}}let h=e.snapshotHash||I(e.fullSnapshot);if(!h)throw Error("snapshotHash is required");let v=e.previousSnapshot??e.baselineSnapshot??{},L={changeLogId:c,entityId:e.entityId,entityType:e.entityType,action:e.action,version:i,dataVersion:p,changes:e.changes||[],fullSnapshot:e.fullSnapshot||{},previousSnapshot:v,snapshotHash:h,description:e.description,changeReason:e.changeReason,parentVersion:e.parentVersion??(void 0===a?n:a),mergedFromVersion:e.mergedFromVersion,isActive:!1!==e.isActive,userId:e.userId,scriptId:e.scriptId,screenId:e.screenId,diagnosisId:e.diagnosisId,configKeyId:e.configKeyId,hospitalId:e.hospitalId,drugsLibraryItemId:e.drugsLibraryItemId,dataKeyId:e.dataKeyId,aliasId:e.aliasId,dateOfChange:new Date},[x]=await t.insert(l.changeLogs).values(L).returning();return x&&x.entityId&&Number.isFinite(x.version)&&await t.update(l.changeLogs).set({isActive:!1,supersededBy:x.version,supersededAt:x.dateOfChange??new Date}).where((0,r.xD)((0,r.eq)(l.changeLogs.entityId,x.entityId),(0,r.eq)(l.changeLogs.entityType,x.entityType),(0,r.lt)(l.changeLogs.version,x.version),(0,r.eq)(l.changeLogs.isActive,!0))),x},h=s?await a(s):await c.Z.transaction(a);return i.success=!0,i.data=h,t&&u.Z.emit("data_changed","save_change_log"),i}catch(e){return i.success=!1,i.errors=[e.message],d.Z.error("_saveChangeLog ERROR",e.message),i}}async function x({data:e,broadcastAction:t}){let s=0,r=[];try{return await c.Z.transaction(async t=>{for(let i of e){let e=await L({data:i,client:t});if(e.errors?.length)throw r.push(...e.errors),Error(r.join(", "));s++}}),t&&!r.length&&u.Z.emit("data_changed","save_change_logs"),{success:!r.length,errors:r.length?r:void 0,saved:s}}catch(e){return d.Z.error("_saveChangeLogs ERROR",e.message),s=0,{success:!1,errors:[e.message],saved:s}}}},88317:(e,t,s)=>{"use strict";s.d(t,{Z:()=>r});let r=(0,s(94901).io)(process.env.NEXT_PUBLIC_APP_URL)},30900:(e,t,s)=>{"use strict";s.d(t,{Z:()=>i});let r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,i=function(e){return"string"==typeof e&&r.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[1633,1744,1337,3788,2758,4901,5059,413,6267,2303],()=>s(13982));module.exports=r})();