"use strict";(()=>{var e={};e.id=4017,e.ids=[4017],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},49411:e=>{e.exports=require("node:path")},22037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},47339:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>I,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>q,staticGenerationAsyncStorage:()=>k});var i={};r.r(i),r.d(i,{DELETE:()=>y,GET:()=>u,POST:()=>l});var s=r(49303),n=r(88716),a=r(60670),c=r(87070),o=r(57435),p=r(72761),d=r(1817);async function u(e){try{if(!(await (0,p.$)()).yes)return c.NextResponse.json({errors:["Unauthorised"]});let t=JSON.parse(e.nextUrl.searchParams.get("data")||"{}"),r=await (0,d.oK)(t);return c.NextResponse.json(r)}catch(e){return o.Z.error("[GET] /api/locks",e.message),c.NextResponse.json({errors:["Internal Error"]})}}async function l(e){try{if(!(await (0,p.$)()).yes)return c.NextResponse.json({errors:["Unauthorised"]});let t=JSON.parse(e.nextUrl.searchParams.get("data")||"{}"),r=await (0,d.YH)(t);return c.NextResponse.json(r)}catch(e){return o.Z.error("[POSTINGI] /api/locks",e.message),c.NextResponse.json({errors:["Internal Error"]})}}async function y(e){try{if(!(await (0,p.$)()).yes)return c.NextResponse.json({errors:["Unauthorised"]});let t=JSON.parse(e.nextUrl.searchParams.get("data")||"{}");return await (0,d.o$)(t),c.NextResponse.json({dropped:!0})}catch(e){return o.Z.error("[DELETE] /api/locks",e.message),c.NextResponse.json({errors:["Internal Error"]})}}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/locks/route",pathname:"/api/locks",filename:"route",bundlePath:"app/api/locks/route"},resolvedPagePath:"/home/morris/Documents/NEOTREE/REPOS/neotree-editor/app/api/locks/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:k,serverHooks:q}=w,S="/api/locks/route";function I(){return(0,a.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:k})}},1817:(e,t,r)=>{r.d(t,{ND:()=>p,YH:()=>a,o$:()=>o,oK:()=>c});var i=r(66267),s=r(24316),n=r(57435);let a=async(...e)=>(await (0,i.isAllowed)(),await (0,s.ny)(...e)),c=async(...e)=>{try{return await (0,i.isAllowed)(),await (0,s.p1)(...e)}catch(e){return n.Z.error("getLocks Status ERROR",e.message),!1}},o=async(...e)=>{try{return await (0,i.isAllowed)(),await (0,s.d6)(...e)}catch(e){n.Z.error("getLocks Status ERROR",e.message)}},p=async(...e)=>{try{return await (0,i.isAllowed)(),await (0,s.FR)(...e)}catch(e){return n.Z.error("getLocks Status ERROR",e.message),!1}}},17754:(e,t,r)=>{r.d(t,{Bv:()=>d,FR:()=>l,UU:()=>S,V4:()=>p,Xe:()=>q,Ze:()=>w,d6:()=>y,nI:()=>I,ny:()=>k,oM:()=>f,p1:()=>u});var i=r(10413),s=r(57745),n=r(93567),a=r(57435),c=r(40801);async function o(e){let{script:t,lockType:r="script"}=e;if(!t&&"script"===r)return!1;let a=t?(0,s.xD)((0,s.or)((0,s.eq)(n.ntScriptLock.scriptId,t),(0,s.eq)(n.ntScriptLock.newScriptId,t)),(0,s.eq)(n.ntScriptLock.lockType,r)):(0,s.eq)(n.ntScriptLock.lockType,r);return!!await i.Z.query.ntScriptLock.findFirst({where:a})}async function p(e){let t=await (0,c.getAuthenticatedUser)();return!!e&&!!t&&!!await i.Z.query.ntScriptLock.findFirst({where:(0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,e),(0,s.eq)(n.ntScriptLock.userId,t?.userId))})}async function d(){let e=await (0,c.getAuthenticatedUser)();return!!e&&!!await i.Z.query.ntScriptLock.findFirst({where:(0,s.eq)(n.ntScriptLock.userId,e?.userId)})}async function u(e){let t=await (0,c.getAuthenticatedUser)();if(!t)return!0;let{script:r,lockType:a="script"}=e;if(r){if(await i.Z.query.ntScriptLock.findFirst({where:(0,s.xD)((0,s.or)((0,s.eq)(n.ntScriptLock.scriptId,r),(0,s.eq)(n.ntScriptLock.newScriptId,r)),(0,s.eq)(n.ntScriptLock.userId,t.userId),(0,s.eq)(n.ntScriptLock.lockType,a))}))return!1}else if("script"!==a&&await i.Z.query.ntScriptLock.findFirst({where:(0,s.xD)((0,s.eq)(n.ntScriptLock.userId,t.userId),(0,s.eq)(n.ntScriptLock.lockType,a))}))return!1;return o(e)}async function l(e){return await k({script:e.script,lockType:e.lockType}),await u({script:e.script,lockType:e.lockType})}async function y(e){let t=await (0,c.getAuthenticatedUser)(),r=t?.userId||"";for(let e of(await i.Z.query.ntScriptLock.findMany({})).map(e=>e.scriptId||e.newScriptId).filter(e=>null!=e)||[]){let[t,a,c,o]=await Promise.all([i.Z.query.scriptsDrafts.findFirst({where:(0,s.or)((0,s.eq)(n.scriptsDrafts.scriptId,e),(0,s.eq)(n.scriptsDrafts.scriptDraftId,e))}),i.Z.query.screensDrafts.findFirst({where:(0,s.eq)(n.screensDrafts.scriptId,e)}),i.Z.query.diagnosesDrafts.findFirst({where:(0,s.eq)(n.diagnosesDrafts.scriptId,e)}),i.Z.query.pendingDeletion.findFirst({where:(0,s.or)((0,s.eq)(n.pendingDeletion.scriptId,e),(0,s.eq)(n.pendingDeletion.screenScriptId,e))})]);t||a||c||o||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.or)(((0,s.eq)(n.ntScriptLock.scriptId,e),(0,s.eq)(n.ntScriptLock.newScriptId,e)),(0,s.eq)(n.ntScriptLock.userId,r))));let[p,d]=await Promise.all([i.Z.query.drugsLibraryDrafts.findFirst({}),i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion.drugsLibraryItemId)})]);p||d||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"drug_library"),(0,s.eq)(n.ntScriptLock.userId,r)));let[u,l]=await Promise.all([i.Z.query.dataKeys.findFirst({}),i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion.dataKeyId)})]);u||l||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"data_key"),(0,s.eq)(n.ntScriptLock.userId,r)))}if("drug_library"!==e.lockType){let[e,t]=await Promise.all([i.Z.query.drugsLibraryDrafts.findFirst({}),i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion.drugsLibraryItemId)})]);e||t||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"drug_library"),(0,s.eq)(n.ntScriptLock.userId,r)))}if("data_key"!==e.lockType){let[e,t]=await Promise.all([i.Z.query.dataKeys.findFirst({}),i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion.dataKeyId)})]);e||t||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"data_key"),(0,s.eq)(n.ntScriptLock.userId,r)))}}async function w(){let e=await i.Z.query.ntScriptLock.findMany({columns:{scriptId:!0,lockType:!0,newScriptId:!0}}),t=await (0,c.getAuthenticatedUser)();for(let r of e)if(r.scriptId){let e=await i.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(r.scriptId))}),a=await i.Z.query.screensDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(r.scriptId))}),c=await i.Z.query.diagnosesDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(r.scriptId))});e||a||c||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.scriptId,String(r.scriptId)),(0,s.eq)(n.ntScriptLock.userId,t?.userId||"")))}else if(r.newScriptId)await i.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptDraftId,r.newScriptId)})||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.newScriptId,String(r.scriptId)),(0,s.eq)(n.ntScriptLock.userId,t?.userId||"")));else{if("drug_library"==r.lockType){let e=await i.Z.query.drugsLibraryDrafts.findFirst({}),r=await i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion?.drugsLibraryItemId)});e||r||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"drug_library"),(0,s.eq)(n.ntScriptLock.userId,t?.userId||"")))}if("data_key"==r.lockType){let e=await i.Z.query.dataKeys.findFirst({}),r=await i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion?.dataKeyId)});e||r||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"data_key"),(0,s.eq)(n.ntScriptLock.userId,t?.userId||"")))}}}async function f(){for(let t of(await i.Z.query.ntScriptLock.findMany({columns:{scriptId:!0,lockType:!0,newScriptId:!0,lockedAt:!0}}))){var e;let r=(e=t.lockedAt,Date.now()-e.getTime()>=72e5);if(console.log("...MY IDLE",r),r){if(t.scriptId){let e=await i.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(t.scriptId))}),r=await i.Z.query.screensDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(t.scriptId))}),a=await i.Z.query.diagnosesDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptId,String(t.scriptId))});e||r||a||await i.Z.delete(n.ntScriptLock).where((0,s.eq)(n.ntScriptLock.scriptId,String(t.scriptId)))}else if(t.newScriptId)await i.Z.query.scriptsDrafts.findFirst({where:(0,s.eq)(n.scriptsDrafts.scriptDraftId,t.newScriptId)})||await i.Z.delete(n.ntScriptLock).where((0,s.eq)(n.ntScriptLock.newScriptId,String(t.scriptId)));else{if("drug_library"==t.lockType){let e=await i.Z.query.drugsLibraryDrafts.findFirst({}),t=await i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion?.drugsLibraryItemId)});e||t||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"drug_library")))}if("data_key"==t.lockType){let e=await i.Z.query.dataKeys.findFirst({}),t=await i.Z.query.pendingDeletion.findFirst({where:(0,s.K0)(n.pendingDeletion?.dataKeyId)});e||t||await i.Z.delete(n.ntScriptLock).where((0,s.xD)((0,s.eq)(n.ntScriptLock.lockType,"data_key")))}}}}}async function k(e){let t={success:!1},r=[],p={};try{try{let t=await o({script:e.script,lockType:e.lockType}),r=await i.Z.query.scripts.findFirst({where:(0,s.eq)(n.scripts.scriptId,e.script)});if(!t){let t=await (0,c.getAuthenticatedUser)();if(r){let r=i.Z.insert(n.ntScriptLock).values({userId:t?.userId,scriptId:e.script||null,lockType:e.lockType,lockedAt:new Date(new Date().toISOString())});p.query=r.toSQL(),await r.execute()}else{let r=i.Z.insert(n.ntScriptLock).values({userId:t?.userId,scriptId:null,newScriptId:e.script,lockType:e.lockType,lockedAt:new Date(new Date().toISOString())});p.query=r.toSQL(),await r.execute()}}}catch(e){a.Z.error(e.message),r.push(e.message)}r.length?(t.errors=r,t.info=p):t.success=!0}catch(e){t.success=!1,t.errors=[e.message],t.info=p}return t}async function q(){let e=await (0,c.getAuthenticatedUser)();return await i.Z.query.ntScriptLock.findMany({where:(0,s.xD)((0,s.eq)(n.ntScriptLock.userId,e?.userId||""),(0,s.or)((0,s.K0)(n.ntScriptLock.scriptId),(0,s.K0)(n.ntScriptLock.newScriptId)))}).then(e=>e.flatMap(e=>[e.scriptId,e.newScriptId]).filter(Boolean))}async function S(){let e=await (0,c.getAuthenticatedUser)();return await i.Z.query.ntScriptLock.findMany({where:(0,s.xD)((0,s.eq)(n.ntScriptLock.userId,e?.userId||""),(0,s.eq)(n.ntScriptLock.lockType,"drug_library"))}).then(e=>e.flatMap(e=>[e.userId]).filter(Boolean))}async function I(){let e=await (0,c.getAuthenticatedUser)();return await i.Z.query.ntScriptLock.findMany({where:(0,s.xD)((0,s.eq)(n.ntScriptLock.userId,e?.userId||""),(0,s.eq)(n.ntScriptLock.lockType,"data_key"))}).then(e=>e.flatMap(e=>[e.userId]).filter(Boolean))}},24316:(e,t,r)=>{r.d(t,{Bv:()=>i.Bv,FR:()=>i.FR,V4:()=>i.V4,Ze:()=>i.Ze,d6:()=>i.d6,ny:()=>i.ny,oM:()=>i.oM,p1:()=>i.p1});var i=r(17754)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[1633,1744,9234,3788,2758,5059,413,6267],()=>r(47339));module.exports=i})();