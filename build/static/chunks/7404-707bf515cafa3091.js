"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7404],{19820:function(e,t,n){n.d(t,{SocketEventsListener:function(){return r}});var i=n(2265),a=n(99376),s=n(62265);function r(e){let{events:t}=e,n=(0,i.useRef)({eventsTimeouts:{},eventsTimestamps:{}});(0,i.useRef)(new Date().getTime());let r=(0,a.useRouter)();return(0,i.useEffect)(()=>{t.forEach(e=>{let{name:t,action:i,delay:a=100,onEvent:l}=e;s.Z.on(t,function(){for(var e=arguments.length,s=Array(e),o=0;o<e;o++)s[o]=arguments[o];let u=()=>{var e,n;(!i||s[0]===i)&&(null===(e=l.callback)||void 0===e||e.call(l,...s),(null==l?void 0:l.refreshRouter)&&(console.log(t,"refreshing..."),r.refresh()),(null===(n=l.redirect)||void 0===n?void 0:n.to)&&(l.redirect.replace?r.replace(l.redirect.to):r.push(l.redirect.to)))},d=new Date().getTime();a?(clearTimeout(n.current.eventsTimeouts[t]),n.current.eventsTimeouts[t]=setTimeout(()=>{n.current.eventsTimestamps[t]=d,u()},a)):(n.current.eventsTimestamps[t]=new Date().getTime(),u())})})},[t,r]),null}},67132:function(e,t,n){n.d(t,{AppContextProvider:function(){return m},b:function(){return g}});var i=n(57437),a=n(2265),s=n(25922),r=n(99376),l=n(6760),o=n(64131);let u=o.Z.get,d=o.Z.set;o.Z.remove;var c={get:u,set:d};function h(){let e=c.get("mode");return e||(e="view",c.set("mode",e,{expires:31536e7})),e}var p=n(62265),y=n(19820);let f=(0,a.createContext)(null),g=()=>(0,a.useContext)(f);function m(e){let{children:t,...n}=e,o=function(e){(0,r.useRouter)();let{isAdmin:t,isSuperUser:n,sys:i}=e,{setTheme:l}=(0,s.F)();(0,a.useEffect)(()=>{"yes"===i.data.hide_theme_toggle&&l("light")},[i]);let o=(0,a.useCallback)(()=>(t||n?h():"view")||"view",[n,t]),[u,d]=(0,a.useState)(o()),y=!t&&!n||"view"===u,f=(0,a.useCallback)(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let i=function(e){return c.set("mode",e,{expires:31536e7}),h()}(...t);return p.Z.emit("mode_changed",o()),d(o()),i},[o]),g=(0,a.useCallback)(()=>{d(o())},[o]);return{...e,mode:u,viewOnly:y,onModeChange:g,getMode:h,setMode:f}}(n),[u,d]=(0,a.useState)(!1);return((0,l.Z)(()=>{d(!0)}),u)?(0,i.jsxs)(f.Provider,{value:o,children:[t,(0,i.jsx)(y.SocketEventsListener,{events:[{name:"mode_changed",onEvent:{callback:o.onModeChange}}]})]}):null}},98656:function(e,t,n){n.d(t,{s:function(){return s}});var i=n(59625);let a={title:"",message:"",buttonLabel:"Ok",variant:"info",onClose:void 0},s=(0,i.Ue)(e=>({isOpen:!1,...a,alert:t=>e({isOpen:!0,...a,...t}),close:()=>e({isOpen:!1,onClose:void 0,...a})}))},22381:function(e,t,n){n.d(t,{$u:function(){return r},KL:function(){return o}});var i=n(73526);let a=new Set(["id","createdAt","updatedAt","deletedAt","oldScriptId","oldScreenId","oldDiagnosisId","oldConfigKeyId","version","publishDate","isDraft","isDeleted","draftCreatedByUserId","createdByUserId","updatedByUserId","createdBy","updatedBy"]);class s{setSnapshot(e){this.isInitialized||(this.originalSnapshot=JSON.parse(JSON.stringify(e)),this.isInitialized=!0)}async trackChanges(e,t){if(!this.isInitialized||!this.originalSnapshot){this.setSnapshot(e);return}let n=this.detectChanges(this.originalSnapshot,e),a=new Map((await i.pb.getEntityChanges(this.options.entityId,this.options.entityType)).map(e=>[e.fieldPath,e])),s=this.resolveEntityTitle(e);for(let r of n){let n=a.get(r.path);n?await i.pb.updateChange(n.id,{newValue:r.newValue,timestamp:Date.now(),description:t,fullSnapshot:e,entityTitle:s}):await i.pb.addChange({entityId:this.options.entityId,entityType:this.options.entityType,action:"update",fieldPath:r.path,fieldName:r.name,oldValue:r.oldValue,newValue:r.newValue,userId:this.options.userId,userName:this.options.userName,description:t,fullSnapshot:e,entityTitle:s})}for(let[e,t]of Array.from(a.entries()))n.some(t=>t.path===e)||await i.pb.deleteChange(t.id);0===n.length&&await i.pb.clearEntityChanges(this.options.entityId,this.options.entityType)}resolveEntityTitle(e){if(this.options.resolveEntityTitle){let t=this.options.resolveEntityTitle(e);if(t&&t.toString().trim().length)return t.toString().trim()}let t=this.extractTitle(e);return t?t:"string"==typeof this.options.entityTitle&&this.options.entityTitle.trim().length?this.options.entityTitle.trim():this.extractTitle(this.originalSnapshot)||"".concat(this.options.entityType," ").concat(this.options.entityId)}extractTitle(e){if(!e||"object"!=typeof e)return null;for(let t of["title","name","label","key","printTitle","displayName","sectionTitle","collectionLabel"]){let n=e[t];if("string"==typeof n&&n.trim().length)return n.trim()}return null}isMeaningfulValue(e){return null!=e&&("string"!=typeof e||""!==e.trim())}isEmptyEquivalentField(e){return!!e&&["timerValue","multiplier","minValue","maxValue"].includes(e.split(".").pop()||"")}normalizeComparableValue(e,t){return null==e||"string"==typeof e&&""===e.trim()||this.isEmptyEquivalentField(t)&&"number"==typeof e&&0===e?null:e}areEquivalentValues(e,t,n){let i=this.normalizeComparableValue(e,n),a=this.normalizeComparableValue(t,n);if(null===i&&null===a)return!0;if("object"!=typeof i||"object"!=typeof a)return i===a;try{return JSON.stringify(i)===JSON.stringify(a)}catch(e){return!1}}detectChanges(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=[];if(this.shouldDiffScreenFields(n)&&(Array.isArray(e)||Array.isArray(t))){let i=Array.isArray(e)?e:[],a=Array.isArray(t)?t:[];return this.diffScreenFields(i,a,n)}return null==e?(null!=t&&this.isMeaningfulValue(t)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}),i):null==t?(this.isMeaningfulValue(e)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}),i):"object"!=typeof e||"object"!=typeof t?(!this.areEquivalentValues(e,t,n)&&this.isMeaningfulValue(t)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}),i):Array.isArray(e)&&Array.isArray(t)?this.shouldDiffScreenFields(n)?this.diffScreenFields(e,t,n):(this.areEquivalentValues(e,t,n)||i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}),i):(Array.from(new Set([...Object.keys(e),...Object.keys(t)])).forEach(s=>{if(a.has(s))return;let r=n?"".concat(n,".").concat(s):s,l=e[s],o=t[s];(this.isMeaningfulValue(l)||this.isMeaningfulValue(o))&&("object"!=typeof l||"object"!=typeof o||null===l||null===o||Array.isArray(l)||Array.isArray(o)?!this.areEquivalentValues(l,o,r)&&this.isMeaningfulValue(o)&&i.push({path:r,name:s,oldValue:l,newValue:o}):i.push(...this.detectChanges(l,o,r)))}),i)}shouldDiffScreenFields(e){return"screen"===this.options.entityType&&("fields"===e||e.endsWith(".fields"))}diffScreenFields(e,t,n){let i=[],a=this.indexFieldsByKey(e),s=this.indexFieldsByKey(t),r=new Set;for(let e of(a.forEach((e,t)=>r.add(t)),s.forEach((e,t)=>r.add(t)),Array.from(r))){let t=a.get(e)||null,r=s.get(e)||null,l=this.resolveFieldLabel(r||t,e),o="".concat(n,".").concat(e);if(!t&&r){i.push({path:o,name:"".concat(l," (added)"),oldValue:null,newValue:r});continue}if(t&&!r){i.push({path:o,name:"".concat(l," (removed)"),oldValue:t,newValue:null});continue}if(t&&r)for(let e of this.detectChanges(t,r,o))i.push({...e,name:e.name?"".concat(l," â€¢ ").concat(e.name):l})}return i}indexFieldsByKey(e){let t=new Map;return e.forEach((e,n)=>{if(!e||"object"!=typeof e)return;let i=String(e.fieldId||e.id||e.key||e.name||"index_".concat(n)).replace(/\./g,"_");t.set(i,e)}),t}resolveFieldLabel(e,t){if(!e||"object"!=typeof e)return t;for(let t of[e.label,e.title,e.name,e.key,e.fieldId,e.id]){if("string"==typeof t&&t.trim().length)return t.trim();if("number"==typeof t&&Number.isFinite(t))return String(t)}return t}async clearChanges(){await i.pb.clearEntityChanges(this.options.entityId,this.options.entityType),this.originalSnapshot=null,this.isInitialized=!1}async getPendingChanges(){return await i.pb.getEntityChanges(this.options.entityId,this.options.entityType)}constructor(e){this.originalSnapshot=null,this.isInitialized=!1,this.options=e}}function r(e){return new s(e)}let l=["title","name","label","key","printTitle","sectionTitle","collectionLabel","drug","fluid","feed"];async function o(e){let{entityId:t,entityType:n,entityTitle:a,snapshot:s,userId:r,userName:o,description:u}=e;if(!t)return;let d=(null==a?void 0:a.trim())||function(e){if(!e||"object"!=typeof e)return null;for(let t of l){let n=e[t];if("string"==typeof n&&n.trim().length)return n.trim()}return null}(s)||"".concat(n," ").concat(t);await i.pb.clearEntityChanges(t,n),await i.pb.addChange({entityId:t,entityType:n,entityTitle:d,action:"delete",fieldPath:"entity",fieldName:d,oldValue:null!=s?s:null,newValue:null,userId:r||void 0,userName:o||void 0,description:u||'Marked "'.concat(d,'" for deletion'),fullSnapshot:null!=s?s:null})}},73526:function(e,t,n){n.d(t,{pb:function(){return r}});var i=n(35966);class a extends i.ZP{constructor(){super("NeotreeChangeLogDB"),this.version(1).stores({pendingChanges:"++id, entityId, entityType, timestamp, userId, [entityId+fieldPath]",changeSessions:"++id, sessionId, entityId, entityType, startedAt, lastModifiedAt"})}}let s=new a,r={async addChange(e){let t=Date.now(),n="string"==typeof e.entityTitle&&e.entityTitle.trim().length?e.entityTitle.trim():"".concat(e.entityType," ").concat(e.entityId);return await s.pendingChanges.add({...e,entityTitle:n,timestamp:t})},async updateChange(e,t){let n={...t};return t.entityTitle&&"string"==typeof t.entityTitle&&(n.entityTitle=t.entityTitle.trim().length>0?t.entityTitle.trim():void 0),await s.pendingChanges.update(e,n)},deleteChange:async e=>await s.pendingChanges.delete(e),async getEntityChanges(e,t){let n=s.pendingChanges.where("entityId").equals(e);return t?await n.and(e=>e.entityType===t).toArray():await n.toArray()},async getAllChangesByEntity(){let e=await s.pendingChanges.toArray(),t={};return e.forEach(e=>{let n="".concat(e.entityType,":").concat(e.entityId);t[n]||(t[n]={title:"string"==typeof e.entityTitle&&e.entityTitle.trim().length?e.entityTitle.trim():"".concat(e.entityType," ").concat(e.entityId),changes:[]}),t[n].changes.push(e)}),t},getChangeCount:async e=>e?await s.pendingChanges.where("entityId").equals(e).count():await s.pendingChanges.count(),clearEntityChanges:async(e,t)=>t?await s.pendingChanges.where("entityId").equals(e).and(e=>e.entityType===t).delete():await s.pendingChanges.where("entityId").equals(e).delete(),clearAllChanges:async()=>await s.pendingChanges.clear(),getChangesByUser:async e=>await s.pendingChanges.where("userId").equals(e).toArray(),async getRecentChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return await s.pendingChanges.orderBy("timestamp").reverse().limit(e).toArray()},async startSession(e,t,n,i){let a="".concat(t,"-").concat(e,"-").concat(Date.now()),r={sessionId:a,entityId:e,entityType:t,entityTitle:n,startedAt:Date.now(),lastModifiedAt:Date.now(),changeCount:0,userId:i};return await s.changeSessions.add(r),a},async updateSession(e){let t=await s.changeSessions.where("sessionId").equals(e).first();t&&await s.changeSessions.update(t.id,{lastModifiedAt:Date.now(),changeCount:(t.changeCount||0)+1})},endSession:async e=>await s.changeSessions.where("sessionId").equals(e).delete(),clearAllSessions:async()=>await s.changeSessions.clear(),getActiveSession:async e=>await s.changeSessions.where("entityId").equals(e).first()}},62265:function(e,t,n){var i=n(68680),a=n(40257);let s=(0,i.io)(a.env.NEXT_PUBLIC_APP_URL);t.Z=s}}]);