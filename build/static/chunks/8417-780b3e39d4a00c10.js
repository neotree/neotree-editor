(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8417],{60662:function(e,a,n){Promise.resolve().then(n.bind(n,60578)),Promise.resolve().then(n.bind(n,89884))},60578:function(e,a,n){"use strict";n.d(a,{DataKeyForm:function(){return C}});var l=n(57437),i=n(2265),t=n(29501),s=n(99397),d=n(71533),r=n(27413),u=n(20657),o=n(99376),c=n(27648),m=n(49360),v=n(83464),y=n(68577),p=n(53647),h=n(84190),f=n(62869),x=n(26815),g=n(95186),j=n(86180),b=n(66024),N=n(32405),k=n(69711),I=n(51383),w=n(66070),D=n(24959),K=n(67132),q=n(22381),S=n(73526);let T=e=>{var a,n,l,i,t,s,d,r;if(!e)return null;let u="string"==typeof e.version?Number(e.version):null!==(a=e.version)&&void 0!==a?a:null;return{uuid:null!==(n=e.uuid)&&void 0!==n?n:"",uniqueKey:null!==(l=e.uniqueKey)&&void 0!==l?l:"",name:null!==(i=e.name)&&void 0!==i?i:"",refId:null!==(t=e.refId)&&void 0!==t?t:"",dataType:null!==(s=e.dataType)&&void 0!==s?s:"",label:null!==(d=e.label)&&void 0!==d?d:"",options:Array.isArray(e.options)?e.options:[],metadata:null!==(r=e.metadata)&&void 0!==r?r:{},version:u}};function C(e){let{loadingDataKeys:a}=(0,y.M)();return a?(0,l.jsx)(k.a,{overlay:!0}):(0,l.jsx)(U,{...e})}function U(e){var a,n,C,U,F,L;let{disabled:Z}=e,{dataKeyId:M}=(0,o.useParams)(),{allDataKeys:R,loadingDataKeys:A,saving:B,saveDataKeys:V}=(0,y.M)(),{confirm:_}=(0,j.t)(),{authenticatedUser:E,viewOnly:P}=(0,K.b)(),z=(0,i.useMemo)(()=>R.find(e=>e.uuid===M||e.uniqueKey===M),[R,M]),Q=(0,D.v)({isDraft:!!(null==z?void 0:z.isDraft),userId:null==z?void 0:z.draftCreatedByUserId}),O=!!Z||Q||P,{control:W,register:$,handleSubmit:X,watch:Y,setValue:G,getValues:H}=(0,t.cI)({defaultValues:{...z,name:(null==z?void 0:z.name)||"",refId:(null==z?void 0:z.refId)||"",dataType:(null==z?void 0:z.dataType)||"",label:(null==z?void 0:z.label)||"",options:(null==z?void 0:z.options)||[],metadata:(null==z?void 0:z.metadata)||{},version:(null==z?void 0:z.version)||1}}),J=(0,i.useRef)(null),ee=(0,i.useRef)(null),ea=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(!(null==z?void 0:z.uuid)){J.current=null,ee.current=null,ea.current=null;return}if(ea.current===z.uuid&&J.current)return;let e=(0,q.$u)({entityId:z.uuid,entityType:"dataKey",userId:null==E?void 0:E.userId,userName:null==E?void 0:E.displayName,entityTitle:(null==z?void 0:z.name)||(null==z?void 0:z.uniqueKey)||"Data Key",resolveEntityTitle:e=>(null==e?void 0:e.name)||(null==e?void 0:e.uniqueKey)}),a=T(z);a&&(e.setSnapshot(a),ee.current=a),J.current=e,ea.current=z.uuid},[z,null==E?void 0:E.userId,null==E?void 0:E.displayName]);let en=Y("dataType"),el=Y("options"),ei=Y("name"),et=Y("label"),[es,ed]=(0,i.useState)(!1),[er,eu]=(0,i.useState)(),[eo,ec]=(0,i.useState)(),[em,ev]=(0,i.useState)(),ey=N.y0.find(e=>e.value===en),ep=(0,i.useCallback)(()=>{let e=H();return[{uuid:(null==e?void 0:e.uuid)||(null==z?void 0:z.uuid)||"",uniqueKey:(null==e?void 0:e.uniqueKey)||(null==z?void 0:z.uniqueKey)||"",name:e.name||"",label:e.label||"",dataType:e.dataType||"",refId:e.refId||"",options:e.options||[],version:"string"==typeof e.version?Number(e.version):e.version}]},[H,null==z?void 0:z.uuid,null==z?void 0:z.uniqueKey]),eh=(0,i.useCallback)(async()=>{if(!(null==z?void 0:z.uuid)&&!(null==z?void 0:z.uniqueKey)){eu(void 0),ec(void 0);return}try{ed(!0);let e=await v.Z.post("/api/data-keys/refs-preview",{data:ep()});eu(e.data.affected),ec(e.data.info)}catch(e){eu(void 0),ec(void 0)}finally{ed(!1)}},[null==z?void 0:z.uuid,null==z?void 0:z.uniqueKey,ep]);(0,i.useEffect)(()=>{if(!z)return;if(!("".concat(ei||"")!=="".concat(z.name||"")||"".concat(et||"")!=="".concat(z.label||"")||"".concat(en||"")!=="".concat(z.dataType||""))){eu(void 0),ec(void 0);return}let e=setTimeout(()=>{eh()},350);return()=>clearTimeout(e)},[z,ei,et,en,eh]);let ef=X(async e=>{var a,n,l;if(O)return;let i=(null==e?void 0:e.uuid)||(null==z?void 0:z.uuid)||(0,m.Z)(),t=null!==(n=null!==(a=null==e?void 0:e.uniqueKey)&&void 0!==a?a:null==z?void 0:z.uniqueKey)&&void 0!==n?n:null,s={...e,uuid:i,uniqueKey:t,version:"string"==typeof e.version?Number(e.version):e.version};G("uuid",i),t&&G("uniqueKey",t);let d=T(s),r=s.name||s.uniqueKey||"Data Key";if(!z&&d){let e=(await S.pb.getEntityChanges(i,"dataKey")).find(e=>"create"===e.action);(null==e?void 0:e.id)?await S.pb.updateChange(e.id,{fieldName:s.name||"New Data Key",newValue:d,timestamp:Date.now(),userId:null==E?void 0:E.userId,userName:null==E?void 0:E.displayName,entityTitle:r,fullSnapshot:d}):await S.pb.addChange({entityType:"dataKey",entityId:i,entityTitle:r,action:"create",fieldPath:"dataKey",fieldName:s.name||"New Data Key",oldValue:null,newValue:d,userId:null==E?void 0:E.userId,userName:null==E?void 0:E.displayName,fullSnapshot:d})}else J.current&&ee.current&&d&&await J.current.trackChanges(d,"Data key saved");let u=await V([{...s}]);u&&"info"in u&&ev(null===(l=u.info)||void 0===l?void 0:l.refs)}),ex=O||B,eg=(0,i.useMemo)(()=>el.map(e=>R.find(a=>a.uniqueKey===e)).filter(e=>e),[R,el]),ej=A||B,eb=(0,i.useCallback)(e=>e?(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsx)(b.DataTable,{title:"Scripts (".concat(e.scripts.length,")"),columns:[{name:"Script title"},{name:"Script ID"}],data:e.scripts.map(e=>[e.scriptTitle||"",e.scriptId||""])}),(0,l.jsx)(b.DataTable,{title:"Screens (".concat(e.screens.length,")"),columns:[{name:"Screen title"},{name:"Script title"},{name:"Screen ID"}],data:e.screens.map(e=>[e.title||"",e.scriptTitle||"",e.id||""])}),(0,l.jsx)(b.DataTable,{title:"Diagnoses (".concat(e.diagnoses.length,")"),columns:[{name:"Diagnosis name"},{name:"Script title"},{name:"Diagnosis ID"}],data:e.diagnoses.map(e=>[e.title||"",e.scriptTitle||"",e.id||""])})]}):null,[]);return(0,l.jsxs)(l.Fragment,{children:[ej&&(0,l.jsx)(k.a,{overlay:!0}),(0,l.jsx)(w.Zb,{children:(0,l.jsxs)(w.aY,{children:[(0,l.jsxs)(w.Ol,{children:[(0,l.jsxs)(w.ll,{children:[z?"Edit":"New"," data key"]}),(0,l.jsx)(w.SZ,{className:"hidden",children:""})]}),(0,l.jsxs)("div",{className:"flex-1 flex flex-col py-2 px-0 gap-y-4 overflow-y-auto",children:[(0,l.jsx)(t.Qr,{control:W,name:"dataType",disabled:ex,rules:{required:!0},render:e=>{let{field:{value:a,onChange:n}}=e;return(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)("div",{className:"px-4",children:[(0,l.jsx)(x._,{htmlFor:"name",children:"Data type *"}),(0,l.jsxs)(p.Ph,{value:a,name:"name",disabled:ex,onValueChange:e=>{n(e);let a=N.y0.find(a=>a.value===e);G("options",(null==a?void 0:a.hasChildren)&&(null==z?void 0:z.options)||[])},children:[(0,l.jsx)(p.i4,{children:(0,l.jsx)(p.ki,{placeholder:"Select type"})}),(0,l.jsx)(p.Bw,{children:(0,l.jsx)(p.DI,{children:N.y0.map(e=>(0,l.jsx)(p.Ql,{value:e.value,children:e.label},e.value))})})]})]})})}}),(0,l.jsxs)("div",{className:"px-4",children:[(0,l.jsx)(x._,{htmlFor:"name",children:"Key *"}),(0,l.jsx)(g.I,{disabled:ex,...$("name",{disabled:ex,required:!0})})]}),(0,l.jsxs)("div",{className:"px-4",children:[(0,l.jsx)(x._,{htmlFor:"label",children:"Label *"}),(0,l.jsx)(g.I,{disabled:ex,...$("label",{disabled:ex,required:!0})})]}),(0,l.jsxs)("div",{className:"px-4 hidden",children:[(0,l.jsx)(x._,{htmlFor:"refId",children:"Ref ID"}),(0,l.jsx)(g.I,{disabled:ex,...$("refId",{disabled:ex,required:!1})})]}),(0,l.jsx)(t.Qr,{control:W,name:"options",disabled:ex,render:e=>{let{field:{value:a,onChange:n}}=e;return(null==ey?void 0:ey.hasChildren)?(0,l.jsx)("div",{className:"mt-4 pt-4 border-t border-t-border",children:(0,l.jsx)(b.DataTable,{sortable:!O,onSort:(e,l)=>{O||n((0,u.q)([...a],e,l))},search:{},title:"Options",headerActions:O?null:(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(I.V,{multiple:!0,search:{placeholder:"Search data keys"},options:R.filter(e=>!el.includes(e.uniqueKey)).map(e=>({label:e.name,value:e.uniqueKey,caption:e.dataType||"",description:e.label})),trigger:(0,l.jsxs)(f.z,{variant:"ghost",className:"w-auto h-auto",children:[(0,l.jsx)(s.Z,{className:"w-4 h-4 mr-2"}),"Add"]}),onSelect:e=>{n([...a,...e.map(e=>e.value)])}})}),noDataMessage:(0,l.jsx)("div",{className:"mt-4 flex flex-col items-center justify-center gap-y-2",children:(0,l.jsx)("div",{children:"Data keys has no options"})}),columns:[{name:"Key"},{name:"Label"},{name:"Data type"},{name:"",align:"right",cellClassName:"w-20",cellRenderer(e){let{rowIndex:n}=e;return!a[n]||O?null:(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)(h.h_,{children:[(0,l.jsx)(h.$F,{children:(0,l.jsx)(d.Z,{className:"h-4 w-4"})}),(0,l.jsx)(h.AW,{children:(0,l.jsxs)(h.Xi,{className:"text-destructive",onClick:()=>setTimeout(()=>_(()=>G("options",el.filter((e,a)=>a!==n)),{title:"Delete",message:"Are you sure you want to delete data key option?",danger:!0}),0),children:[(0,l.jsx)(r.Z,{className:"h-4 w-4 mr-2"})," Delete"]})})]})})}}],data:eg.map(e=>[e.name||"",e.label||"",e.dataType||"",""])})}):(0,l.jsx)(l.Fragment,{})}})]}),(0,l.jsx)("br",{}),(0,l.jsx)("div",{className:"px-4 space-y-4",children:(!!z||!!(null==em?void 0:em.affected))&&(0,l.jsxs)("div",{className:"rounded-md border border-border p-3 space-y-3",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between gap-x-2",children:[(0,l.jsx)("div",{className:"font-medium",children:"Affected entities"}),!!z&&(0,l.jsx)(f.z,{variant:"outline",size:"sm",disabled:es||ex,onClick:()=>eh(),children:es?"Refreshing...":"Refresh Preview"})]}),!!er&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"text-sm",children:["Before update: ",(null===(a=er.scripts)||void 0===a?void 0:a.length)||0," scripts, ",(null===(n=er.screens)||void 0===n?void 0:n.length)||0," screens, ",(null===(C=er.diagnoses)||void 0===C?void 0:C.length)||0," diagnoses"]}),eb(er)]}),!er&&!!z&&!es&&(0,l.jsx)("div",{className:"text-sm text-muted-foreground",children:"No pending impact preview yet. Change key, label, or type to load preview."}),!!(null==em?void 0:em.affected)&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"text-sm",children:["After update: ",(null===(U=em.affected.scripts)||void 0===U?void 0:U.length)||0," scripts, ",(null===(F=em.affected.screens)||void 0===F?void 0:F.length)||0," screens, ",(null===(L=em.affected.diagnoses)||void 0===L?void 0:L.length)||0," diagnoses"]}),eb(em.affected)]}),!!eo&&(0,l.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Preview matching: ",eo.matchedByUniqueKey," key-id, ",eo.matchedByLegacyName," legacy-name, ",eo.matchedByLegacyLabel," legacy-label, ",eo.ambiguousLegacySkips," ambiguous skipped"]}),!!(null==em?void 0:em.info)&&(0,l.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Save matching: ",em.info.matchedByUniqueKey," key-id, ",em.info.matchedByLegacyName," legacy-name, ",em.info.matchedByLegacyLabel," legacy-label, ",em.info.ambiguousLegacySkips," ambiguous skipped"]})]})}),(0,l.jsxs)(w.eW,{className:"gap-x-2",children:[(0,l.jsx)("div",{className:"ml-auto"}),(0,l.jsx)(f.z,{asChild:!0,variant:"ghost",children:(0,l.jsx)(c.default,{href:"/data-keys",children:"Cancel"})}),!O&&(0,l.jsx)(f.z,{onClick:()=>ef(),disabled:ex,children:"Save"})]})]})})]})}},15001:function(e,a,n){"use strict";n.d(a,{Z:function(){return l}});let l=(0,n(79205).Z)("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]])},99397:function(e,a,n){"use strict";n.d(a,{Z:function(){return l}});let l=(0,n(79205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},27648:function(e,a,n){"use strict";n.d(a,{default:function(){return i.a}});var l=n(72972),i=n.n(l)},49360:function(e,a,n){"use strict";n.d(a,{Z:function(){return r}});for(var l,i={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},t=new Uint8Array(16),s=[],d=0;d<256;++d)s.push((d+256).toString(16).slice(1));var r=function(e,a,n){if(i.randomUUID&&!a&&!e)return i.randomUUID();var d=(e=e||{}).random||(e.rng||function(){if(!l&&!(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(t)})();if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,a){n=n||0;for(var r=0;r<16;++r)a[n+r]=d[r];return a}return function(e,a=0){return(s[e[a+0]]+s[e[a+1]]+s[e[a+2]]+s[e[a+3]]+"-"+s[e[a+4]]+s[e[a+5]]+"-"+s[e[a+6]]+s[e[a+7]]+"-"+s[e[a+8]]+s[e[a+9]]+"-"+s[e[a+10]]+s[e[a+11]]+s[e[a+12]]+s[e[a+13]]+s[e[a+14]]+s[e[a+15]]).toLowerCase()}(d)}}}]);