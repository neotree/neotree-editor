"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[259],{58502:function(e,t,n){n.d(t,{SocketEventsListener:function(){return l}});var i=n(2265),a=n(16463),s=n(7752);function l(e){let{events:t}=e,n=(0,i.useRef)({eventsTimeouts:{},eventsTimestamps:{}});(0,i.useRef)(new Date().getTime());let l=(0,a.useRouter)();return(0,i.useEffect)(()=>{t.forEach(e=>{let{name:t,action:i,delay:a=100,onEvent:o}=e;s.Z.on(t,function(){for(var e=arguments.length,s=Array(e),r=0;r<e;r++)s[r]=arguments[r];let u=()=>{var e,n;(!i||s[0]===i)&&(null===(e=o.callback)||void 0===e||e.call(o,...s),(null==o?void 0:o.refreshRouter)&&(console.log(t,"refreshing..."),l.refresh()),(null===(n=o.redirect)||void 0===n?void 0:n.to)&&(o.redirect.replace?l.replace(o.redirect.to):l.push(o.redirect.to)))},d=new Date().getTime();a?(clearTimeout(n.current.eventsTimeouts[t]),n.current.eventsTimeouts[t]=setTimeout(()=>{n.current.eventsTimestamps[t]=d,u()},a)):(n.current.eventsTimestamps[t]=new Date().getTime(),u())})})},[t,l]),null}},17647:function(e,t,n){n.d(t,{AppContextProvider:function(){return m},b:function(){return f}});var i=n(57437),a=n(2265),s=n(79512),l=n(16463),o=n(23314),r=n(44785);let u=r.Z.get,d=r.Z.set;r.Z.remove;var c={get:u,set:d};function h(){let e=c.get("mode");return e||(e="view",c.set("mode",e,{expires:31536e7})),e}var p=n(7752),y=n(58502);let g=(0,a.createContext)(null),f=()=>(0,a.useContext)(g);function m(e){let{children:t,...n}=e,r=function(e){(0,l.useRouter)();let{isAdmin:t,isSuperUser:n,sys:i}=e,{setTheme:o}=(0,s.F)();(0,a.useEffect)(()=>{"yes"===i.data.hide_theme_toggle&&o("light")},[i]);let r=(0,a.useCallback)(()=>(t||n?h():"view")||"view",[n,t]),[u,d]=(0,a.useState)(r()),y=!t&&!n||"view"===u,g=(0,a.useCallback)(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let i=function(e){return c.set("mode",e,{expires:31536e7}),h()}(...t);return p.Z.emit("mode_changed",r()),d(r()),i},[r]),f=(0,a.useCallback)(()=>{d(r())},[r]);return{...e,mode:u,viewOnly:y,onModeChange:f,getMode:h,setMode:g}}(n),[u,d]=(0,a.useState)(!1);return((0,o.Z)(()=>{d(!0)}),u)?(0,i.jsxs)(g.Provider,{value:r,children:[t,(0,i.jsx)(y.SocketEventsListener,{events:[{name:"mode_changed",onEvent:{callback:r.onModeChange}}]})]}):null}},53699:function(e,t,n){n.d(t,{s:function(){return s}});var i=n(39099);let a={title:"",message:"",buttonLabel:"Ok",variant:"info",onClose:void 0},s=(0,i.Ue)(e=>({isOpen:!1,...a,alert:t=>e({isOpen:!0,...a,...t}),close:()=>e({isOpen:!1,onClose:void 0,...a})}))},42314:function(e,t,n){n.d(t,{$u:function(){return l},KL:function(){return r}});var i=n(72341);let a=new Set(["id","createdAt","updatedAt","deletedAt","oldScriptId","oldScreenId","oldDiagnosisId","oldConfigKeyId","version","publishDate","isDraft","isDeleted","draftCreatedByUserId","createdByUserId","updatedByUserId","createdBy","updatedBy"]);class s{setSnapshot(e){this.isInitialized||(this.originalSnapshot=JSON.parse(JSON.stringify(e)),this.isInitialized=!0)}async trackChanges(e,t){if(!this.isInitialized||!this.originalSnapshot){this.setSnapshot(e);return}let n=this.detectChanges(this.originalSnapshot,e),a=new Map((await i.pb.getEntityChanges(this.options.entityId,this.options.entityType)).map(e=>[e.fieldPath,e])),s=this.resolveEntityTitle(e);for(let l of n){let n=a.get(l.path);n?await i.pb.updateChange(n.id,{newValue:l.newValue,timestamp:Date.now(),description:t,fullSnapshot:e,entityTitle:s}):await i.pb.addChange({entityId:this.options.entityId,entityType:this.options.entityType,action:"update",fieldPath:l.path,fieldName:l.name,oldValue:l.oldValue,newValue:l.newValue,userId:this.options.userId,userName:this.options.userName,description:t,fullSnapshot:e,entityTitle:s})}for(let[e,t]of Array.from(a))n.some(t=>t.path===e)||await i.pb.deleteChange(t.id);0===n.length&&await i.pb.clearEntityChanges(this.options.entityId,this.options.entityType)}resolveEntityTitle(e){if(this.options.resolveEntityTitle){let t=this.options.resolveEntityTitle(e);if(t&&t.toString().trim().length)return t.toString().trim()}let t=this.extractTitle(e);return t?t:"string"==typeof this.options.entityTitle&&this.options.entityTitle.trim().length?this.options.entityTitle.trim():this.extractTitle(this.originalSnapshot)||"".concat(this.options.entityType," ").concat(this.options.entityId)}extractTitle(e){if(!e||"object"!=typeof e)return null;for(let t of["title","name","label","key","printTitle","displayName","sectionTitle","collectionLabel"]){let n=e[t];if("string"==typeof n&&n.trim().length)return n.trim()}return null}isMeaningfulValue(e){return null!=e&&("string"!=typeof e||""!==e.trim())}detectChanges(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=[];return null==e?null!=t&&this.isMeaningfulValue(t)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}):null==t?this.isMeaningfulValue(e)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}):"object"!=typeof e||"object"!=typeof t?e!==t&&this.isMeaningfulValue(t)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}):Array.isArray(e)&&Array.isArray(t)?JSON.stringify(e)!==JSON.stringify(t)&&i.push({path:n||"root",name:n.split(".").pop()||"root",oldValue:e,newValue:t}):Array.from(new Set([...Object.keys(e),...Object.keys(t)])).forEach(s=>{if(a.has(s))return;let l=n?"".concat(n,".").concat(s):s,o=e[s],r=t[s];(this.isMeaningfulValue(o)||this.isMeaningfulValue(r))&&("object"!=typeof o||"object"!=typeof r||null===o||null===r||Array.isArray(o)||Array.isArray(r)?JSON.stringify(o)!==JSON.stringify(r)&&this.isMeaningfulValue(r)&&i.push({path:l,name:s,oldValue:o,newValue:r}):i.push(...this.detectChanges(o,r,l)))}),i}async clearChanges(){await i.pb.clearEntityChanges(this.options.entityId,this.options.entityType),this.originalSnapshot=null,this.isInitialized=!1}async getPendingChanges(){return await i.pb.getEntityChanges(this.options.entityId,this.options.entityType)}constructor(e){this.originalSnapshot=null,this.isInitialized=!1,this.options=e}}function l(e){return new s(e)}let o=["title","name","label","key","printTitle","sectionTitle","collectionLabel","drug","fluid","feed"];async function r(e){let{entityId:t,entityType:n,entityTitle:a,snapshot:s,userId:l,userName:r,description:u}=e;if(!t)return;let d=(null==a?void 0:a.trim())||function(e){if(!e||"object"!=typeof e)return null;for(let t of o){let n=e[t];if("string"==typeof n&&n.trim().length)return n.trim()}return null}(s)||"".concat(n," ").concat(t);await i.pb.clearEntityChanges(t,n),await i.pb.addChange({entityId:t,entityType:n,entityTitle:d,action:"delete",fieldPath:"entity",fieldName:d,oldValue:null!=s?s:null,newValue:null,userId:l||void 0,userName:r||void 0,description:u||'Marked "'.concat(d,'" for deletion'),fullSnapshot:null!=s?s:null})}},72341:function(e,t,n){n.d(t,{pb:function(){return l}});var i=n(14635);class a extends i.ZP{constructor(){super("NeotreeChangeLogDB"),this.version(1).stores({pendingChanges:"++id, entityId, entityType, timestamp, userId, [entityId+fieldPath]",changeSessions:"++id, sessionId, entityId, entityType, startedAt, lastModifiedAt"})}}let s=new a,l={async addChange(e){let t=Date.now(),n="string"==typeof e.entityTitle&&e.entityTitle.trim().length?e.entityTitle.trim():"".concat(e.entityType," ").concat(e.entityId);return await s.pendingChanges.add({...e,entityTitle:n,timestamp:t})},async updateChange(e,t){let n={...t};return t.entityTitle&&"string"==typeof t.entityTitle&&(n.entityTitle=t.entityTitle.trim().length>0?t.entityTitle.trim():void 0),await s.pendingChanges.update(e,n)},deleteChange:async e=>await s.pendingChanges.delete(e),async getEntityChanges(e,t){let n=s.pendingChanges.where("entityId").equals(e);return t?await n.and(e=>e.entityType===t).toArray():await n.toArray()},async getAllChangesByEntity(){let e=await s.pendingChanges.toArray(),t={};return e.forEach(e=>{let n="".concat(e.entityType,":").concat(e.entityId);t[n]||(t[n]={title:"string"==typeof e.entityTitle&&e.entityTitle.trim().length?e.entityTitle.trim():"".concat(e.entityType," ").concat(e.entityId),changes:[]}),t[n].changes.push(e)}),t},getChangeCount:async e=>e?await s.pendingChanges.where("entityId").equals(e).count():await s.pendingChanges.count(),clearEntityChanges:async(e,t)=>t?await s.pendingChanges.where("entityId").equals(e).and(e=>e.entityType===t).delete():await s.pendingChanges.where("entityId").equals(e).delete(),clearAllChanges:async()=>await s.pendingChanges.clear(),getChangesByUser:async e=>await s.pendingChanges.where("userId").equals(e).toArray(),async getRecentChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return await s.pendingChanges.orderBy("timestamp").reverse().limit(e).toArray()},async startSession(e,t,n,i){let a="".concat(t,"-").concat(e,"-").concat(Date.now()),l={sessionId:a,entityId:e,entityType:t,entityTitle:n,startedAt:Date.now(),lastModifiedAt:Date.now(),changeCount:0,userId:i};return await s.changeSessions.add(l),a},async updateSession(e){let t=await s.changeSessions.where("sessionId").equals(e).first();t&&await s.changeSessions.update(t.id,{lastModifiedAt:Date.now(),changeCount:(t.changeCount||0)+1})},endSession:async e=>await s.changeSessions.where("sessionId").equals(e).delete(),clearAllSessions:async()=>await s.changeSessions.clear(),getActiveSession:async e=>await s.changeSessions.where("entityId").equals(e).first()}},7752:function(e,t,n){var i=n(45040),a=n(20357);let s=(0,i.io)(a.env.NEXT_PUBLIC_APP_URL);t.Z=s}}]);